<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Budget â€” Personal Budget Tool</title>
    <meta name="description" content="An interactive personal budget tool. Track income, expenses, and savings goals." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #FAFAFA;
        color: #1A1A1A;
        -webkit-font-smoothing: antialiased;
      }
      #my-budget-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }
      #my-budget-root > * {
        width: 100%;
        max-width: 100%;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="my-budget-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfY29uc3RydWN0b3IgPSBwdWJsaWNJbnN0YW5jZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBfY29uc3RydWN0b3IgJiYgKF9jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBfY29uc3RydWN0b3IubmFtZSkgfHwgIlJlYWN0Q2xhc3MiOwogICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yKCJDYW4ndCBjYWxsICVzIG9uIGEgY29tcG9uZW50IHRoYXQgaXMgbm90IHlldCBtb3VudGVkLiBUaGlzIGlzIGEgbm8tb3AsIGJ1dCBpdCBtaWdodCBpbmRpY2F0ZSBhIGJ1ZyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBJbnN0ZWFkLCBhc3NpZ24gdG8gYHRoaXMuc3RhdGVgIGRpcmVjdGx5IG9yIGRlZmluZSBhIGBzdGF0ZSA9IHt9O2AgY2xhc3MgcHJvcGVydHkgd2l0aCB0aGUgZGVzaXJlZCBzdGF0ZSBpbiB0aGUgJXMgY29tcG9uZW50LiIsIGNhbGxlck5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3ROb29wVXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGlzIGNvbXBvc2l0ZSBjb21wb25lbnQgaXMgbW91bnRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHdlIHdhbnQgdG8gdGVzdC4KICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICogQHByb3RlY3RlZAogICAgICAgICAgICogQGZpbmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogRm9yY2VzIGFuIHVwZGF0ZS4gVGhpcyBzaG91bGQgb25seSBiZSBpbnZva2VkIHdoZW4gaXQgaXMga25vd24gd2l0aAogICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogWW91IG1heSB3YW50IHRvIGNhbGwgdGhpcyB3aGVuIHlvdSBrbm93IHRoYXQgc29tZSBkZWVwZXIgYXNwZWN0IG9mIHRoZQogICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhpcyB3aWxsIG5vdCBpbnZva2UgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAsIGJ1dCBpdCB3aWxsIGludm9rZQogICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSZXBsYWNlcyBhbGwgb2YgdGhlIHN0YXRlLiBBbHdheXMgdXNlIHRoaXMgb3IgYHNldFN0YXRlYCB0byBtdXRhdGUgc3RhdGUuCiAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlcmUgaXMgbm8gZ3VhcmFudGVlIHRoYXQgYHRoaXMuc3RhdGVgIHdpbGwgYmUgaW1tZWRpYXRlbHkgdXBkYXRlZCwgc28KICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjb21wbGV0ZVN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgKiBpbnRlcm5hbC4gVGhpcyBwcm92aWRlcyBhIG1lcmdpbmcgc3RyYXRlZ3kgdGhhdCBpcyBub3QgYXZhaWxhYmxlIHRvIGRlZXAKICAgICAgICAgICAqIHByb3BlcnRpZXMgd2hpY2ggaXMgY29uZnVzaW5nLiBUT0RPOiBFeHBvc2UgcGVuZGluZ1N0YXRlIG9yIGRvbid0IHVzZSBpdAogICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gTmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIH0KICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24ocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJmdW5jdGlvbiIgJiYgcGFydGlhbFN0YXRlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUodGhpcywgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgfTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmZvcmNlVXBkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGRlcHJlY2F0ZWRBUElzID0gewogICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICByZXBsYWNlU3RhdGU6IFsicmVwbGFjZVN0YXRlIiwgIlJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2Ugc2V0U3RhdGUgaW5zdGVhZCAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMzIzNikuIl0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiJXMoLi4uKSBpcyBkZXByZWNhdGVkIGluIHBsYWluIEphdmFTY3JpcHQgUmVhY3QgY2xhc3Nlcy4gJXMiLCBpbmZvWzBdLCBpbmZvWzFdKTsKICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBmb3IgKHZhciBmbk5hbWUgaW4gZGVwcmVjYXRlZEFQSXMpIHsKICAgICAgICAgICAgaWYgKGRlcHJlY2F0ZWRBUElzLmhhc093blByb3BlcnR5KGZuTmFtZSkpIHsKICAgICAgICAgICAgICBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcoZm5OYW1lLCBkZXByZWNhdGVkQVBJc1tmbk5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50RHVtbXkucHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICBmdW5jdGlvbiBQdXJlQ29tcG9uZW50Myhwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50My5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDM7CiAgICAgICAgYXNzaWduMihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biwgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24sIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBjb25maWcuX19zZWxmICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQuc3RhdGVOb2RlICE9PSBjb25maWcuX19zZWxmKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcykgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB7CiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGFsbG93cyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgRWxlbWVudAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRUxFTUVOVF9UWVBFLAogICAgICAgICAgICAvLyBCdWlsdC1pbiBwcm9wZXJ0aWVzIHRoYXQgYmVsb25nIG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgcmVmLAogICAgICAgICAgICBwcm9wcywKICAgICAgICAgICAgLy8gUmVjb3JkIHRoZSBjb21wb25lbnQgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIHRoaXMgZWxlbWVudC4KICAgICAgICAgICAgX293bmVyOiBvd25lcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQuX3N0b3JlLCAidmFsaWRhdGVkIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zZWxmIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzZWxmMgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQzOSh0eXBlLCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICB2YXIgc2VsZjIgPSBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IG51bGw7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmMiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUFuZFJlcGxhY2VLZXkob2xkRWxlbWVudCwgbmV3S2V5KSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IFJlYWN0RWxlbWVudChvbGRFbGVtZW50LnR5cGUsIG5ld0tleSwgb2xkRWxlbWVudC5yZWYsIG9sZEVsZW1lbnQuX3NlbGYsIG9sZEVsZW1lbnQuX3NvdXJjZSwgb2xkRWxlbWVudC5fb3duZXIsIG9sZEVsZW1lbnQucHJvcHMpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudDgoZWxlbWVudCwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgaWYgKGVsZW1lbnQgPT09IG51bGwgfHwgZWxlbWVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuY2xvbmVFbGVtZW50KC4uLik6IFRoZSBhcmd1bWVudCBtdXN0IGJlIGEgUmVhY3QgZWxlbWVudCwgYnV0IHlvdSBwYXNzZWQgIiArIGVsZW1lbnQgKyAiLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZjIgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSAmJiBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWdbcHJvcE5hbWVdID09PSB2b2lkIDAgJiYgZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNShvYmplY3QpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgfQogICAgICAgIHZhciBTRVBBUkFUT1IgPSAiLiI7CiAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICBmdW5jdGlvbiBlc2NhcGUoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuYW1lU29GYXIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBjaGlsZHJlbjsKICAgICAgICAgIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4uJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbWFwcGVkQ2hpbGQgPSBjYWxsYmFjayhfY2hpbGQpOwogICAgICAgICAgICB2YXIgY2hpbGRLZXkgPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SICsgZ2V0RWxlbWVudEtleShfY2hpbGQsIDApIDogbmFtZVNvRmFyOwogICAgICAgICAgICBpZiAoaXNBcnJheTIobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWFwcGVkQ2hpbGQua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQgPSBjbG9uZUFuZFJlcGxhY2VLZXkoCiAgICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkLAogICAgICAgICAgICAgICAgICAvLyBLZWVwIGJvdGggdGhlIChtYXBwZWQpIGFuZCBvbGQga2V5cyBpZiB0aGV5IGRpZmZlciwganVzdCBhcwogICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZUFsbENoaWxkcmVuIHVzZWQgdG8gZG8gZm9yIG9iamVjdHMgYXMgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgZXNjYXBlZFByZWZpeCArIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgUmVhY3QuUG9ydGFsIGRvZXNuJ3QgaGF2ZSBhIGtleQogICAgICAgICAgICAgICAgICAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkgPyAoCiAgICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBleGlzdGluZyBlbGVtZW50J3Mga2V5IGNhbiBiZSBhIG51bWJlcgogICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1pbnRlcm5hbC9zYWZlLXN0cmluZy1jb2VyY2lvbgogICAgICAgICAgICAgICAgICAgIGVzY2FwZVVzZXJQcm92aWRlZEtleSgiIiArIG1hcHBlZENoaWxkLmtleSkgKyAiLyIKICAgICAgICAgICAgICAgICAgKSA6ICIiKSArIGNoaWxkS2V5CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcnJheS5wdXNoKG1hcHBlZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHZhciBuZXh0TmFtZTsKICAgICAgICAgIHZhciBzdWJ0cmVlQ291bnQgPSAwOwogICAgICAgICAgdmFyIG5leHROYW1lUHJlZml4ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiA6IG5hbWVTb0ZhciArIFNVQlNFUEFSQVRPUjsKICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGkpOwogICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuID09PSBpdGVyYWJsZUNoaWxkcmVuLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQxNShjaGlsZHJlbikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdC5DaGlsZHJlbi5vbmx5IGV4cGVjdGVkIHRvIHJlY2VpdmUgYSBzaW5nbGUgUmVhY3QgZWxlbWVudCBjaGlsZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGV4dDEyKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgIC8vIHNvbWUgcmVuZGVyZXJzIGFzIHByaW1hcnkgYW5kIG90aGVycyBhcyBzZWNvbmRhcnkuIFdlIG9ubHkgZXhwZWN0CiAgICAgICAgICAgIC8vIHRoZXJlIHRvIGJlIHR3byBjb25jdXJyZW50IHJlbmRlcmVycyBhdCBtb3N0OiBSZWFjdCBOYXRpdmUgKHByaW1hcnkpIGFuZAogICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgLy8gU2Vjb25kYXJ5IHJlbmRlcmVycyBzdG9yZSB0aGVpciBjb250ZXh0IHZhbHVlcyBvbiBzZXBhcmF0ZSBmaWVsZHMuCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgLy8gVXNlZCB0byB0cmFjayBob3cgbWFueSBjb25jdXJyZW50IHJlbmRlcmVycyB0aGlzIGNvbnRleHQgY3VycmVudGx5CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIHdpdGhpbiBpbiBhIHNpbmdsZSByZW5kZXJlci4gU3VjaCBhcyBwYXJhbGxlbCBzZXJ2ZXIgcmVuZGVyaW5nLgogICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBjaXJjdWxhcgogICAgICAgICAgICBQcm92aWRlcjogbnVsbCwKICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgIC8vIEFkZCB0aGVzZSB0byB1c2Ugc2FtZSBoaWRkZW4gY2xhc3MgaW4gVk0gYXMgU2VydmVyQ29udGV4dAogICAgICAgICAgICBfZGVmYXVsdFZhbHVlOiBudWxsLAogICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIENvbnN1bWVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29uc3VtZXIsIHsKICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlcikgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLlByb3ZpZGVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Qcm92aWRlcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9Qcm92aWRlcikgewogICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTIgPSBfY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF90aHJlYWRDb3VudDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX3RocmVhZENvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Db25zdW1lcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlNldHRpbmcgYGRpc3BsYXlOYW1lYCBvbiBDb250ZXh0LkNvbnN1bWVyIGhhcyBubyBlZmZlY3QuIFlvdSBzaG91bGQgc2V0IGl0IGRpcmVjdGx5IG9uIHRoZSBjb250ZXh0IHdpdGggQ29udGV4dC5kaXNwbGF5TmFtZSA9ICclcycuIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnRleHQuQ29uc3VtZXIgPSBDb25zdW1lcjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gbnVsbDsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyMiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgdmFyIFVuaW5pdGlhbGl6ZWQgPSAtMTsKICAgICAgICB2YXIgUGVuZGluZyA9IDA7CiAgICAgICAgdmFyIFJlc29sdmVkID0gMTsKICAgICAgICB2YXIgUmVqZWN0ZWQgPSAyOwogICAgICAgIGZ1bmN0aW9uIGxhenlJbml0aWFsaXplcihwYXlsb2FkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBjdG9yID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB2YXIgdGhlbmFibGUgPSBjdG9yKCk7CiAgICAgICAgICAgIHRoZW5hYmxlLnRoZW4oZnVuY3Rpb24obW9kdWxlT2JqZWN0MikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3N0YXR1cyA9IFJlc29sdmVkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3Jlc3VsdCA9IG1vZHVsZU9iamVjdDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlamVjdGVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9zdGF0dXMgPSBSZWplY3RlZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9yZXN1bHQgPSBlcnJvcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gcGF5bG9hZDsKICAgICAgICAgICAgICBwZW5kaW5nLl9zdGF0dXMgPSBQZW5kaW5nOwogICAgICAgICAgICAgIHBlbmRpbmcuX3Jlc3VsdCA9IHRoZW5hYmxlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBSZXNvbHZlZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlT2JqZWN0ID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG1vZHVsZU9iamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpXG5cbkRpZCB5b3UgYWNjaWRlbnRhbGx5IHB1dCBjdXJseSBicmFjZXMgYXJvdW5kIHRoZSBpbXBvcnQ/IiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghKCJkZWZhdWx0IiBpbiBtb2R1bGVPYmplY3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpIiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZHVsZU9iamVjdC5kZWZhdWx0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYXp5KGN0b3IpIHsKICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAvLyBXZSB1c2UgdGhlc2UgZmllbGRzIHRvIHN0b3JlIHRoZSByZXN1bHQuCiAgICAgICAgICAgIF9zdGF0dXM6IFVuaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgIF9yZXN1bHQ6IGN0b3IKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbGF6eVR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9MQVpZX1RZUEUsCiAgICAgICAgICAgIF9wYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICBfaW5pdDogbGF6eUluaXRpYWxpemVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhsYXp5VHlwZSwgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld0RlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgZGVmYXVsdFByb3BzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IG5ld0RlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAiZGVmYXVsdFByb3BzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBwcm9wVHlwZXM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wVHlwZXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYHByb3BUeXBlc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBwcm9wVHlwZXMgPSBuZXdQcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgInByb3BUeXBlcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGF6eVR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcndhcmRSZWYxNShyZW5kZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgcmVuZGVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXJlbmRlci5uYW1lICYmICFyZW5kZXIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW83KHR5cGUsIGNvbXBhcmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkpIHsKICAgICAgICAgICAgICBlcnJvcigibWVtbzogVGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBjb21wb25lbnQuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzIiwgdHlwZSA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTUVNT19UWVBFMiwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghdHlwZS5uYW1lICYmICF0eXBlLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHR5cGUuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDb250ZXh0MTIoQ29udGV4dCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29udGV4dC5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlYWxDb250ZXh0ID0gQ29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgICBpZiAocmVhbENvbnRleHQuQ29uc3VtZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Db25zdW1lcikgaXMgbm90IHN1cHBvcnRlZCwgbWF5IGNhdXNlIGJ1Z3MsIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVhbENvbnRleHQuUHJvdmlkZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Qcm92aWRlcikgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ29udGV4dChDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3RhdGUxMihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjE2KGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUVmZmVjdDE0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VMYXlvdXRFZmZlY3Q5KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrOChjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VNZW1vOShjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW1wZXJhdGl2ZUhhbmRsZTMocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZDIoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJZCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50MikgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudDIucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bjsKICAgICAgICB7CiAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgbmFtZSArICJgLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMoZWxlbWVudFByb3BzKSB7CiAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShlbGVtZW50UHJvcHMuX19zb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgIGluZm8gPSAiXG5cbkNoZWNrIHRoZSB0b3AtbGV2ZWwgcmVuZGVyIGNhbGwgdXNpbmcgPCIgKyBwYXJlbnROYW1lICsgIj4uIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkyKG5vZGUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNShub2RlKSkgewogICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUoc3RlcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmNyZWF0ZUVsZW1lbnQ6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnQgPSBjcmVhdGVFbGVtZW50MzkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUpIHsKICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSB0cnVlOwogICAgICAgICAgICAgIHdhcm4zKCJSZWFjdC5jcmVhdGVGYWN0b3J5KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIENvbnNpZGVyIHVzaW5nIEpTWCBvciB1c2UgUmVhY3QuY3JlYXRlRWxlbWVudCgpIGRpcmVjdGx5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiRmFjdG9yeS50eXBlIGlzIGRlcHJlY2F0ZWQuIEFjY2VzcyB0aGUgY2xhc3MgZGlyZWN0bHkgYmVmb3JlIHBhc3NpbmcgaXQgdG8gY3JlYXRlRmFjdG9yeS4iKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAidHlwZSIsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWxpZGF0ZWRGYWN0b3J5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbihlbGVtZW50LCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50OC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrMikgewogICAgICAgICAgaWYgKGVucXVldWVUYXNrSW1wbCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciByZXF1aXJlU3RyaW5nID0gKCJyZXF1aXJlIiArIE1hdGgucmFuZG9tKCkpLnNsaWNlKDAsIDcpOwogICAgICAgICAgICAgIHZhciBub2RlUmVxdWlyZSA9IG1vZHVsZSAmJiBtb2R1bGVbcmVxdWlyZVN0cmluZ107CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gbm9kZVJlcXVpcmUuY2FsbChtb2R1bGUsICJ0aW1lcnMiKS5zZXRJbW1lZGlhdGU7CiAgICAgICAgICAgIH0gY2F0Y2ggKF9lcnIpIHsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWVzc2FnZUNoYW5uZWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IGhhdmUgYSBNZXNzYWdlQ2hhbm5lbCBpbXBsZW1lbnRhdGlvbiwgc28gZW5xdWV1aW5nIHRhc2tzIHZpYSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aWxsIGZhaWwuIFBsZWFzZSBmaWxlIGFuIGlzc3VlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMgaWYgeW91IGVuY291bnRlciB0aGlzIHdhcm5pbmcuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2Uodm9pZCAwKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW5xdWV1ZVRhc2tJbXBsKHRhc2syKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdFNjb3BlRGVwdGggPSAwOwogICAgICAgIHZhciBkaWRXYXJuTm9Bd2FpdEFjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGFjdChjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJldkFjdFNjb3BlRGVwdGggPSBhY3RTY29wZURlcHRoOwogICAgICAgICAgICBhY3RTY29wZURlcHRoKys7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2SXNCYXRjaGluZ0xlZ2FjeSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHRydWU7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2soKTsKICAgICAgICAgICAgICBpZiAoIXByZXZJc0JhdGNoaW5nTGVnYWN5ICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gcHJldklzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcmVzdWx0LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGVSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgdmFyIHdhc0F3YWl0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgd2FzQXdhaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRoZW5hYmxlUmVzdWx0LnRoZW4oZnVuY3Rpb24ocmV0dXJuVmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlMiwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2Fybk5vQXdhaXRBY3QgJiYgdHlwZW9mIFByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXNBd2FpdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuTm9Bd2FpdEFjdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGNhbGxlZCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aXRob3V0IGF3YWl0LiBUaGlzIGNvdWxkIGxlYWQgdG8gdW5leHBlY3RlZCB0ZXN0aW5nIGJlaGF2aW91ciwgaW50ZXJsZWF2aW5nIG11bHRpcGxlIGFjdCBjYWxscyBhbmQgbWl4aW5nIHRoZWlyIHNjb3Blcy4gWW91IHNob3VsZCAtIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pOyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGVuYWJsZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3F1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChfcXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShfcXVldWUpOwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlMiA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZXZBY3RTY29wZURlcHRoICE9PSBhY3RTY29wZURlcHRoIC0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3Ugc2VlbSB0byBoYXZlIG92ZXJsYXBwaW5nIGFjdCgpIGNhbGxzLCB0aGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEJlIHN1cmUgdG8gYXdhaXQgcHJldmlvdXMgYWN0KCkgY2FsbHMgYmVmb3JlIG1ha2luZyBhIG5ldyBvbmUuICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGggPSBwcmV2QWN0U2NvcGVEZXB0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIGVucXVldWVUYXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmbHVzaEFjdFF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGbHVzaGluZykgewogICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBxdWV1ZSA9IHF1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlRWxlbWVudCQxID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjbG9uZUVsZW1lbnQkMSA9IGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBDaGlsZHJlbjIgPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW4yOwogICAgICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuUHJvZmlsZXIgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgIGV4cG9ydHMuUHVyZUNvbXBvbmVudCA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgIGV4cG9ydHMuY3JlYXRlUmVmID0gY3JlYXRlUmVmOwogICAgICAgIGV4cG9ydHMuZm9yd2FyZFJlZiA9IGZvcndhcmRSZWYxNTsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQxNTsKICAgICAgICBleHBvcnRzLmxhenkgPSBsYXp5OwogICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW83OwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazg7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWUyOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QxNDsKICAgICAgICBleHBvcnRzLnVzZUlkID0gdXNlSWQyOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGUzOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OTsKICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vOTsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTY7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTI7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGluZyA9IGZhbHNlOwogICAgICAgIHZhciBmcmFtZVlpZWxkTXMgPSA1OwogICAgICAgIGZ1bmN0aW9uIHB1c2goaGVhcCwgbm9kZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICBoZWFwLnB1c2gobm9kZSk7CiAgICAgICAgICBzaWZ0VXAoaGVhcCwgbm9kZSwgaW5kZXgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZWVrMyhoZWFwKSB7CiAgICAgICAgICByZXR1cm4gaGVhcC5sZW5ndGggPT09IDAgPyBudWxsIDogaGVhcFswXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGhlYXApIHsKICAgICAgICAgIGlmIChoZWFwLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdCA9IGhlYXBbMF07CiAgICAgICAgICB2YXIgbGFzdDIgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QyICE9PSBmaXJzdCkgewogICAgICAgICAgICBoZWFwWzBdID0gbGFzdDI7CiAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QyLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrMiwgbXMpIHsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1BlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGlmIChoYXNQZXJmb3JtYW5jZU5vdykgewogICAgICAgICAgdmFyIGxvY2FsUGVyZm9ybWFuY2UgPSBwZXJmb3JtYW5jZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGxvY2FsRGF0ZTIgPSBEYXRlOwogICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlMi5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUyLm5vdygpIC0gaW5pdGlhbFRpbWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbWF4U2lnbmVkMzFCaXRJbnQgPSAxMDczNzQxODIzOwogICAgICAgIHZhciBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVCA9IC0xOwogICAgICAgIHZhciBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQgPSAyNTA7CiAgICAgICAgdmFyIE5PUk1BTF9QUklPUklUWV9USU1FT1VUID0gNWUzOwogICAgICAgIHZhciBMT1dfUFJJT1JJVFlfVElNRU9VVCA9IDFlNDsKICAgICAgICB2YXIgSURMRV9QUklPUklUWV9USU1FT1VUID0gbWF4U2lnbmVkMzFCaXRJbnQ7CiAgICAgICAgdmFyIHRhc2tRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0aW1lclF1ZXVlID0gW107CiAgICAgICAgdmFyIHRhc2tJZENvdW50ZXIgPSAxOwogICAgICAgIHZhciBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgdmFyIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbFNldFRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbENsZWFyVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbFNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICJ1bmRlZmluZWQiID8gc2V0SW1tZWRpYXRlIDogbnVsbDsKICAgICAgICB2YXIgaXNJbnB1dFBlbmRpbmcgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZyAhPT0gdm9pZCAwICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nICE9PSB2b2lkIDAgPyBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZy5iaW5kKG5hdmlnYXRvci5zY2hlZHVsaW5nKSA6IG51bGw7CiAgICAgICAgZnVuY3Rpb24gYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAodGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRpbWVyLmNhbGxiYWNrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICB0aW1lci5zb3J0SW5kZXggPSB0aW1lci5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgdGltZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdFRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5pc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrMyh0YXNrUXVldWUpKSB7CiAgICAgICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgPT09IG51bGwgJiYgbmV3VGFzayA9PT0gcGVlazModGltZXJRdWV1ZSkpIHsKICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBzdGFydFRpbWUyIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcGF1c2VFeGVjdXRpb24oKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uKCkgewogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUoKSB7CiAgICAgICAgICByZXR1cm4gcGVlazModGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzazIpIHsKICAgICAgICAgIHRhc2syLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgfQogICAgICAgIHZhciBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgIHZhciBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgdmFyIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IC0xOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgdmFyIHRpbWVFbGFwc2VkID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIGlmICh0aW1lRWxhcHNlZCA8IGZyYW1lSW50ZXJ2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RQYWludCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICBpZiAoZnBzIDwgMCB8fCBmcHMgPiAxMjUpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXSgiZm9yY2VGcmFtZVJhdGUgdGFrZXMgYSBwb3NpdGl2ZSBpbnQgYmV0d2VlbiAwIGFuZCAxMjUsIGZvcmNpbmcgZnJhbWUgcmF0ZXMgaGlnaGVyIHRoYW4gMTI1IGZwcyBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcHMgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgIHN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgIHZhciBoYXNNb3JlV29yayA9IHRydWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChoYXNNb3JlV29yaykgewogICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgIGlmICh0eXBlb2YgbG9jYWxTZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0SW1tZWRpYXRlKHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShudWxsKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICBpZiAoIWlzTWVzc2FnZUxvb3BSdW5uaW5nKSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RUaW1lb3V0KGNhbGxiYWNrLCBtcykgewogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IGxvY2FsU2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICB9LCBtcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgbG9jYWxDbGVhclRpbWVvdXQodGFza1RpbWVvdXRJRCk7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgfQogICAgICAgIHZhciB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSByZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIHVuc3RhYmxlX1Byb2ZpbGluZyA9IG51bGw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTG93UHJpb3JpdHkgPSBMb3dQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Qcm9maWxpbmcgPSB1bnN0YWJsZV9Qcm9maWxpbmc7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Vc2VyQmxvY2tpbmdQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uID0gdW5zdGFibGVfY29udGludWVFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9mb3JjZUZyYW1lUmF0ZSA9IGZvcmNlRnJhbWVSYXRlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlID0gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9uZXh0ID0gdW5zdGFibGVfbmV4dDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkgPSB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3Nob3VsZFlpZWxkID0gc2hvdWxkWWllbGRUb0hvc3Q7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV93cmFwQ2FsbGJhY2sgPSB1bnN0YWJsZV93cmFwQ2FsbGJhY2s7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzguX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDkgPSA3OwogICAgICAgIHZhciBNb2RlID0gODsKICAgICAgICB2YXIgQ29udGV4dENvbnN1bWVyID0gOTsKICAgICAgICB2YXIgQ29udGV4dFByb3ZpZGVyID0gMTA7CiAgICAgICAgdmFyIEZvcndhcmRSZWYyID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00yID0gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIGF0dHJpYnV0ZSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgYXR0cmlidXRlTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBwcm9wIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgQ1NTIHByb3BlcnR5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBIVE1MIG1hcmt1cCB1c2VzIGEgdmFsdWUgb2YgdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiRm9ybSBmaWVsZCB2YWx1ZXMgKHZhbHVlLCBjaGVja2VkLCBkZWZhdWx0VmFsdWUsIG9yIGRlZmF1bHRDaGVja2VkIHByb3BzKSBtdXN0IGJlIHN0cmluZ3MsIG5vdCAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFU0VSVkVEID0gMDsKICAgICAgICB2YXIgU1RSSU5HID0gMTsKICAgICAgICB2YXIgQk9PTEVBTklTSF9TVFJJTkcgPSAyOwogICAgICAgIHZhciBCT09MRUFOID0gMzsKICAgICAgICB2YXIgT1ZFUkxPQURFRF9CT09MRUFOID0gNDsKICAgICAgICB2YXIgTlVNRVJJQyA9IDU7CiAgICAgICAgdmFyIFBPU0lUSVZFX05VTUVSSUMgPSA2OwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSID0gIjpBLVpfYS16XFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfQ0hBUiA9IEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXFwtLjAtOVxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgICAgIHZhciBWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWCA9IG5ldyBSZWdFeHAoIl5bIiArIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICB2YXIgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIHZhciB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWVTYWZlKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVgudGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgbmFtZTogYCVzYCIsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDIgJiYgKG5hbWVbMF0gPT09ICJvIiB8fCBuYW1lWzBdID09PSAiTyIpICYmIChuYW1lWzFdID09PSAibiIgfHwgbmFtZVsxXSA9PT0gIk4iKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6IHsKICAgICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICFwcm9wZXJ0eUluZm8uYWNjZXB0c0Jvb2xlYW5zOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4MiA9IG5hbWUudG9Mb3dlckNhc2UoKS5zbGljZSgwLCA1KTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXgyICE9PSAiZGF0YS0iICYmIHByZWZpeDIgIT09ICJhcmlhLSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHlJbmZvLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIEJPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gIXZhbHVlOwogICAgICAgICAgICAgIGNhc2UgT1ZFUkxPQURFRF9CT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgICBjYXNlIE5VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgUE9TSVRJVkVfTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgfHwgdmFsdWUgPCAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFByb3BlcnR5SW5mbyhuYW1lKSB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IHByb3BlcnRpZXNbbmFtZV0gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBQcm9wZXJ0eUluZm9SZWNvcmQobmFtZSwgdHlwZSwgbXVzdFVzZVByb3BlcnR5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UsIHNhbml0aXplVVJMMiwgcmVtb3ZlRW1wdHlTdHJpbmcpIHsKICAgICAgICAgIHRoaXMuYWNjZXB0c0Jvb2xlYW5zID0gdHlwZSA9PT0gQk9PTEVBTklTSF9TVFJJTkcgfHwgdHlwZSA9PT0gQk9PTEVBTiB8fCB0eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU47CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBhdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICB0aGlzLm11c3RVc2VQcm9wZXJ0eSA9IG11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gbmFtZTsKICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICB0aGlzLnNhbml0aXplVVJMID0gc2FuaXRpemVVUkwyOwogICAgICAgICAgdGhpcy5yZW1vdmVFbXB0eVN0cmluZyA9IHJlbW92ZUVtcHR5U3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByZXNlcnZlZFByb3BzID0gWwogICAgICAgICAgImNoaWxkcmVuIiwKICAgICAgICAgICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICAvLyBUT0RPOiBUaGlzIHByZXZlbnRzIHRoZSBhc3NpZ25tZW50IG9mIGRlZmF1bHRWYWx1ZSB0byByZWd1bGFyCiAgICAgICAgICAvLyBlbGVtZW50cyAobm90IGp1c3QgaW5wdXRzKS4gTm93IHRoYXQgUmVhY3RET01JbnB1dCBhc3NpZ25zIHRvIHRoZQogICAgICAgICAgLy8gZGVmYXVsdFZhbHVlIHByb3BlcnR5IC0tIGRvIHdlIG5lZWQgdGhpcz8KICAgICAgICAgICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgICJpbm5lckhUTUwiLAogICAgICAgICAgInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgICJzdHlsZSIKICAgICAgICBdOwogICAgICAgIHJlc2VydmVkUHJvcHMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUkVTRVJWRUQsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFtbImFjY2VwdENoYXJzZXQiLCAiYWNjZXB0LWNoYXJzZXQiXSwgWyJjbGFzc05hbWUiLCAiY2xhc3MiXSwgWyJodG1sRm9yIiwgImZvciJdLCBbImh0dHBFcXVpdiIsICJodHRwLWVxdWl2Il1dLmZvckVhY2goZnVuY3Rpb24oX3JlZjIpIHsKICAgICAgICAgIHZhciBuYW1lID0gX3JlZjJbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmMlsxXTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiY29udGVudEVkaXRhYmxlIiwgImRyYWdnYWJsZSIsICJzcGVsbENoZWNrIiwgInZhbHVlIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJhdXRvUmV2ZXJzZSIsICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwgImZvY3VzYWJsZSIsICJwcmVzZXJ2ZUFscGhhIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgImFzeW5jIiwKICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgcHJldmVudHMgaXQgZnJvbSBiZWluZyB3cml0dGVuIHRvIHRoZSBET00KICAgICAgICAgIC8vIG9uIHRoZSBjbGllbnQgc2lkZSBiZWNhdXNlIHRoZSBicm93c2VycyBhcmUgaW5jb25zaXN0ZW50LiBJbnN0ZWFkIHdlIGNhbGwgZm9jdXMoKS4KICAgICAgICAgICJhdXRvRm9jdXMiLAogICAgICAgICAgImF1dG9QbGF5IiwKICAgICAgICAgICJjb250cm9scyIsCiAgICAgICAgICAiZGVmYXVsdCIsCiAgICAgICAgICAiZGVmZXIiLAogICAgICAgICAgImRpc2FibGVkIiwKICAgICAgICAgICJkaXNhYmxlUGljdHVyZUluUGljdHVyZSIsCiAgICAgICAgICAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICAiaGlkZGVuIiwKICAgICAgICAgICJsb29wIiwKICAgICAgICAgICJub01vZHVsZSIsCiAgICAgICAgICAibm9WYWxpZGF0ZSIsCiAgICAgICAgICAib3BlbiIsCiAgICAgICAgICAicGxheXNJbmxpbmUiLAogICAgICAgICAgInJlYWRPbmx5IiwKICAgICAgICAgICJyZXF1aXJlZCIsCiAgICAgICAgICAicmV2ZXJzZWQiLAogICAgICAgICAgInNjb3BlZCIsCiAgICAgICAgICAic2VhbWxlc3MiLAogICAgICAgICAgLy8gTWljcm9kYXRhCiAgICAgICAgICAiaXRlbVNjb3BlIgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2hlY2tlZCIsCiAgICAgICAgICAvLyBOb3RlOiBgb3B0aW9uLnNlbGVjdGVkYCBpcyBub3QgdXBkYXRlZCBpZiBgc2VsZWN0Lm11bHRpcGxlYCBpcwogICAgICAgICAgLy8gZGlzYWJsZWQgd2l0aCBgcmVtb3ZlQXR0cmlidXRlYC4gV2UgaGF2ZSBzcGVjaWFsIGxvZ2ljIGZvciBoYW5kbGluZyB0aGlzLgogICAgICAgICAgIm11bHRpcGxlIiwKICAgICAgICAgICJtdXRlZCIsCiAgICAgICAgICAic2VsZWN0ZWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNhcHR1cmUiLAogICAgICAgICAgImRvd25sb2FkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBPVkVSTE9BREVEX0JPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjb2xzIiwKICAgICAgICAgICJyb3dzIiwKICAgICAgICAgICJzaXplIiwKICAgICAgICAgICJzcGFuIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBQT1NJVElWRV9OVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInJvd1NwYW4iLCAic3RhcnQiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBOVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBDQU1FTElaRSA9IC9bXC1cOl0oW2Etel0pL2c7CiAgICAgICAgdmFyIGNhcGl0YWxpemUgPSBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgcmV0dXJuIHRva2VuWzFdLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfTsKICAgICAgICBbCiAgICAgICAgICAiYWNjZW50LWhlaWdodCIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSIsCiAgICAgICAgICAiYmFzZWxpbmUtc2hpZnQiLAogICAgICAgICAgImNhcC1oZWlnaHQiLAogICAgICAgICAgImNsaXAtcGF0aCIsCiAgICAgICAgICAiY2xpcC1ydWxlIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIiwKICAgICAgICAgICJmaWxsLW9wYWNpdHkiLAogICAgICAgICAgImZpbGwtcnVsZSIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiLAogICAgICAgICAgImZsb29kLW9wYWNpdHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IiwKICAgICAgICAgICJmb250LXNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiLAogICAgICAgICAgImZvbnQtc3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHlsZSIsCiAgICAgICAgICAiZm9udC12YXJpYW50IiwKICAgICAgICAgICJmb250LXdlaWdodCIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiLAogICAgICAgICAgImhvcml6LWFkdi14IiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyIsCiAgICAgICAgICAibGlnaHRpbmctY29sb3IiLAogICAgICAgICAgIm1hcmtlci1lbmQiLAogICAgICAgICAgIm1hcmtlci1taWQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCIsCiAgICAgICAgICAib3ZlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiLAogICAgICAgICAgInBhbm9zZS0xIiwKICAgICAgICAgICJwb2ludGVyLWV2ZW50cyIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIiwKICAgICAgICAgICJzdG9wLWNvbG9yIiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtcG9zaXRpb24iLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIiwKICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiLAogICAgICAgICAgInRleHQtYW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWRlY29yYXRpb24iLAogICAgICAgICAgInRleHQtcmVuZGVyaW5nIiwKICAgICAgICAgICJ1bmRlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSIsCiAgICAgICAgICAidW5pdHMtcGVyLWVtIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiLAogICAgICAgICAgInYtaGFuZ2luZyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1tYXRoZW1hdGljYWwiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiLAogICAgICAgICAgInZlcnQtYWR2LXkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXgiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiLAogICAgICAgICAgIndvcmQtc3BhY2luZyIsCiAgICAgICAgICAid3JpdGluZy1tb2RlIiwKICAgICAgICAgICJ4bWxuczp4bGluayIsCiAgICAgICAgICAieC1oZWlnaHQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bGluazphY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIiwKICAgICAgICAgICJ4bGluazpzaG93IiwKICAgICAgICAgICJ4bGluazp0aXRsZSIsCiAgICAgICAgICAieGxpbms6dHlwZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bWw6YmFzZSIsCiAgICAgICAgICAieG1sOmxhbmciLAogICAgICAgICAgInhtbDpzcGFjZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJ0YWJJbmRleCIsICJjcm9zc09yaWdpbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgeGxpbmtIcmVmID0gInhsaW5rSHJlZiI7CiAgICAgICAgcHJvcGVydGllc1t4bGlua0hyZWZdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICJ4bGlua0hyZWYiLAogICAgICAgICAgU1RSSU5HLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICJ4bGluazpocmVmIiwKICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgIHRydWUsCiAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIFsic3JjIiwgImhyZWYiLCAiYWN0aW9uIiwgImZvcm1BY3Rpb24iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBpc0phdmFTY3JpcHRQcm90b2NvbCA9IC9eW1x1MDAwMC1cdTAwMUYgXSpqW1xyXG5cdF0qYVtcclxuXHRdKnZbXHJcblx0XSphW1xyXG5cdF0qc1tcclxuXHRdKmNbXHJcblx0XSpyW1xyXG5cdF0qaVtcclxuXHRdKnBbXHJcblx0XSp0W1xyXG5cdF0qXDovaTsKICAgICAgICB2YXIgZGlkV2FybiA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMKHVybCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm4gJiYgaXNKYXZhU2NyaXB0UHJvdG9jb2wudGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgZGlkV2FybiA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIkEgZnV0dXJlIHZlcnNpb24gb2YgUmVhY3Qgd2lsbCBibG9jayBqYXZhc2NyaXB0OiBVUkxzIGFzIGEgc2VjdXJpdHkgcHJlY2F1dGlvbi4gVXNlIGV2ZW50IGhhbmRsZXJzIGluc3RlYWQgaWYgeW91IGNhbi4gSWYgeW91IG5lZWQgdG8gZ2VuZXJhdGUgdW5zYWZlIEhUTUwgdHJ5IHVzaW5nIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIGluc3RlYWQuIFJlYWN0IHdhcyBwYXNzZWQgJXMuIiwgSlNPTi5zdHJpbmdpZnkodXJsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoIiIgKyBleHBlY3RlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1ZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTikgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gbnVsbCA/IGV4cGVjdGVkIDogc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmdWYWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yQXR0cmlidXRlKG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFub2RlLmhhc0F0dHJpYnV0ZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgdmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgaWYgKHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgfHwgcHJvcGVydHlJbmZvID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIF9hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lLCAiIiArIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG11c3RVc2VQcm9wZXJ0eSA9IHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICBpZiAobXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHR5cGUgPT09IEJPT0xFQU4gPyBmYWxzZSA6ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlOwogICAgICAgICAgICBpZiAoX3R5cGUgPT09IEJPT0xFQU4gfHwgX3R5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTiAmJiB2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoYXR0cmlidXRlVmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVOYW1lc3BhY2UpIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZU5TKGF0dHJpYnV0ZU5hbWVzcGFjZSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBmaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZS5yZW5kZXIpOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluZm8gKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeDIubWVzc2FnZSArICJcbiIgKyB4Mi5zdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBvdXRlclR5cGUuZGlzcGxheU5hbWUgfHwgKGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUkMSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIkNhY2hlIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiAiRGVoeWRyYXRlZEZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudDMgPSBudWxsOwogICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50My5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50Myk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudDMgPSBmaWJlcjsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQ2ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Ni5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQ0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzOC5DaGlsZHJlbi5mb3JFYWNoKHByb3BzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaW5mZXIgdGhlIG9wdGlvbiB2YWx1ZSBvZiBjb21wbGV4IGNoaWxkcmVuLiBQYXNzIGEgYHZhbHVlYCBwcm9wIG9yIHVzZSBhIHBsYWluIHN0cmluZyBhcyBjaGlsZHJlbiB0byA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlBhc3MgYSBgdmFsdWVgIHByb3AgaWYgeW91IHNldCBkYW5nZXJvdXNseUlubmVySFRNTCBzbyBSZWFjdCBrbm93cyB3aGljaCB2YWx1ZSBzaG91bGQgYmUgc2VsZWN0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgb24gPHNlbGVjdD4gaW5zdGVhZCBvZiBzZXR0aW5nIGBzZWxlY3RlZGAgb24gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSkpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhLCBiKSB7CiAgICAgICAgICBpZiAoaXNJbnNpZGVFdmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIpOwogICAgICAgICAgfQogICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGJhdGNoZWRVcGRhdGVzSW1wbChmbiwgYSwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kaXNwYXRjaEV2ZW50ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tEZXYobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgZG9jdW1lbnRgIGdsb2JhbCB3YXMgZGVmaW5lZCB3aGVuIFJlYWN0IHdhcyBpbml0aWFsaXplZCwgYnV0IGlzIG5vdCBkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgc2NoZWR1bGVzIGFuIHVwZGF0ZSBmcm9tIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjaywgYnV0IHRoZSB0ZXN0IGhhcyBhbHJlYWR5IGZpbmlzaGVkIHJ1bm5pbmcuIFRvIHNvbHZlIHRoaXMsIHlvdSBjYW4gZWl0aGVyIHVubW91bnQgdGhlIGNvbXBvbmVudCBhdCB0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgY2FuY2VsZWQgaW4gYGNvbXBvbmVudFdpbGxVbm1vdW50YCksIG9yIHlvdSBjYW4gY2hhbmdlIHRoZSB0ZXN0IGl0c2VsZiB0byBiZSBhc3luY2hyb25vdXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICB2YXIgZGlkQ2FsbCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdywgImV2ZW50Iik7CiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUFmdGVyRGlzcGF0Y2goKSB7CiAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LmV2ZW50ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoImV2ZW50IikpIHsKICAgICAgICAgICAgICAgICAgd2luZG93LmV2ZW50ID0gd2luZG93RXZlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgIGRpZENhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICB2YXIgZGlkU2V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IGV2ZW50LmVycm9yOwogICAgICAgICAgICAgICAgZGlkU2V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgaXNDcm9zc09yaWdpbkVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiB0eXBlb2YgZXJyb3IyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIGZha2VOb2RlLmRpc3BhdGNoRXZlbnQoZXZ0KTsKICAgICAgICAgICAgICBpZiAod2luZG93RXZlbnREZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkQ2FsbCAmJiBkaWRFcnJvcikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoYEFuIGVycm9yIHdhcyB0aHJvd24gaW5zaWRlIG9uZSBvZiB5b3VyIGNvbXBvbmVudHMsIGJ1dCBSZWFjdCBkb2Vzbid0IGtub3cgd2hhdCBpdCB3YXMuIFRoaXMgaXMgbGlrZWx5IGR1ZSB0byBicm93c2VyIGZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uIGV4Y2VwdGlvbnMiIGJlaGF2aW9yIG9mIHRoZSBEZXZUb29scywgd2hpY2ggcmVxdWlyZXMgc29tZSBERVYtbW9kZSBvbmx5IHRyaWNrcy4gSXQncyBwb3NzaWJsZSB0aGF0IHRoZXNlIGRvbid0IHdvcmsgaW4geW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCBvciBzd2l0Y2hpbmcgdG8gYSBtb2Rlcm4gYnJvd3Nlci4gSWYgeW91IHN1c3BlY3QgdGhhdCB0aGlzIGlzIGFjdHVhbGx5IGFuIGlzc3VlIHdpdGggUmVhY3QsIHBsZWFzZSBmaWxlIGFuIGlzc3VlLmApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nyb3NzT3JpZ2luRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBpZiAoIWRpZENhbGwpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgdmFyIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIHJlcG9ydGVyID0gewogICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgIGlmICghaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBoYXNFcnJvcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGVycm9yMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2xlYXJDYXVnaHRFcnJvciB3YXMgY2FsbGVkIGJ1dCBubyBlcnJvciB3YXMgY2FwdHVyZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldDUoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzMyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldDMoa2V5LCB2YWx1ZSkgewogICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUGxhY2VtZW50ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgVXBkYXRlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIENvbnRlbnRSZXNldCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBDYWxsYmFjayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZUNsaWVudFJlbmRlciA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZjIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmMiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIExheW91dE1hc2sgPSBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZjIgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbjIoe30sIGludGVybmFscywgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgICAgICAgaW5qZWN0ZWRIb29rID0gaG9vazsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMuIiwgZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhvb2suY2hlY2tEQ0UpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uU2NoZWR1bGVSb290KHJvb3QzLCBjaGlsZHJlbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdChyZW5kZXJlcklELCByb290MywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290KHJvb3QzLCBldmVudFByaW9yaXR5KSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSAocm9vdDMuY3VycmVudC5mbGFncyAmIERpZENhcHR1cmUpID09PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyKSB7CiAgICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSWRsZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgc2NoZWR1bGVyUHJpb3JpdHksIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCB2b2lkIDAsIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uUG9zdENvbW1pdFJvb3Qocm9vdDMpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRVbm1vdW50KGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQocmVuZGVyZXJJRCwgZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhuZXdJc1N0cmljdE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB1bnN0YWJsZV95aWVsZFZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICBzZXRTdXBwcmVzc1dhcm5pbmcobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZShyZW5kZXJlcklELCBuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RQcm9maWxpbmdIb29rcyhwcm9maWxpbmdIb29rcykgewogICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IHByb2ZpbGluZ0hvb2tzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMYW5lTGFiZWxNYXAoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleDIgPSAwOyBpbmRleDIgPCBUb3RhbExhbmVzOyBpbmRleDIrKykgewogICAgICAgICAgICAgIHZhciBsYWJlbCA9IGdldExhYmVsRm9yTGFuZShsYW5lKTsKICAgICAgICAgICAgICBtYXAzLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJZaWVsZGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIENvbmN1cnJlbnRNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUHJvZmlsZU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RMZWdhY3lNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdEVmZmVjdHNNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIGNsejMyID0gTWF0aC5jbHozMiA/IE1hdGguY2x6MzIgOiBjbHozMkZhbGxiYWNrOwogICAgICAgIHZhciBsb2cyID0gTWF0aC5sb2c7CiAgICAgICAgdmFyIExOMiA9IE1hdGguTE4yOwogICAgICAgIGZ1bmN0aW9uIGNsejMyRmFsbGJhY2soeDIpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4MiA+Pj4gMDsKICAgICAgICAgIGlmIChhc1VpbnQgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDMyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDMxIC0gKGxvZzIoYXNVaW50KSAvIExOMiB8IDApIHwgMDsKICAgICAgICB9CiAgICAgICAgdmFyIFRvdGFsTGFuZXMgPSAzMTsKICAgICAgICB2YXIgTm9MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBTeW5jTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0SHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0TGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQyNDAKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU3ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTAgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjIxNDQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MjQyODgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMwMDIzNDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjc3NzIxNgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjcxMDg4NjQKICAgICAgICApOwogICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICB2YXIgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICovCiAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICApOwogICAgICAgIHZhciBOb25JZGxlTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NQogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU2CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICApOwogICAgICAgIHZhciBPZmZzY3JlZW5MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNzM3NDE4MjQKICAgICAgICApOwogICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChsYW5lICYgU3luY0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0SHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0TGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgUmV0cnlMYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vVGltZXN0YW1wID0gLTE7CiAgICAgICAgdmFyIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBSZXRyeUxhbmVzOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlTGFuZTsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0TGFuZXMocm9vdDMsIHdpcExhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHBlbmRpbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBub25JZGxlUGVuZGluZ0xhbmVzID0gcGVuZGluZ0xhbmVzICYgTm9uSWRsZUxhbmVzOwogICAgICAgICAgaWYgKG5vbklkbGVQZW5kaW5nTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlVW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlVW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub25JZGxlUGluZ2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVQaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bmJsb2NrZWRMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKHVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChwaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3aXBMYW5lcyAhPT0gTm9MYW5lcyAmJiB3aXBMYW5lcyAhPT0gbmV4dExhbmVzICYmIC8vIElmIHdlIGFscmVhZHkgc3VzcGVuZGVkIHdpdGggYSBkZWxheSwgdGhlbiBpbnRlcnJ1cHRpbmcgaXMgZmluZS4gRG9uJ3QKICAgICAgICAgIC8vIGJvdGhlciB3YWl0aW5nIHVudGlsIHRoZSByb290IGlzIGNvbXBsZXRlLgogICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIHdpcExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHdpcExhbmVzKTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIFRlc3RzIHdoZXRoZXIgdGhlIG5leHQgbGFuZSBpcyBlcXVhbCBvciBsb3dlciBwcmlvcml0eSB0aGFuIHRoZSB3aXAKICAgICAgICAgICAgICAvLyBvbmUuIFRoaXMgd29ya3MgYmVjYXVzZSB0aGUgYml0cyBkZWNyZWFzZSBpbiBwcmlvcml0eSBhcyB5b3UgZ28gbGVmdC4KICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgIC8vIG9ubHkgZGlmZmVyZW5jZSBiZXR3ZWVuIGRlZmF1bHQgdXBkYXRlcyBhbmQgdHJhbnNpdGlvbiB1cGRhdGVzIGlzIHRoYXQKICAgICAgICAgICAgICAvLyBkZWZhdWx0IHVwZGF0ZXMgZG8gbm90IHN1cHBvcnQgcmVmcmVzaCB0cmFuc2l0aW9ucy4KICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHJldHVybiB3aXBMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChuZXh0TGFuZXMgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lczsKICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IG5leHRMYW5lcyAmIGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgyXTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV2ZW50VGltZSA+IG1vc3RSZWNlbnRFdmVudFRpbWUpIHsKICAgICAgICAgICAgICBtb3N0UmVjZW50RXZlbnRUaW1lID0gZXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSkgewogICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDI1MDsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA9PT0gTm9UaW1lc3RhbXApIHsKICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgfD0gbGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgIHZhciBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfk9mZnNjcmVlbkxhbmU7CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1N5bmNMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0xhbmUpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc05vbklkbGVXb3JrKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgTm9uSWRsZUxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFJldHJ5TGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHZhciBVcmdlbnRMYW5lcyA9IFN5bmNMYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jRGVmYXVsdExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiByb290My5leHBpcmVkTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgIHJldHVybiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFJldHJ5TGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgIG5leHRSZXRyeUxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRSZXRyeUxhbmUgJiBSZXRyeUxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gbGFuZXMgJiAtbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAzMSAtIGNsejMyKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvSW5kZXgobGFuZSkgewogICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU29tZUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIChhICYgYikgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3Vic2V0T2ZMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiAoc2V0NCAmIHN1YnNldCkgPT09IHN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVyZ2VMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSB8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIHNldDQgJiB+c3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3RMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAmIGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0xhbmVzKGxhbmUpIHsKICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJQcmlvcml0eUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IE5vTGFuZSAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVMYW5lTWFwKGluaXRpYWwpIHsKICAgICAgICAgIHZhciBsYW5lTWFwID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IFRvdGFsTGFuZXM7IGkrKykgewogICAgICAgICAgICBsYW5lTWFwLnB1c2goaW5pdGlhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZU1hcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCB1cGRhdGVMYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyB8PSB1cGRhdGVMYW5lOwogICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IElkbGVMYW5lKSB7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KHVwZGF0ZUxhbmUpOwogICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDJdID0gZXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzIHw9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgJj0gfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMsIGV2ZW50VGltZSkgewogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgfD0gcm9vdDMuc3VzcGVuZGVkTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RGaW5pc2hlZChyb290MywgcmVtYWluaW5nTGFuZXMpIHsKICAgICAgICAgIHZhciBub0xvbmdlclBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5yZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyA9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMubXV0YWJsZVJlYWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLmVudGFuZ2xlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IG5vTG9uZ2VyUGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSA9IE5vTGFuZXM7CiAgICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIGVudGFuZ2xlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcm9vdEVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXMgfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSByb290RW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gSXMgdGhpcyBvbmUgb2YgdGhlIG5ld2x5IGVudGFuZ2xlZCBsYW5lcz8KICAgICAgICAgICAgICBsYW5lICYgZW50YW5nbGVkTGFuZXMgfCAvLyBJcyB0aGlzIGxhbmUgdHJhbnNpdGl2ZWx5IGVudGFuZ2xlZCB3aXRoIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdICYgZW50YW5nbGVkTGFuZXMKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciByZW5kZXJMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGxhbmU7CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlckxhbmUpIHsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICBsYW5lID0gVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhbmUgPSBOb0xhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGxhbmUgJiAocm9vdDMuc3VzcGVuZGVkTGFuZXMgfCByZW5kZXJMYW5lczIpKSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZXMpIHsKICAgICAgICAgIGlmICghaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSByb290My5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4Ml07CiAgICAgICAgICAgIHVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICBpZiAodXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB1cGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCAhbWVtb2l6ZWRVcGRhdGVycy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBEaXNjcmV0ZUV2ZW50UHJpb3JpdHkgPSBTeW5jTGFuZTsKICAgICAgICB2YXIgQ29udGludW91c0V2ZW50UHJpb3JpdHkgPSBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgIHZhciBEZWZhdWx0RXZlbnRQcmlvcml0eSA9IERlZmF1bHRMYW5lOwogICAgICAgIHZhciBJZGxlRXZlbnRQcmlvcml0eSA9IElkbGVMYW5lOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KG5ld1ByaW9yaXR5KSB7CiAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBuZXdQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5LCBmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmV2aW91c1ByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvd2VyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gMCB8fCBhID4gYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hpZ2hlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IDAgJiYgYSA8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVzVG9FdmVudFByaW9yaXR5KGxhbmVzKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc05vbklkbGVXb3JrKGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHJvb3QzLmN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUuaXNEZWh5ZHJhdGVkOwogICAgICAgIH0KICAgICAgICB2YXIgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMTsKICAgICAgICBmdW5jdGlvbiBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICB2YXIgcXVldWVkRGlzY3JldGVFdmVudHMgPSBbXTsKICAgICAgICB2YXIgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cyA9IFtdOwogICAgICAgIHZhciBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMgPSBbCiAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICJtb3VzZXVwIiwKICAgICAgICAgICJ0b3VjaGNhbmNlbCIsCiAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgInRvdWNoc3RhcnQiLAogICAgICAgICAgImF1eGNsaWNrIiwKICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAicG9pbnRlcmNhbmNlbCIsCiAgICAgICAgICAicG9pbnRlcmRvd24iLAogICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAiZHJhZ2VuZCIsCiAgICAgICAgICAiZHJhZ3N0YXJ0IiwKICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICJjb21wb3NpdGlvbmVuZCIsCiAgICAgICAgICAiY29tcG9zaXRpb25zdGFydCIsCiAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAia2V5cHJlc3MiLAogICAgICAgICAgImtleXVwIiwKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAidGV4dElucHV0IiwKICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgY2FtZWxDYXNlCiAgICAgICAgICAiY29weSIsCiAgICAgICAgICAiY3V0IiwKICAgICAgICAgICJwYXN0ZSIsCiAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgImNoYW5nZSIsCiAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICJzdWJtaXQiCiAgICAgICAgXTsKICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzLmluZGV4T2YoZXZlbnRUeXBlKSA+IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJsb2NrZWRPbiwKICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzLAogICAgICAgICAgICBuYXRpdmVFdmVudCwKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmRlbGV0ZShwb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5kZWxldGUoX3BvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChleGlzdGluZ1F1ZXVlZEV2ZW50LCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGV4aXN0aW5nUXVldWVkRXZlbnQgPT09IG51bGwgfHwgZXhpc3RpbmdRdWV1ZWRFdmVudC5uYXRpdmVFdmVudCAhPT0gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZmliZXIyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IGV4aXN0aW5nUXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIGlmICh0YXJnZXRDb250YWluZXIgIT09IG51bGwgJiYgdGFyZ2V0Q29udGFpbmVycy5pbmRleE9mKHRhcmdldENvbnRhaW5lcikgPT09IC0xKSB7CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXN0aW5nUXVldWVkRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgdmFyIGZvY3VzRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRm9jdXMsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGZvY3VzRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6IHsKICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRHJhZywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZHJhZ0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIG1vdXNlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgIHZhciBwb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQyID0gX3BvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShxdWV1ZWRUYXJnZXQudGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocXVldWVkVGFyZ2V0LnByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gewogICAgICAgICAgICBibG9ja2VkT246IG51bGwsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgcHJpb3JpdHk6IHVwZGF0ZVByaW9yaXR5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkodXBkYXRlUHJpb3JpdHksIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tpXS5wcmlvcml0eSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgd2hpbGUgKHRhcmdldENvbnRhaW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyc1swXTsKICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRDbG9uZSA9IG5ldyBuYXRpdmVFdmVudC5jb25zdHJ1Y3RvcihuYXRpdmVFdmVudC50eXBlLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgICBzZXRSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgcmVzZXRSZXBsYXlpbmdFdmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMyA9IGdldEluc3RhbmNlRnJvbU5vZGUobmV4dEJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcDMpIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXBsYXlVbmJsb2NrZWRFdmVudHMoKSB7CiAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRGb2N1cykpIHsKICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWREcmFnKSkgewogICAgICAgICAgICBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZE1vdXNlKSkgewogICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQsIHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCkgewogICAgICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSB0cnVlOwogICAgICAgICAgICAgIFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSwgcmVwbGF5VW5ibG9ja2VkRXZlbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeUlmQmxvY2tlZE9uKHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERpc2NyZXRlRXZlbnRzWzBdLCB1bmJsb2NrZWQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gcXVldWVkRGlzY3JldGVFdmVudHNbaV07CiAgICAgICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRGb2N1cywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREcmFnLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRNb3VzZSwgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1bmJsb2NrID0gZnVuY3Rpb24ocXVldWVkRXZlbnQyKSB7CiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQyLCB1bmJsb2NrZWQpOwogICAgICAgICAgfTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbX2ldOwogICAgICAgICAgICBpZiAocXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV4dEV4cGxpY2l0VGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzWzBdOwogICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChuZXh0RXhwbGljaXRUYXJnZXQpOwogICAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMuc2hpZnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIF9lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBzZXRFbmFibGVkKGVuYWJsZWQpIHsKICAgICAgICAgIF9lbmFibGVkID0gISFlbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgICAgICByZXR1cm4gX2VuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgZXZlbnRQcmlvcml0eSA9IGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIHZhciBsaXN0ZW5lcldyYXBwZXI7CiAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoQ29udGludW91c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJXcmFwcGVyLmJpbmQobnVsbCwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaERpc2NyZXRlRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoIV9lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UgJiYgaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgd2hpbGUgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBibG9ja2VkT24pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgbnVsbCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50VGFyZ2V0ID0gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpOwogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmVhcmVzdE1vdW50ZWQgIT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgIGNhc2UgImNsb3NlIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJpbnZhbGlkIjoKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICBjYXNlICJwYXVzZSI6CiAgICAgICAgICAgIGNhc2UgInBsYXkiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICBjYXNlICJyYXRlY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicmVzZXQiOgogICAgICAgICAgICBjYXNlICJyZXNpemUiOgogICAgICAgICAgICBjYXNlICJzZWVrZWQiOgogICAgICAgICAgICBjYXNlICJzdWJtaXQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgIGNhc2UgInZvbHVtZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWlucHV0IjoKICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImZ1bGxzY3JlZW5jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJmb2N1cyI6CiAgICAgICAgICAgIGNhc2UgImhhc2hjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJwb3BzdGF0ZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdHN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICBjYXNlICJ0b2dnbGUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZW50ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmVudGVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmxlYXZlIjoKICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2UiOiB7CiAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5ID0gZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVkdWxlclByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcm9vdDIgPSBudWxsOwogICAgICAgIHZhciBzdGFydFRleHQgPSBudWxsOwogICAgICAgIHZhciBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHJvb3QyID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICBzdGFydFRleHQgPSBnZXRUZXh0KCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICByb290MiA9IG51bGw7CiAgICAgICAgICBzdGFydFRleHQgPSBudWxsOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICAgIGlmIChmYWxsYmFja1RleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgIHZhciBzdGFydFZhbHVlID0gc3RhcnRUZXh0OwogICAgICAgICAgdmFyIHN0YXJ0TGVuZ3RoID0gc3RhcnRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICB2YXIgZW5kOwogICAgICAgICAgdmFyIGVuZFZhbHVlID0gZ2V0VGV4dCgpOwogICAgICAgICAgdmFyIGVuZExlbmd0aCA9IGVuZFZhbHVlLmxlbmd0aDsKICAgICAgICAgIGZvciAoc3RhcnQgPSAwOyBzdGFydCA8IHN0YXJ0TGVuZ3RoOyBzdGFydCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0XSAhPT0gZW5kVmFsdWVbc3RhcnRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaW5FbmQgPSBzdGFydExlbmd0aCAtIHN0YXJ0OwogICAgICAgICAgZm9yIChlbmQgPSAxOyBlbmQgPD0gbWluRW5kOyBlbmQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydExlbmd0aCAtIGVuZF0gIT09IGVuZFZhbHVlW2VuZExlbmd0aCAtIGVuZF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHNsaWNlVGFpbCA9IGVuZCA+IDEgPyAxIC0gZW5kIDogdm9pZCAwOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gZW5kVmFsdWUuc2xpY2Uoc3RhcnQsIHNsaWNlVGFpbCk7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KCkgewogICAgICAgICAgaWYgKCJ2YWx1ZSIgaW4gcm9vdDIpIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3QyLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3QyLnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2hhckNvZGU7CiAgICAgICAgICB2YXIga2V5Q29kZSA9IG5hdGl2ZUV2ZW50LmtleUNvZGU7CiAgICAgICAgICBpZiAoImNoYXJDb2RlIiBpbiBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IG5hdGl2ZUV2ZW50LmNoYXJDb2RlOwogICAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDAgJiYga2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFyQ29kZSA9IGtleUNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDEwKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPj0gMzIgfHwgY2hhckNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZSgpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2UoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEludGVyZmFjZSkgewogICAgICAgICAgZnVuY3Rpb24gU3ludGhldGljQmFzZUV2ZW50KHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB0aGlzLl9yZWFjdE5hbWUgPSByZWFjdE5hbWU7CiAgICAgICAgICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0aGlzLnR5cGUgPSByZWFjdEV2ZW50VHlwZTsKICAgICAgICAgICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBfcHJvcE5hbWUgaW4gSW50ZXJmYWNlKSB7CiAgICAgICAgICAgICAgaWYgKCFJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkoX3Byb3BOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub3JtYWxpemUyID0gSW50ZXJmYWNlW19wcm9wTmFtZV07CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZTIpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZTIobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBuYXRpdmVFdmVudFtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgIT0gbnVsbCA/IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgOiBuYXRpdmVFdmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2lnbjIoU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAqIHRoZW0gYmFjayBpbnRvIHRoZSBwb29sLiBUaGlzIGFsbG93cyBhIHdheSB0byBob2xkIG9udG8gYSByZWZlcmVuY2UgdGhhdAogICAgICAgICAgICAgKiB3b24ndCBiZSBhZGRlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwZXJzaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBpZiB0aGlzIGV2ZW50IHNob3VsZCBiZSByZWxlYXNlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc1BlcnNpc3RlbnQ6IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBTeW50aGV0aWNCYXNlRXZlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgIGV2ZW50UGhhc2U6IDAsCiAgICAgICAgICBidWJibGVzOiAwLAogICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgIHRpbWVTdGFtcDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwogICAgICAgICAgfSwKICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IDAsCiAgICAgICAgICBpc1RydXN0ZWQ6IDAKICAgICAgICB9OwogICAgICAgIHZhciBTeW50aGV0aWNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVUlFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHNjcmVlblg6IDAsCiAgICAgICAgICBzY3JlZW5ZOiAwLAogICAgICAgICAgY2xpZW50WDogMCwKICAgICAgICAgIGNsaWVudFk6IDAsCiAgICAgICAgICBwYWdlWDogMCwKICAgICAgICAgIHBhZ2VZOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIGJ1dHRvbjogMCwKICAgICAgICAgIGJ1dHRvbnM6IDAsCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCA9PT0gdm9pZCAwKSByZXR1cm4gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnNyY0VsZW1lbnQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRYOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WCIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRYOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WSIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRZOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNNb3VzZUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoTW91c2VFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIERyYWdFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGFUcmFuc2ZlcjogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBGb2N1c0V2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGFuaW1hdGlvbk5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQW5pbWF0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChBbmltYXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIENsaXBib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiY2xpcGJvYXJkRGF0YSIgaW4gZXZlbnQgPyBldmVudC5jbGlwYm9hcmREYXRhIDogd2luZG93LmNsaXBib2FyZERhdGE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBrZXk6IGdldEV2ZW50S2V5LAogICAgICAgICAgY29kZTogMCwKICAgICAgICAgIGxvY2F0aW9uOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIHJlcGVhdDogMCwKICAgICAgICAgIGxvY2FsZTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIC8vIExlZ2FjeSBJbnRlcmZhY2UKICAgICAgICAgIGNoYXJDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBrZXlDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICB3aGljaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0tleWJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChLZXlib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgUG9pbnRlckV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICBoZWlnaHQ6IDAsCiAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgIHRhbmdlbnRpYWxQcmVzc3VyZTogMCwKICAgICAgICAgIHRpbHRYOiAwLAogICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICB0d2lzdDogMCwKICAgICAgICAgIHBvaW50ZXJUeXBlOiAwLAogICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1BvaW50ZXJFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFBvaW50ZXJFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVHJhbnNpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgV2hlZWxFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVgiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFYIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWGAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChyaWdodCBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFZIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWSA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVlgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhYCBmb3IgSUU8OSBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAgICJ3aGVlbERlbHRhIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhIDogMAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAvLyBCcm93c2VycyB3aXRob3V0ICJkZWx0YU1vZGUiIGlzIHJlcG9ydGluZyBpbiByYXcgd2hlZWwgZGVsdGEgd2hlcmUgb25lCiAgICAgICAgICAvLyBub3RjaCBvbiB0aGUgc2Nyb2xsIGlzIGFsd2F5cyArLy0gMTIwLCByb3VnaGx5IGVxdWl2YWxlbnQgdG8gcGl4ZWxzLgogICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgIC8vIH40MCBwaXhlbHMsIGZvciBET01fREVMVEFfU0NSRUVOICgyKSBpdCBpcyA4Ny41JSBvZiB2aWV3cG9ydCBzaXplLgogICAgICAgICAgZGVsdGFNb2RlOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1doZWVsRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChXaGVlbEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRU5EX0tFWUNPREVTID0gWzksIDEzLCAyNywgMzJdOwogICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgIHZhciBjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50KSB7CiAgICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VUZXh0SW5wdXRFdmVudCA9IGNhblVzZURPTTIgJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgdmFyIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhID0gY2FuVXNlRE9NMiAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTTIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICJvbiIgKyBldmVudE5hbWVTdWZmaXg7CiAgICAgICAgICB2YXIgaXNTdXBwb3J0ZWQgPSBldmVudE5hbWUgaW4gZG9jdW1lbnQ7CiAgICAgICAgICBpZiAoIWlzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsKICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0eXBlb2YgZWxlbWVudFtldmVudE5hbWVdID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQxKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNoYW5nZSIsIFsiY2hhbmdlIiwgImNsaWNrIiwgImZvY3VzaW4iLCAiZm9jdXNvdXQiLCAiaW5wdXQiLCAia2V5ZG93biIsICJrZXl1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgdGFyZ2V0KSB7CiAgICAgICAgICBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGluc3QsICJvbkNoYW5nZSIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25DaGFuZ2UiLCAiY2hhbmdlIiwgbnVsbCwgbmF0aXZlRXZlbnQsIHRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDaGFuZ2VFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSA9PT0gInNlbGVjdCIgfHwgbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiZmlsZSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgYWN0aXZlRWxlbWVudEluc3QsIG5hdGl2ZUV2ZW50LCBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkpOwogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMocnVuRXZlbnRJbkJhdGNoLCBkaXNwYXRjaFF1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuRXZlbnRJbkJhdGNoKGRpc3BhdGNoUXVldWUpIHsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIDApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCkgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpOwogICAgICAgICAgaWYgKHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzSW5wdXRFdmVudFN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBpc0V2ZW50U3VwcG9ydGVkKCJpbnB1dCIpICYmICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gdGFyZ2V0OwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgYWN0aXZlRWxlbWVudC5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICBpZiAoIWFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlRWxlbWVudC5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcm9wZXJ0eUNoYW5nZShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNpbiIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInNlbGVjdGlvbmNoYW5nZSIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5dXAiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDbGlja0V2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0udHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNsaWNrIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIobm9kZSkgewogICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5fd3JhcHBlclN0YXRlOwogICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsICJudW1iZXIiLCBub2RlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgIGlmIChzaG91bGRVc2VDaGFuZ2VFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGlmIChpc0lucHV0RXZlbnRTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyA9IGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRVc2VDbGlja0V2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0VGFyZ2V0SW5zdEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBnZXRUYXJnZXRJbnN0RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhbmRsZUV2ZW50RnVuYykgewogICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VFbnRlciIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUxlYXZlIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckxlYXZlIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGlzT3ZlckV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdmVyIiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciI7CiAgICAgICAgICB2YXIgaXNPdXRFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IjsKICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgdmFyIHJlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVsYXRlZCkgewogICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc091dEV2ZW50ICYmICFpc092ZXJFdmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2luOwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgd2luID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgICAgIHdpbiA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb20yOwogICAgICAgICAgdmFyIHRvMjsKICAgICAgICAgIGlmIChpc091dEV2ZW50KSB7CiAgICAgICAgICAgIHZhciBfcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQudG9FbGVtZW50OwogICAgICAgICAgICBmcm9tMiA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRvMiA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodG8yKTsKICAgICAgICAgICAgICBpZiAodG8yICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0bzIudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHRvMi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICB0bzIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbTIgPSBudWxsOwogICAgICAgICAgICB0bzIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZyb20yID09PSB0bzIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICB2YXIgbGVhdmVFdmVudFR5cGUgPSAib25Nb3VzZUxlYXZlIjsKICAgICAgICAgIHZhciBlbnRlckV2ZW50VHlwZSA9ICJvbk1vdXNlRW50ZXIiOwogICAgICAgICAgdmFyIGV2ZW50VHlwZVByZWZpeCA9ICJtb3VzZSI7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiKSB7CiAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgbGVhdmVFdmVudFR5cGUgPSAib25Qb2ludGVyTGVhdmUiOwogICAgICAgICAgICBlbnRlckV2ZW50VHlwZSA9ICJvblBvaW50ZXJFbnRlciI7CiAgICAgICAgICAgIGV2ZW50VHlwZVByZWZpeCA9ICJwb2ludGVyIjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tTm9kZSA9IGZyb20yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20yKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0bzIgPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UodG8yKTsKICAgICAgICAgIHZhciBsZWF2ZSA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IobGVhdmVFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJsZWF2ZSIsIGZyb20yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bzIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGVudGVyRXZlbnQudGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgICBlbnRlckV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgZW50ZXIgPSBlbnRlckV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZSwgZW50ZXIsIGZyb20yLCB0bzIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICh4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzNDsKICAgICAgICBmdW5jdGlvbiBzaGFsbG93RXF1YWwyKG9iakEsIG9iakIpIHsKICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogICAgICAgICAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8ICFvYmplY3RJcyhvYmpBW2N1cnJlbnRLZXldLCBvYmpCW2N1cnJlbnRLZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWZOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNpYmxpbmdOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGdldExlYWZOb2RlKHJvb3QzKTsKICAgICAgICAgIHZhciBub2RlU3RhcnQgPSAwOwogICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAobm9kZVN0YXJ0IDw9IG9mZnNldCAmJiBub2RlRW5kID49IG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBvZmZzZXQgLSBub2RlU3RhcnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVTdGFydCA9IG5vZGVFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gb3V0ZXJOb2RlLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gb3duZXJEb2N1bWVudCAmJiBvd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uICYmIHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uLmFuY2hvck9mZnNldCwgZm9jdXNOb2RlID0gc2VsZWN0aW9uLmZvY3VzTm9kZSwgZm9jdXNPZmZzZXQgPSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhbmNob3JOb2RlLm5vZGVUeXBlOwogICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgICAgdmFyIHN0YXJ0ID0gLTE7CiAgICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluRm9jdXMgPSAwOwogICAgICAgICAgdmFyIG5vZGUgPSBvdXRlck5vZGU7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBvdXRlcjogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBhbmNob3JOb2RlICYmIChhbmNob3JPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmb2N1c05vZGUgJiYgKGZvY3VzT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLmZpcnN0Q2hpbGQpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGZvY3VzTm9kZSAmJiArK2luZGV4V2l0aGluRm9jdXMgPT09IGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUubmV4dFNpYmxpbmcpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEgfHwgZW5kID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICBlbmQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE9mZnNldHMobm9kZSwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICghd2luLmdldFNlbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgdmFyIHN0YXJ0ID0gTWF0aC5taW4ob2Zmc2V0cy5zdGFydCwgbGVuZ3RoKTsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZCA9PT0gdm9pZCAwID8gc3RhcnQgOiBNYXRoLm1pbihvZmZzZXRzLmVuZCwgbGVuZ3RoKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uLmV4dGVuZCAmJiBzdGFydCA+IGVuZCkgewogICAgICAgICAgICB2YXIgdGVtcCA9IGVuZDsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gdGVtcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQpOwogICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgIGlmIChzdGFydE1hcmtlciAmJiBlbmRNYXJrZXIpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAxICYmIHNlbGVjdGlvbi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5hbmNob3JPZmZzZXQgPT09IHN0YXJ0TWFya2VyLm9mZnNldCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlID09PSBlbmRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJhbmdlNCA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZTQuc2V0U3RhcnQoc3RhcnRNYXJrZXIubm9kZSwgc3RhcnRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICBpZiAoc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uZXh0ZW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByYW5nZTQuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7CiAgICAgICAgICBpZiAoIW91dGVyTm9kZSB8fCAhaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlID09PSBpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUob3V0ZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUoaW5uZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlLnBhcmVudE5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbnMiIGluIG91dGVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlLmNvbnRhaW5zKGlubmVyTm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gISEob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGlubmVyTm9kZSkgJiAxNik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW5Eb2N1bWVudChub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm93bmVyRG9jdW1lbnQgJiYgY29udGFpbnNOb2RlKG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW5GcmFtZShpZnJhbWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaWZyYW1lLmNvbnRlbnRXaW5kb3cubG9jYXRpb24uaHJlZiA9PT0gInN0cmluZyI7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50RGVlcCgpIHsKICAgICAgICAgIHZhciB3aW4gPSB3aW5kb3c7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQoKTsKICAgICAgICAgIHdoaWxlIChlbGVtZW50IGluc3RhbmNlb2Ygd2luLkhUTUxJRnJhbWVFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChpc1NhbWVPcmlnaW5GcmFtZShlbGVtZW50KSkgewogICAgICAgICAgICAgIHdpbiA9IGVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCh3aW4uZG9jdW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAidGV4dCIgfHwgZWxlbS50eXBlID09PSAic2VhcmNoIiB8fCBlbGVtLnR5cGUgPT09ICJ0ZWwiIHx8IGVsZW0udHlwZSA9PT0gInVybCIgfHwgZWxlbS50eXBlID09PSAicGFzc3dvcmQiKSB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiB8fCBlbGVtLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZm9jdXNlZEVsZW0sCiAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlOiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZm9jdXNlZEVsZW0pID8gZ2V0U2VsZWN0aW9uKGZvY3VzZWRFbGVtKSA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24ocHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbikgewogICAgICAgICAgdmFyIGN1ckZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHZhciBwcmlvckZvY3VzZWRFbGVtID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5mb2N1c2VkRWxlbTsKICAgICAgICAgIHZhciBwcmlvclNlbGVjdGlvblJhbmdlID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5zZWxlY3Rpb25SYW5nZTsKICAgICAgICAgIGlmIChjdXJGb2N1c2VkRWxlbSAhPT0gcHJpb3JGb2N1c2VkRWxlbSAmJiBpc0luRG9jdW1lbnQocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgaWYgKHByaW9yU2VsZWN0aW9uUmFuZ2UgIT09IG51bGwgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uKHByaW9yRm9jdXNlZEVsZW0sIHByaW9yU2VsZWN0aW9uUmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvcnMgPSBbXTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9yID0gcHJpb3JGb2N1c2VkRWxlbTsKICAgICAgICAgICAgd2hpbGUgKGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmIChhbmNlc3Rvci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGFuY2VzdG9yLAogICAgICAgICAgICAgICAgICBsZWZ0OiBhbmNlc3Rvci5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICB0b3A6IGFuY2VzdG9yLnNjcm9sbFRvcAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFuY2VzdG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpbmZvID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxMZWZ0ID0gaW5mby5sZWZ0OwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvLnRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24oaW5wdXQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBzZWxlY3Rpb24gPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IGlucHV0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogaW5wdXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBnZXRPZmZzZXRzKGlucHV0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24gfHwgewogICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgZW5kOiAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oaW5wdXQsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IG9mZnNldHMuc3RhcnQ7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQ7CiAgICAgICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25TdGFydCA9IHN0YXJ0OwogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25FbmQgPSBNYXRoLm1pbihlbmQsIGlucHV0LnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRPZmZzZXRzKGlucHV0LCBvZmZzZXRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCA9IGNhblVzZURPTTIgJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbDIobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoYWN0aXZlRWxlbWVudEluc3QkMSwgIm9uU2VsZWN0Iik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25TZWxlY3QiLCAic2VsZWN0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpIHx8IHRhcmdldE5vZGUuY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBpZiAoc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFrZVByZWZpeE1hcChzdHlsZVByb3AsIGV2ZW50TmFtZSkgewogICAgICAgICAgdmFyIHByZWZpeGVzMyA9IHt9OwogICAgICAgICAgcHJlZml4ZXMzW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcHJlZml4ZXMzWyJXZWJraXQiICsgc3R5bGVQcm9wXSA9ICJ3ZWJraXQiICsgZXZlbnROYW1lOwogICAgICAgICAgcHJlZml4ZXMzWyJNb3oiICsgc3R5bGVQcm9wXSA9ICJtb3oiICsgZXZlbnROYW1lOwogICAgICAgICAgcmV0dXJuIHByZWZpeGVzMzsKICAgICAgICB9CiAgICAgICAgdmFyIHZlbmRvclByZWZpeGVzID0gewogICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICBhbmltYXRpb25pdGVyYXRpb246IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25JdGVyYXRpb24iKSwKICAgICAgICAgIGFuaW1hdGlvbnN0YXJ0OiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uU3RhcnQiKSwKICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgfTsKICAgICAgICB2YXIgcHJlZml4ZWRFdmVudE5hbWVzID0ge307CiAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgaWYgKGNhblVzZURPTTIpIHsKICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGU7CiAgICAgICAgICBpZiAoISgiQW5pbWF0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbmVuZC5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25pdGVyYXRpb24uYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uc3RhcnQuYW5pbWF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEoIlRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMudHJhbnNpdGlvbmVuZC50cmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZShldmVudE5hbWUpIHsKICAgICAgICAgIGlmIChwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV07CiAgICAgICAgICB9IGVsc2UgaWYgKCF2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJlZml4TWFwID0gdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlUHJvcCBpbiBwcmVmaXhNYXApIHsKICAgICAgICAgICAgaWYgKHByZWZpeE1hcC5oYXNPd25Qcm9wZXJ0eShzdHlsZVByb3ApICYmIHN0eWxlUHJvcCBpbiBzdHlsZSkgewogICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSA9IHByZWZpeE1hcFtzdHlsZVByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgIH0KICAgICAgICB2YXIgQU5JTUFUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25lbmQiKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTiA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25pdGVyYXRpb24iKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX1NUQVJUID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbnN0YXJ0Iik7CiAgICAgICAgdmFyIFRSQU5TSVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoInRyYW5zaXRpb25lbmQiKTsKICAgICAgICB2YXIgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cyA9IFsiYWJvcnQiLCAiYXV4Q2xpY2siLCAiY2FuY2VsIiwgImNhblBsYXkiLCAiY2FuUGxheVRocm91Z2giLCAiY2xpY2siLCAiY2xvc2UiLCAiY29udGV4dE1lbnUiLCAiY29weSIsICJjdXQiLCAiZHJhZyIsICJkcmFnRW5kIiwgImRyYWdFbnRlciIsICJkcmFnRXhpdCIsICJkcmFnTGVhdmUiLCAiZHJhZ092ZXIiLCAiZHJhZ1N0YXJ0IiwgImRyb3AiLCAiZHVyYXRpb25DaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAiZ290UG9pbnRlckNhcHR1cmUiLCAiaW5wdXQiLCAiaW52YWxpZCIsICJrZXlEb3duIiwgImtleVByZXNzIiwgImtleVVwIiwgImxvYWQiLCAibG9hZGVkRGF0YSIsICJsb2FkZWRNZXRhZGF0YSIsICJsb2FkU3RhcnQiLCAibG9zdFBvaW50ZXJDYXB0dXJlIiwgIm1vdXNlRG93biIsICJtb3VzZU1vdmUiLCAibW91c2VPdXQiLCAibW91c2VPdmVyIiwgIm1vdXNlVXAiLCAicGFzdGUiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInBvaW50ZXJDYW5jZWwiLCAicG9pbnRlckRvd24iLCAicG9pbnRlck1vdmUiLCAicG9pbnRlck91dCIsICJwb2ludGVyT3ZlciIsICJwb2ludGVyVXAiLCAicHJvZ3Jlc3MiLCAicmF0ZUNoYW5nZSIsICJyZXNldCIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdWJtaXQiLCAic3VzcGVuZCIsICJ0aW1lVXBkYXRlIiwgInRvdWNoQ2FuY2VsIiwgInRvdWNoRW5kIiwgInRvdWNoU3RhcnQiLCAidm9sdW1lQ2hhbmdlIiwgInNjcm9sbCIsICJ0b2dnbGUiLCAidG91Y2hNb3ZlIiwgIndhaXRpbmciLCAid2hlZWwiXTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5zZXQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlYWN0TmFtZSwgW2RvbUV2ZW50TmFtZV0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50cygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzW2ldOwogICAgICAgICAgICB2YXIgZG9tRXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBjYXBpdGFsaXplZEV2ZW50ID0gZXZlbnROYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBldmVudE5hbWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCAib24iICsgY2FwaXRhbGl6ZWRFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9FTkQsICJvbkFuaW1hdGlvbkVuZCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fSVRFUkFUSU9OLCAib25BbmltYXRpb25JdGVyYXRpb24iKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX1NUQVJULCAib25BbmltYXRpb25TdGFydCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZGJsY2xpY2siLCAib25Eb3VibGVDbGljayIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNpbiIsICJvbkZvY3VzIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c291dCIsICJvbkJsdXIiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoVFJBTlNJVElPTl9FTkQsICJvblRyYW5zaXRpb25FbmQiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciByZWFjdE5hbWUgPSB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5nZXQoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIGlmIChyZWFjdE5hbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRXZlbnQ7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudFR5cGUgPSBkb21FdmVudE5hbWU7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0tleWJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImZvY3VzIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiYmx1ciI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5idXR0b24gPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRHJhZ0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVG91Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fRU5EOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9JVEVSQVRJT046CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX1NUQVJUOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRSQU5TSVRJT05fRU5EOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNVSUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljV2hlZWxFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNDbGlwYm9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJsb3N0cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjY3VtdWxhdGVUYXJnZXRPbmx5ID0gIWluQ2FwdHVyZVBoYXNlICYmIC8vIFRPRE86IGlkZWFsbHksIHdlJ2QgZXZlbnR1YWxseSBhZGQgYWxsIGV2ZW50cyBmcm9tCiAgICAgICAgICAgIC8vIG5vbkRlbGVnYXRlZEV2ZW50cyBsaXN0IGluIERPTVBsdWdpbkV2ZW50U3lzdGVtLgogICAgICAgICAgICAvLyBUaGVuIHdlIGNhbiByZW1vdmUgdGhpcyBzcGVjaWFsIGxpc3QuCiAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBicmVha2luZyBjaGFuZ2UgdGhhdCBjYW4gd2FpdCB1bnRpbCBSZWFjdCAxOC4KICAgICAgICAgICAgZG9tRXZlbnROYW1lID09PSAic2Nyb2xsIjsKICAgICAgICAgICAgdmFyIF9saXN0ZW5lcnMgPSBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudC50eXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHkpOwogICAgICAgICAgICBpZiAoX2xpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9ldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQ6IF9ldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogX2xpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMigpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDEoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMoKTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUykgPT09IDA7CiAgICAgICAgICBpZiAoc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucykgewogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1lZGlhRXZlbnRUeXBlcyA9IFsiYWJvcnQiLCAiY2FucGxheSIsICJjYW5wbGF5dGhyb3VnaCIsICJkdXJhdGlvbmNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJsb2FkZWRkYXRhIiwgImxvYWRlZG1ldGFkYXRhIiwgImxvYWRzdGFydCIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicHJvZ3Jlc3MiLCAicmF0ZWNoYW5nZSIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdXNwZW5kIiwgInRpbWV1cGRhdGUiLCAidm9sdW1lY2hhbmdlIiwgIndhaXRpbmciXTsKICAgICAgICB2YXIgbm9uRGVsZWdhdGVkRXZlbnRzID0gbmV3IFNldChbImNhbmNlbCIsICJjbG9zZSIsICJpbnZhbGlkIiwgImxvYWQiLCAic2Nyb2xsIiwgInRvZ2dsZSJdLmNvbmNhdChtZWRpYUV2ZW50VHlwZXMpKTsKICAgICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyMiwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2U7CiAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRpID0gZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGluc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuaW5zdGFuY2UsIGN1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5jdXJyZW50VGFyZ2V0LCBsaXN0ZW5lcjIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5saXN0ZW5lcjsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBpc1Bhc3NpdmVMaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgIGlmIChwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICBpc1Bhc3NpdmVMaXN0ZW5lciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1bnN1YnNjcmliZUxpc3RlbmVyOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdyYW5kQ29udGFpbmVyID09PSB0YXJnZXRDb250YWluZXIgfHwgZ3JhbmRDb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBncmFuZENvbnRhaW5lci5wYXJlbnROb2RlID09PSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBhbmNlc3Rvckluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgaWYgKChldmVudFN5c3RlbUZsYWdzICYgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUpID09PSAwICYmIChldmVudFN5c3RlbUZsYWdzICYgSVNfTk9OX0RFTEVHQVRFRCkgPT09IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lck5vZGUgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgIG1haW5Mb29wOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5vZGVUYWcgPSBub2RlLnRhZzsKICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0Um9vdCB8fCBub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGNvbnRhaW5lcjIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGdyYW5kTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kVGFnID0gZ3JhbmROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFRhZyA9PT0gSG9zdFJvb3QgfHwgZ3JhbmRUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kQ29udGFpbmVyID0gZ3JhbmROb2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBncmFuZE5vZGUgPSBncmFuZE5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRUYWcgPT09IEhvc3RDb21wb25lbnQgfHwgcGFyZW50VGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGFuY2VzdG9ySW5zdCA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBtYWluTG9vcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyMiA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgYW5jZXN0b3JJbnN0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lcjogbGlzdGVuZXIyLAogICAgICAgICAgICBjdXJyZW50VGFyZ2V0CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnRUeXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHksIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgIT09IG51bGwgPyByZWFjdE5hbWUgKyAiQ2FwdHVyZSIgOiBudWxsOwogICAgICAgICAgdmFyIHJlYWN0RXZlbnROYW1lID0gaW5DYXB0dXJlUGhhc2UgPyBjYXB0dXJlTmFtZSA6IHJlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgdmFyIGxhc3RIb3N0Q29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UyLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMi50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdEhvc3RDb21wb25lbnQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHJlYWN0RXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGxhc3RIb3N0Q29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhY2N1bXVsYXRlVGFyZ2V0T25seSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSArICJDYXB0dXJlIjsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTMuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UzLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVOYW1lKTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3ROYW1lKTsKICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnQoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGluc3QgPSBpbnN0LnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKGluc3QgJiYgaW5zdC50YWcgIT09IEhvc3RDb21wb25lbnQpOwogICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoaW5zdEEsIGluc3RCKSB7CiAgICAgICAgICB2YXIgbm9kZUEgPSBpbnN0QTsKICAgICAgICAgIHZhciBub2RlQiA9IGluc3RCOwogICAgICAgICAgdmFyIGRlcHRoQSA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQSA9IG5vZGVBOyB0ZW1wQTsgdGVtcEEgPSBnZXRQYXJlbnQodGVtcEEpKSB7CiAgICAgICAgICAgIGRlcHRoQSsrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoQiA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQiA9IG5vZGVCOyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgIGRlcHRoQisrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQSAtIGRlcHRoQiA+IDApIHsKICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBkZXB0aEEtLTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEIgLSBkZXB0aEEgPiAwKSB7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGggPSBkZXB0aEE7CiAgICAgICAgICB3aGlsZSAoZGVwdGgtLSkgewogICAgICAgICAgICBpZiAobm9kZUEgPT09IG5vZGVCIHx8IG5vZGVCICE9PSBudWxsICYmIG5vZGVBID09PSBub2RlQi5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZUE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBldmVudCwgdGFyZ2V0LCBjb21tb24sIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IGV2ZW50Ll9yZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXQ7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGluc3RhbmNlLCBhbHRlcm5hdGUgPSBfaW5zdGFuY2U0LmFsdGVybmF0ZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlNC5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTQudGFnOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmVFdmVudCwgZW50ZXJFdmVudCwgZnJvbTIsIHRvMikgewogICAgICAgICAgdmFyIGNvbW1vbiA9IGZyb20yICYmIHRvMiA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20yLCB0bzIpIDogbnVsbDsKICAgICAgICAgIGlmIChmcm9tMiAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20yLCBjb21tb24sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bzIgIT09IG51bGwgJiYgZW50ZXJFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGVudGVyRXZlbnQsIHRvMiwgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00yICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UgPSBmdW5jdGlvbihwcm9wTmFtZSwgc2VydmVyVmFsdWUsIGNsaWVudFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJWYWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVmFsdWUgPT09IG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyaWJ1dGVOYW1lcykgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgYXR0cmlidXRlTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yKCJFeHRyYSBhdHRyaWJ1dGVzIGZyb20gdGhlIHNlcnZlcjogJXMiLCBuYW1lcyk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ocmVnaXN0cmF0aW9uTmFtZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgbm9ybWFsaXplSFRNTCA9IGZ1bmN0aW9uKHBhcmVudCwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgcmV0dXJuIHRlc3RFbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBOT1JNQUxJWkVfTkVXTElORVNfUkVHRVggPSAvXHJcbj8vZzsKICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUobWFya3VwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWFya3VwU3RyaW5nID0gdHlwZW9mIG1hcmt1cCA9PT0gInN0cmluZyIgPyBtYXJrdXAgOiAiIiArIG1hcmt1cDsKICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChzZXJ2ZXJUZXh0LCBjbGllbnRUZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVGV4dCk7CiAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclRleHQgPT09IG5vcm1hbGl6ZWRDbGllbnRUZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgJiYgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRleHQgY29udGVudCBkb2VzIG5vdCBtYXRjaCBzZXJ2ZXItcmVuZGVyZWQgSFRNTC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3A0KCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChub2RlKSB7CiAgICAgICAgICBub2RlLm9uY2xpY2sgPSBub29wNDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50MzkodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50LCBwYXJlbnROYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHZhciBkb21FbGVtZW50OwogICAgICAgICAgdmFyIG5hbWVzcGFjZVVSSSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZVVSSSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIHR5cGUgIT09IHR5cGUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gInNjcmlwdCIpIHsKICAgICAgICAgICAgICB2YXIgZGl2ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gZGl2LnJlbW92ZUNoaWxkKGZpcnN0Q2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUsIHsKICAgICAgICAgICAgICAgIGlzOiBwcm9wcy5pcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAocHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLnNpemUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5zaXplID0gcHJvcHMuc2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUkksIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRvbUVsZW1lbnQpID09PSAiW29iamVjdCBIVE1MVW5rbm93bkVsZW1lbnRdIiAmJiAhaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRVbmtub3duVGFncywgdHlwZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgdGFnIDwlcz4gaXMgdW5yZWNvZ25pemVkIGluIHRoaXMgYnJvd3Nlci4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIFJlYWN0IGNvbXBvbmVudCwgc3RhcnQgaXRzIG5hbWUgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpOwogICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCBmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0UHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBsYXN0UmF3UHJvcHM7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbGFzdFByb3BzLm9uQ2xpY2sgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG5leHRQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgIHZhciBwcm9wS2V5OwogICAgICAgICAgdmFyIHN0eWxlTmFtZTsKICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgZm9yIChwcm9wS2V5IGluIGxhc3RQcm9wcykgewogICAgICAgICAgICBpZiAobmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8ICFsYXN0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbGFzdFByb3BzW3Byb3BLZXldID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RTdHlsZSkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RTdHlsZS5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIHZhciBsYXN0UHJvcCA9IGxhc3RQcm9wcyAhPSBudWxsID8gbGFzdFByb3BzW3Byb3BLZXldIDogdm9pZCAwOwogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBuZXh0UHJvcCA9PT0gbGFzdFByb3AgfHwgbmV4dFByb3AgPT0gbnVsbCAmJiBsYXN0UHJvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFByb3ApIHsKICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmICghbmV4dFByb3AgfHwgIW5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9IG5leHRQcm9wW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0gbmV4dFByb3A7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RIdG1sICE9PSBuZXh0SHRtbCkgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBsYXN0UHJvcCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0eWxlVXBkYXRlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFByb3BzW1NUWUxFXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcykgewogICAgICAgICAgaWYgKHRhZyA9PT0gImlucHV0IiAmJiBuZXh0UmF3UHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuZXh0UmF3UHJvcHMubmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RVcGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHByb3BOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICghcG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVyRWxlbWVudCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIGV4dHJhQXR0cmlidXRlTmFtZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBkb21FbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlc1tfaV0ubmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNoZWNrZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdGVkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmFkZChhdHRyaWJ1dGVzW19pXS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFyYXdQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IHJhd1Byb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSAiIiArIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgdHlwZW9mIGlzQ3VzdG9tQ29tcG9uZW50VGFnID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICB2YXIgc2VydmVyVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gPT09IHRydWUpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgfHwgLy8gQ29udHJvbGxlZCBhdHRyaWJ1dGVzIGFyZSBub3QgdmFsaWRhdGVkCiAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgcHJvcEtleSA9PT0gInZhbHVlIiB8fCBwcm9wS2V5ID09PSAiY2hlY2tlZCIgfHwgcHJvcEtleSA9PT0gInNlbGVjdGVkIikgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRIVE1MICE9PSBzZXJ2ZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlckhUTUwsIGV4cGVjdGVkSFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgIGlmIChjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFN0eWxlID0gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkU3R5bGUgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBleHBlY3RlZFN0eWxlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgJiYgIWVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkSWdub3JlQXR0cmlidXRlKHByb3BLZXksIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpICYmICFzaG91bGRSZW1vdmVBdHRyaWJ1dGUocHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBvd25OYW1lc3BhY2UgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodGFnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG51bGwgJiYgc3RhbmRhcmROYW1lICE9PSBwcm9wS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgIGlmICghZG9udFdhcm5DdXN0b21FbGVtZW50ICYmIG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSAmJiAhaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgLSBTaG91bGQgYmUgaW5mZXJyZWQgYXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuc2l6ZSA+IDAgJiYgcmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzKGV4dHJhQXR0cmlidXRlTmFtZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIHRydWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFRleHQodGV4dE5vZGUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBpc0RpZmZlcmVudCA9IHRleHROb2RlLm5vZGVWYWx1ZSAhPT0gdGV4dDsKICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIDwlcz4gaW4gPCVzPi4iLCBjaGlsZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIHRoZSB0ZXh0IG5vZGUgIiVzIiBpbiA8JXM+LicsIGNoaWxkLm5vZGVWYWx1ZSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyA8JXM+IGluIDwlcz4uIiwgdGFnLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0V4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyB0ZXh0IG5vZGUgZm9yICIlcyIgaW4gPCVzPi4nLCB0ZXh0LCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMoZG9tRWxlbWVudCwgdGFnLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHNwZWNpYWxUYWdzID0gWyJhZGRyZXNzIiwgImFwcGxldCIsICJhcmVhIiwgImFydGljbGUiLCAiYXNpZGUiLCAiYmFzZSIsICJiYXNlZm9udCIsICJiZ3NvdW5kIiwgImJsb2NrcXVvdGUiLCAiYm9keSIsICJiciIsICJidXR0b24iLCAiY2FwdGlvbiIsICJjZW50ZXIiLCAiY29sIiwgImNvbGdyb3VwIiwgImRkIiwgImRldGFpbHMiLCAiZGlyIiwgImRpdiIsICJkbCIsICJkdCIsICJlbWJlZCIsICJmaWVsZHNldCIsICJmaWdjYXB0aW9uIiwgImZpZ3VyZSIsICJmb290ZXIiLCAiZm9ybSIsICJmcmFtZSIsICJmcmFtZXNldCIsICJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiIsICJoZWFkIiwgImhlYWRlciIsICJoZ3JvdXAiLCAiaHIiLCAiaHRtbCIsICJpZnJhbWUiLCAiaW1nIiwgImlucHV0IiwgImlzaW5kZXgiLCAibGkiLCAibGluayIsICJsaXN0aW5nIiwgIm1haW4iLCAibWFycXVlZSIsICJtZW51IiwgIm1lbnVpdGVtIiwgIm1ldGEiLCAibmF2IiwgIm5vZW1iZWQiLCAibm9mcmFtZXMiLCAibm9zY3JpcHQiLCAib2JqZWN0IiwgIm9sIiwgInAiLCAicGFyYW0iLCAicGxhaW50ZXh0IiwgInByZSIsICJzY3JpcHQiLCAic2VjdGlvbiIsICJzZWxlY3QiLCAic291cmNlIiwgInN0eWxlIiwgInN1bW1hcnkiLCAidGFibGUiLCAidGJvZHkiLCAidGQiLCAidGVtcGxhdGUiLCAidGV4dGFyZWEiLCAidGZvb3QiLCAidGgiLCAidGhlYWQiLCAidGl0bGUiLCAidHIiLCAidHJhY2siLCAidWwiLCAid2JyIiwgInhtcCJdOwogICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAiYXBwbGV0IiwKICAgICAgICAgICAgImNhcHRpb24iLAogICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICJ0YWJsZSIsCiAgICAgICAgICAgICJ0ZCIsCiAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICJtYXJxdWVlIiwKICAgICAgICAgICAgIm9iamVjdCIsCiAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnQKICAgICAgICAgICAgLy8gVE9ETzogRGlzdGluZ3Vpc2ggYnkgbmFtZXNwYWNlIGhlcmUgLS0gZm9yIDx0aXRsZT4sIGluY2x1ZGluZyBpdCBoZXJlCiAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgImZvcmVpZ25PYmplY3QiLAogICAgICAgICAgICAiZGVzYyIsCiAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgIF07CiAgICAgICAgICB2YXIgYnV0dG9uU2NvcGVUYWdzID0gaW5TY29wZVRhZ3MuY29uY2F0KFsiYnV0dG9uIl0pOwogICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgdmFyIGVtcHR5QW5jZXN0b3JJbmZvID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICBhVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgYnV0dG9uVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIHBUYWdJbkJ1dHRvblNjb3BlOiBudWxsLAogICAgICAgICAgICBsaXN0SXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsLAogICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbihvbGRJbmZvLCB0YWcpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbjIoe30sIG9sZEluZm8gfHwgZW1wdHlBbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW5mbyA9IHsKICAgICAgICAgICAgICB0YWcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGluU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidXR0b25TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWxUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEgJiYgdGFnICE9PSAiYWRkcmVzcyIgJiYgdGFnICE9PSAiZGl2IiAmJiB0YWcgIT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFuY2VzdG9ySW5mby5jdXJyZW50ID0gaW5mbzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJhIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImJ1dHRvbiIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJsaSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm87CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGlzVGFnVmFsaWRXaXRoUGFyZW50ID0gZnVuY3Rpb24odGFnLCBwYXJlbnRUYWcpIHsKICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRUYWcpIHsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAib3B0Z3JvdXAiIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRoIiB8fCB0YWcgPT09ICJ0ZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRyIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNvbCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjYXB0aW9uIiB8fCB0YWcgPT09ICJjb2xncm91cCIgfHwgdGFnID09PSAidGJvZHkiIHx8IHRhZyA9PT0gInRmb290IiB8fCB0YWcgPT09ICJ0aGVhZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJhc2UiIHx8IHRhZyA9PT0gImJhc2Vmb250IiB8fCB0YWcgPT09ICJiZ3NvdW5kIiB8fCB0YWcgPT09ICJsaW5rIiB8fCB0YWcgPT09ICJtZXRhIiB8fCB0YWcgPT09ICJ0aXRsZSIgfHwgdGFnID09PSAibm9zY3JpcHQiIHx8IHRhZyA9PT0gIm5vZnJhbWVzIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaGVhZCIgfHwgdGFnID09PSAiYm9keSIgfHwgdGFnID09PSAiZnJhbWVzZXQiOwogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJmcmFtZSI7CiAgICAgICAgICAgICAgY2FzZSAiI2RvY3VtZW50IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJodG1sIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyAhPT0gImgxIiAmJiBwYXJlbnRUYWcgIT09ICJoMiIgJiYgcGFyZW50VGFnICE9PSAiaDMiICYmIHBhcmVudFRhZyAhPT0gImg0IiAmJiBwYXJlbnRUYWcgIT09ICJoNSIgJiYgcGFyZW50VGFnICE9PSAiaDYiOwogICAgICAgICAgICAgIGNhc2UgInJwIjoKICAgICAgICAgICAgICBjYXNlICJydCI6CiAgICAgICAgICAgICAgICByZXR1cm4gaW1wbGllZEVuZFRhZ3MuaW5kZXhPZihwYXJlbnRUYWcpID09PSAtMTsKICAgICAgICAgICAgICBjYXNlICJib2R5IjoKICAgICAgICAgICAgICBjYXNlICJjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJjb2wiOgogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWUiOgogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0ZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgIGNhc2UgInRoIjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyA9PSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnID0gZnVuY3Rpb24odGFnLCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJhZGRyZXNzIjoKICAgICAgICAgICAgICBjYXNlICJhcnRpY2xlIjoKICAgICAgICAgICAgICBjYXNlICJhc2lkZSI6CiAgICAgICAgICAgICAgY2FzZSAiYmxvY2txdW90ZSI6CiAgICAgICAgICAgICAgY2FzZSAiY2VudGVyIjoKICAgICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGNhc2UgImRpciI6CiAgICAgICAgICAgICAgY2FzZSAiZGl2IjoKICAgICAgICAgICAgICBjYXNlICJkbCI6CiAgICAgICAgICAgICAgY2FzZSAiZmllbGRzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZpZ2NhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImZpZ3VyZSI6CiAgICAgICAgICAgICAgY2FzZSAiZm9vdGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkZXIiOgogICAgICAgICAgICAgIGNhc2UgImhncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAibWFpbiI6CiAgICAgICAgICAgICAgY2FzZSAibWVudSI6CiAgICAgICAgICAgICAgY2FzZSAibmF2IjoKICAgICAgICAgICAgICBjYXNlICJvbCI6CiAgICAgICAgICAgICAgY2FzZSAicCI6CiAgICAgICAgICAgICAgY2FzZSAic2VjdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAic3VtbWFyeSI6CiAgICAgICAgICAgICAgY2FzZSAidWwiOgogICAgICAgICAgICAgIGNhc2UgInByZSI6CiAgICAgICAgICAgICAgY2FzZSAibGlzdGluZyI6CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgIGNhc2UgImhyIjoKICAgICAgICAgICAgICBjYXNlICJ4bXAiOgogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJmb3JtIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZm9ybVRhZyB8fCBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibGkiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImRkIjoKICAgICAgICAgICAgICBjYXNlICJkdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiYSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgIm5vYnIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGlkV2FybiQxID0ge307CiAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbihjaGlsZFRhZywgY2hpbGRUZXh0LCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgYW5jZXN0b3JJbmZvID0gYW5jZXN0b3JJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvOwogICAgICAgICAgICB2YXIgcGFyZW50SW5mbyA9IGFuY2VzdG9ySW5mby5jdXJyZW50OwogICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50SW5mbyAmJiBwYXJlbnRJbmZvLnRhZzsKICAgICAgICAgICAgaWYgKGNoaWxkVGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGFnICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3Rpbmc6IHdoZW4gY2hpbGRUZXh0IGlzIHBhc3NlZCwgY2hpbGRUYWcgc2hvdWxkIGJlIG51bGwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGRUYWcgPSAiI3RleHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50ID0gaXNUYWdWYWxpZFdpdGhQYXJlbnQoY2hpbGRUYWcsIHBhcmVudFRhZykgPyBudWxsIDogcGFyZW50SW5mbzsKICAgICAgICAgICAgdmFyIGludmFsaWRBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgPyBudWxsIDogZmluZEludmFsaWRBbmNlc3RvckZvclRhZyhjaGlsZFRhZywgYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnRPckFuY2VzdG9yID0gaW52YWxpZFBhcmVudCB8fCBpbnZhbGlkQW5jZXN0b3I7CiAgICAgICAgICAgIGlmICghaW52YWxpZFBhcmVudE9yQW5jZXN0b3IpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9yVGFnID0gaW52YWxpZFBhcmVudE9yQW5jZXN0b3IudGFnOwogICAgICAgICAgICB2YXIgd2FybktleSA9ICEhaW52YWxpZFBhcmVudCArICJ8IiArIGNoaWxkVGFnICsgInwiICsgYW5jZXN0b3JUYWc7CiAgICAgICAgICAgIGlmIChkaWRXYXJuJDFbd2FybktleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybiQxW3dhcm5LZXldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRhZ0Rpc3BsYXlOYW1lID0gY2hpbGRUYWc7CiAgICAgICAgICAgIHZhciB3aGl0ZXNwYWNlSW5mbyA9ICIiOwogICAgICAgICAgICBpZiAoY2hpbGRUYWcgPT09ICIjdGV4dCIpIHsKICAgICAgICAgICAgICBpZiAoL1xTLy50ZXN0KGNoaWxkVGV4dCkpIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIlRleHQgbm9kZXMiOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJXaGl0ZXNwYWNlIHRleHQgbm9kZXMiOwogICAgICAgICAgICAgICAgd2hpdGVzcGFjZUluZm8gPSAiIE1ha2Ugc3VyZSB5b3UgZG9uJ3QgaGF2ZSBhbnkgZXh0cmEgd2hpdGVzcGFjZSBiZXR3ZWVuIHRhZ3Mgb24gZWFjaCBsaW5lIG9mIHlvdXIgc291cmNlIGNvZGUuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiPCIgKyBjaGlsZFRhZyArICI+IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW52YWxpZFBhcmVudCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yVGFnID09PSAidGFibGUiICYmIGNoaWxkVGFnID09PSAidHIiKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGRlc2NlbmRhbnQgb2YgPCVzPi4iLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMSA9ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciOwogICAgICAgIHZhciBTVVNQRU5TRV9TVEFSVF9EQVRBID0gIiQiOwogICAgICAgIHZhciBTVVNQRU5TRV9FTkRfREFUQSA9ICIvJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSA9ICIkPyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgPSAiJCEiOwogICAgICAgIHZhciBTVFlMRSQxID0gInN0eWxlIjsKICAgICAgICB2YXIgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgdmFyIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRleHQocm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2U7CiAgICAgICAgICB2YXIgbm9kZVR5cGUgPSByb290Q29udGFpbmVySW5zdGFuY2Uubm9kZVR5cGU7CiAgICAgICAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfTk9ERToKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFOiB7CiAgICAgICAgICAgICAgdHlwZSA9IG5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gIiNkb2N1bWVudCIgOiAiI2ZyYWdtZW50IjsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSByb290Q29udGFpbmVySW5zdGFuY2UuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHJvb3QzID8gcm9vdDMubmFtZXNwYWNlVVJJIDogZ2V0Q2hpbGROYW1lc3BhY2UobnVsbCwgIiIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyByb290Q29udGFpbmVySW5zdGFuY2UucGFyZW50Tm9kZSA6IHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gY29udGFpbmVyMi5uYW1lc3BhY2VVUkkgfHwgbnVsbDsKICAgICAgICAgICAgICB0eXBlID0gY29udGFpbmVyMi50YWdOYW1lOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKG93bk5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkYXRlZFRhZyA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8obnVsbCwgdmFsaWRhdGVkVGFnKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENoaWxkSG9zdENvbnRleHQocGFyZW50SG9zdENvbnRleHQsIHR5cGUsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50SG9zdENvbnRleHREZXYgPSBwYXJlbnRIb3N0Q29udGV4dDsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKHBhcmVudEhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKHBhcmVudEhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBpc0VuYWJsZWQoKTsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKTsKICAgICAgICAgIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBzZXRFbmFibGVkKGZhbHNlKTsKICAgICAgICAgIHJldHVybiBhY3RpdmVJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICByZXN0b3JlU2VsZWN0aW9uKHNlbGVjdGlvbkluZm9ybWF0aW9uKTsKICAgICAgICAgIHNldEVuYWJsZWQoZXZlbnRzRW5hYmxlZCk7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2UodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHZhciBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcodHlwZSwgbnVsbCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnROYW1lc3BhY2UgPSBob3N0Q29udGV4dERldi5uYW1lc3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzOSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXM0ID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXM0KHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHBhcmVudENvbnRleHQsIGNoaWxkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0IHx8IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgdHlwZSwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYW4gaW5zdGFuY2UgYnkgdGhpcyBwb2ludC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkQ2hhbmdlKSB7CiAgICAgICAgICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdHlwZSwgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuY29udGV4dDsKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgIHZhciBDb25jdXJyZW50Um9vdCA9IDE7CiAgICAgICAgdmFyIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgIHZhciBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3luY1F1ZXVlID0gW2NhbGxiYWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IHRydWU7CiAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICBpZiAoIWlzRmx1c2hpbmdTeW5jUXVldWUgJiYgc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSB0cnVlOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gc3luY1F1ZXVlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IHN5bmNRdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgdmFyIGZvcmtTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUZvcmtQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgIHZhciBpZFN0YWNrID0gW107CiAgICAgICAgdmFyIGlkU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlQ29udGV4dElkID0gMTsKICAgICAgICB2YXIgdHJlZUNvbnRleHRPdmVyZmxvdyA9ICIiOwogICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9ya2VkKSAhPT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ya3NBdExldmVsKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJlZUlkKCkgewogICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBpZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBpZCA9IGlkV2l0aExlYWRpbmdCaXQgJiB+Z2V0TGVhZGluZ0JpdChpZFdpdGhMZWFkaW5nQml0KTsKICAgICAgICAgIHJldHVybiBpZC50b1N0cmluZygzMikgKyBvdmVyZmxvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya0NvdW50OwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gdG90YWxDaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4sIGluZGV4MikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIGJhc2VJZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBiYXNlT3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgIHZhciBiYXNlSWQgPSBiYXNlSWRXaXRoTGVhZGluZ0JpdCAmIH4oMSA8PCBiYXNlTGVuZ3RoKTsKICAgICAgICAgIHZhciBzbG90ID0gaW5kZXgyICsgMTsKICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDMwKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZk92ZXJmbG93Qml0cyA9IGJhc2VMZW5ndGggLSBiYXNlTGVuZ3RoICUgNTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvdyA9IChiYXNlSWQgJiBuZXdPdmVyZmxvd0JpdHMpLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VJZCA9IGJhc2VJZCA+PiBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZMZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdE9mTmV3Qml0cyA9IHNsb3QgPDwgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIGlkID0gcmVzdE9mTmV3Qml0cyB8IHJlc3RPZkJhc2VJZDsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IHJlc3RPZkxlbmd0aCB8IGlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIF9pZCA9IG5ld0JpdHMgfCBiYXNlSWQ7CiAgICAgICAgICAgIHZhciBfb3ZlcmZsb3cgPSBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IF9vdmVyZmxvdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IDE7CiAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJpdExlbmd0aChudW1iZXI0KSB7CiAgICAgICAgICByZXR1cm4gMzIgLSBjbHozMihudW1iZXI0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQ0KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQ0LmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50NC5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDQucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ0LnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50NC5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50NCwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50NC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gRnJhZ21lbnQ5KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgZnJhZ21lbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgICAgX2NyZWF0ZWQzLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gb2xkRmliZXIgIT09IG51bGwgPyBvbGRGaWJlci5rZXkgOiBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoZWRGaWJlciA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5KGNoaWxkLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaGlsZC5rZXk7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZEtleShpbml0KHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjIua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyMi5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczIgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiR2VuZXJhdG9yIikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZW5lcmF0b3JzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbkl0ZXJhYmxlLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgICAgaWYgKF9uZXdDaGlsZHJlbikgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICAgICAgZm9yICg7ICFfc3RlcC5kb25lOyBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBpdGVyYWJsZSBvYmplY3QgcHJvdmlkZWQgbm8gaXRlcmF0b3IuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlcC5kb25lKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIzLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczMgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQ5KSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjaGlsZCwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY2hpbGQudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2V4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGNoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2V4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChlbGVtZW50LnByb3BzLmNoaWxkcmVuLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkNCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkNDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgcG9ydGFsLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gcG9ydGFsLmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gSG9zdFBvcnRhbCAmJiBjaGlsZC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA9PT0gcG9ydGFsLmNvbnRhaW5lckluZm8gJiYgY2hpbGQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uID09PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50ID0gdHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCAmJiBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFICYmIG5ld0NoaWxkLmtleSA9PT0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCAiIiArIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczI7CiAgICAgICAgfQogICAgICAgIHZhciByZWNvbmNpbGVDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcih0cnVlKTsKICAgICAgICB2YXIgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcihmYWxzZSk7CiAgICAgICAgZnVuY3Rpb24gY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50NC5jaGlsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlc3VtaW5nIHdvcmsgbm90IHlldCBpbXBsZW1lbnRlZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50Q2hpbGQgPSBjdXJyZW50Q2hpbGQuc2libGluZzsKICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgdmFyIGNoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3MoY2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVDdXJzb3IgPSBjcmVhdGVDdXJzb3IobnVsbCk7CiAgICAgICAgdmFyIHJlbmRlcmVyU2lnaWw7CiAgICAgICAgewogICAgICAgICAgcmVuZGVyZXJTaWdpbCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgIHZhciBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgIHZhciBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgIHZhciBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCkgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUHJvdmlkZXIocHJvdmlkZXJGaWJlciwgY29udGV4dCwgbmV4dFZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2godmFsdWVDdXJzb3IsIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHZvaWQgMCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IG51bGwgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSByZW5kZXJlclNpZ2lsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRGV0ZWN0ZWQgbXVsdGlwbGUgcmVuZGVyZXJzIGNvbmN1cnJlbnRseSByZW5kZXJpbmcgdGhlIHNhbWUgY29udGV4dCBwcm92aWRlci4gVGhpcyBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IHJlbmRlcmVyU2lnaWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUHJvdmlkZXIoY29udGV4dCwgcHJvdmlkZXJGaWJlcikgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHZhbHVlQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3AodmFsdWVDdXJzb3IsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50LCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgdmFyIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmICFpc1N1YnNldE9mTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vZGUgIT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcm9wYWdhdGlvbiByb290IHdoZW4gc2NoZWR1bGluZyBjb250ZXh0IHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV4dEZpYmVyID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgbGlzdCA9IGZpYmVyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKGxpc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeSA9IGxpc3QuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIHdoaWxlIChkZXBlbmRlbmN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jeS5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGxpc3QubGFuZXMgPSBtZXJnZUxhbmVzKGxpc3QubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kubmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDb250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIudHlwZSA/IG51bGwgOiBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRTdXNwZW5zZSA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UganVzdCBjYW1lIGZyb20gYSBwYXJlbnQgc28gd2UgbXVzdCBoYXZlIGhhZCBhIHBhcmVudC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UubGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudFN1c3BlbnNlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfYWx0ZXJuYXRlID0gcGFyZW50U3VzcGVuc2UuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChfYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhfYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudFN1c3BlbnNlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHdoaWxlIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0RmliZXIgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gbmV4dEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBuZXh0RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RDb250ZXh0ID0gZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICBpZiAoZmlyc3RDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShkZXBlbmRlbmNpZXMubGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkQ29udGV4dChjb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICBpZiAobGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID09PSBjb250ZXh0KSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvbnRleHRJdGVtID0gewogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgbWVtb2l6ZWRWYWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAobGFzdENvbnRleHREZXBlbmRlbmN5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlci5kZXBlbmRlbmNpZXMgPSB7CiAgICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY29udGV4dEl0ZW0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGxhc3RDb250ZXh0RGVwZW5kZW5jeS5uZXh0ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBbcXVldWVdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcy5wdXNoKHF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoUXVldWVpbmdDb25jdXJyZW50VXBkYXRlcygpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uY3VycmVudFF1ZXVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGNvbmN1cnJlbnRRdWV1ZXNbaV07CiAgICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBmaXJzdEludGVybGVhdmVkVXBkYXRlID0gbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKGxhc3RQZW5kaW5nVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbGFzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIHZhciB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QgPSBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdDsKICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChzb3VyY2VGaWJlciwgbGFuZSkgewogICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCAmJiAoc291cmNlRmliZXIuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBzb3VyY2VGaWJlcjsKICAgICAgICAgIHZhciBwYXJlbnQgPSBzb3VyY2VGaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnQuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIGFsdGVybmF0ZSA9IHBhcmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgocGFyZW50LmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gcGFyZW50OwogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBVcGRhdGVTdGF0ZSA9IDA7CiAgICAgICAgdmFyIFJlcGxhY2VTdGF0ZSA9IDE7CiAgICAgICAgdmFyIEZvcmNlVXBkYXRlID0gMjsKICAgICAgICB2YXIgQ2FwdHVyZVVwZGF0ZSA9IDM7CiAgICAgICAgdmFyIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGU7CiAgICAgICAgdmFyIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplVXBkYXRlUXVldWUoZmliZXIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgYmFzZVN0YXRlOiBmaWJlci5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBzaGFyZWQ6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVmZmVjdHM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGNsb25lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBldmVudFRpbWUsCiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIHRhZzogVXBkYXRlU3RhdGUsCiAgICAgICAgICAgIHBheWxvYWQ6IG51bGwsCiAgICAgICAgICAgIGNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9PT0gc2hhcmVkUXVldWUgJiYgIWRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIChzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCBvciBmb3JjZVVwZGF0ZSkgd2FzIHNjaGVkdWxlZCBmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsIHdpdGggemVybyBzaWRlLWVmZmVjdHMuIENvbnNpZGVyIHVzaW5nIGNvbXBvbmVudERpZFVwZGF0ZSBvciBhIGNhbGxiYWNrLiIpOwogICAgICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNVbnNhZmVDbGFzc1JlbmRlclBoYXNlVXBkYXRlKCkpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICByZXR1cm4gdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBzaGFyZWRRdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gc2hhcmVkUXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjYXB0dXJlZFVwZGF0ZSkgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0ZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3TGFzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGUuZXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZS5sYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWUgPSB7CiAgICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG5ld0ZpcnN0LAogICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG5ld0xhc3QsCiAgICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIHByZXZTdGF0ZSwgbmV4dFByb3BzLCBpbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoICh1cGRhdGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgUmVwbGFjZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYXB0dXJlVXBkYXRlOiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVXBkYXRlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgX3BheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgX3BheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhc3NpZ24yKHt9LCBwcmV2U3RhdGUsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGb3JjZVVwZGF0ZTogewogICAgICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBwcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gcXVldWUuc2hhcmVkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5zaGFyZWQucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICBpZiAobGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSA9IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlICE9PSBsYXN0QmFzZVVwZGF0ZSkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudExhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gcXVldWUuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdMYXN0QmFzZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIHZhciB1cGRhdGVFdmVudFRpbWUgPSB1cGRhdGUuZXZlbnRUaW1lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzMiwgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZUxhbmUsCiAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlLm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgdXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlIGlzIGdvaW5nIHRvIGJlIGNvbW1pdHRlZCBzbyB3ZSBuZXZlciB3YW50IHVuY29tbWl0CiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIFVzaW5nIE5vTGFuZSB3b3JrcyBiZWNhdXNlIDAgaXMgYSBzdWJzZXQgb2YgYWxsIGJpdG1hc2tzLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICBsYW5lOiBOb0xhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdMYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlLm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIG5ld1N0YXRlLCBwcm9wcywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdXBkYXRlLmNhbGxiYWNrOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsICYmIC8vIElmIHRoZSB1cGRhdGUgd2FzIGFscmVhZHkgY29tbWl0dGVkLCB3ZSBzaG91bGQgbm90IHF1ZXVlIGl0cwogICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgYWdhaW4uCiAgICAgICAgICAgICAgICB1cGRhdGUubGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdHMgPSBxdWV1ZS5lZmZlY3RzOwogICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0cyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlLmVmZmVjdHMgPSBbdXBkYXRlXTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2godXBkYXRlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICBpZiAodXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgX2xhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpcnN0UGVuZGluZ1VwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IF9maXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5zaGFyZWQucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUuYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBuZXdGaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWQgPSBxdWV1ZS5zaGFyZWQuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCBpbnRlcmxlYXZlZC5sYW5lKTsKICAgICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaXJzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZS5zaGFyZWQubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobmV3TGFuZXMpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBuZXdMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBhcmd1bWVudCBwYXNzZWQgYXMgY2FsbGJhY2suIEV4cGVjdGVkIGEgZnVuY3Rpb24uIEluc3RlYWQgIiArICgicmVjZWl2ZWQ6ICIgKyBjYWxsYmFjaykpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2suY2FsbChjb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKSB7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgewogICAgICAgICAgcmV0dXJuIGhhc0ZvcmNlVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIGZpbmlzaGVkUXVldWUsIGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgZWZmZWN0cyA9IGZpbmlzaGVkUXVldWUuZWZmZWN0czsKICAgICAgICAgIGZpbmlzaGVkUXVldWUuZWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBpZiAoZWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZWZmZWN0c1tpXTsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBlZmZlY3QuY2FsbGJhY2s7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlZmZlY3QuY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgICAgY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOT19DT05URVhUID0ge307CiAgICAgICAgdmFyIGNvbnRleHRTdGFja0N1cnNvciQxID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciBjb250ZXh0RmliZXJTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgcm9vdEluc3RhbmNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgZnVuY3Rpb24gcmVxdWlyZWRDb250ZXh0KGMpIHsKICAgICAgICAgIGlmIChjID09PSBOT19DT05URVhUKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgaG9zdCBjb250ZXh0IHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGFpbmVyKCkgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHJldHVybiByb290SW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGFpbmVyKGZpYmVyLCBuZXh0Um9vdEluc3RhbmNlKSB7CiAgICAgICAgICBwdXNoKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBuZXh0Um9vdEluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgTk9fQ09OVEVYVCwgZmliZXIpOwogICAgICAgICAgdmFyIG5leHRSb290Q29udGV4dCA9IGdldFJvb3RIb3N0Q29udGV4dChuZXh0Um9vdEluc3RhbmNlKTsKICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dFJvb3RDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEhvc3RDb250YWluZXIoZmliZXIpIHsKICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICBwb3Aocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdENvbnRleHQoKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IkMS5jdXJyZW50KTsKICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IkMS5jdXJyZW50KTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGdldENoaWxkSG9zdENvbnRleHQoY29udGV4dCwgZmliZXIudHlwZSk7CiAgICAgICAgICBpZiAoY29udGV4dCA9PT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBpZiAoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IuY3VycmVudCAhPT0gZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIERlZmF1bHRTdXNwZW5zZUNvbnRleHQgPSAwOwogICAgICAgIHZhciBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayA9IDE7CiAgICAgICAgdmFyIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCA9IDE7CiAgICAgICAgdmFyIEZvcmNlU3VzcGVuc2VGYWxsYmFjayA9IDI7CiAgICAgICAgdmFyIHN1c3BlbnNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoRGVmYXVsdFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgZnVuY3Rpb24gaGFzU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIGZsYWcpIHsKICAgICAgICAgIHJldHVybiAocGFyZW50Q29udGV4dCAmIGZsYWcpICE9PSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCAmIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHNoYWxsb3dDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCAmIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrIHwgc2hhbGxvd0NvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFN1YnRyZWVTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc3VidHJlZUNvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0IHwgc3VidHJlZUNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hTdXNwZW5zZUNvbnRleHQoZmliZXIsIG5ld0NvbnRleHQpIHsKICAgICAgICAgIHB1c2goc3VzcGVuc2VTdGFja0N1cnNvciwgbmV3Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BTdXNwZW5zZUNvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHBvcChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENhcHR1cmVTdXNwZW5zZSh3b3JrSW5Qcm9ncmVzczIsIGhhc0ludmlzaWJsZVBhcmVudCkgewogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpIHsKICAgICAgICAgIHZhciBub2RlID0gcm93OwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkID09PSBudWxsIHx8IGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoZGVoeWRyYXRlZCkgfHwgaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soZGVoeWRyYXRlZCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQgJiYgLy8gcmV2ZWFsT3JkZXIgdW5kZWZpbmVkIGNhbid0IGJlIHRydXN0ZWQgYmVjYXVzZSBpdCBkb24ndAogICAgICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHdoZXRoZXIgaXQgc3VzcGVuZGVkIG9yIG5vdC4KICAgICAgICAgICAgbm9kZS5tZW1vaXplZFByb3BzLnJldmVhbE9yZGVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9IChub2RlLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSByb3cpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSByb3cpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgSGFzRWZmZWN0ID0gKAogICAgICAgICAgLyogKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnNlcnRpb24gPSAoCiAgICAgICAgICAvKiAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXQgPSAoCiAgICAgICAgICAvKiAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMgPSBbXTsKICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZSA9IHdvcmtJblByb2dyZXNzU291cmNlc1tpXTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG11dGFibGVTb3VyY2UuX3dvcmtJblByb2dyZXNzVmVyc2lvblByaW1hcnkgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNdXRhYmxlU291cmNlRm9ySHlkcmF0aW9uKHJvb3QzLCBtdXRhYmxlU291cmNlKSB7CiAgICAgICAgICB2YXIgZ2V0VmVyc2lvbiA9IG11dGFibGVTb3VyY2UuX2dldFZlcnNpb247CiAgICAgICAgICB2YXIgdmVyc2lvbjIgPSBnZXRWZXJzaW9uKG11dGFibGVTb3VyY2UuX3NvdXJjZSk7CiAgICAgICAgICBpZiAocm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBbbXV0YWJsZVNvdXJjZSwgdmVyc2lvbjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YS5wdXNoKG11dGFibGVTb3VyY2UsIHZlcnNpb24yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgdmFyIGdsb2JhbENsaWVudElkQ291bnRlciA9IDA7CiAgICAgICAgdmFyIFJFX1JFTkRFUl9MSU1JVCA9IDI1OwogICAgICAgIHZhciBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgdmFyIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgdmFyIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgdmFyIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gW2hvb2tOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYucHVzaChob29rTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2Kys7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0Rldltob29rVHlwZXNVcGRhdGVJbmRleERldl0gIT09IGhvb2tOYW1lKSB7CiAgICAgICAgICAgICAgICB3YXJuT25Ib29rTWlzbWF0Y2hJbkRldihob29rTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRlcHMgIT09IHZvaWQgMCAmJiBkZXBzICE9PSBudWxsICYmICFpc0FycmF5MihkZXBzKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IHRoYXQgaXMgbm90IGFuIGFycmF5IChpbnN0ZWFkLCByZWNlaXZlZCBgJXNgKS4gV2hlbiBzcGVjaWZpZWQsIHRoZSBmaW5hbCBhcmd1bWVudCBtdXN0IGJlIGFuIGFycmF5LiIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCB0eXBlb2YgZGVwcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSG9va01pc21hdGNoSW5EZXYoY3VycmVudEhvb2tOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxKTsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFibGUgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBzZWNvbmRDb2x1bW5TdGFydCA9IDMwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXY7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgb2xkSG9va05hbWUgPSBob29rVHlwZXNEZXZbaV07CiAgICAgICAgICAgICAgICAgIHZhciBuZXdIb29rTmFtZSA9IGkgPT09IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID8gY3VycmVudEhvb2tOYW1lIDogb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHZhciByb3cgPSBpICsgMSArICIuICIgKyBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBzZWNvbmRDb2x1bW5TdGFydCkgewogICAgICAgICAgICAgICAgICAgIHJvdyArPSAiICI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm93ICs9IG5ld0hvb2tOYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgdGFibGUgKz0gcm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGhhcyBkZXRlY3RlZCBhIGNoYW5nZSBpbiB0aGUgb3JkZXIgb2YgSG9va3MgY2FsbGVkIGJ5ICVzLiBUaGlzIHdpbGwgbGVhZCB0byBidWdzIGFuZCBlcnJvcnMgaWYgbm90IGZpeGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcmVhZCB0aGUgUnVsZXMgb2YgSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rc1xuXG4gICBQcmV2aW91cyByZW5kZXIgICAgICAgICAgICBOZXh0IHJlbmRlclxuICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4lcyAgIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXlxuIiwgY29tcG9uZW50TmFtZSwgdGFibGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0ludmFsaWRIb29rRXJyb3IoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJldkRlcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IGR1cmluZyB0aGlzIHJlbmRlciwgYnV0IG5vdCBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4gRXZlbiB0aG91Z2ggdGhlIGZpbmFsIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBpdHMgdHlwZSBjYW5ub3QgY2hhbmdlIGJldHdlZW4gcmVuZGVycy4iLCBjdXJyZW50SG9va05hbWVJbkRldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmV4dERlcHMubGVuZ3RoICE9PSBwcmV2RGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGZpbmFsIGFyZ3VtZW50IHBhc3NlZCB0byAlcyBjaGFuZ2VkIHNpemUgYmV0d2VlbiByZW5kZXJzLiBUaGUgb3JkZXIgYW5kIHNpemUgb2YgdGhpcyBhcnJheSBtdXN0IHJlbWFpbiBjb25zdGFudC5cblxuUHJldmlvdXM6ICVzXG5JbmNvbWluZzogJXMiLCBjdXJyZW50SG9va05hbWVJbkRldiwgIlsiICsgcHJldkRlcHMuam9pbigiLCAiKSArICJdIiwgIlsiICsgbmV4dERlcHMuam9pbigiLCAiKSArICJdIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJldkRlcHMubGVuZ3RoICYmIGkgPCBuZXh0RGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAob2JqZWN0SXMobmV4dERlcHNbaV0sIHByZXZEZXBzW2ldKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgc2Vjb25kQXJnLCBuZXh0UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHJlbmRlckxhbmVzID0gbmV4dFJlbmRlckxhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5fZGVidWdIb29rVHlwZXMgOiBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcykgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZSZVJlbmRlcnMgPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICAgIGlmIChudW1iZXJPZlJlUmVuZGVycyA+PSBSRV9SRU5ERVJfTElNSVQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG9vIG1hbnkgcmUtcmVuZGVycy4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgcmVuZGVycyB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlck9mUmVSZW5kZXJzICs9IDE7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgICAgfSB3aGlsZSAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gaG9va1R5cGVzRGV2OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFJlbmRlclRvb0Zld0hvb2tzID0gY3VycmVudEhvb2sgIT09IG51bGwgJiYgY3VycmVudEhvb2submV4dCAhPT0gbnVsbDsKICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgKGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzaykgIT09ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTdGF0aWNNYXNrKSAmJiAvLyBEaXNhYmxlIHRoaXMgd2FybmluZyBpbiBsZWdhY3kgbW9kZSwgYmVjYXVzZSBsZWdhY3kgU3VzcGVuc2UgaXMgd2VpcmQKICAgICAgICAgICAgLy8gYW5kIGNyZWF0ZXMgZmFsc2UgcG9zaXRpdmVzLiBUbyBtYWtlIHRoaXMgd29yayBpbiBsZWdhY3kgbW9kZSwgd2UnZAogICAgICAgICAgICAvLyBuZWVkIHRvIG1hcmsgZmliZXJzIHRoYXQgY29tbWl0IGluIGFuIGluY29tcGxldGUgc3RhdGUsIHNvbWVob3cuIEZvcgogICAgICAgICAgICAvLyBub3cgSSdsbCBkaXNhYmxlIHRoZSB3YXJuaW5nIHRoYXQgbW9zdCBvZiB0aGUgYnVncyB0aGF0IHdvdWxkIHRyaWdnZXIKICAgICAgICAgICAgLy8gaXQgYXJlIGVpdGhlciBleGNsdXNpdmUgdG8gY29uY3VycmVudCBtb2RlIG9yIGV4aXN0IGluIGJvdGguCiAgICAgICAgICAgIChjdXJyZW50NC5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgUmVhY3QgZXJyb3I6IEV4cGVjdGVkIHN0YXRpYyBmbGFnIHdhcyBtaXNzaW5nLiBQbGVhc2Ugbm90aWZ5IHRoZSBSZWFjdCB0ZWFtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBpZiAoZGlkUmVuZGVyVG9vRmV3SG9va3MpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBmZXdlciBob29rcyB0aGFuIGV4cGVjdGVkLiBUaGlzIG1heSBiZSBjYXVzZWQgYnkgYW4gYWNjaWRlbnRhbCBlYXJseSByZXR1cm4gc3RhdGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RpZFJlbmRlcklkSG9vaygpIHsKICAgICAgICAgIHZhciBkaWRSZW5kZXJJZEhvb2sgPSBsb2NhbElkQ291bnRlciAhPT0gMDsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgIHJldHVybiBkaWRSZW5kZXJJZEhvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oTW91bnRQYXNzaXZlRGV2IHwgTW91bnRMYXlvdXREZXYgfCBQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudDQubGFuZXMgPSByZW1vdmVMYW5lcyhjdXJyZW50NC5sYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhvb2tzQWZ0ZXJUaHJvdygpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBob29rID0gaG9vay5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHsKICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlUXVldWU6IG51bGwsCiAgICAgICAgICAgIHF1ZXVlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBob29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBob29rOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50SG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV4dFdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG5leHRDdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgbW9yZSBob29rcyB0aGFuIGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICB2YXIgbmV3SG9vayA9IHsKICAgICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudEhvb2suYmFzZVN0YXRlLAogICAgICAgICAgICAgIGJhc2VRdWV1ZTogY3VycmVudEhvb2suYmFzZVF1ZXVlLAogICAgICAgICAgICAgIHF1ZXVlOiBjdXJyZW50SG9vay5xdWV1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXdIb29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gbmV3SG9vazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxhc3RFZmZlY3Q6IG51bGwsCiAgICAgICAgICAgIHN0b3JlczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNTdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgPyBhY3Rpb24oc3RhdGUpIDogYWN0aW9uOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgaWYgKGluaXQgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXQoaW5pdGlhbEFyZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXRpYWxBcmc7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiByZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlMTMKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoUmVkdWNlckFjdGlvbi5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIGJhc2VRdWV1ZSA9IGN1cnJlbnQ0LmJhc2VRdWV1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGJhc2VGaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIHZhciBwZW5kaW5nRmlyc3QgPSBwZW5kaW5nUXVldWUubmV4dDsKICAgICAgICAgICAgICBiYXNlUXVldWUubmV4dCA9IHBlbmRpbmdGaXJzdDsKICAgICAgICAgICAgICBwZW5kaW5nUXVldWUubmV4dCA9IGJhc2VGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmJhc2VRdWV1ZSAhPT0gYmFzZVF1ZXVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgZXJyb3I6IEV4cGVjdGVkIHdvcmstaW4tcHJvZ3Jlc3MgcXVldWUgdG8gYmUgYSBjbG9uZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDQuYmFzZVF1ZXVlID0gYmFzZVF1ZXVlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGN1cnJlbnQ0LmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVGaXJzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVMYXN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lcywgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVGaXJzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXModXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZS5oYXNFYWdlclN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gdXBkYXRlLmVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsICYmIHVwZGF0ZSAhPT0gZmlyc3QpOwogICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IG5ld0Jhc2VRdWV1ZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlUXVldWUgPSBuZXdCYXNlUXVldWVMYXN0OwogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWRMYW5lID0gaW50ZXJsZWF2ZWQubGFuZTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgfSBlbHNlIGlmIChiYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgdmFyIGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobGFzdFJlbmRlclBoYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IGxhc3RSZW5kZXJQaGFzZVVwZGF0ZS5uZXh0OwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlKTsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbbmV3U3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpc0h5ZHJhdGluZzIgPSBnZXRJc0h5ZHJhdGluZygpOwogICAgICAgICAgaWYgKGlzSHlkcmF0aW5nMikgewogICAgICAgICAgICBpZiAoZ2V0U2VydmVyU25hcHNob3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBnZXRTZXJ2ZXJTbmFwc2hvdCwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIHNlcnZlci1yZW5kZXJlZCBjb250ZW50LiBXaWxsIHJldmVydCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNlcnZlclNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFNuYXBzaG90ICE9PSBnZXRTZXJ2ZXJTbmFwc2hvdCgpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNlcnZlclNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaW5zdCA9IHsKICAgICAgICAgICAgdmFsdWU6IG5leHRTbmFwc2hvdCwKICAgICAgICAgICAgZ2V0U25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gaW5zdDsKICAgICAgICAgIG1vdW50RWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZTbmFwc2hvdCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzbmFwc2hvdENoYW5nZWQgPSAhb2JqZWN0SXMocHJldlNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgaWYgKHNuYXBzaG90Q2hhbmdlZCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGhvb2sucXVldWU7CiAgICAgICAgICB1cGRhdGVFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBpZiAoaW5zdC5nZXRTbmFwc2hvdCAhPT0gZ2V0U25hcHNob3QgfHwgc25hcHNob3RDaGFuZ2VkIHx8IC8vIENoZWNrIGlmIHRoZSBzdXNiY3JpYmUgZnVuY3Rpb24gY2hhbmdlZC4gV2UgY2FuIHNhdmUgc29tZSBtZW1vcnkgYnkKICAgICAgICAgIC8vIGNoZWNraW5nIHdoZXRoZXIgd2Ugc2NoZWR1bGVkIGEgc3Vic2NyaXB0aW9uIGVmZmVjdCBhYm92ZS4KICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzc0hvb2subWVtb2l6ZWRTdGF0ZS50YWcgJiBIYXNFZmZlY3QpIHsKICAgICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIHJlbmRlcmVkU25hcHNob3QpIHsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFN0b3JlQ29uc2lzdGVuY3k7CiAgICAgICAgICB2YXIgY2hlY2sgPSB7CiAgICAgICAgICAgIGdldFNuYXBzaG90LAogICAgICAgICAgICB2YWx1ZTogcmVuZGVyZWRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzdG9yZXMgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgIGlmIChzdG9yZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3Jlcy5wdXNoKGNoZWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdG9yZUluc3RhbmNlKGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSB7CiAgICAgICAgICBpbnN0LnZhbHVlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3Vic2NyaWJlVG9TdG9yZShmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB2YXIgaGFuZGxlU3RvcmVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShoYW5kbGVTdG9yZUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgewogICAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBpbnN0LnZhbHVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMocHJldlZhbHVlLCBuZXh0VmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpIHsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlMTMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0aWFsU3RhdGUxMygpOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogYmFzaWNTdGF0ZVJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUxMwogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hTZXRTdGF0ZS5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoRWZmZWN0KHRhZywgY3JlYXRlLCBkZXN0cm95LCBkZXBzKSB7CiAgICAgICAgICB2YXIgZWZmZWN0ID0gewogICAgICAgICAgICB0YWcsCiAgICAgICAgICAgIGNyZWF0ZSwKICAgICAgICAgICAgZGVzdHJveSwKICAgICAgICAgICAgZGVwcywKICAgICAgICAgICAgLy8gQ2lyY3VsYXIKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICBpZiAobGFzdEVmZmVjdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgbGFzdEVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICAgIGVmZmVjdC5uZXh0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVmZmVjdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfcmVmMiA9IHsKICAgICAgICAgICAgICBjdXJyZW50OiBpbml0aWFsVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gX3JlZjI7CiAgICAgICAgICAgIHJldHVybiBfcmVmMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHJldHVybiBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IGhvb2tGbGFncywgY3JlYXRlLCB2b2lkIDAsIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0SW1wbChmaWJlckZsYWdzLCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIGRlc3Ryb3kgPSB2b2lkIDA7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZFZmZlY3QgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBkZXN0cm95ID0gcHJldkVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2RWZmZWN0LmRlcHM7CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KGhvb2tGbGFncywgY3JlYXRlLCBkZXN0cm95LCBuZXh0RGVwcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IGhvb2tGbGFncywgY3JlYXRlLCBkZXN0cm95LCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKE1vdW50UGFzc2l2ZURldiB8IFBhc3NpdmUgfCBQYXNzaXZlU3RhdGljLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKFBhc3NpdmUgfCBQYXNzaXZlU3RhdGljLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFBhc3NpdmUsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QoY3JlYXRlLCByZWYpIHsKICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciByZWZDYWxsYmFjayA9IHJlZjsKICAgICAgICAgICAgdmFyIF9pbnN0ID0gY3JlYXRlKCk7CiAgICAgICAgICAgIHJlZkNhbGxiYWNrKF9pbnN0KTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZkNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChyZWYgIT09IG51bGwgJiYgcmVmICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHJlZjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghcmVmT2JqZWN0Lmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgZmlyc3QgYXJndW1lbnQgdG8gZWl0aGVyIGJlIGEgcmVmIGNhbGxiYWNrIG9yIFJlYWN0LmNyZWF0ZVJlZigpIG9iamVjdC4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgImFuIG9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhyZWZPYmplY3QpLmpvaW4oIiwgIikgKyAifSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3QyID0gY3JlYXRlKCk7CiAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gX2luc3QyOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgIH0KICAgICAgICB2YXIgdXBkYXRlRGVidWdWYWx1ZSA9IG1vdW50RGVidWdWYWx1ZTsKICAgICAgICBmdW5jdGlvbiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtjYWxsYmFjaywgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtjYWxsYmFjaywgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRDdXJyZW50SG9vayA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IHJlc29sdmVkQ3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlZhbHVlID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgc2hvdWxkRGVmZXJWYWx1ZSA9ICFpbmNsdWRlc09ubHlOb25VcmdlbnRMYW5lcyhyZW5kZXJMYW5lcyk7CiAgICAgICAgICBpZiAoc2hvdWxkRGVmZXJWYWx1ZSkgewogICAgICAgICAgICBpZiAoIW9iamVjdElzKHZhbHVlLCBwcmV2VmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFyIGRlZmVycmVkTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmV2VmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaG9vay5iYXNlU3RhdGUpIHsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNldFBlbmRpbmcsIGNhbGxiYWNrLCBvcHRpb25zMikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShoaWdoZXJFdmVudFByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHksIENvbnRpbnVvdXNFdmVudFByaW9yaXR5KSk7CiAgICAgICAgICBzZXRQZW5kaW5nKHRydWUpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uID0ge307CiAgICAgICAgICB2YXIgY3VycmVudFRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRQZW5kaW5nKGZhbHNlKTsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJldlRyYW5zaXRpb24gPT09IG51bGwgJiYgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVkRmliZXJzQ291bnQgPSBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5zaXplOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJEZXRlY3RlZCBhIGxhcmdlIG51bWJlciBvZiB1cGRhdGVzIGluc2lkZSBzdGFydFRyYW5zaXRpb24uIElmIHRoaXMgaXMgZHVlIHRvIGEgc3Vic2NyaXB0aW9uIHBsZWFzZSByZS13cml0ZSBpdCB0byB1c2UgUmVhY3QgcHJvdmlkZWQgaG9va3MuIE90aGVyd2lzZSBjb25jdXJyZW50IG1vZGUgZ3VhcmFudGVlcyBhcmUgb2ZmIHRoZSB0YWJsZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50VHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfbW91bnRTdGF0ZSA9IG1vdW50U3RhdGUoZmFsc2UpLCBpc1BlbmRpbmcgPSBfbW91bnRTdGF0ZVswXSwgc2V0UGVuZGluZyA9IF9tb3VudFN0YXRlWzFdOwogICAgICAgICAgdmFyIHN0YXJ0ID0gc3RhcnRUcmFuc2l0aW9uLmJpbmQobnVsbCwgc2V0UGVuZGluZyk7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBzdGFydDsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3VwZGF0ZVN0YXRlID0gdXBkYXRlU3RhdGUoKSwgaXNQZW5kaW5nID0gX3VwZGF0ZVN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfcmVyZW5kZXJTdGF0ZSA9IHJlcmVuZGVyU3RhdGUoKSwgaXNQZW5kaW5nID0gX3JlcmVuZGVyU3RhdGVbMF07CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHN0YXJ0ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgdmFyIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudElkKCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9IHJvb3QzLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICB2YXIgaWQ7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICB2YXIgdHJlZUlkID0gZ2V0VHJlZUlkKCk7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJSIiArIHRyZWVJZDsKICAgICAgICAgICAgdmFyIGxvY2FsSWQgPSBsb2NhbElkQ291bnRlcisrOwogICAgICAgICAgICBpZiAobG9jYWxJZCA+IDApIHsKICAgICAgICAgICAgICBpZCArPSAiSCIgKyBsb2NhbElkLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZCArPSAiOiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWQgPSBnbG9iYWxDbGllbnRJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWQgPSAiOiIgKyBpZGVudGlmaWVyUHJlZml4ICsgInIiICsgZ2xvYmFsQ2xpZW50SWQudG9TdHJpbmcoMzIpICsgIjoiOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaWQ7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUlkKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpZCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uKGZpYmVyLCBxdWV1ZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlN0YXRlIHVwZGF0ZXMgZnJvbSB0aGUgdXNlU3RhdGUoKSBhbmQgdXNlUmVkdWNlcigpIEhvb2tzIGRvbid0IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiB0aGUgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICBhY3Rpb24sCiAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IGZhbHNlLAogICAgICAgICAgICBlYWdlclN0YXRlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpKSB7CiAgICAgICAgICAgIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFNldFN0YXRlKGZpYmVyLCBxdWV1ZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlN0YXRlIHVwZGF0ZXMgZnJvbSB0aGUgdXNlU3RhdGUoKSBhbmQgdXNlUmVkdWNlcigpIEhvb2tzIGRvbid0IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiB0aGUgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICBhY3Rpb24sCiAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IGZhbHNlLAogICAgICAgICAgICBlYWdlclN0YXRlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpKSB7CiAgICAgICAgICAgIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChmaWJlci5sYW5lcyA9PT0gTm9MYW5lcyAmJiAoYWx0ZXJuYXRlID09PSBudWxsIHx8IGFsdGVybmF0ZS5sYW5lcyA9PT0gTm9MYW5lcykpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFJlbmRlcmVkUmVkdWNlciA9IHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXI7CiAgICAgICAgICAgICAgaWYgKGxhc3RSZW5kZXJlZFJlZHVjZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGVhZ2VyU3RhdGUgPSBsYXN0UmVuZGVyZWRSZWR1Y2VyKGN1cnJlbnRTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmhhc0VhZ2VyU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICB1cGRhdGUuZWFnZXJTdGF0ZSA9IGVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICAgIGlmIChvYmplY3RJcyhlYWdlclN0YXRlLCBjdXJyZW50U3RhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIHJldHVybiBmaWJlciA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlID09PSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSkgewogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB2YXIgcGVuZGluZyA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKSB7CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uTGFuZShsYW5lKSkgewogICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHF1ZXVlLmxhbmVzOwogICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgdmFyIG5ld1F1ZXVlTGFuZXMgPSBtZXJnZUxhbmVzKHF1ZXVlTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgQ29udGV4dE9ubHlEaXNwYXRjaGVyID0gewogICAgICAgICAgcmVhZENvbnRleHQsCiAgICAgICAgICB1c2VDYWxsYmFjazogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlQ29udGV4dDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTWVtbzogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlUmVkdWNlcjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlUmVmOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VTdGF0ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRGVidWdWYWx1ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlVHJhbnNpdGlvbjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUlkOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICB9OwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIHZhciB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuSW52YWxpZEhvb2tBY2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXJyb3IoIkRvIG5vdCBjYWxsIEhvb2tzIGluc2lkZSB1c2VFZmZlY3QoLi4uKSwgdXNlTWVtbyguLi4pLCBvciBvdGhlciBidWlsdC1pbiBIb29rcy4gWW91IGNhbiBvbmx5IGNhbGwgSG9va3MgYXQgdGhlIHRvcCBsZXZlbCBvZiB5b3VyIFJlYWN0IGZ1bmN0aW9uLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rcyIpOwogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCBiYXNlUHJvcHMpIHsKICAgICAgICAgIGlmIChDb21wb25lbnQgJiYgQ29tcG9uZW50LmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgcHJvcHMgPSBhc3NpZ24yKHt9LCBiYXNlUHJvcHMpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gQ29tcG9uZW50LmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFzZVByb3BzOwogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUludGVybmFsSW5zdGFuY2UgPSB7fTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIHdhcm5PbkludmFsaWRDYWxsYmFjazsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHZhciBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSBudWxsIHx8IHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5ID0gY2FsbGVyTmFtZSArICJfIiArIGNhbGxiYWNrOwogICAgICAgICAgICBpZiAoIWRpZFdhcm5PbkludmFsaWRDYWxsYmFjay5oYXMoa2V5KSkgewogICAgICAgICAgICAgIGRpZFdhcm5PbkludmFsaWRDYWxsYmFjay5hZGQoa2V5KTsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsZXJOYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGUgPSBmdW5jdGlvbih0eXBlLCBwYXJ0aWFsU3RhdGUpIHsKICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpOiBBIHZhbGlkIHN0YXRlIG9iamVjdCAob3IgbnVsbCkgbXVzdCBiZSByZXR1cm5lZC4gWW91IGhhdmUgcmV0dXJuZWQgdW5kZWZpbmVkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmYWtlSW50ZXJuYWxJbnN0YW5jZSwgIl9wcm9jZXNzQ2hpbGRDb250ZXh0IiwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX3Byb2Nlc3NDaGlsZENvbnRleHQgaXMgbm90IGF2YWlsYWJsZSBpbiBSZWFjdCAxNisuIFRoaXMgbGlrZWx5IG1lYW5zIHlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBhbmQgYXJlIGF0dGVtcHRpbmcgdG8gbmVzdCBhIFJlYWN0IDE1IHRyZWUgaW5zaWRlIGEgUmVhY3QgMTYgdHJlZSB1c2luZyB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciwgd2hpY2ggaXNuJ3Qgc3VwcG9ydGVkLiBUcnkgdG8gbWFrZSBzdXJlIHlvdSBoYXZlIG9ubHkgb25lIGNvcHkgb2YgUmVhY3QgKGFuZCBpZGVhbGx5LCBzd2l0Y2ggdG8gUmVhY3RET00uY3JlYXRlUG9ydGFsKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGZha2VJbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5leHRQcm9wcykgewogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGUoY3RvciwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtZW1vaXplZFN0YXRlID0gcGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwID8gcHJldlN0YXRlIDogYXNzaWduMih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gcGF5bG9hZDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBSZXBsYWNlU3RhdGU7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gcGF5bG9hZDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKGluc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsMihvbGRQcm9wcywgbmV3UHJvcHMpIHx8ICFzaGFsbG93RXF1YWwyKG9sZFN0YXRlLCBuZXdTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICB2YXIgcmVuZGVyUHJlc2VudCA9IGluc3RhbmNlLnJlbmRlcjsKICAgICAgICAgICAgaWYgKCFyZW5kZXJQcmVzZW50KSB7CiAgICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIHR5cGVvZiBjdG9yLnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogZGlkIHlvdSBhY2NpZGVudGFsbHkgcmV0dXJuIGFuIG9iamVjdCBmcm9tIHRoZSBjb25zdHJ1Y3Rvcj8iLCBuYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiB5b3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIGRlZmluZSBgcmVuZGVyYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldEluaXRpYWxTdGF0ZSAmJiAhaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlLmlzUmVhY3RDbGFzc0FwcHJvdmVkICYmICFpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJnZXRJbml0aWFsU3RhdGUgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgY2xhc3NlcyBjcmVhdGVkIHVzaW5nIFJlYWN0LmNyZWF0ZUNsYXNzLiBEaWQgeW91IG1lYW4gdG8gZGVmaW5lIGEgc3RhdGUgcHJvcGVydHkgaW5zdGVhZD8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzICYmICFpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBkZWZhdWx0UHJvcHMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgZXJyb3IoInByb3BUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBwcm9wVHlwZXMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGUpIHsKICAgICAgICAgICAgICBlcnJvcigiY29udGV4dFR5cGUgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGUgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5oYXMoY3RvcikgJiYgLy8gU3RyaWN0IE1vZGUgaGFzIGl0cyBvd24gd2FybmluZyBmb3IgbGVnYWN5IGNvbnRleHQsIHNvIHdlIGNhbiBza2lwCiAgICAgICAgICAgICAgLy8gdGhpcyBvbmUuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyB1c2VzIHRoZSBsZWdhY3kgY2hpbGRDb250ZXh0VHlwZXMgQVBJIHdoaWNoIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBVc2UgUmVhY3QuY3JlYXRlQ29udGV4dCgpIGluc3RlYWRcblxuLkxlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9sZWdhY3ktY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3Rvci5jb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5oYXMoY3RvcikgJiYgLy8gU3RyaWN0IE1vZGUgaGFzIGl0cyBvd24gd2FybmluZyBmb3IgbGVnYWN5IGNvbnRleHQsIHNvIHdlIGNhbiBza2lwCiAgICAgICAgICAgICAgLy8gdGhpcyBvbmUuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyB1c2VzIHRoZSBsZWdhY3kgY29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSB3aXRoIHN0YXRpYyBjb250ZXh0VHlwZSBpbnN0ZWFkLlxuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBjb250ZXh0VHlwZXMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGUgJiYgY3Rvci5jb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlY2xhcmVzIGJvdGggY29udGV4dFR5cGVzIGFuZCBjb250ZXh0VHlwZSBzdGF0aWMgcHJvcGVydGllcy4gVGhlIGxlZ2FjeSBjb250ZXh0VHlwZXMgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFNob3VsZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudFNob3VsZFVwZGF0ZSgpLiBEaWQgeW91IG1lYW4gc2hvdWxkQ29tcG9uZW50VXBkYXRlKCk/IFRoZSBuYW1lIGlzIHBocmFzZWQgYXMgYSBxdWVzdGlvbiBiZWNhdXNlIHRoZSBmdW5jdGlvbiBpcyBleHBlY3RlZCB0byByZXR1cm4gYSB2YWx1ZS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgY3Rvci5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgJiYgdHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBzaG91bGRDb21wb25lbnRVcGRhdGUoKS4gc2hvdWxkQ29tcG9uZW50VXBkYXRlIHNob3VsZCBub3QgYmUgdXNlZCB3aGVuIGV4dGVuZGluZyBSZWFjdC5QdXJlQ29tcG9uZW50LiBQbGVhc2UgZXh0ZW5kIFJlYWN0LkNvbXBvbmVudCBpZiBzaG91bGRDb21wb25lbnRVcGRhdGUgaXMgdXNlZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkEgcHVyZSBjb21wb25lbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnREaWRVbm1vdW50KCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuIERpZCB5b3UgbWVhbiBjb21wb25lbnRXaWxsVW5tb3VudCgpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzKCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuIElmIHlvdSBtZWFudCB0byB1cGRhdGUgdGhlIHN0YXRlIGluIHJlc3BvbnNlIHRvIGNoYW5naW5nIHByb3BzLCB1c2UgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpLiBJZiB5b3UgbWVhbnQgdG8gZmV0Y2ggZGF0YSBvciBydW4gc2lkZS1lZmZlY3RzIG9yIG11dGF0aW9ucyBhZnRlciBSZWFjdCBoYXMgdXBkYXRlZCB0aGUgVUksIHVzZSBjb21wb25lbnREaWRVcGRhdGUoKS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzKCkuIERpZCB5b3UgbWVhbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzKCkuIERpZCB5b3UgbWVhbiBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNNdXRhdGVkUHJvcHMgPSBpbnN0YW5jZS5wcm9wcyAhPT0gbmV3UHJvcHM7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gdm9pZCAwICYmIGhhc011dGF0ZWRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBXaGVuIGNhbGxpbmcgc3VwZXIoKSBpbiBgJXNgLCBtYWtlIHN1cmUgdG8gcGFzcyB1cCB0aGUgc2FtZSBwcm9wcyB0aGF0IHlvdXIgY29tcG9uZW50J3MgY29uc3RydWN0b3Igd2FzIHBhc3NlZC4iLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlNldHRpbmcgZGVmYXVsdFByb3BzIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVmaW5lIGRlZmF1bHRQcm9wcyBhcyBhIHN0YXRpYyBwcm9wZXJ0eSBvbiAlcy4iLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgIWRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZS5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBzaG91bGQgYmUgdXNlZCB3aXRoIGNvbXBvbmVudERpZFVwZGF0ZSgpLiBUaGlzIGNvbXBvbmVudCBkZWZpbmVzIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgb25seS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSBpcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGEgc3RhdGljIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIGlzIGRlZmluZWQgYXMgYSBzdGF0aWMgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfc3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgICAgaWYgKF9zdGF0ZSAmJiAodHlwZW9mIF9zdGF0ZSAhPT0gIm9iamVjdCIgfHwgaXNBcnJheTIoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0MyhpbnN0YW5jZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaW5zdGFuY2UuX3JlYWN0SW50ZXJuYWxJbnN0YW5jZSA9IGZha2VJbnRlcm5hbEluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGZhbHNlOwogICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIHZhciBjb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCJjb250ZXh0VHlwZSIgaW4gY3RvcikgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gKAogICAgICAgICAgICAgICAgLy8gQWxsb3cgbnVsbCBmb3IgY29uZGl0aW9uYWwgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgIGNvbnRleHRUeXBlID09PSBudWxsIHx8IGNvbnRleHRUeXBlICE9PSB2b2lkIDAgJiYgY29udGV4dFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSAmJiBjb250ZXh0VHlwZS5fY29udGV4dCA9PT0gdm9pZCAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQgJiYgIWRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZS5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSAiIjsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0VHlwZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gdW5kZWZpbmVkLiBUaGlzIGNhbiBiZSBjYXVzZWQgYnkgYSB0eXBvIG9yIGJ5IG1peGluZyB1cCBuYW1lZCBhbmQgZGVmYXVsdCBpbXBvcnRzLiBUaGlzIGNhbiBhbHNvIGhhcHBlbiBkdWUgdG8gYSBjaXJjdWxhciBkZXBlbmRlbmN5LCBzbyB0cnkgbW92aW5nIHRoZSBjcmVhdGVDb250ZXh0KCkgY2FsbCB0byBhIHNlcGFyYXRlIGZpbGUuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHRUeXBlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIGEgIiArIHR5cGVvZiBjb250ZXh0VHlwZSArICIuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuUHJvdmlkZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIHRoZSBDb250ZXh0LkNvbnN1bWVyIGluc3RlYWQ/IjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNvbnRleHRUeXBlKS5qb2luKCIsICIpICsgIn0uIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWZpbmVzIGFuIGludmFsaWQgY29udGV4dFR5cGUuIGNvbnRleHRUeXBlIHNob3VsZCBwb2ludCB0byB0aGUgQ29udGV4dCBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlQ29udGV4dCgpLiVzIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBjb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIHZhciBjb250ZXh0VHlwZXMgPSBjdG9yLmNvbnRleHRUeXBlczsKICAgICAgICAgICAgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBjb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICAgIGNvbnRleHQgPSBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA/IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpIDogZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlICE9PSBudWxsICYmIGluc3RhbmNlLnN0YXRlICE9PSB2b2lkIDAgPyBpbnN0YW5jZS5zdGF0ZSA6IG51bGw7CiAgICAgICAgICBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgc3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiYCVzYCB1c2VzIGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGJ1dCBpdHMgaW5pdGlhbCBzdGF0ZSBpcyAlcy4gVGhpcyBpcyBub3QgcmVjb21tZW5kZWQuIEluc3RlYWQsIGRlZmluZSB0aGUgaW5pdGlhbCBzdGF0ZSBieSBhc3NpZ25pbmcgYW4gb2JqZWN0IHRvIGB0aGlzLnN0YXRlYCBpbiB0aGUgY29uc3RydWN0b3Igb2YgYCVzYC4gVGhpcyBlbnN1cmVzIHRoYXQgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYXJndW1lbnRzIGhhdmUgYSBjb25zaXN0ZW50IHNoYXBlLiIsIGNvbXBvbmVudE5hbWUsIGluc3RhbmNlLnN0YXRlID09PSBudWxsID8gIm51bGwiIDogInVuZGVmaW5lZCIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxNb3VudE5hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsVXBkYXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50Ll9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbE1vdW50TmFtZSA9ICJjb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbE1vdW50TmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSAiY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsIHx8IGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsVXBkYXRlTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgdmFyIG5ld0FwaU5hbWUgPSB0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgPyAiZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkiIDogImdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmhhcyhfY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZS5hZGQoX2NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBlcnJvcigiVW5zYWZlIGxlZ2FjeSBsaWZlY3ljbGVzIHdpbGwgbm90IGJlIGNhbGxlZCBmb3IgY29tcG9uZW50cyB1c2luZyBuZXcgY29tcG9uZW50IEFQSXMuXG5cbiVzIHVzZXMgJXMgYnV0IGFsc28gY29udGFpbnMgdGhlIGZvbGxvd2luZyBsZWdhY3kgbGlmZWN5Y2xlczolcyVzJXNcblxuVGhlIGFib3ZlIGxpZmVjeWNsZXMgc2hvdWxkIGJlIHJlbW92ZWQuIExlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6XG5odHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIiwgX2NvbXBvbmVudE5hbWUsIG5ld0FwaU5hbWUsIGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbE1vdW50TmFtZSA6ICIiLCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA6ICIiLCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsVXBkYXRlTmFtZSA6ICIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0xlZ2FjeUNvbnRleHRDb25zdW1lcikgewogICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9sZFN0YXRlICE9PSBpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmNvbXBvbmVudFdpbGxNb3VudCgpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsYXNzQ29tcG9uZW50VXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKGluc3RhbmNlLCBpbnN0YW5jZS5zdGF0ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBvbGRTdGF0ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsYXNzQ29tcG9uZW50VXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKGluc3RhbmNlLCBpbnN0YW5jZS5zdGF0ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaW5zdGFuY2UucmVmcyA9IHt9OwogICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgPT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFzc2lnbiBwcm9wcyBkaXJlY3RseSB0byBzdGF0ZSBiZWNhdXNlIHVwZGF0ZXMgdG8gcHJvcHMgd29uJ3QgYmUgcmVmbGVjdGVkIGluIHN0YXRlLiBJbiBtb3N0IGNhc2VzLCBpdCBpcyBiZXR0ZXIgdG8gdXNlIHByb3BzIGRpcmVjdGx5LiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IG9sZENvbnRleHQgIT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKTsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaW5zdGFuY2Uuc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAob2xkUHJvcHMgPT09IG5ld1Byb3BzICYmIG9sZFN0YXRlID09PSBuZXdTdGF0ZSAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSAmJiAhY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IF9maWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlckZsYWdzMiA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IF9maWJlckZsYWdzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV4dENvbnRleHQ7CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHVucmVzb2x2ZWRPbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA/IHVucmVzb2x2ZWRPbGRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKHdvcmtJblByb2dyZXNzMi50eXBlLCB1bnJlc29sdmVkT2xkUHJvcHMpOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgIHZhciB1bnJlc29sdmVkTmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dFVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IHVucmVzb2x2ZWROZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGluc3RhbmNlLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyA9PT0gdW5yZXNvbHZlZE5ld1Byb3BzICYmIG9sZFN0YXRlID09PSBuZXdTdGF0ZSAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSAmJiAhY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpICYmICFlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgfHwgY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHx8IC8vIFRPRE86IEluIHNvbWUgY2FzZXMsIHdlJ2xsIGVuZCB1cCBjaGVja2luZyBpZiBjb250ZXh0IGhhcyBjaGFuZ2VkIHR3aWNlLAogICAgICAgICAgLy8gYm90aCBiZWZvcmUgYW5kIGFmdGVyIGBzaG91bGRDb21wb25lbnRVcGRhdGVgIGhhcyBiZWVuIGNhbGxlZC4gTm90IGlkZWFsLAogICAgICAgICAgLy8gYnV0IEknbSBsb2F0aCB0byByZWZhY3RvciB0aGlzIGZ1bmN0aW9uLiBUaGlzIG9ubHkgaGFwcGVucyBmb3IgbWVtb2l6ZWQKICAgICAgICAgIC8vIGNvbXBvbmVudHMgc28gaXQncyBub3QgdGhhdCBjb21tb24uCiAgICAgICAgICBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV4dENvbnRleHQ7CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgc291cmNlLAogICAgICAgICAgICBzdGFjazogZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHNvdXJjZSksCiAgICAgICAgICAgIGRpZ2VzdDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZSh2YWx1ZSwgZGlnZXN0LCBzdGFjaykgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZTogbnVsbCwKICAgICAgICAgICAgc3RhY2s6IHN0YWNrICE9IG51bGwgPyBzdGFjayA6IG51bGwsCiAgICAgICAgICAgIGRpZ2VzdDogZGlnZXN0ICE9IG51bGwgPyBkaWdlc3QgOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG93RXJyb3JEaWFsb2coYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvZ0NhcHR1cmVkRXJyb3IoYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGxvZ0Vycm9yID0gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pOwogICAgICAgICAgICBpZiAobG9nRXJyb3IgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGVycm9ySW5mby5zb3VyY2U7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHN0YWNrICE9PSBudWxsID8gc3RhY2sgOiAiIjsKICAgICAgICAgICAgICBpZiAoZXJyb3IyICE9IG51bGwgJiYgZXJyb3IyLl9zdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgICAgICAgIGlmIChib3VuZGFyeS50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBzb3VyY2UgPyBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHNvdXJjZSkgOiBudWxsOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lTWVzc2FnZSA9IGNvbXBvbmVudE5hbWUgPyAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIHRoZSA8IiArIGNvbXBvbmVudE5hbWUgKyAiPiBjb21wb25lbnQ6IiA6ICJUaGUgYWJvdmUgZXJyb3Igb2NjdXJyZWQgaW4gb25lIG9mIHlvdXIgUmVhY3QgY29tcG9uZW50czoiOwogICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TWVzc2FnZTsKICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiQ29uc2lkZXIgYWRkaW5nIGFuIGVycm9yIGJvdW5kYXJ5IHRvIHlvdXIgdHJlZSB0byBjdXN0b21pemUgZXJyb3IgaGFuZGxpbmcgYmVoYXZpb3IuXG5WaXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZXJyb3ItYm91bmRhcmllcyB0byBsZWFybiBtb3JlIGFib3V0IGVycm9yIGJvdW5kYXJpZXMuIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGVycm9yQm91bmRhcnlOYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihib3VuZGFyeSkgfHwgIkFub255bW91cyI7CiAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJSZWFjdCB3aWxsIHRyeSB0byByZWNyZWF0ZSB0aGlzIGNvbXBvbmVudCB0cmVlIGZyb20gc2NyYXRjaCAiICsgKCJ1c2luZyB0aGUgZXJyb3IgYm91bmRhcnkgeW91IHByb3ZpZGVkLCAiICsgZXJyb3JCb3VuZGFyeU5hbWUgKyAiLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY29tYmluZWRNZXNzYWdlID0gY29tcG9uZW50TmFtZU1lc3NhZ2UgKyAiXG4iICsgY29tcG9uZW50U3RhY2sgKyAiXG5cbiIgKyAoIiIgKyBlcnJvckJvdW5kYXJ5TWVzc2FnZSk7CiAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShjb21iaW5lZE1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwJDEgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdEVycm9yVXBkYXRlKGZpYmVyLCBlcnJvckluZm8sIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnRhZyA9IENhcHR1cmVVcGRhdGU7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBlcnJvcjIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgb25VbmNhdWdodEVycm9yKGVycm9yMik7CiAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9IGZpYmVyLnR5cGUuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yOwogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvciQxKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3QgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoaW5zdCAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdC5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbiBjYWxsYmFjaygpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQodGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvciQxMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvckluZm8uc3RhY2s7CiAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnREaWRDYXRjaChlcnJvciQxMiwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IHN0YWNrICE9PSBudWxsID8gc3RhY2sgOiAiIgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShmaWJlci5sYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBFcnJvciBib3VuZGFyaWVzIHNob3VsZCBpbXBsZW1lbnQgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKCkuIEluIHRoYXQgbWV0aG9kLCByZXR1cm4gYSBzdGF0ZSB1cGRhdGUgdG8gZGlzcGxheSBhbiBlcnJvciBtZXNzYWdlIG9yIGZhbGxiYWNrIFVJLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIHZhciB0aHJlYWRJRHM7CiAgICAgICAgICBpZiAocGluZ0NhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAkMSgpOwogICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBwaW5nQ2FjaGUuc2V0KHdha2VhYmxlLCB0aHJlYWRJRHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyZWFkSURzID0gcGluZ0NhY2hlLmdldCh3YWtlYWJsZSk7CiAgICAgICAgICAgIGlmICh0aHJlYWRJRHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocmVhZElEcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aHJlYWRJRHMuaGFzKGxhbmVzKSkgewogICAgICAgICAgICB0aHJlYWRJRHMuYWRkKGxhbmVzKTsKICAgICAgICAgICAgdmFyIHBpbmcgPSBwaW5nU3VzcGVuZGVkUm9vdC5iaW5kKG51bGwsIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocGluZywgcGluZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFJldHJ5TGlzdGVuZXIoc3VzcGVuc2VCb3VuZGFyeSwgcm9vdDMsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHN1c3BlbnNlQm91bmRhcnkudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkudXBkYXRlUXVldWUgPSB1cGRhdGVRdWV1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdha2VhYmxlcy5hZGQod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlciwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICB2YXIgdGFnID0gc291cmNlRmliZXIudGFnOwogICAgICAgICAgaWYgKChzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgKHRhZyA9PT0gRnVuY3Rpb25Db21wb25lbnQgfHwgdGFnID09PSBGb3J3YXJkUmVmMiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWwyOwogICAgICAgICAgICBpZiAoY29tcGFyZShwcmV2UHJvcHMsIG5leHRQcm9wcykgJiYgY3VycmVudDQucmVmID09PSB3b3JrSW5Qcm9ncmVzczIucmVmKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIG5leHRQcm9wcyk7CiAgICAgICAgICBuZXdDaGlsZC5yZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBvdXRlck1lbW9UeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIGlmIChvdXRlck1lbW9UeXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gb3V0ZXJNZW1vVHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBpbml0KHBheWxvYWQpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBvdXRlck1lbW9UeXBlICYmIG91dGVyTWVtb1R5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCAoU2ltcGxlTWVtb0NvbXBvbmVudCBoYXMgbm8gZGVmYXVsdFByb3BzKQogICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3V0ZXJNZW1vVHlwZSkKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKHNoYWxsb3dFcXVhbDIocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQ0LnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50NC50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmMjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlKTsKICAgICAgICAgICAgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAhZGlkUmVjZWl2ZVVwZGF0ZSkgewogICAgICAgICAgICBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHNob3VsZEVycm9yKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICBjYXNlIGZhbHNlOiB7CiAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgdGVtcEluc3RhbmNlID0gbmV3IGN0b3Iod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMsIF9pbnN0YW5jZS5jb250ZXh0KTsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHRlbXBJbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgICAgICAgIF9pbnN0YW5jZS51cGRhdGVyLmVucXVldWVTZXRTdGF0ZShfaW5zdGFuY2UsIHN0YXRlLCBudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIHRydWU6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IG5ldyBFcnJvcigiU2ltdWxhdGVkIGVycm9yIGNvbWluZyBmcm9tIERldlRvb2xzIik7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKGVycm9yJDEsIHdvcmtJblByb2dyZXNzMiksIGxhbmUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgdXBkYXRlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlOwogICAgICAgICAgaWYgKGluc3RhbmNlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFVuaXRPZldvcmsgPSBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIGluc3QucHJvcHMgIT09IG5leHRQcm9wcykgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgZXJyb3IoIkl0IGxvb2tzIGxpa2UgJXMgaXMgcmVhc3NpZ25pbmcgaXRzIG93biBgdGhpcy5wcm9wc2Agd2hpbGUgcmVuZGVyaW5nLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIGNhbiBsZWFkIHRvIGNvbmZ1c2luZyBidWdzLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiYSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0VW5pdE9mV29yazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBkaWRDYXB0dXJlRXJyb3IgPSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIXNob3VsZFVwZGF0ZSAmJiAhZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIGlmIChkaWRDYXB0dXJlRXJyb3IgJiYgdHlwZW9mIENvbXBvbmVudC5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGRpZENhcHR1cmVFcnJvcikgewogICAgICAgICAgICBmb3JjZVVubW91bnRDdXJyZW50QW5kUmVjb25jaWxlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHJvb3QzLnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyLCByb290My5wZW5kaW5nQ29udGV4dCwgcm9vdDMucGVuZGluZ0NvbnRleHQgIT09IHJvb3QzLmNvbnRleHQpOwogICAgICAgICAgfSBlbHNlIGlmIChyb290My5jb250ZXh0KSB7CiAgICAgICAgICAgIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyLCByb290My5jb250ZXh0LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Um9vdChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgY3VycmVudCBmaWJlci4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHByZXZDaGlsZHJlbiA9IHByZXZTdGF0ZS5lbGVtZW50OwogICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5leHRQcm9wcywgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJldlN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICB2YXIgb3ZlcnJpZGVTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBuZXh0Q2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBmYWxzZSwKICAgICAgICAgICAgICBjYWNoZTogbmV4dFN0YXRlLmNhY2hlLAogICAgICAgICAgICAgIHBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXM6IG5leHRTdGF0ZS5wZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzLAogICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBuZXh0U3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5iYXNlU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgIHZhciByZWNvdmVyYWJsZUVycm9yID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIobmV3IEVycm9yKCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgaHlkcmF0aW5nLiBCZWNhdXNlIHRoZSBlcnJvciBoYXBwZW5lZCBvdXRzaWRlIG9mIGEgU3VzcGVuc2UgYm91bmRhcnksIHRoZSBlbnRpcmUgcm9vdCB3aWxsIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dENoaWxkcmVuICE9PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICB2YXIgX3JlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoaXMgcm9vdCByZWNlaXZlZCBhbiBlYXJseSB1cGRhdGUsIGJlZm9yZSBhbnl0aGluZyB3YXMgYWJsZSBoeWRyYXRlLiBTd2l0Y2hlZCB0aGUgZW50aXJlIHJvb3QgdG8gY2xpZW50IHJlbmRlcmluZy4iKSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIF9yZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbnRlckh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyAmIH5QbGFjZW1lbnQgfCBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICBpZiAobmV4dENoaWxkcmVuID09PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogbnVsbDsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgaXNEaXJlY3RUZXh0Q2hpbGQgPSBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBuZXh0UHJvcHMpOwogICAgICAgICAgaWYgKGlzRGlyZWN0VGV4dENoaWxkKSB7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgaWYgKHByZXZQcm9wcyAhPT0gbnVsbCAmJiBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBwcmV2UHJvcHMpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDb250ZW50UmVzZXQ7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFRleHQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRMYXp5Q29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBlbGVtZW50VHlwZTsKICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgIHZhciBDb21wb25lbnQgPSBpbml0KHBheWxvYWQpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQ7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRUYWcgPSB3b3JrSW5Qcm9ncmVzczIudGFnID0gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KTsKICAgICAgICAgIHZhciByZXNvbHZlZFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCBwcm9wcyk7CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICBzd2l0Y2ggKHJlc29sdmVkVGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQudHlwZSwgcmVzb2x2ZWRQcm9wcyksCiAgICAgICAgICAgICAgICAvLyBUaGUgaW5uZXIgdHlwZSBjYW4gaGF2ZSBkZWZhdWx0cyB0b28KICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGludCA9ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50ICE9PSBudWxsICYmIHR5cGVvZiBDb21wb25lbnQgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgaGludCA9ICIgRGlkIHlvdSB3cmFwIGEgY29tcG9uZW50IGluIFJlYWN0LmxhenkoKSBtb3JlIHRoYW4gb25jZT8iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgdHlwZSBpcyBpbnZhbGlkLiBSZWNlaXZlZCBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0bzogIiArIENvbXBvbmVudCArICIuICIgKyAoIkxhenkgZWxlbWVudCB0eXBlIG11c3QgcmVzb2x2ZSB0byBhIGNsYXNzIG9yIGZ1bmN0aW9uLiIgKyBoaW50KSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gZmluaXNoQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZmFsc2UpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQucHJvdG90eXBlICYmIHR5cGVvZiBDb21wb25lbnQucHJvdG90eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0QmFkQ2xhc3NbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGhhdmUgYSByZW5kZXIgbWV0aG9kLCBidXQgZG9lc24ndCBleHRlbmQgUmVhY3QuQ29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSB0byBjYXVzZSBlcnJvcnMuIENoYW5nZSAlcyB0byBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLnJlbmRlciA9PT0gImZ1bmN0aW9uIiAmJiB2YWx1ZS4kJHR5cGVvZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGJlIGEgZnVuY3Rpb24gY29tcG9uZW50IHRoYXQgcmV0dXJucyBhIGNsYXNzIGluc3RhbmNlLiBDaGFuZ2UgJXMgdG8gYSBjbGFzcyB0aGF0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIElmIHlvdSBjYW4ndCB1c2UgYSBjbGFzcyB0cnkgYXNzaWduaW5nIHRoZSBwcm90b3R5cGUgb24gdGhlIGZ1bmN0aW9uIGFzIGEgd29ya2Fyb3VuZC4gYCVzLnByb3RvdHlwZSA9IFJlYWN0LkNvbXBvbmVudC5wcm90b3R5cGVgLiBEb24ndCB1c2UgYW4gYXJyb3cgZnVuY3Rpb24gc2luY2UgaXQgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGBuZXdgIGJ5IFJlYWN0LiIsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBSdW4gdGhlc2UgY2hlY2tzIGluIHByb2R1Y3Rpb24gb25seSBpZiB0aGUgZmxhZyBpcyBvZmYuCiAgICAgICAgICAgIC8vIEV2ZW50dWFsbHkgd2UnbGwgZGVsZXRlIHRoaXMgYnJhbmNoIGFsdG9nZXRoZXIuCiAgICAgICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLnJlbmRlciA9PT0gImZ1bmN0aW9uIiAmJiB2YWx1ZS4kJHR5cGVvZiA9PT0gdm9pZCAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTIgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGJlIGEgZnVuY3Rpb24gY29tcG9uZW50IHRoYXQgcmV0dXJucyBhIGNsYXNzIGluc3RhbmNlLiBDaGFuZ2UgJXMgdG8gYSBjbGFzcyB0aGF0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIElmIHlvdSBjYW4ndCB1c2UgYSBjbGFzcyB0cnkgYXNzaWduaW5nIHRoZSBwcm90b3R5cGUgb24gdGhlIGZ1bmN0aW9uIGFzIGEgd29ya2Fyb3VuZC4gYCVzLnByb3RvdHlwZSA9IFJlYWN0LkNvbXBvbmVudC5wcm90b3R5cGVgLiBEb24ndCB1c2UgYW4gYXJyb3cgZnVuY3Rpb24gc2luY2UgaXQgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGBuZXdgIGJ5IFJlYWN0LiIsIF9jb21wb25lbnROYW1lMiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTJdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHZhbHVlLnN0YXRlICE9PSBudWxsICYmIHZhbHVlLnN0YXRlICE9PSB2b2lkIDAgPyB2YWx1ZS5zdGF0ZSA6IG51bGw7CiAgICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSk7CiAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKG51bGwsIHdvcmtJblByb2dyZXNzMiwgdmFsdWUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudC5jaGlsZENvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IGNoaWxkQ29udGV4dFR5cGVzIGNhbm5vdCBiZSBkZWZpbmVkIG9uIGEgZnVuY3Rpb24gY29tcG9uZW50LiIsIENvbXBvbmVudC5kaXNwbGF5TmFtZSB8fCBDb21wb25lbnQubmFtZSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG93bmVyTmFtZSB8fCAiIjsKICAgICAgICAgICAgICB2YXIgZGVidWdTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgIGlmIChkZWJ1Z1NvdXJjZSkgewogICAgICAgICAgICAgICAgd2FybmluZ0tleSA9IGRlYnVnU291cmNlLmZpbGVOYW1lICsgIjoiICsgZGVidWdTb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcy4gQXR0ZW1wdHMgdG8gYWNjZXNzIHRoaXMgcmVmIHdpbGwgZmFpbC4gRGlkIHlvdSBtZWFuIHRvIHVzZSBSZWFjdC5mb3J3YXJkUmVmKCk/JXMiLCBpbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENvbXBvbmVudC5kZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gZnVuY3Rpb24gY29tcG9uZW50cyBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBVc2UgSmF2YVNjcmlwdCBkZWZhdWx0IHBhcmFtZXRlcnMgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudC5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUzID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTNdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEZ1bmN0aW9uIGNvbXBvbmVudHMgZG8gbm90IHN1cHBvcnQgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiIsIF9jb21wb25lbnROYW1lMyk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudC5jb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LmNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lNCA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTRdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEZ1bmN0aW9uIGNvbXBvbmVudHMgZG8gbm90IHN1cHBvcnQgY29udGV4dFR5cGUuIiwgX2NvbXBvbmVudE5hbWU0KTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTRdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFNVU1BFTkRFRF9NQVJLRVIgPSB7CiAgICAgICAgICBkZWh5ZHJhdGVkOiBudWxsLAogICAgICAgICAgdHJlZUNvbnRleHQ6IG51bGwsCiAgICAgICAgICByZXRyeUxhbmU6IE5vTGFuZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmFzZUxhbmVzOiByZW5kZXJMYW5lczIsCiAgICAgICAgICAgIGNhY2hlUG9vbDogZ2V0U3VzcGVuZGVkQ2FjaGUoKSwKICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmFzZUxhbmVzOiBtZXJnZUxhbmVzKHByZXZPZmZzY3JlZW5TdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMiksCiAgICAgICAgICAgIGNhY2hlUG9vbCwKICAgICAgICAgICAgdHJhbnNpdGlvbnM6IHByZXZPZmZzY3JlZW5TdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtYWluT25GYWxsYmFjayhzdXNwZW5zZUNvbnRleHQsIGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gcmVtb3ZlTGFuZXMoY3VycmVudDQuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNob3VsZFN1c3BlbmQod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgdmFyIHNob3dGYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoZGlkU3VzcGVuZCB8fCBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDQpKSB7CiAgICAgICAgICAgIHNob3dGYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+RGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgZGVoeWRyYXRlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrRnJhZ21lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2RlaHlkcmF0ZWQgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICBpZiAoX2RlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZGlkU3VzcGVuZCwgbmV4dFByb3BzLCBfZGVoeWRyYXRlZCwgcHJldlN0YXRlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfbmV4dFByaW1hcnlDaGlsZHJlbiwgX25leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3RhdGUgPSBjdXJyZW50NC5jaGlsZC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIubWVtb2l6ZWRTdGF0ZSA9IHByZXZPZmZzY3JlZW5TdGF0ZSA9PT0gbnVsbCA/IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIDogdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5jaGlsZExhbmVzID0gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuMiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MyA9IHVwZGF0ZVN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5wZW5kaW5nUHJvcHMgPSBwcmltYXJ5Q2hpbGRQcm9wczsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgTm9MYW5lcywgbnVsbCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudDQsIG9mZnNjcmVlblByb3BzKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudDQsIG9mZnNjcmVlblByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IG51bGw7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBbY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudF07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gSW4gbGVnYWN5IG1vZGUsIHdlIGNvbW1pdCB0aGUgcHJpbWFyeSB0cmVlIGFzIGlmIGl0IHN1Y2Nlc3NmdWxseQogICAgICAgICAgICAvLyBjb21wbGV0ZWQsIGV2ZW4gdGhvdWdoIGl0J3MgaW4gYW4gaW5jb25zaXN0ZW50IHN0YXRlLgogICAgICAgICAgICAobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIE1ha2Ugc3VyZSB3ZSdyZSBvbiB0aGUgc2Vjb25kIHBhc3MsIGkuZS4gdGhlIHByaW1hcnkgY2hpbGQgZnJhZ21lbnQgd2FzCiAgICAgICAgICAgIC8vIGFscmVhZHkgY2xvbmVkLiBJbiBsZWdhY3kgbW9kZSwgdGhlIG9ubHkgY2FzZSB3aGVyZSB0aGlzIGlzbid0IHRydWUgaXMKICAgICAgICAgICAgLy8gd2hlbiBEZXZUb29scyBmb3JjZXMgdXMgdG8gZGlzcGxheSBhIGZhbGxiYWNrOyB3ZSBza2lwIHRoZSBmaXJzdCByZW5kZXIKICAgICAgICAgICAgLy8gcGFzcyBlbnRpcmVseSBhbmQgZ28gc3RyYWlnaHQgdG8gcmVuZGVyaW5nIHRoZSBmYWxsYmFjay4gKEluIENvbmN1cnJlbnQKICAgICAgICAgICAgLy8gTW9kZSwgU3VzcGVuc2VMaXN0IGNhbiBhbHNvIHRyaWdnZXIgdGhpcyBzY2VuYXJpbywgYnV0IHRoaXMgaXMgYSBsZWdhY3ktCiAgICAgICAgICAgIC8vIG9ubHkgY29kZXBhdGguKQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5wZW5kaW5nUHJvcHMgPSBwcmltYXJ5Q2hpbGRQcm9wczsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQsIHByaW1hcnlDaGlsZFByb3BzKTsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCwgZmFsbGJhY2tDaGlsZHJlbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3IgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihyZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBmaWJlck1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBmaWJlck1vZGUpOwogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIGZpYmVyTW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGh5ZHJhdGUgU3VzcGVuc2UgaW4gbGVnYWN5IG1vZGUuIFN3aXRjaCBmcm9tIFJlYWN0RE9NLmh5ZHJhdGUoZWxlbWVudCwgY29udGFpbmVyKSB0byBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pLnJlbmRlcihlbGVtZW50KSBvciByZW1vdmUgdGhlIFN1c3BlbnNlIGNvbXBvbmVudHMgZnJvbSB0aGUgc2VydmVyIHJlbmRlcmVkIGNvbXBvbmVudHMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoU3luY0xhbmUpOwogICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhEZWZhdWx0SHlkcmF0aW9uTGFuZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhPZmZzY3JlZW5MYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZGlkU3VzcGVuZCwgbmV4dFByb3BzLCBzdXNwZW5zZUluc3RhbmNlLCBzdXNwZW5zZVN0YXRlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmICghZGlkU3VzcGVuZCkgewogICAgICAgICAgICB3YXJuSWZIeWRyYXRpbmcoKTsKICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKAogICAgICAgICAgICAgICAgY3VycmVudDQsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIsCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBXaGVuIHdlIGRlbGV0ZSBsZWdhY3kgbW9kZSwgd2Ugc2hvdWxkIG1ha2UgdGhpcyBlcnJvciBhcmd1bWVudAogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQg4oCUIGV2ZXJ5IGNvbmN1cnJlbnQgbW9kZSBwYXRoIHRoYXQgY2F1c2VzIGh5ZHJhdGlvbiB0bwogICAgICAgICAgICAgICAgLy8gZGUtb3B0IHRvIGNsaWVudCByZW5kZXJpbmcgc2hvdWxkIGhhdmUgYW4gZXJyb3IgbWVzc2FnZS4KICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYgPSBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkaWdlc3QgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYuZGlnZXN0OwogICAgICAgICAgICAgICAgbWVzc2FnZSA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5tZXNzYWdlOwogICAgICAgICAgICAgICAgc3RhY2sgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYuc3RhY2s7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvcjI7CiAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihtZXNzYWdlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJUaGUgc2VydmVyIGNvdWxkIG5vdCBmaW5pc2ggdGhpcyBTdXNwZW5zZSBib3VuZGFyeSwgbGlrZWx5IGR1ZSB0byBhbiBlcnJvciBkdXJpbmcgc2VydmVyIHJlbmRlcmluZy4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKGVycm9yMiwgZGlnZXN0LCBzdGFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgY2FwdHVyZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc0NvbnRleHRDaGFuZ2VkMiA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBjdXJyZW50NC5jaGlsZExhbmVzKTsKICAgICAgICAgICAgaWYgKGRpZFJlY2VpdmVVcGRhdGUgfHwgaGFzQ29udGV4dENoYW5nZWQyKSB7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSA9IGdldEJ1bXBlZExhbmVGb3JIeWRyYXRpb24ocm9vdDMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gTm9MYW5lICYmIGF0dGVtcHRIeWRyYXRpb25BdExhbmUgIT09IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lKSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZTsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoY3VycmVudDQsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUpOwogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQ0LCBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoaXMgU3VzcGVuc2UgYm91bmRhcnkgcmVjZWl2ZWQgYW4gdXBkYXRlIGJlZm9yZSBpdCBmaW5pc2hlZCBoeWRyYXRpbmcuIFRoaXMgY2F1c2VkIHRoZSBib3VuZGFyeSB0byBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4gVGhlIHVzdWFsIHdheSB0byBmaXggdGhpcyBpcyB0byB3cmFwIHRoZSBvcmlnaW5hbCB1cGRhdGUgaW4gc3RhcnRUcmFuc2l0aW9uLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJldHJ5RGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkuYmluZChudWxsLCBjdXJyZW50NCk7CiAgICAgICAgICAgICAgcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoc3VzcGVuc2VJbnN0YW5jZSwgcmV0cnkpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZW50ZXJIeWRyYXRpb25TdGF0ZUZyb21EZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUudHJlZUNvbnRleHQpOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gSHlkcmF0aW5nOwogICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5Gb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUyID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcgdGhpcyBTdXNwZW5zZSBib3VuZGFyeS4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgX2NhcHR1cmVkVmFsdWUyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBuZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50NC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKGZpYmVyLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKGZpYmVyLnJldHVybiwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVTdXNwZW5zZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBmaXJzdENoaWxkLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBub2RlID0gZmlyc3RDaGlsZDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKG5vZGUsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRMYXN0Q29udGVudFJvdyhmaXJzdENoaWxkKSB7CiAgICAgICAgICB2YXIgcm93ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIHZhciBsYXN0Q29udGVudFJvdyA9IG51bGw7CiAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cgPSByb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUmV2ZWFsT3JkZXIocmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJldmVhbE9yZGVyICE9PSB2b2lkIDAgJiYgcmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAidG9nZXRoZXIiICYmICFkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcltyZXZlYWxPcmRlcl0pIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcltyZXZlYWxPcmRlcl0gPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV2ZWFsT3JkZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAidG9nZXRoZXIiOgogICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkcyI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkcyI6IHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSB2YWxpZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gVXNlIGxvd2VyY2FzZSAiJXMiIGluc3RlYWQuJywgcmV2ZWFsT3JkZXIsIHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmQiOgogICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZCI6IHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSB2YWxpZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gUmVhY3QgdXNlcyB0aGUgLXMgc3VmZml4IGluIHRoZSBzcGVsbGluZy4gVXNlICIlc3MiIGluc3RlYWQuJywgcmV2ZWFsT3JkZXIsIHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgc3VwcG9ydGVkIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAidG9nZXRoZXIiLCAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiPycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoJyVzIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVRhaWxPcHRpb25zKHRhaWxNb2RlLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09IHZvaWQgMCAmJiAhZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdKSB7CiAgICAgICAgICAgICAgaWYgKHRhaWxNb2RlICE9PSAiY29sbGFwc2VkIiAmJiB0YWlsTW9kZSAhPT0gImhpZGRlbiIpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgdmFsdWUgZm9yIHRhaWwgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJjb2xsYXBzZWQiIG9yICJoaWRkZW4iPycsIHRhaWxNb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJldmVhbE9yZGVyICE9PSAiZm9yd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAiYmFja3dhcmRzIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCc8U3VzcGVuc2VMaXN0IHRhaWw9IiVzIiAvPiBpcyBvbmx5IHZhbGlkIGlmIHJldmVhbE9yZGVyIGlzICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyIuIERpZCB5b3UgbWVhbiB0byBzcGVjaWZ5IHJldmVhbE9yZGVyPSJmb3J3YXJkcyI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkU2xvdCwgaW5kZXgyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc0FuQXJyYXkgPSBpc0FycmF5MihjaGlsZFNsb3QpOwogICAgICAgICAgICB2YXIgaXNJdGVyYWJsZSA9ICFpc0FuQXJyYXkgJiYgdHlwZW9mIGdldEl0ZXJhdG9yRm4oY2hpbGRTbG90KSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgICAgaWYgKGlzQW5BcnJheSB8fCBpc0l0ZXJhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBpc0FuQXJyYXkgPyAiYXJyYXkiIDogIml0ZXJhYmxlIjsKICAgICAgICAgICAgICBlcnJvcigiQSBuZXN0ZWQgJXMgd2FzIHBhc3NlZCB0byByb3cgIyVzIGluIDxTdXNwZW5zZUxpc3QgLz4uIFdyYXAgaXQgaW4gYW4gYWRkaXRpb25hbCBTdXNwZW5zZUxpc3QgdG8gY29uZmlndXJlIGl0cyByZXZlYWxPcmRlcjogPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+IC4uLiA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPS4uLj57JXN9PC9TdXNwZW5zZUxpc3Q+IC4uLiA8L1N1c3BlbnNlTGlzdD4iLCB0eXBlLCBpbmRleDIsIHR5cGUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4oY2hpbGRyZW4sIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgocmV2ZWFsT3JkZXIgPT09ICJmb3J3YXJkcyIgfHwgcmV2ZWFsT3JkZXIgPT09ICJiYWNrd2FyZHMiKSAmJiBjaGlsZHJlbiAhPT0gdm9pZCAwICYmIGNoaWxkcmVuICE9PSBudWxsICYmIGNoaWxkcmVuICE9PSBmYWxzZSkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDQgIT09IG51bGwgJiYgKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50NC5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50NCwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50NC5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQ0XTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50NC50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDQuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCB1bnJlc29sdmVkUHJvcHMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gX0NvbXBvbmVudCA/IF91bnJlc29sdmVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihfQ29tcG9uZW50LCBfdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudCwgX3Jlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFJvb3QoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKHR5cGUsIF91bnJlc29sdmVkUHJvcHMyKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBfcmVzb2x2ZWRQcm9wczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMiwgX3VucmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IF90eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudDIsIF91bnJlc29sdmVkUHJvcHM0KTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudDIsIF9yZXNvbHZlZFByb3BzNCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB1bml0IG9mIHdvcmsgdGFnICgiICsgd29ya0luUHJvZ3Jlc3MyLnRhZyArICIpLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlbjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCQxOwogICAgICAgIHZhciB1cGRhdGVIb3N0VGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuID0gZnVuY3Rpb24ocGFyZW50LCB3b3JrSW5Qcm9ncmVzczIsIG5lZWRzVmlzaWJpbGl0eVRvZ2dsZSwgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2spIHsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgY2FzZSAiaGlkZGVuIjogewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKHRhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFpbE5vZGUgPSB0YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJjb2xsYXBzZWQiOiB7CiAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIF9sYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChfdGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUgPSBfdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9sYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgIHZhciBkaWRCYWlsb3V0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGUgIT09IG51bGwgJiYgY29tcGxldGVkV29yay5hbHRlcm5hdGUuY2hpbGQgPT09IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIGlmICghZGlkQmFpbG91dCkgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhjaGlsZC5sYW5lcywgY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIGFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdHJlZUJhc2VEdXJhdGlvbiArPSBjaGlsZC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uID0gYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZC5sYW5lcywgX2NoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIF9jaGlsZC5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3RyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDIubGFuZXMsIF9jaGlsZDIuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF90cmVlQmFzZUR1cmF0aW9uICs9IF9jaGlsZDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IF90cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQzID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQzID0gX2NoaWxkMy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgcmV0dXJuIGRpZEJhaWxvdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICBpZiAoaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpICYmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyIHwgSW5jb21wbGV0ZSB8IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsICYmIG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQSBkZWh5ZHJhdGVkIHN1c3BlbnNlIGNvbXBvbmVudCB3YXMgY29tcGxldGVkIHdpdGhvdXQgYSBoeWRyYXRlZCBub2RlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoX2lzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gX3ByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ5OgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQ0ID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDQgPT09IG51bGwgfHwgKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDQsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50NC5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzbmFwc2hvdCA9IGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBwcmV2UHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgcHJldlByb3BzKSwgcHJldlN0YXRlKTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkaWRXYXJuU2V0ID0gZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNuYXBzaG90ID09PSB2b2lkIDAgJiYgIWRpZFdhcm5TZXQuaGFzKGZpbmlzaGVkV29yay50eXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2FyblNldC5hZGQoZmluaXNoZWRXb3JrLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCk6IEEgc25hcHNob3QgdmFsdWUgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IHNuYXBzaG90OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgY2xlYXJDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmssIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdCh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoZmxhZ3MsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZSAhPT0gbnVsbCA/IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgOiBudWxsOwogICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBmbGFncykgPT09IGZsYWdzKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZSA9IGVmZmVjdC5jcmVhdGU7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gY3JlYXRlKCk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgZGVzdHJveSA9IGVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwICYmIHR5cGVvZiBkZXN0cm95ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZWZmZWN0LnRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZCBudWxsLiBJZiB5b3VyIGVmZmVjdCBkb2VzIG5vdCByZXF1aXJlIGNsZWFuIHVwLCByZXR1cm4gdW5kZWZpbmVkIChvciBub3RoaW5nKS4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlc3Ryb3kudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiXG5cbkl0IGxvb2tzIGxpa2UgeW91IHdyb3RlICIgKyBob29rTmFtZSArICIoYXN5bmMgKCkgPT4gLi4uKSBvciByZXR1cm5lZCBhIFByb21pc2UuIEluc3RlYWQsIHdyaXRlIHRoZSBhc3luYyBmdW5jdGlvbiBpbnNpZGUgeW91ciBlZmZlY3QgYW5kIGNhbGwgaXQgaW1tZWRpYXRlbHk6XG5cbiIgKyBob29rTmFtZSArICIoKCkgPT4ge1xuICBhc3luYyBmdW5jdGlvbiBmZXRjaERhdGEoKSB7XG4gICAgLy8gWW91IGNhbiBhd2FpdCBoZXJlXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBNeUFQSS5nZXREYXRhKHNvbWVJZCk7XG4gICAgLy8gLi4uXG4gIH1cbiAgZmV0Y2hEYXRhKCk7XG59LCBbc29tZUlkXSk7IC8vIE9yIFtdIGlmIGVmZmVjdCBkb2Vzbid0IG5lZWQgcHJvcHMgb3Igc3RhdGVcblxuTGVhcm4gbW9yZSBhYm91dCBkYXRhIGZldGNoaW5nIHdpdGggSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ob29rcy1kYXRhLWZldGNoaW5nIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZDogIiArIGRlc3Ryb3k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBtdXN0IG5vdCByZXR1cm4gYW55dGhpbmcgYmVzaWRlcyBhIGZ1bmN0aW9uLCB3aGljaCBpcyB1c2VkIGZvciBjbGVhbi11cC4lcyIsIGhvb2tOYW1lLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgICB2YXIgcGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgaWQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUuaWQsIG9uUG9zdENvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZS5vblBvc3RDb21taXQ7CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZSA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Qb3N0Q29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25Qb3N0Q29tbWl0KGlkLCBwaGFzZSwgcGFzc2l2ZUVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihmaW5pc2hlZFJvb3QsIGN1cnJlbnQ0LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgY3VycmVudDQubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIHVwZGF0ZVF1ZXVlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF91cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmIChfdXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZ2V0UHVibGljSW5zdGFuY2UoZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgX3VwZGF0ZVF1ZXVlLCBfaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsICYmIGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgY29tbWl0TW91bnQoX2luc3RhbmNlMiwgdHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUyID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIG9uQ29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vbkNvbW1pdCwgb25SZW5kZXIgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uUmVuZGVyOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGN1cnJlbnQ0ID09PSBudWxsID8gIm1vdW50IiA6ICJ1cGRhdGUiOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9ICJuZXN0ZWQtdXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUmVuZGVyKGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZmluaXNoZWRXb3JrLmFjdHVhbER1cmF0aW9uLCBmaW5pc2hlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiwgZmluaXNoZWRXb3JrLmFjdHVhbFN0YXJ0VGltZSwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1pdChmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVucXVldWVQZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgICBvdXRlcjogd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihub2RlKSB7CiAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBkZWxldGVkRmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgdmFyIF9lZmZlY3QgPSBlZmZlY3QsIGRlc3Ryb3kgPSBfZWZmZWN0LmRlc3Ryb3ksIHRhZyA9IF9lZmZlY3QudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZEZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZGVsZXRlZEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZGVsZXRlZEZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBkZWxldGVkRmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAocmV0cnlDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID0gbmV3IFBvc3NpYmx5V2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHdha2VhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmVzb2x2ZVJldHJ5V2FrZWFibGUuYmluZChudWxsLCBmaW5pc2hlZFdvcmssIHdha2VhYmxlKTsKICAgICAgICAgICAgICBpZiAoIXJldHJ5Q2FjaGUuaGFzKHdha2VhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0cnlDYWNoZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Qcm9ncmVzc0xhbmVzICE9PSBudWxsICYmIGluUHJvZ3Jlc3NSb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKGluUHJvZ3Jlc3NSb290LCBpblByb2dyZXNzTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgZmluaXNoZWQgcm9vdCBhbmQgbGFuZXMgdG8gYmUgc2V0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FrZWFibGUudGhlbihyZXRyeSwgcmV0cnkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMpOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgbGFuZXMpIHsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBwYXJlbnRGaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY2hpbGRUb0RlbGV0ZSwgcGFyZW50RmliZXIsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkRlYnVnRmliZXIgPSBnZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5zdWJ0cmVlRmxhZ3MgJiBNdXRhdGlvbk1hc2spIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50RmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjaGlsZCk7CiAgICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihjaGlsZCwgcm9vdDMpOwogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZEZWJ1Z0ZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZTQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlKF9pbnN0YW5jZTQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgc2hvdWxkIGhhdmUgYSB0ZXh0IG5vZGUgaW5pdGlhbGl6ZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0ID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogbmV3VGV4dDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2Um9vdFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldlJvb3RTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5GaWJlciA9IGZpbmlzaGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuRmliZXIuZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuSW5zdGFuY2UgPSBvZmZzY3JlZW5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBvZmZzY3JlZW5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IGlzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUgIT09IG51bGwgJiYgb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmICghd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3dhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IF93YXNIaWRkZW47CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgX29mZnNjcmVlbkluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBfbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfaXNIaWRkZW4gPSBfbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQm91bmRhcnkgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBfaXNIaWRkZW47CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChfaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIV93YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICgob2Zmc2NyZWVuQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5Cb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQm91bmRhcnkuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzY3JlZW5DaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5DaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKG9mZnNjcmVlbkNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4ob2Zmc2NyZWVuQm91bmRhcnksIF9pc0hpZGRlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZsYWdzICYgSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+SHlkcmF0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSAoc3VidHJlZVJvb3QubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50ICYmIGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGlzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICBpZiAobmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHdhc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiAmJiAhcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oCiAgICAgICAgICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgICAgICAgICAgLy8gTmV3IHJvb3Q7IGJ1YmJsZSBiYWNrIHVwIHRvIGhlcmUgYW5kIHN0b3AuCiAgICAgICAgICAgICAgICAgICAgcm9vdDMsCiAgICAgICAgICAgICAgICAgICAgY29tbWl0dGVkTGFuZXMKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIocm9vdDMsIGN1cnJlbnQ0LCBmaWJlciwgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBQYXNzaXZlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIocm9vdDMsIGZpYmVyLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50T25GaWJlcihmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihkZWxldGVkU3VidHJlZVJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpOwogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnQ0LnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwgPSBNYXRoLmNlaWw7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudE93bmVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLCBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgdmFyIE5vQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQmF0Y2hlZENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUmVuZGVyQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29tbWl0Q29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUm9vdEluUHJvZ3Jlc3MgPSAwOwogICAgICAgIHZhciBSb290RmF0YWxFcnJvcmVkID0gMTsKICAgICAgICB2YXIgUm9vdEVycm9yZWQgPSAyOwogICAgICAgIHZhciBSb290U3VzcGVuZGVkID0gMzsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZFdpdGhEZWxheSA9IDQ7CiAgICAgICAgdmFyIFJvb3RDb21wbGV0ZWQgPSA1OwogICAgICAgIHZhciBSb290RGlkTm90Q29tcGxldGUgPSA2OwogICAgICAgIHZhciBleGVjdXRpb25Db250ZXh0ID0gTm9Db250ZXh0OwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5vTGFuZXMpOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgdmFyIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSAwOwogICAgICAgIHZhciBGQUxMQkFDS19USFJPVFRMRV9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyVGFyZ2V0VGltZSA9IEluZmluaXR5OwogICAgICAgIHZhciBSRU5ERVJfVElNRU9VVF9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRSZW5kZXJUaW1lcigpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBub3coKSArIFJFTkRFUl9USU1FT1VUX01TOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWU7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICB2YXIgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSBudWxsOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIHZhciBORVNURURfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgdmFyIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID0gTm9MYW5lczsKICAgICAgICB2YXIgaXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEV2ZW50VGltZSgpIHsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRpbWUgIT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IG5vdygpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCAmJiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmUod29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzVHJhbnNpdGlvbiA9IHJlcXVlc3RDdXJyZW50VHJhbnNpdGlvbigpICE9PSBOb1RyYW5zaXRpb247CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgICBpZiAoIXRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRMYW5lID0gZ2V0Q3VycmVudEV2ZW50UHJpb3JpdHkoKTsKICAgICAgICAgIHJldHVybiBldmVudExhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RSZXRyeUxhbmUoZmliZXIpIHsKICAgICAgICAgIHZhciBtb2RlID0gZmliZXIubW9kZTsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjbGFpbU5leHRSZXRyeUxhbmUoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCkgewogICAgICAgICAgICAgIGVycm9yKCJ1c2VJbnNlcnRpb25FZmZlY3QgbXVzdCBub3Qgc2NoZWR1bGUgdXBkYXRlcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0xhbmVzICYmIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcik7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICBpZiAobGFuZSA9PT0gU3luY0xhbmUgJiYgZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0ICYmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICBjdXJyZW50NC5sYW5lcyA9IGxhbmU7CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIG91dGRhdGVkIGRlZmVyUmVuZGVyUGhhc2VVcGRhdGVUb05leHRCYXRjaCBleHBlcmltZW50LiBXZQogICAgICAgICAgICAvLyBkZWNpZGVkIG5vdCB0byBlbmFibGUgaXQuCiAgICAgICAgICAgIChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpOwogICAgICAgICAgdmFyIG5leHRMYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0NhbGxiYWNrTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrJDEoZXhpc3RpbmdDYWxsYmFja05vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja1ByaW9yaXR5ID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9IHJvb3QzLmNhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ID09PSBuZXdDYWxsYmFja1ByaW9yaXR5ICYmIC8vIFNwZWNpYWwgY2FzZSByZWxhdGVkIHRvIGBhY3RgLiBJZiB0aGUgY3VycmVudGx5IHNjaGVkdWxlZCB0YXNrIGlzIGEKICAgICAgICAgIC8vIFNjaGVkdWxlciB0YXNrLCByYXRoZXIgdGhhbiBhbiBgYWN0YCB0YXNrLCBjYW5jZWwgaXQgYW5kIHJlLXNjaGVkdWxlZAogICAgICAgICAgLy8gb24gdGhlIGBhY3RgIHF1ZXVlLgogICAgICAgICAgIShSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IGZha2VBY3RDYWxsYmFja05vZGUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgIT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2NoZWR1bGVkIGNhbGxiYWNrIHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT0gbnVsbCkgewogICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja05vZGU7CiAgICAgICAgICBpZiAobmV3Q2FsbGJhY2tQcmlvcml0eSA9PT0gU3luY0xhbmUpIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyA9PT0gTGVnYWN5Um9vdCkgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKHBlcmZvcm1TeW5jV29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudC5wdXNoKGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlTWljcm90YXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHN3aXRjaCAobGFuZXNUb0V2ZW50UHJpb3JpdHkobmV4dExhbmVzKSkgewogICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBzY2hlZHVsZUNhbGxiYWNrJDEoc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCwgcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBuZXdDYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tOb2RlID0gbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3Qocm9vdDMsIGRpZFRpbWVvdXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFja05vZGUgPSByb290My5jYWxsYmFja05vZGU7CiAgICAgICAgICB2YXIgZGlkRmx1c2hQYXNzaXZlRWZmZWN0cyA9IGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIGlmIChkaWRGbHVzaFBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgIT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVGltZVNsaWNlID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSAmJiAhZGlkVGltZW91dDsKICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gc2hvdWxkVGltZVNsaWNlID8gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSA6IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICBpZiAoZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICB2YXIgZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RGlkTm90Q29tcGxldGUpIHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcldhc0NvbmN1cnJlbnQgPSAhaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuY3VycmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcldhc0NvbmN1cnJlbnQgJiYgIWlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspKSB7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Vycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgaWYgKF9lcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgICBsYW5lcyA9IF9lcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBfZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICAgICAgICB0aHJvdyBfZmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgICBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSA9PT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKSB7CiAgICAgICAgICB2YXIgZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnM7CiAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgdmFyIHJvb3RXb3JrSW5Qcm9ncmVzcyA9IHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICByb290V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvckh5ZHJhdGluZ0NvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4aXRTdGF0dXMgPSByZW5kZXJSb290U3luYyhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgIGlmIChleGl0U3RhdHVzICE9PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB2YXIgZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9yczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBlcnJvcnNGcm9tRmlyc3RBdHRlbXB0OwogICAgICAgICAgICBpZiAoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzMykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzMzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLnB1c2guYXBwbHkod29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIGVycm9yczMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcykgewogICAgICAgICAgc3dpdGNoIChleGl0U3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgUm9vdEluUHJvZ3Jlc3M6CiAgICAgICAgICAgIGNhc2UgUm9vdEZhdGFsRXJyb3JlZDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdEVycm9yZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290U3VzcGVuZGVkOiB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSAmJiAvLyBkbyBub3QgZGVsYXkgaWYgd2UncmUgaW5zaWRlIGFuIGFjdCgpIHNjb3BlCiAgICAgICAgICAgICAgIXNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpKSB7CiAgICAgICAgICAgICAgICB2YXIgbXNVbnRpbFRpbWVvdXQgPSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lICsgRkFMTEJBQ0tfVEhST1RUTEVfTVMgLSBub3coKTsKICAgICAgICAgICAgICAgIGlmIChtc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAobmV4dExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHN1c3BlbmRlZExhbmVzLCBsYW5lcykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICAgIG1hcmtSb290UGluZ2VkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgbXNVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZFdpdGhEZWxheTogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lTXMgPSBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgICAgICAgICAgdmFyIHRpbWVFbGFwc2VkTXMgPSBub3coKSAtIGV2ZW50VGltZU1zOwogICAgICAgICAgICAgICAgdmFyIF9tc1VudGlsVGltZW91dCA9IGpuZCh0aW1lRWxhcHNlZE1zKSAtIHRpbWVFbGFwc2VkTXM7CiAgICAgICAgICAgICAgICBpZiAoX21zVW50aWxUaW1lb3V0ID4gMTApIHsKICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgX21zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RDb21wbGV0ZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByb290IGV4aXQgc3RhdHVzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgaWYgKG5vZGUuZmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5KSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gbm9kZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjaGVja3MgPSB1cGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hlY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrID0gY2hlY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIHZhciBnZXRTbmFwc2hvdCA9IGNoZWNrLmdldFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZFZhbHVlID0gY2hlY2sudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMoZ2V0U25hcHNob3QoKSwgcmVuZGVyZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAobm9kZS5zdWJ0cmVlRmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5ICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQkMShyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzKTsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1TeW5jV29ya09uUm9vdChyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBzeW5jTmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgdmFyIGxhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShsYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIGxhbmVzID0gZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIHRocm93IGZhdGFsRXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSb290KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKGxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBtZXJnZUxhbmVzKGxhbmVzLCBTeW5jTGFuZSkpOwogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyQxKGZuLCBhKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBmbihhKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNjcmV0ZVVwZGF0ZXMoZm4sIGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIsIGMsIGQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCAmJiByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cy50YWcgPT09IExlZ2FjeVJvb3QgJiYgKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IEJhdGNoZWRDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlSZW5kZXJpbmcoKSB7CiAgICAgICAgICByZXR1cm4gKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUmVuZGVyTGFuZXMoZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBwdXNoKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgc3VidHJlZVJlbmRlckxhbmVzLCBmaWJlcik7CiAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHN1YnRyZWVSZW5kZXJMYW5lcywgbGFuZXMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BSZW5kZXJMYW5lcyhmaWJlcikgewogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3Aoc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHRpbWVvdXRIYW5kbGUgPSByb290My50aW1lb3V0SGFuZGxlOwogICAgICAgICAgaWYgKHRpbWVvdXRIYW5kbGUgIT09IG5vVGltZW91dCkgewogICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgICBjYW5jZWxUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcnJ1cHRlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChpbnRlcnJ1cHRlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDQgPSBpbnRlcnJ1cHRlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBpbnRlcnJ1cHRlZFdvcmsgPSBpbnRlcnJ1cHRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhyb290My5jdXJyZW50LCBudWxsKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gcm9vdFdvcmtJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBzdWJ0cmVlUmVuZGVyTGFuZXMgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIGlmIChlcnJvcmVkV29yayA9PT0gbnVsbCB8fCBlcnJvcmVkV29yay5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RmF0YWxFcnJvcmVkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlcnJvcmVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZXJyb3JlZFdvcmssIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICAgICAgaWYgKHRocm93blZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB0aHJvd25WYWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRocm93blZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZXJyb3JlZFdvcmssIHdha2VhYmxlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3JlZChlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dFeGNlcHRpb24ocm9vdDMsIGVycm9yZWRXb3JrLnJldHVybiwgZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKGVycm9yZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoeWV0QW5vdGhlclRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgdGhyb3duVmFsdWUgPSB5ZXRBbm90aGVyVGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzID09PSBlcnJvcmVkV29yayAmJiBlcnJvcmVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSBlcnJvcmVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGVycm9yZWRXb3JrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaERpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudDsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKHByZXZEaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpIHsKICAgICAgICAgIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSBub3coKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1NraXBwZWRVcGRhdGVMYW5lcyhsYW5lKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBtZXJnZUxhbmVzKGxhbmUsIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmQoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwgJiYgKGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKSB8fCBpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKSkpIHsKICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMSh3b3JrSW5Qcm9ncmVzc1Jvb3QsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyAhPT0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEVycm9yZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gW2Vycm9yMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IFJlbmRlckNvbnRleHQ7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBwdXNoRGlzcGF0Y2hlcigpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gcm9vdDMgfHwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICAgIGlmIChtZW1vaXplZFVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBnZXRUcmFuc2l0aW9uc0ZvckxhbmVzKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcFN5bmMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJvb3RJblByb2dyZXNzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BDb25jdXJyZW50KCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsICYmICFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gdW5pdE9mV29yay5hbHRlcm5hdGU7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIodW5pdE9mV29yayk7CiAgICAgICAgICB2YXIgbmV4dDsKICAgICAgICAgIGlmICgodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEodW5pdE9mV29yaywgdHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgdW5pdE9mV29yay5tZW1vaXplZFByb3BzID0gdW5pdE9mV29yay5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGNvbXBsZXRlZFdvcmsgPSB1bml0T2ZXb3JrOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gY29tcGxldGVkV29yay5yZXR1cm47CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5mbGFncyAmIEluY29tcGxldGUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNvbXBsZXRlZFdvcmspOwogICAgICAgICAgICAgIHZhciBuZXh0ID0gdm9pZCAwOwogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGNvbXBsZXRlZFdvcmssIGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBpZiAobmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHQgPSB1bndpbmRXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoX25leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9uZXh0LmZsYWdzICY9IEhvc3RFZmZlY3RNYXNrOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBfbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB2YXIgYWN0dWFsRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3REaWROb3RDb21wbGV0ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmdGaWJlciA9IGNvbXBsZXRlZFdvcmsuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gc2libGluZ0ZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gY29tcGxldGVkV29yazsKICAgICAgICAgIH0gd2hpbGUgKGNvbXBsZXRlZFdvcmsgIT09IG51bGwpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290Q29tcGxldGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290KHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHJlbmRlclByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfSB3aGlsZSAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpOwogICAgICAgICAgZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuZmluaXNoZWRXb3JrOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdDMuZmluaXNoZWRMYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyb290LmZpbmlzaGVkTGFuZXMgc2hvdWxkIG5vdCBiZSBlbXB0eSBkdXJpbmcgYSBjb21taXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByb290My5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSByb290My5jdXJyZW50KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJlbWFpbmluZ0xhbmVzID0gbWVyZ2VMYW5lcyhmaW5pc2hlZFdvcmsubGFuZXMsIGZpbmlzaGVkV29yay5jaGlsZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKTsKICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzIHx8IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gdHJhbnNpdGlvbnM7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VidHJlZUhhc0VmZmVjdHMgPSAoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIHZhciByb290SGFzRWZmZWN0ID0gKGZpbmlzaGVkV29yay5mbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChzdWJ0cmVlSGFzRWZmZWN0cyB8fCByb290SGFzRWZmZWN0KSB7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHNob3VsZEZpcmVBZnRlckFjdGl2ZUluc3RhbmNlQmx1cjIgPSBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGxhbmVzKTsKICAgICAgICAgICAgcmVzZXRBZnRlckNvbW1pdChyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXF1ZXN0UGFpbnQoKTsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlY29yZENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3REaWRIYXZlUGFzc2l2ZUVmZmVjdHMgPSByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0czsKICAgICAgICAgIGlmIChyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IHJvb3QzOwogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IGxhbmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHJlbWFpbmluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFyb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb25Db21taXRSb290KGZpbmlzaGVkV29yay5zdGF0ZU5vZGUsIHJlbmRlclByaW9yaXR5TGV2ZWwpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByb290My5tZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgb25Db21taXRSb290JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSByb290My5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3ZlcmFibGVFcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IHJlY292ZXJhYmxlRXJyb3JzW2ldOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHJlY292ZXJhYmxlRXJyb3Iuc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCA9IHJlY292ZXJhYmxlRXJyb3IuZGlnZXN0OwogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvcihyZWNvdmVyYWJsZUVycm9yLnZhbHVlLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICAgIGRpZ2VzdAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzVW5jYXVnaHRFcnJvcikgewogICAgICAgICAgICBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZmlyc3RVbmNhdWdodEVycm9yOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvciQxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMsIFN5bmNMYW5lKSAmJiByb290My50YWcgIT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfQogICAgICAgICAgcmVtYWluaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW1haW5pbmdMYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0cygpIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcmVuZGVyUHJpb3JpdHkgPSBsYW5lc1RvRXZlbnRQcmlvcml0eShwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyk7CiAgICAgICAgICAgIHZhciBwcmlvcml0eSA9IGxvd2VyRXZlbnRQcmlvcml0eShEZWZhdWx0RXZlbnRQcmlvcml0eSwgcmVuZGVyUHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJpb3JpdHkpOwogICAgICAgICAgICAgIHJldHVybiBmbHVzaFBhc3NpdmVFZmZlY3RzSW1wbCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrJDEoTm9ybWFsUHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYW5zaXRpb25zID0gcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9uczsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgICAgdmFyIHJvb3QzID0gcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lczsKICAgICAgICAgIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmx1c2ggcGFzc2l2ZSBlZmZlY3RzIHdoaWxlIGFscmVhZHkgcmVuZGVyaW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhyb290My5jdXJyZW50KTsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIHJvb3QzLmN1cnJlbnQsIGxhbmVzLCB0cmFuc2l0aW9ucyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9maWxlckVmZmVjdHMgPSBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0czsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9maWxlckVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyID0gcHJvZmlsZXJFZmZlY3RzW2ldOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVFZmZlY3REdXJhdGlvbnMocm9vdDMsIF9maWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYocm9vdDMuY3VycmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAocm9vdDMgPT09IHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvblBvc3RDb21taXRSb290KHJvb3QzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHJvb3QzLmN1cnJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQgIT09IG51bGwgJiYgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuaGFzKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZChpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID09PSBudWxsKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2luc3RhbmNlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZC5hZGQoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoIWhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9uVW5jYXVnaHRFcnJvciA9IHByZXBhcmVUb1Rocm93VW5jYXVnaHRFcnJvcjsKICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChyb290RmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvcjIpIHsKICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvcjIsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUocm9vdEZpYmVyLCBlcnJvckluZm8sIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUocm9vdEZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihzb3VyY2VGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IkMSkgewogICAgICAgICAgewogICAgICAgICAgICByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IkMSk7CiAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChzb3VyY2VGaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlciA9IG5lYXJlc3RNb3VudGVkQW5jZXN0b3I7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChmaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGN0b3IgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBBdHRlbXB0ZWQgdG8gY2FwdHVyZSBhIGNvbW1pdCBwaGFzZSBlcnJvciBpbnNpZGUgYSBkZXRhY2hlZCB0cmVlLiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdC4gTGlrZWx5IGNhdXNlcyBpbmNsdWRlIGRlbGV0aW5nIHRoZSBzYW1lIGZpYmVyIG1vcmUgdGhhbiBvbmNlLCBjb21taXR0aW5nIGFuIGFscmVhZHktZmluaXNoZWQgdHJlZSwgb3IgYW4gaW5jb25zaXN0ZW50IHJldHVybiBwb2ludGVyLlxuXG5FcnJvciBtZXNzYWdlOlxuXG4lcyIsIGVycm9yJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaW5nU3VzcGVuZGVkUm9vdChyb290Mywgd2FrZWFibGUsIHBpbmdlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUuZGVsZXRlKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMpOwogICAgICAgICAgd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCA9PT0gcm9vdDMgJiYgaXNTdWJzZXRPZkxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzLCBwaW5nZWRMYW5lcykpIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCAmJiBpbmNsdWRlc09ubHlSZXRyaWVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKSAmJiBub3coKSAtIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPCBGQUxMQkFDS19USFJPVFRMRV9NUykgewogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBpZiAocmV0cnlMYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0cnlMYW5lID0gcmVxdWVzdFJldHJ5TGFuZShib3VuZGFyeUZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHJldHJ5TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVSZXRyeVdha2VhYmxlKGJvdW5kYXJ5RmliZXIsIHdha2VhYmxlKSB7CiAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJldHJ5Q2FjaGU7CiAgICAgICAgICBzd2l0Y2ggKGJvdW5kYXJ5RmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGJvdW5kYXJ5RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBpbmdlZCB1bmtub3duIHN1c3BlbnNlIGJvdW5kYXJ5IHR5cGUuIFRoaXMgaXMgcHJvYmFibHkgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0cnlDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUNhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gam5kKHRpbWVFbGFwc2VkKSB7CiAgICAgICAgICByZXR1cm4gdGltZUVsYXBzZWQgPCAxMjAgPyAxMjAgOiB0aW1lRWxhcHNlZCA8IDQ4MCA/IDQ4MCA6IHRpbWVFbGFwc2VkIDwgMTA4MCA/IDEwODAgOiB0aW1lRWxhcHNlZCA8IDE5MjAgPyAxOTIwIDogdGltZUVsYXBzZWQgPCAzZTMgPyAzZTMgOiB0aW1lRWxhcHNlZCA8IDQzMjAgPyA0MzIwIDogY2VpbCh0aW1lRWxhcHNlZCAvIDE5NjApICogMTk2MDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKG5lc3RlZFVwZGF0ZUNvdW50ID4gTkVTVEVEX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IHJlcGVhdGVkbHkgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIGNvbXBvbmVudFdpbGxVcGRhdGUgb3IgY29tcG9uZW50RGlkVXBkYXRlLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiBuZXN0ZWQgdXBkYXRlcyB0byBwcmV2ZW50IGluZmluaXRlIGxvb3BzLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID4gTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICBlcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IGNhbGxzIHNldFN0YXRlIGluc2lkZSB1c2VFZmZlY3QsIGJ1dCB1c2VFZmZlY3QgZWl0aGVyIGRvZXNuJ3QgaGF2ZSBhIGRlcGVuZGVuY3kgYXJyYXksIG9yIG9uZSBvZiB0aGUgZGVwZW5kZW5jaWVzIGNoYW5nZXMgb24gZXZlcnkgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZygpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYoZmliZXIsIGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VFZmZlY3RzSW5EZXYoZmlyc3RDaGlsZCwgZmliZXJGbGFncywgaW52b2tlRWZmZWN0Rm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIHN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlTdWJ0cmVlRmxhZyA9IGN1cnJlbnQ0LnN1YnRyZWVGbGFncyAmIGZpYmVyRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBzdWJ0cmVlUm9vdCAmJiBjdXJyZW50NC5jaGlsZCAhPT0gbnVsbCAmJiBwcmltYXJ5U3VidHJlZUZsYWcgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQ0ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgoY3VycmVudDQuZmxhZ3MgJiBmaWJlckZsYWdzKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBpbnZva2VFZmZlY3RGbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IHN1YnRyZWVSb290ID0gY3VycmVudDQucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyAhPT0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCAmJiB0YWcgIT09IEhvc3RSb290ICYmIHRhZyAhPT0gQ2xhc3NDb21wb25lbnQgJiYgdGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiB0YWcgIT09IEZvcndhcmRSZWYyICYmIHRhZyAhPT0gTWVtb0NvbXBvbmVudCAmJiB0YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiUmVhY3RDb21wb25lbnQiOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2NvbXBvbmVudE5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJlZ2luV29yayQxOwogICAgICAgIHsKICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgIGJlZ2luV29yayQxID0gZnVuY3Rpb24oY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSA9IGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKGR1bW15RmliZXIsIHVuaXRPZldvcmspOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiZWdpbldvcmsoY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAob3JpZ2luYWxFcnJvcikgewogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIHVuaXRPZldvcmspOwogICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICBpZiAodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGJlZ2luV29yaywgbnVsbCwgY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXBsYXlFcnJvciA9PT0gIm9iamVjdCIgJiYgcmVwbGF5RXJyb3IgIT09IG51bGwgJiYgcmVwbGF5RXJyb3IuX3N1cHByZXNzTG9nZ2luZyAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiAhb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmICFnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSA9IHdvcmtJblByb2dyZXNzICYmIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgdmFyIGRlZHVwZUtleSA9IHJlbmRlcmluZ0NvbXBvbmVudE5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmhhcyhkZWR1cGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmFkZChkZWR1cGVLZXkpOwogICAgICAgICAgICAgICAgICAgIHZhciBzZXRTdGF0ZUNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgYSBjb21wb25lbnQgKGAlc2ApIHdoaWxlIHJlbmRlcmluZyBhIGRpZmZlcmVudCBjb21wb25lbnQgKGAlc2ApLiBUbyBsb2NhdGUgdGhlIGJhZCBzZXRTdGF0ZSgpIGNhbGwgaW5zaWRlIGAlc2AsIGZvbGxvdyB0aGUgc3RhY2sgdHJhY2UgYXMgZGVzY3JpYmVkIGluIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zZXRzdGF0ZS1pbi1yZW5kZXIiLCBzZXRTdGF0ZUNvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgZHVyaW5nIGFuIGV4aXN0aW5nIHN0YXRlIHRyYW5zaXRpb24gKHN1Y2ggYXMgd2l0aGluIGByZW5kZXJgKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIik7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKHNjaGVkdWxpbmdGaWJlcikgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBzY2hlZHVsaW5nRmliZXIsIGxhbmVzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUFjdENhbGxiYWNrTm9kZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2skMShwcmlvcml0eUxldmVsLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChhY3RRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFjdFF1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgIHJldHVybiBmYWtlQWN0Q2FsbGJhY2tOb2RlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxDYWxsYmFjayQxKGNhbGxiYWNrTm9kZSkgewogICAgICAgICAgaWYgKGNhbGxiYWNrTm9kZSA9PT0gZmFrZUFjdENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FuY2VsQ2FsbGJhY2soY2FsbGJhY2tOb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVXBkYXRlc05vdFdyYXBwZWRXaXRoQWN0REVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc0xlZ2FjeUFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiBmaWJlci50YWcgIT09IEZvcndhcmRSZWYyICYmIGZpYmVyLnRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgc3VzcGVuZGVkIHJlc291cmNlIGZpbmlzaGVkIGxvYWRpbmcgaW5zaWRlIGEgdGVzdCwgYnV0IHRoZSBldmVudCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IHJlc29sdmVzIHN1c3BlbmRlZCBkYXRhIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpbmlzaCBsb2FkaW5nIHN1c3BlbmRlZCBkYXRhICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGlzUnVubmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVGYW1pbHkgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgc2V0UmVmcmVzaEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gbnVsbCAmJiB0eXBlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHR5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlbmRlciA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgICBpZiAodHlwZS5yZW5kZXIgIT09IGN1cnJlbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN5bnRoZXRpY1R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyLAogICAgICAgICAgICAgICAgICAgIHJlbmRlcjogY3VycmVudFJlbmRlcgogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAodHlwZS5kaXNwbGF5TmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3ludGhldGljVHlwZS5kaXNwbGF5TmFtZSA9IHR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY1R5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGZpYmVyLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2VHlwZSA9IGZpYmVyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICB2YXIgbmV4dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgJCR0eXBlb2ZOZXh0VHlwZSA9IHR5cGVvZiBuZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgbmV4dFR5cGUgIT09IG51bGwgPyBuZXh0VHlwZS4kJHR5cGVvZiA6IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNDb21wYXJlRmFtaWxpZXMpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZhbWlseSA9IHJlc29sdmVGYW1pbHkocHJldlR5cGUpOwogICAgICAgICAgICAgIGlmIChwcmV2RmFtaWx5ICE9PSB2b2lkIDAgJiYgcHJldkZhbWlseSA9PT0gcmVzb2x2ZUZhbWlseShuZXh0VHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgV2Vha1NldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzLmFkZChmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgdXBkYXRlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdGFsZUZhbWlsaWVzID0gdXBkYXRlLnN0YWxlRmFtaWxpZXMsIHVwZGF0ZWRGYW1pbGllcyA9IHVwZGF0ZS51cGRhdGVkRmFtaWxpZXM7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgc2NoZWR1bGVSb290ID0gZnVuY3Rpb24ocm9vdDMsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLmNvbnRleHQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoZmliZXIsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlLCBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVzb2x2ZUZhbWlseSB0byBiZSBzZXQgZHVyaW5nIGhvdCByZWxvYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5lZWRzUmVuZGVyID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBuZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseShjYW5kaWRhdGVUeXBlKTsKICAgICAgICAgICAgICBpZiAoZmFtaWx5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChzdGFsZUZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWRGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBpZiAodGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyKSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgZmFpbGVkQm91bmRhcmllcy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCB8fCBuZWVkc1JlbmRlcikgewogICAgICAgICAgICAgIHZhciBfcm9vdCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChfcm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKF9yb290LCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmICFuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGNoaWxkLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShzaWJsaW5nLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgZmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgdHlwZXMgPSBuZXcgU2V0KGZhbWlsaWVzLm1hcChmdW5jdGlvbihmYW1pbHkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgcmV0dXJuIGhvc3RJbnN0YW5jZXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoZmliZXIsIHR5cGVzLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZXMuaGFzKGNhbmRpZGF0ZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGNoaWxkLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byByZWFjaCByb290IGZpcnN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGZvdW5kSG9zdEluc3RhbmNlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgIHsKICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMuZWxlbWVudFR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMucmV0dXJuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgdGhpcy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgIHRoaXMuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgdGhpcy5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdOZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc0JhZE1hcFBvbHlmaWxsICYmIHR5cGVvZiBPYmplY3QucHJldmVudEV4dGVuc2lvbnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBPYmplY3QucHJldmVudEV4dGVuc2lvbnModGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSAmJiB0eXBlLmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpID8gQ2xhc3NDb21wb25lbnQgOiBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZiA9IENvbXBvbmVudC4kJHR5cGVvZjsKICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgIHJldHVybiBGb3J3YXJkUmVmMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50NC5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IGNyZWF0ZUZpYmVyKGN1cnJlbnQ0LnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50NC5rZXksIGN1cnJlbnQ0Lm1vZGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50NC5lbGVtZW50VHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3VycmVudDQuc3RhdGVOb2RlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZSA9IGN1cnJlbnQ0Ll9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgPSBjdXJyZW50NC5fZGVidWdPd25lcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBjdXJyZW50NDsKICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDQuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50NC5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmluZGV4ID0gY3VycmVudDQuaW5kZXg7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGN1cnJlbnQ0Ll9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhjdXJyZW50NC50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gU3RhdGljTWFzayB8IFBsYWNlbWVudDsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQ0LnR5cGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgICAgbGFuZXM6IGN1cnJlbnREZXBlbmRlbmNpZXMubGFuZXMsCiAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSkgewogICAgICAgICAgdmFyIG1vZGU7CiAgICAgICAgICBpZiAodGFnID09PSBDb25jdXJyZW50Um9vdCkgewogICAgICAgICAgICBtb2RlID0gQ29uY3VycmVudE1vZGU7CiAgICAgICAgICAgIGlmIChpc1N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vZGUgPSBOb01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgbW9kZSB8PSBQcm9maWxlTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlcihIb3N0Um9vdCwgbnVsbCwgbnVsbCwgbW9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh0eXBlLCBrZXksIHBlbmRpbmdQcm9wcywgb3duZXIsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXJUYWcgPSBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENvbnN0cnVjdCQxKHR5cGUpKSB7CiAgICAgICAgICAgICAgZmliZXJUYWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICBmaWJlclRhZyA9IEhvc3RDb21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRUYWc6IHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21GcmFnbWVudChwZW5kaW5nUHJvcHMuY2hpbGRyZW4sIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTW9kZTsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX09GRlNDUkVFTl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU0NPUEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NBQ0hFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfREVCVUdfVFJBQ0lOR19NT0RFX1RZUEU6CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0Q29uc3VtZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBMYXp5Q29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IG93bmVyID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcikgOiBudWxsOwogICAgICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZDogZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpICIgKyAoImJ1dCBnb3Q6ICIgKyAodHlwZSA9PSBudWxsID8gdHlwZSA6IHR5cGVvZiB0eXBlKSArICIuIiArIGluZm8pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50OSwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsMyhjaGlsZHJlbiwgY29udGFpbmVySW5mbywgaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgIHZhciBrZXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1szXSA6IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGFsbG93IHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBQb3J0YWwKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BPUlRBTF9UWVBFLAogICAgICAgICAgICBrZXk6IGtleSA9PSBudWxsID8gbnVsbCA6ICIiICsga2V5LAogICAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgICAgY29udGFpbmVySW5mbywKICAgICAgICAgICAgaW1wbGVtZW50YXRpb24KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZSA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgIGlmICghcGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICB2YXIgcGFyZW50Q29udGV4dCA9IGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKTsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSBmaWJlci50eXBlOwogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCBDb21wb25lbnQsIHBhcmVudENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhXYXJuaW5nKGNvbXBvbmVudCwgbWV0aG9kTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihob3N0RmliZXIpOwogICAgICAgICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgZGVwcmVjYXRlZCBpbiBTdHJpY3RNb2RlLiAlcyB3YXMgcGFzc2VkIGFuIGluc3RhbmNlIG9mICVzIHdoaWNoIGlzIGluc2lkZSBTdHJpY3RNb2RlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgZGVwcmVjYXRlZCBpbiBTdHJpY3RNb2RlLiAlcyB3YXMgcGFzc2VkIGFuIGluc3RhbmNlIG9mICVzIHdoaWNoIHJlbmRlcnMgU3RyaWN0TW9kZSBjaGlsZHJlbi4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIiwgbWV0aG9kTmFtZSwgbWV0aG9kTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZpb3VzRmliZXIpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciBoeWRyYXRlMiA9IGZhbHNlOwogICAgICAgICAgdmFyIGluaXRpYWxDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIGNhbGxiYWNrLCBjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciBoeWRyYXRlMiA9IHRydWU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHJvb3QzLmNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShudWxsKTsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50NCk7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsID8gY2FsbGJhY2sgOiBudWxsOwogICAgICAgICAgZW5xdWV1ZVVwZGF0ZShjdXJyZW50NCwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIGNvbnRhaW5lcjIsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgb25TY2hlZHVsZVJvb3QoY29udGFpbmVyMiwgZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudCQxID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoY3VycmVudCQxKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0ID0gZ2V0Q29udGV4dEZvclN1YnRyZWUocGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChjb250YWluZXIyLmNvbnRleHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGVuZGluZ0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNSZW5kZXJpbmcgJiYgY3VycmVudDMgIT09IG51bGwgJiYgIWRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGU7IHRyaWdnZXJpbmcgbmVzdGVkIGNvbXBvbmVudCB1cGRhdGVzIGZyb20gcmVuZGVyIGlzIG5vdCBhbGxvd2VkLiBJZiBuZWNlc3NhcnksIHRyaWdnZXIgbmVzdGVkIHVwZGF0ZXMgaW4gY29tcG9uZW50RGlkVXBkYXRlLlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiAlcy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQzKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIGluZGV4MikgewogICAgICAgICAgICB2YXIga2V5ID0gcGF0aDJbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gcGF0aDIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgyLCBpbmRleDIgKyAxKTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlID0gZnVuY3Rpb24ob2JqLCBwYXRoMikgewogICAgICAgICAgICByZXR1cm4gY29weVdpdGhEZWxldGVJbXBsKG9iaiwgcGF0aDIsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBvbGRQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBuZXdLZXkgPSBuZXdQYXRoW2luZGV4Ml07CiAgICAgICAgICAgICAgdXBkYXRlZFtuZXdLZXldID0gdXBkYXRlZFtvbGRLZXldOwogICAgICAgICAgICAgIGlmIChpc0FycmF5Mih1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybjMoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyBvZiB0aGUgc2FtZSBsZW5ndGgiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdQYXRoLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG9sZFBhdGhbaV0gIT09IG5ld1BhdGhbaV0pIHsKICAgICAgICAgICAgICAgICAgd2FybjMoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyB0byBiZSB0aGUgc2FtZSBleGNlcHQgZm9yIHRoZSBkZWVwZXN0IGtleSIpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFJlbmFtZUltcGwob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXRJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgaW5kZXgyLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaW5kZXgyID49IHBhdGgyLmxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5ID0gcGF0aDJbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aFNldEltcGwob2JqW2tleV0sIHBhdGgyLCBpbmRleDIgKyAxLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFNldEltcGwob2JqLCBwYXRoMiwgMCwgdmFsdWUpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSG9vayA9IGZ1bmN0aW9uKGZpYmVyLCBpZCkgewogICAgICAgICAgICB2YXIgY3VycmVudEhvb2syID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRIb29rMiAhPT0gbnVsbCAmJiBpZCA+IDApIHsKICAgICAgICAgICAgICBjdXJyZW50SG9vazIgPSBjdXJyZW50SG9vazIubmV4dDsKICAgICAgICAgICAgICBpZC0tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50SG9vazI7CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUgPSBmdW5jdGlvbihmaWJlciwgaWQsIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhTZXQoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoMiwgdmFsdWUpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIHBhdGgyKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aERlbGV0ZShob29rLm1lbW9pemVkU3RhdGUsIHBhdGgyKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aFJlbmFtZShob29rLm1lbW9pemVkU3RhdGUsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzID0gZnVuY3Rpb24oZmliZXIsIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFNldChmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoMiwgdmFsdWUpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIHBhdGgyKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoRGVsZXRlKGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgyKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoUmVuYW1lKGZpYmVyLm1lbW9pemVkUHJvcHMsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNjaGVkdWxlVXBkYXRlID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzZXRFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRFcnJvckltcGwpIHsKICAgICAgICAgICAgc2hvdWxkRXJyb3JJbXBsID0gbmV3U2hvdWxkRXJyb3JJbXBsOwogICAgICAgICAgfTsKICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZFN1c3BlbmRJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZFN1c3BlbmRJbXBsID0gbmV3U2hvdWxkU3VzcGVuZEltcGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlQnlGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRvRGV2VG9vbHMoZGV2VG9vbHNDb25maWcpIHsKICAgICAgICAgIHZhciBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZSA9IGRldlRvb2xzQ29uZmlnLmZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOwogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICAgIHJldHVybiBpbmplY3RJbnRlcm5hbHMoewogICAgICAgICAgICBidW5kbGVUeXBlOiBkZXZUb29sc0NvbmZpZy5idW5kbGVUeXBlLAogICAgICAgICAgICB2ZXJzaW9uOiBkZXZUb29sc0NvbmZpZy52ZXJzaW9uLAogICAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlclBhY2thZ2VOYW1lLAogICAgICAgICAgICByZW5kZXJlckNvbmZpZzogZGV2VG9vbHNDb25maWcucmVuZGVyZXJDb25maWcsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wcywKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoLAogICAgICAgICAgICBzZXRFcnJvckhhbmRsZXIsCiAgICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciwKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGUsCiAgICAgICAgICAgIGN1cnJlbnREaXNwYXRjaGVyUmVmOiBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiwKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIsCiAgICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZSB8fCBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlLAogICAgICAgICAgICAvLyBSZWFjdCBSZWZyZXNoCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJvb3QsCiAgICAgICAgICAgIHNldFJlZnJlc2hIYW5kbGVyLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGFwcGVuZCBvd25lciBzdGFja3MgdG8gZXJyb3IgbWVzc2FnZXMgaW4gREVWIG1vZGUuCiAgICAgICAgICAgIGdldEN1cnJlbnRGaWJlcjogZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gZGV0ZWN0IHJlY29uY2lsZXIgdmVyc2lvbiByYXRoZXIgdGhhbiByZW5kZXJlciB2ZXJzaW9uCiAgICAgICAgICAgIC8vIHdoaWNoIG1heSBub3QgbWF0Y2ggZm9yIHRoaXJkIHBhcnR5IHJlbmRlcmVycy4KICAgICAgICAgICAgcmVjb25jaWxlclZlcnNpb246IFJlYWN0VmVyc2lvbgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yID0gdHlwZW9mIHJlcG9ydEVycm9yID09PSAiZnVuY3Rpb24iID8gKAogICAgICAgICAgLy8gSW4gbW9kZXJuIGJyb3dzZXJzLCByZXBvcnRFcnJvciB3aWxsIGRpc3BhdGNoIGFuIGVycm9yIGV2ZW50LAogICAgICAgICAgLy8gZW11bGF0aW5nIGFuIHVuY2F1Z2h0IEphdmFTY3JpcHQgZXJyb3IuCiAgICAgICAgICByZXBvcnRFcnJvcgogICAgICAgICkgOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIFJlYWN0RE9NUm9vdChpbnRlcm5hbFJvb3QpIHsKICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IGludGVybmFsUm9vdDsKICAgICAgICB9CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBSZWFjdERPTVJvb3QucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSB0aGlzLl9pbnRlcm5hbFJvb3Q7CiAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgdXBkYXRlIGFuIHVubW91bnRlZCByb290LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkQ29udGFpbmVyKGFyZ3VtZW50c1sxXSkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIGNvbnRhaW5lciB0byB0aGUgc2Vjb25kIGFyZ3VtZW50IG9mIHJvb3QucmVuZGVyKC4uLikuIFlvdSBkb24ndCBuZWVkIHRvIHBhc3MgaXQgYWdhaW4gc2luY2UgeW91IGFscmVhZHkgcGFzc2VkIGl0IHRvIGNyZWF0ZSB0aGUgcm9vdC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgc2Vjb25kIGFyZ3VtZW50IHRvIHJvb3QucmVuZGVyKC4uLikgYnV0IGl0IG9ubHkgYWNjZXB0cyBvbmUgYXJndW1lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSByb290My5jb250YWluZXJJbmZvOwogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKHJvb3QzLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyMikgewogICAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEl0IGxvb2tzIGxpa2UgdGhlIFJlYWN0LXJlbmRlcmVkIGNvbnRlbnQgb2YgdGhlIHJvb3QgY29udGFpbmVyIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcgUmVhY3QuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBjYXVzZSBlcnJvcnMuIEluc3RlYWQsIGNhbGwgcm9vdC51bm1vdW50KCkgdG8gZW1wdHkgYSByb290J3MgY29udGFpbmVyLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgfTsKICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnVubW91bnQgPSBSZWFjdERPTVJvb3QucHJvdG90eXBlLnVubW91bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudCguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IGEgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSB0aGlzLl9pbnRlcm5hbFJvb3Q7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gbnVsbDsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSByb290My5jb250YWluZXJJbmZvOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzQWxyZWFkeVJlbmRlcmluZygpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQXR0ZW1wdGVkIHRvIHN5bmNocm9ub3VzbHkgdW5tb3VudCBhIHJvb3Qgd2hpbGUgUmVhY3Qgd2FzIGFscmVhZHkgcmVuZGVyaW5nLiBSZWFjdCBjYW5ub3QgZmluaXNoIHVubW91bnRpbmcgdGhlIHJvb3QgdW50aWwgdGhlIGN1cnJlbnQgcmVuZGVyIGhhcyBjb21wbGV0ZWQsIHdoaWNoIG1heSBsZWFkIHRvIGEgcmFjZSBjb25kaXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIobnVsbCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdDIoY29udGFpbmVyMiwgb3B0aW9uczIpIHsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNyZWF0ZVJvb3QoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25DYWxsYmFja3MgPSBudWxsOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMi5oeWRyYXRlKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiaHlkcmF0ZSB0aHJvdWdoIGNyZWF0ZVJvb3QgaXMgZGVwcmVjYXRlZC4gVXNlIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zMiA9PT0gIm9iamVjdCIgJiYgb3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIEpTWCBlbGVtZW50IHRvIGNyZWF0ZVJvb3QuIFlvdSBwcm9iYWJseSBtZWFudCB0byBjYWxsIHJvb3QucmVuZGVyIGluc3RlYWQuIEV4YW1wbGUgdXNhZ2U6XG5cbiAgbGV0IHJvb3QgPSBjcmVhdGVSb290KGRvbUNvbnRhaW5lcik7XG4gIHJvb3QucmVuZGVyKDxBcHAgLz4pOyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIudW5zdGFibGVfc3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlzU3RyaWN0TW9kZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXggIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXggPSBvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvciA9IG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIudHJhbnNpdGlvbkNhbGxiYWNrcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXIyLCBDb25jdXJyZW50Um9vdCwgbnVsbCwgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgIHZhciByb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFJlYWN0RE9NSHlkcmF0aW9uUm9vdChpbnRlcm5hbFJvb3QpIHsKICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IGludGVybmFsUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVIeWRyYXRpb24odGFyZ2V0KSB7CiAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bnN0YWJsZV9zY2hlZHVsZUh5ZHJhdGlvbiA9IHNjaGVkdWxlSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImh5ZHJhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5pdGlhbENoaWxkcmVuID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBlcnJvcigiTXVzdCBwcm92aWRlIGluaXRpYWwgY2hpbGRyZW4gYXMgc2Vjb25kIGFyZ3VtZW50IHRvIGh5ZHJhdGVSb290LiBFeGFtcGxlIHVzYWdlOiBoeWRyYXRlUm9vdChkb21Db250YWluZXIsIDxBcHAgLz4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoeWRyYXRpb25DYWxsYmFja3MgPSBvcHRpb25zMiAhPSBudWxsID8gb3B0aW9uczIgOiBudWxsOwogICAgICAgICAgdmFyIG11dGFibGVTb3VyY2VzID0gb3B0aW9uczIgIT0gbnVsbCAmJiBvcHRpb25zMi5oeWRyYXRlZFNvdXJjZXMgfHwgbnVsbDsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAob3B0aW9uczIudW5zdGFibGVfc3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlzU3RyaWN0TW9kZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXggIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXggPSBvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvciA9IG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgbnVsbCwgY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKGNvbnRhaW5lcjIpOwogICAgICAgICAgaWYgKG11dGFibGVTb3VyY2VzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbXV0YWJsZVNvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZSA9IG11dGFibGVTb3VyY2VzW2ldOwogICAgICAgICAgICAgIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgUmVhY3RET01IeWRyYXRpb25Sb290KHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZENvbnRhaW5lcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gISEobm9kZSAmJiAobm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfRlJBR01FTlRfTk9ERSB8fCAhZGlzYWJsZUNvbW1lbnRzQXNET01Db250YWluZXJzKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXJMZWdhY3kobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFICYmIG5vZGUubm9kZVZhbHVlID09PSAiIHJlYWN0LW1vdW50LXBvaW50LXVuc3RhYmxlICIpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgY29udGFpbmVyMi50YWdOYW1lICYmIGNvbnRhaW5lcjIudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiQk9EWSIpIHsKICAgICAgICAgICAgICBlcnJvcigiY3JlYXRlUm9vdCgpOiBDcmVhdGluZyByb290cyBkaXJlY3RseSB3aXRoIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSB1c2luZyBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSkgewogICAgICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NLnJlbmRlcigpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpIG9uIGEgY29udGFpbmVyIHRoYXQgaGFzIGFscmVhZHkgYmVlbiBwYXNzZWQgdG8gY3JlYXRlUm9vdCgpIGJlZm9yZS4gSW5zdGVhZCwgY2FsbCByb290LnJlbmRlcigpIG9uIHRoZSBleGlzdGluZyByb290IGluc3RlYWQgaWYgeW91IHdhbnQgdG8gdXBkYXRlIGl0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzOwogICAgICAgIHsKICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MgPSBmdW5jdGlvbihjb250YWluZXIyKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgJiYgY29udGFpbmVyMi5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lci5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoaXMgY29udGFpbmVyIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcgUmVhY3QuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBjYXVzZSBlcnJvcnMuIEluc3RlYWQsIGNhbGwgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSB0byBlbXB0eSBhIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QgPSAhIWNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgdmFyIHJvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEocm9vdEVsICYmIGdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKSk7CiAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCAmJiAhaXNSb290UmVuZGVyZWRCeVNvbWVSZWFjdCkgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogUmVwbGFjaW5nIFJlYWN0LXJlbmRlcmVkIGNoaWxkcmVuIHdpdGggYSBuZXcgcm9vdCBjb21wb25lbnQuIElmIHlvdSBpbnRlbmRlZCB0byB1cGRhdGUgdGhlIGNoaWxkcmVuIG9mIHRoaXMgbm9kZSwgeW91IHNob3VsZCBpbnN0ZWFkIGhhdmUgdGhlIGV4aXN0aW5nIGNoaWxkcmVuIHVwZGF0ZSB0aGVpciBzdGF0ZSBhbmQgcmVuZGVyIHRoZSBuZXcgY29tcG9uZW50cyBpbnN0ZWFkIG9mIGNhbGxpbmcgUmVhY3RET00ucmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgY29udGFpbmVyMi50YWdOYW1lICYmIGNvbnRhaW5lcjIudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiQk9EWSIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKCk6IFJlbmRlcmluZyBjb21wb25lbnRzIGRpcmVjdGx5IGludG8gZG9jdW1lbnQuYm9keSBpcyBkaXNjb3VyYWdlZCwgc2luY2UgaXRzIGNoaWxkcmVuIGFyZSBvZnRlbiBtYW5pcHVsYXRlZCBieSB0aGlyZC1wYXJ0eSBzY3JpcHRzIGFuZCBicm93c2VyIGV4dGVuc2lvbnMuIFRoaXMgbWF5IGxlYWQgdG8gc3VidGxlIHJlY29uY2lsaWF0aW9uIGlzc3Vlcy4gVHJ5IHJlbmRlcmluZyBpbnRvIGEgY29udGFpbmVyIGVsZW1lbnQgY3JlYXRlZCBmb3IgeW91ciBhcHAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICBpZiAoIWNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyMi5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub29wT25SZWNvdmVyYWJsZUVycm9yKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsZWdhY3lDcmVhdGVSb290RnJvbURPTUNvbnRhaW5lcihjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpb25Db250YWluZXIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKAogICAgICAgICAgICAgIGluaXRpYWxDaGlsZHJlbiwKICAgICAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgIExlZ2FjeVJvb3QsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBoeWRyYXRpb25DYWxsYmFja3MKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBpc1N0cmljdE1vZGUKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLAogICAgICAgICAgICAgICIiLAogICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJQcmVmaXgKICAgICAgICAgICAgICBub29wT25SZWNvdmVyYWJsZUVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IHJvb3QzOwogICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgIGZsdXNoU3luYygpOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChyb290U2libGluZyA9IGNvbnRhaW5lcjIubGFzdENoaWxkKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyMi5yZW1vdmVDaGlsZChyb290U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2UoX3Jvb3QpOwogICAgICAgICAgICAgICAgX29yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3Jvb3QgPSBjcmVhdGVDb250YWluZXIoCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBfcm9vdDsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChfcm9vdC5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIF9yb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKF9yb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBfcm9vdCwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gX3Jvb3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRDYWxsYmFjayQxKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiB0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsZXJOYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBjaGlsZHJlbiwgY29udGFpbmVyMiwgZm9yY2VIeWRyYXRlLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzKGNvbnRhaW5lcjIpOwogICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjayA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrLCAicmVuZGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVSb290ID0gY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgdmFyIHJvb3QzOwogICAgICAgICAgaWYgKCFtYXliZVJvb3QpIHsKICAgICAgICAgICAgcm9vdDMgPSBsZWdhY3lDcmVhdGVSb290RnJvbURPTUNvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaywgZm9yY2VIeWRyYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzID0gbWF5YmVSb290OwogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgICAgICAgIG9yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZERPTU5vZGUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5kRE9NTm9kZShjb21wb25lbnRPckVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiZmluZERPTU5vZGUgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyJDMuY3VycmVudDsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIG93bmVyLnN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXI7CiAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBmaW5kRE9NTm9kZSBpbnNpZGUgaXRzIHJlbmRlcigpLiByZW5kZXIoKSBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4gSXQgc2hvdWxkIG5ldmVyIGFjY2VzcyBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzdGFsZSBkYXRhIGZyb20gdGhlIHByZXZpb3VzIHJlbmRlciwgc3VjaCBhcyByZWZzLiBNb3ZlIHRoaXMgbG9naWMgdG8gY29tcG9uZW50RGlkTW91bnQgYW5kIGNvbXBvbmVudERpZFVwZGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShvd25lci50eXBlKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb3duZXIuc3RhdGVOb2RlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21wb25lbnRPckVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21wb25lbnRPckVsZW1lbnQubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gY29tcG9uZW50T3JFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmluZEhvc3RJbnN0YW5jZVdpdGhXYXJuaW5nKGNvbXBvbmVudE9yRWxlbWVudCwgImZpbmRET01Ob2RlIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGUoZWxlbWVudCwgY29udGFpbmVyMiwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLmh5ZHJhdGUgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gVXNlIGh5ZHJhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLmh5ZHJhdGUoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgaHlkcmF0ZVJvb3QoY29udGFpbmVyLCBlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIHRydWUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5yZW5kZXIgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gVXNlIGNyZWF0ZVJvb3QgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgbmV3IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00ucmVuZGVyKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QucmVuZGVyKGVsZW1lbnQpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyMiwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00udW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIoKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBDb25zaWRlciB1c2luZyBhIHBvcnRhbCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50Q29tcG9uZW50ID09IG51bGwgfHwgIWhhczMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwzKGNoaWxkcmVuLCBjb250YWluZXIyLCBudWxsLCBrZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHZhciBJbnRlcm5hbHMgPSB7CiAgICAgICAgICB1c2luZ0NsaWVudEVudHJ5UG9pbnQ6IGZhbHNlLAogICAgICAgICAgLy8gS2VlcCBpbiBzeW5jIHdpdGggUmVhY3RUZXN0VXRpbHMuanMuCiAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IGZvciBiZXR0ZXIgbWluaWZpY2F0aW9uLgogICAgICAgICAgRXZlbnRzOiBbZ2V0SW5zdGFuY2VGcm9tTm9kZSwgZ2V0Tm9kZUZyb21JbnN0YW5jZSwgZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZSwgZW5xdWV1ZVN0YXRlUmVzdG9yZSwgcmVzdG9yZVN0YXRlSWZOZWVkZWQsIGJhdGNoZWRVcGRhdGVzJDFdCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290JDEoY29udGFpbmVyMiwgb3B0aW9uczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJbnRlcm5hbHMudXNpbmdDbGllbnRFbnRyeVBvaW50ICYmIHRydWUpIHsKICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgY3JlYXRlUm9vdCBmcm9tICJyZWFjdC1kb20iIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFlvdSBzaG91bGQgaW5zdGVhZCBpbXBvcnQgaXQgZnJvbSAicmVhY3QtZG9tL2NsaWVudCIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVSb290JDEoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBoeWRyYXRlUm9vdCBmcm9tICJyZWFjdC1kb20iIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFlvdSBzaG91bGQgaW5zdGVhZCBpbXBvcnQgaXQgZnJvbSAicmVhY3QtZG9tL2NsaWVudCIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jJDEoZm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQWxyZWFkeVJlbmRlcmluZygpKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZsdXNoU3luYyB3YXMgY2FsbGVkIGZyb20gaW5zaWRlIGEgbGlmZWN5Y2xlIG1ldGhvZC4gUmVhY3QgY2Fubm90IGZsdXNoIHdoZW4gUmVhY3QgaXMgYWxyZWFkeSByZW5kZXJpbmcuIENvbnNpZGVyIG1vdmluZyB0aGlzIGNhbGwgdG8gYSBzY2hlZHVsZXIgdGFzayBvciBtaWNybyB0YXNrLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmx1c2hTeW5jKGZuKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZvdW5kRGV2VG9vbHMgPSBpbmplY3RJbnRvRGV2VG9vbHMoewogICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlLAogICAgICAgICAgYnVuZGxlVHlwZTogMSwKICAgICAgICAgIHZlcnNpb246IFJlYWN0VmVyc2lvbiwKICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6ICJyZWFjdC1kb20iCiAgICAgICAgfSk7CiAgICAgICAgewogICAgICAgICAgaWYgKCFmb3VuZERldlRvb2xzICYmIGNhblVzZURPTTIgJiYgd2luZG93LnRvcCA9PT0gd2luZG93LnNlbGYpIHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgPiAtMSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkVkZ2UiKSA9PT0gLTEgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgPiAtMSkgewogICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbDsKICAgICAgICAgICAgICBpZiAoL14oaHR0cHM/fGZpbGUpOiQvLnRlc3QocHJvdG9jb2wpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oIiVjRG93bmxvYWQgdGhlIFJlYWN0IERldlRvb2xzIGZvciBhIGJldHRlciBkZXZlbG9wbWVudCBleHBlcmllbmNlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMiICsgKHByb3RvY29sID09PSAiZmlsZToiID8gIlxuWW91IG1pZ2h0IG5lZWQgdG8gdXNlIGEgbG9jYWwgSFRUUCBzZXJ2ZXIgKGluc3RlYWQgb2YgZmlsZTovLyk6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scy1mYXEiIDogIiIpLCAiZm9udC13ZWlnaHQ6Ym9sZCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHBvcnRzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUG9ydGFsID0gY3JlYXRlUG9ydGFsJDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gY3JlYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMuZmluZERPTU5vZGUgPSBmaW5kRE9NTm9kZTsKICAgICAgICBleHBvcnRzLmZsdXNoU3luYyA9IGZsdXNoU3luYyQxOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZSA9IGh5ZHJhdGU7CiAgICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGh5ZHJhdGVSb290JDE7CiAgICAgICAgZXhwb3J0cy5yZW5kZXIgPSByZW5kZXI7CiAgICAgICAgZXhwb3J0cy51bm1vdW50Q29tcG9uZW50QXROb2RlID0gdW5tb3VudENvbXBvbmVudEF0Tm9kZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2JhdGNoZWRVcGRhdGVzID0gYmF0Y2hlZFVwZGF0ZXMkMTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyID0gcmVuZGVyU3VidHJlZUludG9Db250YWluZXI7CiAgICAgICAgZXhwb3J0cy52ZXJzaW9uID0gUmVhY3RWZXJzaW9uOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb20gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgY2hlY2tEQ0UoKTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcwp2YXIgcmVxdWlyZV9jbGllbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBtID0gcmVxdWlyZV9yZWFjdF9kb20oKTsKICAgIGlmIChmYWxzZSkgewogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBtLmNyZWF0ZVJvb3Q7CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBtLmh5ZHJhdGVSb290OwogICAgfSBlbHNlIHsKICAgICAgaSA9IG0uX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmNyZWF0ZVJvb3QoYywgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gZnVuY3Rpb24oYywgaCwgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uaHlkcmF0ZVJvb3QoYywgaCwgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdmFyIGk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L19pbnRlcm5hbC9pc1Vuc2FmZVByb3BlcnR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVW5zYWZlUHJvcGVydHkoa2V5KSB7CiAgICAgIHJldHVybiBrZXkgPT09ICJfX3Byb3RvX18iOwogICAgfQogICAgZXhwb3J0cy5pc1Vuc2FmZVByb3BlcnR5ID0gaXNVbnNhZmVQcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcwp2YXIgcmVxdWlyZV9pc0RlZXBLZXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0RlZXBLZXkoa2V5KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4ga2V5LmluY2x1ZGVzKCIuIikgfHwga2V5LmluY2x1ZGVzKCJbIikgfHwga2V5LmluY2x1ZGVzKCJdIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzRGVlcEtleSA9IGlzRGVlcEtleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvS2V5LmpzCnZhciByZXF1aXJlX3RvS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0tleSh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuaXModmFsdWU/LnZhbHVlT2Y/LigpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9LZXkgPSB0b0tleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcwp2YXIgcmVxdWlyZV90b1N0cmluZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvU3RyaW5nLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiB2YWx1ZS5tYXAodG9TdHJpbmcpLmpvaW4oIiwiKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBTdHJpbmcodmFsdWUpOwogICAgICBpZiAocmVzdWx0ID09PSAiMCIgJiYgT2JqZWN0LmlzKE51bWJlcih2YWx1ZSksIC0wKSkgewogICAgICAgIHJldHVybiAiLTAiOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnRvU3RyaW5nID0gdG9TdHJpbmc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9QYXRoLmpzCnZhciByZXF1aXJlX3RvUGF0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdG9TdHJpbmcgPSByZXF1aXJlX3RvU3RyaW5nKCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICBmdW5jdGlvbiB0b1BhdGgoZGVlcEtleSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZWVwS2V5KSkgewogICAgICAgIHJldHVybiBkZWVwS2V5Lm1hcCh0b0tleS50b0tleSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWVwS2V5ID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiBbZGVlcEtleV07CiAgICAgIH0KICAgICAgZGVlcEtleSA9IHRvU3RyaW5nLnRvU3RyaW5nKGRlZXBLZXkpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZGVlcEtleS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBrZXkgPSAiIjsKICAgICAgbGV0IHF1b3RlQ2hhciA9ICIiOwogICAgICBsZXQgYnJhY2tldCA9IGZhbHNlOwogICAgICBpZiAoZGVlcEtleS5jaGFyQ29kZUF0KDApID09PSA0NikgewogICAgICAgIHJlc3VsdC5wdXNoKCIiKTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNoYXIgPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICBpZiAocXVvdGVDaGFyKSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlxcIiAmJiBpbmRleCArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAga2V5ICs9IGRlZXBLZXlbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBxdW90ZUNoYXIpIHsKICAgICAgICAgICAgcXVvdGVDaGFyID0gIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgKz0gY2hhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGJyYWNrZXQpIHsKICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9IGNoYXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICJdIikgewogICAgICAgICAgICBicmFja2V0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IHRydWU7CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIuIikgewogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgICAgaWYgKGtleSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9QYXRoID0gdG9QYXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzCnZhciByZXF1aXJlX2dldCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1Vuc2FmZVByb3BlcnR5ID0gcmVxdWlyZV9pc1Vuc2FmZVByb3BlcnR5KCk7CiAgICB2YXIgaXNEZWVwS2V5ID0gcmVxdWlyZV9pc0RlZXBLZXkoKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gZ2V0NShvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKG9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBwYXRoMikgewogICAgICAgIGNhc2UgInN0cmluZyI6IHsKICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSkgewogICAgICAgICAgICAgIHJldHVybiBnZXQ1KG9iamVjdCwgdG9QYXRoLnRvUGF0aChwYXRoMiksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICBjYXNlICJzeW1ib2wiOiB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhdGgyID09PSAibnVtYmVyIikgewogICAgICAgICAgICBwYXRoMiA9IHRvS2V5LnRvS2V5KHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3QuaXMocGF0aDI/LnZhbHVlT2YoKSwgLTApKSB7CiAgICAgICAgICAgIHBhdGgyID0gIi0wIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhdGgyID0gU3RyaW5nKHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmIChwYXRoMi5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGgyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGlmIChjdXJyZW50MyA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyW2luZGV4XSkpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNbcGF0aDJbaW5kZXhdXTsKICAgICAgfQogICAgICBpZiAoY3VycmVudDMgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgfQogICAgZXhwb3J0cy5nZXQgPSBnZXQ1OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzCnZhciByZXF1aXJlX2dldDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2dldC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfZ2V0KCkuZ2V0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnIsIG1hcHBlcikgewogICAgICBjb25zdCBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gYXJyW2ldOwogICAgICAgIGNvbnN0IGtleSA9IG1hcHBlcihpdGVtKTsKICAgICAgICBpZiAoIW1hcDMuaGFzKGtleSkpIHsKICAgICAgICAgIG1hcDMuc2V0KGtleSwgaXRlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcDMudmFsdWVzKCkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2lkZW50aXR5LmpzCnZhciByZXF1aXJlX2lkZW50aXR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vaWRlbnRpdHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaWRlbnRpdHk0KHgyKSB7CiAgICAgIHJldHVybiB4MjsKICAgIH0KICAgIGV4cG9ydHMuaWRlbnRpdHkgPSBpZGVudGl0eTQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzCnZhciByZXF1aXJlX2lzTGVuZ3RoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzTGVuZ3RoKHZhbHVlKSB7CiAgICAgIHJldHVybiBOdW1iZXIuaXNTYWZlSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMDsKICAgIH0KICAgIGV4cG9ydHMuaXNMZW5ndGggPSBpc0xlbmd0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlLmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNMZW5ndGggPSByZXF1aXJlX2lzTGVuZ3RoKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIgJiYgaXNMZW5ndGguaXNMZW5ndGgodmFsdWUubGVuZ3RoKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2UgPSBpc0FycmF5TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcwp2YXIgcmVxdWlyZV9pc09iamVjdExpa2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdExpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGw7CiAgICB9CiAgICBleHBvcnRzLmlzT2JqZWN0TGlrZSA9IGlzT2JqZWN0TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZU9iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3RMaWtlID0gcmVxdWlyZV9pc09iamVjdExpa2UoKTsKICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UuaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBpc0FycmF5TGlrZS5pc0FycmF5TGlrZSh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlT2JqZWN0ID0gaXNBcnJheUxpa2VPYmplY3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9wcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9wcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldDUgPSByZXF1aXJlX2dldCgpOwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aDIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBnZXQ1LmdldChvYmplY3QsIHBhdGgyKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucHJvcGVydHkgPSBwcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMKdmFyIHJlcXVpcmVfaXNQcmltaXRpdmUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNQcmltaXRpdmUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiI7CiAgICB9CiAgICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMKdmFyIHJlcXVpcmVfZXEgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBlcSh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihvdGhlcik7CiAgICB9CiAgICBleHBvcnRzLmVxID0gZXE7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoV2l0aC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGlzUHJpbWl0aXZlID0gcmVxdWlyZV9pc1ByaW1pdGl2ZSgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUpIHsKICAgICAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgICB9CiAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBmdW5jdGlvbiBkb2VzTWF0Y2gob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlMiwgc3RhY2spIHsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZShvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIEJvb2xlYW4oaXNFcXVhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKG9ialZhbHVlLCBzcmNWYWx1ZSwgZG9lc01hdGNoLCBzdGFjayk7CiAgICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgfQogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PT0gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygc291cmNlKSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgICAgICBjb25zdCBzb3VyY2VLZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgICAgIGlmIChzb3VyY2VLZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCB7IC4uLnNvdXJjZSB9LCBjb21wYXJlLCBzdGFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KHRhcmdldCkpIHsKICAgICAgICAgICAgcmV0dXJuIGVxLmVxKHRhcmdldCwgc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gc291cmNlID09PSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc291cmNlKSkgewogICAgICAgIHJldHVybiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgcmV0dXJuIGlzTWFwTWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgcmV0dXJuIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgaWYgKHRhcmdldCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGtleXMubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChzdGFjaz8uaGFzKHNvdXJjZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHNvdXJjZSkgPT09IHRhcmdldDsKICAgICAgfQogICAgICBzdGFjaz8uc2V0KHNvdXJjZSwgdGFyZ2V0KTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICBpZiAoIWlzUHJpbWl0aXZlLmlzUHJpbWl0aXZlKHRhcmdldCkgJiYgIShrZXkgaW4gdGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlW2tleV0gPT09IHZvaWQgMCAmJiB0YXJnZXRba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gbnVsbCAmJiB0YXJnZXRba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRba2V5XSwgc291cmNlW2tleV0sIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIGlmICghaXNFcXVhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHN0YWNrPy5kZWxldGUoc291cmNlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgTWFwKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IFtrZXksIHNvdXJjZVZhbHVlXSBvZiBzb3VyY2UuZW50cmllcygpKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0YXJnZXQuZ2V0KGtleSk7CiAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0VmFsdWUsIHNvdXJjZVZhbHVlLCBrZXksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gaXNBcnJheU1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ZWRJbmRleCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc291cmNlSXRlbSA9IHNvdXJjZVtpXTsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRhcmdldC5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGNvdW50ZWRJbmRleC5oYXMoaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGFyZ2V0W2pdOwogICAgICAgICAgbGV0IG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRJdGVtLCBzb3VyY2VJdGVtLCBpLCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKGlzRXF1YWwpIHsKICAgICAgICAgICAgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoZXMyKSB7CiAgICAgICAgICAgIGNvdW50ZWRJbmRleC5hZGQoaik7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NldE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBTZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBpc0FycmF5TWF0Y2goWy4uLnRhcmdldF0sIFsuLi5zb3VyY2VdLCBjb21wYXJlLCBzdGFjayk7CiAgICB9CiAgICBleHBvcnRzLmlzTWF0Y2hXaXRoID0gaXNNYXRjaFdpdGg7CiAgICBleHBvcnRzLmlzU2V0TWF0Y2ggPSBpc1NldE1hdGNoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc01hdGNoV2l0aCA9IHJlcXVpcmVfaXNNYXRjaFdpdGgoKTsKICAgIGZ1bmN0aW9uIGlzTWF0Y2godGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoLmlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5pc01hdGNoID0gaXNNYXRjaDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMKdmFyIHJlcXVpcmVfZ2V0U3ltYm9scyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRTeW1ib2xzKG9iamVjdCkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpLmZpbHRlcigoc3ltYm9sKSA9PiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCBzeW1ib2wpKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3ltYm9scyA9IGdldFN5bWJvbHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMKdmFyIHJlcXVpcmVfZ2V0VGFnID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0VGFnKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB2b2lkIDAgPyAiW29iamVjdCBVbmRlZmluZWRdIiA6ICJbb2JqZWN0IE51bGxdIjsKICAgICAgfQogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0VGFnID0gZ2V0VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcwp2YXIgcmVxdWlyZV90YWdzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90YWdzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciByZWdleHBUYWcgPSAiW29iamVjdCBSZWdFeHBdIjsKICAgIHZhciBzdHJpbmdUYWcgPSAiW29iamVjdCBTdHJpbmddIjsKICAgIHZhciBudW1iZXJUYWcgPSAiW29iamVjdCBOdW1iZXJdIjsKICAgIHZhciBib29sZWFuVGFnID0gIltvYmplY3QgQm9vbGVhbl0iOwogICAgdmFyIGFyZ3VtZW50c1RhZyA9ICJbb2JqZWN0IEFyZ3VtZW50c10iOwogICAgdmFyIHN5bWJvbFRhZyA9ICJbb2JqZWN0IFN5bWJvbF0iOwogICAgdmFyIGRhdGVUYWcgPSAiW29iamVjdCBEYXRlXSI7CiAgICB2YXIgbWFwVGFnID0gIltvYmplY3QgTWFwXSI7CiAgICB2YXIgc2V0VGFnID0gIltvYmplY3QgU2V0XSI7CiAgICB2YXIgYXJyYXlUYWcgPSAiW29iamVjdCBBcnJheV0iOwogICAgdmFyIGZ1bmN0aW9uVGFnID0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgIHZhciBhcnJheUJ1ZmZlclRhZyA9ICJbb2JqZWN0IEFycmF5QnVmZmVyXSI7CiAgICB2YXIgb2JqZWN0VGFnID0gIltvYmplY3QgT2JqZWN0XSI7CiAgICB2YXIgZXJyb3JUYWcgPSAiW29iamVjdCBFcnJvcl0iOwogICAgdmFyIGRhdGFWaWV3VGFnID0gIltvYmplY3QgRGF0YVZpZXddIjsKICAgIHZhciB1aW50OEFycmF5VGFnID0gIltvYmplY3QgVWludDhBcnJheV0iOwogICAgdmFyIHVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gIltvYmplY3QgVWludDhDbGFtcGVkQXJyYXldIjsKICAgIHZhciB1aW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQxNkFycmF5XSI7CiAgICB2YXIgdWludDMyQXJyYXlUYWcgPSAiW29iamVjdCBVaW50MzJBcnJheV0iOwogICAgdmFyIGJpZ1VpbnQ2NEFycmF5VGFnID0gIltvYmplY3QgQmlnVWludDY0QXJyYXldIjsKICAgIHZhciBpbnQ4QXJyYXlUYWcgPSAiW29iamVjdCBJbnQ4QXJyYXldIjsKICAgIHZhciBpbnQxNkFycmF5VGFnID0gIltvYmplY3QgSW50MTZBcnJheV0iOwogICAgdmFyIGludDMyQXJyYXlUYWcgPSAiW29iamVjdCBJbnQzMkFycmF5XSI7CiAgICB2YXIgYmlnSW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ0ludDY0QXJyYXldIjsKICAgIHZhciBmbG9hdDMyQXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDMyQXJyYXldIjsKICAgIHZhciBmbG9hdDY0QXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDY0QXJyYXldIjsKICAgIGV4cG9ydHMuYXJndW1lbnRzVGFnID0gYXJndW1lbnRzVGFnOwogICAgZXhwb3J0cy5hcnJheUJ1ZmZlclRhZyA9IGFycmF5QnVmZmVyVGFnOwogICAgZXhwb3J0cy5hcnJheVRhZyA9IGFycmF5VGFnOwogICAgZXhwb3J0cy5iaWdJbnQ2NEFycmF5VGFnID0gYmlnSW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnVWludDY0QXJyYXlUYWcgPSBiaWdVaW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYm9vbGVhblRhZyA9IGJvb2xlYW5UYWc7CiAgICBleHBvcnRzLmRhdGFWaWV3VGFnID0gZGF0YVZpZXdUYWc7CiAgICBleHBvcnRzLmRhdGVUYWcgPSBkYXRlVGFnOwogICAgZXhwb3J0cy5lcnJvclRhZyA9IGVycm9yVGFnOwogICAgZXhwb3J0cy5mbG9hdDMyQXJyYXlUYWcgPSBmbG9hdDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLmZsb2F0NjRBcnJheVRhZyA9IGZsb2F0NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuZnVuY3Rpb25UYWcgPSBmdW5jdGlvblRhZzsKICAgIGV4cG9ydHMuaW50MTZBcnJheVRhZyA9IGludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLmludDMyQXJyYXlUYWcgPSBpbnQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQ4QXJyYXlUYWcgPSBpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLm1hcFRhZyA9IG1hcFRhZzsKICAgIGV4cG9ydHMubnVtYmVyVGFnID0gbnVtYmVyVGFnOwogICAgZXhwb3J0cy5vYmplY3RUYWcgPSBvYmplY3RUYWc7CiAgICBleHBvcnRzLnJlZ2V4cFRhZyA9IHJlZ2V4cFRhZzsKICAgIGV4cG9ydHMuc2V0VGFnID0gc2V0VGFnOwogICAgZXhwb3J0cy5zdHJpbmdUYWcgPSBzdHJpbmdUYWc7CiAgICBleHBvcnRzLnN5bWJvbFRhZyA9IHN5bWJvbFRhZzsKICAgIGV4cG9ydHMudWludDE2QXJyYXlUYWcgPSB1aW50MTZBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDMyQXJyYXlUYWcgPSB1aW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDhBcnJheVRhZyA9IHVpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gdWludDhDbGFtcGVkQXJyYXlUYWc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcwp2YXIgcmVxdWlyZV9pc1R5cGVkQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVHlwZWRBcnJheSh4MikgewogICAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwogICAgfQogICAgZXhwb3J0cy5pc1R5cGVkQXJyYXkgPSBpc1R5cGVkQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXRTeW1ib2xzID0gcmVxdWlyZV9nZXRTeW1ib2xzKCk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgaXNUeXBlZEFycmF5ID0gcmVxdWlyZV9pc1R5cGVkQXJyYXkoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGgob2JqLCBjbG9uZVZhbHVlKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlID0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVmFsdWU/Lih2YWx1ZVRvQ2xvbmUsIGtleVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrKTsKICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGNsb25lZDsKICAgICAgfQogICAgICBpZiAoaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrLmhhcyh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrLmdldCh2YWx1ZVRvQ2xvbmUpOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChPYmplY3QuaGFzT3duKHZhbHVlVG9DbG9uZSwgImluZGV4IikpIHsKICAgICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlVG9DbG9uZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5wdXQiKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWVUb0Nsb25lLmlucHV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlVG9DbG9uZS5nZXRUaW1lKCkpOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgUmVnRXhwKHZhbHVlVG9DbG9uZS5zb3VyY2UsIHZhbHVlVG9DbG9uZS5mbGFncyk7CiAgICAgICAgcmVzdWx0Lmxhc3RJbmRleCA9IHZhbHVlVG9DbG9uZS5sYXN0SW5kZXg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LnNldChrZXksIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFNldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LmFkZChjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZSwgdm9pZCAwLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiBCdWZmZXIuaXNCdWZmZXIodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc3ViYXJyYXkoKTsKICAgICAgfQogICAgICBpZiAoaXNUeXBlZEFycmF5LmlzVHlwZWRBcnJheSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IChPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSkuY29uc3RydWN0b3IodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2hhcmVkQXJyYXlCdWZmZXIpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lLnNsaWNlKDApOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRhVmlldykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBEYXRhVmlldyh2YWx1ZVRvQ2xvbmUuYnVmZmVyLnNsaWNlKDApLCB2YWx1ZVRvQ2xvbmUuYnl0ZU9mZnNldCwgdmFsdWVUb0Nsb25lLmJ5dGVMZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgRmlsZSAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRmlsZSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBGaWxlKFt2YWx1ZVRvQ2xvbmVdLCB2YWx1ZVRvQ2xvbmUubmFtZSwgewogICAgICAgICAgdHlwZTogdmFsdWVUb0Nsb25lLnR5cGUKICAgICAgICB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQmxvYihbdmFsdWVUb0Nsb25lXSwgeyB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZSB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgdmFsdWVUb0Nsb25lLmNvbnN0cnVjdG9yKCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICByZXN1bHQubWVzc2FnZSA9IHZhbHVlVG9DbG9uZS5tZXNzYWdlOwogICAgICAgIHJlc3VsdC5uYW1lID0gdmFsdWVUb0Nsb25lLm5hbWU7CiAgICAgICAgcmVzdWx0LnN0YWNrID0gdmFsdWVUb0Nsb25lLnN0YWNrOwogICAgICAgIHJlc3VsdC5jYXVzZSA9IHZhbHVlVG9DbG9uZS5jYXVzZTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJvb2xlYW4pIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQm9vbGVhbih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTnVtYmVyKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IE51bWJlcih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFN0cmluZyh2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlVG9DbG9uZSA9PT0gIm9iamVjdCIgJiYgaXNDbG9uZWFibGVPYmplY3QodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlVG9DbG9uZSkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICB9CiAgICBmdW5jdGlvbiBjb3B5UHJvcGVydGllcyh0YXJnZXQsIHNvdXJjZSwgb2JqZWN0VG9DbG9uZSA9IHRhcmdldCwgc3RhY2ssIGNsb25lVmFsdWUpIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5PYmplY3Qua2V5cyhzb3VyY2UpLCAuLi5nZXRTeW1ib2xzLmdldFN5bWJvbHMoc291cmNlKV07CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpOwogICAgICAgIGlmIChkZXNjcmlwdG9yID09IG51bGwgfHwgZGVzY3JpcHRvci53cml0YWJsZSkgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSBjbG9uZURlZXBXaXRoSW1wbChzb3VyY2Vba2V5XSwga2V5LCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0Nsb25lYWJsZU9iamVjdChvYmplY3QpIHsKICAgICAgc3dpdGNoIChnZXRUYWcuZ2V0VGFnKG9iamVjdCkpIHsKICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuYXJyYXlCdWZmZXJUYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGFWaWV3VGFnOgogICAgICAgIGNhc2UgdGFncy5ib29sZWFuVGFnOgogICAgICAgIGNhc2UgdGFncy5kYXRlVGFnOgogICAgICAgIGNhc2UgdGFncy5mbG9hdDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0NjRBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50OEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQzMkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5tYXBUYWc6CiAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICBjYXNlIHRhZ3Mub2JqZWN0VGFnOgogICAgICAgIGNhc2UgdGFncy5yZWdleHBUYWc6CiAgICAgICAgY2FzZSB0YWdzLnNldFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgIGNhc2UgdGFncy5zeW1ib2xUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MTZBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDMyQXJyYXlUYWc6IHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoSW1wbCA9IGNsb25lRGVlcFdpdGhJbXBsOwogICAgZXhwb3J0cy5jb3B5UHJvcGVydGllcyA9IGNvcHlQcm9wZXJ0aWVzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCA9IHJlcXVpcmVfY2xvbmVEZWVwV2l0aCgpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzCnZhciByZXF1aXJlX21hdGNoZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcCgpOwogICAgZnVuY3Rpb24gbWF0Y2hlczIoc291cmNlKSB7CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuICh0YXJnZXQpID0+IHsKICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHRhcmdldCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXMyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXBXaXRoMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCQxID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoKCk7CiAgICB2YXIgdGFncyA9IHJlcXVpcmVfdGFncygpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGN1c3RvbWl6ZXIpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGgkMS5jbG9uZURlZXBXaXRoKG9iaiwgKHZhbHVlLCBrZXksIG9iamVjdCwgc3RhY2spID0+IHsKICAgICAgICBjb25zdCBjbG9uZWQgPSBjdXN0b21pemVyPy4odmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjayk7CiAgICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgIGNhc2UgdGFncy5udW1iZXJUYWc6CiAgICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IG9iai5jb25zdHJ1Y3RvcihvYmo/LnZhbHVlT2YoKSk7CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOiB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgICAgICAgICBjbG9uZURlZXBXaXRoJDEuY29weVByb3BlcnRpZXMocmVzdWx0LCBvYmopOwogICAgICAgICAgICByZXN1bHQubGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0W1N5bWJvbC5pdGVyYXRvcl0gPSBvYmpbU3ltYm9sLml0ZXJhdG9yXTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXAyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgyKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXAob2JqKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoLmNsb25lRGVlcFdpdGgob2JqKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcwp2YXIgcmVxdWlyZV9pc0luZGV4ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBJU19VTlNJR05FRF9JTlRFR0VSID0gL14oPzowfFsxLTldXGQqKSQvOwogICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZSwgbGVuZ3RoID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMCAmJiB2YWx1ZSA8IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4gSVNfVU5TSUdORURfSU5URUdFUi50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXNJbmRleCA9IGlzSW5kZXg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FyZ3VtZW50cy5qcwp2YXIgcmVxdWlyZV9pc0FyZ3VtZW50cyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFRhZyA9IHJlcXVpcmVfZ2V0VGFnKCk7CiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiBnZXRUYWcuZ2V0VGFnKHZhbHVlKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSI7CiAgICB9CiAgICBleHBvcnRzLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMKdmFyIHJlcXVpcmVfaGFzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzRGVlcEtleSA9IHJlcXVpcmVfaXNEZWVwS2V5KCk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJndW1lbnRzID0gcmVxdWlyZV9pc0FyZ3VtZW50cygpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBoYXMzKG9iamVjdCwgcGF0aDIpIHsKICAgICAgbGV0IHJlc29sdmVkUGF0aDsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF0aDIpKSB7CiAgICAgICAgcmVzb2x2ZWRQYXRoID0gcGF0aDI7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdGgyID09PSAic3RyaW5nIiAmJiBpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSAmJiBvYmplY3Q/LltwYXRoMl0gPT0gbnVsbCkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHRvUGF0aC50b1BhdGgocGF0aDIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmVkUGF0aCA9IFtwYXRoMl07CiAgICAgIH0KICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IGN1cnJlbnQzID0gb2JqZWN0OwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc29sdmVkUGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IHJlc29sdmVkUGF0aFtpXTsKICAgICAgICBpZiAoY3VycmVudDMgPT0gbnVsbCB8fCAhT2JqZWN0Lmhhc093bihjdXJyZW50Mywga2V5KSkgewogICAgICAgICAgY29uc3QgaXNTcGFyc2VJbmRleCA9IChBcnJheS5pc0FycmF5KGN1cnJlbnQzKSB8fCBpc0FyZ3VtZW50cy5pc0FyZ3VtZW50cyhjdXJyZW50MykpICYmIGlzSW5kZXguaXNJbmRleChrZXkpICYmIGtleSA8IGN1cnJlbnQzLmxlbmd0aDsKICAgICAgICAgIGlmICghaXNTcGFyc2VJbmRleCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGV4cG9ydHMuaGFzID0gaGFzMzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaCA9IHJlcXVpcmVfaXNNYXRjaCgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIGNsb25lRGVlcCA9IHJlcXVpcmVfY2xvbmVEZWVwMigpOwogICAgdmFyIGdldDUgPSByZXF1aXJlX2dldCgpOwogICAgdmFyIGhhczMgPSByZXF1aXJlX2hhcygpOwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHByb3BlcnR5LCBzb3VyY2UpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHkpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHByb3BlcnR5Py52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwcm9wZXJ0eSA9ICItMCI7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcHJvcGVydHkgPSB0b0tleS50b0tleShwcm9wZXJ0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc291cmNlID0gY2xvbmVEZWVwLmNsb25lRGVlcChzb3VyY2UpOwogICAgICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0NS5nZXQodGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gaGFzMy5oYXModGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHJlc3VsdCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL2l0ZXJhdGVlLmpzCnZhciByZXF1aXJlX2l0ZXJhdGVlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvaXRlcmF0ZWUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmVfcHJvcGVydHkoKTsKICAgIHZhciBtYXRjaGVzMiA9IHJlcXVpcmVfbWF0Y2hlcygpOwogICAgdmFyIG1hdGNoZXNQcm9wZXJ0eSA9IHJlcXVpcmVfbWF0Y2hlc1Byb3BlcnR5KCk7CiAgICBmdW5jdGlvbiBpdGVyYXRlZSh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBpZGVudGl0eTQuaWRlbnRpdHk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlc1Byb3BlcnR5Lm1hdGNoZXNQcm9wZXJ0eSh2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXMyLm1hdGNoZXModmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIHByb3BlcnR5LnByb3BlcnR5KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXRlcmF0ZWUgPSBpdGVyYXRlZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB1bmlxQnkkMSA9IHJlcXVpcmVfdW5pcUJ5KCk7CiAgICB2YXIgaWRlbnRpdHk0ID0gcmVxdWlyZV9pZGVudGl0eSgpOwogICAgdmFyIGlzQXJyYXlMaWtlT2JqZWN0ID0gcmVxdWlyZV9pc0FycmF5TGlrZU9iamVjdCgpOwogICAgdmFyIGl0ZXJhdGVlID0gcmVxdWlyZV9pdGVyYXRlZSgpOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnJheSwgaXRlcmF0ZWUkMSA9IGlkZW50aXR5NC5pZGVudGl0eSkgewogICAgICBpZiAoIWlzQXJyYXlMaWtlT2JqZWN0LmlzQXJyYXlMaWtlT2JqZWN0KGFycmF5KSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICByZXR1cm4gdW5pcUJ5JDEudW5pcUJ5KEFycmF5LmZyb20oYXJyYXkpLCBpdGVyYXRlZS5pdGVyYXRlZShpdGVyYXRlZSQxKSk7CiAgICB9CiAgICBleHBvcnRzLnVuaXFCeSA9IHVuaXFCeTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC91bmlxQnkuanMKdmFyIHJlcXVpcmVfdW5pcUJ5MyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91bmlxQnkyKCkudW5pcUJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIGRpZFdhcm5PbGQxOEFscGhhIHx8IHZvaWQgMCA9PT0gUmVhY3QzOC5zdGFydFRyYW5zaXRpb24gfHwgKGRpZFdhcm5PbGQxOEFscGhhID0gdHJ1ZSwgY29uc29sZS5lcnJvcigKICAgICAgICAgICJZb3UgYXJlIHVzaW5nIGFuIG91dGRhdGVkLCBwcmUtcmVsZWFzZSBhbHBoYSBvZiBSZWFjdCAxOCB0aGF0IGRvZXMgbm90IHN1cHBvcnQgdXNlU3luY0V4dGVybmFsU3RvcmUuIFRoZSB1c2Utc3luYy1leHRlcm5hbC1zdG9yZSBzaGltIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5LiBVcGdyYWRlIHRvIGEgbmV3ZXIgcHJlLXJlbGVhc2UuIgogICAgICAgICkpOwogICAgICAgIHZhciB2YWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGNhY2hlZFZhbHVlID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIG9iamVjdElzKHZhbHVlLCBjYWNoZWRWYWx1ZSkgfHwgKGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIKICAgICAgICAgICksIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGNhY2hlZFZhbHVlID0gdXNlU3RhdGUxMih7CiAgICAgICAgICBpbnN0OiB7IHZhbHVlLCBnZXRTbmFwc2hvdCB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGluc3QgPSBjYWNoZWRWYWx1ZVswXS5pbnN0LCBmb3JjZVVwZGF0ZSA9IGNhY2hlZFZhbHVlWzFdOwogICAgICAgIHVzZUxheW91dEVmZmVjdDkoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgfSwKICAgICAgICAgIFtzdWJzY3JpYmUsIHZhbHVlLCBnZXRTbmFwc2hvdF0KICAgICAgICApOwogICAgICAgIHVzZUVmZmVjdDE0KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgIGluc3QgPSBpbnN0LnZhbHVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMoaW5zdCwgbmV4dFZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIHJldHVybiBnZXRTbmFwc2hvdCgpOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN0YXRlMTIgPSBSZWFjdDM4LnVzZVN0YXRlLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzgudXNlRWZmZWN0LCB1c2VMYXlvdXRFZmZlY3Q5ID0gUmVhY3QzOC51c2VMYXlvdXRFZmZlY3QsIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOC51c2VEZWJ1Z1ZhbHVlLCBkaWRXYXJuT2xkMThBbHBoYSA9IGZhbHNlLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IGZhbHNlLCBzaGltID0gInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA/IHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEgOiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdm9pZCAwICE9PSBSZWFjdDM4LnVzZVN5bmNFeHRlcm5hbFN0b3JlID8gUmVhY3QzOC51c2VTeW5jRXh0ZXJuYWxTdG9yZSA6IHNoaW07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMKdmFyIHJlcXVpcmVfc2hpbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3NoaW1fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzggPSByZXF1aXJlX3JlYWN0KCksIHNoaW0gPSByZXF1aXJlX3NoaW0oKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBzaGltLnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzgudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzgudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzgudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM4LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS93aXRoLXNlbGVjdG9yLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvY29tcGFyZVZhbHVlcy5qcwp2YXIgcmVxdWlyZV9jb21wYXJlVmFsdWVzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGdldFByaW9yaXR5KGEpIHsKICAgICAgaWYgKHR5cGVvZiBhID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIDI7CiAgICAgIH0KICAgICAgaWYgKGEgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAzOwogICAgICB9CiAgICAgIGlmIChhICE9PSBhKSB7CiAgICAgICAgcmV0dXJuIDQ7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IChhLCBiLCBvcmRlcikgPT4gewogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGNvbnN0IGFQcmlvcml0eSA9IGdldFByaW9yaXR5KGEpOwogICAgICAgIGNvbnN0IGJQcmlvcml0eSA9IGdldFByaW9yaXR5KGIpOwogICAgICAgIGlmIChhUHJpb3JpdHkgPT09IGJQcmlvcml0eSAmJiBhUHJpb3JpdHkgPT09IDApIHsKICAgICAgICAgIGlmIChhIDwgYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IDEgOiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IC0xIDogMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyBiUHJpb3JpdHkgLSBhUHJpb3JpdHkgOiBhUHJpb3JpdHkgLSBiUHJpb3JpdHk7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9OwogICAgZXhwb3J0cy5jb21wYXJlVmFsdWVzID0gY29tcGFyZVZhbHVlczsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzU3ltYm9sLmpzCnZhciByZXF1aXJlX2lzU3ltYm9sID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1N5bWJvbCh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3ltYm9sIiB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN5bWJvbDsKICAgIH0KICAgIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzS2V5LmpzCnZhciByZXF1aXJlX2lzS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNTeW1ib2wgPSByZXF1aXJlX2lzU3ltYm9sKCk7CiAgICB2YXIgcmVnZXhJc0RlZXBQcm9wID0gL1wufFxbKD86W15bXF1dKnwoWyInXSkoPzooPyFcMSlbXlxcXXxcXC4pKj9cMSlcXS87CiAgICB2YXIgcmVnZXhJc1BsYWluUHJvcCA9IC9eXHcqJC87CiAgICBmdW5jdGlvbiBpc0tleSh2YWx1ZSwgb2JqZWN0KSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PSBudWxsIHx8IGlzU3ltYm9sLmlzU3ltYm9sKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIChyZWdleElzUGxhaW5Qcm9wLnRlc3QodmFsdWUpIHx8ICFyZWdleElzRGVlcFByb3AudGVzdCh2YWx1ZSkpIHx8IG9iamVjdCAhPSBudWxsICYmIE9iamVjdC5oYXNPd24ob2JqZWN0LCB2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmlzS2V5ID0gaXNLZXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L29yZGVyQnkuanMKdmFyIHJlcXVpcmVfb3JkZXJCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjb21wYXJlVmFsdWVzID0gcmVxdWlyZV9jb21wYXJlVmFsdWVzKCk7CiAgICB2YXIgaXNLZXkgPSByZXF1aXJlX2lzS2V5KCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIG9yZGVyQnkoY29sbGVjdGlvbiwgY3JpdGVyaWEsIG9yZGVycywgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBndWFyZCA/IHZvaWQgMCA6IG9yZGVyczsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IE9iamVjdC52YWx1ZXMoY29sbGVjdGlvbik7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNyaXRlcmlhKSkgewogICAgICAgIGNyaXRlcmlhID0gY3JpdGVyaWEgPT0gbnVsbCA/IFtudWxsXSA6IFtjcml0ZXJpYV07CiAgICAgIH0KICAgICAgaWYgKGNyaXRlcmlhLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNyaXRlcmlhID0gW251bGxdOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcmRlcnMpKSB7CiAgICAgICAgb3JkZXJzID0gb3JkZXJzID09IG51bGwgPyBbXSA6IFtvcmRlcnNdOwogICAgICB9CiAgICAgIG9yZGVycyA9IG9yZGVycy5tYXAoKG9yZGVyKSA9PiBTdHJpbmcob3JkZXIpKTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeU5lc3RlZFBhdGggPSAob2JqZWN0LCBwYXRoMikgPT4gewogICAgICAgIGxldCB0YXJnZXQgPSBvYmplY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoMi5sZW5ndGggJiYgdGFyZ2V0ICE9IG51bGw7ICsraSkgewogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhdGgyW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeUNyaXRlcmlvbiA9IChjcml0ZXJpb24sIG9iamVjdCkgPT4gewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCB8fCBjcml0ZXJpb24gPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJvYmplY3QiICYmICJrZXkiIGluIGNyaXRlcmlvbikgewogICAgICAgICAgaWYgKE9iamVjdC5oYXNPd24ob2JqZWN0LCBjcml0ZXJpb24ua2V5KSkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbi5rZXldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uLnBhdGgpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbihvYmplY3QpOwogICAgICAgIH0KICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVCeU5lc3RlZFBhdGgob2JqZWN0LCBjcml0ZXJpb24pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbY3JpdGVyaW9uXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgY29uc3QgcHJlcGFyZWRDcml0ZXJpYSA9IGNyaXRlcmlhLm1hcCgoY3JpdGVyaW9uKSA9PiB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSAmJiBjcml0ZXJpb24ubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjcml0ZXJpb24gPSBjcml0ZXJpb25bMF07CiAgICAgICAgfQogICAgICAgIGlmIChjcml0ZXJpb24gPT0gbnVsbCB8fCB0eXBlb2YgY3JpdGVyaW9uID09PSAiZnVuY3Rpb24iIHx8IEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSB8fCBpc0tleS5pc0tleShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gY3JpdGVyaW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBrZXk6IGNyaXRlcmlvbiwgcGF0aDogdG9QYXRoLnRvUGF0aChjcml0ZXJpb24pIH07CiAgICAgIH0pOwogICAgICBjb25zdCBwcmVwYXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgICBvcmlnaW5hbDogaXRlbSwKICAgICAgICBjcml0ZXJpYTogcHJlcGFyZWRDcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gZ2V0VmFsdWVCeUNyaXRlcmlvbihjcml0ZXJpb24sIGl0ZW0pKQogICAgICB9KSk7CiAgICAgIHJldHVybiBwcmVwYXJlZENvbGxlY3Rpb24uc2xpY2UoKS5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVwYXJlZENyaXRlcmlhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjb21wYXJlZFJlc3VsdCA9IGNvbXBhcmVWYWx1ZXMuY29tcGFyZVZhbHVlcyhhLmNyaXRlcmlhW2ldLCBiLmNyaXRlcmlhW2ldLCBvcmRlcnNbaV0pOwogICAgICAgICAgaWYgKGNvbXBhcmVkUmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlZFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0pLm1hcCgoaXRlbSkgPT4gaXRlbS5vcmlnaW5hbCk7CiAgICB9CiAgICBleHBvcnRzLm9yZGVyQnkgPSBvcmRlckJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMKdmFyIHJlcXVpcmVfZmxhdHRlbiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnIsIGRlcHRoID0gMSkgewogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgZmxvb3JlZERlcHRoID0gTWF0aC5mbG9vcihkZXB0aCk7CiAgICAgIGNvbnN0IHJlY3Vyc2l2ZSA9IChhcnIyLCBjdXJyZW50RGVwdGgpID0+IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycjIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBhcnIyW2ldOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgY3VycmVudERlcHRoIDwgZmxvb3JlZERlcHRoKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZShpdGVtLCBjdXJyZW50RGVwdGggKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmVjdXJzaXZlKGFyciwgMCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmZsYXR0ZW4gPSBmbGF0dGVuOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMKdmFyIHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSXRlcmF0ZWVDYWxsLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0luZGV4ID0gcmVxdWlyZV9pc0luZGV4KCk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3QgPSByZXF1aXJlX2lzT2JqZWN0KCk7CiAgICB2YXIgZXEgPSByZXF1aXJlX2VxKCk7CiAgICBmdW5jdGlvbiBpc0l0ZXJhdGVlQ2FsbCh2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gIm51bWJlciIgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2Uob2JqZWN0KSAmJiBpc0luZGV4LmlzSW5kZXgoaW5kZXgpICYmIGluZGV4IDwgb2JqZWN0Lmxlbmd0aCB8fCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICYmIGluZGV4IGluIG9iamVjdCkgewogICAgICAgIHJldHVybiBlcS5lcShvYmplY3RbaW5kZXhdLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0l0ZXJhdGVlQ2FsbCA9IGlzSXRlcmF0ZWVDYWxsOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgb3JkZXJCeSA9IHJlcXVpcmVfb3JkZXJCeSgpOwogICAgdmFyIGZsYXR0ZW4gPSByZXF1aXJlX2ZsYXR0ZW4oKTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIGZ1bmN0aW9uIHNvcnRCeTUoY29sbGVjdGlvbiwgLi4uY3JpdGVyaWEpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gY3JpdGVyaWEubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMSAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbXTsKICAgICAgfSBlbHNlIGlmIChsZW5ndGggPiAyICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKGNyaXRlcmlhWzBdLCBjcml0ZXJpYVsxXSwgY3JpdGVyaWFbMl0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbY3JpdGVyaWFbMF1dOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlckJ5Lm9yZGVyQnkoY29sbGVjdGlvbiwgZmxhdHRlbi5mbGF0dGVuKGNyaXRlcmlhKSwgWyJhc2MiXSk7CiAgICB9CiAgICBleHBvcnRzLnNvcnRCeSA9IHNvcnRCeTU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9zb3J0QnkoKS5zb3J0Qnk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9kZWJvdW5jZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zLCB7IHNpZ25hbCwgZWRnZXMgfSA9IHt9KSB7CiAgICAgIGxldCBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgY29uc3QgbGVhZGluZyA9IGVkZ2VzICE9IG51bGwgJiYgZWRnZXMuaW5jbHVkZXMoImxlYWRpbmciKTsKICAgICAgY29uc3QgdHJhaWxpbmcgPSBlZGdlcyA9PSBudWxsIHx8IGVkZ2VzLmluY2x1ZGVzKCJ0cmFpbGluZyIpOwogICAgICBjb25zdCBpbnZva2UgPSAoKSA9PiB7CiAgICAgICAgaWYgKHBlbmRpbmdBcmdzICE9PSBudWxsKSB7CiAgICAgICAgICBmdW5jLmFwcGx5KHBlbmRpbmdUaGlzLCBwZW5kaW5nQXJncyk7CiAgICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG9uVGltZXJFbmQgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRyYWlsaW5nKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgICAgY2FuY2VsKCk7CiAgICAgIH07CiAgICAgIGxldCB0aW1lb3V0SWQgPSBudWxsOwogICAgICBjb25zdCBzY2hlZHVsZSA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgICBvblRpbWVyRW5kKCk7CiAgICAgICAgfSwgZGVib3VuY2VNcyk7CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbFRpbWVyID0gKCkgPT4gewogICAgICAgIGlmICh0aW1lb3V0SWQgIT09IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbCA9ICgpID0+IHsKICAgICAgICBjYW5jZWxUaW1lcigpOwogICAgICAgIHBlbmRpbmdUaGlzID0gdm9pZCAwOwogICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgfTsKICAgICAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICAgICAgaW52b2tlKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAoc2lnbmFsPy5hYm9ydGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBlbmRpbmdUaGlzID0gdGhpczsKICAgICAgICBwZW5kaW5nQXJncyA9IGFyZ3M7CiAgICAgICAgY29uc3QgaXNGaXJzdENhbGwgPSB0aW1lb3V0SWQgPT0gbnVsbDsKICAgICAgICBzY2hlZHVsZSgpOwogICAgICAgIGlmIChsZWFkaW5nICYmIGlzRmlyc3RDYWxsKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlYm91bmNlZC5zY2hlZHVsZSA9IHNjaGVkdWxlOwogICAgICBkZWJvdW5jZWQuY2FuY2VsID0gY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgc2lnbmFsPy5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbmNlbCwgeyBvbmNlOiB0cnVlIH0pOwogICAgICByZXR1cm4gZGVib3VuY2VkOwogICAgfQogICAgZXhwb3J0cy5kZWJvdW5jZSA9IGRlYm91bmNlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi9kZWJvdW5jZS5qcwp2YXIgcmVxdWlyZV9kZWJvdW5jZTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlJDEgPSByZXF1aXJlX2RlYm91bmNlKCk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgeyBsZWFkaW5nID0gZmFsc2UsIHRyYWlsaW5nID0gdHJ1ZSwgbWF4V2FpdCB9ID0gb3B0aW9uczsKICAgICAgY29uc3QgZWRnZXMgPSBBcnJheSgyKTsKICAgICAgaWYgKGxlYWRpbmcpIHsKICAgICAgICBlZGdlc1swXSA9ICJsZWFkaW5nIjsKICAgICAgfQogICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICBlZGdlc1sxXSA9ICJ0cmFpbGluZyI7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIGNvbnN0IF9kZWJvdW5jZWQgPSBkZWJvdW5jZSQxLmRlYm91bmNlKGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIH0sIGRlYm91bmNlTXMsIHsgZWRnZXMgfSk7CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAobWF4V2FpdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocGVuZGluZ0F0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHBlbmRpbmdBdCA+PSBtYXhXYWl0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuY2FuY2VsKCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuc2NoZWR1bGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2RlYm91bmNlZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBfZGVib3VuY2VkLmZsdXNoKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IF9kZWJvdW5jZWQuY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlID0gcmVxdWlyZV9kZWJvdW5jZTIoKTsKICAgIGZ1bmN0aW9uIHRocm90dGxlMihmdW5jLCB0aHJvdHRsZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IHRydWUsIHRyYWlsaW5nID0gdHJ1ZSB9ID0gb3B0aW9uczsKICAgICAgcmV0dXJuIGRlYm91bmNlLmRlYm91bmNlKGZ1bmMsIHRocm90dGxlTXMsIHsKICAgICAgICBsZWFkaW5nLAogICAgICAgIG1heFdhaXQ6IHRocm90dGxlTXMsCiAgICAgICAgdHJhaWxpbmcKICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnRocm90dGxlID0gdGhyb3R0bGUyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC90aHJvdHRsZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdGhyb3R0bGUoKS50aHJvdHRsZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcwp2YXIgcmVxdWlyZV90b051bWJlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIGZ1bmN0aW9uIHRvTnVtYmVyKHZhbHVlKSB7CiAgICAgIGlmIChpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTmFOOwogICAgICB9CiAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b051bWJlciA9IHRvTnVtYmVyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzCnZhciByZXF1aXJlX3RvRmluaXRlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9GaW5pdGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvTnVtYmVyID0gcmVxdWlyZV90b051bWJlcigpOwogICAgZnVuY3Rpb24gdG9GaW5pdGUodmFsdWUpIHsKICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZhbHVlIDogMDsKICAgICAgfQogICAgICB2YWx1ZSA9IHRvTnVtYmVyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9tYXRoL3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L21hdGgvcmFuZ2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzSXRlcmF0ZWVDYWxsID0gcmVxdWlyZV9pc0l0ZXJhdGVlQ2FsbCgpOwogICAgdmFyIHRvRmluaXRlID0gcmVxdWlyZV90b0Zpbml0ZSgpOwogICAgZnVuY3Rpb24gcmFuZ2U0KHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgICAgaWYgKHN0ZXAgJiYgdHlwZW9mIHN0ZXAgIT09ICJudW1iZXIiICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKHN0YXJ0LCBlbmQsIHN0ZXApKSB7CiAgICAgICAgZW5kID0gc3RlcCA9IHZvaWQgMDsKICAgICAgfQogICAgICBzdGFydCA9IHRvRmluaXRlLnRvRmluaXRlKHN0YXJ0KTsKICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGVuZCA9IHRvRmluaXRlLnRvRmluaXRlKGVuZCk7CiAgICAgIH0KICAgICAgc3RlcCA9IHN0ZXAgPT09IHZvaWQgMCA/IHN0YXJ0IDwgZW5kID8gMSA6IC0xIDogdG9GaW5pdGUudG9GaW5pdGUoc3RlcCk7CiAgICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gKHN0ZXAgfHwgMSkpLCAwKTsKICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5yYW5nZSA9IHJhbmdlNDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvcmFuZ2UuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JhbmdlKCkucmFuZ2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9kZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanMKdmFyIHJlcXVpcmVfZGVjaW1hbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIChmdW5jdGlvbihnbG9iYWxTY29wZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBNQVhfRElHSVRTID0gMWU5LCBEZWNpbWFsMyA9IHsKICAgICAgICAvLyBUaGVzZSB2YWx1ZXMgbXVzdCBiZSBpbnRlZ2VycyB3aXRoaW4gdGhlIHN0YXRlZCByYW5nZXMgKGluY2x1c2l2ZSkuCiAgICAgICAgLy8gTW9zdCBvZiB0aGVzZSB2YWx1ZXMgY2FuIGJlIGNoYW5nZWQgZHVyaW5nIHJ1bi10aW1lIHVzaW5nIGBEZWNpbWFsLmNvbmZpZ2AuCiAgICAgICAgLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpZ25pZmljYW50IGRpZ2l0cyBvZiB0aGUgcmVzdWx0IG9mIGEgY2FsY3VsYXRpb24gb3IgYmFzZSBjb252ZXJzaW9uLgogICAgICAgIC8vIEUuZy4gYERlY2ltYWwuY29uZmlnKHsgcHJlY2lzaW9uOiAyMCB9KTtgCiAgICAgICAgcHJlY2lzaW9uOiAyMCwKICAgICAgICAvLyAxIHRvIE1BWF9ESUdJVFMKICAgICAgICAvLyBUaGUgcm91bmRpbmcgbW9kZSB1c2VkIGJ5IGRlZmF1bHQgYnkgYHRvSW50ZWdlcmAsIGB0b0RlY2ltYWxQbGFjZXNgLCBgdG9FeHBvbmVudGlhbGAsCiAgICAgICAgLy8gYHRvRml4ZWRgLCBgdG9QcmVjaXNpb25gIGFuZCBgdG9TaWduaWZpY2FudERpZ2l0c2AuCiAgICAgICAgLy8KICAgICAgICAvLyBST1VORF9VUCAgICAgICAgIDAgQXdheSBmcm9tIHplcm8uCiAgICAgICAgLy8gUk9VTkRfRE9XTiAgICAgICAxIFRvd2FyZHMgemVyby4KICAgICAgICAvLyBST1VORF9DRUlMICAgICAgIDIgVG93YXJkcyArSW5maW5pdHkuCiAgICAgICAgLy8gUk9VTkRfRkxPT1IgICAgICAzIFRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfVVAgICAgNCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdXAuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9ET1dOICA1IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCBkb3duLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRVZFTiAgNiBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyBldmVuIG5laWdoYm91ci4KICAgICAgICAvLyBST1VORF9IQUxGX0NFSUwgIDcgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfRkxPT1IgOCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyAtSW5maW5pdHkuCiAgICAgICAgLy8KICAgICAgICAvLyBFLmcuCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSA0O2AKICAgICAgICAvLyBgRGVjaW1hbC5yb3VuZGluZyA9IERlY2ltYWwuUk9VTkRfSEFMRl9VUDtgCiAgICAgICAgcm91bmRpbmc6IDQsCiAgICAgICAgLy8gMCB0byA4CiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBiZW5lYXRoIHdoaWNoIGB0b1N0cmluZ2AgcmV0dXJucyBleHBvbmVudGlhbCBub3RhdGlvbi4KICAgICAgICAvLyBKYXZhU2NyaXB0IG51bWJlcnM6IC03CiAgICAgICAgdG9FeHBOZWc6IC03LAogICAgICAgIC8vIDAgdG8gLU1BWF9FCiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBhYm92ZSB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAyMQogICAgICAgIHRvRXhwUG9zOiAyMSwKICAgICAgICAvLyAwIHRvIE1BWF9FCiAgICAgICAgLy8gVGhlIG5hdHVyYWwgbG9nYXJpdGhtIG9mIDEwLgogICAgICAgIC8vIDExNSBkaWdpdHMKICAgICAgICBMTjEwOiAiMi4zMDI1ODUwOTI5OTQwNDU2ODQwMTc5OTE0NTQ2ODQzNjQyMDc2MDExMDE0ODg2Mjg3NzI5NzYwMzMzMjc5MDA5Njc1NzI2MDk2NzczNTI0ODAyMzU5OTcyMDUwODk1OTgyOTgzNDE5Njc3ODQwNDIyODYiCiAgICAgIH0sIGV4dGVybmFsID0gdHJ1ZSwgZGVjaW1hbEVycm9yID0gIltEZWNpbWFsRXJyb3JdICIsIGludmFsaWRBcmd1bWVudCA9IGRlY2ltYWxFcnJvciArICJJbnZhbGlkIGFyZ3VtZW50OiAiLCBleHBvbmVudE91dE9mUmFuZ2UgPSBkZWNpbWFsRXJyb3IgKyAiRXhwb25lbnQgb3V0IG9mIHJhbmdlOiAiLCBtYXRoZmxvb3IgPSBNYXRoLmZsb29yLCBtYXRocG93ID0gTWF0aC5wb3csIGlzRGVjaW1hbCA9IC9eKFxkKyhcLlxkKik/fFwuXGQrKShlWystXT9cZCspPyQvaSwgT05FLCBCQVNFID0gMWU3LCBMT0dfQkFTRSA9IDcsIE1BWF9TQUZFX0lOVEVHRVIgPSA5MDA3MTk5MjU0NzQwOTkxLCBNQVhfRSA9IG1hdGhmbG9vcihNQVhfU0FGRV9JTlRFR0VSIC8gTE9HX0JBU0UpLCBQID0ge307CiAgICAgIFAuYWJzb2x1dGVWYWx1ZSA9IFAuYWJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgaWYgKHgyLnMpIHgyLnMgPSAxOwogICAgICAgIHJldHVybiB4MjsKICAgICAgfTsKICAgICAgUC5jb21wYXJlZFRvID0gUC5jbXAgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBpLCBqLCB4ZEwsIHlkTCwgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICBpZiAoeDIucyAhPT0geTIucykgcmV0dXJuIHgyLnMgfHwgLXkyLnM7CiAgICAgICAgaWYgKHgyLmUgIT09IHkyLmUpIHJldHVybiB4Mi5lID4geTIuZSBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICAgIHhkTCA9IHgyLmQubGVuZ3RoOwogICAgICAgIHlkTCA9IHkyLmQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDAsIGogPSB4ZEwgPCB5ZEwgPyB4ZEwgOiB5ZEw7IGkgPCBqOyArK2kpIHsKICAgICAgICAgIGlmICh4Mi5kW2ldICE9PSB5Mi5kW2ldKSByZXR1cm4geDIuZFtpXSA+IHkyLmRbaV0gXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHhkTCA9PT0geWRMID8gMCA6IHhkTCA+IHlkTCBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICB9OwogICAgICBQLmRlY2ltYWxQbGFjZXMgPSBQLmRwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgdyA9IHgyLmQubGVuZ3RoIC0gMSwgZHAgPSAodyAtIHgyLmUpICogTE9HX0JBU0U7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgZHAtLTsKICAgICAgICByZXR1cm4gZHAgPCAwID8gMCA6IGRwOwogICAgICB9OwogICAgICBQLmRpdmlkZWRCeSA9IFAuZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gZGl2aWRlKHRoaXMsIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHkyKSk7CiAgICAgIH07CiAgICAgIFAuZGl2aWRlZFRvSW50ZWdlckJ5ID0gUC5pZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHJvdW5kKGRpdmlkZSh4MiwgbmV3IEN0b3IoeTIpLCAwLCAxKSwgQ3Rvci5wcmVjaXNpb24pOwogICAgICB9OwogICAgICBQLmVxdWFscyA9IFAuZXEgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiAhdGhpcy5jbXAoeTIpOwogICAgICB9OwogICAgICBQLmV4cG9uZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldEJhc2UxMEV4cG9uZW50KHRoaXMpOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuID0gUC5ndCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+IDA7CiAgICAgIH07CiAgICAgIFAuZ3JlYXRlclRoYW5PckVxdWFsVG8gPSBQLmd0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+PSAwOwogICAgICB9OwogICAgICBQLmlzSW50ZWdlciA9IFAuaXNpbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lID4gdGhpcy5kLmxlbmd0aCAtIDI7CiAgICAgIH07CiAgICAgIFAuaXNOZWdhdGl2ZSA9IFAuaXNuZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zIDwgMDsKICAgICAgfTsKICAgICAgUC5pc1Bvc2l0aXZlID0gUC5pc3BvcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPiAwOwogICAgICB9OwogICAgICBQLmlzWmVybyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPT09IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW4gPSBQLmx0ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMDsKICAgICAgfTsKICAgICAgUC5sZXNzVGhhbk9yRXF1YWxUbyA9IFAubHRlID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMTsKICAgICAgfTsKICAgICAgUC5sb2dhcml0aG0gPSBQLmxvZyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICB2YXIgcjIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uLCB3cHIgPSBwciArIDU7CiAgICAgICAgaWYgKGJhc2UgPT09IHZvaWQgMCkgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKDEwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKGJhc2UpOwogICAgICAgICAgaWYgKGJhc2UucyA8IDEgfHwgYmFzZS5lcShPTkUpKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfQogICAgICAgIGlmICh4Mi5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgKHgyLnMgPyAiTmFOIiA6ICItSW5maW5pdHkiKSk7CiAgICAgICAgaWYgKHgyLmVxKE9ORSkpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0gZGl2aWRlKGxuKHgyLCB3cHIpLCBsbihiYXNlLCB3cHIpLCB3cHIpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcm91bmQocjIsIHByKTsKICAgICAgfTsKICAgICAgUC5taW51cyA9IFAuc3ViID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gc3VidHJhY3QoeDIsIHkyKSA6IGFkZCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5tb2R1bG8gPSBQLm1vZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHEsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIHkyID0gbmV3IEN0b3IoeTIpOwogICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIGlmICgheDIucykgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgcHIpOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcSA9IGRpdmlkZSh4MiwgeTIsIDAsIDEpLnRpbWVzKHkyKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHgyLm1pbnVzKHEpOwogICAgICB9OwogICAgICBQLm5hdHVyYWxFeHBvbmVudGlhbCA9IFAuZXhwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsTG9nYXJpdGhtID0gUC5sbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBsbih0aGlzKTsKICAgICAgfTsKICAgICAgUC5uZWdhdGVkID0gUC5uZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzKTsKICAgICAgICB4Mi5zID0gLXgyLnMgfHwgMDsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAucGx1cyA9IFAuYWRkID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gYWRkKHgyLCB5MikgOiBzdWJ0cmFjdCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5wcmVjaXNpb24gPSBQLnNkID0gZnVuY3Rpb24oeikgewogICAgICAgIHZhciBlLCBzZCwgdywgeDIgPSB0aGlzOwogICAgICAgIGlmICh6ICE9PSB2b2lkIDAgJiYgeiAhPT0gISF6ICYmIHogIT09IDEgJiYgeiAhPT0gMCkgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgeik7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDE7CiAgICAgICAgdyA9IHgyLmQubGVuZ3RoIC0gMTsKICAgICAgICBzZCA9IHcgKiBMT0dfQkFTRSArIDE7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgc2QtLTsKICAgICAgICAgIGZvciAodyA9IHgyLmRbMF07IHcgPj0gMTA7IHcgLz0gMTApIHNkKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiB6ICYmIGUgPiBzZCA/IGUgOiBzZDsKICAgICAgfTsKICAgICAgUC5zcXVhcmVSb290ID0gUC5zcXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGUsIG4sIHByLCByMiwgcywgdCwgd3ByLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoeDIucyA8IDEpIHsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcyA9IE1hdGguc3FydCgreDIpOwogICAgICAgIGlmIChzID09IDAgfHwgcyA9PSAxIC8gMCkgewogICAgICAgICAgbiA9IGRpZ2l0c1RvU3RyaW5nKHgyLmQpOwogICAgICAgICAgaWYgKChuLmxlbmd0aCArIGUpICUgMiA9PSAwKSBuICs9ICIwIjsKICAgICAgICAgIHMgPSBNYXRoLnNxcnQobik7CiAgICAgICAgICBlID0gbWF0aGZsb29yKChlICsgMSkgLyAyKSAtIChlIDwgMCB8fCBlICUgMik7CiAgICAgICAgICBpZiAocyA9PSAxIC8gMCkgewogICAgICAgICAgICBuID0gIjVlIiArIGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuID0gcy50b0V4cG9uZW50aWFsKCk7CiAgICAgICAgICAgIG4gPSBuLnNsaWNlKDAsIG4uaW5kZXhPZigiZSIpICsgMSkgKyBlOwogICAgICAgICAgfQogICAgICAgICAgcjIgPSBuZXcgQ3RvcihuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihzLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIHMgPSB3cHIgPSBwciArIDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICB0ID0gcjI7CiAgICAgICAgICByMiA9IHQucGx1cyhkaXZpZGUoeDIsIHQsIHdwciArIDIpKS50aW1lcygwLjUpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gKG4gPSBkaWdpdHNUb1N0cmluZyhyMi5kKSkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBuID0gbi5zbGljZSh3cHIgLSAzLCB3cHIgKyAxKTsKICAgICAgICAgICAgaWYgKHMgPT0gd3ByICYmIG4gPT0gIjQ5OTkiKSB7CiAgICAgICAgICAgICAgcm91bmQodCwgcHIgKyAxLCAwKTsKICAgICAgICAgICAgICBpZiAodC50aW1lcyh0KS5lcSh4MikpIHsKICAgICAgICAgICAgICAgIHIyID0gdDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChuICE9ICI5OTk5IikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdwciArPSA0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAudGltZXMgPSBQLm11bCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIGNhcnJ5LCBlLCBpLCBrLCByMiwgckwsIHQsIHhkTCwgeWRMLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgeGQgPSB4Mi5kLCB5ZCA9ICh5MiA9IG5ldyBDdG9yKHkyKSkuZDsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICB5Mi5zICo9IHgyLnM7CiAgICAgICAgZSA9IHgyLmUgKyB5Mi5lOwogICAgICAgIHhkTCA9IHhkLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5ZC5sZW5ndGg7CiAgICAgICAgaWYgKHhkTCA8IHlkTCkgewogICAgICAgICAgcjIgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IHIyOwogICAgICAgICAgckwgPSB4ZEw7CiAgICAgICAgICB4ZEwgPSB5ZEw7CiAgICAgICAgICB5ZEwgPSByTDsKICAgICAgICB9CiAgICAgICAgcjIgPSBbXTsKICAgICAgICByTCA9IHhkTCArIHlkTDsKICAgICAgICBmb3IgKGkgPSByTDsgaS0tOyApIHIyLnB1c2goMCk7CiAgICAgICAgZm9yIChpID0geWRMOyAtLWkgPj0gMDsgKSB7CiAgICAgICAgICBjYXJyeSA9IDA7CiAgICAgICAgICBmb3IgKGsgPSB4ZEwgKyBpOyBrID4gaTsgKSB7CiAgICAgICAgICAgIHQgPSByMltrXSArIHlkW2ldICogeGRbayAtIGkgLSAxXSArIGNhcnJ5OwogICAgICAgICAgICByMltrLS1dID0gdCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHQgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIHIyW2tdID0gKHIyW2tdICsgY2FycnkpICUgQkFTRSB8IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoOyAhcjJbLS1yTF07ICkgcjIucG9wKCk7CiAgICAgICAgaWYgKGNhcnJ5KSArK2U7CiAgICAgICAgZWxzZSByMi5zaGlmdCgpOwogICAgICAgIHkyLmQgPSByMjsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgQ3Rvci5wcmVjaXNpb24pIDogeTI7CiAgICAgIH07CiAgICAgIFAudG9EZWNpbWFsUGxhY2VzID0gUC50b2RwID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHgyID0gbmV3IEN0b3IoeDIpOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4geDI7CiAgICAgICAgY2hlY2tJbnQzMihkcCwgMCwgTUFYX0RJR0lUUyk7CiAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgIHJldHVybiByb3VuZCh4MiwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9FeHBvbmVudGlhbCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgICB4MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyAxLCBybSk7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSwgZHAgKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUC50b0ZpeGVkID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHN0ciwgeTIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4gdG9TdHJpbmcoeDIpOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB5MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgICAgc3RyID0gdG9TdHJpbmcoeTIuYWJzKCksIGZhbHNlLCBkcCArIGdldEJhc2UxMEV4cG9uZW50KHkyKSArIDEpOwogICAgICAgIHJldHVybiB4Mi5pc25lZygpICYmICF4Mi5pc1plcm8oKSA/ICItIiArIHN0ciA6IHN0cjsKICAgICAgfTsKICAgICAgUC50b0ludGVnZXIgPSBQLnRvaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDEsIEN0b3Iucm91bmRpbmcpOwogICAgICB9OwogICAgICBQLnRvTnVtYmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICt0aGlzOwogICAgICB9OwogICAgICBQLnRvUG93ZXIgPSBQLnBvdyA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIGUsIGssIHByLCByMiwgc2lnbjIsIHlJc0ludCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIGd1YXJkID0gMTIsIHluID0gKyh5MiA9IG5ldyBDdG9yKHkyKSk7CiAgICAgICAgaWYgKCF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoIXgyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkluZmluaXR5Iik7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4geDI7CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeTIuZXEoT05FKSkgcmV0dXJuIHJvdW5kKHgyLCBwcik7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgayA9IHkyLmQubGVuZ3RoIC0gMTsKICAgICAgICB5SXNJbnQgPSBlID49IGs7CiAgICAgICAgc2lnbjIgPSB4Mi5zOwogICAgICAgIGlmICgheUlzSW50KSB7CiAgICAgICAgICBpZiAoc2lnbjIgPCAwKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfSBlbHNlIGlmICgoayA9IHluIDwgMCA/IC15biA6IHluKSA8PSBNQVhfU0FGRV9JTlRFR0VSKSB7CiAgICAgICAgICByMiA9IG5ldyBDdG9yKE9ORSk7CiAgICAgICAgICBlID0gTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UgKyA0KTsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKGsgJSAyKSB7CiAgICAgICAgICAgICAgcjIgPSByMi50aW1lcyh4Mik7CiAgICAgICAgICAgICAgdHJ1bmNhdGUocjIuZCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgayA9IG1hdGhmbG9vcihrIC8gMik7CiAgICAgICAgICAgIGlmIChrID09PSAwKSBicmVhazsKICAgICAgICAgICAgeDIgPSB4Mi50aW1lcyh4Mik7CiAgICAgICAgICAgIHRydW5jYXRlKHgyLmQsIGUpOwogICAgICAgICAgfQogICAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHkyLnMgPCAwID8gbmV3IEN0b3IoT05FKS5kaXYocjIpIDogcm91bmQocjIsIHByKTsKICAgICAgICB9CiAgICAgICAgc2lnbjIgPSBzaWduMiA8IDAgJiYgeTIuZFtNYXRoLm1heChlLCBrKV0gJiAxID8gLTEgOiAxOwogICAgICAgIHgyLnMgPSAxOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcjIgPSB5Mi50aW1lcyhsbih4MiwgcHIgKyBndWFyZCkpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByMiA9IGV4cChyMik7CiAgICAgICAgcjIucyA9IHNpZ24yOwogICAgICAgIHJldHVybiByMjsKICAgICAgfTsKICAgICAgUC50b1ByZWNpc2lvbiA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciBlLCBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChzZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIGUgPD0gQ3Rvci50b0V4cE5lZyB8fCBlID49IEN0b3IudG9FeHBQb3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKHNkLCAxLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHNkIDw9IGUgfHwgZSA8PSBDdG9yLnRvRXhwTmVnLCBzZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9TaWduaWZpY2FudERpZ2l0cyA9IFAudG9zZCA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgc2QgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgc2QsIHJtKTsKICAgICAgfTsKICAgICAgUC50b1N0cmluZyA9IFAudmFsdWVPZiA9IFAudmFsID0gUC50b0pTT04gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYWRkKHgyLCB5MikgewogICAgICAgIHZhciBjYXJyeSwgZCwgZSwgaSwgaywgbGVuLCB4ZCwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICgheTIucykgeTIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgICAgfQogICAgICAgIHhkID0geDIuZDsKICAgICAgICB5ZCA9IHkyLmQ7CiAgICAgICAgayA9IHgyLmU7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgeGQgPSB4ZC5zbGljZSgpOwogICAgICAgIGkgPSBrIC0gZTsKICAgICAgICBpZiAoaSkgewogICAgICAgICAgaWYgKGkgPCAwKSB7CiAgICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgICAgaSA9IC1pOwogICAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkID0geWQ7CiAgICAgICAgICAgIGUgPSBrOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBrID0gTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpOwogICAgICAgICAgbGVuID0gayA+IGxlbiA/IGsgKyAxIDogbGVuICsgMTsKICAgICAgICAgIGlmIChpID4gbGVuKSB7CiAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGQubGVuZ3RoID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGQucmV2ZXJzZSgpOwogICAgICAgICAgZm9yICg7IGktLTsgKSBkLnB1c2goMCk7CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgIGkgPSB5ZC5sZW5ndGg7CiAgICAgICAgaWYgKGxlbiAtIGkgPCAwKSB7CiAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgZCA9IHlkOwogICAgICAgICAgeWQgPSB4ZDsKICAgICAgICAgIHhkID0gZDsKICAgICAgICB9CiAgICAgICAgZm9yIChjYXJyeSA9IDA7IGk7ICkgewogICAgICAgICAgY2FycnkgPSAoeGRbLS1pXSA9IHhkW2ldICsgeWRbaV0gKyBjYXJyeSkgLyBCQVNFIHwgMDsKICAgICAgICAgIHhkW2ldICU9IEJBU0U7CiAgICAgICAgfQogICAgICAgIGlmIChjYXJyeSkgewogICAgICAgICAgeGQudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICArK2U7CiAgICAgICAgfQogICAgICAgIGZvciAobGVuID0geGQubGVuZ3RoOyB4ZFstLWxlbl0gPT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICB5Mi5kID0geGQ7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrSW50MzIoaSwgbWluMiwgbWF4MikgewogICAgICAgIGlmIChpICE9PSB+fmkgfHwgaSA8IG1pbjIgfHwgaSA+IG1heDIpIHsKICAgICAgICAgIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIGkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBkaWdpdHNUb1N0cmluZyhkKSB7CiAgICAgICAgdmFyIGksIGssIHdzLCBpbmRleE9mTGFzdFdvcmQgPSBkLmxlbmd0aCAtIDEsIHN0ciA9ICIiLCB3ID0gZFswXTsKICAgICAgICBpZiAoaW5kZXhPZkxhc3RXb3JkID4gMCkgewogICAgICAgICAgc3RyICs9IHc7CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgaW5kZXhPZkxhc3RXb3JkOyBpKyspIHsKICAgICAgICAgICAgd3MgPSBkW2ldICsgIiI7CiAgICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGspIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgICBzdHIgKz0gd3M7CiAgICAgICAgICB9CiAgICAgICAgICB3ID0gZFtpXTsKICAgICAgICAgIHdzID0gdyArICIiOwogICAgICAgICAgayA9IExPR19CQVNFIC0gd3MubGVuZ3RoOwogICAgICAgICAgaWYgKGspIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSBpZiAodyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuICIwIjsKICAgICAgICB9CiAgICAgICAgZm9yICg7IHcgJSAxMCA9PT0gMDsgKSB3IC89IDEwOwogICAgICAgIHJldHVybiBzdHIgKyB3OwogICAgICB9CiAgICAgIHZhciBkaXZpZGUgPSAvKiBAX19QVVJFX18gKi8gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gbXVsdGlwbHlJbnRlZ2VyKHgyLCBrKSB7CiAgICAgICAgICB2YXIgdGVtcCwgY2FycnkgPSAwLCBpID0geDIubGVuZ3RoOwogICAgICAgICAgZm9yICh4MiA9IHgyLnNsaWNlKCk7IGktLTsgKSB7CiAgICAgICAgICAgIHRlbXAgPSB4MltpXSAqIGsgKyBjYXJyeTsKICAgICAgICAgICAgeDJbaV0gPSB0ZW1wICUgQkFTRSB8IDA7CiAgICAgICAgICAgIGNhcnJ5ID0gdGVtcCAvIEJBU0UgfCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNhcnJ5KSB4Mi51bnNoaWZ0KGNhcnJ5KTsKICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGFyZShhLCBiLCBhTCwgYkwpIHsKICAgICAgICAgIHZhciBpLCByMjsKICAgICAgICAgIGlmIChhTCAhPSBiTCkgewogICAgICAgICAgICByMiA9IGFMID4gYkwgPyAxIDogLTE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKGkgPSByMiA9IDA7IGkgPCBhTDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKGFbaV0gIT0gYltpXSkgewogICAgICAgICAgICAgICAgcjIgPSBhW2ldID4gYltpXSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJ0cmFjdDIoYSwgYiwgYUwpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBhTC0tOyApIHsKICAgICAgICAgICAgYVthTF0gLT0gaTsKICAgICAgICAgICAgaSA9IGFbYUxdIDwgYlthTF0gPyAxIDogMDsKICAgICAgICAgICAgYVthTF0gPSBpICogQkFTRSArIGFbYUxdIC0gYlthTF07CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgIWFbMF0gJiYgYS5sZW5ndGggPiAxOyApIGEuc2hpZnQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHgyLCB5MiwgcHIsIGRwKSB7CiAgICAgICAgICB2YXIgY21wLCBlLCBpLCBrLCBwcm9kLCBwcm9kTCwgcSwgcWQsIHJlbSwgcmVtTCwgcmVtMCwgc2QsIHQsIHhpLCB4TCwgeWQwLCB5TCwgeXosIEN0b3IgPSB4Mi5jb25zdHJ1Y3Rvciwgc2lnbjIgPSB4Mi5zID09IHkyLnMgPyAxIDogLTEsIHhkID0geDIuZCwgeWQgPSB5Mi5kOwogICAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoeDIpOwogICAgICAgICAgaWYgKCF5Mi5zKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiRGl2aXNpb24gYnkgemVybyIpOwogICAgICAgICAgZSA9IHgyLmUgLSB5Mi5lOwogICAgICAgICAgeUwgPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TCA9IHhkLmxlbmd0aDsKICAgICAgICAgIHEgPSBuZXcgQ3RvcihzaWduMik7CiAgICAgICAgICBxZCA9IHEuZCA9IFtdOwogICAgICAgICAgZm9yIChpID0gMDsgeWRbaV0gPT0gKHhkW2ldIHx8IDApOyApICsraTsKICAgICAgICAgIGlmICh5ZFtpXSA+ICh4ZFtpXSB8fCAwKSkgLS1lOwogICAgICAgICAgaWYgKHByID09IG51bGwpIHsKICAgICAgICAgICAgc2QgPSBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgICAgfSBlbHNlIGlmIChkcCkgewogICAgICAgICAgICBzZCA9IHByICsgKGdldEJhc2UxMEV4cG9uZW50KHgyKSAtIGdldEJhc2UxMEV4cG9uZW50KHkyKSkgKyAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2QgPSBwcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZCA8IDApIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHNkID0gc2QgLyBMT0dfQkFTRSArIDIgfCAwOwogICAgICAgICAgaSA9IDA7CiAgICAgICAgICBpZiAoeUwgPT0gMSkgewogICAgICAgICAgICBrID0gMDsKICAgICAgICAgICAgeWQgPSB5ZFswXTsKICAgICAgICAgICAgc2QrKzsKICAgICAgICAgICAgZm9yICg7IChpIDwgeEwgfHwgaykgJiYgc2QtLTsgaSsrKSB7CiAgICAgICAgICAgICAgdCA9IGsgKiBCQVNFICsgKHhkW2ldIHx8IDApOwogICAgICAgICAgICAgIHFkW2ldID0gdCAvIHlkIHwgMDsKICAgICAgICAgICAgICBrID0gdCAlIHlkIHwgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgayA9IEJBU0UgLyAoeWRbMF0gKyAxKSB8IDA7CiAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgIHlkID0gbXVsdGlwbHlJbnRlZ2VyKHlkLCBrKTsKICAgICAgICAgICAgICB4ZCA9IG11bHRpcGx5SW50ZWdlcih4ZCwgayk7CiAgICAgICAgICAgICAgeUwgPSB5ZC5sZW5ndGg7CiAgICAgICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGkgPSB5TDsKICAgICAgICAgICAgcmVtID0geGQuc2xpY2UoMCwgeUwpOwogICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgZm9yICg7IHJlbUwgPCB5TDsgKSByZW1bcmVtTCsrXSA9IDA7CiAgICAgICAgICAgIHl6ID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgeXoudW5zaGlmdCgwKTsKICAgICAgICAgICAgeWQwID0geWRbMF07CiAgICAgICAgICAgIGlmICh5ZFsxXSA+PSBCQVNFIC8gMikgKyt5ZDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBrID0gMDsKICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICBpZiAoY21wIDwgMCkgewogICAgICAgICAgICAgICAgcmVtMCA9IHJlbVswXTsKICAgICAgICAgICAgICAgIGlmICh5TCAhPSByZW1MKSByZW0wID0gcmVtMCAqIEJBU0UgKyAocmVtWzFdIHx8IDApOwogICAgICAgICAgICAgICAgayA9IHJlbTAgLyB5ZDAgfCAwOwogICAgICAgICAgICAgICAgaWYgKGsgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGlmIChrID49IEJBU0UpIGsgPSBCQVNFIC0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHByb2QsIHJlbSwgcHJvZEwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBrLS07CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHByb2QsIHlMIDwgcHJvZEwgPyB5eiA6IHlkLCBwcm9kTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChrID09IDApIGNtcCA9IGsgPSAxOwogICAgICAgICAgICAgICAgICBwcm9kID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAocHJvZEwgPCByZW1MKSBwcm9kLnVuc2hpZnQoMCk7CiAgICAgICAgICAgICAgICBzdWJ0cmFjdDIocmVtLCBwcm9kLCByZW1MKTsKICAgICAgICAgICAgICAgIGlmIChjbXAgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGNtcCA9IGNvbXBhcmUoeWQsIHJlbSwgeUwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wIDwgMSkgewogICAgICAgICAgICAgICAgICAgIGsrKzsKICAgICAgICAgICAgICAgICAgICBzdWJ0cmFjdDIocmVtLCB5TCA8IHJlbUwgPyB5eiA6IHlkLCByZW1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjbXAgPT09IDApIHsKICAgICAgICAgICAgICAgIGsrKzsKICAgICAgICAgICAgICAgIHJlbSA9IFswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcWRbaSsrXSA9IGs7CiAgICAgICAgICAgICAgaWYgKGNtcCAmJiByZW1bMF0pIHsKICAgICAgICAgICAgICAgIHJlbVtyZW1MKytdID0geGRbeGldIHx8IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlbSA9IFt4ZFt4aV1dOwogICAgICAgICAgICAgICAgcmVtTCA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICgoeGkrKyA8IHhMIHx8IHJlbVswXSAhPT0gdm9pZCAwKSAmJiBzZC0tKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcWRbMF0pIHFkLnNoaWZ0KCk7CiAgICAgICAgICBxLmUgPSBlOwogICAgICAgICAgcmV0dXJuIHJvdW5kKHEsIGRwID8gcHIgKyBnZXRCYXNlMTBFeHBvbmVudChxKSArIDEgOiBwcik7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICBmdW5jdGlvbiBleHAoeDIsIHNkKSB7CiAgICAgICAgdmFyIGRlbm9taW5hdG9yLCBndWFyZCwgcG93Miwgc3VtLCB0LCB3cHIsIGkgPSAwLCBrID0gMCwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmIChnZXRCYXNlMTBFeHBvbmVudCh4MikgPiAxNikgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcihPTkUpOwogICAgICAgIGlmIChzZCA9PSBudWxsKSB7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgd3ByID0gcHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdwciA9IHNkOwogICAgICAgIH0KICAgICAgICB0ID0gbmV3IEN0b3IoMC4wMzEyNSk7CiAgICAgICAgd2hpbGUgKHgyLmFicygpLmd0ZSgwLjEpKSB7CiAgICAgICAgICB4MiA9IHgyLnRpbWVzKHQpOwogICAgICAgICAgayArPSA1OwogICAgICAgIH0KICAgICAgICBndWFyZCA9IE1hdGgubG9nKG1hdGhwb3coMiwgaykpIC8gTWF0aC5MTjEwICogMiArIDUgfCAwOwogICAgICAgIHdwciArPSBndWFyZDsKICAgICAgICBkZW5vbWluYXRvciA9IHBvdzIgPSBzdW0gPSBuZXcgQ3RvcihPTkUpOwogICAgICAgIEN0b3IucHJlY2lzaW9uID0gd3ByOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgcG93MiA9IHJvdW5kKHBvdzIudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgZGVub21pbmF0b3IgPSBkZW5vbWluYXRvci50aW1lcygrK2kpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShwb3cyLCBkZW5vbWluYXRvciwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICB3aGlsZSAoay0tKSBzdW0gPSByb3VuZChzdW0udGltZXMoc3VtKSwgd3ByKTsKICAgICAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSBwcjsKICAgICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZChzdW0sIHByKSkgOiBzdW07CiAgICAgICAgICB9CiAgICAgICAgICBzdW0gPSB0OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRCYXNlMTBFeHBvbmVudCh4MikgewogICAgICAgIHZhciBlID0geDIuZSAqIExPR19CQVNFLCB3ID0geDIuZFswXTsKICAgICAgICBmb3IgKDsgdyA+PSAxMDsgdyAvPSAxMCkgZSsrOwogICAgICAgIHJldHVybiBlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldExuMTAoQ3Rvciwgc2QsIHByKSB7CiAgICAgICAgaWYgKHNkID4gQ3Rvci5MTjEwLnNkKCkpIHsKICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIGlmIChwcikgQ3Rvci5wcmVjaXNpb24gPSBwcjsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJMTjEwIHByZWNpc2lvbiBsaW1pdCBleGNlZWRlZCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoQ3Rvci5MTjEwKSwgc2QpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldFplcm9TdHJpbmcoaykgewogICAgICAgIHZhciB6cyA9ICIiOwogICAgICAgIGZvciAoOyBrLS07ICkgenMgKz0gIjAiOwogICAgICAgIHJldHVybiB6czsKICAgICAgfQogICAgICBmdW5jdGlvbiBsbih5Miwgc2QpIHsKICAgICAgICB2YXIgYywgYzAsIGRlbm9taW5hdG9yLCBlLCBudW1lcmF0b3IsIHN1bSwgdCwgd3ByLCB4MiwgbiA9IDEsIGd1YXJkID0gMTAsIHgzID0geTIsIHhkID0geDMuZCwgQ3RvciA9IHgzLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmICh4My5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgKHgzLnMgPyAiTmFOIiA6ICItSW5maW5pdHkiKSk7CiAgICAgICAgaWYgKHgzLmVxKE9ORSkpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgaWYgKHgzLmVxKDEwKSkgewogICAgICAgICAgaWYgKHNkID09IG51bGwpIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBnZXRMbjEwKEN0b3IsIHdwcik7CiAgICAgICAgfQogICAgICAgIHdwciArPSBndWFyZDsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBjID0gZGlnaXRzVG9TdHJpbmcoeGQpOwogICAgICAgIGMwID0gYy5jaGFyQXQoMCk7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgzKTsKICAgICAgICBpZiAoTWF0aC5hYnMoZSkgPCAxNWUxNCkgewogICAgICAgICAgd2hpbGUgKGMwIDwgNyAmJiBjMCAhPSAxIHx8IGMwID09IDEgJiYgYy5jaGFyQXQoMSkgPiAzKSB7CiAgICAgICAgICAgIHgzID0geDMudGltZXMoeTIpOwogICAgICAgICAgICBjID0gZGlnaXRzVG9TdHJpbmcoeDMuZCk7CiAgICAgICAgICAgIGMwID0gYy5jaGFyQXQoMCk7CiAgICAgICAgICAgIG4rKzsKICAgICAgICAgIH0KICAgICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgICBpZiAoYzAgPiAxKSB7CiAgICAgICAgICAgIHgzID0gbmV3IEN0b3IoIjAuIiArIGMpOwogICAgICAgICAgICBlKys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKGMwICsgIi4iICsgYy5zbGljZSgxKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQgPSBnZXRMbjEwKEN0b3IsIHdwciArIDIsIHByKS50aW1lcyhlICsgIiIpOwogICAgICAgICAgeDMgPSBsbihuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpLCB3cHIgLSBndWFyZCkucGx1cyh0KTsKICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHgzLCBwcikpIDogeDM7CiAgICAgICAgfQogICAgICAgIHN1bSA9IG51bWVyYXRvciA9IHgzID0gZGl2aWRlKHgzLm1pbnVzKE9ORSksIHgzLnBsdXMoT05FKSwgd3ByKTsKICAgICAgICB4MiA9IHJvdW5kKHgzLnRpbWVzKHgzKSwgd3ByKTsKICAgICAgICBkZW5vbWluYXRvciA9IDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICBudW1lcmF0b3IgPSByb3VuZChudW1lcmF0b3IudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShudW1lcmF0b3IsIG5ldyBDdG9yKGRlbm9taW5hdG9yKSwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBzdW0gPSBzdW0udGltZXMoMik7CiAgICAgICAgICAgIGlmIChlICE9PSAwKSBzdW0gPSBzdW0ucGx1cyhnZXRMbjEwKEN0b3IsIHdwciArIDIsIHByKS50aW1lcyhlICsgIiIpKTsKICAgICAgICAgICAgc3VtID0gZGl2aWRlKHN1bSwgbmV3IEN0b3IobiksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICAgIGRlbm9taW5hdG9yICs9IDI7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRGVjaW1hbCh4Miwgc3RyKSB7CiAgICAgICAgdmFyIGUsIGksIGxlbjsKICAgICAgICBpZiAoKGUgPSBzdHIuaW5kZXhPZigiLiIpKSA+IC0xKSBzdHIgPSBzdHIucmVwbGFjZSgiLiIsICIiKTsKICAgICAgICBpZiAoKGkgPSBzdHIuc2VhcmNoKC9lL2kpKSA+IDApIHsKICAgICAgICAgIGlmIChlIDwgMCkgZSA9IGk7CiAgICAgICAgICBlICs9ICtzdHIuc2xpY2UoaSArIDEpOwogICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCBpKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBlID0gc3RyLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgc3RyLmNoYXJDb2RlQXQoaSkgPT09IDQ4OyApICsraTsKICAgICAgICBmb3IgKGxlbiA9IHN0ci5sZW5ndGg7IHN0ci5jaGFyQ29kZUF0KGxlbiAtIDEpID09PSA0ODsgKSAtLWxlbjsKICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSwgbGVuKTsKICAgICAgICBpZiAoc3RyKSB7CiAgICAgICAgICBsZW4gLT0gaTsKICAgICAgICAgIGUgPSBlIC0gaSAtIDE7CiAgICAgICAgICB4Mi5lID0gbWF0aGZsb29yKGUgLyBMT0dfQkFTRSk7CiAgICAgICAgICB4Mi5kID0gW107CiAgICAgICAgICBpID0gKGUgKyAxKSAlIExPR19CQVNFOwogICAgICAgICAgaWYgKGUgPCAwKSBpICs9IExPR19CQVNFOwogICAgICAgICAgaWYgKGkgPCBsZW4pIHsKICAgICAgICAgICAgaWYgKGkpIHgyLmQucHVzaCgrc3RyLnNsaWNlKDAsIGkpKTsKICAgICAgICAgICAgZm9yIChsZW4gLT0gTE9HX0JBU0U7IGkgPCBsZW47ICkgeDIuZC5wdXNoKCtzdHIuc2xpY2UoaSwgaSArPSBMT0dfQkFTRSkpOwogICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSk7CiAgICAgICAgICAgIGkgPSBMT0dfQkFTRSAtIHN0ci5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpIC09IGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBpLS07ICkgc3RyICs9ICIwIjsKICAgICAgICAgIHgyLmQucHVzaCgrc3RyKTsKICAgICAgICAgIGlmIChleHRlcm5hbCAmJiAoeDIuZSA+IE1BWF9FIHx8IHgyLmUgPCAtTUFYX0UpKSB0aHJvdyBFcnJvcihleHBvbmVudE91dE9mUmFuZ2UgKyBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeDIucyA9IDA7CiAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgIHgyLmQgPSBbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiB4MjsKICAgICAgfQogICAgICBmdW5jdGlvbiByb3VuZCh4Miwgc2QsIHJtKSB7CiAgICAgICAgdmFyIGksIGosIGssIG4sIHJkLCBkb1JvdW5kLCB3LCB4ZGksIHhkID0geDIuZDsKICAgICAgICBmb3IgKG4gPSAxLCBrID0geGRbMF07IGsgPj0gMTA7IGsgLz0gMTApIG4rKzsKICAgICAgICBpID0gc2QgLSBuOwogICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBzZDsKICAgICAgICAgIHcgPSB4ZFt4ZGkgPSAwXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGRpID0gTWF0aC5jZWlsKChpICsgMSkgLyBMT0dfQkFTRSk7CiAgICAgICAgICBrID0geGQubGVuZ3RoOwogICAgICAgICAgaWYgKHhkaSA+PSBrKSByZXR1cm4geDI7CiAgICAgICAgICB3ID0gayA9IHhkW3hkaV07CiAgICAgICAgICBmb3IgKG4gPSAxOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgICBpICU9IExPR19CQVNFOwogICAgICAgICAgaiA9IGkgLSBMT0dfQkFTRSArIG47CiAgICAgICAgfQogICAgICAgIGlmIChybSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBrID0gbWF0aHBvdygxMCwgbiAtIGogLSAxKTsKICAgICAgICAgIHJkID0gdyAvIGsgJSAxMCB8IDA7CiAgICAgICAgICBkb1JvdW5kID0gc2QgPCAwIHx8IHhkW3hkaSArIDFdICE9PSB2b2lkIDAgfHwgdyAlIGs7CiAgICAgICAgICBkb1JvdW5kID0gcm0gPCA0ID8gKHJkIHx8IGRvUm91bmQpICYmIChybSA9PSAwIHx8IHJtID09ICh4Mi5zIDwgMCA/IDMgOiAyKSkgOiByZCA+IDUgfHwgcmQgPT0gNSAmJiAocm0gPT0gNCB8fCBkb1JvdW5kIHx8IHJtID09IDYgJiYgLy8gQ2hlY2sgd2hldGhlciB0aGUgZGlnaXQgdG8gdGhlIGxlZnQgb2YgdGhlIHJvdW5kaW5nIGRpZ2l0IGlzIG9kZC4KICAgICAgICAgIChpID4gMCA/IGogPiAwID8gdyAvIG1hdGhwb3coMTAsIG4gLSBqKSA6IDAgOiB4ZFt4ZGkgLSAxXSkgJSAxMCAmIDEgfHwgcm0gPT0gKHgyLnMgPCAwID8gOCA6IDcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNkIDwgMSB8fCAheGRbMF0pIHsKICAgICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICAgIGsgPSBnZXRCYXNlMTBFeHBvbmVudCh4Mik7CiAgICAgICAgICAgIHhkLmxlbmd0aCA9IDE7CiAgICAgICAgICAgIHNkID0gc2QgLSBrIC0gMTsKICAgICAgICAgICAgeGRbMF0gPSBtYXRocG93KDEwLCAoTE9HX0JBU0UgLSBzZCAlIExPR19CQVNFKSAlIExPR19CQVNFKTsKICAgICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcigtc2QgLyBMT0dfQkFTRSkgfHwgMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHhkLmxlbmd0aCA9IDE7CiAgICAgICAgICAgIHhkWzBdID0geDIuZSA9IHgyLnMgPSAwOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICB4ZC5sZW5ndGggPSB4ZGk7CiAgICAgICAgICBrID0gMTsKICAgICAgICAgIHhkaS0tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4ZC5sZW5ndGggPSB4ZGkgKyAxOwogICAgICAgICAgayA9IG1hdGhwb3coMTAsIExPR19CQVNFIC0gaSk7CiAgICAgICAgICB4ZFt4ZGldID0gaiA+IDAgPyAodyAvIG1hdGhwb3coMTAsIG4gLSBqKSAlIG1hdGhwb3coMTAsIGopIHwgMCkgKiBrIDogMDsKICAgICAgICB9CiAgICAgICAgaWYgKGRvUm91bmQpIHsKICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICBpZiAoeGRpID09IDApIHsKICAgICAgICAgICAgICBpZiAoKHhkWzBdICs9IGspID09IEJBU0UpIHsKICAgICAgICAgICAgICAgIHhkWzBdID0gMTsKICAgICAgICAgICAgICAgICsreDIuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgeGRbeGRpXSArPSBrOwogICAgICAgICAgICAgIGlmICh4ZFt4ZGldICE9IEJBU0UpIGJyZWFrOwogICAgICAgICAgICAgIHhkW3hkaS0tXSA9IDA7CiAgICAgICAgICAgICAgayA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChpID0geGQubGVuZ3RoOyB4ZFstLWldID09PSAwOyApIHhkLnBvcCgpOwogICAgICAgIGlmIChleHRlcm5hbCAmJiAoeDIuZSA+IE1BWF9FIHx8IHgyLmUgPCAtTUFYX0UpKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihleHBvbmVudE91dE9mUmFuZ2UgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3VidHJhY3QoeDIsIHkyKSB7CiAgICAgICAgdmFyIGQsIGUsIGksIGosIGssIGxlbiwgeGQsIHhlLCB4TFR5LCB5ZCwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmICgheDIucyB8fCAheTIucykgewogICAgICAgICAgaWYgKHkyLnMpIHkyLnMgPSAteTIuczsKICAgICAgICAgIGVsc2UgeTIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgICAgfQogICAgICAgIHhkID0geDIuZDsKICAgICAgICB5ZCA9IHkyLmQ7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgeGUgPSB4Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBrID0geGUgLSBlOwogICAgICAgIGlmIChrKSB7CiAgICAgICAgICB4TFR5ID0gayA8IDA7CiAgICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGsgPSAtazsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0geGU7CiAgICAgICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGkgPSBNYXRoLm1heChNYXRoLmNlaWwocHIgLyBMT0dfQkFTRSksIGxlbikgKyAyOwogICAgICAgICAgaWYgKGsgPiBpKSB7CiAgICAgICAgICAgIGsgPSBpOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoaSA9IGs7IGktLTsgKSBkLnB1c2goMCk7CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaSA9IHhkLmxlbmd0aDsKICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIHhMVHkgPSBpIDwgbGVuOwogICAgICAgICAgaWYgKHhMVHkpIGxlbiA9IGk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKHhkW2ldICE9IHlkW2ldKSB7CiAgICAgICAgICAgICAgeExUeSA9IHhkW2ldIDwgeWRbaV07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGsgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgZCA9IHhkOwogICAgICAgICAgeGQgPSB5ZDsKICAgICAgICAgIHlkID0gZDsKICAgICAgICAgIHkyLnMgPSAteTIuczsKICAgICAgICB9CiAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IHlkLmxlbmd0aCAtIGxlbjsgaSA+IDA7IC0taSkgeGRbbGVuKytdID0gMDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGg7IGkgPiBrOyApIHsKICAgICAgICAgIGlmICh4ZFstLWldIDwgeWRbaV0pIHsKICAgICAgICAgICAgZm9yIChqID0gaTsgaiAmJiB4ZFstLWpdID09PSAwOyApIHhkW2pdID0gQkFTRSAtIDE7CiAgICAgICAgICAgIC0teGRbal07CiAgICAgICAgICAgIHhkW2ldICs9IEJBU0U7CiAgICAgICAgICB9CiAgICAgICAgICB4ZFtpXSAtPSB5ZFtpXTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IHhkWy0tbGVuXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBmb3IgKDsgeGRbMF0gPT09IDA7IHhkLnNoaWZ0KCkpIC0tZTsKICAgICAgICBpZiAoIXhkWzBdKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0b1N0cmluZyh4MiwgaXNFeHAsIHNkKSB7CiAgICAgICAgdmFyIGssIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MiksIHN0ciA9IGRpZ2l0c1RvU3RyaW5nKHgyLmQpLCBsZW4gPSBzdHIubGVuZ3RoOwogICAgICAgIGlmIChpc0V4cCkgewogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBzdHIgPSBzdHIuY2hhckF0KDApICsgIi4iICsgc3RyLnNsaWNlKDEpICsgZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgIH0gZWxzZSBpZiAobGVuID4gMSkgewogICAgICAgICAgICBzdHIgPSBzdHIuY2hhckF0KDApICsgIi4iICsgc3RyLnNsaWNlKDEpOwogICAgICAgICAgfQogICAgICAgICAgc3RyID0gc3RyICsgKGUgPCAwID8gImUiIDogImUrIikgKyBlOwogICAgICAgIH0gZWxzZSBpZiAoZSA8IDApIHsKICAgICAgICAgIHN0ciA9ICIwLiIgKyBnZXRaZXJvU3RyaW5nKC1lIC0gMSkgKyBzdHI7CiAgICAgICAgICBpZiAoc2QgJiYgKGsgPSBzZCAtIGxlbikgPiAwKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPj0gbGVuKSB7CiAgICAgICAgICBzdHIgKz0gZ2V0WmVyb1N0cmluZyhlICsgMSAtIGxlbik7CiAgICAgICAgICBpZiAoc2QgJiYgKGsgPSBzZCAtIGUgLSAxKSA+IDApIHN0ciA9IHN0ciArICIuIiArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgoayA9IGUgKyAxKSA8IGxlbikgc3RyID0gc3RyLnNsaWNlKDAsIGspICsgIi4iICsgc3RyLnNsaWNlKGspOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBpZiAoZSArIDEgPT09IGxlbikgc3RyICs9ICIuIjsKICAgICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB4Mi5zIDwgMCA/ICItIiArIHN0ciA6IHN0cjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0cnVuY2F0ZShhcnIsIGxlbikgewogICAgICAgIGlmIChhcnIubGVuZ3RoID4gbGVuKSB7CiAgICAgICAgICBhcnIubGVuZ3RoID0gbGVuOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNsb25lKG9iaikgewogICAgICAgIHZhciBpLCBwLCBwczsKICAgICAgICBmdW5jdGlvbiBEZWNpbWFsNCh2YWx1ZSkgewogICAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICAgIGlmICghKHgyIGluc3RhbmNlb2YgRGVjaW1hbDQpKSByZXR1cm4gbmV3IERlY2ltYWw0KHZhbHVlKTsKICAgICAgICAgIHgyLmNvbnN0cnVjdG9yID0gRGVjaW1hbDQ7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEZWNpbWFsNCkgewogICAgICAgICAgICB4Mi5zID0gdmFsdWUuczsKICAgICAgICAgICAgeDIuZSA9IHZhbHVlLmU7CiAgICAgICAgICAgIHgyLmQgPSAodmFsdWUgPSB2YWx1ZS5kKSA/IHZhbHVlLnNsaWNlKCkgOiB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICogMCAhPT0gMCkgewogICAgICAgICAgICAgIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPiAwKSB7CiAgICAgICAgICAgICAgeDIucyA9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSAtdmFsdWU7CiAgICAgICAgICAgICAgeDIucyA9IC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgICAgIHgyLmUgPSAwOwogICAgICAgICAgICAgIHgyLmQgPSBbMF07CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gfn52YWx1ZSAmJiB2YWx1ZSA8IDFlNykgewogICAgICAgICAgICAgIHgyLmUgPSAwOwogICAgICAgICAgICAgIHgyLmQgPSBbdmFsdWVdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUuY2hhckNvZGVBdCgwKSA9PT0gNDUpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgxKTsKICAgICAgICAgICAgeDIucyA9IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDIucyA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZWNpbWFsLnRlc3QodmFsdWUpKSBwYXJzZURlY2ltYWwoeDIsIHZhbHVlKTsKICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBEZWNpbWFsNC5wcm90b3R5cGUgPSBQOwogICAgICAgIERlY2ltYWw0LlJPVU5EX1VQID0gMDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9ET1dOID0gMTsKICAgICAgICBEZWNpbWFsNC5ST1VORF9DRUlMID0gMjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9GTE9PUiA9IDM7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9VUCA9IDQ7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9ET1dOID0gNTsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0VWRU4gPSA2OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfQ0VJTCA9IDc7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9GTE9PUiA9IDg7CiAgICAgICAgRGVjaW1hbDQuY2xvbmUgPSBjbG9uZTsKICAgICAgICBEZWNpbWFsNC5jb25maWcgPSBEZWNpbWFsNC5zZXQgPSBjb25maWc7CiAgICAgICAgaWYgKG9iaiA9PT0gdm9pZCAwKSBvYmogPSB7fTsKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICBwcyA9IFsicHJlY2lzaW9uIiwgInJvdW5kaW5nIiwgInRvRXhwTmVnIiwgInRvRXhwUG9zIiwgIkxOMTAiXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7ICkgaWYgKCFvYmouaGFzT3duUHJvcGVydHkocCA9IHBzW2krK10pKSBvYmpbcF0gPSB0aGlzW3BdOwogICAgICAgIH0KICAgICAgICBEZWNpbWFsNC5jb25maWcob2JqKTsKICAgICAgICByZXR1cm4gRGVjaW1hbDQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29uZmlnKG9iaikgewogICAgICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiT2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgfQogICAgICAgIHZhciBpLCBwLCB2LCBwcyA9IFsKICAgICAgICAgICJwcmVjaXNpb24iLAogICAgICAgICAgMSwKICAgICAgICAgIE1BWF9ESUdJVFMsCiAgICAgICAgICAicm91bmRpbmciLAogICAgICAgICAgMCwKICAgICAgICAgIDgsCiAgICAgICAgICAidG9FeHBOZWciLAogICAgICAgICAgLTEgLyAwLAogICAgICAgICAgMCwKICAgICAgICAgICJ0b0V4cFBvcyIsCiAgICAgICAgICAwLAogICAgICAgICAgMSAvIDAKICAgICAgICBdOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgaWYgKCh2ID0gb2JqW3AgPSBwc1tpXV0pICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG1hdGhmbG9vcih2KSA9PT0gdiAmJiB2ID49IHBzW2kgKyAxXSAmJiB2IDw9IHBzW2kgKyAyXSkgdGhpc1twXSA9IHY7CiAgICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgcCArICI6ICIgKyB2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCh2ID0gb2JqW3AgPSAiTE4xMCJdKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAodiA9PSBNYXRoLkxOMTApIHRoaXNbcF0gPSBuZXcgdGhpcyh2KTsKICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgcCArICI6ICIgKyB2KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgRGVjaW1hbDMgPSBjbG9uZShEZWNpbWFsMyk7CiAgICAgIERlY2ltYWwzWyJkZWZhdWx0Il0gPSBEZWNpbWFsMy5EZWNpbWFsID0gRGVjaW1hbDM7CiAgICAgIE9ORSA9IG5ldyBEZWNpbWFsMygxKTsKICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIERlY2ltYWwzOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IERlY2ltYWwzOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghZ2xvYmFsU2NvcGUpIHsKICAgICAgICAgIGdsb2JhbFNjb3BlID0gdHlwZW9mIHNlbGYgIT0gInVuZGVmaW5lZCIgJiYgc2VsZiAmJiBzZWxmLnNlbGYgPT0gc2VsZiA/IHNlbGYgOiBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpOwogICAgICAgIH0KICAgICAgICBnbG9iYWxTY29wZS5EZWNpbWFsID0gRGVjaW1hbDM7CiAgICAgIH0KICAgIH0pKGV4cG9ydHMpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcwp2YXIgcmVxdWlyZV9ldmVudGVtaXR0ZXIzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBoYXMzID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBwcmVmaXggPSAifiI7CiAgICBmdW5jdGlvbiBFdmVudHMoKSB7CiAgICB9CiAgICBpZiAoT2JqZWN0LmNyZWF0ZSkgewogICAgICBFdmVudHMucHJvdG90eXBlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIGlmICghbmV3IEV2ZW50cygpLl9fcHJvdG9fXykgcHJlZml4ID0gZmFsc2U7CiAgICB9CiAgICBmdW5jdGlvbiBFRShmbiwgY29udGV4dCwgb25jZSkgewogICAgICB0aGlzLmZuID0gZm47CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIHRoaXMub25jZSA9IG9uY2UgfHwgZmFsc2U7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRMaXN0ZW5lcjIoZW1pdHRlciwgZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVyMiA9IG5ldyBFRShmbiwgY29udGV4dCB8fCBlbWl0dGVyLCBvbmNlKSwgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XSkgZW1pdHRlci5fZXZlbnRzW2V2dF0gPSBsaXN0ZW5lcjIsIGVtaXR0ZXIuX2V2ZW50c0NvdW50Kys7CiAgICAgIGVsc2UgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XS5mbikgZW1pdHRlci5fZXZlbnRzW2V2dF0ucHVzaChsaXN0ZW5lcjIpOwogICAgICBlbHNlIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gW2VtaXR0ZXIuX2V2ZW50c1tldnRdLCBsaXN0ZW5lcjJdOwogICAgICByZXR1cm4gZW1pdHRlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGNsZWFyRXZlbnQoZW1pdHRlciwgZXZ0KSB7CiAgICAgIGlmICgtLWVtaXR0ZXIuX2V2ZW50c0NvdW50ID09PSAwKSBlbWl0dGVyLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7CiAgICAgIGVsc2UgZGVsZXRlIGVtaXR0ZXIuX2V2ZW50c1tldnRdOwogICAgfQogICAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyMigpIHsKICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CiAgICB9CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5ldmVudE5hbWVzID0gZnVuY3Rpb24gZXZlbnROYW1lcygpIHsKICAgICAgdmFyIG5hbWVzID0gW10sIGV2ZW50cywgbmFtZTsKICAgICAgaWYgKHRoaXMuX2V2ZW50c0NvdW50ID09PSAwKSByZXR1cm4gbmFtZXM7CiAgICAgIGZvciAobmFtZSBpbiBldmVudHMgPSB0aGlzLl9ldmVudHMpIHsKICAgICAgICBpZiAoaGFzMy5jYWxsKGV2ZW50cywgbmFtZSkpIG5hbWVzLnB1c2gocHJlZml4ID8gbmFtZS5zbGljZSgxKSA6IG5hbWUpOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICAgICAgcmV0dXJuIG5hbWVzLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGV2ZW50cykpOwogICAgICB9CiAgICAgIHJldHVybiBuYW1lczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnQpIHsKICAgICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQsIGhhbmRsZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CiAgICAgIGlmICghaGFuZGxlcnMpIHJldHVybiBbXTsKICAgICAgaWYgKGhhbmRsZXJzLmZuKSByZXR1cm4gW2hhbmRsZXJzLmZuXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGgsIGVlID0gbmV3IEFycmF5KGwpOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZWVbaV0gPSBoYW5kbGVyc1tpXS5mbjsKICAgICAgfQogICAgICByZXR1cm4gZWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uIGxpc3RlbmVyQ291bnQoZXZlbnQpIHsKICAgICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQsIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIDA7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHJldHVybiAxOwogICAgICByZXR1cm4gbGlzdGVuZXJzLmxlbmd0aDsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdChldmVudCwgYTEsIGEyLCBhMywgYTQsIGE1KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwogICAgICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XSwgbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncywgaTsKICAgICAgaWYgKGxpc3RlbmVycy5mbikgewogICAgICAgIGlmIChsaXN0ZW5lcnMub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzLmZuLCB2b2lkIDAsIHRydWUpOwogICAgICAgIHN3aXRjaCAobGVuKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCksIHRydWU7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEpLCB0cnVlOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiksIHRydWU7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMyksIHRydWU7CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQpLCB0cnVlOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0LCBhNSksIHRydWU7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDEsIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICAgIGxpc3RlbmVycy5mbi5hcHBseShsaXN0ZW5lcnMuY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGgsIGo7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyc1tpXS5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICAgIHN3aXRjaCAobGVuKSB7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEsIGEyLCBhMyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSBmb3IgKGogPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbaiAtIDFdID0gYXJndW1lbnRzW2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uYXBwbHkobGlzdGVuZXJzW2ldLmNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIG9uKGV2ZW50LCBmbiwgY29udGV4dCkgewogICAgICByZXR1cm4gYWRkTGlzdGVuZXIyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgZmFsc2UpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiBvbmNlKGV2ZW50LCBmbiwgY29udGV4dCkgewogICAgICByZXR1cm4gYWRkTGlzdGVuZXIyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgdHJ1ZSk7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcjIoZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwogICAgICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFmbikgewogICAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLmZuID09PSBmbiAmJiAoIW9uY2UgfHwgbGlzdGVuZXJzLm9uY2UpICYmICghY29udGV4dCB8fCBsaXN0ZW5lcnMuY29udGV4dCA9PT0gY29udGV4dCkpIHsKICAgICAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50cyA9IFtdLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0uZm4gIT09IGZuIHx8IG9uY2UgJiYgIWxpc3RlbmVyc1tpXS5vbmNlIHx8IGNvbnRleHQgJiYgbGlzdGVuZXJzW2ldLmNvbnRleHQgIT09IGNvbnRleHQpIHsKICAgICAgICAgICAgZXZlbnRzLnB1c2gobGlzdGVuZXJzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHRoaXMuX2V2ZW50c1tldnRdID0gZXZlbnRzLmxlbmd0aCA9PT0gMSA/IGV2ZW50c1swXSA6IGV2ZW50czsKICAgICAgICBlbHNlIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnQpIHsKICAgICAgdmFyIGV2dDsKICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgICBpZiAodGhpcy5fZXZlbnRzW2V2dF0pIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7CiAgICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLm9mZiA9IEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyOwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbjsKICAgIEV2ZW50RW1pdHRlcjIucHJlZml4ZWQgPSBwcmVmaXg7CiAgICBFdmVudEVtaXR0ZXIyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjI7CiAgICBpZiAoInVuZGVmaW5lZCIgIT09IHR5cGVvZiBtb2R1bGUpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXIyOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMKdmFyIHJlcXVpcmVfbGFzdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyKSB7CiAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0FycmF5LmpzCnZhciByZXF1aXJlX3RvQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvQXJyYXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdG9BcnJheSh2YWx1ZSkgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IEFycmF5LmZyb20odmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0FycmF5ID0gdG9BcnJheTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBsYXN0JDEgPSByZXF1aXJlX2xhc3QoKTsKICAgIHZhciB0b0FycmF5ID0gcmVxdWlyZV90b0FycmF5KCk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICBmdW5jdGlvbiBsYXN0MihhcnJheSkgewogICAgICBpZiAoIWlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKGFycmF5KSkgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3QkMS5sYXN0KHRvQXJyYXkudG9BcnJheShhcnJheSkpOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9sYXN0MigpLmxhc3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzggPSByZXF1aXJlX3JlYWN0KCksIG9iamVjdElzID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIE9iamVjdC5pcyA/IE9iamVjdC5pcyA6IGlzNCwgdXNlU3luY0V4dGVybmFsU3RvcmUyID0gUmVhY3QzOC51c2VTeW5jRXh0ZXJuYWxTdG9yZSwgdXNlUmVmMTYgPSBSZWFjdDM4LnVzZVJlZiwgdXNlRWZmZWN0MTQgPSBSZWFjdDM4LnVzZUVmZmVjdCwgdXNlTWVtbzkgPSBSZWFjdDM4LnVzZU1lbW8sIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOC51c2VEZWJ1Z1ZhbHVlOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yID0gZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsKSB7CiAgICAgICAgdmFyIGluc3RSZWYgPSB1c2VSZWYxNihudWxsKTsKICAgICAgICBpZiAobnVsbCA9PT0gaW5zdFJlZi5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgaW5zdCA9IHsgaGFzVmFsdWU6IGZhbHNlLCB2YWx1ZTogbnVsbCB9OwogICAgICAgICAgaW5zdFJlZi5jdXJyZW50ID0gaW5zdDsKICAgICAgICB9IGVsc2UgaW5zdCA9IGluc3RSZWYuY3VycmVudDsKICAgICAgICBpbnN0UmVmID0gdXNlTWVtbzkoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZWRTZWxlY3RvcihuZXh0U25hcHNob3QpIHsKICAgICAgICAgICAgICBpZiAoIWhhc01lbW8pIHsKICAgICAgICAgICAgICAgIGhhc01lbW8gPSB0cnVlOwogICAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGluc3QuaGFzVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBpbnN0LnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRTZWxlY3Rpb24gPSBtZW1vaXplZFNlbGVjdGlvbjsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMobWVtb2l6ZWRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIHZhciBuZXh0U2VsZWN0aW9uID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNlbGVjdGlvbikpCiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdCwgY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTZWxlY3Rpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc01lbW8gPSBmYWxzZSwgbWVtb2l6ZWRTbmFwc2hvdCwgbWVtb2l6ZWRTZWxlY3Rpb24sIG1heWJlR2V0U2VydmVyU25hcHNob3QgPSB2b2lkIDAgPT09IGdldFNlcnZlclNuYXBzaG90ID8gbnVsbCA6IGdldFNlcnZlclNuYXBzaG90OwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IoZ2V0U25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBudWxsID09PSBtYXliZUdldFNlcnZlclNuYXBzaG90ID8gdm9pZCAwIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihtYXliZUdldFNlcnZlclNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICAgIH0sCiAgICAgICAgICBbZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbF0KICAgICAgICApOwogICAgICAgIHZhciB2YWx1ZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGluc3RSZWZbMF0sIGluc3RSZWZbMV0pOwogICAgICAgIHVzZUVmZmVjdDE0KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QuaGFzVmFsdWUgPSB0cnVlOwogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9LAogICAgICAgICAgW3ZhbHVlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzguX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkyKGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBzZWxmMiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZjIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICAgIGlmIChtYXliZUtleSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihtYXliZUtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgbWF5YmVLZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlICYmIHR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNShvYmplY3QpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG5hbWUgKyAiYC4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKHNvdXJjZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICAgIHZhciBsaW5lTnVtYmVyID0gc291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvID0gIlxuXG5DaGVjayB0aGUgdG9wLWxldmVsIHJlbmRlciBjYWxsIHVzaW5nIDwiICsgcGFyZW50TmFtZSArICI+LiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUV4cGxpY2l0S2V5KGVsZW1lbnQsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIG5vZGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0FycmF5Mihub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KGNoaWxkKSkgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNShub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BUeXBlcykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3BUeXBlcywgZWxlbWVudC5wcm9wcywgInByb3AiLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlLlByb3BUeXBlcyAhPT0gdm9pZCAwICYmICFwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgX25hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbXBvbmVudCAlcyBkZWNsYXJlZCBgUHJvcFR5cGVzYCBpbnN0ZWFkIG9mIGBwcm9wVHlwZXNgLiBEaWQgeW91IG1pc3NwZWxsIHRoZSBwcm9wZXJ0eSBhc3NpZ25tZW50PyIsIF9uYW1lIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLmdldERlZmF1bHRQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiAhdHlwZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIGlzIG9ubHkgdXNlZCBvbiBjbGFzc2ljIFJlYWN0LmNyZWF0ZUNsYXNzIGRlZmluaXRpb25zLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgbmFtZWQgYGRlZmF1bHRQcm9wc2AgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZnJhZ21lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmcmFnbWVudC5wcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIGlmIChrZXkgIT09ICJjaGlsZHJlbiIgJiYga2V5ICE9PSAia2V5IikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBwcm9wIGAlc2Agc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4gUmVhY3QuRnJhZ21lbnQgY2FuIG9ubHkgaGF2ZSBga2V5YCBhbmQgYGNoaWxkcmVuYCBwcm9wcy4iLCBrZXkpOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIGByZWZgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIik7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0S2V5U3ByZWFkID0ge307CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgaXNTdGF0aWNDaGlsZHJlbiwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gdm9pZCAwICYmIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmpzeDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganN4REVWKHR5cGUsIHByb3BzLCBrZXksIHNvdXJjZSwgc2VsZjIpOwogICAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIGlmIChjaGlsZHJlbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdGF0aWNDaGlsZHJlbikgewogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoY2hpbGRyZW5baV0sIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IFN0YXRpYyBjaGlsZHJlbiBzaG91bGQgYWx3YXlzIGJlIGFuIGFycmF5LiBZb3UgYXJlIGxpa2VseSBleHBsaWNpdGx5IGNhbGxpbmcgUmVhY3QuanN4cyBvciBSZWFjdC5qc3hERVYuIFVzZSB0aGUgQmFiZWwgdHJhbnNmb3JtIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3BzLCAia2V5IikpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcykuZmlsdGVyKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGsgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIHNyYy9tYWluLnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfY2xpZW50ID0gX190b0VTTShyZXF1aXJlX2NsaWVudCgpLCAxKTsKCi8vIHNyYy9NeUJ1ZGdldC50c3gKdmFyIGltcG9ydF9yZWFjdDUxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzCnZhciBpbXBvcnRfcmVhY3QyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzCnZhciB0b0tlYmFiQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAiJDEtJDIiKS50b0xvd2VyQ2FzZSgpOwp2YXIgdG9DYW1lbENhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgKICAvXihbQS1aXSl8W1xzLV9dKyhcdykvZywKICAobWF0Y2gsIHAxLCBwMikgPT4gcDIgPyBwMi50b1VwcGVyQ2FzZSgpIDogcDEudG9Mb3dlckNhc2UoKQopOwp2YXIgdG9QYXNjYWxDYXNlID0gKHN0cmluZykgPT4gewogIGNvbnN0IGNhbWVsQ2FzZSA9IHRvQ2FtZWxDYXNlKHN0cmluZyk7CiAgcmV0dXJuIGNhbWVsQ2FzZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNhbWVsQ2FzZS5zbGljZSgxKTsKfTsKdmFyIG1lcmdlQ2xhc3NlcyA9ICguLi5jbGFzc2VzKSA9PiBjbGFzc2VzLmZpbHRlcigoY2xhc3NOYW1lLCBpbmRleCwgYXJyYXkpID0+IHsKICByZXR1cm4gQm9vbGVhbihjbGFzc05hbWUpICYmIGNsYXNzTmFtZS50cmltKCkgIT09ICIiICYmIGFycmF5LmluZGV4T2YoY2xhc3NOYW1lKSA9PT0gaW5kZXg7Cn0pLmpvaW4oIiAiKS50cmltKCk7CnZhciBoYXNBMTF5UHJvcCA9IChwcm9wcykgPT4gewogIGZvciAoY29uc3QgcHJvcCBpbiBwcm9wcykgewogICAgaWYgKHByb3Auc3RhcnRzV2l0aCgiYXJpYS0iKSB8fCBwcm9wID09PSAicm9sZSIgfHwgcHJvcCA9PT0gInRpdGxlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIGltcG9ydF9yZWFjdCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanMKdmFyIGRlZmF1bHRBdHRyaWJ1dGVzID0gewogIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLAogIHdpZHRoOiAyNCwKICBoZWlnaHQ6IDI0LAogIHZpZXdCb3g6ICIwIDAgMjQgMjQiLAogIGZpbGw6ICJub25lIiwKICBzdHJva2U6ICJjdXJyZW50Q29sb3IiLAogIHN0cm9rZVdpZHRoOiAyLAogIHN0cm9rZUxpbmVjYXA6ICJyb3VuZCIsCiAgc3Ryb2tlTGluZWpvaW46ICJyb3VuZCIKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgSWNvbiA9ICgwLCBpbXBvcnRfcmVhY3QuZm9yd2FyZFJlZikoCiAgKHsKICAgIGNvbG9yOiBjb2xvcjIgPSAiY3VycmVudENvbG9yIiwKICAgIHNpemUgPSAyNCwKICAgIHN0cm9rZVdpZHRoID0gMiwKICAgIGFic29sdXRlU3Ryb2tlV2lkdGgsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIGNoaWxkcmVuLAogICAgaWNvbk5vZGUsCiAgICAuLi5yZXN0CiAgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKAogICAgInN2ZyIsCiAgICB7CiAgICAgIHJlZiwKICAgICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsCiAgICAgIHdpZHRoOiBzaXplLAogICAgICBoZWlnaHQ6IHNpemUsCiAgICAgIHN0cm9rZTogY29sb3IyLAogICAgICBzdHJva2VXaWR0aDogYWJzb2x1dGVTdHJva2VXaWR0aCA/IE51bWJlcihzdHJva2VXaWR0aCkgKiAyNCAvIE51bWJlcihzaXplKSA6IHN0cm9rZVdpZHRoLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygibHVjaWRlIiwgY2xhc3NOYW1lKSwKICAgICAgLi4uIWNoaWxkcmVuICYmICFoYXNBMTF5UHJvcChyZXN0KSAmJiB7ICJhcmlhLWhpZGRlbiI6ICJ0cnVlIiB9LAogICAgICAuLi5yZXN0CiAgICB9LAogICAgWwogICAgICAuLi5pY29uTm9kZS5tYXAoKFt0YWcsIGF0dHJzXSkgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSh0YWcsIGF0dHJzKSksCiAgICAgIC4uLkFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gY2hpbGRyZW4gOiBbY2hpbGRyZW5dCiAgICBdCiAgKQopOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzCnZhciBjcmVhdGVMdWNpZGVJY29uID0gKGljb25OYW1lLCBpY29uTm9kZSkgPT4gewogIGNvbnN0IENvbXBvbmVudCA9ICgwLCBpbXBvcnRfcmVhY3QyLmZvcndhcmRSZWYpKAogICAgKHsgY2xhc3NOYW1lLCAuLi5wcm9wcyB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QyLmNyZWF0ZUVsZW1lbnQpKEljb24sIHsKICAgICAgcmVmLAogICAgICBpY29uTm9kZSwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoCiAgICAgICAgYGx1Y2lkZS0ke3RvS2ViYWJDYXNlKHRvUGFzY2FsQ2FzZShpY29uTmFtZSkpfWAsCiAgICAgICAgYGx1Y2lkZS0ke2ljb25OYW1lfWAsCiAgICAgICAgY2xhc3NOYW1lCiAgICAgICksCiAgICAgIC4uLnByb3BzCiAgICB9KQogICk7CiAgQ29tcG9uZW50LmRpc3BsYXlOYW1lID0gdG9QYXNjYWxDYXNlKGljb25OYW1lKTsKICByZXR1cm4gQ29tcG9uZW50Owp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9hcnJvdy11cC1yaWdodC5qcwp2YXIgX19pY29uTm9kZSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNyA3aDEwdjEwIiwga2V5OiAiMXRpdm45IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNyAxNyAxNyA3Iiwga2V5OiAiMXZraXphIiB9XQpdOwp2YXIgQXJyb3dVcFJpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctdXAtcmlnaHQiLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDEyaDQiLCBrZXk6ICJhNTZiMHAiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA4aDQiLCBrZXk6ICIxc3IyYWYiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAyMXYtM2EyIDIgMCAwIDAtNCAwdjMiLCBrZXk6ICIxcmdpZWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDEwSDRhMiAyIDAgMCAwLTIgMnY3YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY5YTIgMiAwIDAgMC0yLTJoLTIiLAogICAgICBrZXk6ICJzZWNtaTIiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiAyMVY1YTIgMiAwIDAgMSAyLTJoOGEyIDIgMCAwIDEgMiAydjE2Iiwga2V5OiAiMTZyYTB0IiB9XQpdOwp2YXIgQnVpbGRpbmcyID0gY3JlYXRlTHVjaWRlSWNvbigiYnVpbGRpbmctMiIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanMKdmFyIF9faWNvbk5vZGUzID0gW1sicGF0aCIsIHsgZDogIk0yMCA2IDkgMTdsLTUtNSIsIGtleTogIjFnbWYyYyIgfV1dOwp2YXIgQ2hlY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGVjayIsIF9faWNvbk5vZGUzKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzCnZhciBfX2ljb25Ob2RlNCA9IFtbInBhdGgiLCB7IGQ6ICJtNiA5IDYgNiA2LTYiLCBrZXk6ICJxcnVuc2wiIH1dXTsKdmFyIENoZXZyb25Eb3duID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi1kb3duIiwgX19pY29uTm9kZTQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzCnZhciBfX2ljb25Ob2RlNSA9IFtbInBhdGgiLCB7IGQ6ICJtMTggMTUtNi02LTYgNiIsIGtleTogIjE1M3VkeiIgfV1dOwp2YXIgQ2hldnJvblVwID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi11cCIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2xvY2suanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMiA2djZsNCAyIiwga2V5OiAibW1rN3lnIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxMiIsIGN5OiAiMTIiLCByOiAiMTAiLCBrZXk6ICIxbWdsYXkiIH1dCl07CnZhciBDbG9jayA9IGNyZWF0ZUx1Y2lkZUljb24oImNsb2NrIiwgX19pY29uTm9kZTYpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9kb2xsYXItc2lnbi5qcwp2YXIgX19pY29uTm9kZTcgPSBbCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiMiIsIHkyOiAiMjIiLCBrZXk6ICI3ZXF5cWgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNyA1SDkuNWEzLjUgMy41IDAgMCAwIDAgN2g1YTMuNSAzLjUgMCAwIDEgMCA3SDYiLCBrZXk6ICIxYjBwNHMiIH1dCl07CnZhciBEb2xsYXJTaWduID0gY3JlYXRlTHVjaWRlSWNvbigiZG9sbGFyLXNpZ24iLCBfX2ljb25Ob2RlNyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2dyaXAtdmVydGljYWwuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdmN0Z2YiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjUiLCByOiAiMSIsIGtleTogImhwMHRjZiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiOSIsIGN5OiAiMTkiLCByOiAiMSIsIGtleTogImZrampmNiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTUiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdG1haWoiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICI1IiwgcjogIjEiLCBrZXk6ICIxOWwyOGUiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICIxOSIsIHI6ICIxIiwga2V5OiAiZjR6b2ozIiB9XQpdOwp2YXIgR3JpcFZlcnRpY2FsID0gY3JlYXRlTHVjaWRlSWNvbigiZ3JpcC12ZXJ0aWNhbCIsIF9faWNvbk5vZGU4KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGU5ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yIDkuNWE1LjUgNS41IDAgMCAxIDkuNTkxLTMuNjc2LjU2LjU2IDAgMCAwIC44MTggMEE1LjQ5IDUuNDkgMCAwIDEgMjIgOS41YzAgMi4yOS0xLjUgNC0zIDUuNWwtNS40OTIgNS4zMTNhMiAyIDAgMCAxLTMgLjAxOUw1IDE1Yy0xLjUtMS41LTMtMy4yLTMtNS41IiwKICAgICAga2V5OiAibXZyMWEwIgogICAgfQogIF0KXTsKdmFyIEhlYXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiaGVhcnQiLCBfX2ljb25Ob2RlOSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2hvdXNlLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE1IDIxdi04YTEgMSAwIDAgMC0xLTFoLTRhMSAxIDAgMCAwLTEgMXY4Iiwga2V5OiAiNXd3bHI1IiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMyAxMGEyIDIgMCAwIDEgLjcwOS0xLjUyOGw3LTZhMiAyIDAgMCAxIDIuNTgyIDBsNyA2QTIgMiAwIDAgMSAyMSAxMHY5YTIgMiAwIDAgMS0yIDJINWEyIDIgMCAwIDEtMi0yeiIsCiAgICAgIGtleTogInI2bnNzMSIKICAgIH0KICBdCl07CnZhciBIb3VzZSA9IGNyZWF0ZUx1Y2lkZUljb24oImhvdXNlIiwgX19pY29uTm9kZTEwKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbGFuZG1hcmsuanMKdmFyIF9faWNvbk5vZGUxMSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTAgMTh2LTciLCBrZXk6ICJ3dDExNmIiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xMS4xMiAyLjE5OGEyIDIgMCAwIDEgMS43Ni4wMDZsNy44NjYgMy44NDdjLjQ3Ni4yMzMuMzEuOTQ5LS4yMi45NDlIMy40NzRjLS41MyAwLS42OTUtLjcxNi0uMjItLjk0OXoiLAogICAgICBrZXk6ICIxbTMyOW0iCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTQgMTh2LTciLCBrZXk6ICJ2YXY2dDMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xOCAxOHYtNyIsIGtleTogImFleGRtaiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgMjJoMTgiLCBrZXk6ICI4cHJyNDUiIH1dLAogIFsicGF0aCIsIHsgZDogIk02IDE4di03Iiwga2V5OiAiMWl2ZmxrIiB9XQpdOwp2YXIgTGFuZG1hcmsgPSBjcmVhdGVMdWNpZGVJY29uKCJsYW5kbWFyayIsIF9faWNvbk5vZGUxMSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci1jaXJjbGUuanMKdmFyIF9faWNvbk5vZGUxMiA9IFtbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMSAxLTYuMjE5LTguNTYiLCBrZXk6ICIxM3phbGQiIH1dXTsKdmFyIExvYWRlckNpcmNsZSA9IGNyZWF0ZUx1Y2lkZUljb24oImxvYWRlci1jaXJjbGUiLCBfX2ljb25Ob2RlMTIpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzCnZhciBfX2ljb25Ob2RlMTMgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC45OTEgNS43MjdhMiAyIDAgMCAxLTIuMDA5IDBMMiA3Iiwga2V5OiAiMTMycTdxIiB9XSwKICBbInJlY3QiLCB7IHg6ICIyIiwgeTogIjQiLCB3aWR0aDogIjIwIiwgaGVpZ2h0OiAiMTYiLCByeDogIjIiLCBrZXk6ICJpenhsYW8iIH1dCl07CnZhciBNYWlsID0gY3JlYXRlTHVjaWRlSWNvbigibWFpbCIsIF9faWNvbk5vZGUxMyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21lc3NhZ2Utc3F1YXJlLmpzCnZhciBfX2ljb25Ob2RlMTQgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIyIDE3YTIgMiAwIDAgMS0yIDJINi44MjhhMiAyIDAgMCAwLTEuNDE0LjU4NmwtMi4yMDIgMi4yMDJBLjcxLjcxIDAgMCAxIDIgMjEuMjg2VjVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAyeiIsCiAgICAgIGtleTogIjE4ODg3cCIKICAgIH0KICBdCl07CnZhciBNZXNzYWdlU3F1YXJlID0gY3JlYXRlTHVjaWRlSWNvbigibWVzc2FnZS1zcXVhcmUiLCBfX2ljb25Ob2RlMTQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wZW4uanMKdmFyIF9faWNvbk5vZGUxNSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMjEuMTc0IDYuODEyYTEgMSAwIDAgMC0zLjk4Ni0zLjk4N0wzLjg0MiAxNi4xNzRhMiAyIDAgMCAwLS41LjgzbC0xLjMyMSA0LjM1MmEuNS41IDAgMCAwIC42MjMuNjIybDQuMzUzLTEuMzJhMiAyIDAgMCAwIC44My0uNDk3eiIsCiAgICAgIGtleTogIjFhOHVzdSIKICAgIH0KICBdCl07CnZhciBQZW4gPSBjcmVhdGVMdWNpZGVJY29uKCJwZW4iLCBfX2ljb25Ob2RlMTUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9waWdneS1iYW5rLmpzCnZhciBfX2ljb25Ob2RlMTYgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTExIDE3aDN2MmExIDEgMCAwIDAgMSAxaDJhMSAxIDAgMCAwIDEtMXYtM2EzLjE2IDMuMTYgMCAwIDAgMi0yaDFhMSAxIDAgMCAwIDEtMXYtMmExIDEgMCAwIDAtMS0xaC0xYTUgNSAwIDAgMC0yLTRWM2E0IDQgMCAwIDAtMy4yIDEuNmwtLjMuNEgxMWE2IDYgMCAwIDAtNiA2djFhNSA1IDAgMCAwIDIgNHYzYTEgMSAwIDAgMCAxIDFoMmExIDEgMCAwIDAgMS0xeiIsCiAgICAgIGtleTogIjFwaWdsYyIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xNiAxMGguMDEiLCBrZXk6ICIxbTk0d3oiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yIDh2MWEyIDIgMCAwIDAgMiAyaDEiLCBrZXk6ICIxZW52NDMiIH1dCl07CnZhciBQaWdneUJhbmsgPSBjcmVhdGVMdWNpZGVJY29uKCJwaWdneS1iYW5rIiwgX19pY29uTm9kZTE2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qcwp2YXIgX19pY29uTm9kZTE3ID0gWwogIFsicGF0aCIsIHsgZDogIk01IDEyaDE0Iiwga2V5OiAiMWF5czBoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgNXYxNCIsIGtleTogInM2OTlsZSIgfV0KXTsKdmFyIFBsdXMgPSBjcmVhdGVMdWNpZGVJY29uKCJwbHVzIiwgX19pY29uTm9kZTE3KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcHJpbnRlci5qcwp2YXIgX19pY29uTm9kZTE4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDE4SDRhMiAyIDAgMCAxLTItMnYtNWEyIDIgMCAwIDEgMi0yaDE2YTIgMiAwIDAgMSAyIDJ2NWEyIDIgMCAwIDEtMiAyaC0yIiwKICAgICAga2V5OiAiMTQzd3lkIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTYgOVYzYTEgMSAwIDAgMSAxLTFoMTBhMSAxIDAgMCAxIDEgMXY2Iiwga2V5OiAiMWl0bmU3IiB9XSwKICBbInJlY3QiLCB7IHg6ICI2IiwgeTogIjE0Iiwgd2lkdGg6ICIxMiIsIGhlaWdodDogIjgiLCByeDogIjEiLCBrZXk6ICIxdWUwdGciIH1dCl07CnZhciBQcmludGVyID0gY3JlYXRlTHVjaWRlSWNvbigicHJpbnRlciIsIF9faWNvbk5vZGUxOCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanMKdmFyIF9faWNvbk5vZGUxOSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMyAxMmE5IDkgMCAwIDEgOS05IDkuNzUgOS43NSAwIDAgMSA2Ljc0IDIuNzRMMjEgOCIsIGtleTogInY5aDV2YyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIxIDN2NWgtNSIsIGtleTogIjFxN3RvMCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIxIDEyYTkgOSAwIDAgMS05IDkgOS43NSA5Ljc1IDAgMCAxLTYuNzQtMi43NEwzIDE2Iiwga2V5OiAiM3VpZmwzIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCAxNkgzdjUiLCBrZXk6ICIxY3Y2NzgiIH1dCl07CnZhciBSZWZyZXNoQ3cgPSBjcmVhdGVMdWNpZGVJY29uKCJyZWZyZXNoLWN3IiwgX19pY29uTm9kZTE5KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qcwp2YXIgX19pY29uTm9kZTIwID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDEgMCA5LTkgOS43NSA5Ljc1IDAgMCAwLTYuNzQgMi43NEwzIDgiLCBrZXk6ICIxMzU3ZTMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDN2NWg1Iiwga2V5OiAiMXhocThhIiB9XQpdOwp2YXIgUm90YXRlQ2N3ID0gY3JlYXRlTHVjaWRlSWNvbigicm90YXRlLWNjdyIsIF9faWNvbk5vZGUyMCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NhdmUuanMKdmFyIF9faWNvbk5vZGUyMSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTUuMiAzYTIgMiAwIDAgMSAxLjQuNmwzLjggMy44YTIgMiAwIDAgMSAuNiAxLjRWMTlhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJWNWEyIDIgMCAwIDEgMi0yeiIsCiAgICAgIGtleTogIjFjODQ3NiIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xNyAyMXYtN2ExIDEgMCAwIDAtMS0xSDhhMSAxIDAgMCAwLTEgMXY3Iiwga2V5OiAiMXlkdG9zIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNyAzdjRhMSAxIDAgMCAwIDEgMWg3Iiwga2V5OiAidDUxdTczIiB9XQpdOwp2YXIgU2F2ZSA9IGNyZWF0ZUx1Y2lkZUljb24oInNhdmUiLCBfX2ljb25Ob2RlMjEpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zZWFyY2guanMKdmFyIF9faWNvbk5vZGUyMiA9IFsKICBbInBhdGgiLCB7IGQ6ICJtMjEgMjEtNC4zNC00LjM0Iiwga2V5OiAiMTRqN3JqIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxMSIsIGN5OiAiMTEiLCByOiAiOCIsIGtleTogIjRlajk3dSIgfV0KXTsKdmFyIFNlYXJjaCA9IGNyZWF0ZUx1Y2lkZUljb24oInNlYXJjaCIsIF9faWNvbk5vZGUyMik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy1kb3duLmpzCnZhciBfX2ljb25Ob2RlMjMgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE3IDE0VjIiLCBrZXk6ICI4eW1xbmsiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk05IDE4LjEyIDEwIDE0SDQuMTdhMiAyIDAgMCAxLTEuOTItMi41NmwyLjMzLThBMiAyIDAgMCAxIDYuNSAySDIwYTIgMiAwIDAgMSAyIDJ2OGEyIDIgMCAwIDEtMiAyaC0yLjc2YTIgMiAwIDAgMC0xLjc5IDEuMTFMMTIgMjJhMy4xMyAzLjEzIDAgMCAxLTMtMy44OFoiLAogICAgICBrZXk6ICJtNjFtNzciCiAgICB9CiAgXQpdOwp2YXIgVGh1bWJzRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oInRodW1icy1kb3duIiwgX19pY29uTm9kZTIzKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLXVwLmpzCnZhciBfX2ljb25Ob2RlMjQgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTcgMTB2MTIiLCBrZXk6ICIxcWM5M24iIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xNSA1Ljg4IDE0IDEwaDUuODNhMiAyIDAgMCAxIDEuOTIgMi41NmwtMi4zMyA4QTIgMiAwIDAgMSAxNy41IDIySDRhMiAyIDAgMCAxLTItMnYtOGEyIDIgMCAwIDEgMi0yaDIuNzZhMiAyIDAgMCAwIDEuNzktMS4xMUwxMiAyYTMuMTMgMy4xMyAwIDAgMSAzIDMuODhaIiwKICAgICAga2V5OiAiZW1tbWNyIgogICAgfQogIF0KXTsKdmFyIFRodW1ic1VwID0gY3JlYXRlTHVjaWRlSWNvbigidGh1bWJzLXVwIiwgX19pY29uTm9kZTI0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qcwp2YXIgX19pY29uTm9kZTI1ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMCAxMXY2Iiwga2V5OiAibmNvMG9tIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTQgMTF2NiIsIGtleTogIm91dHYxdSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE5IDZ2MTRhMiAyIDAgMCAxLTIgMkg3YTIgMiAwIDAgMS0yLTJWNiIsIGtleTogIm1peXRyYyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgNmgxOCIsIGtleTogImQwd20waiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTggNlY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiLCBrZXk6ICJlNzkxamkiIH1dCl07CnZhciBUcmFzaDIgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmFzaC0yIiwgX19pY29uTm9kZTI1KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJlbmRpbmctZG93bi5qcwp2YXIgX19pY29uTm9kZTI2ID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiAxN2g2di02Iiwga2V5OiAidDZuMml0IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMjIgMTctOC41LTguNS01IDVMMiA3Iiwga2V5OiAieDQ3M3AiIH1dCl07CnZhciBUcmVuZGluZ0Rvd24gPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmVuZGluZy1kb3duIiwgX19pY29uTm9kZTI2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJlbmRpbmctdXAuanMKdmFyIF9faWNvbk5vZGUyNyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTYgN2g2djYiLCBrZXk6ICJib3g1NWwiIH1dLAogIFsicGF0aCIsIHsgZDogIm0yMiA3LTguNSA4LjUtNS01TDIgMTciLCBrZXk6ICIxdDFtNzkiIH1dCl07CnZhciBUcmVuZGluZ1VwID0gY3JlYXRlTHVjaWRlSWNvbigidHJlbmRpbmctdXAiLCBfX2ljb25Ob2RlMjcpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmlhbmdsZS1hbGVydC5qcwp2YXIgX19pY29uTm9kZTI4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIm0yMS43MyAxOC04LTE0YTIgMiAwIDAgMC0zLjQ4IDBsLTggMTRBMiAyIDAgMCAwIDQgMjFoMTZhMiAyIDAgMCAwIDEuNzMtMyIsCiAgICAgIGtleTogIndtb2VucSIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xMiA5djQiLCBrZXk6ICJqdXpwdTciIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiAxN2guMDEiLCBrZXk6ICJwMzJwMDUiIH1dCl07CnZhciBUcmlhbmdsZUFsZXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigidHJpYW5nbGUtYWxlcnQiLCBfX2ljb25Ob2RlMjgpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy93YWxsZXQuanMKdmFyIF9faWNvbk5vZGUyOSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTkgN1Y0YTEgMSAwIDAgMC0xLTFINWEyIDIgMCAwIDAgMCA0aDE1YTEgMSAwIDAgMSAxIDF2NGgtM2EyIDIgMCAwIDAgMCA0aDNhMSAxIDAgMCAwIDEtMXYtMmExIDEgMCAwIDAtMS0xIiwKICAgICAga2V5OiAiMThldGI2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgNXYxNGEyIDIgMCAwIDAgMiAyaDE1YTEgMSAwIDAgMCAxLTF2LTQiLCBrZXk6ICJ4b2MwcTQiIH1dCl07CnZhciBXYWxsZXQgPSBjcmVhdGVMdWNpZGVJY29uKCJ3YWxsZXQiLCBfX2ljb25Ob2RlMjkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy94LmpzCnZhciBfX2ljb25Ob2RlMzAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE4IDYgNiAxOCIsIGtleTogIjFibDVmOCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTYgNiAxMiAxMiIsIGtleTogImQ4Yms2diIgfV0KXTsKdmFyIFggPSBjcmVhdGVMdWNpZGVJY29uKCJ4IiwgX19pY29uTm9kZTMwKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1N1cmZhY2UuanMKdmFyIFJlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9jbHN4L2Rpc3QvY2xzeC5tanMKZnVuY3Rpb24gcihlKSB7CiAgdmFyIHQsIGYsIG4gPSAiIjsKICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUgfHwgIm51bWJlciIgPT0gdHlwZW9mIGUpIG4gKz0gZTsKICBlbHNlIGlmICgib2JqZWN0IiA9PSB0eXBlb2YgZSkgaWYgKEFycmF5LmlzQXJyYXkoZSkpIHsKICAgIHZhciBvID0gZS5sZW5ndGg7CiAgICBmb3IgKHQgPSAwOyB0IDwgbzsgdCsrKSBlW3RdICYmIChmID0gcihlW3RdKSkgJiYgKG4gJiYgKG4gKz0gIiAiKSwgbiArPSBmKTsKICB9IGVsc2UgZm9yIChmIGluIGUpIGVbZl0gJiYgKG4gJiYgKG4gKz0gIiAiKSwgbiArPSBmKTsKICByZXR1cm4gbjsKfQpmdW5jdGlvbiBjbHN4KCkgewogIGZvciAodmFyIGUsIHQsIGYgPSAwLCBuID0gIiIsIG8gPSBhcmd1bWVudHMubGVuZ3RoOyBmIDwgbzsgZisrKSAoZSA9IGFyZ3VtZW50c1tmXSkgJiYgKHQgPSByKGUpKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IHQpOwogIHJldHVybiBuOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc0FuZEV2ZW50cy5qcwp2YXIgaW1wb3J0X3JlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9leGNsdWRlRXZlbnRQcm9wcy5qcwp2YXIgRXZlbnRLZXlzID0gWyJkYW5nZXJvdXNseVNldElubmVySFRNTCIsICJvbkNvcHkiLCAib25Db3B5Q2FwdHVyZSIsICJvbkN1dCIsICJvbkN1dENhcHR1cmUiLCAib25QYXN0ZSIsICJvblBhc3RlQ2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uRW5kIiwgIm9uQ29tcG9zaXRpb25FbmRDYXB0dXJlIiwgIm9uQ29tcG9zaXRpb25TdGFydCIsICJvbkNvbXBvc2l0aW9uU3RhcnRDYXB0dXJlIiwgIm9uQ29tcG9zaXRpb25VcGRhdGUiLCAib25Db21wb3NpdGlvblVwZGF0ZUNhcHR1cmUiLCAib25Gb2N1cyIsICJvbkZvY3VzQ2FwdHVyZSIsICJvbkJsdXIiLCAib25CbHVyQ2FwdHVyZSIsICJvbkNoYW5nZSIsICJvbkNoYW5nZUNhcHR1cmUiLCAib25CZWZvcmVJbnB1dCIsICJvbkJlZm9yZUlucHV0Q2FwdHVyZSIsICJvbklucHV0IiwgIm9uSW5wdXRDYXB0dXJlIiwgIm9uUmVzZXQiLCAib25SZXNldENhcHR1cmUiLCAib25TdWJtaXQiLCAib25TdWJtaXRDYXB0dXJlIiwgIm9uSW52YWxpZCIsICJvbkludmFsaWRDYXB0dXJlIiwgIm9uTG9hZCIsICJvbkxvYWRDYXB0dXJlIiwgIm9uRXJyb3IiLCAib25FcnJvckNhcHR1cmUiLCAib25LZXlEb3duIiwgIm9uS2V5RG93bkNhcHR1cmUiLCAib25LZXlQcmVzcyIsICJvbktleVByZXNzQ2FwdHVyZSIsICJvbktleVVwIiwgIm9uS2V5VXBDYXB0dXJlIiwgIm9uQWJvcnQiLCAib25BYm9ydENhcHR1cmUiLCAib25DYW5QbGF5IiwgIm9uQ2FuUGxheUNhcHR1cmUiLCAib25DYW5QbGF5VGhyb3VnaCIsICJvbkNhblBsYXlUaHJvdWdoQ2FwdHVyZSIsICJvbkR1cmF0aW9uQ2hhbmdlIiwgIm9uRHVyYXRpb25DaGFuZ2VDYXB0dXJlIiwgIm9uRW1wdGllZCIsICJvbkVtcHRpZWRDYXB0dXJlIiwgIm9uRW5jcnlwdGVkIiwgIm9uRW5jcnlwdGVkQ2FwdHVyZSIsICJvbkVuZGVkIiwgIm9uRW5kZWRDYXB0dXJlIiwgIm9uTG9hZGVkRGF0YSIsICJvbkxvYWRlZERhdGFDYXB0dXJlIiwgIm9uTG9hZGVkTWV0YWRhdGEiLCAib25Mb2FkZWRNZXRhZGF0YUNhcHR1cmUiLCAib25Mb2FkU3RhcnQiLCAib25Mb2FkU3RhcnRDYXB0dXJlIiwgIm9uUGF1c2UiLCAib25QYXVzZUNhcHR1cmUiLCAib25QbGF5IiwgIm9uUGxheUNhcHR1cmUiLCAib25QbGF5aW5nIiwgIm9uUGxheWluZ0NhcHR1cmUiLCAib25Qcm9ncmVzcyIsICJvblByb2dyZXNzQ2FwdHVyZSIsICJvblJhdGVDaGFuZ2UiLCAib25SYXRlQ2hhbmdlQ2FwdHVyZSIsICJvblNlZWtlZCIsICJvblNlZWtlZENhcHR1cmUiLCAib25TZWVraW5nIiwgIm9uU2Vla2luZ0NhcHR1cmUiLCAib25TdGFsbGVkIiwgIm9uU3RhbGxlZENhcHR1cmUiLCAib25TdXNwZW5kIiwgIm9uU3VzcGVuZENhcHR1cmUiLCAib25UaW1lVXBkYXRlIiwgIm9uVGltZVVwZGF0ZUNhcHR1cmUiLCAib25Wb2x1bWVDaGFuZ2UiLCAib25Wb2x1bWVDaGFuZ2VDYXB0dXJlIiwgIm9uV2FpdGluZyIsICJvbldhaXRpbmdDYXB0dXJlIiwgIm9uQXV4Q2xpY2siLCAib25BdXhDbGlja0NhcHR1cmUiLCAib25DbGljayIsICJvbkNsaWNrQ2FwdHVyZSIsICJvbkNvbnRleHRNZW51IiwgIm9uQ29udGV4dE1lbnVDYXB0dXJlIiwgIm9uRG91YmxlQ2xpY2siLCAib25Eb3VibGVDbGlja0NhcHR1cmUiLCAib25EcmFnIiwgIm9uRHJhZ0NhcHR1cmUiLCAib25EcmFnRW5kIiwgIm9uRHJhZ0VuZENhcHR1cmUiLCAib25EcmFnRW50ZXIiLCAib25EcmFnRW50ZXJDYXB0dXJlIiwgIm9uRHJhZ0V4aXQiLCAib25EcmFnRXhpdENhcHR1cmUiLCAib25EcmFnTGVhdmUiLCAib25EcmFnTGVhdmVDYXB0dXJlIiwgIm9uRHJhZ092ZXIiLCAib25EcmFnT3ZlckNhcHR1cmUiLCAib25EcmFnU3RhcnQiLCAib25EcmFnU3RhcnRDYXB0dXJlIiwgIm9uRHJvcCIsICJvbkRyb3BDYXB0dXJlIiwgIm9uTW91c2VEb3duIiwgIm9uTW91c2VEb3duQ2FwdHVyZSIsICJvbk1vdXNlRW50ZXIiLCAib25Nb3VzZUxlYXZlIiwgIm9uTW91c2VNb3ZlIiwgIm9uTW91c2VNb3ZlQ2FwdHVyZSIsICJvbk1vdXNlT3V0IiwgIm9uTW91c2VPdXRDYXB0dXJlIiwgIm9uTW91c2VPdmVyIiwgIm9uTW91c2VPdmVyQ2FwdHVyZSIsICJvbk1vdXNlVXAiLCAib25Nb3VzZVVwQ2FwdHVyZSIsICJvblNlbGVjdCIsICJvblNlbGVjdENhcHR1cmUiLCAib25Ub3VjaENhbmNlbCIsICJvblRvdWNoQ2FuY2VsQ2FwdHVyZSIsICJvblRvdWNoRW5kIiwgIm9uVG91Y2hFbmRDYXB0dXJlIiwgIm9uVG91Y2hNb3ZlIiwgIm9uVG91Y2hNb3ZlQ2FwdHVyZSIsICJvblRvdWNoU3RhcnQiLCAib25Ub3VjaFN0YXJ0Q2FwdHVyZSIsICJvblBvaW50ZXJEb3duIiwgIm9uUG9pbnRlckRvd25DYXB0dXJlIiwgIm9uUG9pbnRlck1vdmUiLCAib25Qb2ludGVyTW92ZUNhcHR1cmUiLCAib25Qb2ludGVyVXAiLCAib25Qb2ludGVyVXBDYXB0dXJlIiwgIm9uUG9pbnRlckNhbmNlbCIsICJvblBvaW50ZXJDYW5jZWxDYXB0dXJlIiwgIm9uUG9pbnRlckVudGVyIiwgIm9uUG9pbnRlckVudGVyQ2FwdHVyZSIsICJvblBvaW50ZXJMZWF2ZSIsICJvblBvaW50ZXJMZWF2ZUNhcHR1cmUiLCAib25Qb2ludGVyT3ZlciIsICJvblBvaW50ZXJPdmVyQ2FwdHVyZSIsICJvblBvaW50ZXJPdXQiLCAib25Qb2ludGVyT3V0Q2FwdHVyZSIsICJvbkdvdFBvaW50ZXJDYXB0dXJlIiwgIm9uR290UG9pbnRlckNhcHR1cmVDYXB0dXJlIiwgIm9uTG9zdFBvaW50ZXJDYXB0dXJlIiwgIm9uTG9zdFBvaW50ZXJDYXB0dXJlQ2FwdHVyZSIsICJvblNjcm9sbCIsICJvblNjcm9sbENhcHR1cmUiLCAib25XaGVlbCIsICJvbldoZWVsQ2FwdHVyZSIsICJvbkFuaW1hdGlvblN0YXJ0IiwgIm9uQW5pbWF0aW9uU3RhcnRDYXB0dXJlIiwgIm9uQW5pbWF0aW9uRW5kIiwgIm9uQW5pbWF0aW9uRW5kQ2FwdHVyZSIsICJvbkFuaW1hdGlvbkl0ZXJhdGlvbiIsICJvbkFuaW1hdGlvbkl0ZXJhdGlvbkNhcHR1cmUiLCAib25UcmFuc2l0aW9uRW5kIiwgIm9uVHJhbnNpdGlvbkVuZENhcHR1cmUiXTsKZnVuY3Rpb24gaXNFdmVudEtleShrZXkpIHsKICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGFsbG93ZWRFdmVudEtleXMgPSBFdmVudEtleXM7CiAgcmV0dXJuIGFsbG93ZWRFdmVudEtleXMuaW5jbHVkZXMoa2V5KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNOb0V2ZW50cy5qcwp2YXIgaW1wb3J0X3JlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5cyA9IFsKICAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwKICAiYXJpYS1hdG9taWMiLAogICJhcmlhLWF1dG9jb21wbGV0ZSIsCiAgImFyaWEtYnVzeSIsCiAgImFyaWEtY2hlY2tlZCIsCiAgImFyaWEtY29sY291bnQiLAogICJhcmlhLWNvbGluZGV4IiwKICAiYXJpYS1jb2xzcGFuIiwKICAiYXJpYS1jb250cm9scyIsCiAgImFyaWEtY3VycmVudCIsCiAgImFyaWEtZGVzY3JpYmVkYnkiLAogICJhcmlhLWRldGFpbHMiLAogICJhcmlhLWRpc2FibGVkIiwKICAiYXJpYS1lcnJvcm1lc3NhZ2UiLAogICJhcmlhLWV4cGFuZGVkIiwKICAiYXJpYS1mbG93dG8iLAogICJhcmlhLWhhc3BvcHVwIiwKICAiYXJpYS1oaWRkZW4iLAogICJhcmlhLWludmFsaWQiLAogICJhcmlhLWtleXNob3J0Y3V0cyIsCiAgImFyaWEtbGFiZWwiLAogICJhcmlhLWxhYmVsbGVkYnkiLAogICJhcmlhLWxldmVsIiwKICAiYXJpYS1saXZlIiwKICAiYXJpYS1tb2RhbCIsCiAgImFyaWEtbXVsdGlsaW5lIiwKICAiYXJpYS1tdWx0aXNlbGVjdGFibGUiLAogICJhcmlhLW9yaWVudGF0aW9uIiwKICAiYXJpYS1vd25zIiwKICAiYXJpYS1wbGFjZWhvbGRlciIsCiAgImFyaWEtcG9zaW5zZXQiLAogICJhcmlhLXByZXNzZWQiLAogICJhcmlhLXJlYWRvbmx5IiwKICAiYXJpYS1yZWxldmFudCIsCiAgImFyaWEtcmVxdWlyZWQiLAogICJhcmlhLXJvbGVkZXNjcmlwdGlvbiIsCiAgImFyaWEtcm93Y291bnQiLAogICJhcmlhLXJvd2luZGV4IiwKICAiYXJpYS1yb3dzcGFuIiwKICAiYXJpYS1zZWxlY3RlZCIsCiAgImFyaWEtc2V0c2l6ZSIsCiAgImFyaWEtc29ydCIsCiAgImFyaWEtdmFsdWVtYXgiLAogICJhcmlhLXZhbHVlbWluIiwKICAiYXJpYS12YWx1ZW5vdyIsCiAgImFyaWEtdmFsdWV0ZXh0IiwKICAiY2xhc3NOYW1lIiwKICAiY29sb3IiLAogICJoZWlnaHQiLAogICJpZCIsCiAgImxhbmciLAogICJtYXgiLAogICJtZWRpYSIsCiAgIm1ldGhvZCIsCiAgIm1pbiIsCiAgIm5hbWUiLAogICJzdHlsZSIsCiAgLyoKICAgKiByZW1vdmVkICd0eXBlJyBTVkdFbGVtZW50UHJvcEtleSBiZWNhdXNlIHdlIGRvIG5vdCBjdXJyZW50bHkgdXNlIGFueSBTVkcgZWxlbWVudHMKICAgKiB0aGF0IGNhbiB1c2UgaXQsIGFuZCBpdCBjb25mbGljdHMgd2l0aCB0aGUgcmVjaGFydHMgcHJvcCAndHlwZScKICAgKiBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvcHVsbC8zMzI3CiAgICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvU1ZHL0F0dHJpYnV0ZS90eXBlCiAgICovCiAgLy8gJ3R5cGUnLAogICJ0YXJnZXQiLAogICJ3aWR0aCIsCiAgInJvbGUiLAogICJ0YWJJbmRleCIsCiAgImFjY2VudEhlaWdodCIsCiAgImFjY3VtdWxhdGUiLAogICJhZGRpdGl2ZSIsCiAgImFsaWdubWVudEJhc2VsaW5lIiwKICAiYWxsb3dSZW9yZGVyIiwKICAiYWxwaGFiZXRpYyIsCiAgImFtcGxpdHVkZSIsCiAgImFyYWJpY0Zvcm0iLAogICJhc2NlbnQiLAogICJhdHRyaWJ1dGVOYW1lIiwKICAiYXR0cmlidXRlVHlwZSIsCiAgImF1dG9SZXZlcnNlIiwKICAiYXppbXV0aCIsCiAgImJhc2VGcmVxdWVuY3kiLAogICJiYXNlbGluZVNoaWZ0IiwKICAiYmFzZVByb2ZpbGUiLAogICJiYm94IiwKICAiYmVnaW4iLAogICJiaWFzIiwKICAiYnkiLAogICJjYWxjTW9kZSIsCiAgImNhcEhlaWdodCIsCiAgImNsaXAiLAogICJjbGlwUGF0aCIsCiAgImNsaXBQYXRoVW5pdHMiLAogICJjbGlwUnVsZSIsCiAgImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICJjb2xvclByb2ZpbGUiLAogICJjb2xvclJlbmRlcmluZyIsCiAgImNvbnRlbnRTY3JpcHRUeXBlIiwKICAiY29udGVudFN0eWxlVHlwZSIsCiAgImN1cnNvciIsCiAgImN4IiwKICAiY3kiLAogICJkIiwKICAiZGVjZWxlcmF0ZSIsCiAgImRlc2NlbnQiLAogICJkaWZmdXNlQ29uc3RhbnQiLAogICJkaXJlY3Rpb24iLAogICJkaXNwbGF5IiwKICAiZGl2aXNvciIsCiAgImRvbWluYW50QmFzZWxpbmUiLAogICJkdXIiLAogICJkeCIsCiAgImR5IiwKICAiZWRnZU1vZGUiLAogICJlbGV2YXRpb24iLAogICJlbmFibGVCYWNrZ3JvdW5kIiwKICAiZW5kIiwKICAiZXhwb25lbnQiLAogICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAiZmlsbCIsCiAgImZpbGxPcGFjaXR5IiwKICAiZmlsbFJ1bGUiLAogICJmaWx0ZXIiLAogICJmaWx0ZXJSZXMiLAogICJmaWx0ZXJVbml0cyIsCiAgImZsb29kQ29sb3IiLAogICJmbG9vZE9wYWNpdHkiLAogICJmb2N1c2FibGUiLAogICJmb250RmFtaWx5IiwKICAiZm9udFNpemUiLAogICJmb250U2l6ZUFkanVzdCIsCiAgImZvbnRTdHJldGNoIiwKICAiZm9udFN0eWxlIiwKICAiZm9udFZhcmlhbnQiLAogICJmb250V2VpZ2h0IiwKICAiZm9ybWF0IiwKICAiZnJvbSIsCiAgImZ4IiwKICAiZnkiLAogICJnMSIsCiAgImcyIiwKICAiZ2x5cGhOYW1lIiwKICAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICJnbHlwaFJlZiIsCiAgImdyYWRpZW50VHJhbnNmb3JtIiwKICAiZ3JhZGllbnRVbml0cyIsCiAgImhhbmdpbmciLAogICJob3JpekFkdlgiLAogICJob3Jpek9yaWdpblgiLAogICJocmVmIiwKICAiaWRlb2dyYXBoaWMiLAogICJpbWFnZVJlbmRlcmluZyIsCiAgImluMiIsCiAgImluIiwKICAiaW50ZXJjZXB0IiwKICAiazEiLAogICJrMiIsCiAgImszIiwKICAiazQiLAogICJrIiwKICAia2VybmVsTWF0cml4IiwKICAia2VybmVsVW5pdExlbmd0aCIsCiAgImtlcm5pbmciLAogICJrZXlQb2ludHMiLAogICJrZXlTcGxpbmVzIiwKICAia2V5VGltZXMiLAogICJsZW5ndGhBZGp1c3QiLAogICJsZXR0ZXJTcGFjaW5nIiwKICAibGlnaHRpbmdDb2xvciIsCiAgImxpbWl0aW5nQ29uZUFuZ2xlIiwKICAibG9jYWwiLAogICJtYXJrZXJFbmQiLAogICJtYXJrZXJIZWlnaHQiLAogICJtYXJrZXJNaWQiLAogICJtYXJrZXJTdGFydCIsCiAgIm1hcmtlclVuaXRzIiwKICAibWFya2VyV2lkdGgiLAogICJtYXNrIiwKICAibWFza0NvbnRlbnRVbml0cyIsCiAgIm1hc2tVbml0cyIsCiAgIm1hdGhlbWF0aWNhbCIsCiAgIm1vZGUiLAogICJudW1PY3RhdmVzIiwKICAib2Zmc2V0IiwKICAib3BhY2l0eSIsCiAgIm9wZXJhdG9yIiwKICAib3JkZXIiLAogICJvcmllbnQiLAogICJvcmllbnRhdGlvbiIsCiAgIm9yaWdpbiIsCiAgIm92ZXJmbG93IiwKICAib3ZlcmxpbmVQb3NpdGlvbiIsCiAgIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAicGFpbnRPcmRlciIsCiAgInBhbm9zZTEiLAogICJwYXRoTGVuZ3RoIiwKICAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgInBhdHRlcm5UcmFuc2Zvcm0iLAogICJwYXR0ZXJuVW5pdHMiLAogICJwb2ludGVyRXZlbnRzIiwKICAicG9pbnRzQXRYIiwKICAicG9pbnRzQXRZIiwKICAicG9pbnRzQXRaIiwKICAicHJlc2VydmVBbHBoYSIsCiAgInByZXNlcnZlQXNwZWN0UmF0aW8iLAogICJwcmltaXRpdmVVbml0cyIsCiAgInIiLAogICJyYWRpdXMiLAogICJyZWZYIiwKICAicmVmWSIsCiAgInJlbmRlcmluZ0ludGVudCIsCiAgInJlcGVhdENvdW50IiwKICAicmVwZWF0RHVyIiwKICAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAicmVxdWlyZWRGZWF0dXJlcyIsCiAgInJlc3RhcnQiLAogICJyZXN1bHQiLAogICJyb3RhdGUiLAogICJyeCIsCiAgInJ5IiwKICAic2VlZCIsCiAgInNoYXBlUmVuZGVyaW5nIiwKICAic2xvcGUiLAogICJzcGFjaW5nIiwKICAic3BlY3VsYXJDb25zdGFudCIsCiAgInNwZWN1bGFyRXhwb25lbnQiLAogICJzcGVlZCIsCiAgInNwcmVhZE1ldGhvZCIsCiAgInN0YXJ0T2Zmc2V0IiwKICAic3RkRGV2aWF0aW9uIiwKICAic3RlbWgiLAogICJzdGVtdiIsCiAgInN0aXRjaFRpbGVzIiwKICAic3RvcENvbG9yIiwKICAic3RvcE9wYWNpdHkiLAogICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICJzdHJpa2V0aHJvdWdoVGhpY2tuZXNzIiwKICAic3RyaW5nIiwKICAic3Ryb2tlIiwKICAic3Ryb2tlRGFzaGFycmF5IiwKICAic3Ryb2tlRGFzaG9mZnNldCIsCiAgInN0cm9rZUxpbmVjYXAiLAogICJzdHJva2VMaW5lam9pbiIsCiAgInN0cm9rZU1pdGVybGltaXQiLAogICJzdHJva2VPcGFjaXR5IiwKICAic3Ryb2tlV2lkdGgiLAogICJzdXJmYWNlU2NhbGUiLAogICJzeXN0ZW1MYW5ndWFnZSIsCiAgInRhYmxlVmFsdWVzIiwKICAidGFyZ2V0WCIsCiAgInRhcmdldFkiLAogICJ0ZXh0QW5jaG9yIiwKICAidGV4dERlY29yYXRpb24iLAogICJ0ZXh0TGVuZ3RoIiwKICAidGV4dFJlbmRlcmluZyIsCiAgInRvIiwKICAidHJhbnNmb3JtIiwKICAidTEiLAogICJ1MiIsCiAgInVuZGVybGluZVBvc2l0aW9uIiwKICAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAidW5pY29kZSIsCiAgInVuaWNvZGVCaWRpIiwKICAidW5pY29kZVJhbmdlIiwKICAidW5pdHNQZXJFbSIsCiAgInZBbHBoYWJldGljIiwKICAidmFsdWVzIiwKICAidmVjdG9yRWZmZWN0IiwKICAidmVyc2lvbiIsCiAgInZlcnRBZHZZIiwKICAidmVydE9yaWdpblgiLAogICJ2ZXJ0T3JpZ2luWSIsCiAgInZIYW5naW5nIiwKICAidklkZW9ncmFwaGljIiwKICAidmlld1RhcmdldCIsCiAgInZpc2liaWxpdHkiLAogICJ2TWF0aGVtYXRpY2FsIiwKICAid2lkdGhzIiwKICAid29yZFNwYWNpbmciLAogICJ3cml0aW5nTW9kZSIsCiAgIngxIiwKICAieDIiLAogICJ4IiwKICAieENoYW5uZWxTZWxlY3RvciIsCiAgInhIZWlnaHQiLAogICJ4bGlua0FjdHVhdGUiLAogICJ4bGlua0FyY3JvbGUiLAogICJ4bGlua0hyZWYiLAogICJ4bGlua1JvbGUiLAogICJ4bGlua1Nob3ciLAogICJ4bGlua1RpdGxlIiwKICAieGxpbmtUeXBlIiwKICAieG1sQmFzZSIsCiAgInhtbExhbmciLAogICJ4bWxucyIsCiAgInhtbG5zWGxpbmsiLAogICJ4bWxTcGFjZSIsCiAgInkxIiwKICAieTIiLAogICJ5IiwKICAieUNoYW5uZWxTZWxlY3RvciIsCiAgInoiLAogICJ6b29tQW5kUGFuIiwKICAicmVmIiwKICAia2V5IiwKICAiYW5nbGUiCl07CnZhciBTVkdFbGVtZW50UHJvcEtleVNldCA9IG5ldyBTZXQoU1ZHRWxlbWVudFByb3BLZXlzKTsKZnVuY3Rpb24gaXNTdmdFbGVtZW50UHJvcEtleShrZXkpIHsKICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIFNWR0VsZW1lbnRQcm9wS2V5U2V0LmhhcyhrZXkpOwp9CmZ1bmN0aW9uIGlzRGF0YUF0dHJpYnV0ZShrZXkpIHsKICByZXR1cm4gdHlwZW9mIGtleSA9PT0gInN0cmluZyIgJiYga2V5LnN0YXJ0c1dpdGgoImRhdGEtIik7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc05vRXZlbnRzKG9iaikgewogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpIHsKICAgIHJldHVybiB7fTsKICB9CiAgdmFyIHJlc3VsdCA9IHt9OwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgIGlmIChpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgfHwgaXNEYXRhQXR0cmlidXRlKGtleSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oaW5wdXQpIHsKICBpZiAoaW5wdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMuaXNWYWxpZEVsZW1lbnQpKGlucHV0KSAmJiB0eXBlb2YgaW5wdXQucHJvcHMgPT09ICJvYmplY3QiICYmIGlucHV0LnByb3BzICE9PSBudWxsKSB7CiAgICB2YXIgcCA9IGlucHV0LnByb3BzOwogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwKTsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gIm9iamVjdCIgJiYgIUFycmF5LmlzQXJyYXkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKGlucHV0KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzQW5kRXZlbnRzLmpzCmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob2JqKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgIGlmIChpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgfHwgaXNEYXRhQXR0cmlidXRlKGtleSkgfHwgaXNFdmVudEtleShrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NC5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhpbnB1dC5wcm9wcyk7CiAgfQogIGlmICh0eXBlb2YgaW5wdXQgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvU3VyZmFjZS5qcwp2YXIgX2V4Y2x1ZGVkID0gWyJjaGlsZHJlbiIsICJ3aWR0aCIsICJoZWlnaHQiLCAidmlld0JveCIsICJjbGFzc05hbWUiLCAic3R5bGUiLCAidGl0bGUiLCAiZGVzYyJdOwpmdW5jdGlvbiBfZXh0ZW5kcygpIHsKICByZXR1cm4gX2V4dGVuZHMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kcy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllcyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB2aWV3Qm94LAogICAgY2xhc3NOYW1lLAogICAgc3R5bGUsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllcyhwcm9wcywgX2V4Y2x1ZGVkKTsKICB2YXIgc3ZnVmlldyA9IHZpZXdCb3ggfHwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB4OiAwLAogICAgeTogMAogIH07CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1zdXJmYWNlIiwgY2xhc3NOYW1lKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoInN2ZyIsIF9leHRlbmRzKHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKG90aGVycyksIHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3R5bGUsCiAgICB2aWV3Qm94OiAiIi5jb25jYXQoc3ZnVmlldy54LCAiICIpLmNvbmNhdChzdmdWaWV3LnksICIgIikuY29uY2F0KHN2Z1ZpZXcud2lkdGgsICIgIikuY29uY2F0KHN2Z1ZpZXcuaGVpZ2h0KSwKICAgIHJlZgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgidGl0bGUiLCBudWxsLCB0aXRsZSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJkZXNjIiwgbnVsbCwgZGVzYyksIGNoaWxkcmVuKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9MYXllci5qcwp2YXIgUmVhY3QyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMiA9IFsiY2hpbGRyZW4iLCAiY2xhc3NOYW1lIl07CmZ1bmN0aW9uIF9leHRlbmRzMigpIHsKICByZXR1cm4gX2V4dGVuZHMyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIExheWVyID0gLyogQF9fUFVSRV9fICovIFJlYWN0Mi5mb3J3YXJkUmVmKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKHByb3BzLCBfZXhjbHVkZWQyKTsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWxheWVyIiwgY2xhc3NOYW1lKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Mi5jcmVhdGVFbGVtZW50KCJnIiwgX2V4dGVuZHMyKHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcwogIH0sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob3RoZXJzKSwgewogICAgcmVmCiAgfSksIGNoaWxkcmVuKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvbGVnZW5kUG9ydGFsQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIExlZ2VuZFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDYuY3JlYXRlQ29udGV4dCkobnVsbCk7CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50X2RlZmF1bHQoeDIpIHsKICByZXR1cm4gZnVuY3Rpb24gY29uc3RhbnQoKSB7CiAgICByZXR1cm4geDI7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXBhdGgvc3JjL3BhdGguanMKdmFyIHBpID0gTWF0aC5QSTsKdmFyIHRhdSA9IDIgKiBwaTsKdmFyIGVwc2lsb24gPSAxZS02Owp2YXIgdGF1RXBzaWxvbiA9IHRhdSAtIGVwc2lsb247CmZ1bmN0aW9uIGFwcGVuZChzdHJpbmdzKSB7CiAgdGhpcy5fICs9IHN0cmluZ3NbMF07CiAgZm9yIChsZXQgaSA9IDEsIG4gPSBzdHJpbmdzLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgdGhpcy5fICs9IGFyZ3VtZW50c1tpXSArIHN0cmluZ3NbaV07CiAgfQp9CmZ1bmN0aW9uIGFwcGVuZFJvdW5kKGRpZ2l0cykgewogIGxldCBkID0gTWF0aC5mbG9vcihkaWdpdHMpOwogIGlmICghKGQgPj0gMCkpIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBkaWdpdHM6ICR7ZGlnaXRzfWApOwogIGlmIChkID4gMTUpIHJldHVybiBhcHBlbmQ7CiAgY29uc3QgayA9IDEwICoqIGQ7CiAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZ3MpIHsKICAgIHRoaXMuXyArPSBzdHJpbmdzWzBdOwogICAgZm9yIChsZXQgaSA9IDEsIG4gPSBzdHJpbmdzLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICB0aGlzLl8gKz0gTWF0aC5yb3VuZChhcmd1bWVudHNbaV0gKiBrKSAvIGsgKyBzdHJpbmdzW2ldOwogICAgfQogIH07Cn0KdmFyIFBhdGggPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoZGlnaXRzKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3kwID0gLy8gc3RhcnQgb2YgY3VycmVudCBzdWJwYXRoCiAgICB0aGlzLl94MSA9IHRoaXMuX3kxID0gbnVsbDsKICAgIHRoaXMuXyA9ICIiOwogICAgdGhpcy5fYXBwZW5kID0gZGlnaXRzID09IG51bGwgPyBhcHBlbmQgOiBhcHBlbmRSb3VuZChkaWdpdHMpOwogIH0KICBtb3ZlVG8oeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgTSR7dGhpcy5feDAgPSB0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MCA9IHRoaXMuX3kxID0gK3kyfWA7CiAgfQogIGNsb3NlUGF0aCgpIHsKICAgIGlmICh0aGlzLl94MSAhPT0gbnVsbCkgewogICAgICB0aGlzLl94MSA9IHRoaXMuX3gwLCB0aGlzLl95MSA9IHRoaXMuX3kwOwogICAgICB0aGlzLl9hcHBlbmRgWmA7CiAgICB9CiAgfQogIGxpbmVUbyh4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBMJHt0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBxdWFkcmF0aWNDdXJ2ZVRvKHgxLCB5MSwgeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgUSR7K3gxfSwkeyt5MX0sJHt0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBiZXppZXJDdXJ2ZVRvKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2FwcGVuZGBDJHsreDF9LCR7K3kxfSwkeyt4Mn0sJHsreTJ9LCR7dGhpcy5feDEgPSAreDN9LCR7dGhpcy5feTEgPSAreTN9YDsKICB9CiAgYXJjVG8oeDEsIHkxLCB4MiwgeTIsIHIyKSB7CiAgICB4MSA9ICt4MSwgeTEgPSAreTEsIHgyID0gK3gyLCB5MiA9ICt5MiwgcjIgPSArcjI7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCB4MCA9IHRoaXMuX3gxLCB5MCA9IHRoaXMuX3kxLCB4MjEgPSB4MiAtIHgxLCB5MjEgPSB5MiAtIHkxLCB4MDEgPSB4MCAtIHgxLCB5MDEgPSB5MCAtIHkxLCBsMDFfMiA9IHgwMSAqIHgwMSArIHkwMSAqIHkwMTsKICAgIGlmICh0aGlzLl94MSA9PT0gbnVsbCkgewogICAgICB0aGlzLl9hcHBlbmRgTSR7dGhpcy5feDEgPSB4MX0sJHt0aGlzLl95MSA9IHkxfWA7CiAgICB9IGVsc2UgaWYgKCEobDAxXzIgPiBlcHNpbG9uKSkgOwogICAgZWxzZSBpZiAoIShNYXRoLmFicyh5MDEgKiB4MjEgLSB5MjEgKiB4MDEpID4gZXBzaWxvbikgfHwgIXIyKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt0aGlzLl94MSA9IHgxfSwke3RoaXMuX3kxID0geTF9YDsKICAgIH0gZWxzZSB7CiAgICAgIGxldCB4MjAgPSB4MiAtIHgwLCB5MjAgPSB5MiAtIHkwLCBsMjFfMiA9IHgyMSAqIHgyMSArIHkyMSAqIHkyMSwgbDIwXzIgPSB4MjAgKiB4MjAgKyB5MjAgKiB5MjAsIGwyMSA9IE1hdGguc3FydChsMjFfMiksIGwwMSA9IE1hdGguc3FydChsMDFfMiksIGwgPSByMiAqIE1hdGgudGFuKChwaSAtIE1hdGguYWNvcygobDIxXzIgKyBsMDFfMiAtIGwyMF8yKSAvICgyICogbDIxICogbDAxKSkpIC8gMiksIHQwMSA9IGwgLyBsMDEsIHQyMSA9IGwgLyBsMjE7CiAgICAgIGlmIChNYXRoLmFicyh0MDEgLSAxKSA+IGVwc2lsb24pIHsKICAgICAgICB0aGlzLl9hcHBlbmRgTCR7eDEgKyB0MDEgKiB4MDF9LCR7eTEgKyB0MDEgKiB5MDF9YDsKICAgICAgfQogICAgICB0aGlzLl9hcHBlbmRgQSR7cjJ9LCR7cjJ9LDAsMCwkeysoeTAxICogeDIwID4geDAxICogeTIwKX0sJHt0aGlzLl94MSA9IHgxICsgdDIxICogeDIxfSwke3RoaXMuX3kxID0geTEgKyB0MjEgKiB5MjF9YDsKICAgIH0KICB9CiAgYXJjKHgyLCB5MiwgcjIsIGEwLCBhMSwgY2N3KSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTIsIHIyID0gK3IyLCBjY3cgPSAhIWNjdzsKICAgIGlmIChyMiA8IDApIHRocm93IG5ldyBFcnJvcihgbmVnYXRpdmUgcmFkaXVzOiAke3IyfWApOwogICAgbGV0IGR4ID0gcjIgKiBNYXRoLmNvcyhhMCksIGR5ID0gcjIgKiBNYXRoLnNpbihhMCksIHgwID0geDIgKyBkeCwgeTAgPSB5MiArIGR5LCBjdyA9IDEgXiBjY3csIGRhID0gY2N3ID8gYTAgLSBhMSA6IGExIC0gYTA7CiAgICBpZiAodGhpcy5feDEgPT09IG51bGwpIHsKICAgICAgdGhpcy5fYXBwZW5kYE0ke3gwfSwke3kwfWA7CiAgICB9IGVsc2UgaWYgKE1hdGguYWJzKHRoaXMuX3gxIC0geDApID4gZXBzaWxvbiB8fCBNYXRoLmFicyh0aGlzLl95MSAtIHkwKSA+IGVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEwke3gwfSwke3kwfWA7CiAgICB9CiAgICBpZiAoIXIyKSByZXR1cm47CiAgICBpZiAoZGEgPCAwKSBkYSA9IGRhICUgdGF1ICsgdGF1OwogICAgaWYgKGRhID4gdGF1RXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgQSR7cjJ9LCR7cjJ9LDAsMSwke2N3fSwke3gyIC0gZHh9LCR7eTIgLSBkeX1BJHtyMn0sJHtyMn0sMCwxLCR7Y3d9LCR7dGhpcy5feDEgPSB4MH0sJHt0aGlzLl95MSA9IHkwfWA7CiAgICB9IGVsc2UgaWYgKGRhID4gZXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgQSR7cjJ9LCR7cjJ9LDAsJHsrKGRhID49IHBpKX0sJHtjd30sJHt0aGlzLl94MSA9IHgyICsgcjIgKiBNYXRoLmNvcyhhMSl9LCR7dGhpcy5feTEgPSB5MiArIHIyICogTWF0aC5zaW4oYTEpfWA7CiAgICB9CiAgfQogIHJlY3QoeDIsIHkyLCB3LCBoKSB7CiAgICB0aGlzLl9hcHBlbmRgTSR7dGhpcy5feDAgPSB0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MCA9IHRoaXMuX3kxID0gK3kyfWgke3cgPSArd312JHsraH1oJHstd31aYDsKICB9CiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fOwogIH0KfTsKZnVuY3Rpb24gcGF0aCgpIHsKICByZXR1cm4gbmV3IFBhdGgoKTsKfQpwYXRoLnByb3RvdHlwZSA9IFBhdGgucHJvdG90eXBlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9wYXRoLmpzCmZ1bmN0aW9uIHdpdGhQYXRoKHNoYXBlKSB7CiAgbGV0IGRpZ2l0cyA9IDM7CiAgc2hhcGUuZGlnaXRzID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZGlnaXRzOwogICAgaWYgKF8gPT0gbnVsbCkgewogICAgICBkaWdpdHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZCA9IE1hdGguZmxvb3IoXyk7CiAgICAgIGlmICghKGQgPj0gMCkpIHRocm93IG5ldyBSYW5nZUVycm9yKGBpbnZhbGlkIGRpZ2l0czogJHtffWApOwogICAgICBkaWdpdHMgPSBkOwogICAgfQogICAgcmV0dXJuIHNoYXBlOwogIH07CiAgcmV0dXJuICgpID0+IG5ldyBQYXRoKGRpZ2l0cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJyYXkuanMKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwpmdW5jdGlvbiBhcnJheV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gIm9iamVjdCIgJiYgImxlbmd0aCIgaW4geDIgPyB4MiA6IEFycmF5LmZyb20oeDIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2xpbmVhci5qcwpmdW5jdGlvbiBMaW5lYXIoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkxpbmVhci5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICB9Cn07CmZ1bmN0aW9uIGxpbmVhcl9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IExpbmVhcihjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9wb2ludC5qcwpmdW5jdGlvbiB4KHApIHsKICByZXR1cm4gcFswXTsKfQpmdW5jdGlvbiB5KHApIHsKICByZXR1cm4gcFsxXTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9saW5lLmpzCmZ1bmN0aW9uIGxpbmVfZGVmYXVsdCh4MiwgeTIpIHsKICB2YXIgZGVmaW5lZDIgPSBjb25zdGFudF9kZWZhdWx0KHRydWUpLCBjb250ZXh0ID0gbnVsbCwgY3VydmUgPSBsaW5lYXJfZGVmYXVsdCwgb3V0cHV0ID0gbnVsbCwgcGF0aDIgPSB3aXRoUGF0aChsaW5lKTsKICB4MiA9IHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIiA/IHgyIDogeDIgPT09IHZvaWQgMCA/IHggOiBjb25zdGFudF9kZWZhdWx0KHgyKTsKICB5MiA9IHR5cGVvZiB5MiA9PT0gImZ1bmN0aW9uIiA/IHkyIDogeTIgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KHkyKTsKICBmdW5jdGlvbiBsaW5lKGRhdGEpIHsKICAgIHZhciBpLCBuID0gKGRhdGEgPSBhcnJheV9kZWZhdWx0KGRhdGEpKS5sZW5ndGgsIGQsIGRlZmluZWQwID0gZmFsc2UsIGJ1ZmZlcjsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIG91dHB1dC5saW5lU3RhcnQoKTsKICAgICAgICBlbHNlIG91dHB1dC5saW5lRW5kKCk7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQwKSBvdXRwdXQucG9pbnQoK3gyKGQsIGksIGRhdGEpLCAreTIoZCwgaSwgZGF0YSkpOwogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGxpbmUueCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGxpbmUpIDogeDI7CiAgfTsKICBsaW5lLnkgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHkyOwogIH07CiAgbGluZS5kZWZpbmVkID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGVmaW5lZDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCEhXyksIGxpbmUpIDogZGVmaW5lZDI7CiAgfTsKICBsaW5lLmN1cnZlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY3VydmUgPSBfLCBjb250ZXh0ICE9IG51bGwgJiYgKG91dHB1dCA9IGN1cnZlKGNvbnRleHQpKSwgbGluZSkgOiBjdXJ2ZTsKICB9OwogIGxpbmUuY29udGV4dCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKF8gPT0gbnVsbCA/IGNvbnRleHQgPSBvdXRwdXQgPSBudWxsIDogb3V0cHV0ID0gY3VydmUoY29udGV4dCA9IF8pLCBsaW5lKSA6IGNvbnRleHQ7CiAgfTsKICByZXR1cm4gbGluZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9hcmVhLmpzCmZ1bmN0aW9uIGFyZWFfZGVmYXVsdCh4MCwgeTAsIHkxKSB7CiAgdmFyIHgxID0gbnVsbCwgZGVmaW5lZDIgPSBjb25zdGFudF9kZWZhdWx0KHRydWUpLCBjb250ZXh0ID0gbnVsbCwgY3VydmUgPSBsaW5lYXJfZGVmYXVsdCwgb3V0cHV0ID0gbnVsbCwgcGF0aDIgPSB3aXRoUGF0aChhcmVhKTsKICB4MCA9IHR5cGVvZiB4MCA9PT0gImZ1bmN0aW9uIiA/IHgwIDogeDAgPT09IHZvaWQgMCA/IHggOiBjb25zdGFudF9kZWZhdWx0KCt4MCk7CiAgeTAgPSB0eXBlb2YgeTAgPT09ICJmdW5jdGlvbiIgPyB5MCA6IHkwID09PSB2b2lkIDAgPyBjb25zdGFudF9kZWZhdWx0KDApIDogY29uc3RhbnRfZGVmYXVsdCgreTApOwogIHkxID0gdHlwZW9mIHkxID09PSAiZnVuY3Rpb24iID8geTEgOiB5MSA9PT0gdm9pZCAwID8geSA6IGNvbnN0YW50X2RlZmF1bHQoK3kxKTsKICBmdW5jdGlvbiBhcmVhKGRhdGEpIHsKICAgIHZhciBpLCBqLCBrLCBuID0gKGRhdGEgPSBhcnJheV9kZWZhdWx0KGRhdGEpKS5sZW5ndGgsIGQsIGRlZmluZWQwID0gZmFsc2UsIGJ1ZmZlciwgeDB6ID0gbmV3IEFycmF5KG4pLCB5MHogPSBuZXcgQXJyYXkobik7CiAgICBpZiAoY29udGV4dCA9PSBudWxsKSBvdXRwdXQgPSBjdXJ2ZShidWZmZXIgPSBwYXRoMigpKTsKICAgIGZvciAoaSA9IDA7IGkgPD0gbjsgKytpKSB7CiAgICAgIGlmICghKGkgPCBuICYmIGRlZmluZWQyKGQgPSBkYXRhW2ldLCBpLCBkYXRhKSkgPT09IGRlZmluZWQwKSB7CiAgICAgICAgaWYgKGRlZmluZWQwID0gIWRlZmluZWQwKSB7CiAgICAgICAgICBqID0gaTsKICAgICAgICAgIG91dHB1dC5hcmVhU3RhcnQoKTsKICAgICAgICAgIG91dHB1dC5saW5lU3RhcnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3V0cHV0LmxpbmVFbmQoKTsKICAgICAgICAgIG91dHB1dC5saW5lU3RhcnQoKTsKICAgICAgICAgIGZvciAoayA9IGkgLSAxOyBrID49IGo7IC0taykgewogICAgICAgICAgICBvdXRwdXQucG9pbnQoeDB6W2tdLCB5MHpba10pOwogICAgICAgICAgfQogICAgICAgICAgb3V0cHV0LmxpbmVFbmQoKTsKICAgICAgICAgIG91dHB1dC5hcmVhRW5kKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWZpbmVkMCkgewogICAgICAgIHgweltpXSA9ICt4MChkLCBpLCBkYXRhKSwgeTB6W2ldID0gK3kwKGQsIGksIGRhdGEpOwogICAgICAgIG91dHB1dC5wb2ludCh4MSA/ICt4MShkLCBpLCBkYXRhKSA6IHgweltpXSwgeTEgPyAreTEoZCwgaSwgZGF0YSkgOiB5MHpbaV0pOwogICAgICB9CiAgICB9CiAgICBpZiAoYnVmZmVyKSByZXR1cm4gb3V0cHV0ID0gbnVsbCwgYnVmZmVyICsgIiIgfHwgbnVsbDsKICB9CiAgZnVuY3Rpb24gYXJlYWxpbmUoKSB7CiAgICByZXR1cm4gbGluZV9kZWZhdWx0KCkuZGVmaW5lZChkZWZpbmVkMikuY3VydmUoY3VydmUpLmNvbnRleHQoY29udGV4dCk7CiAgfQogIGFyZWEueCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHgxID0gbnVsbCwgYXJlYSkgOiB4MDsKICB9OwogIGFyZWEueDAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHgwOwogIH07CiAgYXJlYS54MSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgxID0gXyA9PSBudWxsID8gbnVsbCA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHgxOwogIH07CiAgYXJlYS55ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgeTEgPSBudWxsLCBhcmVhKSA6IHkwOwogIH07CiAgYXJlYS55MCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeTA7CiAgfTsKICBhcmVhLnkxID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTEgPSBfID09IG51bGwgPyBudWxsIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeTE7CiAgfTsKICBhcmVhLmxpbmVYMCA9IGFyZWEubGluZVkwID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYXJlYWxpbmUoKS54KHgwKS55KHkwKTsKICB9OwogIGFyZWEubGluZVkxID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYXJlYWxpbmUoKS54KHgwKS55KHkxKTsKICB9OwogIGFyZWEubGluZVgxID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYXJlYWxpbmUoKS54KHgxKS55KHkwKTsKICB9OwogIGFyZWEuZGVmaW5lZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRlZmluZWQyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCghIV8pLCBhcmVhKSA6IGRlZmluZWQyOwogIH07CiAgYXJlYS5jdXJ2ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGN1cnZlID0gXywgY29udGV4dCAhPSBudWxsICYmIChvdXRwdXQgPSBjdXJ2ZShjb250ZXh0KSksIGFyZWEpIDogY3VydmU7CiAgfTsKICBhcmVhLmNvbnRleHQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChfID09IG51bGwgPyBjb250ZXh0ID0gb3V0cHV0ID0gbnVsbCA6IG91dHB1dCA9IGN1cnZlKGNvbnRleHQgPSBfKSwgYXJlYSkgOiBjb250ZXh0OwogIH07CiAgcmV0dXJuIGFyZWE7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYnVtcC5qcwp2YXIgQnVtcCA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb250ZXh0LCB4MikgewogICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgICB0aGlzLl94ID0geDI7CiAgfQogIGFyZWFTdGFydCgpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0KICBhcmVhRW5kKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9CiAgbGluZVN0YXJ0KCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0KICBsaW5lRW5kKCkgewogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9CiAgcG9pbnQoeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDogewogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICBpZiAodGhpcy5fbGluZSkgdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgICAgICBlbHNlIHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl94KSB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8odGhpcy5feDAgPSAodGhpcy5feDAgKyB4MikgLyAyLCB0aGlzLl95MCwgdGhpcy5feDAsIHkyLCB4MiwgeTIpOwogICAgICAgIGVsc2UgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHRoaXMuX3gwLCB0aGlzLl95MCA9ICh0aGlzLl95MCArIHkyKSAvIDIsIHgyLCB0aGlzLl95MCwgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy5feDAgPSB4MiwgdGhpcy5feTAgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJ1bXBYKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJ1bXAoY29udGV4dCwgdHJ1ZSk7Cn0KZnVuY3Rpb24gYnVtcFkoY29udGV4dCkgewogIHJldHVybiBuZXcgQnVtcChjb250ZXh0LCBmYWxzZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbm9vcC5qcwpmdW5jdGlvbiBub29wX2RlZmF1bHQoKSB7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXMuanMKZnVuY3Rpb24gcG9pbnQodGhhdCwgeDIsIHkyKSB7CiAgdGhhdC5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKAogICAgKDIgKiB0aGF0Ll94MCArIHRoYXQuX3gxKSAvIDMsCiAgICAoMiAqIHRoYXQuX3kwICsgdGhhdC5feTEpIC8gMywKICAgICh0aGF0Ll94MCArIDIgKiB0aGF0Ll94MSkgLyAzLAogICAgKHRoYXQuX3kwICsgMiAqIHRoYXQuX3kxKSAvIDMsCiAgICAodGhhdC5feDAgKyA0ICogdGhhdC5feDEgKyB4MikgLyA2LAogICAgKHRoYXQuX3kwICsgNCAqIHRoYXQuX3kxICsgeTIpIC8gNgogICk7Cn0KZnVuY3Rpb24gQmFzaXMoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feDAgPSB0aGlzLl94MSA9IHRoaXMuX3kwID0gdGhpcy5feTEgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAzOgogICAgICAgIHBvaW50KHRoaXMsIHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oKDUgKiB0aGlzLl94MCArIHRoaXMuX3gxKSAvIDYsICg1ICogdGhpcy5feTAgKyB0aGlzLl95MSkgLyA2KTsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludCh0aGlzLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgfQp9OwpmdW5jdGlvbiBiYXNpc19kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJhc2lzKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIEJhc2lzQ2xvc2VkKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpc0Nsb3NlZC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBub29wX2RlZmF1bHQsCiAgYXJlYUVuZDogbm9vcF9kZWZhdWx0LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feDIgPSB0aGlzLl94MyA9IHRoaXMuX3g0ID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IHRoaXMuX3kyID0gdGhpcy5feTMgPSB0aGlzLl95NCA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDE6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh0aGlzLl94MiwgdGhpcy5feTIpOwogICAgICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAyOiB7CiAgICAgICAgdGhpcy5fY29udGV4dC5tb3ZlVG8oKHRoaXMuX3gyICsgMiAqIHRoaXMuX3gzKSAvIDMsICh0aGlzLl95MiArIDIgKiB0aGlzLl95MykgLyAzKTsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbygodGhpcy5feDMgKyAyICogdGhpcy5feDIpIC8gMywgKHRoaXMuX3kzICsgMiAqIHRoaXMuX3kyKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAzOiB7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MiwgdGhpcy5feTIpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDMsIHRoaXMuX3kzKTsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3g0LCB0aGlzLl95NCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl94MiA9IHgyLCB0aGlzLl95MiA9IHkyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIHRoaXMuX3gzID0geDIsIHRoaXMuX3kzID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgdGhpcy5feDQgPSB4MiwgdGhpcy5feTQgPSB5MjsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDAgKyA0ICogdGhpcy5feDEgKyB4MikgLyA2LCAodGhpcy5feTAgKyA0ICogdGhpcy5feTEgKyB5MikgLyA2KTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludCh0aGlzLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgfQp9OwpmdW5jdGlvbiBiYXNpc0Nsb3NlZF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJhc2lzQ2xvc2VkKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzT3Blbi5qcwpmdW5jdGlvbiBCYXNpc09wZW4oY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzT3Blbi5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAzKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHZhciB4MCA9ICh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsIHkwID0gKHRoaXMuX3kwICsgNCAqIHRoaXMuX3kxICsgeTIpIC8gNjsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDAsIHkwKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgwLCB5MCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLl9wb2ludCA9IDQ7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNPcGVuX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNPcGVuKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2xpbmVhckNsb3NlZC5qcwpmdW5jdGlvbiBMaW5lYXJDbG9zZWQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkxpbmVhckNsb3NlZC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBub29wX2RlZmF1bHQsCiAgYXJlYUVuZDogbm9vcF9kZWZhdWx0LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9wb2ludCkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIGlmICh0aGlzLl9wb2ludCkgdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgIGVsc2UgdGhpcy5fcG9pbnQgPSAxLCB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogIH0KfTsKZnVuY3Rpb24gbGluZWFyQ2xvc2VkX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgTGluZWFyQ2xvc2VkKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL21vbm90b25lLmpzCmZ1bmN0aW9uIHNpZ24oeDIpIHsKICByZXR1cm4geDIgPCAwID8gLTEgOiAxOwp9CmZ1bmN0aW9uIHNsb3BlMyh0aGF0LCB4MiwgeTIpIHsKICB2YXIgaDAgPSB0aGF0Ll94MSAtIHRoYXQuX3gwLCBoMSA9IHgyIC0gdGhhdC5feDEsIHMwID0gKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gKGgwIHx8IGgxIDwgMCAmJiAtMCksIHMxID0gKHkyIC0gdGhhdC5feTEpIC8gKGgxIHx8IGgwIDwgMCAmJiAtMCksIHAgPSAoczAgKiBoMSArIHMxICogaDApIC8gKGgwICsgaDEpOwogIHJldHVybiAoc2lnbihzMCkgKyBzaWduKHMxKSkgKiBNYXRoLm1pbihNYXRoLmFicyhzMCksIE1hdGguYWJzKHMxKSwgMC41ICogTWF0aC5hYnMocCkpIHx8IDA7Cn0KZnVuY3Rpb24gc2xvcGUyKHRoYXQsIHQpIHsKICB2YXIgaCA9IHRoYXQuX3gxIC0gdGhhdC5feDA7CiAgcmV0dXJuIGggPyAoMyAqICh0aGF0Ll95MSAtIHRoYXQuX3kwKSAvIGggLSB0KSAvIDIgOiB0Owp9CmZ1bmN0aW9uIHBvaW50Mih0aGF0LCB0MDIsIHQxMikgewogIHZhciB4MCA9IHRoYXQuX3gwLCB5MCA9IHRoYXQuX3kwLCB4MSA9IHRoYXQuX3gxLCB5MSA9IHRoYXQuX3kxLCBkeCA9ICh4MSAtIHgwKSAvIDM7CiAgdGhhdC5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHgwICsgZHgsIHkwICsgZHggKiB0MDIsIHgxIC0gZHgsIHkxIC0gZHggKiB0MTIsIHgxLCB5MSk7Cn0KZnVuY3Rpb24gTW9ub3RvbmVYKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpNb25vdG9uZVgucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IHRoaXMuX3QwID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgcG9pbnQyKHRoaXMsIHRoaXMuX3QwLCBzbG9wZTIodGhpcywgdGhpcy5fdDApKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB2YXIgdDEyID0gTmFOOwogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgaWYgKHgyID09PSB0aGlzLl94MSAmJiB5MiA9PT0gdGhpcy5feTEpIHJldHVybjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgcG9pbnQyKHRoaXMsIHNsb3BlMih0aGlzLCB0MTIgPSBzbG9wZTModGhpcywgeDIsIHkyKSksIHQxMik7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQyKHRoaXMsIHRoaXMuX3QwLCB0MTIgPSBzbG9wZTModGhpcywgeDIsIHkyKSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICAgIHRoaXMuX3QwID0gdDEyOwogIH0KfTsKZnVuY3Rpb24gTW9ub3RvbmVZKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gbmV3IFJlZmxlY3RDb250ZXh0KGNvbnRleHQpOwp9CihNb25vdG9uZVkucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShNb25vdG9uZVgucHJvdG90eXBlKSkucG9pbnQgPSBmdW5jdGlvbih4MiwgeTIpIHsKICBNb25vdG9uZVgucHJvdG90eXBlLnBvaW50LmNhbGwodGhpcywgeTIsIHgyKTsKfTsKZnVuY3Rpb24gUmVmbGVjdENvbnRleHQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9ClJlZmxlY3RDb250ZXh0LnByb3RvdHlwZSA9IHsKICBtb3ZlVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5tb3ZlVG8oeTIsIHgyKTsKICB9LAogIGNsb3NlUGF0aDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogIH0sCiAgbGluZVRvOiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHkyLCB4Mik7CiAgfSwKICBiZXppZXJDdXJ2ZVRvOiBmdW5jdGlvbih4MSwgeTEsIHgyLCB5MiwgeDMsIHkzKSB7CiAgICB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8oeTEsIHgxLCB5MiwgeDIsIHkzLCB4Myk7CiAgfQp9OwpmdW5jdGlvbiBtb25vdG9uZVgoY29udGV4dCkgewogIHJldHVybiBuZXcgTW9ub3RvbmVYKGNvbnRleHQpOwp9CmZ1bmN0aW9uIG1vbm90b25lWShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVkoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbmF0dXJhbC5qcwpmdW5jdGlvbiBOYXR1cmFsKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpOYXR1cmFsLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feCA9IFtdOwogICAgdGhpcy5feSA9IFtdOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICB2YXIgeDIgPSB0aGlzLl94LCB5MiA9IHRoaXMuX3ksIG4gPSB4Mi5sZW5ndGg7CiAgICBpZiAobikgewogICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMF0sIHkyWzBdKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyWzBdLCB5MlswXSk7CiAgICAgIGlmIChuID09PSAyKSB7CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMV0sIHkyWzFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHggPSBjb250cm9sUG9pbnRzKHgyKSwgcHkgPSBjb250cm9sUG9pbnRzKHkyKTsKICAgICAgICBmb3IgKHZhciBpMCA9IDAsIGkxID0gMTsgaTEgPCBuOyArK2kwLCArK2kxKSB7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8ocHhbMF1baTBdLCBweVswXVtpMF0sIHB4WzFdW2kwXSwgcHlbMV1baTBdLCB4MltpMV0sIHkyW2kxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIG4gPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgICB0aGlzLl94ID0gdGhpcy5feSA9IG51bGw7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl94LnB1c2goK3gyKTsKICAgIHRoaXMuX3kucHVzaCgreTIpOwogIH0KfTsKZnVuY3Rpb24gY29udHJvbFBvaW50cyh4MikgewogIHZhciBpLCBuID0geDIubGVuZ3RoIC0gMSwgbSwgYSA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgcjIgPSBuZXcgQXJyYXkobik7CiAgYVswXSA9IDAsIGJbMF0gPSAyLCByMlswXSA9IHgyWzBdICsgMiAqIHgyWzFdOwogIGZvciAoaSA9IDE7IGkgPCBuIC0gMTsgKytpKSBhW2ldID0gMSwgYltpXSA9IDQsIHIyW2ldID0gNCAqIHgyW2ldICsgMiAqIHgyW2kgKyAxXTsKICBhW24gLSAxXSA9IDIsIGJbbiAtIDFdID0gNywgcjJbbiAtIDFdID0gOCAqIHgyW24gLSAxXSArIHgyW25dOwogIGZvciAoaSA9IDE7IGkgPCBuOyArK2kpIG0gPSBhW2ldIC8gYltpIC0gMV0sIGJbaV0gLT0gbSwgcjJbaV0gLT0gbSAqIHIyW2kgLSAxXTsKICBhW24gLSAxXSA9IHIyW24gLSAxXSAvIGJbbiAtIDFdOwogIGZvciAoaSA9IG4gLSAyOyBpID49IDA7IC0taSkgYVtpXSA9IChyMltpXSAtIGFbaSArIDFdKSAvIGJbaV07CiAgYltuIC0gMV0gPSAoeDJbbl0gKyBhW24gLSAxXSkgLyAyOwogIGZvciAoaSA9IDA7IGkgPCBuIC0gMTsgKytpKSBiW2ldID0gMiAqIHgyW2kgKyAxXSAtIGFbaSArIDFdOwogIHJldHVybiBbYSwgYl07Cn0KZnVuY3Rpb24gbmF0dXJhbF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE5hdHVyYWwoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvc3RlcC5qcwpmdW5jdGlvbiBTdGVwKGNvbnRleHQsIHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKICB0aGlzLl90ID0gdDsKfQpTdGVwLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feCA9IHRoaXMuX3kgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICgwIDwgdGhpcy5fdCAmJiB0aGlzLl90IDwgMSAmJiB0aGlzLl9wb2ludCA9PT0gMikgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feCwgdGhpcy5feSk7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgaWYgKHRoaXMuX2xpbmUgPj0gMCkgdGhpcy5fdCA9IDEgLSB0aGlzLl90LCB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgaWYgKHRoaXMuX3QgPD0gMCkgewogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feCwgeTIpOwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHgxID0gdGhpcy5feCAqICgxIC0gdGhpcy5fdCkgKyB4MiAqIHRoaXMuX3Q7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MSwgdGhpcy5feSk7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MSwgeTIpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy5feCA9IHgyLCB0aGlzLl95ID0geTI7CiAgfQp9OwpmdW5jdGlvbiBzdGVwX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgU3RlcChjb250ZXh0LCAwLjUpOwp9CmZ1bmN0aW9uIHN0ZXBCZWZvcmUoY29udGV4dCkgewogIHJldHVybiBuZXcgU3RlcChjb250ZXh0LCAwKTsKfQpmdW5jdGlvbiBzdGVwQWZ0ZXIoY29udGV4dCkgewogIHJldHVybiBuZXcgU3RlcChjb250ZXh0LCAxKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvbm9uZS5qcwpmdW5jdGlvbiBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAxKSkgcmV0dXJuOwogIGZvciAodmFyIGkgPSAxLCBqLCBzMCwgczEgPSBzZXJpZXNbb3JkZXJbMF1dLCBuLCBtID0gczEubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICBzMCA9IHMxLCBzMSA9IHNlcmllc1tvcmRlcltpXV07CiAgICBmb3IgKGogPSAwOyBqIDwgbTsgKytqKSB7CiAgICAgIHMxW2pdWzFdICs9IHMxW2pdWzBdID0gaXNOYU4oczBbal1bMV0pID8gczBbal1bMF0gOiBzMFtqXVsxXTsKICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb3JkZXIvbm9uZS5qcwpmdW5jdGlvbiBub25lX2RlZmF1bHQyKHNlcmllcykgewogIHZhciBuID0gc2VyaWVzLmxlbmd0aCwgbyA9IG5ldyBBcnJheShuKTsKICB3aGlsZSAoLS1uID49IDApIG9bbl0gPSBuOwogIHJldHVybiBvOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3N0YWNrLmpzCmZ1bmN0aW9uIHN0YWNrVmFsdWUoZCwga2V5KSB7CiAgcmV0dXJuIGRba2V5XTsKfQpmdW5jdGlvbiBzdGFja1NlcmllcyhrZXkpIHsKICBjb25zdCBzZXJpZXMgPSBbXTsKICBzZXJpZXMua2V5ID0ga2V5OwogIHJldHVybiBzZXJpZXM7Cn0KZnVuY3Rpb24gc3RhY2tfZGVmYXVsdCgpIHsKICB2YXIga2V5cyA9IGNvbnN0YW50X2RlZmF1bHQoW10pLCBvcmRlciA9IG5vbmVfZGVmYXVsdDIsIG9mZnNldCA9IG5vbmVfZGVmYXVsdCwgdmFsdWUgPSBzdGFja1ZhbHVlOwogIGZ1bmN0aW9uIHN0YWNrKGRhdGEpIHsKICAgIHZhciBzeiA9IEFycmF5LmZyb20oa2V5cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCBzdGFja1NlcmllcyksIGksIG4gPSBzei5sZW5ndGgsIGogPSAtMSwgb3o7CiAgICBmb3IgKGNvbnN0IGQgb2YgZGF0YSkgewogICAgICBmb3IgKGkgPSAwLCArK2o7IGkgPCBuOyArK2kpIHsKICAgICAgICAoc3pbaV1bal0gPSBbMCwgK3ZhbHVlKGQsIHN6W2ldLmtleSwgaiwgZGF0YSldKS5kYXRhID0gZDsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMCwgb3ogPSBhcnJheV9kZWZhdWx0KG9yZGVyKHN6KSk7IGkgPCBuOyArK2kpIHsKICAgICAgc3pbb3pbaV1dLmluZGV4ID0gaTsKICAgIH0KICAgIG9mZnNldChzeiwgb3opOwogICAgcmV0dXJuIHN6OwogIH0KICBzdGFjay5rZXlzID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoa2V5cyA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoQXJyYXkuZnJvbShfKSksIHN0YWNrKSA6IGtleXM7CiAgfTsKICBzdGFjay52YWx1ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHZhbHVlID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHN0YWNrKSA6IHZhbHVlOwogIH07CiAgc3RhY2sub3JkZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChvcmRlciA9IF8gPT0gbnVsbCA/IG5vbmVfZGVmYXVsdDIgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KEFycmF5LmZyb20oXykpLCBzdGFjaykgOiBvcmRlcjsKICB9OwogIHN0YWNrLm9mZnNldCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG9mZnNldCA9IF8gPT0gbnVsbCA/IG5vbmVfZGVmYXVsdCA6IF8sIHN0YWNrKSA6IG9mZnNldDsKICB9OwogIHJldHVybiBzdGFjazsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvZXhwYW5kLmpzCmZ1bmN0aW9uIGV4cGFuZF9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciBpLCBuLCBqID0gMCwgbSA9IHNlcmllc1swXS5sZW5ndGgsIHkyOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHkyID0gaSA9IDA7IGkgPCBuOyArK2kpIHkyICs9IHNlcmllc1tpXVtqXVsxXSB8fCAwOwogICAgaWYgKHkyKSBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSBzZXJpZXNbaV1bal1bMV0gLz0geTI7CiAgfQogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvc2lsaG91ZXR0ZS5qcwpmdW5jdGlvbiBzaWxob3VldHRlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGogPSAwLCBzMCA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMC5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCB5MiA9IDA7IGkgPCBuOyArK2kpIHkyICs9IHNlcmllc1tpXVtqXVsxXSB8fCAwOwogICAgczBbal1bMV0gKz0gczBbal1bMF0gPSAteTIgLyAyOwogIH0KICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L3dpZ2dsZS5qcwpmdW5jdGlvbiB3aWdnbGVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDApIHx8ICEoKG0gPSAoczAgPSBzZXJpZXNbb3JkZXJbMF1dKS5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciB5MiA9IDAsIGogPSAxLCBzMCwgbSwgbjsgaiA8IG07ICsraikgewogICAgZm9yICh2YXIgaSA9IDAsIHMxID0gMCwgczIgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciBzaSA9IHNlcmllc1tvcmRlcltpXV0sIHNpajAgPSBzaVtqXVsxXSB8fCAwLCBzaWoxID0gc2lbaiAtIDFdWzFdIHx8IDAsIHMzID0gKHNpajAgLSBzaWoxKSAvIDI7CiAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgaTsgKytrKSB7CiAgICAgICAgdmFyIHNrID0gc2VyaWVzW29yZGVyW2tdXSwgc2tqMCA9IHNrW2pdWzFdIHx8IDAsIHNrajEgPSBza1tqIC0gMV1bMV0gfHwgMDsKICAgICAgICBzMyArPSBza2owIC0gc2tqMTsKICAgICAgfQogICAgICBzMSArPSBzaWowLCBzMiArPSBzMyAqIHNpajA7CiAgICB9CiAgICBzMFtqIC0gMV1bMV0gKz0gczBbaiAtIDFdWzBdID0geTI7CiAgICBpZiAoczEpIHkyIC09IHMyIC8gczE7CiAgfQogIHMwW2ogLSAxXVsxXSArPSBzMFtqIC0gMV1bMF0gPSB5MjsKICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9EYXRhVXRpbHMuanMKdmFyIGltcG9ydF9nZXQgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKdmFyIG1hdGhTaWduID0gKHZhbHVlKSA9PiB7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKHZhbHVlID4gMCkgewogICAgcmV0dXJuIDE7CiAgfQogIHJldHVybiAtMTsKfTsKdmFyIGlzTmFuID0gKHZhbHVlKSA9PiB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiB2YWx1ZSAhPSArdmFsdWU7Cn07CnZhciBpc1BlcmNlbnQgPSAodmFsdWUpID0+IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiJSIpID09PSB2YWx1ZS5sZW5ndGggLSAxOwp2YXIgaXNOdW1iZXIgPSAodmFsdWUpID0+ICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiIHx8IHZhbHVlIGluc3RhbmNlb2YgTnVtYmVyKSAmJiAhaXNOYW4odmFsdWUpOwp2YXIgaXNOdW1PclN0ciA9ICh2YWx1ZSkgPT4gaXNOdW1iZXIodmFsdWUpIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyI7CnZhciBpZENvdW50ZXIgPSAwOwp2YXIgdW5pcXVlSWQgPSAocHJlZml4KSA9PiB7CiAgdmFyIGlkID0gKytpZENvdW50ZXI7CiAgcmV0dXJuICIiLmNvbmNhdChwcmVmaXggfHwgIiIpLmNvbmNhdChpZCk7Cn07CnZhciBnZXRQZXJjZW50VmFsdWUgPSBmdW5jdGlvbiBnZXRQZXJjZW50VmFsdWUyKHBlcmNlbnQsIHRvdGFsVmFsdWUpIHsKICB2YXIgZGVmYXVsdFZhbHVlID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiAwOwogIHZhciB2YWxpZGF0ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogZmFsc2U7CiAgaWYgKCFpc051bWJlcihwZXJjZW50KSAmJiB0eXBlb2YgcGVyY2VudCAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgfQogIHZhciB2YWx1ZTsKICBpZiAoaXNQZXJjZW50KHBlcmNlbnQpKSB7CiAgICBpZiAodG90YWxWYWx1ZSA9PSBudWxsKSB7CiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICB9CiAgICB2YXIgaW5kZXggPSBwZXJjZW50LmluZGV4T2YoIiUiKTsKICAgIHZhbHVlID0gdG90YWxWYWx1ZSAqIHBhcnNlRmxvYXQocGVyY2VudC5zbGljZSgwLCBpbmRleCkpIC8gMTAwOwogIH0gZWxzZSB7CiAgICB2YWx1ZSA9ICtwZXJjZW50OwogIH0KICBpZiAoaXNOYW4odmFsdWUpKSB7CiAgICB2YWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICB9CiAgaWYgKHZhbGlkYXRlICYmIHRvdGFsVmFsdWUgIT0gbnVsbCAmJiB2YWx1ZSA+IHRvdGFsVmFsdWUpIHsKICAgIHZhbHVlID0gdG90YWxWYWx1ZTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgaGFzRHVwbGljYXRlID0gKGFyeSkgPT4gewogIGlmICghQXJyYXkuaXNBcnJheShhcnkpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBsZW4gPSBhcnkubGVuZ3RoOwogIHZhciBjYWNoZSA9IHt9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIGlmICghY2FjaGVbYXJ5W2ldXSkgewogICAgICBjYWNoZVthcnlbaV1dID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07CmZ1bmN0aW9uIGludGVycG9sYXRlKHN0YXJ0LCBlbmQsIHQpIHsKICBpZiAoaXNOdW1iZXIoc3RhcnQpICYmIGlzTnVtYmVyKGVuZCkpIHsKICAgIHJldHVybiBzdGFydCArIHQgKiAoZW5kIC0gc3RhcnQpOwogIH0KICByZXR1cm4gZW5kOwp9CmZ1bmN0aW9uIGZpbmRFbnRyeUluQXJyYXkoYXJ5LCBzcGVjaWZpZWRLZXksIHNwZWNpZmllZFZhbHVlKSB7CiAgaWYgKCFhcnkgfHwgIWFyeS5sZW5ndGgpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBhcnkuZmluZCgoZW50cnkpID0+IGVudHJ5ICYmICh0eXBlb2Ygc3BlY2lmaWVkS2V5ID09PSAiZnVuY3Rpb24iID8gc3BlY2lmaWVkS2V5KGVudHJ5KSA6ICgwLCBpbXBvcnRfZ2V0LmRlZmF1bHQpKGVudHJ5LCBzcGVjaWZpZWRLZXkpKSA9PT0gc3BlY2lmaWVkVmFsdWUpOwp9CnZhciBpc051bGxpc2ggPSAodmFsdWUpID0+IHsKICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIjsKfTsKdmFyIHVwcGVyRmlyc3QgPSAodmFsdWUpID0+IHsKICBpZiAoaXNOdWxsaXNoKHZhbHVlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICByZXR1cm4gIiIuY29uY2F0KHZhbHVlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpKS5jb25jYXQodmFsdWUuc2xpY2UoMSkpOwp9OwpmdW5jdGlvbiBpc05vdE5pbCh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPSBudWxsOwp9CmZ1bmN0aW9uIG5vb3AoKSB7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC90eXBlcy5qcwp2YXIgaW1wb3J0X3JlYWN0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGlzUG9sYXJDb29yZGluYXRlID0gKGMpID0+IHsKICByZXR1cm4gInJhZGl1cyIgaW4gYyAmJiAic3RhcnRBbmdsZSIgaW4gYyAmJiAiZW5kQW5nbGUiIGluIGM7Cn07CnZhciBhZGFwdEV2ZW50SGFuZGxlcnMgPSAocHJvcHMsIG5ld0hhbmRsZXIpID0+IHsKICBpZiAoIXByb3BzIHx8IHR5cGVvZiBwcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgcHJvcHMgPT09ICJib29sZWFuIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBpbnB1dFByb3BzID0gcHJvcHM7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0Ny5pc1ZhbGlkRWxlbWVudCkocHJvcHMpKSB7CiAgICBpbnB1dFByb3BzID0gcHJvcHMucHJvcHM7CiAgfQogIGlmICh0eXBlb2YgaW5wdXRQcm9wcyAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIGlucHV0UHJvcHMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb3V0ID0ge307CiAgT2JqZWN0LmtleXMoaW5wdXRQcm9wcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICBpZiAoaXNFdmVudEtleShrZXkpKSB7CiAgICAgIG91dFtrZXldID0gbmV3SGFuZGxlciB8fCAoKGUpID0+IGlucHV0UHJvcHNba2V5XShpbnB1dFByb3BzLCBlKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dDsKfTsKdmFyIGdldEV2ZW50SGFuZGxlck9mQ2hpbGQgPSAob3JpZ2luYWxIYW5kbGVyLCBkYXRhLCBpbmRleCkgPT4gKGUpID0+IHsKICBvcmlnaW5hbEhhbmRsZXIoZGF0YSwgaW5kZXgsIGUpOwogIHJldHVybiBudWxsOwp9Owp2YXIgYWRhcHRFdmVudHNPZkNoaWxkID0gKHByb3BzLCBkYXRhLCBpbmRleCkgPT4gewogIGlmIChwcm9wcyA9PT0gbnVsbCB8fCB0eXBlb2YgcHJvcHMgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9wcyAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvdXQgPSBudWxsOwogIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIHZhciBpdGVtID0gcHJvcHNba2V5XTsKICAgIGlmIChpc0V2ZW50S2V5KGtleSkgJiYgdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCFvdXQpIG91dCA9IHt9OwogICAgICBvdXRba2V5XSA9IGdldEV2ZW50SGFuZGxlck9mQ2hpbGQoaXRlbSwgZGF0YSwgaW5kZXgpOwogICAgfQogIH0pOwogIHJldHVybiBvdXQ7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvcmVzb2x2ZURlZmF1bHRQcm9wcy5qcwpmdW5jdGlvbiBvd25LZXlzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHJlc29sdmVEZWZhdWx0UHJvcHMocmVhbFByb3BzLCBkZWZhdWx0UHJvcHMpIHsKICB2YXIgcmVzb2x2ZWRQcm9wcyA9IF9vYmplY3RTcHJlYWQoe30sIHJlYWxQcm9wcyk7CiAgdmFyIGRwID0gZGVmYXVsdFByb3BzOwogIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZGVmYXVsdFByb3BzKTsKICB2YXIgd2l0aERlZmF1bHRzID0ga2V5cy5yZWR1Y2UoKGFjYywga2V5KSA9PiB7CiAgICBpZiAoYWNjW2tleV0gPT09IHZvaWQgMCAmJiBkcFtrZXldICE9PSB2b2lkIDApIHsKICAgICAgYWNjW2tleV0gPSBkcFtrZXldOwogICAgfQogICAgcmV0dXJuIGFjYzsKICB9LCByZXNvbHZlZFByb3BzKTsKICByZXR1cm4gd2l0aERlZmF1bHRzOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvcGF5bG9hZC9nZXRVbmlxUGF5bG9hZC5qcwp2YXIgaW1wb3J0X3VuaXFCeSA9IF9fdG9FU00ocmVxdWlyZV91bmlxQnkzKCkpOwpmdW5jdGlvbiBnZXRVbmlxUGF5bG9hZChwYXlsb2FkLCBvcHRpb24sIGRlZmF1bHRVbmlxQnkyKSB7CiAgaWYgKG9wdGlvbiA9PT0gdHJ1ZSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfdW5pcUJ5LmRlZmF1bHQpKHBheWxvYWQsIGRlZmF1bHRVbmlxQnkyKTsKICB9CiAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X3VuaXFCeS5kZWZhdWx0KShwYXlsb2FkLCBvcHRpb24pOwogIH0KICByZXR1cm4gcGF5bG9hZDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ob29rcy5qcwp2YXIgaW1wb3J0X3dpdGhfc2VsZWN0b3IgPSBfX3RvRVNNKHJlcXVpcmVfd2l0aF9zZWxlY3RvcigpKTsKdmFyIGltcG9ydF9yZWFjdDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzUmVkdXhDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3Q4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgUmVjaGFydHNSZWR1eENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDguY3JlYXRlQ29udGV4dCkobnVsbCk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2hvb2tzLmpzCnZhciBub29wRGlzcGF0Y2ggPSAoYSkgPT4gYTsKdmFyIHVzZUFwcERpc3BhdGNoID0gKCkgPT4gewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIGlmIChjb250ZXh0KSB7CiAgICByZXR1cm4gY29udGV4dC5zdG9yZS5kaXNwYXRjaDsKICB9CiAgcmV0dXJuIG5vb3BEaXNwYXRjaDsKfTsKdmFyIG5vb3AyID0gKCkgPT4gewp9Owp2YXIgYWRkTmVzdGVkU3ViTm9vcCA9ICgpID0+IG5vb3AyOwp2YXIgcmVmRXF1YWxpdHkgPSAoYSwgYikgPT4gYSA9PT0gYjsKZnVuY3Rpb24gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0b3IpIHsKICB2YXIgY29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3Q5LnVzZUNvbnRleHQpKFJlY2hhcnRzUmVkdXhDb250ZXh0KTsKICByZXR1cm4gKDAsIGltcG9ydF93aXRoX3NlbGVjdG9yLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yKShjb250ZXh0ID8gY29udGV4dC5zdWJzY3JpcHRpb24uYWRkTmVzdGVkU3ViIDogYWRkTmVzdGVkU3ViTm9vcCwgY29udGV4dCA/IGNvbnRleHQuc3RvcmUuZ2V0U3RhdGUgOiBub29wMiwgY29udGV4dCA/IGNvbnRleHQuc3RvcmUuZ2V0U3RhdGUgOiBub29wMiwgY29udGV4dCA/IHNlbGVjdG9yIDogbm9vcDIsIHJlZkVxdWFsaXR5KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3Jlc2VsZWN0L2Rpc3QvcmVzZWxlY3QubWpzCnZhciBydW5JZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPSAocmVzdWx0RnVuYywgaW5wdXRTZWxlY3RvcnNSZXN1bHRzLCBvdXRwdXRTZWxlY3RvclJlc3VsdCkgPT4gewogIGlmIChpbnB1dFNlbGVjdG9yc1Jlc3VsdHMubGVuZ3RoID09PSAxICYmIGlucHV0U2VsZWN0b3JzUmVzdWx0c1swXSA9PT0gb3V0cHV0U2VsZWN0b3JSZXN1bHQpIHsKICAgIGxldCBpc0lucHV0U2FtZUFzT3V0cHV0ID0gZmFsc2U7CiAgICB0cnkgewogICAgICBjb25zdCBlbXB0eU9iamVjdCA9IHt9OwogICAgICBpZiAocmVzdWx0RnVuYyhlbXB0eU9iamVjdCkgPT09IGVtcHR5T2JqZWN0KQogICAgICAgIGlzSW5wdXRTYW1lQXNPdXRwdXQgPSB0cnVlOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICBpZiAoaXNJbnB1dFNhbWVBc091dHB1dCkgewogICAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICAgIHRyeSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICA7CiAgICAgICAgKHsgc3RhY2sgfSA9IGUpOwogICAgICB9CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAiVGhlIHJlc3VsdCBmdW5jdGlvbiByZXR1cm5lZCBpdHMgb3duIGlucHV0cyB3aXRob3V0IG1vZGlmaWNhdGlvbi4gZS5nXG5gY3JlYXRlU2VsZWN0b3IoW3N0YXRlID0+IHN0YXRlLnRvZG9zXSwgdG9kb3MgPT4gdG9kb3MpYFxuVGhpcyBjb3VsZCBsZWFkIHRvIGluZWZmaWNpZW50IG1lbW9pemF0aW9uIGFuZCB1bm5lY2Vzc2FyeSByZS1yZW5kZXJzLlxuRW5zdXJlIHRyYW5zZm9ybWF0aW9uIGxvZ2ljIGlzIGluIHRoZSByZXN1bHQgZnVuY3Rpb24sIGFuZCBleHRyYWN0aW9uIGxvZ2ljIGlzIGluIHRoZSBpbnB1dCBzZWxlY3RvcnMuIiwKICAgICAgICB7IHN0YWNrIH0KICAgICAgKTsKICAgIH0KICB9Cn07CnZhciBydW5JbnB1dFN0YWJpbGl0eUNoZWNrID0gKGlucHV0U2VsZWN0b3JSZXN1bHRzT2JqZWN0LCBvcHRpb25zLCBpbnB1dFNlbGVjdG9yQXJncykgPT4gewogIGNvbnN0IHsgbWVtb2l6ZSwgbWVtb2l6ZU9wdGlvbnMgfSA9IG9wdGlvbnM7CiAgY29uc3QgeyBpbnB1dFNlbGVjdG9yUmVzdWx0cywgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5IH0gPSBpbnB1dFNlbGVjdG9yUmVzdWx0c09iamVjdDsKICBjb25zdCBjcmVhdGVBbkVtcHR5T2JqZWN0ID0gbWVtb2l6ZSgoKSA9PiAoe30pLCAuLi5tZW1vaXplT3B0aW9ucyk7CiAgY29uc3QgYXJlSW5wdXRTZWxlY3RvclJlc3VsdHNFcXVhbCA9IGNyZWF0ZUFuRW1wdHlPYmplY3QuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHMpID09PSBjcmVhdGVBbkVtcHR5T2JqZWN0LmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSk7CiAgaWYgKCFhcmVJbnB1dFNlbGVjdG9yUmVzdWx0c0VxdWFsKSB7CiAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgOwogICAgICAoeyBzdGFjayB9ID0gZSk7CiAgICB9CiAgICBjb25zb2xlLndhcm4oCiAgICAgICJBbiBpbnB1dCBzZWxlY3RvciByZXR1cm5lZCBhIGRpZmZlcmVudCByZXN1bHQgd2hlbiBwYXNzZWQgc2FtZSBhcmd1bWVudHMuXG5UaGlzIG1lYW5zIHlvdXIgb3V0cHV0IHNlbGVjdG9yIHdpbGwgbGlrZWx5IHJ1biBtb3JlIGZyZXF1ZW50bHkgdGhhbiBpbnRlbmRlZC5cbkF2b2lkIHJldHVybmluZyBhIG5ldyByZWZlcmVuY2UgaW5zaWRlIHlvdXIgaW5wdXQgc2VsZWN0b3IsIGUuZy5cbmBjcmVhdGVTZWxlY3Rvcihbc3RhdGUgPT4gc3RhdGUudG9kb3MubWFwKHRvZG8gPT4gdG9kby5pZCldLCB0b2RvSWRzID0+IHRvZG9JZHMubGVuZ3RoKWAiLAogICAgICB7CiAgICAgICAgYXJndW1lbnRzOiBpbnB1dFNlbGVjdG9yQXJncywKICAgICAgICBmaXJzdElucHV0czogaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgc2Vjb25kSW5wdXRzOiBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHksCiAgICAgICAgc3RhY2sKICAgICAgfQogICAgKTsKICB9Cn07CnZhciBnbG9iYWxEZXZNb2RlQ2hlY2tzID0gewogIGlucHV0U3RhYmlsaXR5Q2hlY2s6ICJvbmNlIiwKICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6ICJvbmNlIgp9OwpmdW5jdGlvbiBhc3NlcnRJc0Z1bmN0aW9uKGZ1bmMsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhIGZ1bmN0aW9uLCBpbnN0ZWFkIHJlY2VpdmVkICR7dHlwZW9mIGZ1bmN9YCkgewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRJc09iamVjdChvYmplY3QsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhbiBvYmplY3QsIGluc3RlYWQgcmVjZWl2ZWQgJHt0eXBlb2Ygb2JqZWN0fWApIHsKICBpZiAodHlwZW9mIG9iamVjdCAhPT0gIm9iamVjdCIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKGFycmF5LCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYWxsIGl0ZW1zIHRvIGJlIGZ1bmN0aW9ucywgaW5zdGVhZCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgKSB7CiAgaWYgKCFhcnJheS5ldmVyeSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpKSB7CiAgICBjb25zdCBpdGVtVHlwZXMgPSBhcnJheS5tYXAoCiAgICAgIChpdGVtKSA9PiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiA/IGBmdW5jdGlvbiAke2l0ZW0ubmFtZSB8fCAidW5uYW1lZCJ9KClgIDogdHlwZW9mIGl0ZW0KICAgICkuam9pbigiLCAiKTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYCR7ZXJyb3JNZXNzYWdlfVske2l0ZW1UeXBlc31dYCk7CiAgfQp9CnZhciBlbnN1cmVJc0FycmF5ID0gKGl0ZW0pID0+IHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGl0ZW0gOiBbaXRlbV07Cn07CmZ1bmN0aW9uIGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpIHsKICBjb25zdCBkZXBlbmRlbmNpZXMgPSBBcnJheS5pc0FycmF5KGNyZWF0ZVNlbGVjdG9yQXJnc1swXSkgPyBjcmVhdGVTZWxlY3RvckFyZ3NbMF0gOiBjcmVhdGVTZWxlY3RvckFyZ3M7CiAgYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKAogICAgZGVwZW5kZW5jaWVzLAogICAgYGNyZWF0ZVNlbGVjdG9yIGV4cGVjdHMgYWxsIGlucHV0LXNlbGVjdG9ycyB0byBiZSBmdW5jdGlvbnMsIGJ1dCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgCiAgKTsKICByZXR1cm4gZGVwZW5kZW5jaWVzOwp9CmZ1bmN0aW9uIGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cyhkZXBlbmRlbmNpZXMsIGlucHV0U2VsZWN0b3JBcmdzKSB7CiAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHMgPSBbXTsKICBjb25zdCB7IGxlbmd0aCB9ID0gZGVwZW5kZW5jaWVzOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGlucHV0U2VsZWN0b3JSZXN1bHRzLnB1c2goZGVwZW5kZW5jaWVzW2ldLmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JBcmdzKSk7CiAgfQogIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0czsKfQp2YXIgZ2V0RGV2TW9kZUNoZWNrc0V4ZWN1dGlvbkluZm8gPSAoZmlyc3RSdW4sIGRldk1vZGVDaGVja3MpID0+IHsKICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjaywgaW5wdXRTdGFiaWxpdHlDaGVjayB9ID0gewogICAgLi4uZ2xvYmFsRGV2TW9kZUNoZWNrcywKICAgIC4uLmRldk1vZGVDaGVja3MKICB9OwogIHJldHVybiB7CiAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPT09ICJhbHdheXMiIHx8IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9PT0gIm9uY2UiICYmIGZpcnN0UnVuLAogICAgICBydW46IHJ1bklkZW50aXR5RnVuY3Rpb25DaGVjawogICAgfSwKICAgIGlucHV0U3RhYmlsaXR5Q2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAiYWx3YXlzIiB8fCBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAib25jZSIgJiYgZmlyc3RSdW4sCiAgICAgIHJ1bjogcnVuSW5wdXRTdGFiaWxpdHlDaGVjawogICAgfQogIH07Cn07CnZhciBSRURVWF9QUk9YWV9MQUJFTCA9IFN5bWJvbCgpOwp2YXIgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yoe30pOwp2YXIgU3Ryb25nUmVmID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfQogIGRlcmVmKCkgewogICAgcmV0dXJuIHRoaXMudmFsdWU7CiAgfQp9Owp2YXIgUmVmID0gdHlwZW9mIFdlYWtSZWYgIT09ICJ1bmRlZmluZWQiID8gV2Vha1JlZiA6IFN0cm9uZ1JlZjsKdmFyIFVOVEVSTUlOQVRFRCA9IDA7CnZhciBURVJNSU5BVEVEID0gMTsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVOb2RlKCkgewogIHJldHVybiB7CiAgICBzOiBVTlRFUk1JTkFURUQsCiAgICB2OiB2b2lkIDAsCiAgICBvOiBudWxsLAogICAgcDogbnVsbAogIH07Cn0KZnVuY3Rpb24gd2Vha01hcE1lbW9pemUoZnVuYywgb3B0aW9ucyA9IHt9KSB7CiAgbGV0IGZuTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogIGNvbnN0IHsgcmVzdWx0RXF1YWxpdHlDaGVjayB9ID0gb3B0aW9uczsKICBsZXQgbGFzdFJlc3VsdDsKICBsZXQgcmVzdWx0c0NvdW50ID0gMDsKICBmdW5jdGlvbiBtZW1vaXplZCgpIHsKICAgIGxldCBjYWNoZU5vZGUgPSBmbk5vZGU7CiAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXJndW1lbnRzOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBsZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3QgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBpZiAodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXJnID09PSAib2JqZWN0IiAmJiBhcmcgIT09IG51bGwpIHsKICAgICAgICBsZXQgb2JqZWN0Q2FjaGUgPSBjYWNoZU5vZGUubzsKICAgICAgICBpZiAob2JqZWN0Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlTm9kZS5vID0gb2JqZWN0Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2JqZWN0Tm9kZSA9IG9iamVjdENhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChvYmplY3ROb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgb2JqZWN0Q2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gb2JqZWN0Tm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IHByaW1pdGl2ZUNhY2hlID0gY2FjaGVOb2RlLnA7CiAgICAgICAgaWYgKHByaW1pdGl2ZUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUucCA9IHByaW1pdGl2ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJpbWl0aXZlTm9kZSA9IHByaW1pdGl2ZUNhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChwcmltaXRpdmVOb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgcHJpbWl0aXZlQ2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gcHJpbWl0aXZlTm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRlcm1pbmF0ZWROb2RlID0gY2FjaGVOb2RlOwogICAgbGV0IHJlc3VsdDsKICAgIGlmIChjYWNoZU5vZGUucyA9PT0gVEVSTUlOQVRFRCkgewogICAgICByZXN1bHQgPSBjYWNoZU5vZGUudjsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgcmVzdWx0c0NvdW50Kys7CiAgICAgIGlmIChyZXN1bHRFcXVhbGl0eUNoZWNrKSB7CiAgICAgICAgY29uc3QgbGFzdFJlc3VsdFZhbHVlID0gbGFzdFJlc3VsdD8uZGVyZWY/LigpID8/IGxhc3RSZXN1bHQ7CiAgICAgICAgaWYgKGxhc3RSZXN1bHRWYWx1ZSAhPSBudWxsICYmIHJlc3VsdEVxdWFsaXR5Q2hlY2sobGFzdFJlc3VsdFZhbHVlLCByZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBsYXN0UmVzdWx0VmFsdWU7CiAgICAgICAgICByZXN1bHRzQ291bnQgIT09IDAgJiYgcmVzdWx0c0NvdW50LS07CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5lZWRzV2Vha1JlZiA9IHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiICYmIHJlc3VsdCAhPT0gbnVsbCB8fCB0eXBlb2YgcmVzdWx0ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGxhc3RSZXN1bHQgPSBuZWVkc1dlYWtSZWYgPyBuZXcgUmVmKHJlc3VsdCkgOiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHRlcm1pbmF0ZWROb2RlLnMgPSBURVJNSU5BVEVEOwogICAgdGVybWluYXRlZE5vZGUudiA9IHJlc3VsdDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIG1lbW9pemVkLmNsZWFyQ2FjaGUgPSAoKSA9PiB7CiAgICBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50KCk7CiAgfTsKICBtZW1vaXplZC5yZXN1bHRzQ291bnQgPSAoKSA9PiByZXN1bHRzQ291bnQ7CiAgbWVtb2l6ZWQucmVzZXRSZXN1bHRzQ291bnQgPSAoKSA9PiB7CiAgICByZXN1bHRzQ291bnQgPSAwOwogIH07CiAgcmV0dXJuIG1lbW9pemVkOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcihtZW1vaXplT3JPcHRpb25zLCAuLi5tZW1vaXplT3B0aW9uc0Zyb21BcmdzKSB7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucyA9IHR5cGVvZiBtZW1vaXplT3JPcHRpb25zID09PSAiZnVuY3Rpb24iID8gewogICAgbWVtb2l6ZTogbWVtb2l6ZU9yT3B0aW9ucywKICAgIG1lbW9pemVPcHRpb25zOiBtZW1vaXplT3B0aW9uc0Zyb21BcmdzCiAgfSA6IG1lbW9pemVPck9wdGlvbnM7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3IyID0gKC4uLmNyZWF0ZVNlbGVjdG9yQXJncykgPT4gewogICAgbGV0IHJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMgPSAwOwogICAgbGV0IGxhc3RSZXN1bHQ7CiAgICBsZXQgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0ge307CiAgICBsZXQgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIGlmICh0eXBlb2YgcmVzdWx0RnVuYyA9PT0gIm9iamVjdCIpIHsKICAgICAgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0gcmVzdWx0RnVuYzsKICAgICAgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIH0KICAgIGFzc2VydElzRnVuY3Rpb24oCiAgICAgIHJlc3VsdEZ1bmMsCiAgICAgIGBjcmVhdGVTZWxlY3RvciBleHBlY3RzIGFuIG91dHB1dCBmdW5jdGlvbiBhZnRlciB0aGUgaW5wdXRzLCBidXQgcmVjZWl2ZWQ6IFske3R5cGVvZiByZXN1bHRGdW5jfV1gCiAgICApOwogICAgY29uc3QgY29tYmluZWRPcHRpb25zID0gewogICAgICAuLi5jcmVhdGVTZWxlY3RvckNyZWF0b3JPcHRpb25zLAogICAgICAuLi5kaXJlY3RseVBhc3NlZE9wdGlvbnMKICAgIH07CiAgICBjb25zdCB7CiAgICAgIG1lbW9pemUsCiAgICAgIG1lbW9pemVPcHRpb25zID0gW10sCiAgICAgIGFyZ3NNZW1vaXplID0gd2Vha01hcE1lbW9pemUsCiAgICAgIGFyZ3NNZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBkZXZNb2RlQ2hlY2tzID0ge30KICAgIH0gPSBjb21iaW5lZE9wdGlvbnM7CiAgICBjb25zdCBmaW5hbE1lbW9pemVPcHRpb25zID0gZW5zdXJlSXNBcnJheShtZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBmaW5hbEFyZ3NNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkoYXJnc01lbW9pemVPcHRpb25zKTsKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpOwogICAgY29uc3QgbWVtb2l6ZWRSZXN1bHRGdW5jID0gbWVtb2l6ZShmdW5jdGlvbiByZWNvbXB1dGF0aW9uV3JhcHBlcigpIHsKICAgICAgcmVjb21wdXRhdGlvbnMrKzsKICAgICAgcmV0dXJuIHJlc3VsdEZ1bmMuYXBwbHkoCiAgICAgICAgbnVsbCwKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgIH0sIC4uLmZpbmFsTWVtb2l6ZU9wdGlvbnMpOwogICAgbGV0IGZpcnN0UnVuID0gdHJ1ZTsKICAgIGNvbnN0IHNlbGVjdG9yID0gYXJnc01lbW9pemUoZnVuY3Rpb24gZGVwZW5kZW5jaWVzQ2hlY2tlcigpIHsKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zKys7CiAgICAgIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgIGRlcGVuZGVuY2llcywKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgICAgbGFzdFJlc3VsdCA9IG1lbW9pemVkUmVzdWx0RnVuYy5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0cyk7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2ssIGlucHV0U3RhYmlsaXR5Q2hlY2sgfSA9IGdldERldk1vZGVDaGVja3NFeGVjdXRpb25JbmZvKGZpcnN0UnVuLCBkZXZNb2RlQ2hlY2tzKTsKICAgICAgICBpZiAoaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnJ1bigKICAgICAgICAgICAgcmVzdWx0RnVuYywKICAgICAgICAgICAgaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgICAgIGxhc3RSZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dFN0YWJpbGl0eUNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5ID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgKTsKICAgICAgICAgIGlucHV0U3RhYmlsaXR5Q2hlY2sucnVuKAogICAgICAgICAgICB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSwKICAgICAgICAgICAgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9uczogZmluYWxNZW1vaXplT3B0aW9ucyB9LAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdFJ1bikKICAgICAgICAgIGZpcnN0UnVuID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RSZXN1bHQ7CiAgICB9LCAuLi5maW5hbEFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihzZWxlY3RvciwgewogICAgICByZXN1bHRGdW5jLAogICAgICBtZW1vaXplZFJlc3VsdEZ1bmMsCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMsCiAgICAgIHJlc2V0RGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zID0gMDsKICAgICAgfSwKICAgICAgbGFzdFJlc3VsdDogKCkgPT4gbGFzdFJlc3VsdCwKICAgICAgcmVjb21wdXRhdGlvbnM6ICgpID0+IHJlY29tcHV0YXRpb25zLAogICAgICByZXNldFJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgcmVjb21wdXRhdGlvbnMgPSAwOwogICAgICB9LAogICAgICBtZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZQogICAgfSk7CiAgfTsKICBPYmplY3QuYXNzaWduKGNyZWF0ZVNlbGVjdG9yMiwgewogICAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVTZWxlY3RvcjIKICB9KTsKICByZXR1cm4gY3JlYXRlU2VsZWN0b3IyOwp9CnZhciBjcmVhdGVTZWxlY3RvciA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVTZWxlY3RvckNyZWF0b3Iod2Vha01hcE1lbW9pemUpOwp2YXIgY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yID0gT2JqZWN0LmFzc2lnbigKICAoaW5wdXRTZWxlY3RvcnNPYmplY3QsIHNlbGVjdG9yQ3JlYXRvciA9IGNyZWF0ZVNlbGVjdG9yKSA9PiB7CiAgICBhc3NlcnRJc09iamVjdCgKICAgICAgaW5wdXRTZWxlY3RvcnNPYmplY3QsCiAgICAgIGBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgZXhwZWN0cyBmaXJzdCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2hlcmUgZWFjaCBwcm9wZXJ0eSBpcyBhIHNlbGVjdG9yLCBpbnN0ZWFkIHJlY2VpdmVkIGEgJHt0eXBlb2YgaW5wdXRTZWxlY3RvcnNPYmplY3R9YAogICAgKTsKICAgIGNvbnN0IGlucHV0U2VsZWN0b3JLZXlzID0gT2JqZWN0LmtleXMoaW5wdXRTZWxlY3RvcnNPYmplY3QpOwogICAgY29uc3QgZGVwZW5kZW5jaWVzID0gaW5wdXRTZWxlY3RvcktleXMubWFwKAogICAgICAoa2V5KSA9PiBpbnB1dFNlbGVjdG9yc09iamVjdFtrZXldCiAgICApOwogICAgY29uc3Qgc3RydWN0dXJlZFNlbGVjdG9yID0gc2VsZWN0b3JDcmVhdG9yKAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICguLi5pbnB1dFNlbGVjdG9yUmVzdWx0cykgPT4gewogICAgICAgIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0cy5yZWR1Y2UoKGNvbXBvc2l0aW9uLCB2YWx1ZSwgaW5kZXgpID0+IHsKICAgICAgICAgIGNvbXBvc2l0aW9uW2lucHV0U2VsZWN0b3JLZXlzW2luZGV4XV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiBjb21wb3NpdGlvbjsKICAgICAgICB9LCB7fSk7CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gc3RydWN0dXJlZFNlbGVjdG9yOwogIH0sCiAgeyB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciB9Cik7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9sZWdlbmRTZWxlY3RvcnMuanMKdmFyIGltcG9ydF9zb3J0QnkgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKdmFyIHNlbGVjdExlZ2VuZFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5sZWdlbmQuc2V0dGluZ3M7CnZhciBzZWxlY3RMZWdlbmRTaXplID0gKHN0YXRlKSA9PiBzdGF0ZS5sZWdlbmQuc2l6ZTsKdmFyIHNlbGVjdEFsbExlZ2VuZFBheWxvYWQyREFycmF5ID0gKHN0YXRlKSA9PiBzdGF0ZS5sZWdlbmQucGF5bG9hZDsKdmFyIHNlbGVjdExlZ2VuZFBheWxvYWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsTGVnZW5kUGF5bG9hZDJEQXJyYXksIHNlbGVjdExlZ2VuZFNldHRpbmdzXSwgKHBheWxvYWRzLCBfcmVmMikgPT4gewogIHZhciB7CiAgICBpdGVtU29ydGVyCiAgfSA9IF9yZWYyOwogIHZhciBmbGF0ID0gcGF5bG9hZHMuZmxhdCgxKTsKICByZXR1cm4gaXRlbVNvcnRlciA/ICgwLCBpbXBvcnRfc29ydEJ5LmRlZmF1bHQpKGZsYXQsIGl0ZW1Tb3J0ZXIpIDogZmxhdDsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlRWxlbWVudE9mZnNldC5qcwp2YXIgaW1wb3J0X3JlYWN0MTAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBFUFMgPSAxOwpmdW5jdGlvbiB1c2VFbGVtZW50T2Zmc2V0KCkgewogIHZhciBleHRyYURlcGVuZGVuY2llcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzBdIDogW107CiAgdmFyIFtsYXN0Qm91bmRpbmdCb3gsIHNldExhc3RCb3VuZGluZ0JveF0gPSAoMCwgaW1wb3J0X3JlYWN0MTAudXNlU3RhdGUpKHsKICAgIGhlaWdodDogMCwKICAgIGxlZnQ6IDAsCiAgICB0b3A6IDAsCiAgICB3aWR0aDogMAogIH0pOwogIHZhciB1cGRhdGVCb3VuZGluZ0JveCA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VDYWxsYmFjaykoCiAgICAobm9kZSkgPT4gewogICAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgdmFyIHJlY3QgPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHZhciBib3ggPSB7CiAgICAgICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0LAogICAgICAgICAgbGVmdDogcmVjdC5sZWZ0LAogICAgICAgICAgdG9wOiByZWN0LnRvcCwKICAgICAgICAgIHdpZHRoOiByZWN0LndpZHRoCiAgICAgICAgfTsKICAgICAgICBpZiAoTWF0aC5hYnMoYm94LmhlaWdodCAtIGxhc3RCb3VuZGluZ0JveC5oZWlnaHQpID4gRVBTIHx8IE1hdGguYWJzKGJveC5sZWZ0IC0gbGFzdEJvdW5kaW5nQm94LmxlZnQpID4gRVBTIHx8IE1hdGguYWJzKGJveC50b3AgLSBsYXN0Qm91bmRpbmdCb3gudG9wKSA+IEVQUyB8fCBNYXRoLmFicyhib3gud2lkdGggLSBsYXN0Qm91bmRpbmdCb3gud2lkdGgpID4gRVBTKSB7CiAgICAgICAgICBzZXRMYXN0Qm91bmRpbmdCb3goewogICAgICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQsCiAgICAgICAgICAgIGxlZnQ6IGJveC5sZWZ0LAogICAgICAgICAgICB0b3A6IGJveC50b3AsCiAgICAgICAgICAgIHdpZHRoOiBib3gud2lkdGgKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHMKICAgIFtsYXN0Qm91bmRpbmdCb3gud2lkdGgsIGxhc3RCb3VuZGluZ0JveC5oZWlnaHQsIGxhc3RCb3VuZGluZ0JveC50b3AsIGxhc3RCb3VuZGluZ0JveC5sZWZ0LCAuLi5leHRyYURlcGVuZGVuY2llc10KICApOwogIHJldHVybiBbbGFzdEJvdW5kaW5nQm94LCB1cGRhdGVCb3VuZGluZ0JveF07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDEzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlZHV4L2Rpc3QvcmVkdXgubWpzCnZhciAkJG9ic2VydmFibGUgPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLm9ic2VydmFibGUgfHwgIkBAb2JzZXJ2YWJsZSIpKCk7CnZhciBzeW1ib2xfb2JzZXJ2YWJsZV9kZWZhdWx0ID0gJCRvYnNlcnZhYmxlOwp2YXIgcmFuZG9tU3RyaW5nID0gKCkgPT4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDcpLnNwbGl0KCIiKS5qb2luKCIuIik7CnZhciBBY3Rpb25UeXBlcyA9IHsKICBJTklUOiBgQEByZWR1eC9JTklUJHsvKiBAX19QVVJFX18gKi8gcmFuZG9tU3RyaW5nKCl9YCwKICBSRVBMQUNFOiBgQEByZWR1eC9SRVBMQUNFJHsvKiBAX19QVVJFX18gKi8gcmFuZG9tU3RyaW5nKCl9YCwKICBQUk9CRV9VTktOT1dOX0FDVElPTjogKCkgPT4gYEBAcmVkdXgvUFJPQkVfVU5LTk9XTl9BQ1RJT04ke3JhbmRvbVN0cmluZygpfWAKfTsKdmFyIGFjdGlvblR5cGVzX2RlZmF1bHQgPSBBY3Rpb25UeXBlczsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdChvYmopIHsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIgfHwgb2JqID09PSBudWxsKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBwcm90bzIgPSBvYmo7CiAgd2hpbGUgKE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90bzIpICE9PSBudWxsKSB7CiAgICBwcm90bzIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8yKTsKICB9CiAgcmV0dXJuIE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopID09PSBwcm90bzIgfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT09IG51bGw7Cn0KZnVuY3Rpb24gbWluaUtpbmRPZih2YWwpIHsKICBpZiAodmFsID09PSB2b2lkIDApCiAgICByZXR1cm4gInVuZGVmaW5lZCI7CiAgaWYgKHZhbCA9PT0gbnVsbCkKICAgIHJldHVybiAibnVsbCI7CiAgY29uc3QgdHlwZSA9IHR5cGVvZiB2YWw7CiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlICJib29sZWFuIjoKICAgIGNhc2UgInN0cmluZyI6CiAgICBjYXNlICJudW1iZXIiOgogICAgY2FzZSAic3ltYm9sIjoKICAgIGNhc2UgImZ1bmN0aW9uIjogewogICAgICByZXR1cm4gdHlwZTsKICAgIH0KICB9CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkKICAgIHJldHVybiAiYXJyYXkiOwogIGlmIChpc0RhdGUodmFsKSkKICAgIHJldHVybiAiZGF0ZSI7CiAgaWYgKGlzRXJyb3IodmFsKSkKICAgIHJldHVybiAiZXJyb3IiOwogIGNvbnN0IGNvbnN0cnVjdG9yTmFtZSA9IGN0b3JOYW1lKHZhbCk7CiAgc3dpdGNoIChjb25zdHJ1Y3Rvck5hbWUpIHsKICAgIGNhc2UgIlN5bWJvbCI6CiAgICBjYXNlICJQcm9taXNlIjoKICAgIGNhc2UgIldlYWtNYXAiOgogICAgY2FzZSAiV2Vha1NldCI6CiAgICBjYXNlICJNYXAiOgogICAgY2FzZSAiU2V0IjoKICAgICAgcmV0dXJuIGNvbnN0cnVjdG9yTmFtZTsKICB9CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWwpLnNsaWNlKDgsIC0xKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1xzL2csICIiKTsKfQpmdW5jdGlvbiBjdG9yTmFtZSh2YWwpIHsKICByZXR1cm4gdHlwZW9mIHZhbC5jb25zdHJ1Y3RvciA9PT0gImZ1bmN0aW9uIiA/IHZhbC5jb25zdHJ1Y3Rvci5uYW1lIDogbnVsbDsKfQpmdW5jdGlvbiBpc0Vycm9yKHZhbCkgewogIHJldHVybiB2YWwgaW5zdGFuY2VvZiBFcnJvciB8fCB0eXBlb2YgdmFsLm1lc3NhZ2UgPT09ICJzdHJpbmciICYmIHZhbC5jb25zdHJ1Y3RvciAmJiB0eXBlb2YgdmFsLmNvbnN0cnVjdG9yLnN0YWNrVHJhY2VMaW1pdCA9PT0gIm51bWJlciI7Cn0KZnVuY3Rpb24gaXNEYXRlKHZhbCkgewogIGlmICh2YWwgaW5zdGFuY2VvZiBEYXRlKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIHR5cGVvZiB2YWwudG9EYXRlU3RyaW5nID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB2YWwuZ2V0RGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgdmFsLnNldERhdGUgPT09ICJmdW5jdGlvbiI7Cn0KZnVuY3Rpb24ga2luZE9mKHZhbCkgewogIGxldCB0eXBlT2ZWYWwgPSB0eXBlb2YgdmFsOwogIGlmICh0cnVlKSB7CiAgICB0eXBlT2ZWYWwgPSBtaW5pS2luZE9mKHZhbCk7CiAgfQogIHJldHVybiB0eXBlT2ZWYWw7Cn0KZnVuY3Rpb24gY3JlYXRlU3RvcmUocmVkdWNlciwgcHJlbG9hZGVkU3RhdGUsIGVuaGFuY2VyKSB7CiAgaWYgKHR5cGVvZiByZWR1Y2VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIpIDogYEV4cGVjdGVkIHRoZSByb290IHJlZHVjZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihyZWR1Y2VyKX0nYCk7CiAgfQogIGlmICh0eXBlb2YgcHJlbG9hZGVkU3RhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGVuaGFuY2VyID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBlbmhhbmNlciA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDApIDogIkl0IGxvb2tzIGxpa2UgeW91IGFyZSBwYXNzaW5nIHNldmVyYWwgc3RvcmUgZW5oYW5jZXJzIHRvIGNyZWF0ZVN0b3JlKCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gSW5zdGVhZCwgY29tcG9zZSB0aGVtIHRvZ2V0aGVyIHRvIGEgc2luZ2xlIGZ1bmN0aW9uLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvdHV0b3JpYWxzL2Z1bmRhbWVudGFscy9wYXJ0LTQtc3RvcmUjY3JlYXRpbmctYS1zdG9yZS13aXRoLWVuaGFuY2VycyBmb3IgYW4gZXhhbXBsZS4iKTsKICB9CiAgaWYgKHR5cGVvZiBwcmVsb2FkZWRTdGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZW5oYW5jZXIgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBlbmhhbmNlciA9IHByZWxvYWRlZFN0YXRlOwogICAgcHJlbG9hZGVkU3RhdGUgPSB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgZW5oYW5jZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICBpZiAodHlwZW9mIGVuaGFuY2VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMSkgOiBgRXhwZWN0ZWQgdGhlIGVuaGFuY2VyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YoZW5oYW5jZXIpfSdgKTsKICAgIH0KICAgIHJldHVybiBlbmhhbmNlcihjcmVhdGVTdG9yZSkocmVkdWNlciwgcHJlbG9hZGVkU3RhdGUpOwogIH0KICBsZXQgY3VycmVudFJlZHVjZXIgPSByZWR1Y2VyOwogIGxldCBjdXJyZW50U3RhdGUgPSBwcmVsb2FkZWRTdGF0ZTsKICBsZXQgY3VycmVudExpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IG5leHRMaXN0ZW5lcnMgPSBjdXJyZW50TGlzdGVuZXJzOwogIGxldCBsaXN0ZW5lcklkQ291bnRlciA9IDA7CiAgbGV0IGlzRGlzcGF0Y2hpbmcgPSBmYWxzZTsKICBmdW5jdGlvbiBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCkgewogICAgaWYgKG5leHRMaXN0ZW5lcnMgPT09IGN1cnJlbnRMaXN0ZW5lcnMpIHsKICAgICAgbmV4dExpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGN1cnJlbnRMaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIyLCBrZXkpID0+IHsKICAgICAgICBuZXh0TGlzdGVuZXJzLnNldChrZXksIGxpc3RlbmVyMik7CiAgICAgIH0pOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRTdGF0ZSgpIHsKICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMykgOiAiWW91IG1heSBub3QgY2FsbCBzdG9yZS5nZXRTdGF0ZSgpIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gVGhlIHJlZHVjZXIgaGFzIGFscmVhZHkgcmVjZWl2ZWQgdGhlIHN0YXRlIGFzIGFuIGFyZ3VtZW50LiBQYXNzIGl0IGRvd24gZnJvbSB0aGUgdG9wIHJlZHVjZXIgaW5zdGVhZCBvZiByZWFkaW5nIGl0IGZyb20gdGhlIHN0b3JlLiIpOwogICAgfQogICAgcmV0dXJuIGN1cnJlbnRTdGF0ZTsKICB9CiAgZnVuY3Rpb24gc3Vic2NyaWJlKGxpc3RlbmVyMikgewogICAgaWYgKHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0KSA6IGBFeHBlY3RlZCB0aGUgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihsaXN0ZW5lcjIpfSdgKTsKICAgIH0KICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNSkgOiAiWW91IG1heSBub3QgY2FsbCBzdG9yZS5zdWJzY3JpYmUoKSB3aGlsZSB0aGUgcmVkdWNlciBpcyBleGVjdXRpbmcuIElmIHlvdSB3b3VsZCBsaWtlIHRvIGJlIG5vdGlmaWVkIGFmdGVyIHRoZSBzdG9yZSBoYXMgYmVlbiB1cGRhdGVkLCBzdWJzY3JpYmUgZnJvbSBhIGNvbXBvbmVudCBhbmQgaW52b2tlIHN0b3JlLmdldFN0YXRlKCkgaW4gdGhlIGNhbGxiYWNrIHRvIGFjY2VzcyB0aGUgbGF0ZXN0IHN0YXRlLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvYXBpL3N0b3JlI3N1YnNjcmliZWxpc3RlbmVyIGZvciBtb3JlIGRldGFpbHMuIik7CiAgICB9CiAgICBsZXQgaXNTdWJzY3JpYmVkID0gdHJ1ZTsKICAgIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKTsKICAgIGNvbnN0IGxpc3RlbmVySWQgPSBsaXN0ZW5lcklkQ291bnRlcisrOwogICAgbmV4dExpc3RlbmVycy5zZXQobGlzdGVuZXJJZCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHsKICAgICAgaWYgKCFpc1N1YnNjcmliZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDYpIDogIllvdSBtYXkgbm90IHVuc3Vic2NyaWJlIGZyb20gYSBzdG9yZSBsaXN0ZW5lciB3aGlsZSB0aGUgcmVkdWNlciBpcyBleGVjdXRpbmcuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9hcGkvc3RvcmUjc3Vic2NyaWJlbGlzdGVuZXIgZm9yIG1vcmUgZGV0YWlscy4iKTsKICAgICAgfQogICAgICBpc1N1YnNjcmliZWQgPSBmYWxzZTsKICAgICAgZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpOwogICAgICBuZXh0TGlzdGVuZXJzLmRlbGV0ZShsaXN0ZW5lcklkKTsKICAgICAgY3VycmVudExpc3RlbmVycyA9IG51bGw7CiAgICB9OwogIH0KICBmdW5jdGlvbiBkaXNwYXRjaChhY3Rpb24pIHsKICAgIGlmICghaXNQbGFpbk9iamVjdChhY3Rpb24pKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNykgOiBgQWN0aW9ucyBtdXN0IGJlIHBsYWluIG9iamVjdHMuIEluc3RlYWQsIHRoZSBhY3R1YWwgdHlwZSB3YXM6ICcke2tpbmRPZihhY3Rpb24pfScuIFlvdSBtYXkgbmVlZCB0byBhZGQgbWlkZGxld2FyZSB0byB5b3VyIHN0b3JlIHNldHVwIHRvIGhhbmRsZSBkaXNwYXRjaGluZyBvdGhlciB2YWx1ZXMsIHN1Y2ggYXMgJ3JlZHV4LXRodW5rJyB0byBoYW5kbGUgZGlzcGF0Y2hpbmcgZnVuY3Rpb25zLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvdHV0b3JpYWxzL2Z1bmRhbWVudGFscy9wYXJ0LTQtc3RvcmUjbWlkZGxld2FyZSBhbmQgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvdHV0b3JpYWxzL2Z1bmRhbWVudGFscy9wYXJ0LTYtYXN5bmMtbG9naWMjdXNpbmctdGhlLXJlZHV4LXRodW5rLW1pZGRsZXdhcmUgZm9yIGV4YW1wbGVzLmApOwogICAgfQogICAgaWYgKHR5cGVvZiBhY3Rpb24udHlwZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg4KSA6ICdBY3Rpb25zIG1heSBub3QgaGF2ZSBhbiB1bmRlZmluZWQgInR5cGUiIHByb3BlcnR5LiBZb3UgbWF5IGhhdmUgbWlzc3BlbGxlZCBhbiBhY3Rpb24gdHlwZSBzdHJpbmcgY29uc3RhbnQuJyk7CiAgICB9CiAgICBpZiAodHlwZW9mIGFjdGlvbi50eXBlICE9PSAic3RyaW5nIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE3KSA6IGBBY3Rpb24gInR5cGUiIHByb3BlcnR5IG11c3QgYmUgYSBzdHJpbmcuIEluc3RlYWQsIHRoZSBhY3R1YWwgdHlwZSB3YXM6ICcke2tpbmRPZihhY3Rpb24udHlwZSl9Jy4gVmFsdWUgd2FzOiAnJHthY3Rpb24udHlwZX0nIChzdHJpbmdpZmllZClgKTsKICAgIH0KICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOSkgOiAiUmVkdWNlcnMgbWF5IG5vdCBkaXNwYXRjaCBhY3Rpb25zLiIpOwogICAgfQogICAgdHJ5IHsKICAgICAgaXNEaXNwYXRjaGluZyA9IHRydWU7CiAgICAgIGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnRSZWR1Y2VyKGN1cnJlbnRTdGF0ZSwgYWN0aW9uKTsKICAgIH0gZmluYWxseSB7CiAgICAgIGlzRGlzcGF0Y2hpbmcgPSBmYWxzZTsKICAgIH0KICAgIGNvbnN0IGxpc3RlbmVycyA9IGN1cnJlbnRMaXN0ZW5lcnMgPSBuZXh0TGlzdGVuZXJzOwogICAgbGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyMikgPT4gewogICAgICBsaXN0ZW5lcjIoKTsKICAgIH0pOwogICAgcmV0dXJuIGFjdGlvbjsKICB9CiAgZnVuY3Rpb24gcmVwbGFjZVJlZHVjZXIobmV4dFJlZHVjZXIpIHsKICAgIGlmICh0eXBlb2YgbmV4dFJlZHVjZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMCkgOiBgRXhwZWN0ZWQgdGhlIG5leHRSZWR1Y2VyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YobmV4dFJlZHVjZXIpfWApOwogICAgfQogICAgY3VycmVudFJlZHVjZXIgPSBuZXh0UmVkdWNlcjsKICAgIGRpc3BhdGNoKHsKICAgICAgdHlwZTogYWN0aW9uVHlwZXNfZGVmYXVsdC5SRVBMQUNFCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gb2JzZXJ2YWJsZSgpIHsKICAgIGNvbnN0IG91dGVyU3Vic2NyaWJlID0gc3Vic2NyaWJlOwogICAgcmV0dXJuIHsKICAgICAgLyoqCiAgICAgICAqIFRoZSBtaW5pbWFsIG9ic2VydmFibGUgc3Vic2NyaXB0aW9uIG1ldGhvZC4KICAgICAgICogQHBhcmFtIG9ic2VydmVyIEFueSBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCBhcyBhbiBvYnNlcnZlci4KICAgICAgICogVGhlIG9ic2VydmVyIG9iamVjdCBzaG91bGQgaGF2ZSBhIGBuZXh0YCBtZXRob2QuCiAgICAgICAqIEByZXR1cm5zIEFuIG9iamVjdCB3aXRoIGFuIGB1bnN1YnNjcmliZWAgbWV0aG9kIHRoYXQgY2FuCiAgICAgICAqIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUgdGhlIG9ic2VydmFibGUgZnJvbSB0aGUgc3RvcmUsIGFuZCBwcmV2ZW50IGZ1cnRoZXIKICAgICAgICogZW1pc3Npb24gb2YgdmFsdWVzIGZyb20gdGhlIG9ic2VydmFibGUuCiAgICAgICAqLwogICAgICBzdWJzY3JpYmUob2JzZXJ2ZXIpIHsKICAgICAgICBpZiAodHlwZW9mIG9ic2VydmVyICE9PSAib2JqZWN0IiB8fCBvYnNlcnZlciA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMSkgOiBgRXhwZWN0ZWQgdGhlIG9ic2VydmVyIHRvIGJlIGFuIG9iamVjdC4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihvYnNlcnZlcil9J2ApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvYnNlcnZlU3RhdGUoKSB7CiAgICAgICAgICBjb25zdCBvYnNlcnZlckFzT2JzZXJ2ZXIgPSBvYnNlcnZlcjsKICAgICAgICAgIGlmIChvYnNlcnZlckFzT2JzZXJ2ZXIubmV4dCkgewogICAgICAgICAgICBvYnNlcnZlckFzT2JzZXJ2ZXIubmV4dChnZXRTdGF0ZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb2JzZXJ2ZVN0YXRlKCk7CiAgICAgICAgY29uc3QgdW5zdWJzY3JpYmUgPSBvdXRlclN1YnNjcmliZShvYnNlcnZlU3RhdGUpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB1bnN1YnNjcmliZQogICAgICAgIH07CiAgICAgIH0sCiAgICAgIFtzeW1ib2xfb2JzZXJ2YWJsZV9kZWZhdWx0XSgpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfTsKICB9CiAgZGlzcGF0Y2goewogICAgdHlwZTogYWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUCiAgfSk7CiAgY29uc3Qgc3RvcmUgPSB7CiAgICBkaXNwYXRjaCwKICAgIHN1YnNjcmliZSwKICAgIGdldFN0YXRlLAogICAgcmVwbGFjZVJlZHVjZXIsCiAgICBbc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdF06IG9ic2VydmFibGUKICB9OwogIHJldHVybiBzdG9yZTsKfQpmdW5jdGlvbiB3YXJuaW5nKG1lc3NhZ2UpIHsKICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBjb25zb2xlLmVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogIH0KICB0cnkgewogICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpOwogIH0gY2F0Y2ggKGUpIHsKICB9Cn0KZnVuY3Rpb24gZ2V0VW5leHBlY3RlZFN0YXRlU2hhcGVXYXJuaW5nTWVzc2FnZShpbnB1dFN0YXRlLCByZWR1Y2VycywgYWN0aW9uLCB1bmV4cGVjdGVkS2V5Q2FjaGUpIHsKICBjb25zdCByZWR1Y2VyS2V5cyA9IE9iamVjdC5rZXlzKHJlZHVjZXJzKTsKICBjb25zdCBhcmd1bWVudE5hbWUgPSBhY3Rpb24gJiYgYWN0aW9uLnR5cGUgPT09IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVCA/ICJwcmVsb2FkZWRTdGF0ZSBhcmd1bWVudCBwYXNzZWQgdG8gY3JlYXRlU3RvcmUiIDogInByZXZpb3VzIHN0YXRlIHJlY2VpdmVkIGJ5IHRoZSByZWR1Y2VyIjsKICBpZiAocmVkdWNlcktleXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gIlN0b3JlIGRvZXMgbm90IGhhdmUgYSB2YWxpZCByZWR1Y2VyLiBNYWtlIHN1cmUgdGhlIGFyZ3VtZW50IHBhc3NlZCB0byBjb21iaW5lUmVkdWNlcnMgaXMgYW4gb2JqZWN0IHdob3NlIHZhbHVlcyBhcmUgcmVkdWNlcnMuIjsKICB9CiAgaWYgKCFpc1BsYWluT2JqZWN0KGlucHV0U3RhdGUpKSB7CiAgICByZXR1cm4gYFRoZSAke2FyZ3VtZW50TmFtZX0gaGFzIHVuZXhwZWN0ZWQgdHlwZSBvZiAiJHtraW5kT2YoaW5wdXRTdGF0ZSl9Ii4gRXhwZWN0ZWQgYXJndW1lbnQgdG8gYmUgYW4gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBrZXlzOiAiJHtyZWR1Y2VyS2V5cy5qb2luKCciLCAiJyl9ImA7CiAgfQogIGNvbnN0IHVuZXhwZWN0ZWRLZXlzID0gT2JqZWN0LmtleXMoaW5wdXRTdGF0ZSkuZmlsdGVyKChrZXkpID0+ICFyZWR1Y2Vycy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF1bmV4cGVjdGVkS2V5Q2FjaGVba2V5XSk7CiAgdW5leHBlY3RlZEtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICB1bmV4cGVjdGVkS2V5Q2FjaGVba2V5XSA9IHRydWU7CiAgfSk7CiAgaWYgKGFjdGlvbiAmJiBhY3Rpb24udHlwZSA9PT0gYWN0aW9uVHlwZXNfZGVmYXVsdC5SRVBMQUNFKQogICAgcmV0dXJuOwogIGlmICh1bmV4cGVjdGVkS2V5cy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gYFVuZXhwZWN0ZWQgJHt1bmV4cGVjdGVkS2V5cy5sZW5ndGggPiAxID8gImtleXMiIDogImtleSJ9ICIke3VuZXhwZWN0ZWRLZXlzLmpvaW4oJyIsICInKX0iIGZvdW5kIGluICR7YXJndW1lbnROYW1lfS4gRXhwZWN0ZWQgdG8gZmluZCBvbmUgb2YgdGhlIGtub3duIHJlZHVjZXIga2V5cyBpbnN0ZWFkOiAiJHtyZWR1Y2VyS2V5cy5qb2luKCciLCAiJyl9Ii4gVW5leHBlY3RlZCBrZXlzIHdpbGwgYmUgaWdub3JlZC5gOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRSZWR1Y2VyU2hhcGUocmVkdWNlcnMpIHsKICBPYmplY3Qua2V5cyhyZWR1Y2VycykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICBjb25zdCByZWR1Y2VyID0gcmVkdWNlcnNba2V5XTsKICAgIGNvbnN0IGluaXRpYWxTdGF0ZTEzID0gcmVkdWNlcih2b2lkIDAsIHsKICAgICAgdHlwZTogYWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUCiAgICB9KTsKICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlMTMgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTIpIDogYFRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkIGR1cmluZyBpbml0aWFsaXphdGlvbi4gSWYgdGhlIHN0YXRlIHBhc3NlZCB0byB0aGUgcmVkdWNlciBpcyB1bmRlZmluZWQsIHlvdSBtdXN0IGV4cGxpY2l0bHkgcmV0dXJuIHRoZSBpbml0aWFsIHN0YXRlLiBUaGUgaW5pdGlhbCBzdGF0ZSBtYXkgbm90IGJlIHVuZGVmaW5lZC4gSWYgeW91IGRvbid0IHdhbnQgdG8gc2V0IGEgdmFsdWUgZm9yIHRoaXMgcmVkdWNlciwgeW91IGNhbiB1c2UgbnVsbCBpbnN0ZWFkIG9mIHVuZGVmaW5lZC5gKTsKICAgIH0KICAgIGlmICh0eXBlb2YgcmVkdWNlcih2b2lkIDAsIHsKICAgICAgdHlwZTogYWN0aW9uVHlwZXNfZGVmYXVsdC5QUk9CRV9VTktOT1dOX0FDVElPTigpCiAgICB9KSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMykgOiBgVGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQgd2hlbiBwcm9iZWQgd2l0aCBhIHJhbmRvbSB0eXBlLiBEb24ndCB0cnkgdG8gaGFuZGxlICcke2FjdGlvblR5cGVzX2RlZmF1bHQuSU5JVH0nIG9yIG90aGVyIGFjdGlvbnMgaW4gInJlZHV4LyoiIG5hbWVzcGFjZS4gVGhleSBhcmUgY29uc2lkZXJlZCBwcml2YXRlLiBJbnN0ZWFkLCB5b3UgbXVzdCByZXR1cm4gdGhlIGN1cnJlbnQgc3RhdGUgZm9yIGFueSB1bmtub3duIGFjdGlvbnMsIHVubGVzcyBpdCBpcyB1bmRlZmluZWQsIGluIHdoaWNoIGNhc2UgeW91IG11c3QgcmV0dXJuIHRoZSBpbml0aWFsIHN0YXRlLCByZWdhcmRsZXNzIG9mIHRoZSBhY3Rpb24gdHlwZS4gVGhlIGluaXRpYWwgc3RhdGUgbWF5IG5vdCBiZSB1bmRlZmluZWQsIGJ1dCBjYW4gYmUgbnVsbC5gKTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjb21iaW5lUmVkdWNlcnMocmVkdWNlcnMpIHsKICBjb25zdCByZWR1Y2VyS2V5cyA9IE9iamVjdC5rZXlzKHJlZHVjZXJzKTsKICBjb25zdCBmaW5hbFJlZHVjZXJzID0ge307CiAgZm9yIChsZXQgaSA9IDA7IGkgPCByZWR1Y2VyS2V5cy5sZW5ndGg7IGkrKykgewogICAgY29uc3Qga2V5ID0gcmVkdWNlcktleXNbaV07CiAgICBpZiAodHJ1ZSkgewogICAgICBpZiAodHlwZW9mIHJlZHVjZXJzW2tleV0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgd2FybmluZyhgTm8gcmVkdWNlciBwcm92aWRlZCBmb3Iga2V5ICIke2tleX0iYCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0eXBlb2YgcmVkdWNlcnNba2V5XSA9PT0gImZ1bmN0aW9uIikgewogICAgICBmaW5hbFJlZHVjZXJzW2tleV0gPSByZWR1Y2Vyc1trZXldOwogICAgfQogIH0KICBjb25zdCBmaW5hbFJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMoZmluYWxSZWR1Y2Vycyk7CiAgbGV0IHVuZXhwZWN0ZWRLZXlDYWNoZTsKICBpZiAodHJ1ZSkgewogICAgdW5leHBlY3RlZEtleUNhY2hlID0ge307CiAgfQogIGxldCBzaGFwZUFzc2VydGlvbkVycm9yOwogIHRyeSB7CiAgICBhc3NlcnRSZWR1Y2VyU2hhcGUoZmluYWxSZWR1Y2Vycyk7CiAgfSBjYXRjaCAoZSkgewogICAgc2hhcGVBc3NlcnRpb25FcnJvciA9IGU7CiAgfQogIHJldHVybiBmdW5jdGlvbiBjb21iaW5hdGlvbihzdGF0ZSA9IHt9LCBhY3Rpb24pIHsKICAgIGlmIChzaGFwZUFzc2VydGlvbkVycm9yKSB7CiAgICAgIHRocm93IHNoYXBlQXNzZXJ0aW9uRXJyb3I7CiAgICB9CiAgICBpZiAodHJ1ZSkgewogICAgICBjb25zdCB3YXJuaW5nTWVzc2FnZSA9IGdldFVuZXhwZWN0ZWRTdGF0ZVNoYXBlV2FybmluZ01lc3NhZ2Uoc3RhdGUsIGZpbmFsUmVkdWNlcnMsIGFjdGlvbiwgdW5leHBlY3RlZEtleUNhY2hlKTsKICAgICAgaWYgKHdhcm5pbmdNZXNzYWdlKSB7CiAgICAgICAgd2FybmluZyh3YXJuaW5nTWVzc2FnZSk7CiAgICAgIH0KICAgIH0KICAgIGxldCBoYXNDaGFuZ2VkID0gZmFsc2U7CiAgICBjb25zdCBuZXh0U3RhdGUgPSB7fTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmluYWxSZWR1Y2VyS2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrZXkgPSBmaW5hbFJlZHVjZXJLZXlzW2ldOwogICAgICBjb25zdCByZWR1Y2VyID0gZmluYWxSZWR1Y2Vyc1trZXldOwogICAgICBjb25zdCBwcmV2aW91c1N0YXRlRm9yS2V5ID0gc3RhdGVba2V5XTsKICAgICAgY29uc3QgbmV4dFN0YXRlRm9yS2V5ID0gcmVkdWNlcihwcmV2aW91c1N0YXRlRm9yS2V5LCBhY3Rpb24pOwogICAgICBpZiAodHlwZW9mIG5leHRTdGF0ZUZvcktleSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICBjb25zdCBhY3Rpb25UeXBlID0gYWN0aW9uICYmIGFjdGlvbi50eXBlOwogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTQpIDogYFdoZW4gY2FsbGVkIHdpdGggYW4gYWN0aW9uIG9mIHR5cGUgJHthY3Rpb25UeXBlID8gYCIke1N0cmluZyhhY3Rpb25UeXBlKX0iYCA6ICIodW5rbm93biB0eXBlKSJ9LCB0aGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZC4gVG8gaWdub3JlIGFuIGFjdGlvbiwgeW91IG11c3QgZXhwbGljaXRseSByZXR1cm4gdGhlIHByZXZpb3VzIHN0YXRlLiBJZiB5b3Ugd2FudCB0aGlzIHJlZHVjZXIgdG8gaG9sZCBubyB2YWx1ZSwgeW91IGNhbiByZXR1cm4gbnVsbCBpbnN0ZWFkIG9mIHVuZGVmaW5lZC5gKTsKICAgICAgfQogICAgICBuZXh0U3RhdGVba2V5XSA9IG5leHRTdGF0ZUZvcktleTsKICAgICAgaGFzQ2hhbmdlZCA9IGhhc0NoYW5nZWQgfHwgbmV4dFN0YXRlRm9yS2V5ICE9PSBwcmV2aW91c1N0YXRlRm9yS2V5OwogICAgfQogICAgaGFzQ2hhbmdlZCA9IGhhc0NoYW5nZWQgfHwgZmluYWxSZWR1Y2VyS2V5cy5sZW5ndGggIT09IE9iamVjdC5rZXlzKHN0YXRlKS5sZW5ndGg7CiAgICByZXR1cm4gaGFzQ2hhbmdlZCA/IG5leHRTdGF0ZSA6IHN0YXRlOwogIH07Cn0KZnVuY3Rpb24gY29tcG9zZSguLi5mdW5jcykgewogIGlmIChmdW5jcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiAoYXJnKSA9PiBhcmc7CiAgfQogIGlmIChmdW5jcy5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiBmdW5jc1swXTsKICB9CiAgcmV0dXJuIGZ1bmNzLnJlZHVjZSgoYSwgYikgPT4gKC4uLmFyZ3MpID0+IGEoYiguLi5hcmdzKSkpOwp9CmZ1bmN0aW9uIGFwcGx5TWlkZGxld2FyZSguLi5taWRkbGV3YXJlcykgewogIHJldHVybiAoY3JlYXRlU3RvcmUyKSA9PiAocmVkdWNlciwgcHJlbG9hZGVkU3RhdGUpID0+IHsKICAgIGNvbnN0IHN0b3JlID0gY3JlYXRlU3RvcmUyKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKTsKICAgIGxldCBkaXNwYXRjaCA9ICgpID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNSkgOiAiRGlzcGF0Y2hpbmcgd2hpbGUgY29uc3RydWN0aW5nIHlvdXIgbWlkZGxld2FyZSBpcyBub3QgYWxsb3dlZC4gT3RoZXIgbWlkZGxld2FyZSB3b3VsZCBub3QgYmUgYXBwbGllZCB0byB0aGlzIGRpc3BhdGNoLiIpOwogICAgfTsKICAgIGNvbnN0IG1pZGRsZXdhcmVBUEkgPSB7CiAgICAgIGdldFN0YXRlOiBzdG9yZS5nZXRTdGF0ZSwKICAgICAgZGlzcGF0Y2g6IChhY3Rpb24sIC4uLmFyZ3MpID0+IGRpc3BhdGNoKGFjdGlvbiwgLi4uYXJncykKICAgIH07CiAgICBjb25zdCBjaGFpbiA9IG1pZGRsZXdhcmVzLm1hcCgobWlkZGxld2FyZSkgPT4gbWlkZGxld2FyZShtaWRkbGV3YXJlQVBJKSk7CiAgICBkaXNwYXRjaCA9IGNvbXBvc2UoLi4uY2hhaW4pKHN0b3JlLmRpc3BhdGNoKTsKICAgIHJldHVybiB7CiAgICAgIC4uLnN0b3JlLAogICAgICBkaXNwYXRjaAogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGlzQWN0aW9uKGFjdGlvbikgewogIHJldHVybiBpc1BsYWluT2JqZWN0KGFjdGlvbikgJiYgInR5cGUiIGluIGFjdGlvbiAmJiB0eXBlb2YgYWN0aW9uLnR5cGUgPT09ICJzdHJpbmciOwp9CgovLyBub2RlX21vZHVsZXMvQHJlZHV4anMvdG9vbGtpdC9ub2RlX21vZHVsZXMvaW1tZXIvZGlzdC9pbW1lci5tanMKdmFyIE5PVEhJTkcgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUgPSBTeW1ib2wuZm9yKCJpbW1lci1kcmFmdGFibGUiKTsKdmFyIERSQUZUX1NUQVRFID0gU3ltYm9sLmZvcigiaW1tZXItc3RhdGUiKTsKdmFyIGVycm9ycyA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUoZXJyb3IsIC4uLmFyZ3MpIHsKICBpZiAodHJ1ZSkgewogICAgY29uc3QgZSA9IGVycm9yc1tlcnJvcl07CiAgICBjb25zdCBtc2cgPSBpc0Z1bmN0aW9uKGUpID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBPID0gT2JqZWN0Owp2YXIgZ2V0UHJvdG90eXBlT2YgPSBPLmdldFByb3RvdHlwZU9mOwp2YXIgQ09OU1RSVUNUT1IgPSAiY29uc3RydWN0b3IiOwp2YXIgUFJPVE9UWVBFID0gInByb3RvdHlwZSI7CnZhciBDT05GSUdVUkFCTEUgPSAiY29uZmlndXJhYmxlIjsKdmFyIEVOVU1FUkFCTEUgPSAiZW51bWVyYWJsZSI7CnZhciBXUklUQUJMRSA9ICJ3cml0YWJsZSI7CnZhciBWQUxVRSA9ICJ2YWx1ZSI7CnZhciBpc0RyYWZ0ID0gKHZhbHVlKSA9PiAhIXZhbHVlICYmICEhdmFsdWVbRFJBRlRfU1RBVEVdOwpmdW5jdGlvbiBpc0RyYWZ0YWJsZSh2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QyKHZhbHVlKSB8fCBpc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRV0gfHwgISF2YWx1ZVtDT05TVFJVQ1RPUl0/LltEUkFGVEFCTEVdIHx8IGlzTWFwKHZhbHVlKSB8fCBpc1NldCh2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcgPSBPW1BST1RPVFlQRV1bQ09OU1RSVUNUT1JdLnRvU3RyaW5nKCk7CnZhciBjYWNoZWRDdG9yU3RyaW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgewogIGlmICghdmFsdWUgfHwgIWlzT2JqZWN0aXNoKHZhbHVlKSkKICAgIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9bUFJPVE9UWVBFXSkKICAgIHJldHVybiB0cnVlOwogIGNvbnN0IEN0b3IgPSBPLmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCBDT05TVFJVQ1RPUikgJiYgcHJvdG8yW0NPTlNUUlVDVE9SXTsKICBpZiAoQ3RvciA9PT0gT2JqZWN0KQogICAgcmV0dXJuIHRydWU7CiAgaWYgKCFpc0Z1bmN0aW9uKEN0b3IpKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBjdG9yU3RyaW5nID0gY2FjaGVkQ3RvclN0cmluZ3MuZ2V0KEN0b3IpOwogIGlmIChjdG9yU3RyaW5nID09PSB2b2lkIDApIHsKICAgIGN0b3JTdHJpbmcgPSBGdW5jdGlvbi50b1N0cmluZy5jYWxsKEN0b3IpOwogICAgY2FjaGVkQ3RvclN0cmluZ3Muc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzsKfQpmdW5jdGlvbiBlYWNoKG9iaiwgaXRlciwgc3RyaWN0ID0gdHJ1ZSkgewogIGlmIChnZXRBcmNodHlwZShvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPLmtleXMob2JqKTsKICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIGl0ZXIoa2V5LCBvYmpba2V5XSwgb2JqKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBvYmouZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiBpdGVyKGluZGV4LCBlbnRyeSwgb2JqKSk7CiAgfQp9CmZ1bmN0aW9uIGdldEFyY2h0eXBlKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURV07CiAgcmV0dXJuIHN0YXRlID8gc3RhdGUudHlwZV8gOiBpc0FycmF5KHRoaW5nKSA/IDEgOiBpc01hcCh0aGluZykgPyAyIDogaXNTZXQodGhpbmcpID8gMyA6IDA7Cn0KdmFyIGhhcyA9ICh0aGluZywgcHJvcCwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gdHlwZSA9PT0gMiA/IHRoaW5nLmhhcyhwcm9wKSA6IE9bUFJPVE9UWVBFXS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKdmFyIGdldDIgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+ICgKICAvLyBAdHMtaWdub3JlCiAgdHlwZSA9PT0gMiA/IHRoaW5nLmdldChwcm9wKSA6IHRoaW5nW3Byb3BdCik7CnZhciBzZXQgPSAodGhpbmcsIHByb3BPck9sZFZhbHVlLCB2YWx1ZSwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gewogIGlmICh0eXBlID09PSAyKQogICAgdGhpbmcuc2V0KHByb3BPck9sZFZhbHVlLCB2YWx1ZSk7CiAgZWxzZSBpZiAodHlwZSA9PT0gMykgewogICAgdGhpbmcuYWRkKHZhbHVlKTsKICB9IGVsc2UKICAgIHRoaW5nW3Byb3BPck9sZFZhbHVlXSA9IHZhbHVlOwp9OwpmdW5jdGlvbiBpcyh4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CnZhciBpc01hcCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIE1hcDsKdmFyIGlzU2V0ID0gKHRhcmdldCkgPT4gdGFyZ2V0IGluc3RhbmNlb2YgU2V0Owp2YXIgaXNPYmplY3Rpc2ggPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAib2JqZWN0IjsKdmFyIGlzRnVuY3Rpb24gPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAiZnVuY3Rpb24iOwp2YXIgaXNCb29sZWFuID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iOwp2YXIgbGF0ZXN0ID0gKHN0YXRlKSA9PiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKdmFyIGdldEZpbmFsVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLm1vZGlmaWVkXyA/IHN0YXRlLmNvcHlfIDogc3RhdGUuYmFzZV87CmZ1bmN0aW9uIHNoYWxsb3dDb3B5KGJhc2UsIHN0cmljdCkgewogIGlmIChpc01hcChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBTZXQoYmFzZSk7CiAgfQogIGlmIChpc0FycmF5KGJhc2UpKQogICAgcmV0dXJuIEFycmF5W1BST1RPVFlQRV0uc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QyKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE8uZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiYXNlKTsKICAgIGRlbGV0ZSBkZXNjcmlwdG9yc1tEUkFGVF9TVEFURV07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjW1dSSVRBQkxFXSA9PT0gZmFsc2UpIHsKICAgICAgICBkZXNjW1dSSVRBQkxFXSA9IHRydWU7CiAgICAgICAgZGVzY1tDT05GSUdVUkFCTEVdID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIFtDT05GSUdVUkFCTEVdOiB0cnVlLAogICAgICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgICAgIC8vIGNvdWxkIGxpdmUgd2l0aCAhIWRlc2Muc2V0IGFzIHdlbGwgaGVyZS4uLgogICAgICAgICAgW0VOVU1FUkFCTEVdOiBkZXNjW0VOVU1FUkFCTEVdLAogICAgICAgICAgW1ZBTFVFXTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPLmNyZWF0ZShnZXRQcm90b3R5cGVPZihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZihiYXNlKTsKICAgIGlmIChwcm90bzIgIT09IG51bGwgJiYgaXNQbGFpbjIpIHsKICAgICAgcmV0dXJuIHsgLi4uYmFzZSB9OwogICAgfQogICAgY29uc3Qgb2JqID0gTy5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPLmFzc2lnbihvYmosIGJhc2UpOwogIH0KfQpmdW5jdGlvbiBmcmVlemUob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4ob2JqKSB8fCBpc0RyYWZ0KG9iaikgfHwgIWlzRHJhZnRhYmxlKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZShvYmopID4gMSkgewogICAgTy5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSwKICAgICAgYWRkOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGNsZWFyOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlCiAgICB9KTsKICB9CiAgTy5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIGVhY2goCiAgICAgIG9iaiwKICAgICAgKF9rZXksIHZhbHVlKSA9PiB7CiAgICAgICAgZnJlZXplKHZhbHVlLCB0cnVlKTsKICAgICAgfSwKICAgICAgZmFsc2UKICAgICk7CiAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMoKSB7CiAgZGllKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUgPSB7CiAgW1ZBTFVFXTogZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zCn07CmZ1bmN0aW9uIGlzRnJvemVuKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgIWlzT2JqZWN0aXNoKG9iaikpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gTy5pc0Zyb3plbihvYmopOwp9CnZhciBQbHVnaW5NYXBTZXQgPSAiTWFwU2V0IjsKdmFyIFBsdWdpblBhdGNoZXMgPSAiUGF0Y2hlcyI7CnZhciBwbHVnaW5zID0ge307CmZ1bmN0aW9uIGdldFBsdWdpbihwbHVnaW5LZXkpIHsKICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZSgwLCBwbHVnaW5LZXkpOwogIH0KICByZXR1cm4gcGx1Z2luOwp9CnZhciBpc1BsdWdpbkxvYWRlZCA9IChwbHVnaW5LZXkpID0+ICEhcGx1Z2luc1twbHVnaW5LZXldOwp2YXIgY3VycmVudFNjb3BlOwp2YXIgZ2V0Q3VycmVudFNjb3BlID0gKCkgPT4gY3VycmVudFNjb3BlOwp2YXIgY3JlYXRlU2NvcGUgPSAocGFyZW50XywgaW1tZXJfKSA9PiAoewogIGRyYWZ0c186IFtdLAogIHBhcmVudF8sCiAgaW1tZXJfLAogIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAvLyBuZWVkIHRvIHByZXZlbnQgYXV0by1mcmVlemluZyBzbyB0aGUgdW5vd25lZCBkcmFmdCBjYW4gYmUgZmluYWxpemVkLgogIGNhbkF1dG9GcmVlemVfOiB0cnVlLAogIHVuZmluYWxpemVkRHJhZnRzXzogMCwKICBoYW5kbGVkU2V0XzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBwcm9jZXNzZWRGb3JQYXRjaGVzXzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBtYXBTZXRQbHVnaW5fOiBpc1BsdWdpbkxvYWRlZChQbHVnaW5NYXBTZXQpID8gZ2V0UGx1Z2luKFBsdWdpbk1hcFNldCkgOiB2b2lkIDAKfSk7CmZ1bmN0aW9uIHVzZVBhdGNoZXNJblNjb3BlKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIHNjb3BlLnBhdGNoUGx1Z2luXyA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUoc2NvcGUpIHsKICBsZWF2ZVNjb3BlKHNjb3BlKTsKICBzY29wZS5kcmFmdHNfLmZvckVhY2gocmV2b2tlRHJhZnQpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUoc2NvcGUpIHsKICBpZiAoc2NvcGUgPT09IGN1cnJlbnRTY29wZSkgewogICAgY3VycmVudFNjb3BlID0gc2NvcGUucGFyZW50XzsKICB9Cn0KdmFyIGVudGVyU2NvcGUgPSAoaW1tZXIyMikgPT4gY3VycmVudFNjb3BlID0gY3JlYXRlU2NvcGUoY3VycmVudFNjb3BlLCBpbW1lcjIyKTsKZnVuY3Rpb24gcmV2b2tlRHJhZnQoZHJhZnQpIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSkgewogIHNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA9IHNjb3BlLmRyYWZ0c18ubGVuZ3RoOwogIGNvbnN0IGJhc2VEcmFmdCA9IHNjb3BlLmRyYWZ0c19bMF07CiAgY29uc3QgaXNSZXBsYWNlZCA9IHJlc3VsdCAhPT0gdm9pZCAwICYmIHJlc3VsdCAhPT0gYmFzZURyYWZ0OwogIGlmIChpc1JlcGxhY2VkKSB7CiAgICBpZiAoYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5tb2RpZmllZF8pIHsKICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICBkaWUoNCk7CiAgICB9CiAgICBpZiAoaXNEcmFmdGFibGUocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSBzY29wZTsKICAgIGlmIChwYXRjaFBsdWdpbl8pIHsKICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXygKICAgICAgICBiYXNlRHJhZnRbRFJBRlRfU1RBVEVdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZQogICAgICApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgYmFzZURyYWZ0KTsKICB9CiAgbWF5YmVGcmVlemUoc2NvcGUsIHJlc3VsdCwgdHJ1ZSk7CiAgcmV2b2tlU2NvcGUoc2NvcGUpOwogIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8oc2NvcGUucGF0Y2hlc18sIHNjb3BlLmludmVyc2VQYXRjaGVzXyk7CiAgfQogIHJldHVybiByZXN1bHQgIT09IE5PVEhJTkcgPyByZXN1bHQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZmluYWxpemUocm9vdFNjb3BlLCB2YWx1ZSkgewogIGlmIChpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgaWYgKCFzdGF0ZSkgewogICAgY29uc3QgZmluYWxWYWx1ZSA9IGhhbmRsZVZhbHVlKHZhbHVlLCByb290U2NvcGUuaGFuZGxlZFNldF8sIHJvb3RTY29wZSk7CiAgICByZXR1cm4gZmluYWxWYWx1ZTsKICB9CiAgaWYgKCFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIGNvbnN0IHsgY2FsbGJhY2tzXyB9ID0gc3RhdGU7CiAgICBpZiAoY2FsbGJhY2tzXykgewogICAgICB3aGlsZSAoY2FsbGJhY2tzXy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSBjYWxsYmFja3NfLnBvcCgpOwogICAgICAgIGNhbGxiYWNrKHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIGdlbmVyYXRlUGF0Y2hlc0FuZEZpbmFsaXplKHN0YXRlLCByb290U2NvcGUpOwogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gbWF5YmVGcmVlemUoc2NvcGUsIHZhbHVlLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoIXNjb3BlLnBhcmVudF8gJiYgc2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHNjb3BlLmNhbkF1dG9GcmVlemVfKSB7CiAgICBmcmVlemUodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpIHsKICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICBzdGF0ZS5zY29wZV8udW5maW5hbGl6ZWREcmFmdHNfLS07Cn0KdmFyIGlzU2FtZVNjb3BlID0gKHN0YXRlLCByb290U2NvcGUpID0+IHN0YXRlLnNjb3BlXyA9PT0gcm9vdFNjb3BlOwp2YXIgRU1QVFlfTE9DQVRJT05TX1JFU1VMVCA9IFtdOwpmdW5jdGlvbiB1cGRhdGVEcmFmdEluUGFyZW50KHBhcmVudCwgZHJhZnRWYWx1ZSwgZmluYWxpemVkVmFsdWUsIG9yaWdpbmFsS2V5KSB7CiAgY29uc3QgcGFyZW50Q29weSA9IGxhdGVzdChwYXJlbnQpOwogIGNvbnN0IHBhcmVudFR5cGUgPSBwYXJlbnQudHlwZV87CiAgaWYgKG9yaWdpbmFsS2V5ICE9PSB2b2lkIDApIHsKICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGdldDIocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIHBhcmVudFR5cGUpOwogICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gZHJhZnRWYWx1ZSkgewogICAgICBzZXQocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgcmV0dXJuOwogICAgfQogIH0KICBpZiAoIXBhcmVudC5kcmFmdExvY2F0aW9uc18pIHsKICAgIGNvbnN0IGRyYWZ0TG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBlYWNoKHBhcmVudENvcHksIChrZXksIHZhbHVlKSA9PiB7CiAgICAgIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgICAgIGNvbnN0IGtleXMgPSBkcmFmdExvY2F0aW9ucy5nZXQodmFsdWUpIHx8IFtdOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgIGRyYWZ0TG9jYXRpb25zLnNldCh2YWx1ZSwga2V5cyk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb25zdCBsb2NhdGlvbnMgPSBwYXJlbnQuZHJhZnRMb2NhdGlvbnNfLmdldChkcmFmdFZhbHVlKSA/PyBFTVBUWV9MT0NBVElPTlNfUkVTVUxUOwogIGZvciAoY29uc3QgbG9jYXRpb24gb2YgbG9jYXRpb25zKSB7CiAgICBzZXQocGFyZW50Q29weSwgbG9jYXRpb24sIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICB9Cn0KZnVuY3Rpb24gcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgY2hpbGQsIGtleSkgewogIHBhcmVudC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY2hpbGRDbGVhbnVwKHJvb3RTY29wZSkgewogICAgY29uc3Qgc3RhdGUgPSBjaGlsZDsKICAgIGlmICghc3RhdGUgfHwgIWlzU2FtZVNjb3BlKHN0YXRlLCByb290U2NvcGUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJvb3RTY29wZS5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICBjb25zdCBmaW5hbGl6ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIHN0YXRlLmRyYWZ0XyA/PyBzdGF0ZSwgZmluYWxpemVkVmFsdWUsIGtleSk7CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9KTsKfQpmdW5jdGlvbiBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKSB7CiAgY29uc3Qgc2hvdWxkRmluYWxpemUgPSBzdGF0ZS5tb2RpZmllZF8gJiYgIXN0YXRlLmZpbmFsaXplZF8gJiYgKHN0YXRlLnR5cGVfID09PSAzIHx8IChzdGF0ZS5hc3NpZ25lZF8/LnNpemUgPz8gMCkgPiAwKTsKICBpZiAoc2hvdWxkRmluYWxpemUpIHsKICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIGNvbnN0IGJhc2VQYXRoID0gcGF0Y2hQbHVnaW5fLmdldFBhdGgoc3RhdGUpOwogICAgICBpZiAoYmFzZVBhdGgpIHsKICAgICAgICBwYXRjaFBsdWdpbl8uZ2VuZXJhdGVQYXRjaGVzXyhzdGF0ZSwgYmFzZVBhdGgsIHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgfQp9CmZ1bmN0aW9uIGhhbmRsZUNyb3NzUmVmZXJlbmNlKHRhcmdldCwga2V5LCB2YWx1ZSkgewogIGNvbnN0IHsgc2NvcGVfIH0gPSB0YXJnZXQ7CiAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgc2NvcGVfKSkgewogICAgICBzdGF0ZS5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY3Jvc3NSZWZlcmVuY2VDbGVhbnVwKCkgewogICAgICAgIHByZXBhcmVDb3B5KHRhcmdldCk7CiAgICAgICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICB1cGRhdGVEcmFmdEluUGFyZW50KHRhcmdldCwgdmFsdWUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgdGFyZ2V0LmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiBuZXN0ZWREcmFmdENsZWFudXAoKSB7CiAgICAgIGNvbnN0IHRhcmdldENvcHkgPSBsYXRlc3QodGFyZ2V0KTsKICAgICAgaWYgKGdldDIodGFyZ2V0Q29weSwga2V5LCB0YXJnZXQudHlwZV8pID09PSB2YWx1ZSkgewogICAgICAgIGlmIChzY29wZV8uZHJhZnRzXy5sZW5ndGggPiAxICYmICh0YXJnZXQuYXNzaWduZWRfLmdldChrZXkpID8/IGZhbHNlKSA9PT0gdHJ1ZSAmJiB0YXJnZXQuY29weV8pIHsKICAgICAgICAgIGhhbmRsZVZhbHVlKAogICAgICAgICAgICBnZXQyKHRhcmdldC5jb3B5Xywga2V5LCB0YXJnZXQudHlwZV8pLAogICAgICAgICAgICBzY29wZV8uaGFuZGxlZFNldF8sCiAgICAgICAgICAgIHNjb3BlXwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVWYWx1ZSh0YXJnZXQsIGhhbmRsZWRTZXQsIHJvb3RTY29wZSkgewogIGlmICghcm9vdFNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiByb290U2NvcGUudW5maW5hbGl6ZWREcmFmdHNfIDwgMSkgewogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgaWYgKGlzRHJhZnQodGFyZ2V0KSB8fCBoYW5kbGVkU2V0Lmhhcyh0YXJnZXQpIHx8ICFpc0RyYWZ0YWJsZSh0YXJnZXQpIHx8IGlzRnJvemVuKHRhcmdldCkpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGhhbmRsZWRTZXQuYWRkKHRhcmdldCk7CiAgZWFjaCh0YXJnZXQsIChrZXksIHZhbHVlKSA9PiB7CiAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgICAgIHNldCh0YXJnZXQsIGtleSwgdXBkYXRlZFZhbHVlLCB0YXJnZXQudHlwZV8pOwogICAgICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNEcmFmdGFibGUodmFsdWUpKSB7CiAgICAgIGhhbmRsZVZhbHVlKHZhbHVlLCBoYW5kbGVkU2V0LCByb290U2NvcGUpOwogICAgfQogIH0pOwogIHJldHVybiB0YXJnZXQ7Cn0KZnVuY3Rpb24gY3JlYXRlUHJveHlQcm94eShiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBiYXNlSXNBcnJheSA9IGlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogYmFzZUlzQXJyYXkgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZSgpLAogICAgLy8gVHJ1ZSBmb3IgYm90aCBzaGFsbG93IGFuZCBkZWVwIGNoYW5nZXMuCiAgICBtb2RpZmllZF86IGZhbHNlLAogICAgLy8gVXNlZCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgZmluYWxpemVkXzogZmFsc2UsCiAgICAvLyBUcmFjayB3aGljaCBwcm9wZXJ0aWVzIGhhdmUgYmVlbiBhc3NpZ25lZCAodHJ1ZSkgb3IgZGVsZXRlZCAoZmFsc2UpLgogICAgLy8gYWN0dWFsbHkgaW5zdGFudGlhdGVkIGluIGBwcmVwYXJlQ29weSgpYAogICAgYXNzaWduZWRfOiB2b2lkIDAsCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlLAogICAgLy8gYGNhbGxiYWNrc2AgYWN0dWFsbHkgZ2V0cyBhc3NpZ25lZCBpbiBgY3JlYXRlUHJveHlgCiAgICBjYWxsYmFja3NfOiB2b2lkIDAKICB9OwogIGxldCB0YXJnZXQgPSBzdGF0ZTsKICBsZXQgdHJhcHMgPSBvYmplY3RUcmFwczsKICBpZiAoYmFzZUlzQXJyYXkpIHsKICAgIHRhcmdldCA9IFtzdGF0ZV07CiAgICB0cmFwcyA9IGFycmF5VHJhcHM7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIFtwcm94eSwgc3RhdGVdOwp9CnZhciBvYmplY3RUcmFwcyA9IHsKICBnZXQoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwcm9wID09PSBEUkFGVF9TVEFURSkKICAgICAgcmV0dXJuIHN0YXRlOwogICAgY29uc3Qgc291cmNlID0gbGF0ZXN0KHN0YXRlKTsKICAgIGlmICghaGFzKHNvdXJjZSwgcHJvcCwgc3RhdGUudHlwZV8pKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90byhzdGF0ZSwgc291cmNlLCBwcm9wKTsKICAgIH0KICAgIGNvbnN0IHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgaWYgKHN0YXRlLmZpbmFsaXplZF8gfHwgIWlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodmFsdWUgPT09IHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgICAgY29uc3QgY2hpbGRLZXkgPSBzdGF0ZS50eXBlXyA9PT0gMSA/ICtwcm9wIDogcHJvcDsKICAgICAgY29uc3QgY2hpbGREcmFmdCA9IGNyZWF0ZVByb3h5KHN0YXRlLnNjb3BlXywgdmFsdWUsIHN0YXRlLCBjaGlsZEtleSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1tjaGlsZEtleV0gPSBjaGlsZERyYWZ0OwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3Qoc3RhdGUpOwogIH0sCiAgb3duS2V5cyhzdGF0ZSkgewogICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyhsYXRlc3Qoc3RhdGUpKTsKICB9LAogIHNldChzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICAgIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgaWYgKGRlc2M/LnNldCkgewogICAgICBkZXNjLnNldC5jYWxsKHN0YXRlLmRyYWZ0XywgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICAgIGNvbnN0IGN1cnJlbnQyMiA9IHBlZWsobGF0ZXN0KHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFXTsKICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuYmFzZV8gPT09IHZhbHVlKSB7CiAgICAgICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXModmFsdWUsIGN1cnJlbnQyMikgJiYgKHZhbHVlICE9PSB2b2lkIDAgfHwgaGFzKHN0YXRlLmJhc2VfLCBwcm9wLCBzdGF0ZS50eXBlXykpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5X1twcm9wXSA9PT0gdmFsdWUgJiYgLy8gc3BlY2lhbCBjYXNlOiBoYW5kbGUgbmV3IHByb3BzIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcKICAgICh2YWx1ZSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuY29weV8pIHx8IC8vIHNwZWNpYWwgY2FzZTogTmFOCiAgICBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihzdGF0ZS5jb3B5X1twcm9wXSkpCiAgICAgIHJldHVybiB0cnVlOwogICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgIHN0YXRlLmFzc2lnbmVkXy5zZXQocHJvcCwgdHJ1ZSk7CiAgICBoYW5kbGVDcm9zc1JlZmVyZW5jZShzdGF0ZSwgcHJvcCwgdmFsdWUpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgaWYgKHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5iYXNlXykgewogICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLmRlbGV0ZShwcm9wKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5XykgewogICAgICBkZWxldGUgc3RhdGUuY29weV9bcHJvcF07CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8vIE5vdGU6IFdlIG5ldmVyIGNvZXJjZSBgZGVzYy52YWx1ZWAgaW50byBhbiBJbW1lciBkcmFmdCwgYmVjYXVzZSB3ZSBjYW4ndCBtYWtlCiAgLy8gdGhlIHNhbWUgZ3VhcmFudGVlIGluIEVTNSBtb2RlLgogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihzdGF0ZSwgcHJvcCkgewogICAgY29uc3Qgb3duZXIgPSBsYXRlc3Qoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICBbV1JJVEFCTEVdOiB0cnVlLAogICAgICBbQ09ORklHVVJBQkxFXTogc3RhdGUudHlwZV8gIT09IDEgfHwgcHJvcCAhPT0gImxlbmd0aCIsCiAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgW1ZBTFVFXTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZSgxMSk7CiAgfSwKICBnZXRQcm90b3R5cGVPZihzdGF0ZSkgewogICAgcmV0dXJuIGdldFByb3RvdHlwZU9mKHN0YXRlLmJhc2VfKTsKICB9LAogIHNldFByb3RvdHlwZU9mKCkgewogICAgZGllKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzID0ge307CmVhY2gob2JqZWN0VHJhcHMsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwc1trZXldID0gZnVuY3Rpb24oKSB7CiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzOwogICAgYXJnc1swXSA9IGFyZ3NbMF1bMF07CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncyk7CiAgfTsKfSk7CmFycmF5VHJhcHMuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCkgewogIGlmIChpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTMpOwogIHJldHVybiBhcnJheVRyYXBzLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzLnNldCA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogIGlmIChwcm9wICE9PSAibGVuZ3RoIiAmJiBpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTQpOwogIHJldHVybiBvYmplY3RUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlayhkcmFmdCwgcHJvcCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEVdOwogIGNvbnN0IHNvdXJjZSA9IHN0YXRlID8gbGF0ZXN0KHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCkgewogIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCk7CiAgcmV0dXJuIGRlc2MgPyBWQUxVRSBpbiBkZXNjID8gZGVzY1tWQUxVRV0gOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8oc291cmNlLCBwcm9wKSB7CiAgaWYgKCEocHJvcCBpbiBzb3VyY2UpKQogICAgcmV0dXJuIHZvaWQgMDsKICBsZXQgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2Yoc291cmNlKTsKICB3aGlsZSAocHJvdG8yKSB7CiAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bzIsIHByb3ApOwogICAgaWYgKGRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZChzdGF0ZSkgewogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBzdGF0ZS5tb2RpZmllZF8gPSB0cnVlOwogICAgaWYgKHN0YXRlLnBhcmVudF8pIHsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUucGFyZW50Xyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHByZXBhcmVDb3B5KHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuYXNzaWduZWRfID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHN0YXRlLmNvcHlfID0gc2hhbGxvd0NvcHkoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb25maWcpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB0cnVlOwogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSBmYWxzZTsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IGZhbHNlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAoaXNGdW5jdGlvbihiYXNlKSAmJiAhaXNGdW5jdGlvbihyZWNpcGUpKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdEJhc2UgPSByZWNpcGU7CiAgICAgICAgcmVjaXBlID0gYmFzZTsKICAgICAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGN1cnJpZWRQcm9kdWNlKGJhc2UyID0gZGVmYXVsdEJhc2UsIC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBzZWxmMi5wcm9kdWNlKGJhc2UyLCAoZHJhZnQpID0+IHJlY2lwZS5jYWxsKHRoaXMsIGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIWlzRnVuY3Rpb24ocmVjaXBlKSkKICAgICAgICBkaWUoNik7CiAgICAgIGlmIChwYXRjaExpc3RlbmVyICE9PSB2b2lkIDAgJiYgIWlzRnVuY3Rpb24ocGF0Y2hMaXN0ZW5lcikpCiAgICAgICAgZGllKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUoYmFzZSkpIHsKICAgICAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICAgICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eShzY29wZSwgYmFzZSwgdm9pZCAwKTsKICAgICAgICBsZXQgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSByZWNpcGUocHJveHkpOwogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKQogICAgICAgICAgICByZXZva2VTY29wZShzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgICAgIH0KICAgICAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgIWlzT2JqZWN0aXNoKGJhc2UpKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORykKICAgICAgICAgIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICBpZiAodGhpcy5hdXRvRnJlZXplXykKICAgICAgICAgIGZyZWV6ZShyZXN1bHQsIHRydWUpOwogICAgICAgIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBjb25zdCBpcCA9IFtdOwogICAgICAgICAgZ2V0UGx1Z2luKFBsdWdpblBhdGNoZXMpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXyhiYXNlLCByZXN1bHQsIHsKICAgICAgICAgICAgcGF0Y2hlc186IHAsCiAgICAgICAgICAgIGludmVyc2VQYXRjaGVzXzogaXAKICAgICAgICAgIH0pOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZSgxLCBiYXNlKTsKICAgIH07CiAgICB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyA9IChiYXNlLCByZWNpcGUpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLCAuLi5hcmdzKSA9PiB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyhzdGF0ZSwgKGRyYWZ0KSA9PiBiYXNlKGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgIH0KICAgICAgbGV0IHBhdGNoZXMsIGludmVyc2VQYXRjaGVzOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnByb2R1Y2UoYmFzZSwgcmVjaXBlLCAocCwgaXApID0+IHsKICAgICAgICBwYXRjaGVzID0gcDsKICAgICAgICBpbnZlcnNlUGF0Y2hlcyA9IGlwOwogICAgICB9KTsKICAgICAgcmV0dXJuIFtyZXN1bHQsIHBhdGNoZXMsIGludmVyc2VQYXRjaGVzXTsKICAgIH07CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8uYXV0b0ZyZWV6ZSkpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkpKQogICAgICB0aGlzLnNldFVzZVN0cmljdFNoYWxsb3dDb3B5KGNvbmZpZy51c2VTdHJpY3RTaGFsbG93Q29weSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0SXRlcmF0aW9uKSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RJdGVyYXRpb24oY29uZmlnLnVzZVN0cmljdEl0ZXJhdGlvbik7CiAgfQogIGNyZWF0ZURyYWZ0KGJhc2UpIHsKICAgIGlmICghaXNEcmFmdGFibGUoYmFzZSkpCiAgICAgIGRpZSg4KTsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKQogICAgICBiYXNlID0gY3VycmVudChiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZSh0aGlzKTsKICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICBwcm94eVtEUkFGVF9TVEFURV0uaXNNYW51YWxfID0gdHJ1ZTsKICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURV07CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5pc01hbnVhbF8pCiAgICAgIGRpZSg5KTsKICAgIGNvbnN0IHsgc2NvcGVfOiBzY29wZSB9ID0gc3RhdGU7CiAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdCh2b2lkIDAsIHNjb3BlKTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGF1dG9tYXRpY2FsbHkgZnJlZXplIGFsbCBjb3BpZXMgY3JlYXRlZCBieSBJbW1lci4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGF1dG8tZnJlZXppbmcgaXMgZW5hYmxlZC4KICAgKi8KICBzZXRBdXRvRnJlZXplKHZhbHVlKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBlbmFibGUgc3RyaWN0IHNoYWxsb3cgY29weS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGltbWVyIGRvZXMgbm90IGNvcHkgdGhlIG9iamVjdCBkZXNjcmlwdG9ycyBzdWNoIGFzIGdldHRlciwgc2V0dGVyIGFuZCBub24tZW51bXJhYmxlIHByb3BlcnRpZXMuCiAgICovCiAgc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkodmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgZmFsc2UgdG8gdXNlIGZhc3RlciBpdGVyYXRpb24gdGhhdCBza2lwcyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICogYnV0IHN0aWxsIGhhbmRsZXMgc3ltYm9scyBmb3IgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHN0cmljdCBpdGVyYXRpb24gaXMgZW5hYmxlZCAoaW5jbHVkZXMgYWxsIG93biBwcm9wZXJ0aWVzKS4KICAgKi8KICBzZXRVc2VTdHJpY3RJdGVyYXRpb24odmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHZhbHVlOwogIH0KICBzaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fOwogIH0KICBhcHBseVBhdGNoZXMoYmFzZSwgcGF0Y2hlcykgewogICAgbGV0IGk7CiAgICBmb3IgKGkgPSBwYXRjaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHBhdGNoID0gcGF0Y2hlc1tpXTsKICAgICAgaWYgKHBhdGNoLnBhdGgubGVuZ3RoID09PSAwICYmIHBhdGNoLm9wID09PSAicmVwbGFjZSIpIHsKICAgICAgICBiYXNlID0gcGF0Y2gudmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChpID4gLTEpIHsKICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuc2xpY2UoaSArIDEpOwogICAgfQogICAgY29uc3QgYXBwbHlQYXRjaGVzSW1wbCA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5hcHBseVBhdGNoZXNfOwogICAgaWYgKGlzRHJhZnQoYmFzZSkpIHsKICAgICAgcmV0dXJuIGFwcGx5UGF0Y2hlc0ltcGwoYmFzZSwgcGF0Y2hlcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9kdWNlKAogICAgICBiYXNlLAogICAgICAoZHJhZnQpID0+IGFwcGx5UGF0Y2hlc0ltcGwoZHJhZnQsIHBhdGNoZXMpCiAgICApOwogIH0KfTsKZnVuY3Rpb24gY3JlYXRlUHJveHkocm9vdFNjb3BlLCB2YWx1ZSwgcGFyZW50LCBrZXkpIHsKICBjb25zdCBbZHJhZnQsIHN0YXRlXSA9IGlzTWFwKHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0KHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5U2V0Xyh2YWx1ZSwgcGFyZW50KSA6IGNyZWF0ZVByb3h5UHJveHkodmFsdWUsIHBhcmVudCk7CiAgY29uc3Qgc2NvcGUgPSBwYXJlbnQ/LnNjb3BlXyA/PyBnZXRDdXJyZW50U2NvcGUoKTsKICBzY29wZS5kcmFmdHNfLnB1c2goZHJhZnQpOwogIHN0YXRlLmNhbGxiYWNrc18gPSBwYXJlbnQ/LmNhbGxiYWNrc18gPz8gW107CiAgc3RhdGUua2V5XyA9IGtleTsKICBpZiAocGFyZW50ICYmIGtleSAhPT0gdm9pZCAwKSB7CiAgICByZWdpc3RlckNoaWxkRmluYWxpemF0aW9uQ2FsbGJhY2socGFyZW50LCBzdGF0ZSwga2V5KTsKICB9IGVsc2UgewogICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIHJvb3REcmFmdENsZWFudXAocm9vdFNjb3BlMikgewogICAgICByb290U2NvcGUyLm1hcFNldFBsdWdpbl8/LmZpeFNldENvbnRlbnRzKHN0YXRlKTsKICAgICAgY29uc3QgeyBwYXRjaFBsdWdpbl8gfSA9IHJvb3RTY29wZTI7CiAgICAgIGlmIChzdGF0ZS5tb2RpZmllZF8gJiYgcGF0Y2hQbHVnaW5fKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIFtdLCByb290U2NvcGUyKTsKICAgICAgfQogICAgfSk7CiAgfQogIHJldHVybiBkcmFmdDsKfQpmdW5jdGlvbiBjdXJyZW50KHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0KHZhbHVlKSkKICAgIGRpZSgxMCwgdmFsdWUpOwogIHJldHVybiBjdXJyZW50SW1wbCh2YWx1ZSk7Cn0KZnVuY3Rpb24gY3VycmVudEltcGwodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlKHZhbHVlKSB8fCBpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8pOwogICAgc3RyaWN0ID0gc3RhdGUuc2NvcGVfLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICB9IGVsc2UgewogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgdHJ1ZSk7CiAgfQogIGVhY2goCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0KGNvcHkzLCBrZXksIGN1cnJlbnRJbXBsKGNoaWxkVmFsdWUpKTsKICAgIH0sCiAgICBzdHJpY3QKICApOwogIGlmIChzdGF0ZSkgewogICAgc3RhdGUuZmluYWxpemVkXyA9IGZhbHNlOwogIH0KICByZXR1cm4gY29weTM7Cn0KdmFyIGltbWVyID0gbmV3IEltbWVyMigpOwp2YXIgcHJvZHVjZSA9IGltbWVyLnByb2R1Y2U7CgovLyBub2RlX21vZHVsZXMvcmVkdXgtdGh1bmsvZGlzdC9yZWR1eC10aHVuay5tanMKZnVuY3Rpb24gY3JlYXRlVGh1bmtNaWRkbGV3YXJlKGV4dHJhQXJndW1lbnQpIHsKICBjb25zdCBtaWRkbGV3YXJlID0gKHsgZGlzcGF0Y2gsIGdldFN0YXRlIH0pID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICBpZiAodHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZXR1cm4gYWN0aW9uKGRpc3BhdGNoLCBnZXRTdGF0ZSwgZXh0cmFBcmd1bWVudCk7CiAgICB9CiAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogIH07CiAgcmV0dXJuIG1pZGRsZXdhcmU7Cn0KdmFyIHRodW5rID0gY3JlYXRlVGh1bmtNaWRkbGV3YXJlKCk7CnZhciB3aXRoRXh0cmFBcmd1bWVudCA9IGNyZWF0ZVRodW5rTWlkZGxld2FyZTsKCi8vIG5vZGVfbW9kdWxlcy9AcmVkdXhqcy90b29sa2l0L2Rpc3QvcmVkdXgtdG9vbGtpdC5tb2Rlcm4ubWpzCnZhciBjb21wb3NlV2l0aERldlRvb2xzID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX0NPTVBPU0VfXyA/IHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9DT01QT1NFX18gOiBmdW5jdGlvbigpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHZvaWQgMDsKICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gIm9iamVjdCIpIHJldHVybiBjb21wb3NlOwogIHJldHVybiBjb21wb3NlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn07CnZhciBkZXZUb29sc0VuaGFuY2VyID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18gPyB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fXyA6IGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbihub29wMzIpIHsKICAgIHJldHVybiBub29wMzI7CiAgfTsKfTsKdmFyIGhhc01hdGNoRnVuY3Rpb24gPSAodikgPT4gewogIHJldHVybiB2ICYmIHR5cGVvZiB2Lm1hdGNoID09PSAiZnVuY3Rpb24iOwp9OwpmdW5jdGlvbiBjcmVhdGVBY3Rpb24odHlwZSwgcHJlcGFyZUFjdGlvbikgewogIGZ1bmN0aW9uIGFjdGlvbkNyZWF0b3IoLi4uYXJncykgewogICAgaWYgKHByZXBhcmVBY3Rpb24pIHsKICAgICAgbGV0IHByZXBhcmVkID0gcHJlcGFyZUFjdGlvbiguLi5hcmdzKTsKICAgICAgaWYgKCFwcmVwYXJlZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMCkgOiAicHJlcGFyZUFjdGlvbiBkaWQgbm90IHJldHVybiBhbiBvYmplY3QiKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHR5cGUsCiAgICAgICAgcGF5bG9hZDogcHJlcGFyZWQucGF5bG9hZCwKICAgICAgICAuLi4ibWV0YSIgaW4gcHJlcGFyZWQgJiYgewogICAgICAgICAgbWV0YTogcHJlcGFyZWQubWV0YQogICAgICAgIH0sCiAgICAgICAgLi4uImVycm9yIiBpbiBwcmVwYXJlZCAmJiB7CiAgICAgICAgICBlcnJvcjogcHJlcGFyZWQuZXJyb3IKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gewogICAgICB0eXBlLAogICAgICBwYXlsb2FkOiBhcmdzWzBdCiAgICB9OwogIH0KICBhY3Rpb25DcmVhdG9yLnRvU3RyaW5nID0gKCkgPT4gYCR7dHlwZX1gOwogIGFjdGlvbkNyZWF0b3IudHlwZSA9IHR5cGU7CiAgYWN0aW9uQ3JlYXRvci5tYXRjaCA9IChhY3Rpb24pID0+IGlzQWN0aW9uKGFjdGlvbikgJiYgYWN0aW9uLnR5cGUgPT09IHR5cGU7CiAgcmV0dXJuIGFjdGlvbkNyZWF0b3I7Cn0KZnVuY3Rpb24gaXNBY3Rpb25DcmVhdG9yKGFjdGlvbikgewogIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgLy8gaGFzTWF0Y2hGdW5jdGlvbiBvbmx5IHdhbnRzIE1hdGNoZXJzIGJ1dCBJIGRvbid0IHNlZSB0aGUgcG9pbnQgaW4gcmV3cml0aW5nIGl0CiAgaGFzTWF0Y2hGdW5jdGlvbihhY3Rpb24pOwp9CmZ1bmN0aW9uIGdldE1lc3NhZ2UodHlwZSkgewogIGNvbnN0IHNwbGl0VHlwZSA9IHR5cGUgPyBgJHt0eXBlfWAuc3BsaXQoIi8iKSA6IFtdOwogIGNvbnN0IGFjdGlvbk5hbWUgPSBzcGxpdFR5cGVbc3BsaXRUeXBlLmxlbmd0aCAtIDFdIHx8ICJhY3Rpb25DcmVhdG9yIjsKICByZXR1cm4gYERldGVjdGVkIGFuIGFjdGlvbiBjcmVhdG9yIHdpdGggdHlwZSAiJHt0eXBlIHx8ICJ1bmtub3duIn0iIGJlaW5nIGRpc3BhdGNoZWQuIApNYWtlIHN1cmUgeW91J3JlIGNhbGxpbmcgdGhlIGFjdGlvbiBjcmVhdG9yIGJlZm9yZSBkaXNwYXRjaGluZywgaS5lLiBcYGRpc3BhdGNoKCR7YWN0aW9uTmFtZX0oKSlcYCBpbnN0ZWFkIG9mIFxgZGlzcGF0Y2goJHthY3Rpb25OYW1lfSlcYC4gVGhpcyBpcyBuZWNlc3NhcnkgZXZlbiBpZiB0aGUgYWN0aW9uIGhhcyBubyBwYXlsb2FkLmA7Cn0KZnVuY3Rpb24gY3JlYXRlQWN0aW9uQ3JlYXRvckludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9CiAgY29uc3QgewogICAgaXNBY3Rpb25DcmVhdG9yOiBpc0FjdGlvbkNyZWF0b3IyID0gaXNBY3Rpb25DcmVhdG9yCiAgfSA9IG9wdGlvbnM7CiAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICBpZiAoaXNBY3Rpb25DcmVhdG9yMihhY3Rpb24pKSB7CiAgICAgIGNvbnNvbGUud2FybihnZXRNZXNzYWdlKGFjdGlvbi50eXBlKSk7CiAgICB9CiAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogIH07Cn0KZnVuY3Rpb24gZ2V0VGltZU1lYXN1cmVVdGlscyhtYXhEZWxheSwgZm5OYW1lKSB7CiAgbGV0IGVsYXBzZWQgPSAwOwogIHJldHVybiB7CiAgICBtZWFzdXJlVGltZShmbikgewogICAgICBjb25zdCBzdGFydGVkID0gRGF0ZS5ub3coKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBjb25zdCBmaW5pc2hlZCA9IERhdGUubm93KCk7CiAgICAgICAgZWxhcHNlZCArPSBmaW5pc2hlZCAtIHN0YXJ0ZWQ7CiAgICAgIH0KICAgIH0sCiAgICB3YXJuSWZFeGNlZWRlZCgpIHsKICAgICAgaWYgKGVsYXBzZWQgPiBtYXhEZWxheSkgewogICAgICAgIGNvbnNvbGUud2FybihgJHtmbk5hbWV9IHRvb2sgJHtlbGFwc2VkfW1zLCB3aGljaCBpcyBtb3JlIHRoYW4gdGhlIHdhcm5pbmcgdGhyZXNob2xkIG9mICR7bWF4RGVsYXl9bXMuIApJZiB5b3VyIHN0YXRlIG9yIGFjdGlvbnMgYXJlIHZlcnkgbGFyZ2UsIHlvdSBtYXkgd2FudCB0byBkaXNhYmxlIHRoZSBtaWRkbGV3YXJlIGFzIGl0IG1pZ2h0IGNhdXNlIHRvbyBtdWNoIG9mIGEgc2xvd2Rvd24gaW4gZGV2ZWxvcG1lbnQgbW9kZS4gU2VlIGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2dldERlZmF1bHRNaWRkbGV3YXJlIGZvciBpbnN0cnVjdGlvbnMuCkl0IGlzIGRpc2FibGVkIGluIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB5b3UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB0aGF0LmApOwogICAgICB9CiAgICB9CiAgfTsKfQp2YXIgVHVwbGUgPSBjbGFzcyBfVHVwbGUgZXh0ZW5kcyBBcnJheSB7CiAgY29uc3RydWN0b3IoLi4uaXRlbXMpIHsKICAgIHN1cGVyKC4uLml0ZW1zKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBfVHVwbGUucHJvdG90eXBlKTsKICB9CiAgc3RhdGljIGdldCBbU3ltYm9sLnNwZWNpZXNdKCkgewogICAgcmV0dXJuIF9UdXBsZTsKICB9CiAgY29uY2F0KC4uLmFycikgewogICAgcmV0dXJuIHN1cGVyLmNvbmNhdC5hcHBseSh0aGlzLCBhcnIpOwogIH0KICBwcmVwZW5kKC4uLmFycikgewogICAgaWYgKGFyci5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShhcnJbMF0pKSB7CiAgICAgIHJldHVybiBuZXcgX1R1cGxlKC4uLmFyclswXS5jb25jYXQodGhpcykpOwogICAgfQogICAgcmV0dXJuIG5ldyBfVHVwbGUoLi4uYXJyLmNvbmNhdCh0aGlzKSk7CiAgfQp9OwpmdW5jdGlvbiBmcmVlemVEcmFmdGFibGUodmFsKSB7CiAgcmV0dXJuIGlzRHJhZnRhYmxlKHZhbCkgPyBwcm9kdWNlKHZhbCwgKCkgPT4gewogIH0pIDogdmFsOwp9CmZ1bmN0aW9uIGdldE9ySW5zZXJ0Q29tcHV0ZWQobWFwMywga2V5LCBjb21wdXRlKSB7CiAgaWYgKG1hcDMuaGFzKGtleSkpIHJldHVybiBtYXAzLmdldChrZXkpOwogIHJldHVybiBtYXAzLnNldChrZXksIGNvbXB1dGUoa2V5KSkuZ2V0KGtleSk7Cn0KZnVuY3Rpb24gaXNJbW11dGFibGVEZWZhdWx0KHZhbHVlKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgdmFsdWUgPT0gbnVsbCB8fCBPYmplY3QuaXNGcm96ZW4odmFsdWUpOwp9CmZ1bmN0aW9uIHRyYWNrRm9yTXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9iaikgewogIGNvbnN0IHRyYWNrZWRQcm9wZXJ0aWVzID0gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9iaik7CiAgcmV0dXJuIHsKICAgIGRldGVjdE11dGF0aW9ucygpIHsKICAgICAgcmV0dXJuIGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCB0cmFja2VkUHJvcGVydGllcywgb2JqKTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzID0gW10sIG9iaiwgcGF0aDIgPSAiIiwgY2hlY2tlZE9iamVjdHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKSB7CiAgY29uc3QgdHJhY2tlZCA9IHsKICAgIHZhbHVlOiBvYmoKICB9OwogIGlmICghaXNJbW11dGFibGUob2JqKSAmJiAhY2hlY2tlZE9iamVjdHMuaGFzKG9iaikpIHsKICAgIGNoZWNrZWRPYmplY3RzLmFkZChvYmopOwogICAgdHJhY2tlZC5jaGlsZHJlbiA9IHt9OwogICAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHsKICAgICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgICB9KTsKICAgICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRyYWNrZWQuY2hpbGRyZW5ba2V5XSA9IHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmpba2V5XSwgbmVzdGVkUGF0aCk7CiAgICB9CiAgfQogIHJldHVybiB0cmFja2VkOwp9CmZ1bmN0aW9uIGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzID0gW10sIHRyYWNrZWRQcm9wZXJ0eSwgb2JqLCBzYW1lUGFyZW50UmVmID0gZmFsc2UsIHBhdGgyID0gIiIpIHsKICBjb25zdCBwcmV2T2JqID0gdHJhY2tlZFByb3BlcnR5ID8gdHJhY2tlZFByb3BlcnR5LnZhbHVlIDogdm9pZCAwOwogIGNvbnN0IHNhbWVSZWYgPSBwcmV2T2JqID09PSBvYmo7CiAgaWYgKHNhbWVQYXJlbnRSZWYgJiYgIXNhbWVSZWYgJiYgIU51bWJlci5pc05hTihvYmopKSB7CiAgICByZXR1cm4gewogICAgICB3YXNNdXRhdGVkOiB0cnVlLAogICAgICBwYXRoOiBwYXRoMgogICAgfTsKICB9CiAgaWYgKGlzSW1tdXRhYmxlKHByZXZPYmopIHx8IGlzSW1tdXRhYmxlKG9iaikpIHsKICAgIHJldHVybiB7CiAgICAgIHdhc011dGF0ZWQ6IGZhbHNlCiAgICB9OwogIH0KICBjb25zdCBrZXlzVG9EZXRlY3QgPSB7fTsKICBmb3IgKGxldCBrZXkgaW4gdHJhY2tlZFByb3BlcnR5LmNoaWxkcmVuKSB7CiAgICBrZXlzVG9EZXRlY3Rba2V5XSA9IHRydWU7CiAgfQogIGZvciAobGV0IGtleSBpbiBvYmopIHsKICAgIGtleXNUb0RldGVjdFtrZXldID0gdHJ1ZTsKICB9CiAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgZm9yIChsZXQga2V5IGluIGtleXNUb0RldGVjdCkgewogICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgfSk7CiAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCB0cmFja2VkUHJvcGVydHkuY2hpbGRyZW5ba2V5XSwgb2JqW2tleV0sIHNhbWVSZWYsIG5lc3RlZFBhdGgpOwogICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICB3YXNNdXRhdGVkOiBmYWxzZQogIH07Cn0KZnVuY3Rpb24gY3JlYXRlSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIGxldCBzdHJpbmdpZnkyID0gZnVuY3Rpb24ob2JqLCBzZXJpYWxpemVyLCBpbmRlbnQsIGRlY3ljbGVyKSB7CiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIGdldFNlcmlhbGl6ZTIoc2VyaWFsaXplciwgZGVjeWNsZXIpLCBpbmRlbnQpOwogICAgfSwgZ2V0U2VyaWFsaXplMiA9IGZ1bmN0aW9uKHNlcmlhbGl6ZXIsIGRlY3ljbGVyKSB7CiAgICAgIGxldCBzdGFjayA9IFtdLCBrZXlzID0gW107CiAgICAgIGlmICghZGVjeWNsZXIpIGRlY3ljbGVyID0gZnVuY3Rpb24oXywgdmFsdWUpIHsKICAgICAgICBpZiAoc3RhY2tbMF0gPT09IHZhbHVlKSByZXR1cm4gIltDaXJjdWxhciB+XSI7CiAgICAgICAgcmV0dXJuICJbQ2lyY3VsYXIgfi4iICsga2V5cy5zbGljZSgwLCBzdGFjay5pbmRleE9mKHZhbHVlKSkuam9pbigiLiIpICsgIl0iOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdGhpc1BvcyA9IHN0YWNrLmluZGV4T2YodGhpcyk7CiAgICAgICAgICB+dGhpc1BvcyA/IHN0YWNrLnNwbGljZSh0aGlzUG9zICsgMSkgOiBzdGFjay5wdXNoKHRoaXMpOwogICAgICAgICAgfnRoaXNQb3MgPyBrZXlzLnNwbGljZSh0aGlzUG9zLCBJbmZpbml0eSwga2V5KSA6IGtleXMucHVzaChrZXkpOwogICAgICAgICAgaWYgKH5zdGFjay5pbmRleE9mKHZhbHVlKSkgdmFsdWUgPSBkZWN5Y2xlci5jYWxsKHRoaXMsIGtleSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICByZXR1cm4gc2VyaWFsaXplciA9PSBudWxsID8gdmFsdWUgOiBzZXJpYWxpemVyLmNhbGwodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgIH07CiAgICB9OwogICAgdmFyIHN0cmluZ2lmeSA9IHN0cmluZ2lmeTIsIGdldFNlcmlhbGl6ZSA9IGdldFNlcmlhbGl6ZTI7CiAgICBsZXQgewogICAgICBpc0ltbXV0YWJsZSA9IGlzSW1tdXRhYmxlRGVmYXVsdCwKICAgICAgaWdub3JlZFBhdGhzLAogICAgICB3YXJuQWZ0ZXIgPSAzMgogICAgfSA9IG9wdGlvbnM7CiAgICBjb25zdCB0cmFjayA9IHRyYWNrRm9yTXV0YXRpb25zLmJpbmQobnVsbCwgaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyk7CiAgICByZXR1cm4gKHsKICAgICAgZ2V0U3RhdGUKICAgIH0pID0+IHsKICAgICAgbGV0IHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgbGV0IHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIHJldHVybiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgICAgIGNvbnN0IG1lYXN1cmVVdGlscyA9IGdldFRpbWVNZWFzdXJlVXRpbHMod2FybkFmdGVyLCAiSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlIik7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgICAgIHJlc3VsdCA9IHRyYWNrZXIuZGV0ZWN0TXV0YXRpb25zKCk7CiAgICAgICAgICB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICAgICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTkpIDogYEEgc3RhdGUgbXV0YXRpb24gd2FzIGRldGVjdGVkIGJldHdlZW4gZGlzcGF0Y2hlcywgaW4gdGhlIHBhdGggJyR7cmVzdWx0LnBhdGggfHwgIiJ9Jy4gIFRoaXMgbWF5IGNhdXNlIGluY29ycmVjdCBiZWhhdmlvci4gKGh0dHBzOi8vcmVkdXguanMub3JnL3N0eWxlLWd1aWRlL3N0eWxlLWd1aWRlI2RvLW5vdC1tdXRhdGUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgZGlzcGF0Y2hlZEFjdGlvbiA9IG5leHQoYWN0aW9uKTsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICAgICAgcmVzdWx0ID0gdHJhY2tlci5kZXRlY3RNdXRhdGlvbnMoKTsKICAgICAgICAgIHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMCkgOiBgQSBzdGF0ZSBtdXRhdGlvbiB3YXMgZGV0ZWN0ZWQgaW5zaWRlIGEgZGlzcGF0Y2gsIGluIHRoZSBwYXRoOiAke3Jlc3VsdC5wYXRoIHx8ICIifS4gVGFrZSBhIGxvb2sgYXQgdGhlIHJlZHVjZXIocykgaGFuZGxpbmcgdGhlIGFjdGlvbiAke3N0cmluZ2lmeTIoYWN0aW9uKX0uIChodHRwczovL3JlZHV4LmpzLm9yZy9zdHlsZS1ndWlkZS9zdHlsZS1ndWlkZSNkby1ub3QtbXV0YXRlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG1lYXN1cmVVdGlscy53YXJuSWZFeGNlZWRlZCgpOwogICAgICAgIHJldHVybiBkaXNwYXRjaGVkQWN0aW9uOwogICAgICB9OwogICAgfTsKICB9Cn0KZnVuY3Rpb24gaXNQbGFpbih2YWwpIHsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDsKICByZXR1cm4gdmFsID09IG51bGwgfHwgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gImJvb2xlYW4iIHx8IHR5cGUgPT09ICJudW1iZXIiIHx8IEFycmF5LmlzQXJyYXkodmFsKSB8fCBpc1BsYWluT2JqZWN0KHZhbCk7Cn0KZnVuY3Rpb24gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKHZhbHVlLCBwYXRoMiA9ICIiLCBpc1NlcmlhbGl6YWJsZSA9IGlzUGxhaW4sIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocyA9IFtdLCBjYWNoZSkgewogIGxldCBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZTsKICBpZiAoIWlzU2VyaWFsaXphYmxlKHZhbHVlKSkgewogICAgcmV0dXJuIHsKICAgICAga2V5UGF0aDogcGF0aDIgfHwgIjxyb290PiIsCiAgICAgIHZhbHVlCiAgICB9OwogIH0KICBpZiAodHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoY2FjaGU/Lmhhcyh2YWx1ZSkpIHJldHVybiBmYWxzZTsKICBjb25zdCBlbnRyaWVzID0gZ2V0RW50cmllcyAhPSBudWxsID8gZ2V0RW50cmllcyh2YWx1ZSkgOiBPYmplY3QuZW50cmllcyh2YWx1ZSk7CiAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgZm9yIChjb25zdCBba2V5LCBuZXN0ZWRWYWx1ZV0gb2YgZW50cmllcykgewogICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgfSk7CiAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgIH0KICAgIGlmICghaXNTZXJpYWxpemFibGUobmVzdGVkVmFsdWUpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAga2V5UGF0aDogbmVzdGVkUGF0aCwKICAgICAgICB2YWx1ZTogbmVzdGVkVmFsdWUKICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgbmVzdGVkVmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgIGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKG5lc3RlZFZhbHVlLCBuZXN0ZWRQYXRoLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzLCBjYWNoZSk7CiAgICAgIGlmIChmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZSkgewogICAgICAgIHJldHVybiBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZTsKICAgICAgfQogICAgfQogIH0KICBpZiAoY2FjaGUgJiYgaXNOZXN0ZWRGcm96ZW4odmFsdWUpKSBjYWNoZS5hZGQodmFsdWUpOwogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBpc05lc3RlZEZyb3plbih2YWx1ZSkgewogIGlmICghT2JqZWN0LmlzRnJvemVuKHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIGZvciAoY29uc3QgbmVzdGVkVmFsdWUgb2YgT2JqZWN0LnZhbHVlcyh2YWx1ZSkpIHsKICAgIGlmICh0eXBlb2YgbmVzdGVkVmFsdWUgIT09ICJvYmplY3QiIHx8IG5lc3RlZFZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIGlmICghaXNOZXN0ZWRGcm96ZW4obmVzdGVkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICBjb25zdCB7CiAgICAgIGlzU2VyaWFsaXphYmxlID0gaXNQbGFpbiwKICAgICAgZ2V0RW50cmllcywKICAgICAgaWdub3JlZEFjdGlvbnMgPSBbXSwKICAgICAgaWdub3JlZEFjdGlvblBhdGhzID0gWyJtZXRhLmFyZyIsICJtZXRhLmJhc2VRdWVyeU1ldGEiXSwKICAgICAgaWdub3JlZFBhdGhzID0gW10sCiAgICAgIHdhcm5BZnRlciA9IDMyLAogICAgICBpZ25vcmVTdGF0ZSA9IGZhbHNlLAogICAgICBpZ25vcmVBY3Rpb25zID0gZmFsc2UsCiAgICAgIGRpc2FibGVDYWNoZSA9IGZhbHNlCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IGNhY2hlID0gIWRpc2FibGVDYWNoZSAmJiBXZWFrU2V0ID8gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkgOiB2b2lkIDA7CiAgICByZXR1cm4gKHN0b3JlQVBJKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgICBpZiAoIWlzQWN0aW9uKGFjdGlvbikpIHsKICAgICAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdCA9IG5leHQoYWN0aW9uKTsKICAgICAgY29uc3QgbWVhc3VyZVV0aWxzID0gZ2V0VGltZU1lYXN1cmVVdGlscyh3YXJuQWZ0ZXIsICJTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUiKTsKICAgICAgaWYgKCFpZ25vcmVBY3Rpb25zICYmICEoaWdub3JlZEFjdGlvbnMubGVuZ3RoICYmIGlnbm9yZWRBY3Rpb25zLmluZGV4T2YoYWN0aW9uLnR5cGUpICE9PSAtMSkpIHsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgY29uc3QgZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShhY3Rpb24sICIiLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZEFjdGlvblBhdGhzLCBjYWNoZSk7CiAgICAgICAgICBpZiAoZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZSkgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAga2V5UGF0aCwKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9ID0gZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQSBub24tc2VyaWFsaXphYmxlIHZhbHVlIHdhcyBkZXRlY3RlZCBpbiBhbiBhY3Rpb24sIGluIHRoZSBwYXRoOiBcYCR7a2V5UGF0aH1cYC4gVmFsdWU6YCwgdmFsdWUsICJcblRha2UgYSBsb29rIGF0IHRoZSBsb2dpYyB0aGF0IGRpc3BhdGNoZWQgdGhpcyBhY3Rpb246ICIsIGFjdGlvbiwgIlxuKFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9mYXEvYWN0aW9ucyN3aHktc2hvdWxkLXR5cGUtYmUtYS1zdHJpbmctb3ItYXQtbGVhc3Qtc2VyaWFsaXphYmxlLXdoeS1zaG91bGQtbXktYWN0aW9uLXR5cGVzLWJlLWNvbnN0YW50cykiLCAiXG4oVG8gYWxsb3cgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZXMgc2VlOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL3VzYWdlL3VzYWdlLWd1aWRlI3dvcmtpbmctd2l0aC1ub24tc2VyaWFsaXphYmxlLWRhdGEpIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFpZ25vcmVTdGF0ZSkgewogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBjb25zdCBzdGF0ZSA9IHN0b3JlQVBJLmdldFN0YXRlKCk7CiAgICAgICAgICBjb25zdCBmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUoc3RhdGUsICIiLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzLCBjYWNoZSk7CiAgICAgICAgICBpZiAoZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBrZXlQYXRoLAogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0gPSBmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWU7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEEgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZSB3YXMgZGV0ZWN0ZWQgaW4gdGhlIHN0YXRlLCBpbiB0aGUgcGF0aDogXGAke2tleVBhdGh9XGAuIFZhbHVlOmAsIHZhbHVlLCBgClRha2UgYSBsb29rIGF0IHRoZSByZWR1Y2VyKHMpIGhhbmRsaW5nIHRoaXMgYWN0aW9uIHR5cGU6ICR7YWN0aW9uLnR5cGV9LgooU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2ZhcS9vcmdhbml6aW5nLXN0YXRlI2Nhbi1pLXB1dC1mdW5jdGlvbnMtcHJvbWlzZXMtb3Itb3RoZXItbm9uLXNlcmlhbGl6YWJsZS1pdGVtcy1pbi1teS1zdG9yZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBtZWFzdXJlVXRpbHMud2FybklmRXhjZWVkZWQoKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9Cn0KZnVuY3Rpb24gaXNCb29sZWFuMih4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJib29sZWFuIjsKfQp2YXIgYnVpbGRHZXREZWZhdWx0TWlkZGxld2FyZSA9ICgpID0+IGZ1bmN0aW9uIGdldERlZmF1bHRNaWRkbGV3YXJlKG9wdGlvbnMpIHsKICBjb25zdCB7CiAgICB0aHVuazogdGh1bmsyID0gdHJ1ZSwKICAgIGltbXV0YWJsZUNoZWNrID0gdHJ1ZSwKICAgIHNlcmlhbGl6YWJsZUNoZWNrID0gdHJ1ZSwKICAgIGFjdGlvbkNyZWF0b3JDaGVjayA9IHRydWUKICB9ID0gb3B0aW9ucyA/PyB7fTsKICBsZXQgbWlkZGxld2FyZUFycmF5ID0gbmV3IFR1cGxlKCk7CiAgaWYgKHRodW5rMikgewogICAgaWYgKGlzQm9vbGVhbjIodGh1bmsyKSkgewogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaCh0aHVuayk7CiAgICB9IGVsc2UgewogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaCh3aXRoRXh0cmFBcmd1bWVudCh0aHVuazIuZXh0cmFBcmd1bWVudCkpOwogICAgfQogIH0KICBpZiAodHJ1ZSkgewogICAgaWYgKGltbXV0YWJsZUNoZWNrKSB7CiAgICAgIGxldCBpbW11dGFibGVPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihpbW11dGFibGVDaGVjaykpIHsKICAgICAgICBpbW11dGFibGVPcHRpb25zID0gaW1tdXRhYmxlQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnVuc2hpZnQoY3JlYXRlSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKGltbXV0YWJsZU9wdGlvbnMpKTsKICAgIH0KICAgIGlmIChzZXJpYWxpemFibGVDaGVjaykgewogICAgICBsZXQgc2VyaWFsaXphYmxlT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoc2VyaWFsaXphYmxlQ2hlY2spKSB7CiAgICAgICAgc2VyaWFsaXphYmxlT3B0aW9ucyA9IHNlcmlhbGl6YWJsZUNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKGNyZWF0ZVNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShzZXJpYWxpemFibGVPcHRpb25zKSk7CiAgICB9CiAgICBpZiAoYWN0aW9uQ3JlYXRvckNoZWNrKSB7CiAgICAgIGxldCBhY3Rpb25DcmVhdG9yT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoYWN0aW9uQ3JlYXRvckNoZWNrKSkgewogICAgICAgIGFjdGlvbkNyZWF0b3JPcHRpb25zID0gYWN0aW9uQ3JlYXRvckNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS51bnNoaWZ0KGNyZWF0ZUFjdGlvbkNyZWF0b3JJbnZhcmlhbnRNaWRkbGV3YXJlKGFjdGlvbkNyZWF0b3JPcHRpb25zKSk7CiAgICB9CiAgfQogIHJldHVybiBtaWRkbGV3YXJlQXJyYXk7Cn07CnZhciBTSE9VTERfQVVUT0JBVENIID0gIlJUS19hdXRvQmF0Y2giOwp2YXIgcHJlcGFyZUF1dG9CYXRjaGVkID0gKCkgPT4gKHBheWxvYWQpID0+ICh7CiAgcGF5bG9hZCwKICBtZXRhOiB7CiAgICBbU0hPVUxEX0FVVE9CQVRDSF06IHRydWUKICB9Cn0pOwp2YXIgY3JlYXRlUXVldWVXaXRoVGltZXIgPSAodGltZW91dCkgPT4gewogIHJldHVybiAobm90aWZ5KSA9PiB7CiAgICBzZXRUaW1lb3V0KG5vdGlmeSwgdGltZW91dCk7CiAgfTsKfTsKdmFyIGF1dG9CYXRjaEVuaGFuY2VyID0gKG9wdGlvbnMgPSB7CiAgdHlwZTogInJhZiIKfSkgPT4gKG5leHQpID0+ICguLi5hcmdzKSA9PiB7CiAgY29uc3Qgc3RvcmUgPSBuZXh0KC4uLmFyZ3MpOwogIGxldCBub3RpZnlpbmcgPSB0cnVlOwogIGxldCBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9IGZhbHNlOwogIGxldCBub3RpZmljYXRpb25RdWV1ZWQgPSBmYWxzZTsKICBjb25zdCBsaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIGNvbnN0IHF1ZXVlQ2FsbGJhY2sgPSBvcHRpb25zLnR5cGUgPT09ICJ0aWNrIiA/IHF1ZXVlTWljcm90YXNrIDogb3B0aW9ucy50eXBlID09PSAicmFmIiA/ICgKICAgIC8vIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3b24ndCBleGlzdCBpbiBTU1IgZW52aXJvbm1lbnRzLiBGYWxsIGJhY2sgdG8gYSB2YWd1ZSBhcHByb3hpbWF0aW9uIGp1c3QgdG8ga2VlcCBmcm9tIGVycm9yaW5nLgogICAgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgOiBjcmVhdGVRdWV1ZVdpdGhUaW1lcigxMCkKICApIDogb3B0aW9ucy50eXBlID09PSAiY2FsbGJhY2siID8gb3B0aW9ucy5xdWV1ZU5vdGlmaWNhdGlvbiA6IGNyZWF0ZVF1ZXVlV2l0aFRpbWVyKG9wdGlvbnMudGltZW91dCk7CiAgY29uc3Qgbm90aWZ5TGlzdGVuZXJzID0gKCkgPT4gewogICAgbm90aWZpY2F0aW9uUXVldWVkID0gZmFsc2U7CiAgICBpZiAoc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2spIHsKICAgICAgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSBmYWxzZTsKICAgICAgbGlzdGVuZXJzLmZvckVhY2goKGwpID0+IGwoKSk7CiAgICB9CiAgfTsKICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgc3RvcmUsIHsKICAgIC8vIE92ZXJyaWRlIHRoZSBiYXNlIGBzdG9yZS5zdWJzY3JpYmVgIG1ldGhvZCB0byBrZWVwIG9yaWdpbmFsIGxpc3RlbmVycwogICAgLy8gZnJvbSBydW5uaW5nIGlmIHdlJ3JlIGRlbGF5aW5nIG5vdGlmaWNhdGlvbnMKICAgIHN1YnNjcmliZShsaXN0ZW5lcjIpIHsKICAgICAgY29uc3Qgd3JhcHBlZExpc3RlbmVyID0gKCkgPT4gbm90aWZ5aW5nICYmIGxpc3RlbmVyMigpOwogICAgICBjb25zdCB1bnN1YnNjcmliZSA9IHN0b3JlLnN1YnNjcmliZSh3cmFwcGVkTGlzdGVuZXIpOwogICAgICBsaXN0ZW5lcnMuYWRkKGxpc3RlbmVyMik7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgdW5zdWJzY3JpYmUoKTsKICAgICAgICBsaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVyMik7CiAgICAgIH07CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGJhc2UgYHN0b3JlLmRpc3BhdGNoYCBtZXRob2Qgc28gdGhhdCB3ZSBjYW4gY2hlY2sgYWN0aW9ucwogICAgLy8gZm9yIHRoZSBgc2hvdWxkQXV0b0JhdGNoYCBmbGFnIGFuZCBkZXRlcm1pbmUgaWYgYmF0Y2hpbmcgaXMgYWN0aXZlCiAgICBkaXNwYXRjaChhY3Rpb24pIHsKICAgICAgdHJ5IHsKICAgICAgICBub3RpZnlpbmcgPSAhYWN0aW9uPy5tZXRhPy5bU0hPVUxEX0FVVE9CQVRDSF07CiAgICAgICAgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSAhbm90aWZ5aW5nOwogICAgICAgIGlmIChzaG91bGROb3RpZnlBdEVuZE9mVGljaykgewogICAgICAgICAgaWYgKCFub3RpZmljYXRpb25RdWV1ZWQpIHsKICAgICAgICAgICAgbm90aWZpY2F0aW9uUXVldWVkID0gdHJ1ZTsKICAgICAgICAgICAgcXVldWVDYWxsYmFjayhub3RpZnlMaXN0ZW5lcnMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RvcmUuZGlzcGF0Y2goYWN0aW9uKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBub3RpZnlpbmcgPSB0cnVlOwogICAgICB9CiAgICB9CiAgfSk7Cn07CnZhciBidWlsZEdldERlZmF1bHRFbmhhbmNlcnMgPSAobWlkZGxld2FyZUVuaGFuY2VyKSA9PiBmdW5jdGlvbiBnZXREZWZhdWx0RW5oYW5jZXJzKG9wdGlvbnMpIHsKICBjb25zdCB7CiAgICBhdXRvQmF0Y2ggPSB0cnVlCiAgfSA9IG9wdGlvbnMgPz8ge307CiAgbGV0IGVuaGFuY2VyQXJyYXkgPSBuZXcgVHVwbGUobWlkZGxld2FyZUVuaGFuY2VyKTsKICBpZiAoYXV0b0JhdGNoKSB7CiAgICBlbmhhbmNlckFycmF5LnB1c2goYXV0b0JhdGNoRW5oYW5jZXIodHlwZW9mIGF1dG9CYXRjaCA9PT0gIm9iamVjdCIgPyBhdXRvQmF0Y2ggOiB2b2lkIDApKTsKICB9CiAgcmV0dXJuIGVuaGFuY2VyQXJyYXk7Cn07CmZ1bmN0aW9uIGNvbmZpZ3VyZVN0b3JlKG9wdGlvbnMpIHsKICBjb25zdCBnZXREZWZhdWx0TWlkZGxld2FyZSA9IGJ1aWxkR2V0RGVmYXVsdE1pZGRsZXdhcmUoKTsKICBjb25zdCB7CiAgICByZWR1Y2VyID0gdm9pZCAwLAogICAgbWlkZGxld2FyZSwKICAgIGRldlRvb2xzID0gdHJ1ZSwKICAgIGR1cGxpY2F0ZU1pZGRsZXdhcmVDaGVjayA9IHRydWUsCiAgICBwcmVsb2FkZWRTdGF0ZSA9IHZvaWQgMCwKICAgIGVuaGFuY2VycyA9IHZvaWQgMAogIH0gPSBvcHRpb25zIHx8IHt9OwogIGxldCByb290UmVkdWNlcjI7CiAgaWYgKHR5cGVvZiByZWR1Y2VyID09PSAiZnVuY3Rpb24iKSB7CiAgICByb290UmVkdWNlcjIgPSByZWR1Y2VyOwogIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChyZWR1Y2VyKSkgewogICAgcm9vdFJlZHVjZXIyID0gY29tYmluZVJlZHVjZXJzKHJlZHVjZXIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEpIDogImByZWR1Y2VyYCBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50LCBhbmQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdCBvZiBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIGNvbWJpbmVSZWR1Y2VycyIpOwogIH0KICBpZiAobWlkZGxld2FyZSAmJiB0eXBlb2YgbWlkZGxld2FyZSAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyKSA6ICJgbWlkZGxld2FyZWAgZmllbGQgbXVzdCBiZSBhIGNhbGxiYWNrIik7CiAgfQogIGxldCBmaW5hbE1pZGRsZXdhcmU7CiAgaWYgKHR5cGVvZiBtaWRkbGV3YXJlID09PSAiZnVuY3Rpb24iKSB7CiAgICBmaW5hbE1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlKGdldERlZmF1bHRNaWRkbGV3YXJlKTsKICAgIGlmICghQXJyYXkuaXNBcnJheShmaW5hbE1pZGRsZXdhcmUpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMykgOiAid2hlbiB1c2luZyBhIG1pZGRsZXdhcmUgYnVpbGRlciBmdW5jdGlvbiwgYW4gYXJyYXkgb2YgbWlkZGxld2FyZSBtdXN0IGJlIHJldHVybmVkIik7CiAgICB9CiAgfSBlbHNlIHsKICAgIGZpbmFsTWlkZGxld2FyZSA9IGdldERlZmF1bHRNaWRkbGV3YXJlKCk7CiAgfQogIGlmIChmaW5hbE1pZGRsZXdhcmUuc29tZSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gIT09ICJmdW5jdGlvbiIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQpIDogImVhY2ggbWlkZGxld2FyZSBwcm92aWRlZCB0byBjb25maWd1cmVTdG9yZSBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICB9CiAgaWYgKGR1cGxpY2F0ZU1pZGRsZXdhcmVDaGVjaykgewogICAgbGV0IG1pZGRsZXdhcmVSZWZlcmVuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGZpbmFsTWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlMikgPT4gewogICAgICBpZiAobWlkZGxld2FyZVJlZmVyZW5jZXMuaGFzKG1pZGRsZXdhcmUyKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNDIpIDogIkR1cGxpY2F0ZSBtaWRkbGV3YXJlIHJlZmVyZW5jZXMgZm91bmQgd2hlbiBjcmVhdGluZyB0aGUgc3RvcmUuIEVuc3VyZSB0aGF0IGVhY2ggbWlkZGxld2FyZSBpcyBvbmx5IGluY2x1ZGVkIG9uY2UuIik7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZVJlZmVyZW5jZXMuYWRkKG1pZGRsZXdhcmUyKTsKICAgIH0pOwogIH0KICBsZXQgZmluYWxDb21wb3NlID0gY29tcG9zZTsKICBpZiAoZGV2VG9vbHMpIHsKICAgIGZpbmFsQ29tcG9zZSA9IGNvbXBvc2VXaXRoRGV2VG9vbHMoewogICAgICAvLyBFbmFibGUgY2FwdHVyZSBvZiBzdGFjayB0cmFjZXMgZm9yIGRpc3BhdGNoZWQgUmVkdXggYWN0aW9ucwogICAgICB0cmFjZTogdHJ1ZSwKICAgICAgLi4udHlwZW9mIGRldlRvb2xzID09PSAib2JqZWN0IiAmJiBkZXZUb29scwogICAgfSk7CiAgfQogIGNvbnN0IG1pZGRsZXdhcmVFbmhhbmNlciA9IGFwcGx5TWlkZGxld2FyZSguLi5maW5hbE1pZGRsZXdhcmUpOwogIGNvbnN0IGdldERlZmF1bHRFbmhhbmNlcnMgPSBidWlsZEdldERlZmF1bHRFbmhhbmNlcnMobWlkZGxld2FyZUVuaGFuY2VyKTsKICBpZiAoZW5oYW5jZXJzICYmIHR5cGVvZiBlbmhhbmNlcnMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNSkgOiAiYGVuaGFuY2Vyc2AgZmllbGQgbXVzdCBiZSBhIGNhbGxiYWNrIik7CiAgfQogIGxldCBzdG9yZUVuaGFuY2VycyA9IHR5cGVvZiBlbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIgPyBlbmhhbmNlcnMoZ2V0RGVmYXVsdEVuaGFuY2VycykgOiBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgaWYgKCFBcnJheS5pc0FycmF5KHN0b3JlRW5oYW5jZXJzKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg2KSA6ICJgZW5oYW5jZXJzYCBjYWxsYmFjayBtdXN0IHJldHVybiBhbiBhcnJheSIpOwogIH0KICBpZiAoc3RvcmVFbmhhbmNlcnMuc29tZSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gIT09ICJmdW5jdGlvbiIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDcpIDogImVhY2ggZW5oYW5jZXIgcHJvdmlkZWQgdG8gY29uZmlndXJlU3RvcmUgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgfQogIGlmIChmaW5hbE1pZGRsZXdhcmUubGVuZ3RoICYmICFzdG9yZUVuaGFuY2Vycy5pbmNsdWRlcyhtaWRkbGV3YXJlRW5oYW5jZXIpKSB7CiAgICBjb25zb2xlLmVycm9yKCJtaWRkbGV3YXJlcyB3ZXJlIHByb3ZpZGVkLCBidXQgbWlkZGxld2FyZSBlbmhhbmNlciB3YXMgbm90IGluY2x1ZGVkIGluIGZpbmFsIGVuaGFuY2VycyAtIG1ha2Ugc3VyZSB0byBjYWxsIGBnZXREZWZhdWx0RW5oYW5jZXJzYCIpOwogIH0KICBjb25zdCBjb21wb3NlZEVuaGFuY2VyID0gZmluYWxDb21wb3NlKC4uLnN0b3JlRW5oYW5jZXJzKTsKICByZXR1cm4gY3JlYXRlU3RvcmUocm9vdFJlZHVjZXIyLCBwcmVsb2FkZWRTdGF0ZSwgY29tcG9zZWRFbmhhbmNlcik7Cn0KZnVuY3Rpb24gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2soYnVpbGRlckNhbGxiYWNrKSB7CiAgY29uc3QgYWN0aW9uc01hcCA9IHt9OwogIGNvbnN0IGFjdGlvbk1hdGNoZXJzID0gW107CiAgbGV0IGRlZmF1bHRDYXNlUmVkdWNlcjsKICBjb25zdCBidWlsZGVyID0gewogICAgYWRkQ2FzZSh0eXBlT3JBY3Rpb25DcmVhdG9yLCByZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGFjdGlvbk1hdGNoZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjYpIDogImBidWlsZGVyLmFkZENhc2VgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGRNYXRjaGVyYCIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI3KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdHlwZU9yQWN0aW9uQ3JlYXRvciA9PT0gInN0cmluZyIgPyB0eXBlT3JBY3Rpb25DcmVhdG9yIDogdHlwZU9yQWN0aW9uQ3JlYXRvci50eXBlOwogICAgICBpZiAoIXR5cGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI4KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYW4gZW1wdHkgYWN0aW9uIHR5cGUiKTsKICAgICAgfQogICAgICBpZiAodHlwZSBpbiBhY3Rpb25zTWFwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyOSkgOiBgXGBidWlsZGVyLmFkZENhc2VcYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggdHdvIHJlZHVjZXJzIGZvciB0aGUgc2FtZSBhY3Rpb24gdHlwZSAnJHt0eXBlfSdgKTsKICAgICAgfQogICAgICBhY3Rpb25zTWFwW3R5cGVdID0gcmVkdWNlcjsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkQXN5bmNUaHVuayhhc3luY1RodW5rLCByZWR1Y2VycykgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNDMpIDogImBidWlsZGVyLmFkZEFzeW5jVGh1bmtgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHJlZHVjZXJzLnBlbmRpbmcpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5wZW5kaW5nLnR5cGVdID0gcmVkdWNlcnMucGVuZGluZzsKICAgICAgaWYgKHJlZHVjZXJzLnJlamVjdGVkKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsucmVqZWN0ZWQudHlwZV0gPSByZWR1Y2Vycy5yZWplY3RlZDsKICAgICAgaWYgKHJlZHVjZXJzLmZ1bGZpbGxlZCkgYWN0aW9uc01hcFthc3luY1RodW5rLmZ1bGZpbGxlZC50eXBlXSA9IHJlZHVjZXJzLmZ1bGZpbGxlZDsKICAgICAgaWYgKHJlZHVjZXJzLnNldHRsZWQpIGFjdGlvbk1hdGNoZXJzLnB1c2goewogICAgICAgIG1hdGNoZXI6IGFzeW5jVGh1bmsuc2V0dGxlZCwKICAgICAgICByZWR1Y2VyOiByZWR1Y2Vycy5zZXR0bGVkCiAgICAgIH0pOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGRNYXRjaGVyKG1hdGNoZXIsIHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMwKSA6ICJgYnVpbGRlci5hZGRNYXRjaGVyYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFjdGlvbk1hdGNoZXJzLnB1c2goewogICAgICAgIG1hdGNoZXIsCiAgICAgICAgcmVkdWNlcgogICAgICB9KTsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkRGVmYXVsdENhc2UocmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzEpIDogImBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCBjYW4gb25seSBiZSBjYWxsZWQgb25jZSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBkZWZhdWx0Q2FzZVJlZHVjZXIgPSByZWR1Y2VyOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0KICB9OwogIGJ1aWxkZXJDYWxsYmFjayhidWlsZGVyKTsKICByZXR1cm4gW2FjdGlvbnNNYXAsIGFjdGlvbk1hdGNoZXJzLCBkZWZhdWx0Q2FzZVJlZHVjZXJdOwp9CmZ1bmN0aW9uIGlzU3RhdGVGdW5jdGlvbih4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJmdW5jdGlvbiI7Cn0KZnVuY3Rpb24gY3JlYXRlUmVkdWNlcihpbml0aWFsU3RhdGUxMywgbWFwT3JCdWlsZGVyQ2FsbGJhY2spIHsKICBpZiAodHJ1ZSkgewogICAgaWYgKHR5cGVvZiBtYXBPckJ1aWxkZXJDYWxsYmFjayA9PT0gIm9iamVjdCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg4KSA6ICJUaGUgb2JqZWN0IG5vdGF0aW9uIGZvciBgY3JlYXRlUmVkdWNlcmAgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHVzZSB0aGUgJ2J1aWxkZXIgY2FsbGJhY2snIG5vdGF0aW9uIGluc3RlYWQ6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2NyZWF0ZVJlZHVjZXIiKTsKICAgIH0KICB9CiAgbGV0IFthY3Rpb25zTWFwLCBmaW5hbEFjdGlvbk1hdGNoZXJzLCBmaW5hbERlZmF1bHRDYXNlUmVkdWNlcl0gPSBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhtYXBPckJ1aWxkZXJDYWxsYmFjayk7CiAgbGV0IGdldEluaXRpYWxTdGF0ZTsKICBpZiAoaXNTdGF0ZUZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSkgewogICAgZ2V0SW5pdGlhbFN0YXRlID0gKCkgPT4gZnJlZXplRHJhZnRhYmxlKGluaXRpYWxTdGF0ZTEzKCkpOwogIH0gZWxzZSB7CiAgICBjb25zdCBmcm96ZW5Jbml0aWFsU3RhdGUgPSBmcmVlemVEcmFmdGFibGUoaW5pdGlhbFN0YXRlMTMpOwogICAgZ2V0SW5pdGlhbFN0YXRlID0gKCkgPT4gZnJvemVuSW5pdGlhbFN0YXRlOwogIH0KICBmdW5jdGlvbiByZWR1Y2VyKHN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlKCksIGFjdGlvbikgewogICAgbGV0IGNhc2VSZWR1Y2VycyA9IFthY3Rpb25zTWFwW2FjdGlvbi50eXBlXSwgLi4uZmluYWxBY3Rpb25NYXRjaGVycy5maWx0ZXIoKHsKICAgICAgbWF0Y2hlcgogICAgfSkgPT4gbWF0Y2hlcihhY3Rpb24pKS5tYXAoKHsKICAgICAgcmVkdWNlcjogcmVkdWNlcjIKICAgIH0pID0+IHJlZHVjZXIyKV07CiAgICBpZiAoY2FzZVJlZHVjZXJzLmZpbHRlcigoY3IpID0+ICEhY3IpLmxlbmd0aCA9PT0gMCkgewogICAgICBjYXNlUmVkdWNlcnMgPSBbZmluYWxEZWZhdWx0Q2FzZVJlZHVjZXJdOwogICAgfQogICAgcmV0dXJuIGNhc2VSZWR1Y2Vycy5yZWR1Y2UoKHByZXZpb3VzU3RhdGUsIGNhc2VSZWR1Y2VyKSA9PiB7CiAgICAgIGlmIChjYXNlUmVkdWNlcikgewogICAgICAgIGlmIChpc0RyYWZ0KHByZXZpb3VzU3RhdGUpKSB7CiAgICAgICAgICBjb25zdCBkcmFmdCA9IHByZXZpb3VzU3RhdGU7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBjYXNlUmVkdWNlcihkcmFmdCwgYWN0aW9uKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmICghaXNEcmFmdGFibGUocHJldmlvdXNTdGF0ZSkpIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhc2VSZWR1Y2VyKHByZXZpb3VzU3RhdGUsIGFjdGlvbik7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZXZpb3VzU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBFcnJvcigiQSBjYXNlIHJlZHVjZXIgb24gYSBub24tZHJhZnRhYmxlIHZhbHVlIG11c3Qgbm90IHJldHVybiB1bmRlZmluZWQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBwcm9kdWNlKHByZXZpb3VzU3RhdGUsIChkcmFmdCkgPT4gewogICAgICAgICAgICByZXR1cm4gY2FzZVJlZHVjZXIoZHJhZnQsIGFjdGlvbik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICB9LCBzdGF0ZSk7CiAgfQogIHJlZHVjZXIuZ2V0SW5pdGlhbFN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlOwogIHJldHVybiByZWR1Y2VyOwp9CnZhciBtYXRjaGVzID0gKG1hdGNoZXIsIGFjdGlvbikgPT4gewogIGlmIChoYXNNYXRjaEZ1bmN0aW9uKG1hdGNoZXIpKSB7CiAgICByZXR1cm4gbWF0Y2hlci5tYXRjaChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICByZXR1cm4gbWF0Y2hlcihhY3Rpb24pOwogIH0KfTsKZnVuY3Rpb24gaXNBbnlPZiguLi5tYXRjaGVycykgewogIHJldHVybiAoYWN0aW9uKSA9PiB7CiAgICByZXR1cm4gbWF0Y2hlcnMuc29tZSgobWF0Y2hlcikgPT4gbWF0Y2hlcyhtYXRjaGVyLCBhY3Rpb24pKTsKICB9Owp9CnZhciB1cmxBbHBoYWJldCA9ICJNb2R1bGVTeW1iaGFzT3duUHItMDEyMzQ1Njc4OUFCQ0RFRkdITlJWZmdjdGlVdnpfS3FZVEprTHhwWlhJalFXIjsKdmFyIG5hbm9pZCA9IChzaXplID0gMjEpID0+IHsKICBsZXQgaWQgPSAiIjsKICBsZXQgaSA9IHNpemU7CiAgd2hpbGUgKGktLSkgewogICAgaWQgKz0gdXJsQWxwaGFiZXRbTWF0aC5yYW5kb20oKSAqIDY0IHwgMF07CiAgfQogIHJldHVybiBpZDsKfTsKdmFyIGNvbW1vblByb3BlcnRpZXMgPSBbIm5hbWUiLCAibWVzc2FnZSIsICJzdGFjayIsICJjb2RlIl07CnZhciBSZWplY3RXaXRoVmFsdWUgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IocGF5bG9hZCwgbWV0YSkgewogICAgdGhpcy5wYXlsb2FkID0gcGF5bG9hZDsKICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgfQogIC8qCiAgdHlwZS1vbmx5IHByb3BlcnR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gUmVqZWN0V2l0aFZhbHVlIGFuZCBGdWxmaWxsV2l0aE1ldGEKICBkb2VzIG5vdCBleGlzdCBhdCBydW50aW1lCiAgKi8KICBfdHlwZTsKfTsKdmFyIEZ1bGZpbGxXaXRoTWV0YSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwYXlsb2FkLCBtZXRhKSB7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5tZXRhID0gbWV0YTsKICB9CiAgLyoKICB0eXBlLW9ubHkgcHJvcGVydHkgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBSZWplY3RXaXRoVmFsdWUgYW5kIEZ1bGZpbGxXaXRoTWV0YQogIGRvZXMgbm90IGV4aXN0IGF0IHJ1bnRpbWUKICAqLwogIF90eXBlOwp9Owp2YXIgbWluaVNlcmlhbGl6ZUVycm9yID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgIGNvbnN0IHNpbXBsZUVycm9yID0ge307CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIGNvbW1vblByb3BlcnRpZXMpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZVtwcm9wZXJ0eV0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgc2ltcGxlRXJyb3JbcHJvcGVydHldID0gdmFsdWVbcHJvcGVydHldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2ltcGxlRXJyb3I7CiAgfQogIHJldHVybiB7CiAgICBtZXNzYWdlOiBTdHJpbmcodmFsdWUpCiAgfTsKfTsKdmFyIGV4dGVybmFsQWJvcnRNZXNzYWdlID0gIkV4dGVybmFsIHNpZ25hbCB3YXMgYWJvcnRlZCI7CnZhciBjcmVhdGVBc3luY1RodW5rID0gLyogQF9fUFVSRV9fICovICgoKSA9PiB7CiAgZnVuY3Rpb24gY3JlYXRlQXN5bmNUaHVuazIodHlwZVByZWZpeCwgcGF5bG9hZENyZWF0b3IsIG9wdGlvbnMpIHsKICAgIGNvbnN0IGZ1bGZpbGxlZCA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9mdWxmaWxsZWQiLCAocGF5bG9hZCwgcmVxdWVzdElkLCBhcmcsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQsCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogImZ1bGZpbGxlZCIKICAgICAgfQogICAgfSkpOwogICAgY29uc3QgcGVuZGluZyA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9wZW5kaW5nIiwgKHJlcXVlc3RJZCwgYXJnLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkOiB2b2lkIDAsCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogInBlbmRpbmciCiAgICAgIH0KICAgIH0pKTsKICAgIGNvbnN0IHJlamVjdGVkID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL3JlamVjdGVkIiwgKGVycm9yLCByZXF1ZXN0SWQsIGFyZywgcGF5bG9hZCwgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZCwKICAgICAgZXJyb3I6IChvcHRpb25zICYmIG9wdGlvbnMuc2VyaWFsaXplRXJyb3IgfHwgbWluaVNlcmlhbGl6ZUVycm9yKShlcnJvciB8fCAiUmVqZWN0ZWQiKSwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZWplY3RlZFdpdGhWYWx1ZTogISFwYXlsb2FkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJyZWplY3RlZCIsCiAgICAgICAgYWJvcnRlZDogZXJyb3I/Lm5hbWUgPT09ICJBYm9ydEVycm9yIiwKICAgICAgICBjb25kaXRpb246IGVycm9yPy5uYW1lID09PSAiQ29uZGl0aW9uRXJyb3IiCiAgICAgIH0KICAgIH0pKTsKICAgIGZ1bmN0aW9uIGFjdGlvbkNyZWF0b3IoYXJnLCB7CiAgICAgIHNpZ25hbAogICAgfSA9IHt9KSB7CiAgICAgIHJldHVybiAoZGlzcGF0Y2gsIGdldFN0YXRlLCBleHRyYSkgPT4gewogICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IG9wdGlvbnM/LmlkR2VuZXJhdG9yID8gb3B0aW9ucy5pZEdlbmVyYXRvcihhcmcpIDogbmFub2lkKCk7CiAgICAgICAgY29uc3QgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICAgIGxldCBhYm9ydEhhbmRsZXI7CiAgICAgICAgbGV0IGFib3J0UmVhc29uOwogICAgICAgIGZ1bmN0aW9uIGFib3J0KHJlYXNvbikgewogICAgICAgICAgYWJvcnRSZWFzb24gPSByZWFzb247CiAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuYWJvcnQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpZ25hbCkgewogICAgICAgICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgICAgIGFib3J0KGV4dGVybmFsQWJvcnRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsICgpID0+IGFib3J0KGV4dGVybmFsQWJvcnRNZXNzYWdlKSwgewogICAgICAgICAgICAgIG9uY2U6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByb21pc2UgPSBhc3luYyBmdW5jdGlvbigpIHsKICAgICAgICAgIGxldCBmaW5hbEFjdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxldCBjb25kaXRpb25SZXN1bHQgPSBvcHRpb25zPy5jb25kaXRpb24/LihhcmcsIHsKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGlzVGhlbmFibGUoY29uZGl0aW9uUmVzdWx0KSkgewogICAgICAgICAgICAgIGNvbmRpdGlvblJlc3VsdCA9IGF3YWl0IGNvbmRpdGlvblJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29uZGl0aW9uUmVzdWx0ID09PSBmYWxzZSB8fCBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgICAgICBuYW1lOiAiQ29uZGl0aW9uRXJyb3IiLAogICAgICAgICAgICAgICAgbWVzc2FnZTogIkFib3J0ZWQgZHVlIHRvIGNvbmRpdGlvbiBjYWxsYmFjayByZXR1cm5pbmcgZmFsc2UuIgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgYWJvcnRlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgICAgYWJvcnRIYW5kbGVyID0gKCkgPT4gewogICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgbmFtZTogIkFib3J0RXJyb3IiLAogICAgICAgICAgICAgICAgICBtZXNzYWdlOiBhYm9ydFJlYXNvbiB8fCAiQWJvcnRlZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkaXNwYXRjaChwZW5kaW5nKHJlcXVlc3RJZCwgYXJnLCBvcHRpb25zPy5nZXRQZW5kaW5nTWV0YT8uKHsKICAgICAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICAgICAgYXJnCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYQogICAgICAgICAgICB9KSkpOwogICAgICAgICAgICBmaW5hbEFjdGlvbiA9IGF3YWl0IFByb21pc2UucmFjZShbYWJvcnRlZFByb21pc2UsIFByb21pc2UucmVzb2x2ZShwYXlsb2FkQ3JlYXRvcihhcmcsIHsKICAgICAgICAgICAgICBkaXNwYXRjaCwKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYSwKICAgICAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICAgICAgc2lnbmFsOiBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLAogICAgICAgICAgICAgIGFib3J0LAogICAgICAgICAgICAgIHJlamVjdFdpdGhWYWx1ZTogKHZhbHVlLCBtZXRhKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFJlamVjdFdpdGhWYWx1ZSh2YWx1ZSwgbWV0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmdWxmaWxsV2l0aFZhbHVlOiAodmFsdWUsIG1ldGEpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRnVsZmlsbFdpdGhNZXRhKHZhbHVlLCBtZXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKS50aGVuKChyZXN1bHQpID0+IHsKICAgICAgICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgUmVqZWN0V2l0aFZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyByZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBGdWxmaWxsV2l0aE1ldGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdWxmaWxsZWQocmVzdWx0LnBheWxvYWQsIHJlcXVlc3RJZCwgYXJnLCByZXN1bHQubWV0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmdWxmaWxsZWQocmVzdWx0LCByZXF1ZXN0SWQsIGFyZyk7CiAgICAgICAgICAgIH0pXSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZmluYWxBY3Rpb24gPSBlcnIgaW5zdGFuY2VvZiBSZWplY3RXaXRoVmFsdWUgPyByZWplY3RlZChudWxsLCByZXF1ZXN0SWQsIGFyZywgZXJyLnBheWxvYWQsIGVyci5tZXRhKSA6IHJlamVjdGVkKGVyciwgcmVxdWVzdElkLCBhcmcpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaWYgKGFib3J0SGFuZGxlcikgewogICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlci5zaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBza2lwRGlzcGF0Y2ggPSBvcHRpb25zICYmICFvcHRpb25zLmRpc3BhdGNoQ29uZGl0aW9uUmVqZWN0aW9uICYmIHJlamVjdGVkLm1hdGNoKGZpbmFsQWN0aW9uKSAmJiBmaW5hbEFjdGlvbi5tZXRhLmNvbmRpdGlvbjsKICAgICAgICAgIGlmICghc2tpcERpc3BhdGNoKSB7CiAgICAgICAgICAgIGRpc3BhdGNoKGZpbmFsQWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaW5hbEFjdGlvbjsKICAgICAgICB9KCk7CiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJvbWlzZSwgewogICAgICAgICAgYWJvcnQsCiAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICBhcmcsCiAgICAgICAgICB1bndyYXAoKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4odW53cmFwUmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuYXNzaWduKGFjdGlvbkNyZWF0b3IsIHsKICAgICAgcGVuZGluZywKICAgICAgcmVqZWN0ZWQsCiAgICAgIGZ1bGZpbGxlZCwKICAgICAgc2V0dGxlZDogaXNBbnlPZihyZWplY3RlZCwgZnVsZmlsbGVkKSwKICAgICAgdHlwZVByZWZpeAogICAgfSk7CiAgfQogIGNyZWF0ZUFzeW5jVGh1bmsyLndpdGhUeXBlcyA9ICgpID0+IGNyZWF0ZUFzeW5jVGh1bmsyOwogIHJldHVybiBjcmVhdGVBc3luY1RodW5rMjsKfSkoKTsKZnVuY3Rpb24gdW53cmFwUmVzdWx0KGFjdGlvbikgewogIGlmIChhY3Rpb24ubWV0YSAmJiBhY3Rpb24ubWV0YS5yZWplY3RlZFdpdGhWYWx1ZSkgewogICAgdGhyb3cgYWN0aW9uLnBheWxvYWQ7CiAgfQogIGlmIChhY3Rpb24uZXJyb3IpIHsKICAgIHRocm93IGFjdGlvbi5lcnJvcjsKICB9CiAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwp9CmZ1bmN0aW9uIGlzVGhlbmFibGUodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIjsKfQp2YXIgYXN5bmNUaHVua1N5bWJvbCA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJydGstc2xpY2UtY3JlYXRlYXN5bmN0aHVuayIpOwp2YXIgYXN5bmNUaHVua0NyZWF0b3IgPSB7CiAgW2FzeW5jVGh1bmtTeW1ib2xdOiBjcmVhdGVBc3luY1RodW5rCn07CmZ1bmN0aW9uIGdldFR5cGUoc2xpY2UyLCBhY3Rpb25LZXkpIHsKICByZXR1cm4gYCR7c2xpY2UyfS8ke2FjdGlvbktleX1gOwp9CmZ1bmN0aW9uIGJ1aWxkQ3JlYXRlU2xpY2UoewogIGNyZWF0b3JzCn0gPSB7fSkgewogIGNvbnN0IGNBVCA9IGNyZWF0b3JzPy5hc3luY1RodW5rPy5bYXN5bmNUaHVua1N5bWJvbF07CiAgcmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZVNsaWNlMihvcHRpb25zKSB7CiAgICBjb25zdCB7CiAgICAgIG5hbWUsCiAgICAgIHJlZHVjZXJQYXRoID0gbmFtZQogICAgfSA9IG9wdGlvbnM7CiAgICBpZiAoIW5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMSkgOiAiYG5hbWVgIGlzIGEgcmVxdWlyZWQgb3B0aW9uIGZvciBjcmVhdGVTbGljZSIpOwogICAgfQogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJiB0cnVlKSB7CiAgICAgIGlmIChvcHRpb25zLmluaXRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiWW91IG11c3QgcHJvdmlkZSBhbiBgaW5pdGlhbFN0YXRlYCB2YWx1ZSB0aGF0IGlzIG5vdCBgdW5kZWZpbmVkYC4gWW91IG1heSBoYXZlIG1pc3NwZWxsZWQgYGluaXRpYWxTdGF0ZWAiKTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVkdWNlcnMgPSAodHlwZW9mIG9wdGlvbnMucmVkdWNlcnMgPT09ICJmdW5jdGlvbiIgPyBvcHRpb25zLnJlZHVjZXJzKGJ1aWxkUmVkdWNlckNyZWF0b3JzKCkpIDogb3B0aW9ucy5yZWR1Y2VycykgfHwge307CiAgICBjb25zdCByZWR1Y2VyTmFtZXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgICBjb25zdCBjb250ZXh0ID0gewogICAgICBzbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZToge30sCiAgICAgIHNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlOiB7fSwKICAgICAgYWN0aW9uQ3JlYXRvcnM6IHt9LAogICAgICBzbGljZU1hdGNoZXJzOiBbXQogICAgfTsKICAgIGNvbnN0IGNvbnRleHRNZXRob2RzID0gewogICAgICBhZGRDYXNlKHR5cGVPckFjdGlvbkNyZWF0b3IsIHJlZHVjZXIyKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IHR5cGVvZiB0eXBlT3JBY3Rpb25DcmVhdG9yID09PSAic3RyaW5nIiA/IHR5cGVPckFjdGlvbkNyZWF0b3IgOiB0eXBlT3JBY3Rpb25DcmVhdG9yLnR5cGU7CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEyKSA6ICJgY29udGV4dC5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYW4gZW1wdHkgYWN0aW9uIHR5cGUiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGUgaW4gY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMykgOiAiYGNvbnRleHQuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIHR3byByZWR1Y2VycyBmb3IgdGhlIHNhbWUgYWN0aW9uIHR5cGU6ICIgKyB0eXBlKTsKICAgICAgICB9CiAgICAgICAgY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZVt0eXBlXSA9IHJlZHVjZXIyOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgYWRkTWF0Y2hlcihtYXRjaGVyLCByZWR1Y2VyMikgewogICAgICAgIGNvbnRleHQuc2xpY2VNYXRjaGVycy5wdXNoKHsKICAgICAgICAgIG1hdGNoZXIsCiAgICAgICAgICByZWR1Y2VyOiByZWR1Y2VyMgogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgZXhwb3NlQWN0aW9uKG5hbWUyLCBhY3Rpb25DcmVhdG9yKSB7CiAgICAgICAgY29udGV4dC5hY3Rpb25DcmVhdG9yc1tuYW1lMl0gPSBhY3Rpb25DcmVhdG9yOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgZXhwb3NlQ2FzZVJlZHVjZXIobmFtZTIsIHJlZHVjZXIyKSB7CiAgICAgICAgY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZVtuYW1lMl0gPSByZWR1Y2VyMjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0KICAgIH07CiAgICByZWR1Y2VyTmFtZXMuZm9yRWFjaCgocmVkdWNlck5hbWUpID0+IHsKICAgICAgY29uc3QgcmVkdWNlckRlZmluaXRpb24gPSByZWR1Y2Vyc1tyZWR1Y2VyTmFtZV07CiAgICAgIGNvbnN0IHJlZHVjZXJEZXRhaWxzID0gewogICAgICAgIHJlZHVjZXJOYW1lLAogICAgICAgIHR5cGU6IGdldFR5cGUobmFtZSwgcmVkdWNlck5hbWUpLAogICAgICAgIGNyZWF0ZU5vdGF0aW9uOiB0eXBlb2Ygb3B0aW9ucy5yZWR1Y2VycyA9PT0gImZ1bmN0aW9uIgogICAgICB9OwogICAgICBpZiAoaXNBc3luY1RodW5rU2xpY2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikpIHsKICAgICAgICBoYW5kbGVUaHVua0Nhc2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGV0YWlscywgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHRNZXRob2RzLCBjQVQpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhbmRsZU5vcm1hbFJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZXRhaWxzLCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dE1ldGhvZHMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGJ1aWxkUmVkdWNlcigpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZXh0cmFSZWR1Y2VycyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTQpIDogIlRoZSBvYmplY3Qgbm90YXRpb24gZm9yIGBjcmVhdGVTbGljZS5leHRyYVJlZHVjZXJzYCBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgdXNlIHRoZSAnYnVpbGRlciBjYWxsYmFjaycgbm90YXRpb24gaW5zdGVhZDogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvY3JlYXRlU2xpY2UiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgW2V4dHJhUmVkdWNlcnMgPSB7fSwgYWN0aW9uTWF0Y2hlcnMgPSBbXSwgZGVmYXVsdENhc2VSZWR1Y2VyID0gdm9pZCAwXSA9IHR5cGVvZiBvcHRpb25zLmV4dHJhUmVkdWNlcnMgPT09ICJmdW5jdGlvbiIgPyBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhvcHRpb25zLmV4dHJhUmVkdWNlcnMpIDogW29wdGlvbnMuZXh0cmFSZWR1Y2Vyc107CiAgICAgIGNvbnN0IGZpbmFsQ2FzZVJlZHVjZXJzID0gewogICAgICAgIC4uLmV4dHJhUmVkdWNlcnMsCiAgICAgICAgLi4uY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZQogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlUmVkdWNlcihvcHRpb25zLmluaXRpYWxTdGF0ZSwgKGJ1aWxkZXIpID0+IHsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gZmluYWxDYXNlUmVkdWNlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkQ2FzZShrZXksIGZpbmFsQ2FzZVJlZHVjZXJzW2tleV0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzTSBvZiBjb250ZXh0LnNsaWNlTWF0Y2hlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihzTS5tYXRjaGVyLCBzTS5yZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgbSBvZiBhY3Rpb25NYXRjaGVycykgewogICAgICAgICAgYnVpbGRlci5hZGRNYXRjaGVyKG0ubWF0Y2hlciwgbS5yZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgYnVpbGRlci5hZGREZWZhdWx0Q2FzZShkZWZhdWx0Q2FzZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBzZWxlY3RTZWxmID0gKHN0YXRlKSA9PiBzdGF0ZTsKICAgIGNvbnN0IGluamVjdGVkU2VsZWN0b3JDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCBpbmplY3RlZFN0YXRlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgIGxldCBfcmVkdWNlcjsKICAgIGZ1bmN0aW9uIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICBpZiAoIV9yZWR1Y2VyKSBfcmVkdWNlciA9IGJ1aWxkUmVkdWNlcigpOwogICAgICByZXR1cm4gX3JlZHVjZXIoc3RhdGUsIGFjdGlvbik7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIGlmICghX3JlZHVjZXIpIF9yZWR1Y2VyID0gYnVpbGRSZWR1Y2VyKCk7CiAgICAgIHJldHVybiBfcmVkdWNlci5nZXRJbml0aWFsU3RhdGUoKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VTZWxlY3RvclByb3BzKHJlZHVjZXJQYXRoMiwgaW5qZWN0ZWQgPSBmYWxzZSkgewogICAgICBmdW5jdGlvbiBzZWxlY3RTbGljZShzdGF0ZSkgewogICAgICAgIGxldCBzbGljZVN0YXRlID0gc3RhdGVbcmVkdWNlclBhdGgyXTsKICAgICAgICBpZiAodHlwZW9mIHNsaWNlU3RhdGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICAgICAgc2xpY2VTdGF0ZSA9IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTdGF0ZUNhY2hlLCBzZWxlY3RTbGljZSwgZ2V0SW5pdGlhbFN0YXRlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHJ1ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE1KSA6ICJzZWxlY3RTbGljZSByZXR1cm5lZCB1bmRlZmluZWQgZm9yIGFuIHVuaW5qZWN0ZWQgc2xpY2UgcmVkdWNlciIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2xpY2VTdGF0ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRTZWxlY3RvcnMoc2VsZWN0U3RhdGUgPSBzZWxlY3RTZWxmKSB7CiAgICAgICAgY29uc3Qgc2VsZWN0b3JDYWNoZSA9IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTZWxlY3RvckNhY2hlLCBpbmplY3RlZCwgKCkgPT4gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCkpOwogICAgICAgIHJldHVybiBnZXRPckluc2VydENvbXB1dGVkKHNlbGVjdG9yQ2FjaGUsIHNlbGVjdFN0YXRlLCAoKSA9PiB7CiAgICAgICAgICBjb25zdCBtYXAzID0ge307CiAgICAgICAgICBmb3IgKGNvbnN0IFtuYW1lMiwgc2VsZWN0b3JdIG9mIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMuc2VsZWN0b3JzID8/IHt9KSkgewogICAgICAgICAgICBtYXAzW25hbWUyXSA9IHdyYXBTZWxlY3RvcihzZWxlY3Rvciwgc2VsZWN0U3RhdGUsICgpID0+IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTdGF0ZUNhY2hlLCBzZWxlY3RTdGF0ZSwgZ2V0SW5pdGlhbFN0YXRlKSwgaW5qZWN0ZWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hcDM7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICByZWR1Y2VyUGF0aDogcmVkdWNlclBhdGgyLAogICAgICAgIGdldFNlbGVjdG9ycywKICAgICAgICBnZXQgc2VsZWN0b3JzKCkgewogICAgICAgICAgcmV0dXJuIGdldFNlbGVjdG9ycyhzZWxlY3RTbGljZSk7CiAgICAgICAgfSwKICAgICAgICBzZWxlY3RTbGljZQogICAgICB9OwogICAgfQogICAgY29uc3Qgc2xpY2UyID0gewogICAgICBuYW1lLAogICAgICByZWR1Y2VyLAogICAgICBhY3Rpb25zOiBjb250ZXh0LmFjdGlvbkNyZWF0b3JzLAogICAgICBjYXNlUmVkdWNlcnM6IGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWUsCiAgICAgIGdldEluaXRpYWxTdGF0ZSwKICAgICAgLi4ubWFrZVNlbGVjdG9yUHJvcHMocmVkdWNlclBhdGgpLAogICAgICBpbmplY3RJbnRvKGluamVjdGFibGUsIHsKICAgICAgICByZWR1Y2VyUGF0aDogcGF0aE9wdCwKICAgICAgICAuLi5jb25maWcKICAgICAgfSA9IHt9KSB7CiAgICAgICAgY29uc3QgbmV3UmVkdWNlclBhdGggPSBwYXRoT3B0ID8/IHJlZHVjZXJQYXRoOwogICAgICAgIGluamVjdGFibGUuaW5qZWN0KHsKICAgICAgICAgIHJlZHVjZXJQYXRoOiBuZXdSZWR1Y2VyUGF0aCwKICAgICAgICAgIHJlZHVjZXIKICAgICAgICB9LCBjb25maWcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5zbGljZTIsCiAgICAgICAgICAuLi5tYWtlU2VsZWN0b3JQcm9wcyhuZXdSZWR1Y2VyUGF0aCwgdHJ1ZSkKICAgICAgICB9OwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHNsaWNlMjsKICB9Owp9CmZ1bmN0aW9uIHdyYXBTZWxlY3RvcihzZWxlY3Rvciwgc2VsZWN0U3RhdGUsIGdldEluaXRpYWxTdGF0ZSwgaW5qZWN0ZWQpIHsKICBmdW5jdGlvbiB3cmFwcGVyKHJvb3RTdGF0ZSwgLi4uYXJncykgewogICAgbGV0IHNsaWNlU3RhdGUgPSBzZWxlY3RTdGF0ZShyb290U3RhdGUpOwogICAgaWYgKHR5cGVvZiBzbGljZVN0YXRlID09PSAidW5kZWZpbmVkIikgewogICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICBzbGljZVN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlKCk7CiAgICAgIH0gZWxzZSBpZiAodHJ1ZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTYpIDogInNlbGVjdFN0YXRlIHJldHVybmVkIHVuZGVmaW5lZCBmb3IgYW4gdW5pbmplY3RlZCBzbGljZSByZWR1Y2VyIik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzZWxlY3RvcihzbGljZVN0YXRlLCAuLi5hcmdzKTsKICB9CiAgd3JhcHBlci51bndyYXBwZWQgPSBzZWxlY3RvcjsKICByZXR1cm4gd3JhcHBlcjsKfQp2YXIgY3JlYXRlU2xpY2UgPSAvKiBAX19QVVJFX18gKi8gYnVpbGRDcmVhdGVTbGljZSgpOwpmdW5jdGlvbiBidWlsZFJlZHVjZXJDcmVhdG9ycygpIHsKICBmdW5jdGlvbiBhc3luY1RodW5rKHBheWxvYWRDcmVhdG9yLCBjb25maWcpIHsKICAgIHJldHVybiB7CiAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJhc3luY1RodW5rIiwKICAgICAgcGF5bG9hZENyZWF0b3IsCiAgICAgIC4uLmNvbmZpZwogICAgfTsKICB9CiAgYXN5bmNUaHVuay53aXRoVHlwZXMgPSAoKSA9PiBhc3luY1RodW5rOwogIHJldHVybiB7CiAgICByZWR1Y2VyKGNhc2VSZWR1Y2VyKSB7CiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHsKICAgICAgICAvLyBoYWNrIHNvIHRoZSB3cmFwcGluZyBmdW5jdGlvbiBoYXMgdGhlIHNhbWUgbmFtZSBhcyB0aGUgb3JpZ2luYWwKICAgICAgICAvLyB3ZSBuZWVkIHRvIGNyZWF0ZSBhIHdyYXBwZXIgc28gdGhlIGByZWR1Y2VyRGVmaW5pdGlvblR5cGVgIGlzIG5vdCBhc3NpZ25lZCB0byB0aGUgb3JpZ2luYWwKICAgICAgICBbY2FzZVJlZHVjZXIubmFtZV0oLi4uYXJncykgewogICAgICAgICAgcmV0dXJuIGNhc2VSZWR1Y2VyKC4uLmFyZ3MpOwogICAgICAgIH0KICAgICAgfVtjYXNlUmVkdWNlci5uYW1lXSwgewogICAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJyZWR1Y2VyIgogICAgICAgIC8qIHJlZHVjZXIgKi8KICAgICAgfSk7CiAgICB9LAogICAgcHJlcGFyZWRSZWR1Y2VyKHByZXBhcmUsIHJlZHVjZXIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAicmVkdWNlcldpdGhQcmVwYXJlIiwKICAgICAgICBwcmVwYXJlLAogICAgICAgIHJlZHVjZXIKICAgICAgfTsKICAgIH0sCiAgICBhc3luY1RodW5rCiAgfTsKfQpmdW5jdGlvbiBoYW5kbGVOb3JtYWxSZWR1Y2VyRGVmaW5pdGlvbih7CiAgdHlwZSwKICByZWR1Y2VyTmFtZSwKICBjcmVhdGVOb3RhdGlvbgp9LCBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSwgY29udGV4dCkgewogIGxldCBjYXNlUmVkdWNlcjsKICBsZXQgcHJlcGFyZUNhbGxiYWNrOwogIGlmICgicmVkdWNlciIgaW4gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUpIHsKICAgIGlmIChjcmVhdGVOb3RhdGlvbiAmJiAhaXNDYXNlUmVkdWNlcldpdGhQcmVwYXJlRGVmaW5pdGlvbihtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNykgOiAiUGxlYXNlIHVzZSB0aGUgYGNyZWF0ZS5wcmVwYXJlZFJlZHVjZXJgIG5vdGF0aW9uIGZvciBwcmVwYXJlZCBhY3Rpb24gY3JlYXRvcnMgd2l0aCB0aGUgYGNyZWF0ZWAgbm90YXRpb24uIik7CiAgICB9CiAgICBjYXNlUmVkdWNlciA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLnJlZHVjZXI7CiAgICBwcmVwYXJlQ2FsbGJhY2sgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZS5wcmVwYXJlOwogIH0gZWxzZSB7CiAgICBjYXNlUmVkdWNlciA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlOwogIH0KICBjb250ZXh0LmFkZENhc2UodHlwZSwgY2FzZVJlZHVjZXIpLmV4cG9zZUNhc2VSZWR1Y2VyKHJlZHVjZXJOYW1lLCBjYXNlUmVkdWNlcikuZXhwb3NlQWN0aW9uKHJlZHVjZXJOYW1lLCBwcmVwYXJlQ2FsbGJhY2sgPyBjcmVhdGVBY3Rpb24odHlwZSwgcHJlcGFyZUNhbGxiYWNrKSA6IGNyZWF0ZUFjdGlvbih0eXBlKSk7Cn0KZnVuY3Rpb24gaXNBc3luY1RodW5rU2xpY2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikgewogIHJldHVybiByZWR1Y2VyRGVmaW5pdGlvbi5fcmVkdWNlckRlZmluaXRpb25UeXBlID09PSAiYXN5bmNUaHVuayI7Cn0KZnVuY3Rpb24gaXNDYXNlUmVkdWNlcldpdGhQcmVwYXJlRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikgewogIHJldHVybiByZWR1Y2VyRGVmaW5pdGlvbi5fcmVkdWNlckRlZmluaXRpb25UeXBlID09PSAicmVkdWNlcldpdGhQcmVwYXJlIjsKfQpmdW5jdGlvbiBoYW5kbGVUaHVua0Nhc2VSZWR1Y2VyRGVmaW5pdGlvbih7CiAgdHlwZSwKICByZWR1Y2VyTmFtZQp9LCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dCwgY0FUKSB7CiAgaWYgKCFjQVQpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTgpIDogIkNhbm5vdCB1c2UgYGNyZWF0ZS5hc3luY1RodW5rYCBpbiB0aGUgYnVpbHQtaW4gYGNyZWF0ZVNsaWNlYC4gVXNlIGBidWlsZENyZWF0ZVNsaWNlKHsgY3JlYXRvcnM6IHsgYXN5bmNUaHVuazogYXN5bmNUaHVua0NyZWF0b3IgfSB9KWAgdG8gY3JlYXRlIGEgY3VzdG9taXNlZCB2ZXJzaW9uIG9mIGBjcmVhdGVTbGljZWAuIik7CiAgfQogIGNvbnN0IHsKICAgIHBheWxvYWRDcmVhdG9yLAogICAgZnVsZmlsbGVkLAogICAgcGVuZGluZywKICAgIHJlamVjdGVkLAogICAgc2V0dGxlZCwKICAgIG9wdGlvbnMKICB9ID0gcmVkdWNlckRlZmluaXRpb247CiAgY29uc3QgdGh1bmsyID0gY0FUKHR5cGUsIHBheWxvYWRDcmVhdG9yLCBvcHRpb25zKTsKICBjb250ZXh0LmV4cG9zZUFjdGlvbihyZWR1Y2VyTmFtZSwgdGh1bmsyKTsKICBpZiAoZnVsZmlsbGVkKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLmZ1bGZpbGxlZCwgZnVsZmlsbGVkKTsKICB9CiAgaWYgKHBlbmRpbmcpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIucGVuZGluZywgcGVuZGluZyk7CiAgfQogIGlmIChyZWplY3RlZCkgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5yZWplY3RlZCwgcmVqZWN0ZWQpOwogIH0KICBpZiAoc2V0dGxlZCkgewogICAgY29udGV4dC5hZGRNYXRjaGVyKHRodW5rMi5zZXR0bGVkLCBzZXR0bGVkKTsKICB9CiAgY29udGV4dC5leHBvc2VDYXNlUmVkdWNlcihyZWR1Y2VyTmFtZSwgewogICAgZnVsZmlsbGVkOiBmdWxmaWxsZWQgfHwgbm9vcDMsCiAgICBwZW5kaW5nOiBwZW5kaW5nIHx8IG5vb3AzLAogICAgcmVqZWN0ZWQ6IHJlamVjdGVkIHx8IG5vb3AzLAogICAgc2V0dGxlZDogc2V0dGxlZCB8fCBub29wMwogIH0pOwp9CmZ1bmN0aW9uIG5vb3AzKCkgewp9CnZhciB0YXNrID0gInRhc2siOwp2YXIgbGlzdGVuZXIgPSAibGlzdGVuZXIiOwp2YXIgY29tcGxldGVkID0gImNvbXBsZXRlZCI7CnZhciBjYW5jZWxsZWQgPSAiY2FuY2VsbGVkIjsKdmFyIHRhc2tDYW5jZWxsZWQgPSBgdGFzay0ke2NhbmNlbGxlZH1gOwp2YXIgdGFza0NvbXBsZXRlZCA9IGB0YXNrLSR7Y29tcGxldGVkfWA7CnZhciBsaXN0ZW5lckNhbmNlbGxlZCA9IGAke2xpc3RlbmVyfS0ke2NhbmNlbGxlZH1gOwp2YXIgbGlzdGVuZXJDb21wbGV0ZWQgPSBgJHtsaXN0ZW5lcn0tJHtjb21wbGV0ZWR9YDsKdmFyIFRhc2tBYm9ydEVycm9yID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvZGUpIHsKICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICB0aGlzLm1lc3NhZ2UgPSBgJHt0YXNrfSAke2NhbmNlbGxlZH0gKHJlYXNvbjogJHtjb2RlfSlgOwogIH0KICBuYW1lID0gIlRhc2tBYm9ydEVycm9yIjsKICBtZXNzYWdlOwp9Owp2YXIgYXNzZXJ0RnVuY3Rpb24gPSAoZnVuYywgZXhwZWN0ZWQpID0+IHsKICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMyKSA6IGAke2V4cGVjdGVkfSBpcyBub3QgYSBmdW5jdGlvbmApOwogIH0KfTsKdmFyIG5vb3AyMiA9ICgpID0+IHsKfTsKdmFyIGNhdGNoUmVqZWN0aW9uID0gKHByb21pc2UsIG9uRXJyb3IgPSBub29wMjIpID0+IHsKICBwcm9taXNlLmNhdGNoKG9uRXJyb3IpOwogIHJldHVybiBwcm9taXNlOwp9Owp2YXIgYWRkQWJvcnRTaWduYWxMaXN0ZW5lciA9IChhYm9ydFNpZ25hbCwgY2FsbGJhY2spID0+IHsKICBhYm9ydFNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbGxiYWNrLCB7CiAgICBvbmNlOiB0cnVlCiAgfSk7CiAgcmV0dXJuICgpID0+IGFib3J0U2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FsbGJhY2spOwp9Owp2YXIgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbiA9IChhYm9ydENvbnRyb2xsZXIsIHJlYXNvbikgPT4gewogIGNvbnN0IHNpZ25hbCA9IGFib3J0Q29udHJvbGxlci5zaWduYWw7CiAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICByZXR1cm47CiAgfQogIGlmICghKCJyZWFzb24iIGluIHNpZ25hbCkpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzaWduYWwsICJyZWFzb24iLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiByZWFzb24sCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgd3JpdGFibGU6IHRydWUKICAgIH0pOwogIH0KICA7CiAgYWJvcnRDb250cm9sbGVyLmFib3J0KHJlYXNvbik7Cn07CnZhciB2YWxpZGF0ZUFjdGl2ZSA9IChzaWduYWwpID0+IHsKICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgIGNvbnN0IHsKICAgICAgcmVhc29uCiAgICB9ID0gc2lnbmFsOwogICAgdGhyb3cgbmV3IFRhc2tBYm9ydEVycm9yKHJlYXNvbik7CiAgfQp9OwpmdW5jdGlvbiByYWNlV2l0aFNpZ25hbChzaWduYWwsIHByb21pc2UpIHsKICBsZXQgY2xlYW51cCA9IG5vb3AyMjsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgY29uc3Qgbm90aWZ5UmVqZWN0aW9uID0gKCkgPT4gcmVqZWN0KG5ldyBUYXNrQWJvcnRFcnJvcihzaWduYWwucmVhc29uKSk7CiAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgbm90aWZ5UmVqZWN0aW9uKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNsZWFudXAgPSBhZGRBYm9ydFNpZ25hbExpc3RlbmVyKHNpZ25hbCwgbm90aWZ5UmVqZWN0aW9uKTsKICAgIHByb21pc2UuZmluYWxseSgoKSA9PiBjbGVhbnVwKCkpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICB9KS5maW5hbGx5KCgpID0+IHsKICAgIGNsZWFudXAgPSBub29wMjI7CiAgfSk7Cn0KdmFyIHJ1blRhc2sgPSBhc3luYyAodGFzazIsIGNsZWFuVXApID0+IHsKICB0cnkgewogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCk7CiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRhc2syKCk7CiAgICByZXR1cm4gewogICAgICBzdGF0dXM6ICJvayIsCiAgICAgIHZhbHVlCiAgICB9OwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gewogICAgICBzdGF0dXM6IGVycm9yIGluc3RhbmNlb2YgVGFza0Fib3J0RXJyb3IgPyAiY2FuY2VsbGVkIiA6ICJyZWplY3RlZCIsCiAgICAgIGVycm9yCiAgICB9OwogIH0gZmluYWxseSB7CiAgICBjbGVhblVwPy4oKTsKICB9Cn07CnZhciBjcmVhdGVQYXVzZSA9IChzaWduYWwpID0+IHsKICByZXR1cm4gKHByb21pc2UpID0+IHsKICAgIHJldHVybiBjYXRjaFJlamVjdGlvbihyYWNlV2l0aFNpZ25hbChzaWduYWwsIHByb21pc2UpLnRoZW4oKG91dHB1dCkgPT4gewogICAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSkpOwogIH07Cn07CnZhciBjcmVhdGVEZWxheSA9IChzaWduYWwpID0+IHsKICBjb25zdCBwYXVzZSA9IGNyZWF0ZVBhdXNlKHNpZ25hbCk7CiAgcmV0dXJuICh0aW1lb3V0TXMpID0+IHsKICAgIHJldHVybiBwYXVzZShuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0TXMpKSk7CiAgfTsKfTsKdmFyIHsKICBhc3NpZ24KfSA9IE9iamVjdDsKdmFyIElOVEVSTkFMX05JTF9UT0tFTiA9IHt9Owp2YXIgYWxtID0gImxpc3RlbmVyTWlkZGxld2FyZSI7CnZhciBjcmVhdGVGb3JrID0gKHBhcmVudEFib3J0U2lnbmFsLCBwYXJlbnRCbG9ja2luZ1Byb21pc2VzKSA9PiB7CiAgY29uc3QgbGlua0NvbnRyb2xsZXJzID0gKGNvbnRyb2xsZXIpID0+IGFkZEFib3J0U2lnbmFsTGlzdGVuZXIocGFyZW50QWJvcnRTaWduYWwsICgpID0+IGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgcGFyZW50QWJvcnRTaWduYWwucmVhc29uKSk7CiAgcmV0dXJuICh0YXNrRXhlY3V0b3IsIG9wdHMpID0+IHsKICAgIGFzc2VydEZ1bmN0aW9uKHRhc2tFeGVjdXRvciwgInRhc2tFeGVjdXRvciIpOwogICAgY29uc3QgY2hpbGRBYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBsaW5rQ29udHJvbGxlcnMoY2hpbGRBYm9ydENvbnRyb2xsZXIpOwogICAgY29uc3QgcmVzdWx0ID0gcnVuVGFzayhhc3luYyAoKSA9PiB7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHBhcmVudEFib3J0U2lnbmFsKTsKICAgICAgdmFsaWRhdGVBY3RpdmUoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgY29uc3QgcmVzdWx0MiA9IGF3YWl0IHRhc2tFeGVjdXRvcih7CiAgICAgICAgcGF1c2U6IGNyZWF0ZVBhdXNlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgZGVsYXk6IGNyZWF0ZURlbGF5KGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgc2lnbmFsOiBjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwKICAgICAgfSk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgIHJldHVybiByZXN1bHQyOwogICAgfSwgKCkgPT4gYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjaGlsZEFib3J0Q29udHJvbGxlciwgdGFza0NvbXBsZXRlZCkpOwogICAgaWYgKG9wdHM/LmF1dG9Kb2luKSB7CiAgICAgIHBhcmVudEJsb2NraW5nUHJvbWlzZXMucHVzaChyZXN1bHQuY2F0Y2gobm9vcDIyKSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICByZXN1bHQ6IGNyZWF0ZVBhdXNlKHBhcmVudEFib3J0U2lnbmFsKShyZXN1bHQpLAogICAgICBjYW5jZWwoKSB7CiAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjaGlsZEFib3J0Q29udHJvbGxlciwgdGFza0NhbmNlbGxlZCk7CiAgICAgIH0KICAgIH07CiAgfTsKfTsKdmFyIGNyZWF0ZVRha2VQYXR0ZXJuID0gKHN0YXJ0TGlzdGVuaW5nLCBzaWduYWwpID0+IHsKICBjb25zdCB0YWtlID0gYXN5bmMgKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gewogICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgIGxldCB1bnN1YnNjcmliZSA9ICgpID0+IHsKICAgIH07CiAgICBjb25zdCB0dXBsZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGxldCBzdG9wTGlzdGVuaW5nID0gc3RhcnRMaXN0ZW5pbmcoewogICAgICAgIHByZWRpY2F0ZSwKICAgICAgICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICAgICAgICBsaXN0ZW5lckFwaS51bnN1YnNjcmliZSgpOwogICAgICAgICAgcmVzb2x2ZShbYWN0aW9uLCBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBsaXN0ZW5lckFwaS5nZXRPcmlnaW5hbFN0YXRlKCldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB1bnN1YnNjcmliZSA9ICgpID0+IHsKICAgICAgICBzdG9wTGlzdGVuaW5nKCk7CiAgICAgICAgcmVqZWN0KCk7CiAgICAgIH07CiAgICB9KTsKICAgIGNvbnN0IHByb21pc2VzID0gW3R1cGxlUHJvbWlzZV07CiAgICBpZiAodGltZW91dCAhPSBudWxsKSB7CiAgICAgIHByb21pc2VzLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dCwgbnVsbCkpKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgUHJvbWlzZS5yYWNlKHByb21pc2VzKSk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9IGZpbmFsbHkgewogICAgICB1bnN1YnNjcmliZSgpOwogICAgfQogIH07CiAgcmV0dXJuIChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IGNhdGNoUmVqZWN0aW9uKHRha2UocHJlZGljYXRlLCB0aW1lb3V0KSk7Cn07CnZhciBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tID0gKG9wdGlvbnMpID0+IHsKICBsZXQgewogICAgdHlwZSwKICAgIGFjdGlvbkNyZWF0b3IsCiAgICBtYXRjaGVyLAogICAgcHJlZGljYXRlLAogICAgZWZmZWN0CiAgfSA9IG9wdGlvbnM7CiAgaWYgKHR5cGUpIHsKICAgIHByZWRpY2F0ZSA9IGNyZWF0ZUFjdGlvbih0eXBlKS5tYXRjaDsKICB9IGVsc2UgaWYgKGFjdGlvbkNyZWF0b3IpIHsKICAgIHR5cGUgPSBhY3Rpb25DcmVhdG9yLnR5cGU7CiAgICBwcmVkaWNhdGUgPSBhY3Rpb25DcmVhdG9yLm1hdGNoOwogIH0gZWxzZSBpZiAobWF0Y2hlcikgewogICAgcHJlZGljYXRlID0gbWF0Y2hlcjsKICB9IGVsc2UgaWYgKHByZWRpY2F0ZSkgewogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIxKSA6ICJDcmVhdGluZyBvciByZW1vdmluZyBhIGxpc3RlbmVyIHJlcXVpcmVzIG9uZSBvZiB0aGUga25vd24gZmllbGRzIGZvciBtYXRjaGluZyBhbiBhY3Rpb24iKTsKICB9CiAgYXNzZXJ0RnVuY3Rpb24oZWZmZWN0LCAib3B0aW9ucy5saXN0ZW5lciIpOwogIHJldHVybiB7CiAgICBwcmVkaWNhdGUsCiAgICB0eXBlLAogICAgZWZmZWN0CiAgfTsKfTsKdmFyIGNyZWF0ZUxpc3RlbmVyRW50cnkgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKChvcHRpb25zKSA9PiB7CiAgY29uc3QgewogICAgdHlwZSwKICAgIHByZWRpY2F0ZSwKICAgIGVmZmVjdAogIH0gPSBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tKG9wdGlvbnMpOwogIGNvbnN0IGVudHJ5ID0gewogICAgaWQ6IG5hbm9pZCgpLAogICAgZWZmZWN0LAogICAgdHlwZSwKICAgIHByZWRpY2F0ZSwKICAgIHBlbmRpbmc6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICB1bnN1YnNjcmliZTogKCkgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIyKSA6ICJVbnN1YnNjcmliZSBub3QgaW5pdGlhbGl6ZWQiKTsKICAgIH0KICB9OwogIHJldHVybiBlbnRyeTsKfSwgewogIHdpdGhUeXBlczogKCkgPT4gY3JlYXRlTGlzdGVuZXJFbnRyeQp9KTsKdmFyIGZpbmRMaXN0ZW5lckVudHJ5ID0gKGxpc3RlbmVyTWFwLCBvcHRpb25zKSA9PiB7CiAgY29uc3QgewogICAgdHlwZSwKICAgIGVmZmVjdCwKICAgIHByZWRpY2F0ZQogIH0gPSBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tKG9wdGlvbnMpOwogIHJldHVybiBBcnJheS5mcm9tKGxpc3RlbmVyTWFwLnZhbHVlcygpKS5maW5kKChlbnRyeSkgPT4gewogICAgY29uc3QgbWF0Y2hQcmVkaWNhdGVPclR5cGUgPSB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgPyBlbnRyeS50eXBlID09PSB0eXBlIDogZW50cnkucHJlZGljYXRlID09PSBwcmVkaWNhdGU7CiAgICByZXR1cm4gbWF0Y2hQcmVkaWNhdGVPclR5cGUgJiYgZW50cnkuZWZmZWN0ID09PSBlZmZlY3Q7CiAgfSk7Cn07CnZhciBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMgPSAoZW50cnkpID0+IHsKICBlbnRyeS5wZW5kaW5nLmZvckVhY2goKGNvbnRyb2xsZXIpID0+IHsKICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogIH0pOwp9Owp2YXIgY3JlYXRlQ2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUgPSAobGlzdGVuZXJNYXAsIGV4ZWN1dGluZ0xpc3RlbmVycykgPT4gewogIHJldHVybiAoKSA9PiB7CiAgICBmb3IgKGNvbnN0IGxpc3RlbmVyMiBvZiBleGVjdXRpbmdMaXN0ZW5lcnMua2V5cygpKSB7CiAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhsaXN0ZW5lcjIpOwogICAgfQogICAgbGlzdGVuZXJNYXAuY2xlYXIoKTsKICB9Owp9Owp2YXIgc2FmZWx5Tm90aWZ5RXJyb3IgPSAoZXJyb3JIYW5kbGVyLCBlcnJvclRvTm90aWZ5LCBlcnJvckluZm8pID0+IHsKICB0cnkgewogICAgZXJyb3JIYW5kbGVyKGVycm9yVG9Ob3RpZnksIGVycm9ySW5mbyk7CiAgfSBjYXRjaCAoZXJyb3JIYW5kbGVyRXJyb3IpIHsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aHJvdyBlcnJvckhhbmRsZXJFcnJvcjsKICAgIH0sIDApOwogIH0KfTsKdmFyIGFkZExpc3RlbmVyID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vYWRkYCksIHsKICB3aXRoVHlwZXM6ICgpID0+IGFkZExpc3RlbmVyCn0pOwp2YXIgY2xlYXJBbGxMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vcmVtb3ZlQWxsYCk7CnZhciByZW1vdmVMaXN0ZW5lciA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L3JlbW92ZWApLCB7CiAgd2l0aFR5cGVzOiAoKSA9PiByZW1vdmVMaXN0ZW5lcgp9KTsKdmFyIGRlZmF1bHRFcnJvckhhbmRsZXIgPSAoLi4uYXJncykgPT4gewogIGNvbnNvbGUuZXJyb3IoYCR7YWxtfS9lcnJvcmAsIC4uLmFyZ3MpOwp9Owp2YXIgY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlID0gKG1pZGRsZXdhcmVPcHRpb25zID0ge30pID0+IHsKICBjb25zdCBsaXN0ZW5lck1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgZXhlY3V0aW5nTGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCB0cmFja0V4ZWN1dGluZ0xpc3RlbmVyID0gKGVudHJ5KSA9PiB7CiAgICBjb25zdCBjb3VudCA9IGV4ZWN1dGluZ0xpc3RlbmVycy5nZXQoZW50cnkpID8/IDA7CiAgICBleGVjdXRpbmdMaXN0ZW5lcnMuc2V0KGVudHJ5LCBjb3VudCArIDEpOwogIH07CiAgY29uc3QgdW50cmFja0V4ZWN1dGluZ0xpc3RlbmVyID0gKGVudHJ5KSA9PiB7CiAgICBjb25zdCBjb3VudCA9IGV4ZWN1dGluZ0xpc3RlbmVycy5nZXQoZW50cnkpID8/IDE7CiAgICBpZiAoY291bnQgPT09IDEpIHsKICAgICAgZXhlY3V0aW5nTGlzdGVuZXJzLmRlbGV0ZShlbnRyeSk7CiAgICB9IGVsc2UgewogICAgICBleGVjdXRpbmdMaXN0ZW5lcnMuc2V0KGVudHJ5LCBjb3VudCAtIDEpOwogICAgfQogIH07CiAgY29uc3QgewogICAgZXh0cmEsCiAgICBvbkVycm9yID0gZGVmYXVsdEVycm9ySGFuZGxlcgogIH0gPSBtaWRkbGV3YXJlT3B0aW9uczsKICBhc3NlcnRGdW5jdGlvbihvbkVycm9yLCAib25FcnJvciIpOwogIGNvbnN0IGluc2VydEVudHJ5ID0gKGVudHJ5KSA9PiB7CiAgICBlbnRyeS51bnN1YnNjcmliZSA9ICgpID0+IGxpc3RlbmVyTWFwLmRlbGV0ZShlbnRyeS5pZCk7CiAgICBsaXN0ZW5lck1hcC5zZXQoZW50cnkuaWQsIGVudHJ5KTsKICAgIHJldHVybiAoY2FuY2VsT3B0aW9ucykgPT4gewogICAgICBlbnRyeS51bnN1YnNjcmliZSgpOwogICAgICBpZiAoY2FuY2VsT3B0aW9ucz8uY2FuY2VsQWN0aXZlKSB7CiAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGVudHJ5KTsKICAgICAgfQogICAgfTsKICB9OwogIGNvbnN0IHN0YXJ0TGlzdGVuaW5nID0gKG9wdGlvbnMpID0+IHsKICAgIGNvbnN0IGVudHJ5ID0gZmluZExpc3RlbmVyRW50cnkobGlzdGVuZXJNYXAsIG9wdGlvbnMpID8/IGNyZWF0ZUxpc3RlbmVyRW50cnkob3B0aW9ucyk7CiAgICByZXR1cm4gaW5zZXJ0RW50cnkoZW50cnkpOwogIH07CiAgYXNzaWduKHN0YXJ0TGlzdGVuaW5nLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IHN0YXJ0TGlzdGVuaW5nCiAgfSk7CiAgY29uc3Qgc3RvcExpc3RlbmluZyA9IChvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbnRyeSA9IGZpbmRMaXN0ZW5lckVudHJ5KGxpc3RlbmVyTWFwLCBvcHRpb25zKTsKICAgIGlmIChlbnRyeSkgewogICAgICBlbnRyeS51bnN1YnNjcmliZSgpOwogICAgICBpZiAob3B0aW9ucy5jYW5jZWxBY3RpdmUpIHsKICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMoZW50cnkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gISFlbnRyeTsKICB9OwogIGFzc2lnbihzdG9wTGlzdGVuaW5nLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IHN0b3BMaXN0ZW5pbmcKICB9KTsKICBjb25zdCBub3RpZnlMaXN0ZW5lciA9IGFzeW5jIChlbnRyeSwgYWN0aW9uLCBhcGksIGdldE9yaWdpbmFsU3RhdGUpID0+IHsKICAgIGNvbnN0IGludGVybmFsVGFza0NvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCB0YWtlID0gY3JlYXRlVGFrZVBhdHRlcm4oc3RhcnRMaXN0ZW5pbmcsIGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKTsKICAgIGNvbnN0IGF1dG9Kb2luUHJvbWlzZXMgPSBbXTsKICAgIHRyeSB7CiAgICAgIGVudHJ5LnBlbmRpbmcuYWRkKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgICB0cmFja0V4ZWN1dGluZ0xpc3RlbmVyKGVudHJ5KTsKICAgICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGVudHJ5LmVmZmVjdCgKICAgICAgICBhY3Rpb24sCiAgICAgICAgLy8gVXNlIGFzc2lnbigpIHJhdGhlciB0aGFuIC4uLiB0byBhdm9pZCBleHRyYSBoZWxwZXIgZnVuY3Rpb25zIGFkZGVkIHRvIGJ1bmRsZQogICAgICAgIGFzc2lnbih7fSwgYXBpLCB7CiAgICAgICAgICBnZXRPcmlnaW5hbFN0YXRlLAogICAgICAgICAgY29uZGl0aW9uOiAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiB0YWtlKHByZWRpY2F0ZSwgdGltZW91dCkudGhlbihCb29sZWFuKSwKICAgICAgICAgIHRha2UsCiAgICAgICAgICBkZWxheTogY3JlYXRlRGVsYXkoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpLAogICAgICAgICAgcGF1c2U6IGNyZWF0ZVBhdXNlKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICAgIGV4dHJhLAogICAgICAgICAgc2lnbmFsOiBpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCwKICAgICAgICAgIGZvcms6IGNyZWF0ZUZvcmsoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwsIGF1dG9Kb2luUHJvbWlzZXMpLAogICAgICAgICAgdW5zdWJzY3JpYmU6IGVudHJ5LnVuc3Vic2NyaWJlLAogICAgICAgICAgc3Vic2NyaWJlOiAoKSA9PiB7CiAgICAgICAgICAgIGxpc3RlbmVyTWFwLnNldChlbnRyeS5pZCwgZW50cnkpOwogICAgICAgICAgfSwKICAgICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVyczogKCkgPT4gewogICAgICAgICAgICBlbnRyeS5wZW5kaW5nLmZvckVhY2goKGNvbnRyb2xsZXIsIF8sIHNldDMpID0+IHsKICAgICAgICAgICAgICBpZiAoY29udHJvbGxlciAhPT0gaW50ZXJuYWxUYXNrQ29udHJvbGxlcikgewogICAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgICAgICAgICAgICAgICBzZXQzLmRlbGV0ZShjb250cm9sbGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGNhbmNlbDogKCkgPT4gewogICAgICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGludGVybmFsVGFza0NvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICAgICAgICAgICAgZW50cnkucGVuZGluZy5kZWxldGUoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICAgICAgICB9LAogICAgICAgICAgdGhyb3dJZkNhbmNlbGxlZDogKCkgPT4gewogICAgICAgICAgICB2YWxpZGF0ZUFjdGl2ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgKSk7CiAgICB9IGNhdGNoIChsaXN0ZW5lckVycm9yKSB7CiAgICAgIGlmICghKGxpc3RlbmVyRXJyb3IgaW5zdGFuY2VvZiBUYXNrQWJvcnRFcnJvcikpIHsKICAgICAgICBzYWZlbHlOb3RpZnlFcnJvcihvbkVycm9yLCBsaXN0ZW5lckVycm9yLCB7CiAgICAgICAgICByYWlzZWRCeTogImVmZmVjdCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXV0b0pvaW5Qcm9taXNlcyk7CiAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oaW50ZXJuYWxUYXNrQ29udHJvbGxlciwgbGlzdGVuZXJDb21wbGV0ZWQpOwogICAgICB1bnRyYWNrRXhlY3V0aW5nTGlzdGVuZXIoZW50cnkpOwogICAgICBlbnRyeS5wZW5kaW5nLmRlbGV0ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgIH0KICB9OwogIGNvbnN0IGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlID0gY3JlYXRlQ2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUobGlzdGVuZXJNYXAsIGV4ZWN1dGluZ0xpc3RlbmVycyk7CiAgY29uc3QgbWlkZGxld2FyZSA9IChhcGkpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICBpZiAoIWlzQWN0aW9uKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICAgIH0KICAgIGlmIChhZGRMaXN0ZW5lci5tYXRjaChhY3Rpb24pKSB7CiAgICAgIHJldHVybiBzdGFydExpc3RlbmluZyhhY3Rpb24ucGF5bG9hZCk7CiAgICB9CiAgICBpZiAoY2xlYXJBbGxMaXN0ZW5lcnMubWF0Y2goYWN0aW9uKSkgewogICAgICBjbGVhckxpc3RlbmVyTWlkZGxld2FyZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocmVtb3ZlTGlzdGVuZXIubWF0Y2goYWN0aW9uKSkgewogICAgICByZXR1cm4gc3RvcExpc3RlbmluZyhhY3Rpb24ucGF5bG9hZCk7CiAgICB9CiAgICBsZXQgb3JpZ2luYWxTdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpOwogICAgY29uc3QgZ2V0T3JpZ2luYWxTdGF0ZSA9ICgpID0+IHsKICAgICAgaWYgKG9yaWdpbmFsU3RhdGUgPT09IElOVEVSTkFMX05JTF9UT0tFTikgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjMpIDogYCR7YWxtfTogZ2V0T3JpZ2luYWxTdGF0ZSBjYW4gb25seSBiZSBjYWxsZWQgc3luY2hyb25vdXNseWApOwogICAgICB9CiAgICAgIHJldHVybiBvcmlnaW5hbFN0YXRlOwogICAgfTsKICAgIGxldCByZXN1bHQ7CiAgICB0cnkgewogICAgICByZXN1bHQgPSBuZXh0KGFjdGlvbik7CiAgICAgIGlmIChsaXN0ZW5lck1hcC5zaXplID4gMCkgewogICAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpOwogICAgICAgIGNvbnN0IGxpc3RlbmVyRW50cmllcyA9IEFycmF5LmZyb20obGlzdGVuZXJNYXAudmFsdWVzKCkpOwogICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgbGlzdGVuZXJFbnRyaWVzKSB7CiAgICAgICAgICBsZXQgcnVuTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJ1bkxpc3RlbmVyID0gZW50cnkucHJlZGljYXRlKGFjdGlvbiwgY3VycmVudFN0YXRlLCBvcmlnaW5hbFN0YXRlKTsKICAgICAgICAgIH0gY2F0Y2ggKHByZWRpY2F0ZUVycm9yKSB7CiAgICAgICAgICAgIHJ1bkxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICAgIHNhZmVseU5vdGlmeUVycm9yKG9uRXJyb3IsIHByZWRpY2F0ZUVycm9yLCB7CiAgICAgICAgICAgICAgcmFpc2VkQnk6ICJwcmVkaWNhdGUiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFydW5MaXN0ZW5lcikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vdGlmeUxpc3RlbmVyKGVudHJ5LCBhY3Rpb24sIGFwaSwgZ2V0T3JpZ2luYWxTdGF0ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBvcmlnaW5hbFN0YXRlID0gSU5URVJOQUxfTklMX1RPS0VOOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIHJldHVybiB7CiAgICBtaWRkbGV3YXJlLAogICAgc3RhcnRMaXN0ZW5pbmcsCiAgICBzdG9wTGlzdGVuaW5nLAogICAgY2xlYXJMaXN0ZW5lcnM6IGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlCiAgfTsKfTsKdmFyIE9SSUdJTkFMX1NUQVRFID0gU3ltYm9sLmZvcigicnRrLXN0YXRlLXByb3h5LW9yaWdpbmFsIik7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xheW91dFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUgPSB7CiAgbGF5b3V0VHlwZTogImhvcml6b250YWwiLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBtYXJnaW46IHsKICAgIHRvcDogNSwKICAgIHJpZ2h0OiA1LAogICAgYm90dG9tOiA1LAogICAgbGVmdDogNQogIH0sCiAgc2NhbGU6IDEKfTsKdmFyIGNoYXJ0TGF5b3V0U2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNoYXJ0TGF5b3V0IiwKICBpbml0aWFsU3RhdGUsCiAgcmVkdWNlcnM6IHsKICAgIHNldExheW91dChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmxheW91dFR5cGUgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRDaGFydFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS53aWR0aCA9IGFjdGlvbi5wYXlsb2FkLndpZHRoOwogICAgICBzdGF0ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TWFyZ2luKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCR0b3AsIF9hY3Rpb24kcGF5bG9hZCRyaWdodCwgX2FjdGlvbiRwYXlsb2FkJGJvdHRvLCBfYWN0aW9uJHBheWxvYWQkbGVmdDsKICAgICAgc3RhdGUubWFyZ2luLnRvcCA9IChfYWN0aW9uJHBheWxvYWQkdG9wID0gYWN0aW9uLnBheWxvYWQudG9wKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkdG9wICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkdG9wIDogMDsKICAgICAgc3RhdGUubWFyZ2luLnJpZ2h0ID0gKF9hY3Rpb24kcGF5bG9hZCRyaWdodCA9IGFjdGlvbi5wYXlsb2FkLnJpZ2h0KSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkcmlnaHQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRyaWdodCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5ib3R0b20gPSAoX2FjdGlvbiRwYXlsb2FkJGJvdHRvID0gYWN0aW9uLnBheWxvYWQuYm90dG9tKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkYm90dG8gIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRib3R0byA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5sZWZ0ID0gKF9hY3Rpb24kcGF5bG9hZCRsZWZ0ID0gYWN0aW9uLnBheWxvYWQubGVmdCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGxlZnQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRsZWZ0IDogMDsKICAgIH0sCiAgICBzZXRTY2FsZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNjYWxlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRNYXJnaW4sCiAgc2V0TGF5b3V0LAogIHNldENoYXJ0U2l6ZSwKICBzZXRTY2FsZQp9ID0gY2hhcnRMYXlvdXRTbGljZS5hY3Rpb25zOwp2YXIgY2hhcnRMYXlvdXRSZWR1Y2VyID0gY2hhcnRMYXlvdXRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NoYXJ0VXRpbHMuanMKdmFyIGltcG9ydF9zb3J0QnkyID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CnZhciBpbXBvcnRfZ2V0MiA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldFNsaWNlZC5qcwpmdW5jdGlvbiBnZXRTbGljZWQoYXJyLCBzdGFydEluZGV4LCBlbmRJbmRleCkgewogIGlmICghQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyOwogIH0KICBpZiAoYXJyICYmIHN0YXJ0SW5kZXggKyBlbmRJbmRleCAhPT0gMCkgewogICAgcmV0dXJuIGFyci5zbGljZShzdGFydEluZGV4LCBlbmRJbmRleCArIDEpOwogIH0KICByZXR1cm4gYXJyOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2hhcnRVdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRWYWx1ZUJ5RGF0YUtleShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSkgewogIGlmIChpc051bGxpc2gob2JqKSB8fCBpc051bGxpc2goZGF0YUtleSkpIHsKICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgfQogIGlmIChpc051bU9yU3RyKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9nZXQyLmRlZmF1bHQpKG9iaiwgZGF0YUtleSwgZGVmYXVsdFZhbHVlKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZGF0YUtleShvYmopOwogIH0KICByZXR1cm4gZGVmYXVsdFZhbHVlOwp9CnZhciBhcHBlbmRPZmZzZXRPZkxlZ2VuZCA9IChvZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKSA9PiB7CiAgaWYgKGxlZ2VuZFNldHRpbmdzICYmIGxlZ2VuZFNpemUpIHsKICAgIHZhciB7CiAgICAgIHdpZHRoOiBib3hXaWR0aCwKICAgICAgaGVpZ2h0OiBib3hIZWlnaHQKICAgIH0gPSBsZWdlbmRTaXplOwogICAgdmFyIHsKICAgICAgYWxpZ24sCiAgICAgIHZlcnRpY2FsQWxpZ24sCiAgICAgIGxheW91dAogICAgfSA9IGxlZ2VuZFNldHRpbmdzOwogICAgaWYgKChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgfHwgbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgdmVydGljYWxBbGlnbiA9PT0gIm1pZGRsZSIpICYmIGFsaWduICE9PSAiY2VudGVyIiAmJiBpc051bWJlcihvZmZzZXRbYWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW2FsaWduXTogb2Zmc2V0W2FsaWduXSArIChib3hXaWR0aCB8fCAwKQogICAgICB9KTsKICAgIH0KICAgIGlmICgobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGFsaWduID09PSAiY2VudGVyIikgJiYgdmVydGljYWxBbGlnbiAhPT0gIm1pZGRsZSIgJiYgaXNOdW1iZXIob2Zmc2V0W3ZlcnRpY2FsQWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW3ZlcnRpY2FsQWxpZ25dOiBvZmZzZXRbdmVydGljYWxBbGlnbl0gKyAoYm94SGVpZ2h0IHx8IDApCiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gb2Zmc2V0Owp9Owp2YXIgaXNDYXRlZ29yaWNhbEF4aXMgPSAobGF5b3V0LCBheGlzVHlwZSkgPT4gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgYXhpc1R5cGUgPT09ICJ4QXhpcyIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiIHx8IGxheW91dCA9PT0gImNlbnRyaWMiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiB8fCBsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyI7CnZhciBnZXRDb29yZGluYXRlc09mR3JpZCA9ICh0aWNrczIsIG1pblZhbHVlLCBtYXhWYWx1ZSwgc3luY1dpdGhUaWNrcykgPT4gewogIGlmIChzeW5jV2l0aFRpY2tzKSB7CiAgICByZXR1cm4gdGlja3MyLm1hcCgoZW50cnkpID0+IGVudHJ5LmNvb3JkaW5hdGUpOwogIH0KICB2YXIgaGFzTWluLCBoYXNNYXg7CiAgdmFyIHZhbHVlcyA9IHRpY2tzMi5tYXAoKGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWluVmFsdWUpIHsKICAgICAgaGFzTWluID0gdHJ1ZTsKICAgIH0KICAgIGlmIChlbnRyeS5jb29yZGluYXRlID09PSBtYXhWYWx1ZSkgewogICAgICBoYXNNYXggPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGVudHJ5LmNvb3JkaW5hdGU7CiAgfSk7CiAgaWYgKCFoYXNNaW4pIHsKICAgIHZhbHVlcy5wdXNoKG1pblZhbHVlKTsKICB9CiAgaWYgKCFoYXNNYXgpIHsKICAgIHZhbHVlcy5wdXNoKG1heFZhbHVlKTsKICB9CiAgcmV0dXJuIHZhbHVlczsKfTsKdmFyIGdldFRpY2tzT2ZBeGlzID0gKGF4aXMsIGlzR3JpZCwgaXNBbGwpID0+IHsKICBpZiAoIWF4aXMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZHVwbGljYXRlRG9tYWluLAogICAgdHlwZSwKICAgIHJhbmdlOiByYW5nZTQsCiAgICBzY2FsZSwKICAgIHJlYWxTY2FsZVR5cGUsCiAgICBpc0NhdGVnb3JpY2FsLAogICAgY2F0ZWdvcmljYWxEb21haW4sCiAgICB0aWNrQ291bnQsCiAgICB0aWNrczogdGlja3MyLAogICAgbmljZVRpY2tzLAogICAgYXhpc1R5cGUKICB9ID0gYXhpczsKICBpZiAoIXNjYWxlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSAoaXNHcmlkIHx8IGlzQWxsKSAmJiB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAmJiByYW5nZTQubGVuZ3RoID49IDIgPyBtYXRoU2lnbihyYW5nZTRbMF0gLSByYW5nZTRbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICBpZiAoaXNHcmlkICYmICh0aWNrczIgfHwgbmljZVRpY2tzKSkgewogICAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgbmljZVRpY2tzIHx8IFtdKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQsCiAgICAgICAgaW5kZXgKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gIWlzTmFuKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIGlmIChzY2FsZS50aWNrcyAmJiAhaXNBbGwgJiYgdGlja0NvdW50ICE9IG51bGwpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0LAogICAgICBpbmRleAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBFUFMyID0gMWUtNDsKdmFyIGNoZWNrRG9tYWluT2ZTY2FsZSA9IChzY2FsZSkgPT4gewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW4oKTsKICBpZiAoIWRvbWFpbiB8fCBkb21haW4ubGVuZ3RoIDw9IDIpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGxlbiA9IGRvbWFpbi5sZW5ndGg7CiAgdmFyIHJhbmdlNCA9IHNjYWxlLnJhbmdlKCk7CiAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4ocmFuZ2U0WzBdLCByYW5nZTRbMV0pIC0gRVBTMjsKICB2YXIgbWF4VmFsdWUgPSBNYXRoLm1heChyYW5nZTRbMF0sIHJhbmdlNFsxXSkgKyBFUFMyOwogIHZhciBmaXJzdCA9IHNjYWxlKGRvbWFpblswXSk7CiAgdmFyIGxhc3QyID0gc2NhbGUoZG9tYWluW2xlbiAtIDFdKTsKICBpZiAoZmlyc3QgPCBtaW5WYWx1ZSB8fCBmaXJzdCA+IG1heFZhbHVlIHx8IGxhc3QyIDwgbWluVmFsdWUgfHwgbGFzdDIgPiBtYXhWYWx1ZSkgewogICAgc2NhbGUuZG9tYWluKFtkb21haW5bMF0sIGRvbWFpbltsZW4gLSAxXV0pOwogIH0KfTsKdmFyIG9mZnNldFNpZ24gPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgdmFyIG5lZ2F0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBuZWdhdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBuZWdhdGl2ZSArIHZhbHVlOwogICAgICAgIG5lZ2F0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgb2Zmc2V0UG9zaXRpdmUgPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHZhbHVlID0gaXNOYW4oc2VyaWVzW2ldW2pdWzFdKSA/IHNlcmllc1tpXVtqXVswXSA6IHNlcmllc1tpXVtqXVsxXTsKICAgICAgaWYgKHZhbHVlID49IDApIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBwb3NpdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBwb3NpdGl2ZSArIHZhbHVlOwogICAgICAgIHBvc2l0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9IGVsc2UgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IDA7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gMDsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIFNUQUNLX09GRlNFVF9NQVAgPSB7CiAgc2lnbjogb2Zmc2V0U2lnbiwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgZXhwYW5kOiBleHBhbmRfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgbm9uZTogbm9uZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICBzaWxob3VldHRlOiBzaWxob3VldHRlX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIHdpZ2dsZTogd2lnZ2xlX2RlZmF1bHQsCiAgcG9zaXRpdmU6IG9mZnNldFBvc2l0aXZlCn07CnZhciBnZXRTdGFja2VkRGF0YSA9IChkYXRhLCBkYXRhS2V5cywgb2Zmc2V0VHlwZSkgPT4gewogIHZhciBvZmZzZXRBY2Nlc3NvciA9IFNUQUNLX09GRlNFVF9NQVBbb2Zmc2V0VHlwZV07CiAgdmFyIHN0YWNrID0gc3RhY2tfZGVmYXVsdCgpLmtleXMoZGF0YUtleXMpLnZhbHVlKChkLCBrZXkpID0+IE51bWJlcihnZXRWYWx1ZUJ5RGF0YUtleShkLCBrZXksIDApKSkub3JkZXIobm9uZV9kZWZhdWx0Mikub2Zmc2V0KG9mZnNldEFjY2Vzc29yKTsKICByZXR1cm4gc3RhY2soZGF0YSk7Cn07CmZ1bmN0aW9uIGdldE5vcm1hbGl6ZWRTdGFja0lkKHB1YmxpY1N0YWNrSWQpIHsKICByZXR1cm4gcHVibGljU3RhY2tJZCA9PSBudWxsID8gdm9pZCAwIDogU3RyaW5nKHB1YmxpY1N0YWNrSWQpOwp9CmZ1bmN0aW9uIGdldENhdGVDb29yZGluYXRlT2ZMaW5lKF9yZWYyKSB7CiAgdmFyIHsKICAgIGF4aXMsCiAgICB0aWNrczogdGlja3MyLAogICAgYmFuZFNpemUsCiAgICBlbnRyeSwKICAgIGluZGV4LAogICAgZGF0YUtleQogIH0gPSBfcmVmMjsKICBpZiAoYXhpcy50eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICBpZiAoIWF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgYXhpcy5kYXRhS2V5ICYmICFpc051bGxpc2goZW50cnlbYXhpcy5kYXRhS2V5XSkpIHsKICAgICAgdmFyIG1hdGNoZWRUaWNrID0gZmluZEVudHJ5SW5BcnJheSh0aWNrczIsICJ2YWx1ZSIsIGVudHJ5W2F4aXMuZGF0YUtleV0pOwogICAgICBpZiAobWF0Y2hlZFRpY2spIHsKICAgICAgICByZXR1cm4gbWF0Y2hlZFRpY2suY29vcmRpbmF0ZSArIGJhbmRTaXplIC8gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRpY2tzMltpbmRleF0gPyB0aWNrczJbaW5kZXhdLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDIgOiBudWxsOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgIWlzTnVsbGlzaChkYXRhS2V5KSA/IGRhdGFLZXkgOiBheGlzLmRhdGFLZXkpOwogIHJldHVybiAhaXNOdWxsaXNoKHZhbHVlKSA/IGF4aXMuc2NhbGUodmFsdWUpIDogbnVsbDsKfQp2YXIgZ2V0RG9tYWluT2ZTaW5nbGUgPSAoZGF0YSkgPT4gewogIHZhciBmbGF0ID0gZGF0YS5mbGF0KDIpLmZpbHRlcihpc051bWJlcik7CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5mbGF0KSwgTWF0aC5tYXgoLi4uZmxhdCldOwp9Owp2YXIgbWFrZURvbWFpbkZpbml0ZSA9IChkb21haW4pID0+IHsKICByZXR1cm4gW2RvbWFpblswXSA9PT0gSW5maW5pdHkgPyAwIDogZG9tYWluWzBdLCBkb21haW5bMV0gPT09IC1JbmZpbml0eSA/IDAgOiBkb21haW5bMV1dOwp9Owp2YXIgZ2V0RG9tYWluT2ZTdGFja0dyb3VwcyA9IChzdGFja0dyb3Vwcywgc3RhcnRJbmRleCwgZW5kSW5kZXgpID0+IHsKICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG1ha2VEb21haW5GaW5pdGUoT2JqZWN0LmtleXMoc3RhY2tHcm91cHMpLnJlZHVjZSgocmVzdWx0LCBzdGFja0lkKSA9PiB7CiAgICB2YXIgZ3JvdXAgPSBzdGFja0dyb3Vwc1tzdGFja0lkXTsKICAgIHZhciB7CiAgICAgIHN0YWNrZWREYXRhCiAgICB9ID0gZ3JvdXA7CiAgICB2YXIgZG9tYWluID0gc3RhY2tlZERhdGEucmVkdWNlKChyZXMsIGVudHJ5KSA9PiB7CiAgICAgIHZhciBzbGljZWQgPSBnZXRTbGljZWQoZW50cnksIHN0YXJ0SW5kZXgsIGVuZEluZGV4KTsKICAgICAgdmFyIHMgPSBnZXREb21haW5PZlNpbmdsZShzbGljZWQpOwogICAgICByZXR1cm4gW01hdGgubWluKHJlc1swXSwgc1swXSksIE1hdGgubWF4KHJlc1sxXSwgc1sxXSldOwogICAgfSwgW0luZmluaXR5LCAtSW5maW5pdHldKTsKICAgIHJldHVybiBbTWF0aC5taW4oZG9tYWluWzBdLCByZXN1bHRbMF0pLCBNYXRoLm1heChkb21haW5bMV0sIHJlc3VsdFsxXSldOwogIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSkpOwp9Owp2YXIgTUlOX1ZBTFVFX1JFRyA9IC9eZGF0YU1pbltcc10qLVtcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBNQVhfVkFMVUVfUkVHID0gL15kYXRhTWF4W1xzXSpcK1tcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBnZXRCYW5kU2l6ZU9mQXhpcyA9IChheGlzLCB0aWNrczIsIGlzQmFyKSA9PiB7CiAgaWYgKGF4aXMgJiYgYXhpcy5zY2FsZSAmJiBheGlzLnNjYWxlLmJhbmR3aWR0aCkgewogICAgdmFyIGJhbmRXaWR0aCA9IGF4aXMuc2NhbGUuYmFuZHdpZHRoKCk7CiAgICBpZiAoIWlzQmFyIHx8IGJhbmRXaWR0aCA+IDApIHsKICAgICAgcmV0dXJuIGJhbmRXaWR0aDsKICAgIH0KICB9CiAgaWYgKGF4aXMgJiYgdGlja3MyICYmIHRpY2tzMi5sZW5ndGggPj0gMikgewogICAgdmFyIG9yZGVyZWRUaWNrcyA9ICgwLCBpbXBvcnRfc29ydEJ5Mi5kZWZhdWx0KSh0aWNrczIsIChvKSA9PiBvLmNvb3JkaW5hdGUpOwogICAgdmFyIGJhbmRTaXplID0gSW5maW5pdHk7CiAgICBmb3IgKHZhciBpID0gMSwgbGVuID0gb3JkZXJlZFRpY2tzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBjdXIgPSBvcmRlcmVkVGlja3NbaV07CiAgICAgIHZhciBwcmV2ID0gb3JkZXJlZFRpY2tzW2kgLSAxXTsKICAgICAgYmFuZFNpemUgPSBNYXRoLm1pbigoY3VyLmNvb3JkaW5hdGUgfHwgMCkgLSAocHJldi5jb29yZGluYXRlIHx8IDApLCBiYW5kU2l6ZSk7CiAgICB9CiAgICByZXR1cm4gYmFuZFNpemUgPT09IEluZmluaXR5ID8gMCA6IGJhbmRTaXplOwogIH0KICByZXR1cm4gaXNCYXIgPyB2b2lkIDAgOiAwOwp9OwpmdW5jdGlvbiBnZXRUb29sdGlwRW50cnkoX3JlZjQpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0gPSBfcmVmNDsKICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIHRvb2x0aXBFbnRyeVNldHRpbmdzKSwge30sIHsKICAgIGRhdGFLZXksCiAgICBwYXlsb2FkLAogICAgdmFsdWUsCiAgICBuYW1lCiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWVGcm9tSXRlbSwgZGF0YUtleSkgewogIGlmIChuYW1lRnJvbUl0ZW0pIHsKICAgIHJldHVybiBTdHJpbmcobmFtZUZyb21JdGVtKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRhdGFLZXk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KdmFyIGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MgPSAoY29vcmRpbmF0ZSwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFg7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBjb29yZGluYXRlLmNoYXJ0WTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIGNhbGN1bGF0ZVBvbGFyVG9vbHRpcFBvcyA9IChyYW5nZU9iaiwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICByZXR1cm4gcmFuZ2VPYmouYW5nbGU7CiAgfQogIHJldHVybiByYW5nZU9iai5yYWRpdXM7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb250YWluZXJTZWxlY3RvcnMuanMKdmFyIHNlbGVjdENoYXJ0V2lkdGggPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC53aWR0aDsKdmFyIHNlbGVjdENoYXJ0SGVpZ2h0ID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQuaGVpZ2h0Owp2YXIgc2VsZWN0Q29udGFpbmVyU2NhbGUgPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5zY2FsZTsKdmFyIHNlbGVjdE1hcmdpbiA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0Lm1hcmdpbjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdEFsbEF4ZXMuanMKdmFyIHNlbGVjdEFsbFhBeGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnhBeGlzLCAoeEF4aXNNYXApID0+IHsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyh4QXhpc01hcCk7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLmNhcnRlc2lhbkF4aXMueUF4aXMsICh5QXhpc01hcCkgPT4gewogIHJldHVybiBPYmplY3QudmFsdWVzKHlBeGlzTWFwKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ29uc3RhbnRzLmpzCnZhciBEQVRBX0lURU1fSU5ERVhfQVRUUklCVVRFX05BTUUgPSAiZGF0YS1yZWNoYXJ0cy1pdGVtLWluZGV4IjsKdmFyIERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1kYXRhLWtleSI7CnZhciBERUZBVUxUX1lfQVhJU19XSURUSCA9IDYwOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbC5qcwpmdW5jdGlvbiBvd25LZXlzMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgc2VsZWN0QnJ1c2hIZWlnaHQgPSAoc3RhdGUpID0+IHN0YXRlLmJydXNoLmhlaWdodDsKZnVuY3Rpb24gc2VsZWN0TGVmdEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeUF4ZXMgPSBzZWxlY3RBbGxZQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHlBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICB2YXIgd2lkdGggPSB0eXBlb2YgZW50cnkud2lkdGggPT09ICJudW1iZXIiID8gZW50cnkud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICAgICAgcmV0dXJuIHJlc3VsdCArIHdpZHRoOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQpmdW5jdGlvbiBzZWxlY3RSaWdodEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeUF4ZXMgPSBzZWxlY3RBbGxZQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHlBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAicmlnaHQiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgdmFyIHdpZHRoID0gdHlwZW9mIGVudHJ5LndpZHRoID09PSAibnVtYmVyIiA/IGVudHJ5LndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgICAgIHJldHVybiByZXN1bHQgKyB3aWR0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0VG9wQXhlc09mZnNldChzdGF0ZSkgewogIHZhciB4QXhlcyA9IHNlbGVjdEFsbFhBeGVzKHN0YXRlKTsKICByZXR1cm4geEF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJ0b3AiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgcmV0dXJuIHJlc3VsdCArIGVudHJ5LmhlaWdodDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0Qm90dG9tQXhlc09mZnNldChzdGF0ZSkgewogIHZhciB4QXhlcyA9IHNlbGVjdEFsbFhBeGVzKHN0YXRlKTsKICByZXR1cm4geEF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJib3R0b20iICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgcmV0dXJuIHJlc3VsdCArIGVudHJ5LmhlaWdodDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KdmFyIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdE1hcmdpbiwgc2VsZWN0QnJ1c2hIZWlnaHQsIHNlbGVjdExlZnRBeGVzT2Zmc2V0LCBzZWxlY3RSaWdodEF4ZXNPZmZzZXQsIHNlbGVjdFRvcEF4ZXNPZmZzZXQsIHNlbGVjdEJvdHRvbUF4ZXNPZmZzZXQsIHNlbGVjdExlZ2VuZFNldHRpbmdzLCBzZWxlY3RMZWdlbmRTaXplXSwgKGNoYXJ0V2lkdGgsIGNoYXJ0SGVpZ2h0LCBtYXJnaW4sIGJydXNoSGVpZ2h0LCBsZWZ0QXhlc09mZnNldCwgcmlnaHRBeGVzT2Zmc2V0LCB0b3BBeGVzT2Zmc2V0LCBib3R0b21BeGVzT2Zmc2V0LCBsZWdlbmRTZXR0aW5ncywgbGVnZW5kU2l6ZSkgPT4gewogIHZhciBvZmZzZXRIID0gewogICAgbGVmdDogKG1hcmdpbi5sZWZ0IHx8IDApICsgbGVmdEF4ZXNPZmZzZXQsCiAgICByaWdodDogKG1hcmdpbi5yaWdodCB8fCAwKSArIHJpZ2h0QXhlc09mZnNldAogIH07CiAgdmFyIG9mZnNldFYgPSB7CiAgICB0b3A6IChtYXJnaW4udG9wIHx8IDApICsgdG9wQXhlc09mZnNldCwKICAgIGJvdHRvbTogKG1hcmdpbi5ib3R0b20gfHwgMCkgKyBib3R0b21BeGVzT2Zmc2V0CiAgfTsKICB2YXIgb2Zmc2V0ID0gX29iamVjdFNwcmVhZDMoX29iamVjdFNwcmVhZDMoe30sIG9mZnNldFYpLCBvZmZzZXRIKTsKICB2YXIgYnJ1c2hCb3R0b20gPSBvZmZzZXQuYm90dG9tOwogIG9mZnNldC5ib3R0b20gKz0gYnJ1c2hIZWlnaHQ7CiAgb2Zmc2V0ID0gYXBwZW5kT2Zmc2V0T2ZMZWdlbmQob2Zmc2V0LCBsZWdlbmRTZXR0aW5ncywgbGVnZW5kU2l6ZSk7CiAgdmFyIG9mZnNldFdpZHRoID0gY2hhcnRXaWR0aCAtIG9mZnNldC5sZWZ0IC0gb2Zmc2V0LnJpZ2h0OwogIHZhciBvZmZzZXRIZWlnaHQgPSBjaGFydEhlaWdodCAtIG9mZnNldC50b3AgLSBvZmZzZXQuYm90dG9tOwogIHJldHVybiBfb2JqZWN0U3ByZWFkMyhfb2JqZWN0U3ByZWFkMyh7CiAgICBicnVzaEJvdHRvbQogIH0sIG9mZnNldCksIHt9LCB7CiAgICAvLyBuZXZlciByZXR1cm4gbmVnYXRpdmUgdmFsdWVzIGZvciBoZWlnaHQgYW5kIHdpZHRoCiAgICB3aWR0aDogTWF0aC5tYXgob2Zmc2V0V2lkdGgsIDApLAogICAgaGVpZ2h0OiBNYXRoLm1heChvZmZzZXRIZWlnaHQsIDApCiAgfSk7Cn0pOwp2YXIgc2VsZWN0Q2hhcnRWaWV3Qm94ID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgKG9mZnNldCkgPT4gKHsKICB4OiBvZmZzZXQubGVmdCwKICB5OiBvZmZzZXQudG9wLAogIHdpZHRoOiBvZmZzZXQud2lkdGgsCiAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0Cn0pKTsKdmFyIHNlbGVjdEF4aXNWaWV3Qm94ID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsICh3aWR0aCwgaGVpZ2h0KSA9PiAoewogIHg6IDAsCiAgeTogMCwKICB3aWR0aCwKICBoZWlnaHQKfSkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1Bhbm9yYW1hQ29udGV4dC5qcwp2YXIgUmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBQYW5vcmFtYUNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDExLmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlSXNQYW5vcmFtYSA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QxMS51c2VDb250ZXh0KShQYW5vcmFtYUNvbnRleHQpICE9IG51bGw7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9icnVzaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QnJ1c2hTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUuYnJ1c2g7CnZhciBzZWxlY3RCcnVzaERpbWVuc2lvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QnJ1c2hTZXR0aW5ncywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0TWFyZ2luXSwgKGJydXNoU2V0dGluZ3MsIG9mZnNldCwgbWFyZ2luKSA9PiAoewogIGhlaWdodDogYnJ1c2hTZXR0aW5ncy5oZWlnaHQsCiAgeDogaXNOdW1iZXIoYnJ1c2hTZXR0aW5ncy54KSA/IGJydXNoU2V0dGluZ3MueCA6IG9mZnNldC5sZWZ0LAogIHk6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueSkgPyBicnVzaFNldHRpbmdzLnkgOiBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCArIG9mZnNldC5icnVzaEJvdHRvbSAtICgobWFyZ2luID09PSBudWxsIHx8IG1hcmdpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogbWFyZ2luLmJvdHRvbSkgfHwgMCksCiAgd2lkdGg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3Mud2lkdGgpID8gYnJ1c2hTZXR0aW5ncy53aWR0aCA6IG9mZnNldC53aWR0aAp9KSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9SZXNwb25zaXZlQ29udGFpbmVyLmpzCnZhciBSZWFjdDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF90aHJvdHRsZSA9IF9fdG9FU00ocmVxdWlyZV90aHJvdHRsZTIoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvTG9nVXRpbHMuanMKdmFyIGlzRGV2ID0gdHJ1ZTsKdmFyIHdhcm4gPSBmdW5jdGlvbiB3YXJuMihjb25kaXRpb24sIGZvcm1hdDIpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMiA/IF9sZW4gLSAyIDogMCksIF9rZXkgPSAyOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBhcmdzW19rZXkgLSAyXSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgaWYgKGlzRGV2ICYmIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLndhcm4pIHsKICAgIGlmIChmb3JtYXQyID09PSB2b2lkIDApIHsKICAgICAgY29uc29sZS53YXJuKCJMb2dVdGlscyByZXF1aXJlcyBhbiBlcnJvciBtZXNzYWdlIGFyZ3VtZW50Iik7CiAgICB9CiAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICBpZiAoZm9ybWF0MiA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJNaW5pZmllZCBleGNlcHRpb24gb2NjdXJyZWQ7IHVzZSB0aGUgbm9uLW1pbmlmaWVkIGRldiBlbnZpcm9ubWVudCBmb3IgdGhlIGZ1bGwgZXJyb3IgbWVzc2FnZSBhbmQgYWRkaXRpb25hbCBoZWxwZnVsIHdhcm5pbmdzLiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBhcmdJbmRleCA9IDA7CiAgICAgICAgY29uc29sZS53YXJuKGZvcm1hdDIucmVwbGFjZSgvJXMvZywgKCkgPT4gYXJnc1thcmdJbmRleCsrXSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvcmVzcG9uc2l2ZUNvbnRhaW5lclV0aWxzLmpzCnZhciBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnMgPSAoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCwgcHJvcHMpID0+IHsKICB2YXIgewogICAgd2lkdGggPSAiMTAwJSIsCiAgICBoZWlnaHQgPSAiMTAwJSIsCiAgICBhc3BlY3QsCiAgICBtYXhIZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IGlzUGVyY2VudCh3aWR0aCkgPyBjb250YWluZXJXaWR0aCA6IE51bWJlcih3aWR0aCk7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBpc1BlcmNlbnQoaGVpZ2h0KSA/IGNvbnRhaW5lckhlaWdodCA6IE51bWJlcihoZWlnaHQpOwogIGlmIChhc3BlY3QgJiYgYXNwZWN0ID4gMCkgewogICAgaWYgKGNhbGN1bGF0ZWRXaWR0aCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gY2FsY3VsYXRlZFdpZHRoIC8gYXNwZWN0OwogICAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRXaWR0aCA9IGNhbGN1bGF0ZWRIZWlnaHQgKiBhc3BlY3Q7CiAgICB9CiAgICBpZiAobWF4SGVpZ2h0ICYmIGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gbWF4SGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBtYXhIZWlnaHQ7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfTsKfTsKdmFyIGJvdGhPdmVyZmxvdyA9IHsKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgb3ZlcmZsb3c6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dYID0gewogIHdpZHRoOiAwLAogIG92ZXJmbG93WDogInZpc2libGUiCn07CnZhciBvdmVyZmxvd1kgPSB7CiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93WTogInZpc2libGUiCn07CnZhciBub1N0eWxlID0ge307CnZhciBnZXRJbm5lckRpdlN0eWxlID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBpc1dpZHRoUGVyY2VudCA9IGlzUGVyY2VudCh3aWR0aCk7CiAgdmFyIGlzSGVpZ2h0UGVyY2VudCA9IGlzUGVyY2VudChoZWlnaHQpOwogIGlmIChpc1dpZHRoUGVyY2VudCAmJiBpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBib3RoT3ZlcmZsb3c7CiAgfQogIGlmIChpc1dpZHRoUGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WDsKICB9CiAgaWYgKGlzSGVpZ2h0UGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WTsKICB9CiAgcmV0dXJuIG5vU3R5bGU7Cn07CmZ1bmN0aW9uIGdldERlZmF1bHRXaWR0aEFuZEhlaWdodChfcmVmMikgewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdAogIH0gPSBfcmVmMjsKICB2YXIgY2FsY3VsYXRlZFdpZHRoID0gd2lkdGg7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBoZWlnaHQ7CiAgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwICYmIGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gIjEwMCUiOwogICAgY2FsY3VsYXRlZEhlaWdodCA9ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwKSB7CiAgICBjYWxjdWxhdGVkV2lkdGggPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZEhlaWdodCA9IGFzcGVjdCAmJiBhc3BlY3QgPiAwID8gdm9pZCAwIDogIjEwMCUiOwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9pc1dlbGxCZWhhdmVkTnVtYmVyLmpzCmZ1bmN0aW9uIGlzV2VsbEJlaGF2ZWROdW1iZXIobikgewogIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobik7Cn0KZnVuY3Rpb24gaXNQb3NpdGl2ZU51bWJlcihuKSB7CiAgcmV0dXJuIHR5cGVvZiBuID09PSAibnVtYmVyIiAmJiBuID4gMCAmJiBOdW1iZXIuaXNGaW5pdGUobik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Jlc3BvbnNpdmVDb250YWluZXIuanMKZnVuY3Rpb24gX2V4dGVuZHMzKCkgewogIHJldHVybiBfZXh0ZW5kczMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmNyZWF0ZUNvbnRleHQpKHsKICB3aWR0aDogLTEsCiAgaGVpZ2h0OiAtMQp9KTsKZnVuY3Rpb24gaXNBY2NlcHRhYmxlU2l6ZShzaXplKSB7CiAgcmV0dXJuIGlzUG9zaXRpdmVOdW1iZXIoc2l6ZS53aWR0aCkgJiYgaXNQb3NpdGl2ZU51bWJlcihzaXplLmhlaWdodCk7Cn0KZnVuY3Rpb24gUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlcihfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IF9yZWYyOwogIHZhciBzaXplID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZU1lbW8pKCgpID0+ICh7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbd2lkdGgsIGhlaWdodF0pOwogIGlmICghaXNBY2NlcHRhYmxlU2l6ZShzaXplKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiBzaXplCiAgfSwgY2hpbGRyZW4pOwp9CnZhciB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VDb250ZXh0KShSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCk7CnZhciBTaXplRGV0ZWN0b3JDb250YWluZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmZvcndhcmRSZWYpKChfcmVmMiwgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGFzcGVjdCwKICAgIGluaXRpYWxEaW1lbnNpb24gPSB7CiAgICAgIHdpZHRoOiAtMSwKICAgICAgaGVpZ2h0OiAtMQogICAgfSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgLyoKICAgICAqIGRlZmF1bHQgbWluLXdpZHRoIHRvIDAgaWYgbm90IHNwZWNpZmllZCAtICdhdXRvJyBjYXVzZXMgaXNzdWVzIHdpdGggZmxleGJveAogICAgICogaHR0cHM6Ly9naXRodWIuY29tL3JlY2hhcnRzL3JlY2hhcnRzL2lzc3Vlcy8xNzIKICAgICAqLwogICAgbWluV2lkdGggPSAwLAogICAgbWluSGVpZ2h0LAogICAgbWF4SGVpZ2h0LAogICAgY2hpbGRyZW4sCiAgICBkZWJvdW5jZSA9IDAsCiAgICBpZCwKICAgIGNsYXNzTmFtZSwKICAgIG9uUmVzaXplLAogICAgc3R5bGUgPSB7fQogIH0gPSBfcmVmMjsKICB2YXIgY29udGFpbmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVJlZikobnVsbCk7CiAgdmFyIG9uUmVzaXplUmVmID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVJlZikoKTsKICBvblJlc2l6ZVJlZi5jdXJyZW50ID0gb25SZXNpemU7CiAgKDAsIGltcG9ydF9yZWFjdDEyLnVzZUltcGVyYXRpdmVIYW5kbGUpKHJlZiwgKCkgPT4gY29udGFpbmVyUmVmLmN1cnJlbnQpOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGluaXRpYWxEaW1lbnNpb24ud2lkdGgsCiAgICBjb250YWluZXJIZWlnaHQ6IGluaXRpYWxEaW1lbnNpb24uaGVpZ2h0CiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgKDAsIGltcG9ydF9yZWFjdDEyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGNvbnRhaW5lclJlZi5jdXJyZW50ID09IG51bGwgfHwgdHlwZW9mIFJlc2l6ZU9ic2VydmVyID09PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBjYWxsYmFjayA9IChlbnRyaWVzKSA9PiB7CiAgICAgIHZhciBfb25SZXNpemVSZWYkY3VycmVudDsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgzLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0MwogICAgICB9ID0gZW50cmllc1swXS5jb250ZW50UmVjdDsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aDMsIGNvbnRhaW5lckhlaWdodDMpOwogICAgICAoX29uUmVzaXplUmVmJGN1cnJlbnQgPSBvblJlc2l6ZVJlZi5jdXJyZW50KSA9PT0gbnVsbCB8fCBfb25SZXNpemVSZWYkY3VycmVudCA9PT0gdm9pZCAwIHx8IF9vblJlc2l6ZVJlZiRjdXJyZW50LmNhbGwob25SZXNpemVSZWYsIGNvbnRhaW5lcldpZHRoMywgY29udGFpbmVySGVpZ2h0Myk7CiAgICB9OwogICAgaWYgKGRlYm91bmNlID4gMCkgewogICAgICBjYWxsYmFjayA9ICgwLCBpbXBvcnRfdGhyb3R0bGUuZGVmYXVsdCkoY2FsbGJhY2ssIGRlYm91bmNlLCB7CiAgICAgICAgdHJhaWxpbmc6IHRydWUsCiAgICAgICAgbGVhZGluZzogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoY2FsbGJhY2spOwogICAgdmFyIHsKICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoMiwKICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQyCiAgICB9ID0gY29udGFpbmVyUmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoMiwgY29udGFpbmVySGVpZ2h0Mik7CiAgICBvYnNlcnZlci5vYnNlcnZlKGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgIH07CiAgfSwgW3NldENvbnRhaW5lclNpemUsIGRlYm91bmNlXSk7CiAgdmFyIHsKICAgIGNvbnRhaW5lcldpZHRoLAogICAgY29udGFpbmVySGVpZ2h0CiAgfSA9IHNpemVzOwogIHdhcm4oIWFzcGVjdCB8fCBhc3BlY3QgPiAwLCAiVGhlIGFzcGVjdCglcykgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iLCBhc3BlY3QpOwogIHZhciB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfSA9IGNhbGN1bGF0ZUNoYXJ0RGltZW5zaW9ucyhjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0LCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdCwKICAgIG1heEhlaWdodAogIH0pOwogIHdhcm4oY2FsY3VsYXRlZFdpZHRoICE9IG51bGwgJiYgY2FsY3VsYXRlZFdpZHRoID4gMCB8fCBjYWxjdWxhdGVkSGVpZ2h0ICE9IG51bGwgJiYgY2FsY3VsYXRlZEhlaWdodCA+IDAsICJUaGUgd2lkdGgoJXMpIGFuZCBoZWlnaHQoJXMpIG9mIGNoYXJ0IHNob3VsZCBiZSBncmVhdGVyIHRoYW4gMCxcbiAgICAgICBwbGVhc2UgY2hlY2sgdGhlIHN0eWxlIG9mIGNvbnRhaW5lciwgb3IgdGhlIHByb3BzIHdpZHRoKCVzKSBhbmQgaGVpZ2h0KCVzKSxcbiAgICAgICBvciBhZGQgYSBtaW5XaWR0aCglcykgb3IgbWluSGVpZ2h0KCVzKSBvciB1c2UgYXNwZWN0KCVzKSB0byBjb250cm9sIHRoZVxuICAgICAgIGhlaWdodCBhbmQgd2lkdGguIiwgY2FsY3VsYXRlZFdpZHRoLCBjYWxjdWxhdGVkSGVpZ2h0LCB3aWR0aCwgaGVpZ2h0LCBtaW5XaWR0aCwgbWluSGVpZ2h0LCBhc3BlY3QpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgIGlkOiBpZCA/ICIiLmNvbmNhdChpZCkgOiB2b2lkIDAsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXJlc3BvbnNpdmUtY29udGFpbmVyIiwgY2xhc3NOYW1lKSwKICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkNChfb2JqZWN0U3ByZWFkNCh7fSwgc3R5bGUpLCB7fSwgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBtaW5XaWR0aCwKICAgICAgbWluSGVpZ2h0LAogICAgICBtYXhIZWlnaHQKICAgIH0pLAogICAgcmVmOiBjb250YWluZXJSZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgIHN0eWxlOiBnZXRJbm5lckRpdlN0eWxlKHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlciwgewogICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogIH0sIGNoaWxkcmVuKSkpOwp9KTsKdmFyIFJlc3BvbnNpdmVDb250YWluZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICBpZiAoaXNQb3NpdGl2ZU51bWJlcihyZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC53aWR0aCkgJiYgaXNQb3NpdGl2ZU51bWJlcihyZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC5oZWlnaHQpKSB7CiAgICByZXR1cm4gcHJvcHMuY2hpbGRyZW47CiAgfQogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBnZXREZWZhdWx0V2lkdGhBbmRIZWlnaHQoewogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBhc3BlY3Q6IHByb3BzLmFzcGVjdAogIH0pOwogIHZhciB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfSA9IGNhbGN1bGF0ZUNoYXJ0RGltZW5zaW9ucyh2b2lkIDAsIHZvaWQgMCwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3Q6IHByb3BzLmFzcGVjdCwKICAgIG1heEhlaWdodDogcHJvcHMubWF4SGVpZ2h0CiAgfSk7CiAgaWYgKGlzTnVtYmVyKGNhbGN1bGF0ZWRXaWR0aCkgJiYgaXNOdW1iZXIoY2FsY3VsYXRlZEhlaWdodCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlciwgewogICAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICAgIH0sIHByb3BzLmNoaWxkcmVuKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChTaXplRGV0ZWN0b3JDb250YWluZXIsIF9leHRlbmRzMyh7fSwgcHJvcHMsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVmCiAgfSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKZnVuY3Rpb24gY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKGJveCkgewogIGlmICghYm94KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gewogICAgeDogYm94LngsCiAgICB5OiBib3gueSwKICAgIHVwcGVyV2lkdGg6ICJ1cHBlcldpZHRoIiBpbiBib3ggPyBib3gudXBwZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIGxvd2VyV2lkdGg6ICJsb3dlcldpZHRoIiBpbiBib3ggPyBib3gubG93ZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIHdpZHRoOiBib3gud2lkdGgsCiAgICBoZWlnaHQ6IGJveC5oZWlnaHQKICB9Owp9CnZhciB1c2VWaWV3Qm94ID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIHBhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciByb290Vmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0Vmlld0JveCk7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgdmFyIGJydXNoUGFkZGluZyA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaFNldHRpbmdzKSkgPT09IG51bGwgfHwgX3VzZUFwcFNlbGVjdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdXNlQXBwU2VsZWN0b3IucGFkZGluZzsKICBpZiAoIXBhbm9yYW1hIHx8ICFicnVzaERpbWVuc2lvbnMgfHwgIWJydXNoUGFkZGluZykgewogICAgcmV0dXJuIHJvb3RWaWV3Qm94OwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5sZWZ0IC0gYnJ1c2hQYWRkaW5nLnJpZ2h0LAogICAgaGVpZ2h0OiBicnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLnRvcCAtIGJydXNoUGFkZGluZy5ib3R0b20sCiAgICB4OiBicnVzaFBhZGRpbmcubGVmdCwKICAgIHk6IGJydXNoUGFkZGluZy50b3AKICB9Owp9Owp2YXIgbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQgPSB7CiAgdG9wOiAwLAogIGJvdHRvbTogMCwKICBsZWZ0OiAwLAogIHJpZ2h0OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBicnVzaEJvdHRvbTogMAp9Owp2YXIgdXNlT2Zmc2V0SW50ZXJuYWwgPSAoKSA9PiB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjI7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvcjIgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvcjIgOiBtYW55Q29tcG9uZW50c1Rocm93RXJyb3JzSWZPZmZzZXRJc1VuZGVmaW5lZDsKfTsKdmFyIHVzZUNoYXJ0V2lkdGggPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgpOwp9Owp2YXIgdXNlQ2hhcnRIZWlnaHQgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0KTsKfTsKdmFyIHNlbGVjdENoYXJ0TGF5b3V0ID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZTsKdmFyIHVzZUNoYXJ0TGF5b3V0ID0gKCkgPT4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRMYXlvdXQpOwp2YXIgdXNlQ2FydGVzaWFuQ2hhcnRMYXlvdXQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGxheW91dDsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHVzZUlzSW5DaGFydENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgcmV0dXJuIGxheW91dCAhPT0gdm9pZCAwOwp9Owp2YXIgUmVwb3J0Q2hhcnRTaXplID0gKHByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgd2lkdGg6IHdpZHRoRnJvbVByb3BzLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMKICB9ID0gcHJvcHM7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IHdpZHRoRnJvbVByb3BzOwogIHZhciBoZWlnaHQgPSBoZWlnaHRGcm9tUHJvcHM7CiAgaWYgKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMpIHsKICAgIHdpZHRoID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoIDogd2lkdGhGcm9tUHJvcHM7CiAgICBoZWlnaHQgPSByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA6IGhlaWdodEZyb21Qcm9wczsKICB9CiAgKDAsIGltcG9ydF9yZWFjdDEzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hICYmIGlzUG9zaXRpdmVOdW1iZXIod2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSkgewogICAgICBkaXNwYXRjaChzZXRDaGFydFNpemUoewogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9KSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvaW1tZXIvZGlzdC9pbW1lci5tanMKdmFyIE5PVEhJTkcyID0gU3ltYm9sLmZvcigiaW1tZXItbm90aGluZyIpOwp2YXIgRFJBRlRBQkxFMiA9IFN5bWJvbC5mb3IoImltbWVyLWRyYWZ0YWJsZSIpOwp2YXIgRFJBRlRfU1RBVEUyID0gU3ltYm9sLmZvcigiaW1tZXItc3RhdGUiKTsKdmFyIGVycm9yczIgPSB0cnVlID8gWwogIC8vIEFsbCBlcnJvciBjb2Rlcywgc3RhcnRpbmcgYnkgMDoKICBmdW5jdGlvbihwbHVnaW4pIHsKICAgIHJldHVybiBgVGhlIHBsdWdpbiBmb3IgJyR7cGx1Z2lufScgaGFzIG5vdCBiZWVuIGxvYWRlZCBpbnRvIEltbWVyLiBUbyBlbmFibGUgdGhlIHBsdWdpbiwgaW1wb3J0IGFuZCBjYWxsIFxgZW5hYmxlJHtwbHVnaW59KClcYCB3aGVuIGluaXRpYWxpemluZyB5b3VyIGFwcGxpY2F0aW9uLmA7CiAgfSwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGBwcm9kdWNlIGNhbiBvbmx5IGJlIGNhbGxlZCBvbiB0aGluZ3MgdGhhdCBhcmUgZHJhZnRhYmxlOiBwbGFpbiBvYmplY3RzLCBhcnJheXMsIE1hcCwgU2V0IG9yIGNsYXNzZXMgdGhhdCBhcmUgbWFya2VkIHdpdGggJ1tpbW1lcmFibGVdOiB0cnVlJy4gR290ICcke3RoaW5nfSdgOwogIH0sCiAgIlRoaXMgb2JqZWN0IGhhcyBiZWVuIGZyb3plbiBhbmQgc2hvdWxkIG5vdCBiZSBtdXRhdGVkIiwKICBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gIkNhbm5vdCB1c2UgYSBwcm94eSB0aGF0IGhhcyBiZWVuIHJldm9rZWQuIERpZCB5b3UgcGFzcyBhbiBvYmplY3QgZnJvbSBpbnNpZGUgYW4gaW1tZXIgZnVuY3Rpb24gdG8gYW4gYXN5bmMgcHJvY2Vzcz8gIiArIGRhdGE7CiAgfSwKICAiQW4gaW1tZXIgcHJvZHVjZXIgcmV0dXJuZWQgYSBuZXcgdmFsdWUgKmFuZCogbW9kaWZpZWQgaXRzIGRyYWZ0LiBFaXRoZXIgcmV0dXJuIGEgbmV3IHZhbHVlICpvciogbW9kaWZ5IHRoZSBkcmFmdC4iLAogICJJbW1lciBmb3JiaWRzIGNpcmN1bGFyIHJlZmVyZW5jZXMiLAogICJUaGUgZmlyc3Qgb3Igc2Vjb25kIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24iLAogICJUaGUgdGhpcmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiBvciB1bmRlZmluZWQiLAogICJGaXJzdCBhcmd1bWVudCB0byBgY3JlYXRlRHJhZnRgIG11c3QgYmUgYSBwbGFpbiBvYmplY3QsIGFuIGFycmF5LCBvciBhbiBpbW1lcmFibGUgb2JqZWN0IiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGZpbmlzaERyYWZ0YCBtdXN0IGJlIGEgZHJhZnQgcmV0dXJuZWQgYnkgYGNyZWF0ZURyYWZ0YCIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ2N1cnJlbnQnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfSwKICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJPYmplY3Quc2V0UHJvdG90eXBlT2YoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgZGVsZXRpbmcgYXJyYXkgaW5kaWNlcyIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgc2V0dGluZyBhcnJheSBpbmRpY2VzIGFuZCB0aGUgJ2xlbmd0aCcgcHJvcGVydHkiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdvcmlnaW5hbCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9CiAgLy8gTm90ZTogaWYgbW9yZSBlcnJvcnMgYXJlIGFkZGVkLCB0aGUgZXJyb3JPZmZzZXQgaW4gUGF0Y2hlcy50cyBzaG91bGQgYmUgaW5jcmVhc2VkCiAgLy8gU2VlIFBhdGNoZXMudHMgZm9yIGFkZGl0aW9uYWwgZXJyb3JzCl0gOiBbXTsKZnVuY3Rpb24gZGllMihlcnJvciwgLi4uYXJncykgewogIGlmICh0cnVlKSB7CiAgICBjb25zdCBlID0gZXJyb3JzMltlcnJvcl07CiAgICBjb25zdCBtc2cgPSB0eXBlb2YgZSA9PT0gImZ1bmN0aW9uIiA/IGUuYXBwbHkobnVsbCwgYXJncykgOiBlOwogICAgdGhyb3cgbmV3IEVycm9yKGBbSW1tZXJdICR7bXNnfWApOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoCiAgICBgW0ltbWVyXSBtaW5pZmllZCBlcnJvciBucjogJHtlcnJvcn0uIEZ1bGwgZXJyb3IgYXQ6IGh0dHBzOi8vYml0Lmx5LzNjWEVLV2ZgCiAgKTsKfQp2YXIgZ2V0UHJvdG90eXBlT2YyID0gT2JqZWN0LmdldFByb3RvdHlwZU9mOwpmdW5jdGlvbiBpc0RyYWZ0Mih2YWx1ZSkgewogIHJldHVybiAhIXZhbHVlICYmICEhdmFsdWVbRFJBRlRfU1RBVEUyXTsKfQpmdW5jdGlvbiBpc0RyYWZ0YWJsZTIodmFsdWUpIHsKICBpZiAoIXZhbHVlKQogICAgcmV0dXJuIGZhbHNlOwogIHJldHVybiBpc1BsYWluT2JqZWN0Myh2YWx1ZSkgfHwgQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISF2YWx1ZVtEUkFGVEFCTEUyXSB8fCAhIXZhbHVlLmNvbnN0cnVjdG9yPy5bRFJBRlRBQkxFMl0gfHwgaXNNYXAyKHZhbHVlKSB8fCBpc1NldDIodmFsdWUpOwp9CnZhciBvYmplY3RDdG9yU3RyaW5nMiA9IE9iamVjdC5wcm90b3R5cGUuY29uc3RydWN0b3IudG9TdHJpbmcoKTsKdmFyIGNhY2hlZEN0b3JTdHJpbmdzMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0Myh2YWx1ZSkgewogIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IikKICAgIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90bzIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIGlmIChwcm90bzIgPT09IG51bGwgfHwgcHJvdG8yID09PSBPYmplY3QucHJvdG90eXBlKQogICAgcmV0dXJuIHRydWU7CiAgY29uc3QgQ3RvciA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvMiwgImNvbnN0cnVjdG9yIikgJiYgcHJvdG8yLmNvbnN0cnVjdG9yOwogIGlmIChDdG9yID09PSBPYmplY3QpCiAgICByZXR1cm4gdHJ1ZTsKICBpZiAodHlwZW9mIEN0b3IgIT09ICJmdW5jdGlvbiIpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IGN0b3JTdHJpbmcgPSBjYWNoZWRDdG9yU3RyaW5nczIuZ2V0KEN0b3IpOwogIGlmIChjdG9yU3RyaW5nID09PSB2b2lkIDApIHsKICAgIGN0b3JTdHJpbmcgPSBGdW5jdGlvbi50b1N0cmluZy5jYWxsKEN0b3IpOwogICAgY2FjaGVkQ3RvclN0cmluZ3MyLnNldChDdG9yLCBjdG9yU3RyaW5nKTsKICB9CiAgcmV0dXJuIGN0b3JTdHJpbmcgPT09IG9iamVjdEN0b3JTdHJpbmcyOwp9CmZ1bmN0aW9uIGVhY2gyKG9iaiwgaXRlciwgc3RyaWN0ID0gdHJ1ZSkgewogIGlmIChnZXRBcmNodHlwZTIob2JqKSA9PT0gMCkgewogICAgY29uc3Qga2V5cyA9IHN0cmljdCA/IFJlZmxlY3Qub3duS2V5cyhvYmopIDogT2JqZWN0LmtleXMob2JqKTsKICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIGl0ZXIoa2V5LCBvYmpba2V5XSwgb2JqKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBvYmouZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiBpdGVyKGluZGV4LCBlbnRyeSwgb2JqKSk7CiAgfQp9CmZ1bmN0aW9uIGdldEFyY2h0eXBlMih0aGluZykgewogIGNvbnN0IHN0YXRlID0gdGhpbmdbRFJBRlRfU1RBVEUyXTsKICByZXR1cm4gc3RhdGUgPyBzdGF0ZS50eXBlXyA6IEFycmF5LmlzQXJyYXkodGhpbmcpID8gMSA6IGlzTWFwMih0aGluZykgPyAyIDogaXNTZXQyKHRoaW5nKSA/IDMgOiAwOwp9CmZ1bmN0aW9uIGhhczIodGhpbmcsIHByb3ApIHsKICByZXR1cm4gZ2V0QXJjaHR5cGUyKHRoaW5nKSA9PT0gMiA/IHRoaW5nLmhhcyhwcm9wKSA6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGluZywgcHJvcCk7Cn0KZnVuY3Rpb24gc2V0Mih0aGluZywgcHJvcE9yT2xkVmFsdWUsIHZhbHVlKSB7CiAgY29uc3QgdCA9IGdldEFyY2h0eXBlMih0aGluZyk7CiAgaWYgKHQgPT09IDIpCiAgICB0aGluZy5zZXQocHJvcE9yT2xkVmFsdWUsIHZhbHVlKTsKICBlbHNlIGlmICh0ID09PSAzKSB7CiAgICB0aGluZy5hZGQodmFsdWUpOwogIH0gZWxzZQogICAgdGhpbmdbcHJvcE9yT2xkVmFsdWVdID0gdmFsdWU7Cn0KZnVuY3Rpb24gaXMyKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIGlzTWFwMih0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0IGluc3RhbmNlb2YgTWFwOwp9CmZ1bmN0aW9uIGlzU2V0Mih0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0IGluc3RhbmNlb2YgU2V0Owp9CmZ1bmN0aW9uIGxhdGVzdDIoc3RhdGUpIHsKICByZXR1cm4gc3RhdGUuY29weV8gfHwgc3RhdGUuYmFzZV87Cn0KZnVuY3Rpb24gc2hhbGxvd0NvcHkyKGJhc2UsIHN0cmljdCkgewogIGlmIChpc01hcDIoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgTWFwKGJhc2UpOwogIH0KICBpZiAoaXNTZXQyKGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IFNldChiYXNlKTsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkoYmFzZSkpCiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYmFzZSk7CiAgY29uc3QgaXNQbGFpbjIgPSBpc1BsYWluT2JqZWN0MyhiYXNlKTsKICBpZiAoc3RyaWN0ID09PSB0cnVlIHx8IHN0cmljdCA9PT0gImNsYXNzX29ubHkiICYmICFpc1BsYWluMikgewogICAgY29uc3QgZGVzY3JpcHRvcnMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiYXNlKTsKICAgIGRlbGV0ZSBkZXNjcmlwdG9yc1tEUkFGVF9TVEFURTJdOwogICAgbGV0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZGVzY3JpcHRvcnMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgIGNvbnN0IGRlc2MgPSBkZXNjcmlwdG9yc1trZXldOwogICAgICBpZiAoZGVzYy53cml0YWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICBkZXNjLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgICBkZXNjLmNvbmZpZ3VyYWJsZSA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KQogICAgICAgIGRlc2NyaXB0b3JzW2tleV0gPSB7CiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIC8vIGNvdWxkIGxpdmUgd2l0aCAhIWRlc2Muc2V0IGFzIHdlbGwgaGVyZS4uLgogICAgICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICAgICAgdmFsdWU6IGJhc2Vba2V5XQogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShnZXRQcm90b3R5cGVPZjIoYmFzZSksIGRlc2NyaXB0b3JzKTsKICB9IGVsc2UgewogICAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKGJhc2UpOwogICAgaWYgKHByb3RvMiAhPT0gbnVsbCAmJiBpc1BsYWluMikgewogICAgICByZXR1cm4geyAuLi5iYXNlIH07CiAgICB9CiAgICBjb25zdCBvYmogPSBPYmplY3QuY3JlYXRlKHByb3RvMik7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihvYmosIGJhc2UpOwogIH0KfQpmdW5jdGlvbiBmcmVlemUyKG9iaiwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKGlzRnJvemVuMihvYmopIHx8IGlzRHJhZnQyKG9iaikgfHwgIWlzRHJhZnRhYmxlMihvYmopKQogICAgcmV0dXJuIG9iajsKICBpZiAoZ2V0QXJjaHR5cGUyKG9iaikgPiAxKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhvYmosIHsKICAgICAgc2V0OiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBhZGQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGNsZWFyOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBkZWxldGU6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIKICAgIH0pOwogIH0KICBPYmplY3QuZnJlZXplKG9iaik7CiAgaWYgKGRlZXApCiAgICBPYmplY3QudmFsdWVzKG9iaikuZm9yRWFjaCgodmFsdWUpID0+IGZyZWV6ZTIodmFsdWUsIHRydWUpKTsKICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9uczIoKSB7CiAgZGllMigyKTsKfQp2YXIgZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiA9IHsKICB2YWx1ZTogZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zMgp9OwpmdW5jdGlvbiBpc0Zyb3plbjIob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikKICAgIHJldHVybiB0cnVlOwogIHJldHVybiBPYmplY3QuaXNGcm96ZW4ob2JqKTsKfQp2YXIgcGx1Z2luczIgPSB7fTsKZnVuY3Rpb24gZ2V0UGx1Z2luMihwbHVnaW5LZXkpIHsKICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zMltwbHVnaW5LZXldOwogIGlmICghcGx1Z2luKSB7CiAgICBkaWUyKDAsIHBsdWdpbktleSk7CiAgfQogIHJldHVybiBwbHVnaW47Cn0KdmFyIGN1cnJlbnRTY29wZTI7CmZ1bmN0aW9uIGdldEN1cnJlbnRTY29wZTIoKSB7CiAgcmV0dXJuIGN1cnJlbnRTY29wZTI7Cn0KZnVuY3Rpb24gY3JlYXRlU2NvcGUyKHBhcmVudF8sIGltbWVyXykgewogIHJldHVybiB7CiAgICBkcmFmdHNfOiBbXSwKICAgIHBhcmVudF8sCiAgICBpbW1lcl8sCiAgICAvLyBXaGVuZXZlciB0aGUgbW9kaWZpZWQgZHJhZnQgY29udGFpbnMgYSBkcmFmdCBmcm9tIGFub3RoZXIgc2NvcGUsIHdlCiAgICAvLyBuZWVkIHRvIHByZXZlbnQgYXV0by1mcmVlemluZyBzbyB0aGUgdW5vd25lZCBkcmFmdCBjYW4gYmUgZmluYWxpemVkLgogICAgY2FuQXV0b0ZyZWV6ZV86IHRydWUsCiAgICB1bmZpbmFsaXplZERyYWZ0c186IDAKICB9Owp9CmZ1bmN0aW9uIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcikgewogIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIik7CiAgICBzY29wZS5wYXRjaGVzXyA9IFtdOwogICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfID0gW107CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyA9IHBhdGNoTGlzdGVuZXI7CiAgfQp9CmZ1bmN0aW9uIHJldm9rZVNjb3BlMihzY29wZSkgewogIGxlYXZlU2NvcGUyKHNjb3BlKTsKICBzY29wZS5kcmFmdHNfLmZvckVhY2gocmV2b2tlRHJhZnQyKTsKICBzY29wZS5kcmFmdHNfID0gbnVsbDsKfQpmdW5jdGlvbiBsZWF2ZVNjb3BlMihzY29wZSkgewogIGlmIChzY29wZSA9PT0gY3VycmVudFNjb3BlMikgewogICAgY3VycmVudFNjb3BlMiA9IHNjb3BlLnBhcmVudF87CiAgfQp9CmZ1bmN0aW9uIGVudGVyU2NvcGUyKGltbWVyMjIpIHsKICByZXR1cm4gY3VycmVudFNjb3BlMiA9IGNyZWF0ZVNjb3BlMihjdXJyZW50U2NvcGUyLCBpbW1lcjIyKTsKfQpmdW5jdGlvbiByZXZva2VEcmFmdDIoZHJhZnQpIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgaWYgKHN0YXRlLnR5cGVfID09PSAwIHx8IHN0YXRlLnR5cGVfID09PSAxKQogICAgc3RhdGUucmV2b2tlXygpOwogIGVsc2UKICAgIHN0YXRlLnJldm9rZWRfID0gdHJ1ZTsKfQpmdW5jdGlvbiBwcm9jZXNzUmVzdWx0MihyZXN1bHQsIHNjb3BlKSB7CiAgc2NvcGUudW5maW5hbGl6ZWREcmFmdHNfID0gc2NvcGUuZHJhZnRzXy5sZW5ndGg7CiAgY29uc3QgYmFzZURyYWZ0ID0gc2NvcGUuZHJhZnRzX1swXTsKICBjb25zdCBpc1JlcGxhY2VkID0gcmVzdWx0ICE9PSB2b2lkIDAgJiYgcmVzdWx0ICE9PSBiYXNlRHJhZnQ7CiAgaWYgKGlzUmVwbGFjZWQpIHsKICAgIGlmIChiYXNlRHJhZnRbRFJBRlRfU1RBVEUyXS5tb2RpZmllZF8pIHsKICAgICAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICAgICAgZGllMig0KTsKICAgIH0KICAgIGlmIChpc0RyYWZ0YWJsZTIocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBmaW5hbGl6ZTIoc2NvcGUsIHJlc3VsdCk7CiAgICAgIGlmICghc2NvcGUucGFyZW50XykKICAgICAgICBtYXliZUZyZWV6ZTIoc2NvcGUsIHJlc3VsdCk7CiAgICB9CiAgICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXygKICAgICAgICBiYXNlRHJhZnRbRFJBRlRfU1RBVEUyXS5iYXNlXywKICAgICAgICByZXN1bHQsCiAgICAgICAgc2NvcGUucGF0Y2hlc18sCiAgICAgICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfCiAgICAgICk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJlc3VsdCA9IGZpbmFsaXplMihzY29wZSwgYmFzZURyYWZ0LCBbXSk7CiAgfQogIHJldm9rZVNjb3BlMihzY29wZSk7CiAgaWYgKHNjb3BlLnBhdGNoZXNfKSB7CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyhzY29wZS5wYXRjaGVzXywgc2NvcGUuaW52ZXJzZVBhdGNoZXNfKTsKICB9CiAgcmV0dXJuIHJlc3VsdCAhPT0gTk9USElORzIgPyByZXN1bHQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZmluYWxpemUyKHJvb3RTY29wZSwgdmFsdWUsIHBhdGgyKSB7CiAgaWYgKGlzRnJvemVuMih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3QgdXNlU3RyaWN0SXRlcmF0aW9uID0gcm9vdFNjb3BlLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFMl07CiAgaWYgKCFzdGF0ZSkgewogICAgZWFjaDIoCiAgICAgIHZhbHVlLAogICAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiBmaW5hbGl6ZVByb3BlcnR5KHJvb3RTY29wZSwgc3RhdGUsIHZhbHVlLCBrZXksIGNoaWxkVmFsdWUsIHBhdGgyKSwKICAgICAgdXNlU3RyaWN0SXRlcmF0aW9uCiAgICApOwogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoc3RhdGUuc2NvcGVfICE9PSByb290U2NvcGUpCiAgICByZXR1cm4gdmFsdWU7CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIHN0YXRlLmJhc2VfLCB0cnVlKTsKICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICB9CiAgaWYgKCFzdGF0ZS5maW5hbGl6ZWRfKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIHN0YXRlLnNjb3BlXy51bmZpbmFsaXplZERyYWZ0c18tLTsKICAgIGNvbnN0IHJlc3VsdCA9IHN0YXRlLmNvcHlfOwogICAgbGV0IHJlc3VsdEVhY2ggPSByZXN1bHQ7CiAgICBsZXQgaXNTZXQyMiA9IGZhbHNlOwogICAgaWYgKHN0YXRlLnR5cGVfID09PSAzKSB7CiAgICAgIHJlc3VsdEVhY2ggPSBuZXcgU2V0KHJlc3VsdCk7CiAgICAgIHJlc3VsdC5jbGVhcigpOwogICAgICBpc1NldDIyID0gdHJ1ZTsKICAgIH0KICAgIGVhY2gyKAogICAgICByZXN1bHRFYWNoLAogICAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiBmaW5hbGl6ZVByb3BlcnR5KAogICAgICAgIHJvb3RTY29wZSwKICAgICAgICBzdGF0ZSwKICAgICAgICByZXN1bHQsCiAgICAgICAga2V5LAogICAgICAgIGNoaWxkVmFsdWUsCiAgICAgICAgcGF0aDIsCiAgICAgICAgaXNTZXQyMgogICAgICApLAogICAgICB1c2VTdHJpY3RJdGVyYXRpb24KICAgICk7CiAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCByZXN1bHQsIGZhbHNlKTsKICAgIGlmIChwYXRoMiAmJiByb290U2NvcGUucGF0Y2hlc18pIHsKICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUGF0Y2hlc18oCiAgICAgICAgc3RhdGUsCiAgICAgICAgcGF0aDIsCiAgICAgICAgcm9vdFNjb3BlLnBhdGNoZXNfLAogICAgICAgIHJvb3RTY29wZS5pbnZlcnNlUGF0Y2hlc18KICAgICAgKTsKICAgIH0KICB9CiAgcmV0dXJuIHN0YXRlLmNvcHlfOwp9CmZ1bmN0aW9uIGZpbmFsaXplUHJvcGVydHkocm9vdFNjb3BlLCBwYXJlbnRTdGF0ZSwgdGFyZ2V0T2JqZWN0LCBwcm9wLCBjaGlsZFZhbHVlLCByb290UGF0aCwgdGFyZ2V0SXNTZXQpIHsKICBpZiAoY2hpbGRWYWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm47CiAgfQogIGlmICh0eXBlb2YgY2hpbGRWYWx1ZSAhPT0gIm9iamVjdCIgJiYgIXRhcmdldElzU2V0KSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IGNoaWxkSXNGcm96ZW4gPSBpc0Zyb3plbjIoY2hpbGRWYWx1ZSk7CiAgaWYgKGNoaWxkSXNGcm96ZW4gJiYgIXRhcmdldElzU2V0KSB7CiAgICByZXR1cm47CiAgfQogIGlmIChjaGlsZFZhbHVlID09PSB0YXJnZXRPYmplY3QpCiAgICBkaWUyKDUpOwogIGlmIChpc0RyYWZ0MihjaGlsZFZhbHVlKSkgewogICAgY29uc3QgcGF0aDIgPSByb290UGF0aCAmJiBwYXJlbnRTdGF0ZSAmJiBwYXJlbnRTdGF0ZS50eXBlXyAhPT0gMyAmJiAvLyBTZXQgb2JqZWN0cyBhcmUgYXRvbWljIHNpbmNlIHRoZXkgaGF2ZSBubyBrZXlzLgogICAgIWhhczIocGFyZW50U3RhdGUuYXNzaWduZWRfLCBwcm9wKSA/IHJvb3RQYXRoLmNvbmNhdChwcm9wKSA6IHZvaWQgMDsKICAgIGNvbnN0IHJlcyA9IGZpbmFsaXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUsIHBhdGgyKTsKICAgIHNldDIodGFyZ2V0T2JqZWN0LCBwcm9wLCByZXMpOwogICAgaWYgKGlzRHJhZnQyKHJlcykpIHsKICAgICAgcm9vdFNjb3BlLmNhbkF1dG9GcmVlemVfID0gZmFsc2U7CiAgICB9IGVsc2UKICAgICAgcmV0dXJuOwogIH0gZWxzZSBpZiAodGFyZ2V0SXNTZXQpIHsKICAgIHRhcmdldE9iamVjdC5hZGQoY2hpbGRWYWx1ZSk7CiAgfQogIGlmIChpc0RyYWZ0YWJsZTIoY2hpbGRWYWx1ZSkgJiYgIWNoaWxkSXNGcm96ZW4pIHsKICAgIGlmICghcm9vdFNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiByb290U2NvcGUudW5maW5hbGl6ZWREcmFmdHNfIDwgMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocGFyZW50U3RhdGUgJiYgcGFyZW50U3RhdGUuYmFzZV8gJiYgcGFyZW50U3RhdGUuYmFzZV9bcHJvcF0gPT09IGNoaWxkVmFsdWUgJiYgY2hpbGRJc0Zyb3plbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBmaW5hbGl6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlKTsKICAgIGlmICgoIXBhcmVudFN0YXRlIHx8ICFwYXJlbnRTdGF0ZS5zY29wZV8ucGFyZW50XykgJiYgdHlwZW9mIHByb3AgIT09ICJzeW1ib2wiICYmIChpc01hcDIodGFyZ2V0T2JqZWN0KSA/IHRhcmdldE9iamVjdC5oYXMocHJvcCkgOiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwodGFyZ2V0T2JqZWN0LCBwcm9wKSkpCiAgICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUpOwogIH0KfQpmdW5jdGlvbiBtYXliZUZyZWV6ZTIoc2NvcGUsIHZhbHVlLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoIXNjb3BlLnBhcmVudF8gJiYgc2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHNjb3BlLmNhbkF1dG9GcmVlemVfKSB7CiAgICBmcmVlemUyKHZhbHVlLCBkZWVwKTsKICB9Cn0KZnVuY3Rpb24gY3JlYXRlUHJveHlQcm94eTIoYmFzZSwgcGFyZW50KSB7CiAgY29uc3QgaXNBcnJheTIgPSBBcnJheS5pc0FycmF5KGJhc2UpOwogIGNvbnN0IHN0YXRlID0gewogICAgdHlwZV86IGlzQXJyYXkyID8gMSA6IDAsCiAgICAvLyBUcmFjayB3aGljaCBwcm9kdWNlIGNhbGwgdGhpcyBpcyBhc3NvY2lhdGVkIHdpdGguCiAgICBzY29wZV86IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUyKCksCiAgICAvLyBUcnVlIGZvciBib3RoIHNoYWxsb3cgYW5kIGRlZXAgY2hhbmdlcy4KICAgIG1vZGlmaWVkXzogZmFsc2UsCiAgICAvLyBVc2VkIGR1cmluZyBmaW5hbGl6YXRpb24uCiAgICBmaW5hbGl6ZWRfOiBmYWxzZSwKICAgIC8vIFRyYWNrIHdoaWNoIHByb3BlcnRpZXMgaGF2ZSBiZWVuIGFzc2lnbmVkICh0cnVlKSBvciBkZWxldGVkIChmYWxzZSkuCiAgICBhc3NpZ25lZF86IHt9LAogICAgLy8gVGhlIHBhcmVudCBkcmFmdCBzdGF0ZS4KICAgIHBhcmVudF86IHBhcmVudCwKICAgIC8vIFRoZSBiYXNlIHN0YXRlLgogICAgYmFzZV86IGJhc2UsCiAgICAvLyBUaGUgYmFzZSBwcm94eS4KICAgIGRyYWZ0XzogbnVsbCwKICAgIC8vIHNldCBiZWxvdwogICAgLy8gVGhlIGJhc2UgY29weSB3aXRoIGFueSB1cGRhdGVkIHZhbHVlcy4KICAgIGNvcHlfOiBudWxsLAogICAgLy8gQ2FsbGVkIGJ5IHRoZSBgcHJvZHVjZWAgZnVuY3Rpb24uCiAgICByZXZva2VfOiBudWxsLAogICAgaXNNYW51YWxfOiBmYWxzZQogIH07CiAgbGV0IHRhcmdldCA9IHN0YXRlOwogIGxldCB0cmFwcyA9IG9iamVjdFRyYXBzMjsKICBpZiAoaXNBcnJheTIpIHsKICAgIHRhcmdldCA9IFtzdGF0ZV07CiAgICB0cmFwcyA9IGFycmF5VHJhcHMyOwogIH0KICBjb25zdCB7IHJldm9rZSwgcHJveHkgfSA9IFByb3h5LnJldm9jYWJsZSh0YXJnZXQsIHRyYXBzKTsKICBzdGF0ZS5kcmFmdF8gPSBwcm94eTsKICBzdGF0ZS5yZXZva2VfID0gcmV2b2tlOwogIHJldHVybiBwcm94eTsKfQp2YXIgb2JqZWN0VHJhcHMyID0gewogIGdldChzdGF0ZSwgcHJvcCkgewogICAgaWYgKHByb3AgPT09IERSQUZUX1NUQVRFMikKICAgICAgcmV0dXJuIHN0YXRlOwogICAgY29uc3Qgc291cmNlID0gbGF0ZXN0MihzdGF0ZSk7CiAgICBpZiAoIWhhczIoc291cmNlLCBwcm9wKSkgewogICAgICByZXR1cm4gcmVhZFByb3BGcm9tUHJvdG8yKHN0YXRlLCBzb3VyY2UsIHByb3ApOwogICAgfQogICAgY29uc3QgdmFsdWUgPSBzb3VyY2VbcHJvcF07CiAgICBpZiAoc3RhdGUuZmluYWxpemVkXyB8fCAhaXNEcmFmdGFibGUyKHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodmFsdWUgPT09IHBlZWsyKHN0YXRlLmJhc2VfLCBwcm9wKSkgewogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICByZXR1cm4gc3RhdGUuY29weV9bcHJvcF0gPSBjcmVhdGVQcm94eTIodmFsdWUsIHN0YXRlKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9LAogIGhhcyhzdGF0ZSwgcHJvcCkgewogICAgcmV0dXJuIHByb3AgaW4gbGF0ZXN0MihzdGF0ZSk7CiAgfSwKICBvd25LZXlzKHN0YXRlKSB7CiAgICByZXR1cm4gUmVmbGVjdC5vd25LZXlzKGxhdGVzdDIoc3RhdGUpKTsKICB9LAogIHNldChzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICAgIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihsYXRlc3QyKHN0YXRlKSwgcHJvcCk7CiAgICBpZiAoZGVzYz8uc2V0KSB7CiAgICAgIGRlc2Muc2V0LmNhbGwoc3RhdGUuZHJhZnRfLCB2YWx1ZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgICAgY29uc3QgY3VycmVudDIyID0gcGVlazIobGF0ZXN0MihzdGF0ZSksIHByb3ApOwogICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBjdXJyZW50MjI/LltEUkFGVF9TVEFURTJdOwogICAgICBpZiAoY3VycmVudFN0YXRlICYmIGN1cnJlbnRTdGF0ZS5iYXNlXyA9PT0gdmFsdWUpIHsKICAgICAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpczIodmFsdWUsIGN1cnJlbnQyMikgJiYgKHZhbHVlICE9PSB2b2lkIDAgfHwgaGFzMihzdGF0ZS5iYXNlXywgcHJvcCkpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUpOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfW3Byb3BdID09PSB2YWx1ZSAmJiAvLyBzcGVjaWFsIGNhc2U6IGhhbmRsZSBuZXcgcHJvcHMgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJwogICAgKHZhbHVlICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5jb3B5XykgfHwgLy8gc3BlY2lhbCBjYXNlOiBOYU4KICAgIE51bWJlci5pc05hTih2YWx1ZSkgJiYgTnVtYmVyLmlzTmFOKHN0YXRlLmNvcHlfW3Byb3BdKSkKICAgICAgcmV0dXJuIHRydWU7CiAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gdHJ1ZTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgZGVsZXRlUHJvcGVydHkoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwZWVrMihzdGF0ZS5iYXNlXywgcHJvcCkgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmJhc2VfKSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IGZhbHNlOwogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgZGVsZXRlIHN0YXRlLmFzc2lnbmVkX1twcm9wXTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5XykgewogICAgICBkZWxldGUgc3RhdGUuY29weV9bcHJvcF07CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8vIE5vdGU6IFdlIG5ldmVyIGNvZXJjZSBgZGVzYy52YWx1ZWAgaW50byBhbiBJbW1lciBkcmFmdCwgYmVjYXVzZSB3ZSBjYW4ndCBtYWtlCiAgLy8gdGhlIHNhbWUgZ3VhcmFudGVlIGluIEVTNSBtb2RlLgogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihzdGF0ZSwgcHJvcCkgewogICAgY29uc3Qgb3duZXIgPSBsYXRlc3QyKHN0YXRlKTsKICAgIGNvbnN0IGRlc2MgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgcHJvcCk7CiAgICBpZiAoIWRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcmV0dXJuIHsKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogc3RhdGUudHlwZV8gIT09IDEgfHwgcHJvcCAhPT0gImxlbmd0aCIsCiAgICAgIGVudW1lcmFibGU6IGRlc2MuZW51bWVyYWJsZSwKICAgICAgdmFsdWU6IG93bmVyW3Byb3BdCiAgICB9OwogIH0sCiAgZGVmaW5lUHJvcGVydHkoKSB7CiAgICBkaWUyKDExKTsKICB9LAogIGdldFByb3RvdHlwZU9mKHN0YXRlKSB7CiAgICByZXR1cm4gZ2V0UHJvdG90eXBlT2YyKHN0YXRlLmJhc2VfKTsKICB9LAogIHNldFByb3RvdHlwZU9mKCkgewogICAgZGllMigxMik7CiAgfQp9Owp2YXIgYXJyYXlUcmFwczIgPSB7fTsKZWFjaDIob2JqZWN0VHJhcHMyLCAoa2V5LCBmbikgPT4gewogIGFycmF5VHJhcHMyW2tleV0gPSBmdW5jdGlvbigpIHsKICAgIGFyZ3VtZW50c1swXSA9IGFyZ3VtZW50c1swXVswXTsKICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07Cn0pOwphcnJheVRyYXBzMi5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wKSB7CiAgaWYgKGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZTIoMTMpOwogIHJldHVybiBhcnJheVRyYXBzMi5zZXQuY2FsbCh0aGlzLCBzdGF0ZSwgcHJvcCwgdm9pZCAwKTsKfTsKYXJyYXlUcmFwczIuc2V0ID0gZnVuY3Rpb24oc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgaWYgKHByb3AgIT09ICJsZW5ndGgiICYmIGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZTIoMTQpOwogIHJldHVybiBvYmplY3RUcmFwczIuc2V0LmNhbGwodGhpcywgc3RhdGVbMF0sIHByb3AsIHZhbHVlLCBzdGF0ZVswXSk7Cn07CmZ1bmN0aW9uIHBlZWsyKGRyYWZ0LCBwcm9wKSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURTJdOwogIGNvbnN0IHNvdXJjZSA9IHN0YXRlID8gbGF0ZXN0MihzdGF0ZSkgOiBkcmFmdDsKICByZXR1cm4gc291cmNlW3Byb3BdOwp9CmZ1bmN0aW9uIHJlYWRQcm9wRnJvbVByb3RvMihzdGF0ZSwgc291cmNlLCBwcm9wKSB7CiAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKHNvdXJjZSwgcHJvcCk7CiAgcmV0dXJuIGRlc2MgPyBgdmFsdWVgIGluIGRlc2MgPyBkZXNjLnZhbHVlIDogKAogICAgLy8gVGhpcyBpcyBhIHZlcnkgc3BlY2lhbCBjYXNlLCBpZiB0aGUgcHJvcCBpcyBhIGdldHRlciBkZWZpbmVkIGJ5IHRoZQogICAgLy8gcHJvdG90eXBlLCB3ZSBzaG91bGQgaW52b2tlIGl0IHdpdGggdGhlIGRyYWZ0IGFzIGNvbnRleHQhCiAgICBkZXNjLmdldD8uY2FsbChzdGF0ZS5kcmFmdF8pCiAgKSA6IHZvaWQgMDsKfQpmdW5jdGlvbiBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihzb3VyY2UsIHByb3ApIHsKICBpZiAoIShwcm9wIGluIHNvdXJjZSkpCiAgICByZXR1cm4gdm9pZCAwOwogIGxldCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIoc291cmNlKTsKICB3aGlsZSAocHJvdG8yKSB7CiAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bzIsIHByb3ApOwogICAgaWYgKGRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKHByb3RvMik7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFya0NoYW5nZWQyKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHN0YXRlLm1vZGlmaWVkXyA9IHRydWU7CiAgICBpZiAoc3RhdGUucGFyZW50XykgewogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUucGFyZW50Xyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHByZXBhcmVDb3B5MihzdGF0ZSkgewogIGlmICghc3RhdGUuY29weV8pIHsKICAgIHN0YXRlLmNvcHlfID0gc2hhbGxvd0NvcHkyKAogICAgICBzdGF0ZS5iYXNlXywKICAgICAgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8KICAgICk7CiAgfQp9CnZhciBJbW1lcjIyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbmZpZykgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHRydWU7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IGZhbHNlOwogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gdHJ1ZTsKICAgIHRoaXMucHJvZHVjZSA9IChiYXNlLCByZWNpcGUsIHBhdGNoTGlzdGVuZXIpID0+IHsKICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiByZWNpcGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjb25zdCBkZWZhdWx0QmFzZSA9IHJlY2lwZTsKICAgICAgICByZWNpcGUgPSBiYXNlOwogICAgICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gY3VycmllZFByb2R1Y2UoYmFzZTIgPSBkZWZhdWx0QmFzZSwgLi4uYXJncykgewogICAgICAgICAgcmV0dXJuIHNlbGYyLnByb2R1Y2UoYmFzZTIsIChkcmFmdCkgPT4gcmVjaXBlLmNhbGwodGhpcywgZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVjaXBlICE9PSAiZnVuY3Rpb24iKQogICAgICAgIGRpZTIoNik7CiAgICAgIGlmIChwYXRjaExpc3RlbmVyICE9PSB2b2lkIDAgJiYgdHlwZW9mIHBhdGNoTGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgZGllMig3KTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGlzRHJhZnRhYmxlMihiYXNlKSkgewogICAgICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZTIodGhpcyk7CiAgICAgICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eTIoYmFzZSwgdm9pZCAwKTsKICAgICAgICBsZXQgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSByZWNpcGUocHJveHkpOwogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKQogICAgICAgICAgICByZXZva2VTY29wZTIoc2NvcGUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgICAgICAgfQogICAgICAgIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQyKHJlc3VsdCwgc2NvcGUpOwogICAgICB9IGVsc2UgaWYgKCFiYXNlIHx8IHR5cGVvZiBiYXNlICE9PSAib2JqZWN0IikgewogICAgICAgIHJlc3VsdCA9IHJlY2lwZShiYXNlKTsKICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApCiAgICAgICAgICByZXN1bHQgPSBiYXNlOwogICAgICAgIGlmIChyZXN1bHQgPT09IE5PVEhJTkcyKQogICAgICAgICAgcmVzdWx0ID0gdm9pZCAwOwogICAgICAgIGlmICh0aGlzLmF1dG9GcmVlemVfKQogICAgICAgICAgZnJlZXplMihyZXN1bHQsIHRydWUpOwogICAgICAgIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBjb25zdCBpcCA9IFtdOwogICAgICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXyhiYXNlLCByZXN1bHQsIHAsIGlwKTsKICAgICAgICAgIHBhdGNoTGlzdGVuZXIocCwgaXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9IGVsc2UKICAgICAgICBkaWUyKDEsIGJhc2UpOwogICAgfTsKICAgIHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzID0gKGJhc2UsIHJlY2lwZSkgPT4gewogICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLCAuLi5hcmdzKSA9PiB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyhzdGF0ZSwgKGRyYWZ0KSA9PiBiYXNlKGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgIH0KICAgICAgbGV0IHBhdGNoZXMsIGludmVyc2VQYXRjaGVzOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnByb2R1Y2UoYmFzZSwgcmVjaXBlLCAocCwgaXApID0+IHsKICAgICAgICBwYXRjaGVzID0gcDsKICAgICAgICBpbnZlcnNlUGF0Y2hlcyA9IGlwOwogICAgICB9KTsKICAgICAgcmV0dXJuIFtyZXN1bHQsIHBhdGNoZXMsIGludmVyc2VQYXRjaGVzXTsKICAgIH07CiAgICBpZiAodHlwZW9mIGNvbmZpZz8uYXV0b0ZyZWV6ZSA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldEF1dG9GcmVlemUoY29uZmlnLmF1dG9GcmVlemUpOwogICAgaWYgKHR5cGVvZiBjb25maWc/LnVzZVN0cmljdFNoYWxsb3dDb3B5ID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkoY29uZmlnLnVzZVN0cmljdFNoYWxsb3dDb3B5KTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy51c2VTdHJpY3RJdGVyYXRpb24gPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RJdGVyYXRpb24oY29uZmlnLnVzZVN0cmljdEl0ZXJhdGlvbik7CiAgfQogIGNyZWF0ZURyYWZ0KGJhc2UpIHsKICAgIGlmICghaXNEcmFmdGFibGUyKGJhc2UpKQogICAgICBkaWUyKDgpOwogICAgaWYgKGlzRHJhZnQyKGJhc2UpKQogICAgICBiYXNlID0gY3VycmVudDIoYmFzZSk7CiAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUyKHRoaXMpOwogICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eTIoYmFzZSwgdm9pZCAwKTsKICAgIHByb3h5W0RSQUZUX1NUQVRFMl0uaXNNYW51YWxfID0gdHJ1ZTsKICAgIGxlYXZlU2NvcGUyKHNjb3BlKTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZmluaXNoRHJhZnQoZHJhZnQsIHBhdGNoTGlzdGVuZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gZHJhZnQgJiYgZHJhZnRbRFJBRlRfU1RBVEUyXTsKICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmlzTWFudWFsXykKICAgICAgZGllMig5KTsKICAgIGNvbnN0IHsgc2NvcGVfOiBzY29wZSB9ID0gc3RhdGU7CiAgICB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQyKHZvaWQgMCwgc2NvcGUpOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gYXV0b21hdGljYWxseSBmcmVlemUgYWxsIGNvcGllcyBjcmVhdGVkIGJ5IEltbWVyLgogICAqCiAgICogQnkgZGVmYXVsdCwgYXV0by1mcmVlemluZyBpcyBlbmFibGVkLgogICAqLwogIHNldEF1dG9GcmVlemUodmFsdWUpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGVuYWJsZSBzdHJpY3Qgc2hhbGxvdyBjb3B5LgogICAqCiAgICogQnkgZGVmYXVsdCwgaW1tZXIgZG9lcyBub3QgY29weSB0aGUgb2JqZWN0IGRlc2NyaXB0b3JzIHN1Y2ggYXMgZ2V0dGVyLCBzZXR0ZXIgYW5kIG5vbi1lbnVtcmFibGUgcHJvcGVydGllcy4KICAgKi8KICBzZXRVc2VTdHJpY3RTaGFsbG93Q29weSh2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyBmYWxzZSB0byB1c2UgZmFzdGVyIGl0ZXJhdGlvbiB0aGF0IHNraXBzIG5vbi1lbnVtZXJhYmxlIHByb3BlcnRpZXMKICAgKiBidXQgc3RpbGwgaGFuZGxlcyBzeW1ib2xzIGZvciBjb21wYXRpYmlsaXR5LgogICAqCiAgICogQnkgZGVmYXVsdCwgc3RyaWN0IGl0ZXJhdGlvbiBpcyBlbmFibGVkIChpbmNsdWRlcyBhbGwgb3duIHByb3BlcnRpZXMpLgogICAqLwogIHNldFVzZVN0cmljdEl0ZXJhdGlvbih2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gdmFsdWU7CiAgfQogIHNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl87CiAgfQogIGFwcGx5UGF0Y2hlcyhiYXNlLCBwYXRjaGVzKSB7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IHBhdGNoZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcGF0Y2ggPSBwYXRjaGVzW2ldOwogICAgICBpZiAocGF0Y2gucGF0aC5sZW5ndGggPT09IDAgJiYgcGF0Y2gub3AgPT09ICJyZXBsYWNlIikgewogICAgICAgIGJhc2UgPSBwYXRjaC52YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKGkgPiAtMSkgewogICAgICBwYXRjaGVzID0gcGF0Y2hlcy5zbGljZShpICsgMSk7CiAgICB9CiAgICBjb25zdCBhcHBseVBhdGNoZXNJbXBsID0gZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmFwcGx5UGF0Y2hlc187CiAgICBpZiAoaXNEcmFmdDIoYmFzZSkpIHsKICAgICAgcmV0dXJuIGFwcGx5UGF0Y2hlc0ltcGwoYmFzZSwgcGF0Y2hlcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9kdWNlKAogICAgICBiYXNlLAogICAgICAoZHJhZnQpID0+IGFwcGx5UGF0Y2hlc0ltcGwoZHJhZnQsIHBhdGNoZXMpCiAgICApOwogIH0KfTsKZnVuY3Rpb24gY3JlYXRlUHJveHkyKHZhbHVlLCBwYXJlbnQpIHsKICBjb25zdCBkcmFmdCA9IGlzTWFwMih2YWx1ZSkgPyBnZXRQbHVnaW4yKCJNYXBTZXQiKS5wcm94eU1hcF8odmFsdWUsIHBhcmVudCkgOiBpc1NldDIodmFsdWUpID8gZ2V0UGx1Z2luMigiTWFwU2V0IikucHJveHlTZXRfKHZhbHVlLCBwYXJlbnQpIDogY3JlYXRlUHJveHlQcm94eTIodmFsdWUsIHBhcmVudCk7CiAgY29uc3Qgc2NvcGUgPSBwYXJlbnQgPyBwYXJlbnQuc2NvcGVfIDogZ2V0Q3VycmVudFNjb3BlMigpOwogIHNjb3BlLmRyYWZ0c18ucHVzaChkcmFmdCk7CiAgcmV0dXJuIGRyYWZ0Owp9CmZ1bmN0aW9uIGN1cnJlbnQyKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0Mih2YWx1ZSkpCiAgICBkaWUyKDEwLCB2YWx1ZSk7CiAgcmV0dXJuIGN1cnJlbnRJbXBsMih2YWx1ZSk7Cn0KZnVuY3Rpb24gY3VycmVudEltcGwyKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0YWJsZTIodmFsdWUpIHx8IGlzRnJvemVuMih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURTJdOwogIGxldCBjb3B5MzsKICBsZXQgc3RyaWN0ID0gdHJ1ZTsKICBpZiAoc3RhdGUpIHsKICAgIGlmICghc3RhdGUubW9kaWZpZWRfKQogICAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkyKHZhbHVlLCBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5Xyk7CiAgICBzdHJpY3QgPSBzdGF0ZS5zY29wZV8uaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIH0gZWxzZSB7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5Mih2YWx1ZSwgdHJ1ZSk7CiAgfQogIGVhY2gyKAogICAgY29weTMsCiAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiB7CiAgICAgIHNldDIoY29weTMsIGtleSwgY3VycmVudEltcGwyKGNoaWxkVmFsdWUpKTsKICAgIH0sCiAgICBzdHJpY3QKICApOwogIGlmIChzdGF0ZSkgewogICAgc3RhdGUuZmluYWxpemVkXyA9IGZhbHNlOwogIH0KICByZXR1cm4gY29weTM7Cn0KdmFyIGltbWVyMiA9IG5ldyBJbW1lcjIyKCk7CnZhciBwcm9kdWNlMiA9IGltbWVyMi5wcm9kdWNlOwpmdW5jdGlvbiBjYXN0RHJhZnQodmFsdWUpIHsKICByZXR1cm4gdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbGVnZW5kU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTIgPSB7CiAgc2V0dGluZ3M6IHsKICAgIGxheW91dDogImhvcml6b250YWwiLAogICAgYWxpZ246ICJjZW50ZXIiLAogICAgdmVydGljYWxBbGlnbjogIm1pZGRsZSIsCiAgICBpdGVtU29ydGVyOiAidmFsdWUiCiAgfSwKICBzaXplOiB7CiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgcGF5bG9hZDogW10KfTsKdmFyIGxlZ2VuZFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJsZWdlbmQiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMiwKICByZWR1Y2VyczogewogICAgc2V0TGVnZW5kU2l6ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNpemUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuc2l6ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TGVnZW5kU2V0dGluZ3Moc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zZXR0aW5ncy5hbGlnbiA9IGFjdGlvbi5wYXlsb2FkLmFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5sYXlvdXQgPSBhY3Rpb24ucGF5bG9hZC5sYXlvdXQ7CiAgICAgIHN0YXRlLnNldHRpbmdzLnZlcnRpY2FsQWxpZ24gPSBhY3Rpb24ucGF5bG9hZC52ZXJ0aWNhbEFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5pdGVtU29ydGVyID0gYWN0aW9uLnBheWxvYWQuaXRlbVNvcnRlcjsKICAgIH0sCiAgICBhZGRMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBheWxvYWQucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucGF5bG9hZC5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWRbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUucGF5bG9hZC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldExlZ2VuZFNpemUsCiAgc2V0TGVnZW5kU2V0dGluZ3MsCiAgYWRkTGVnZW5kUGF5bG9hZCwKICByZXBsYWNlTGVnZW5kUGF5bG9hZCwKICByZW1vdmVMZWdlbmRQYXlsb2FkCn0gPSBsZWdlbmRTbGljZS5hY3Rpb25zOwp2YXIgbGVnZW5kUmVkdWNlciA9IGxlZ2VuZFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Ub29sdGlwLmpzCnZhciBSZWFjdDEyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3RfZG9tMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdF9kb20oKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9EZWZhdWx0VG9vbHRpcENvbnRlbnQuanMKdmFyIFJlYWN0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9zb3J0QnkzID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CmZ1bmN0aW9uIF9leHRlbmRzNCgpIHsKICByZXR1cm4gX2V4dGVuZHM0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM0LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZGVmYXVsdEZvcm1hdHRlcih2YWx1ZSkgewogIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiBpc051bU9yU3RyKHZhbHVlWzBdKSAmJiBpc051bU9yU3RyKHZhbHVlWzFdKSA/IHZhbHVlLmpvaW4oIiB+ICIpIDogdmFsdWU7Cn0KdmFyIERlZmF1bHRUb29sdGlwQ29udGVudCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBzZXBhcmF0b3IgPSAiIDogIiwKICAgIGNvbnRlbnRTdHlsZSA9IHt9LAogICAgaXRlbVN0eWxlID0ge30sCiAgICBsYWJlbFN0eWxlID0ge30sCiAgICBwYXlsb2FkLAogICAgZm9ybWF0dGVyLAogICAgaXRlbVNvcnRlciwKICAgIHdyYXBwZXJDbGFzc05hbWUsCiAgICBsYWJlbENsYXNzTmFtZSwKICAgIGxhYmVsLAogICAgbGFiZWxGb3JtYXR0ZXIsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXIgPSBmYWxzZQogIH0gPSBwcm9wczsKICB2YXIgcmVuZGVyQ29udGVudDIgPSAoKSA9PiB7CiAgICBpZiAocGF5bG9hZCAmJiBwYXlsb2FkLmxlbmd0aCkgewogICAgICB2YXIgbGlzdFN0eWxlID0gewogICAgICAgIHBhZGRpbmc6IDAsCiAgICAgICAgbWFyZ2luOiAwCiAgICAgIH07CiAgICAgIHZhciBpdGVtcyA9IChpdGVtU29ydGVyID8gKDAsIGltcG9ydF9zb3J0QnkzLmRlZmF1bHQpKHBheWxvYWQsIGl0ZW1Tb3J0ZXIpIDogcGF5bG9hZCkubWFwKChlbnRyeSwgaSkgPT4gewogICAgICAgIGlmIChlbnRyeS50eXBlID09PSAibm9uZSIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZmluYWxGb3JtYXR0ZXIgPSBlbnRyeS5mb3JtYXR0ZXIgfHwgZm9ybWF0dGVyIHx8IGRlZmF1bHRGb3JtYXR0ZXI7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgbmFtZQogICAgICAgIH0gPSBlbnRyeTsKICAgICAgICB2YXIgZmluYWxWYWx1ZSA9IHZhbHVlOwogICAgICAgIHZhciBmaW5hbE5hbWUgPSBuYW1lOwogICAgICAgIGlmIChmaW5hbEZvcm1hdHRlcikgewogICAgICAgICAgdmFyIGZvcm1hdHRlZCA9IGZpbmFsRm9ybWF0dGVyKHZhbHVlLCBuYW1lLCBlbnRyeSwgaSwgcGF5bG9hZCk7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmb3JtYXR0ZWQpKSB7CiAgICAgICAgICAgIFtmaW5hbFZhbHVlLCBmaW5hbE5hbWVdID0gZm9ybWF0dGVkOwogICAgICAgICAgfSBlbHNlIGlmIChmb3JtYXR0ZWQgIT0gbnVsbCkgewogICAgICAgICAgICBmaW5hbFZhbHVlID0gZm9ybWF0dGVkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5hbEl0ZW1TdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgICAgICAgIGRpc3BsYXk6ICJibG9jayIsCiAgICAgICAgICBwYWRkaW5nVG9wOiA0LAogICAgICAgICAgcGFkZGluZ0JvdHRvbTogNCwKICAgICAgICAgIGNvbG9yOiBlbnRyeS5jb2xvciB8fCAiIzAwMCIKICAgICAgICB9LCBpdGVtU3R5bGUpOwogICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoImxpIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtIiwKICAgICAgICAgIGtleTogInRvb2x0aXAtaXRlbS0iLmNvbmNhdChpKSwKICAgICAgICAgIHN0eWxlOiBmaW5hbEl0ZW1TdHlsZQogICAgICAgIH0sIGlzTnVtT3JTdHIoZmluYWxOYW1lKSA/IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1uYW1lIgogICAgICAgIH0sIGZpbmFsTmFtZSkgOiBudWxsLCBpc051bU9yU3RyKGZpbmFsTmFtZSkgPyAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tc2VwYXJhdG9yIgogICAgICAgIH0sIHNlcGFyYXRvcikgOiBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tdmFsdWUiCiAgICAgICAgfSwgZmluYWxWYWx1ZSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS11bml0IgogICAgICAgIH0sIGVudHJ5LnVuaXQgfHwgIiIpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInVsIiwgewogICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1saXN0IiwKICAgICAgICBzdHlsZTogbGlzdFN0eWxlCiAgICAgIH0sIGl0ZW1zKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CiAgdmFyIGZpbmFsU3R5bGUgPSBfb2JqZWN0U3ByZWFkNSh7CiAgICBtYXJnaW46IDAsCiAgICBwYWRkaW5nOiAxMCwKICAgIGJhY2tncm91bmRDb2xvcjogIiNmZmYiLAogICAgYm9yZGVyOiAiMXB4IHNvbGlkICNjY2MiLAogICAgd2hpdGVTcGFjZTogIm5vd3JhcCIKICB9LCBjb250ZW50U3R5bGUpOwogIHZhciBmaW5hbExhYmVsU3R5bGUgPSBfb2JqZWN0U3ByZWFkNSh7CiAgICBtYXJnaW46IDAKICB9LCBsYWJlbFN0eWxlKTsKICB2YXIgaGFzTGFiZWwgPSAhaXNOdWxsaXNoKGxhYmVsKTsKICB2YXIgZmluYWxMYWJlbCA9IGhhc0xhYmVsID8gbGFiZWwgOiAiIjsKICB2YXIgd3JhcHBlckNOID0gY2xzeCgicmVjaGFydHMtZGVmYXVsdC10b29sdGlwIiwgd3JhcHBlckNsYXNzTmFtZSk7CiAgdmFyIGxhYmVsQ04gPSBjbHN4KCJyZWNoYXJ0cy10b29sdGlwLWxhYmVsIiwgbGFiZWxDbGFzc05hbWUpOwogIGlmIChoYXNMYWJlbCAmJiBsYWJlbEZvcm1hdHRlciAmJiBwYXlsb2FkICE9PSB2b2lkIDAgJiYgcGF5bG9hZCAhPT0gbnVsbCkgewogICAgZmluYWxMYWJlbCA9IGxhYmVsRm9ybWF0dGVyKGxhYmVsLCBwYXlsb2FkKTsKICB9CiAgdmFyIGFjY2Vzc2liaWxpdHlBdHRyaWJ1dGVzID0gYWNjZXNzaWJpbGl0eUxheWVyID8gewogICAgcm9sZTogInN0YXR1cyIsCiAgICAiYXJpYS1saXZlIjogImFzc2VydGl2ZSIKICB9IDoge307CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHM0KHsKICAgIGNsYXNzTmFtZTogd3JhcHBlckNOLAogICAgc3R5bGU6IGZpbmFsU3R5bGUKICB9LCBhY2Nlc3NpYmlsaXR5QXR0cmlidXRlcyksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgicCIsIHsKICAgIGNsYXNzTmFtZTogbGFiZWxDTiwKICAgIHN0eWxlOiBmaW5hbExhYmVsU3R5bGUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmlzVmFsaWRFbGVtZW50KGZpbmFsTGFiZWwpID8gZmluYWxMYWJlbCA6ICIiLmNvbmNhdChmaW5hbExhYmVsKSksIHJlbmRlckNvbnRlbnQyKCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCnZhciBSZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC90b29sdGlwL3RyYW5zbGF0ZS5qcwp2YXIgQ1NTX0NMQVNTX1BSRUZJWCA9ICJyZWNoYXJ0cy10b29sdGlwLXdyYXBwZXIiOwp2YXIgVE9PTFRJUF9ISURERU4gPSB7CiAgdmlzaWJpbGl0eTogImhpZGRlbiIKfTsKZnVuY3Rpb24gZ2V0VG9vbHRpcENTU0NsYXNzTmFtZShfcmVmMikgewogIHZhciB7CiAgICBjb29yZGluYXRlLAogICAgdHJhbnNsYXRlWCwKICAgIHRyYW5zbGF0ZVkKICB9ID0gX3JlZjI7CiAgcmV0dXJuIGNsc3goQ1NTX0NMQVNTX1BSRUZJWCwgewogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLXJpZ2h0IildOiBpc051bWJlcih0cmFuc2xhdGVYKSAmJiBjb29yZGluYXRlICYmIGlzTnVtYmVyKGNvb3JkaW5hdGUueCkgJiYgdHJhbnNsYXRlWCA+PSBjb29yZGluYXRlLngsCiAgICBbIiIuY29uY2F0KENTU19DTEFTU19QUkVGSVgsICItbGVmdCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLngpICYmIHRyYW5zbGF0ZVggPCBjb29yZGluYXRlLngsCiAgICBbIiIuY29uY2F0KENTU19DTEFTU19QUkVGSVgsICItYm90dG9tIildOiBpc051bWJlcih0cmFuc2xhdGVZKSAmJiBjb29yZGluYXRlICYmIGlzTnVtYmVyKGNvb3JkaW5hdGUueSkgJiYgdHJhbnNsYXRlWSA+PSBjb29yZGluYXRlLnksCiAgICBbIiIuY29uY2F0KENTU19DTEFTU19QUkVGSVgsICItdG9wIildOiBpc051bWJlcih0cmFuc2xhdGVZKSAmJiBjb29yZGluYXRlICYmIGlzTnVtYmVyKGNvb3JkaW5hdGUueSkgJiYgdHJhbnNsYXRlWSA8IGNvb3JkaW5hdGUueQogIH0pOwp9CmZ1bmN0aW9uIGdldFRvb2x0aXBUcmFuc2xhdGVYWShfcmVmMikgewogIHZhciB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBjb29yZGluYXRlLAogICAga2V5LAogICAgb2Zmc2V0VG9wTGVmdCwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHRvb2x0aXBEaW1lbnNpb24sCiAgICB2aWV3Qm94LAogICAgdmlld0JveERpbWVuc2lvbgogIH0gPSBfcmVmMjsKICBpZiAocG9zaXRpb24gJiYgaXNOdW1iZXIocG9zaXRpb25ba2V5XSkpIHsKICAgIHJldHVybiBwb3NpdGlvbltrZXldOwogIH0KICB2YXIgbmVnYXRpdmUgPSBjb29yZGluYXRlW2tleV0gLSB0b29sdGlwRGltZW5zaW9uIC0gKG9mZnNldFRvcExlZnQgPiAwID8gb2Zmc2V0VG9wTGVmdCA6IDApOwogIHZhciBwb3NpdGl2ZSA9IGNvb3JkaW5hdGVba2V5XSArIG9mZnNldFRvcExlZnQ7CiAgaWYgKGFsbG93RXNjYXBlVmlld0JveFtrZXldKSB7CiAgICByZXR1cm4gcmV2ZXJzZURpcmVjdGlvbltrZXldID8gbmVnYXRpdmUgOiBwb3NpdGl2ZTsKICB9CiAgdmFyIHZpZXdCb3hLZXkgPSB2aWV3Qm94W2tleV07CiAgaWYgKHZpZXdCb3hLZXkgPT0gbnVsbCkgewogICAgcmV0dXJuIDA7CiAgfQogIGlmIChyZXZlcnNlRGlyZWN0aW9uW2tleV0pIHsKICAgIHZhciBfdG9vbHRpcEJvdW5kYXJ5ID0gbmVnYXRpdmU7CiAgICB2YXIgX3ZpZXdCb3hCb3VuZGFyeSA9IHZpZXdCb3hLZXk7CiAgICBpZiAoX3Rvb2x0aXBCb3VuZGFyeSA8IF92aWV3Qm94Qm91bmRhcnkpIHsKICAgICAgcmV0dXJuIE1hdGgubWF4KHBvc2l0aXZlLCB2aWV3Qm94S2V5KTsKICAgIH0KICAgIHJldHVybiBNYXRoLm1heChuZWdhdGl2ZSwgdmlld0JveEtleSk7CiAgfQogIGlmICh2aWV3Qm94RGltZW5zaW9uID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICB2YXIgdG9vbHRpcEJvdW5kYXJ5ID0gcG9zaXRpdmUgKyB0b29sdGlwRGltZW5zaW9uOwogIHZhciB2aWV3Qm94Qm91bmRhcnkgPSB2aWV3Qm94S2V5ICsgdmlld0JveERpbWVuc2lvbjsKICBpZiAodG9vbHRpcEJvdW5kYXJ5ID4gdmlld0JveEJvdW5kYXJ5KSB7CiAgICByZXR1cm4gTWF0aC5tYXgobmVnYXRpdmUsIHZpZXdCb3hLZXkpOwogIH0KICByZXR1cm4gTWF0aC5tYXgocG9zaXRpdmUsIHZpZXdCb3hLZXkpOwp9CmZ1bmN0aW9uIGdldFRyYW5zZm9ybVN0eWxlKF9yZWYzKSB7CiAgdmFyIHsKICAgIHRyYW5zbGF0ZVgsCiAgICB0cmFuc2xhdGVZLAogICAgdXNlVHJhbnNsYXRlM2QKICB9ID0gX3JlZjM7CiAgcmV0dXJuIHsKICAgIHRyYW5zZm9ybTogdXNlVHJhbnNsYXRlM2QgPyAidHJhbnNsYXRlM2QoIi5jb25jYXQodHJhbnNsYXRlWCwgInB4LCAiKS5jb25jYXQodHJhbnNsYXRlWSwgInB4LCAwKSIpIDogInRyYW5zbGF0ZSgiLmNvbmNhdCh0cmFuc2xhdGVYLCAicHgsICIpLmNvbmNhdCh0cmFuc2xhdGVZLCAicHgpIikKICB9Owp9CmZ1bmN0aW9uIGdldFRvb2x0aXBUcmFuc2xhdGUoX3JlZjQpIHsKICB2YXIgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgY29vcmRpbmF0ZSwKICAgIG9mZnNldFRvcExlZnQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB0b29sdGlwQm94LAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB2aWV3Qm94CiAgfSA9IF9yZWY0OwogIHZhciBjc3NQcm9wZXJ0aWVzLCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZOwogIGlmICh0b29sdGlwQm94LmhlaWdodCA+IDAgJiYgdG9vbHRpcEJveC53aWR0aCA+IDAgJiYgY29vcmRpbmF0ZSkgewogICAgdHJhbnNsYXRlWCA9IGdldFRvb2x0aXBUcmFuc2xhdGVYWSh7CiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgY29vcmRpbmF0ZSwKICAgICAga2V5OiAieCIsCiAgICAgIG9mZnNldFRvcExlZnQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwRGltZW5zaW9uOiB0b29sdGlwQm94LndpZHRoLAogICAgICB2aWV3Qm94LAogICAgICB2aWV3Qm94RGltZW5zaW9uOiB2aWV3Qm94LndpZHRoCiAgICB9KTsKICAgIHRyYW5zbGF0ZVkgPSBnZXRUb29sdGlwVHJhbnNsYXRlWFkoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGtleTogInkiLAogICAgICBvZmZzZXRUb3BMZWZ0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcERpbWVuc2lvbjogdG9vbHRpcEJveC5oZWlnaHQsCiAgICAgIHZpZXdCb3gsCiAgICAgIHZpZXdCb3hEaW1lbnNpb246IHZpZXdCb3guaGVpZ2h0CiAgICB9KTsKICAgIGNzc1Byb3BlcnRpZXMgPSBnZXRUcmFuc2Zvcm1TdHlsZSh7CiAgICAgIHRyYW5zbGF0ZVgsCiAgICAgIHRyYW5zbGF0ZVksCiAgICAgIHVzZVRyYW5zbGF0ZTNkCiAgICB9KTsKICB9IGVsc2UgewogICAgY3NzUHJvcGVydGllcyA9IFRPT0xUSVBfSElEREVOOwogIH0KICByZXR1cm4gewogICAgY3NzUHJvcGVydGllcywKICAgIGNzc0NsYXNzZXM6IGdldFRvb2x0aXBDU1NDbGFzc05hbWUoewogICAgICB0cmFuc2xhdGVYLAogICAgICB0cmFuc2xhdGVZLAogICAgICBjb29yZGluYXRlCiAgICB9KQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXBCb3VuZGluZ0JveC5qcwpmdW5jdGlvbiBvd25LZXlzNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTYodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgVG9vbHRpcEJvdW5kaW5nQm94ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3QxNC5QdXJlQ29tcG9uZW50IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICBfZGVmaW5lUHJvcGVydHk2KHRoaXMsICJzdGF0ZSIsIHsKICAgICAgZGlzbWlzc2VkOiBmYWxzZSwKICAgICAgZGlzbWlzc2VkQXRDb29yZGluYXRlOiB7CiAgICAgICAgeDogMCwKICAgICAgICB5OiAwCiAgICAgIH0KICAgIH0pOwogICAgX2RlZmluZVByb3BlcnR5Nih0aGlzLCAiaGFuZGxlS2V5RG93biIsIChldmVudCkgPT4gewogICAgICBpZiAoZXZlbnQua2V5ID09PSAiRXNjYXBlIikgewogICAgICAgIHZhciBfdGhpcyRwcm9wcyRjb29yZGluYXQsIF90aGlzJHByb3BzJGNvb3JkaW5hdDIsIF90aGlzJHByb3BzJGNvb3JkaW5hdDMsIF90aGlzJHByb3BzJGNvb3JkaW5hdDQ7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBkaXNtaXNzZWQ6IHRydWUsCiAgICAgICAgICBkaXNtaXNzZWRBdENvb3JkaW5hdGU6IHsKICAgICAgICAgICAgeDogKF90aGlzJHByb3BzJGNvb3JkaW5hdCA9IChfdGhpcyRwcm9wcyRjb29yZGluYXQyID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQyLngpICE9PSBudWxsICYmIF90aGlzJHByb3BzJGNvb3JkaW5hdCAhPT0gdm9pZCAwID8gX3RoaXMkcHJvcHMkY29vcmRpbmF0IDogMCwKICAgICAgICAgICAgeTogKF90aGlzJHByb3BzJGNvb3JkaW5hdDMgPSAoX3RoaXMkcHJvcHMkY29vcmRpbmF0NCA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0NC55KSAhPT0gbnVsbCAmJiBfdGhpcyRwcm9wcyRjb29yZGluYXQzICE9PSB2b2lkIDAgPyBfdGhpcyRwcm9wcyRjb29yZGluYXQzIDogMAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CiAgY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5oYW5kbGVLZXlEb3duKTsKICB9CiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5oYW5kbGVLZXlEb3duKTsKICB9CiAgY29tcG9uZW50RGlkVXBkYXRlKCkgewogICAgdmFyIF90aGlzJHByb3BzJGNvb3JkaW5hdDUsIF90aGlzJHByb3BzJGNvb3JkaW5hdDY7CiAgICBpZiAoIXRoaXMuc3RhdGUuZGlzbWlzc2VkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICgoKF90aGlzJHByb3BzJGNvb3JkaW5hdDUgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDUueCkgIT09IHRoaXMuc3RhdGUuZGlzbWlzc2VkQXRDb29yZGluYXRlLnggfHwgKChfdGhpcyRwcm9wcyRjb29yZGluYXQ2ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ2ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ2LnkpICE9PSB0aGlzLnN0YXRlLmRpc21pc3NlZEF0Q29vcmRpbmF0ZS55KSB7CiAgICAgIHRoaXMuc3RhdGUuZGlzbWlzc2VkID0gZmFsc2U7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIHZhciB7CiAgICAgIGFjdGl2ZSwKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgICAgYW5pbWF0aW9uRWFzaW5nLAogICAgICBjaGlsZHJlbiwKICAgICAgY29vcmRpbmF0ZSwKICAgICAgaGFzUGF5bG9hZCwKICAgICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICAgIG9mZnNldCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgICB2aWV3Qm94LAogICAgICB3cmFwcGVyU3R5bGUsCiAgICAgIGxhc3RCb3VuZGluZ0JveCwKICAgICAgaW5uZXJSZWYsCiAgICAgIGhhc1BvcnRhbEZyb21Qcm9wcwogICAgfSA9IHRoaXMucHJvcHM7CiAgICB2YXIgewogICAgICBjc3NDbGFzc2VzLAogICAgICBjc3NQcm9wZXJ0aWVzCiAgICB9ID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZSh7CiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgY29vcmRpbmF0ZSwKICAgICAgb2Zmc2V0VG9wTGVmdDogb2Zmc2V0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcEJveDogewogICAgICAgIGhlaWdodDogbGFzdEJvdW5kaW5nQm94LmhlaWdodCwKICAgICAgICB3aWR0aDogbGFzdEJvdW5kaW5nQm94LndpZHRoCiAgICAgIH0sCiAgICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgICB2aWV3Qm94CiAgICB9KTsKICAgIHZhciBwb3NpdGlvblN0eWxlcyA9IGhhc1BvcnRhbEZyb21Qcm9wcyA/IHt9IDogX29iamVjdFNwcmVhZDYoX29iamVjdFNwcmVhZDYoewogICAgICB0cmFuc2l0aW9uOiBpc0FuaW1hdGlvbkFjdGl2ZSAmJiBhY3RpdmUgPyAidHJhbnNmb3JtICIuY29uY2F0KGFuaW1hdGlvbkR1cmF0aW9uLCAibXMgIikuY29uY2F0KGFuaW1hdGlvbkVhc2luZykgOiB2b2lkIDAKICAgIH0sIGNzc1Byb3BlcnRpZXMpLCB7fSwgewogICAgICBwb2ludGVyRXZlbnRzOiAibm9uZSIsCiAgICAgIHZpc2liaWxpdHk6ICF0aGlzLnN0YXRlLmRpc21pc3NlZCAmJiBhY3RpdmUgJiYgaGFzUGF5bG9hZCA/ICJ2aXNpYmxlIiA6ICJoaWRkZW4iLAogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdG9wOiAwLAogICAgICBsZWZ0OiAwCiAgICB9KTsKICAgIHZhciBvdXRlclN0eWxlID0gX29iamVjdFNwcmVhZDYoX29iamVjdFNwcmVhZDYoe30sIHBvc2l0aW9uU3R5bGVzKSwge30sIHsKICAgICAgdmlzaWJpbGl0eTogIXRoaXMuc3RhdGUuZGlzbWlzc2VkICYmIGFjdGl2ZSAmJiBoYXNQYXlsb2FkID8gInZpc2libGUiIDogImhpZGRlbiIKICAgIH0sIHdyYXBwZXJTdHlsZSk7CiAgICByZXR1cm4gKAogICAgICAvLyBUaGlzIGVsZW1lbnQgYWxsb3cgbGlzdGVuaW5nIHRvIHRoZSBgRXNjYXBlYCBrZXkuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvcHVsbC8yOTI1CiAgICAgIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDYuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdHlwZXNjcmlwdCBsaWJyYXJ5IGRvZXMgbm90IHJlY29nbml6ZSB4bWxucyBhdHRyaWJ1dGUsIGJ1dCBpdCdzIHJlcXVpcmVkIGZvciBhbiBIVE1MIGNodW5rIGluc2lkZSBTVkcuCiAgICAgICAgeG1sbnM6ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiwKICAgICAgICB0YWJJbmRleDogLTEsCiAgICAgICAgY2xhc3NOYW1lOiBjc3NDbGFzc2VzLAogICAgICAgIHN0eWxlOiBvdXRlclN0eWxlLAogICAgICAgIHJlZjogaW5uZXJSZWYKICAgICAgfSwgY2hpbGRyZW4pCiAgICApOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9hY2Nlc3NpYmlsaXR5Q29udGV4dC5qcwp2YXIgdXNlQWNjZXNzaWJpbGl0eUxheWVyID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHRydWU7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9DdXJzb3IuanMKdmFyIFJlYWN0MTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvQ3VydmUuanMKdmFyIFJlYWN0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHM1KCkgewogIHJldHVybiBfZXh0ZW5kczUgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDcoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czcoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgQ1VSVkVfRkFDVE9SSUVTID0gewogIGN1cnZlQmFzaXNDbG9zZWQ6IGJhc2lzQ2xvc2VkX2RlZmF1bHQsCiAgY3VydmVCYXNpc09wZW46IGJhc2lzT3Blbl9kZWZhdWx0LAogIGN1cnZlQmFzaXM6IGJhc2lzX2RlZmF1bHQsCiAgY3VydmVCdW1wWDogYnVtcFgsCiAgY3VydmVCdW1wWTogYnVtcFksCiAgY3VydmVMaW5lYXJDbG9zZWQ6IGxpbmVhckNsb3NlZF9kZWZhdWx0LAogIGN1cnZlTGluZWFyOiBsaW5lYXJfZGVmYXVsdCwKICBjdXJ2ZU1vbm90b25lWDogbW9ub3RvbmVYLAogIGN1cnZlTW9ub3RvbmVZOiBtb25vdG9uZVksCiAgY3VydmVOYXR1cmFsOiBuYXR1cmFsX2RlZmF1bHQsCiAgY3VydmVTdGVwOiBzdGVwX2RlZmF1bHQsCiAgY3VydmVTdGVwQWZ0ZXI6IHN0ZXBBZnRlciwKICBjdXJ2ZVN0ZXBCZWZvcmU6IHN0ZXBCZWZvcmUKfTsKdmFyIGRlZmluZWQgPSAocCkgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihwLngpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIocC55KTsKdmFyIGFyZWFEZWZpbmVkID0gKGQpID0+IGQuYmFzZSAhPSBudWxsICYmIGRlZmluZWQoZC5iYXNlKSAmJiBkZWZpbmVkKGQpOwp2YXIgZ2V0WCA9IChwKSA9PiBwLng7CnZhciBnZXRZID0gKHApID0+IHAueTsKdmFyIGdldEN1cnZlRmFjdG9yeSA9ICh0eXBlLCBsYXlvdXQpID0+IHsKICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB0eXBlOwogIH0KICB2YXIgbmFtZSA9ICJjdXJ2ZSIuY29uY2F0KHVwcGVyRmlyc3QodHlwZSkpOwogIGlmICgobmFtZSA9PT0gImN1cnZlTW9ub3RvbmUiIHx8IG5hbWUgPT09ICJjdXJ2ZUJ1bXAiKSAmJiBsYXlvdXQpIHsKICAgIHJldHVybiBDVVJWRV9GQUNUT1JJRVNbIiIuY29uY2F0KG5hbWUpLmNvbmNhdChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgPyAiWSIgOiAiWCIpXTsKICB9CiAgcmV0dXJuIENVUlZFX0ZBQ1RPUklFU1tuYW1lXSB8fCBsaW5lYXJfZGVmYXVsdDsKfTsKdmFyIGdldFBhdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgdHlwZSA9ICJsaW5lYXIiLAogICAgcG9pbnRzID0gW10sCiAgICBiYXNlTGluZSwKICAgIGxheW91dCwKICAgIGNvbm5lY3ROdWxscyA9IGZhbHNlCiAgfSA9IF9yZWYyOwogIHZhciBjdXJ2ZUZhY3RvcnkgPSBnZXRDdXJ2ZUZhY3RvcnkodHlwZSwgbGF5b3V0KTsKICB2YXIgZm9ybWF0UG9pbnRzID0gY29ubmVjdE51bGxzID8gcG9pbnRzLmZpbHRlcihkZWZpbmVkKSA6IHBvaW50czsKICB2YXIgbGluZUZ1bmN0aW9uOwogIGlmIChBcnJheS5pc0FycmF5KGJhc2VMaW5lKSkgewogICAgdmFyIGFyZWFQb2ludHMgPSBwb2ludHMubWFwKChlbnRyeSwgaW5kZXgpID0+IF9vYmplY3RTcHJlYWQ3KF9vYmplY3RTcHJlYWQ3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgIGJhc2U6IGJhc2VMaW5lW2luZGV4XQogICAgfSkpOwogICAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS55KGdldFkpLngxKGdldFgpLngwKChkKSA9PiBkLmJhc2UueCk7CiAgICB9IGVsc2UgewogICAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS54KGdldFgpLnkxKGdldFkpLnkwKChkKSA9PiBkLmJhc2UueSk7CiAgICB9CiAgICB2YXIgX251bGxhYmxlTGluZUZ1bmN0aW9uID0gbGluZUZ1bmN0aW9uLmRlZmluZWQoYXJlYURlZmluZWQpLmN1cnZlKGN1cnZlRmFjdG9yeSk7CiAgICB2YXIgZmluYWxQb2ludHMgPSBjb25uZWN0TnVsbHMgPyBhcmVhUG9pbnRzLmZpbHRlcihhcmVhRGVmaW5lZCkgOiBhcmVhUG9pbnRzOwogICAgcmV0dXJuIF9udWxsYWJsZUxpbmVGdW5jdGlvbihmaW5hbFBvaW50cyk7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgJiYgaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS55KGdldFkpLngxKGdldFgpLngwKGJhc2VMaW5lKTsKICB9IGVsc2UgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueChnZXRYKS55MShnZXRZKS55MChiYXNlTGluZSk7CiAgfSBlbHNlIHsKICAgIGxpbmVGdW5jdGlvbiA9IGxpbmVfZGVmYXVsdCgpLngoZ2V0WCkueShnZXRZKTsKICB9CiAgdmFyIG51bGxhYmxlTGluZUZ1bmN0aW9uID0gbGluZUZ1bmN0aW9uLmRlZmluZWQoZGVmaW5lZCkuY3VydmUoY3VydmVGYWN0b3J5KTsKICByZXR1cm4gbnVsbGFibGVMaW5lRnVuY3Rpb24oZm9ybWF0UG9pbnRzKTsKfTsKdmFyIEN1cnZlID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGNsYXNzTmFtZSwKICAgIHBvaW50cywKICAgIHBhdGg6IHBhdGgyLAogICAgcGF0aFJlZgogIH0gPSBwcm9wczsKICBpZiAoKCFwb2ludHMgfHwgIXBvaW50cy5sZW5ndGgpICYmICFwYXRoMikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByZWFsUGF0aCA9IHBvaW50cyAmJiBwb2ludHMubGVuZ3RoID8gZ2V0UGF0aChwcm9wcykgOiBwYXRoMjsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Ny5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM1KHt9LCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpLCBhZGFwdEV2ZW50SGFuZGxlcnMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWN1cnZlIiwgY2xhc3NOYW1lKSwKICAgIGQ6IHJlYWxQYXRoID09PSBudWxsID8gdm9pZCAwIDogcmVhbFBhdGgsCiAgICByZWY6IHBhdGhSZWYKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0Nyb3NzLmpzCnZhciBSZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQzID0gWyJ4IiwgInkiLCAidG9wIiwgImxlZnQiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSJdOwpmdW5jdGlvbiBfZXh0ZW5kczYoKSB7CiAgcmV0dXJuIF9leHRlbmRzNiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTgoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5OChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTgocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5OCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTgodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBnZXRQYXRoMiA9ICh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkgPT4gewogIHJldHVybiAiTSIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh0b3AsICJ2IikuY29uY2F0KGhlaWdodCwgIk0iKS5jb25jYXQobGVmdCwgIiwiKS5jb25jYXQoeTIsICJoIikuY29uY2F0KHdpZHRoKTsKfTsKdmFyIENyb3NzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyID0gMCwKICAgIHk6IHkyID0gMCwKICAgIHRvcCA9IDAsCiAgICBsZWZ0ID0gMCwKICAgIHdpZHRoID0gMCwKICAgIGhlaWdodCA9IDAsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMzKF9yZWYyLCBfZXhjbHVkZWQzKTsKICB2YXIgcHJvcHMgPSBfb2JqZWN0U3ByZWFkOCh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdG9wLAogICAgbGVmdCwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSwgcmVzdCk7CiAgaWYgKCFpc051bWJlcih4MikgfHwgIWlzTnVtYmVyKHkyKSB8fCAhaXNOdW1iZXIod2lkdGgpIHx8ICFpc051bWJlcihoZWlnaHQpIHx8ICFpc051bWJlcih0b3ApIHx8ICFpc051bWJlcihsZWZ0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q4LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczYoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNyb3NzIiwgY2xhc3NOYW1lKSwKICAgIGQ6IGdldFBhdGgyKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgdG9wLCBsZWZ0KQogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0Q3Vyc29yUmVjdGFuZ2xlLmpzCmZ1bmN0aW9uIGdldEN1cnNvclJlY3RhbmdsZShsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCwgdG9vbHRpcEF4aXNCYW5kU2l6ZSkgewogIHZhciBoYWxmU2l6ZSA9IHRvb2x0aXBBeGlzQmFuZFNpemUgLyAyOwogIHJldHVybiB7CiAgICBzdHJva2U6ICJub25lIiwKICAgIGZpbGw6ICIjY2NjIiwKICAgIHg6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gYWN0aXZlQ29vcmRpbmF0ZS54IC0gaGFsZlNpemUgOiBvZmZzZXQubGVmdCArIDAuNSwKICAgIHk6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gb2Zmc2V0LnRvcCArIDAuNSA6IGFjdGl2ZUNvb3JkaW5hdGUueSAtIGhhbGZTaXplLAogICAgd2lkdGg6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gdG9vbHRpcEF4aXNCYW5kU2l6ZSA6IG9mZnNldC53aWR0aCAtIDEsCiAgICBoZWlnaHQ6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gb2Zmc2V0LmhlaWdodCAtIDEgOiB0b29sdGlwQXhpc0JhbmRTaXplCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9SZWN0YW5nbGUuanMKdmFyIFJlYWN0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDE4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGltcG9ydF9yZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXRpbC5qcwpmdW5jdGlvbiBvd25LZXlzOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0RGFzaENhc2UgPSAobmFtZSkgPT4gbmFtZS5yZXBsYWNlKC8oW0EtWl0pL2csICh2KSA9PiAiLSIuY29uY2F0KHYudG9Mb3dlckNhc2UoKSkpOwp2YXIgZ2V0VHJhbnNpdGlvblZhbCA9IChwcm9wcywgZHVyYXRpb24sIGVhc2luZykgPT4gcHJvcHMubWFwKChwcm9wKSA9PiAiIi5jb25jYXQoZ2V0RGFzaENhc2UocHJvcCksICIgIikuY29uY2F0KGR1cmF0aW9uLCAibXMgIikuY29uY2F0KGVhc2luZykpLmpvaW4oIiwiKTsKdmFyIGdldEludGVyc2VjdGlvbktleXMgPSAocHJlT2JqLCBuZXh0T2JqKSA9PiBbT2JqZWN0LmtleXMocHJlT2JqKSwgT2JqZWN0LmtleXMobmV4dE9iaildLnJlZHVjZSgoYSwgYikgPT4gYS5maWx0ZXIoKGMpID0+IGIuaW5jbHVkZXMoYykpKTsKdmFyIG1hcE9iamVjdCA9IChmbiwgb2JqKSA9PiBPYmplY3Qua2V5cyhvYmopLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQ5KF9vYmplY3RTcHJlYWQ5KHt9LCByZXMpLCB7fSwgewogIFtrZXldOiBmbihrZXksIG9ialtrZXldKQp9KSwge30pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY29uZmlnVXBkYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgYWxwaGEgPSAoYmVnaW4sIGVuZCwgaykgPT4gYmVnaW4gKyAoZW5kIC0gYmVnaW4pICogazsKdmFyIG5lZWRDb250aW51ZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBmcm9tOiBmcm9tMiwKICAgIHRvOiB0bzIKICB9ID0gX3JlZjI7CiAgcmV0dXJuIGZyb20yICE9PSB0bzI7Cn07CnZhciBjYWxTdGVwcGVyVmFscyA9IChlYXNpbmcsIHByZVZhbHMsIHN0ZXBzKSA9PiB7CiAgdmFyIG5leHRTdGVwVmFscyA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgIGlmIChuZWVkQ29udGludWUodmFsKSkgewogICAgICB2YXIgW25ld1gsIG5ld1ZdID0gZWFzaW5nKHZhbC5mcm9tLCB2YWwudG8sIHZhbC52ZWxvY2l0eSk7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCB2YWwpLCB7fSwgewogICAgICAgIGZyb206IG5ld1gsCiAgICAgICAgdmVsb2NpdHk6IG5ld1YKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdmFsOwogIH0sIHByZVZhbHMpOwogIGlmIChzdGVwcyA8IDEpIHsKICAgIHJldHVybiBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiB7CiAgICAgIGlmIChuZWVkQ29udGludWUodmFsKSkgewogICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCB2YWwpLCB7fSwgewogICAgICAgICAgdmVsb2NpdHk6IGFscGhhKHZhbC52ZWxvY2l0eSwgbmV4dFN0ZXBWYWxzW2tleV0udmVsb2NpdHksIHN0ZXBzKSwKICAgICAgICAgIGZyb206IGFscGhhKHZhbC5mcm9tLCBuZXh0U3RlcFZhbHNba2V5XS5mcm9tLCBzdGVwcykKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfSwgcHJlVmFscyk7CiAgfQogIHJldHVybiBjYWxTdGVwcGVyVmFscyhlYXNpbmcsIG5leHRTdGVwVmFscywgc3RlcHMgLSAxKTsKfTsKZnVuY3Rpb24gY3JlYXRlU3RlcHBlclVwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgewogIHZhciBwcmVUaW1lOwogIHZhciBzdGVwcGVyU3R5bGUgPSBpbnRlcktleXMucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgcmVzKSwge30sIHsKICAgIFtrZXldOiB7CiAgICAgIGZyb206IGZyb20yW2tleV0sCiAgICAgIHZlbG9jaXR5OiAwLAogICAgICB0bzogdG8yW2tleV0KICAgIH0KICB9KSwge30pOwogIHZhciBnZXRDdXJyU3R5bGUgPSAoKSA9PiBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiB2YWwuZnJvbSwgc3RlcHBlclN0eWxlKTsKICB2YXIgc2hvdWxkU3RvcEFuaW1hdGlvbiA9ICgpID0+ICFPYmplY3QudmFsdWVzKHN0ZXBwZXJTdHlsZSkuZmlsdGVyKG5lZWRDb250aW51ZSkubGVuZ3RoOwogIHZhciBzdG9wQW5pbWF0aW9uID0gbnVsbDsKICB2YXIgc3RlcHBlclVwZGF0ZSA9IChub3cpID0+IHsKICAgIGlmICghcHJlVGltZSkgewogICAgICBwcmVUaW1lID0gbm93OwogICAgfQogICAgdmFyIGRlbHRhVGltZSA9IG5vdyAtIHByZVRpbWU7CiAgICB2YXIgc3RlcHMgPSBkZWx0YVRpbWUgLyBlYXNpbmcuZHQ7CiAgICBzdGVwcGVyU3R5bGUgPSBjYWxTdGVwcGVyVmFscyhlYXNpbmcsIHN0ZXBwZXJTdHlsZSwgc3RlcHMpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGdldEN1cnJTdHlsZSgpKSk7CiAgICBwcmVUaW1lID0gbm93OwogICAgaWYgKCFzaG91bGRTdG9wQW5pbWF0aW9uKCkpIHsKICAgICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc3RlcHBlclVwZGF0ZSk7CiAgICB9CiAgfTsKICByZXR1cm4gKCkgPT4gewogICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc3RlcHBlclVwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb247CiAgICAgIChfc3RvcEFuaW1hdGlvbiA9IHN0b3BBbmltYXRpb24pID09PSBudWxsIHx8IF9zdG9wQW5pbWF0aW9uID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24oKTsKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVUaW1pbmdVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBkdXJhdGlvbiwgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciB0aW1pbmdTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IFtmcm9tMltrZXldLCB0bzJba2V5XV0KICB9KSwge30pOwogIHZhciBiZWdpblRpbWU7CiAgdmFyIHRpbWluZ1VwZGF0ZSA9IChub3cpID0+IHsKICAgIGlmICghYmVnaW5UaW1lKSB7CiAgICAgIGJlZ2luVGltZSA9IG5vdzsKICAgIH0KICAgIHZhciB0ID0gKG5vdyAtIGJlZ2luVGltZSkgLyBkdXJhdGlvbjsKICAgIHZhciBjdXJyU3R5bGUgPSBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiBhbHBoYSguLi52YWwsIGVhc2luZyh0KSksIHRpbWluZ1N0eWxlKTsKICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpLCBjdXJyU3R5bGUpKTsKICAgIGlmICh0IDwgMSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dCh0aW1pbmdVcGRhdGUpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGZpbmFsU3R5bGUgPSBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiBhbHBoYSguLi52YWwsIGVhc2luZygxKSksIHRpbWluZ1N0eWxlKTsKICAgICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGZpbmFsU3R5bGUpKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dCh0aW1pbmdVcGRhdGUpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIF9zdG9wQW5pbWF0aW9uMjsKICAgICAgKF9zdG9wQW5pbWF0aW9uMiA9IHN0b3BBbmltYXRpb24pID09PSBudWxsIHx8IF9zdG9wQW5pbWF0aW9uMiA9PT0gdm9pZCAwIHx8IF9zdG9wQW5pbWF0aW9uMigpOwogICAgfTsKICB9Owp9CnZhciBjb25maWdVcGRhdGVfZGVmYXVsdCA9IChmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA9PiB7CiAgdmFyIGludGVyS2V5cyA9IGdldEludGVyc2VjdGlvbktleXMoZnJvbTIsIHRvMik7CiAgaWYgKGVhc2luZyA9PSBudWxsKSB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgfTsKICAgIH07CiAgfQogIHJldHVybiBlYXNpbmcuaXNTdGVwcGVyID09PSB0cnVlID8gY3JlYXRlU3RlcHBlclVwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgOiBjcmVhdGVUaW1pbmdVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBkdXJhdGlvbiwgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL2Vhc2luZy5qcwp2YXIgQUNDVVJBQ1kgPSAxZS00Owp2YXIgY3ViaWNCZXppZXJGYWN0b3IgPSAoYzEsIGMyKSA9PiBbMCwgMyAqIGMxLCAzICogYzIgLSA2ICogYzEsIDMgKiBjMSAtIDMgKiBjMiArIDFdOwp2YXIgZXZhbHVhdGVQb2x5bm9taWFsID0gKHBhcmFtcywgdCkgPT4gcGFyYW1zLm1hcCgocGFyYW0sIGkpID0+IHBhcmFtICogdCAqKiBpKS5yZWR1Y2UoKHByZSwgY3VycikgPT4gcHJlICsgY3Vycik7CnZhciBjdWJpY0JlemllciA9IChjMSwgYzIpID0+ICh0KSA9PiB7CiAgdmFyIHBhcmFtcyA9IGN1YmljQmV6aWVyRmFjdG9yKGMxLCBjMik7CiAgcmV0dXJuIGV2YWx1YXRlUG9seW5vbWlhbChwYXJhbXMsIHQpOwp9Owp2YXIgZGVyaXZhdGl2ZUN1YmljQmV6aWVyID0gKGMxLCBjMikgPT4gKHQpID0+IHsKICB2YXIgcGFyYW1zID0gY3ViaWNCZXppZXJGYWN0b3IoYzEsIGMyKTsKICB2YXIgbmV3UGFyYW1zID0gWy4uLnBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiBwYXJhbSAqIGkpLnNsaWNlKDEpLCAwXTsKICByZXR1cm4gZXZhbHVhdGVQb2x5bm9taWFsKG5ld1BhcmFtcywgdCk7Cn07CnZhciBnZXRCZXppZXJDb29yZGluYXRlcyA9IGZ1bmN0aW9uIGdldEJlemllckNvb3JkaW5hdGVzMigpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkgewogICAgc3dpdGNoIChhcmdzWzBdKSB7CiAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgcmV0dXJuIFswLCAwLCAxLCAxXTsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgICAgcmV0dXJuIFswLjI1LCAwLjEsIDAuMjUsIDFdOwogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgICByZXR1cm4gWzAuNDIsIDAsIDEsIDFdOwogICAgICBjYXNlICJlYXNlLW91dCI6CiAgICAgICAgcmV0dXJuIFswLjQyLCAwLCAwLjU4LCAxXTsKICAgICAgY2FzZSAiZWFzZS1pbi1vdXQiOgogICAgICAgIHJldHVybiBbMCwgMCwgMC41OCwgMV07CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICB2YXIgX2Vhc2luZyQ7CiAgICAgICAgdmFyIGVhc2luZyA9IGFyZ3NbMF0uc3BsaXQoIigiKTsKICAgICAgICBpZiAoZWFzaW5nWzBdID09PSAiY3ViaWMtYmV6aWVyIiAmJiAoKF9lYXNpbmckID0gZWFzaW5nWzFdKSA9PT0gbnVsbCB8fCBfZWFzaW5nJCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vhc2luZyQuc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLmxlbmd0aCkgPT09IDQpIHsKICAgICAgICAgIHZhciBjb29yZHMgPSBlYXNpbmdbMV0uc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLm1hcCgoeDIpID0+IHBhcnNlRmxvYXQoeDIpKTsKICAgICAgICAgIHJldHVybiBbY29vcmRzWzBdLCBjb29yZHNbMV0sIGNvb3Jkc1syXSwgY29vcmRzWzNdXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGFyZ3MubGVuZ3RoID09PSA0KSB7CiAgICByZXR1cm4gYXJnczsKICB9CiAgcmV0dXJuIFswLCAwLCAxLCAxXTsKfTsKdmFyIGNyZWF0ZUJlemllckVhc2luZyA9ICh4MSwgeTEsIHgyLCB5MikgPT4gewogIHZhciBjdXJ2ZVggPSBjdWJpY0Jlemllcih4MSwgeDIpOwogIHZhciBjdXJ2ZVkgPSBjdWJpY0Jlemllcih5MSwgeTIpOwogIHZhciBkZXJDdXJ2ZVggPSBkZXJpdmF0aXZlQ3ViaWNCZXppZXIoeDEsIHgyKTsKICB2YXIgcmFuZ2VWYWx1ZSA9ICh2YWx1ZSkgPT4gewogICAgaWYgKHZhbHVlID4gMSkgewogICAgICByZXR1cm4gMTsKICAgIH0KICAgIGlmICh2YWx1ZSA8IDApIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICB2YXIgYmV6aWVyID0gKF90KSA9PiB7CiAgICB2YXIgdCA9IF90ID4gMSA/IDEgOiBfdDsKICAgIHZhciB4MyA9IHQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7ICsraSkgewogICAgICB2YXIgZXZhbFQgPSBjdXJ2ZVgoeDMpIC0gdDsKICAgICAgdmFyIGRlclZhbCA9IGRlckN1cnZlWCh4Myk7CiAgICAgIGlmIChNYXRoLmFicyhldmFsVCAtIHQpIDwgQUNDVVJBQ1kgfHwgZGVyVmFsIDwgQUNDVVJBQ1kpIHsKICAgICAgICByZXR1cm4gY3VydmVZKHgzKTsKICAgICAgfQogICAgICB4MyA9IHJhbmdlVmFsdWUoeDMgLSBldmFsVCAvIGRlclZhbCk7CiAgICB9CiAgICByZXR1cm4gY3VydmVZKHgzKTsKICB9OwogIGJlemllci5pc1N0ZXBwZXIgPSBmYWxzZTsKICByZXR1cm4gYmV6aWVyOwp9Owp2YXIgY29uZmlnQmV6aWVyID0gZnVuY3Rpb24gY29uZmlnQmV6aWVyMigpIHsKICByZXR1cm4gY3JlYXRlQmV6aWVyRWFzaW5nKC4uLmdldEJlemllckNvb3JkaW5hdGVzKC4uLmFyZ3VtZW50cykpOwp9Owp2YXIgY29uZmlnU3ByaW5nID0gZnVuY3Rpb24gY29uZmlnU3ByaW5nMigpIHsKICB2YXIgY29uZmlnID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiB7fTsKICB2YXIgewogICAgc3RpZmYgPSAxMDAsCiAgICBkYW1waW5nID0gOCwKICAgIGR0ID0gMTcKICB9ID0gY29uZmlnOwogIHZhciBzdGVwcGVyID0gKGN1cnJYLCBkZXN0WCwgY3VyclYpID0+IHsKICAgIHZhciBGU3ByaW5nID0gLShjdXJyWCAtIGRlc3RYKSAqIHN0aWZmOwogICAgdmFyIEZEYW1waW5nID0gY3VyclYgKiBkYW1waW5nOwogICAgdmFyIG5ld1YgPSBjdXJyViArIChGU3ByaW5nIC0gRkRhbXBpbmcpICogZHQgLyAxZTM7CiAgICB2YXIgbmV3WCA9IGN1cnJWICogZHQgLyAxZTMgKyBjdXJyWDsKICAgIGlmIChNYXRoLmFicyhuZXdYIC0gZGVzdFgpIDwgQUNDVVJBQ1kgJiYgTWF0aC5hYnMobmV3VikgPCBBQ0NVUkFDWSkgewogICAgICByZXR1cm4gW2Rlc3RYLCAwXTsKICAgIH0KICAgIHJldHVybiBbbmV3WCwgbmV3Vl07CiAgfTsKICBzdGVwcGVyLmlzU3RlcHBlciA9IHRydWU7CiAgc3RlcHBlci5kdCA9IGR0OwogIHJldHVybiBzdGVwcGVyOwp9Owp2YXIgY29uZmlnRWFzaW5nID0gKGVhc2luZykgPT4gewogIGlmICh0eXBlb2YgZWFzaW5nID09PSAic3RyaW5nIikgewogICAgc3dpdGNoIChlYXNpbmcpIHsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgIGNhc2UgImVhc2UtaW4tb3V0IjoKICAgICAgY2FzZSAiZWFzZS1vdXQiOgogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgY2FzZSAibGluZWFyIjoKICAgICAgICByZXR1cm4gY29uZmlnQmV6aWVyKGVhc2luZyk7CiAgICAgIGNhc2UgInNwcmluZyI6CiAgICAgICAgcmV0dXJuIGNvbmZpZ1NwcmluZygpOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChlYXNpbmcuc3BsaXQoIigiKVswXSA9PT0gImN1YmljLWJlemllciIpIHsKICAgICAgICAgIHJldHVybiBjb25maWdCZXppZXIoZWFzaW5nKTsKICAgICAgICB9CiAgICB9CiAgfQogIGlmICh0eXBlb2YgZWFzaW5nID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZWFzaW5nOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3VzZUFuaW1hdGlvbk1hbmFnZXIuanMKdmFyIGltcG9ydF9yZWFjdDE1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vQW5pbWF0aW9uTWFuYWdlci5qcwpmdW5jdGlvbiBjcmVhdGVBbmltYXRlTWFuYWdlcih0aW1lb3V0Q29udHJvbGxlcikgewogIHZhciBjdXJyU3R5bGU7CiAgdmFyIGhhbmRsZUNoYW5nZSA9ICgpID0+IG51bGw7CiAgdmFyIHNob3VsZFN0b3AgPSBmYWxzZTsKICB2YXIgY2FuY2VsVGltZW91dCA9IG51bGw7CiAgdmFyIHNldFN0eWxlID0gKF9zdHlsZSkgPT4gewogICAgaWYgKHNob3VsZFN0b3ApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkoX3N0eWxlKSkgewogICAgICBpZiAoIV9zdHlsZS5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHN0eWxlcyA9IF9zdHlsZTsKICAgICAgdmFyIFtjdXJyLCAuLi5yZXN0U3R5bGVzXSA9IHN0eWxlczsKICAgICAgaWYgKHR5cGVvZiBjdXJyID09PSAibnVtYmVyIikgewogICAgICAgIGNhbmNlbFRpbWVvdXQgPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHNldFN0eWxlLmJpbmQobnVsbCwgcmVzdFN0eWxlcyksIGN1cnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZXRTdHlsZShjdXJyKTsKICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAic3RyaW5nIikgewogICAgICBjdXJyU3R5bGUgPSBfc3R5bGU7CiAgICAgIGhhbmRsZUNoYW5nZShjdXJyU3R5bGUpOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJvYmplY3QiKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBfc3R5bGUoKTsKICAgIH0KICB9OwogIHJldHVybiB7CiAgICBzdG9wOiAoKSA9PiB7CiAgICAgIHNob3VsZFN0b3AgPSB0cnVlOwogICAgfSwKICAgIHN0YXJ0OiAoc3R5bGUpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IGZhbHNlOwogICAgICBpZiAoY2FuY2VsVGltZW91dCkgewogICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICAgICAgfQogICAgICBzZXRTdHlsZShzdHlsZSk7CiAgICB9LAogICAgc3Vic2NyaWJlOiAoX2hhbmRsZUNoYW5nZSkgPT4gewogICAgICBoYW5kbGVDaGFuZ2UgPSBfaGFuZGxlQ2hhbmdlOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGhhbmRsZUNoYW5nZSA9ICgpID0+IG51bGw7CiAgICAgIH07CiAgICB9LAogICAgZ2V0VGltZW91dENvbnRyb2xsZXI6ICgpID0+IHRpbWVvdXRDb250cm9sbGVyCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdGltZW91dENvbnRyb2xsZXIuanMKdmFyIFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyID0gY2xhc3MgewogIHNldFRpbWVvdXQoY2FsbGJhY2spIHsKICAgIHZhciBkZWxheSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogMDsKICAgIHZhciBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIHZhciByZXF1ZXN0SWQgPSBudWxsOwogICAgdmFyIGV4ZWN1dGVDYWxsYmFjayA9IChub3cpID0+IHsKICAgICAgaWYgKG5vdyAtIHN0YXJ0VGltZSA+PSBkZWxheSkgewogICAgICAgIGNhbGxiYWNrKG5vdyk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlQ2FsbGJhY2spOwogICAgICB9CiAgICB9OwogICAgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGV4ZWN1dGVDYWxsYmFjayk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocmVxdWVzdElkICE9IG51bGwpIHsKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQpOwogICAgICB9CiAgICB9OwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL2NyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyLmpzCmZ1bmN0aW9uIGNyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyKCkgewogIHJldHVybiBjcmVhdGVBbmltYXRlTWFuYWdlcihuZXcgUmVxdWVzdEFuaW1hdGlvbkZyYW1lVGltZW91dENvbnRyb2xsZXIoKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3VzZUFuaW1hdGlvbk1hbmFnZXIuanMKdmFyIEFuaW1hdGlvbk1hbmFnZXJDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxNS5jcmVhdGVDb250ZXh0KShjcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlcik7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbk1hbmFnZXIoYW5pbWF0aW9uSWQsIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMpIHsKICB2YXIgY29udGV4dEFuaW1hdGlvbk1hbmFnZXIgPSAoMCwgaW1wb3J0X3JlYWN0MTUudXNlQ29udGV4dCkoQW5pbWF0aW9uTWFuYWdlckNvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MTUudXNlTWVtbykoKCkgPT4gYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcyAhPT0gbnVsbCAmJiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSB2b2lkIDAgPyBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzIDogY29udGV4dEFuaW1hdGlvbk1hbmFnZXIoYW5pbWF0aW9uSWQpLCBbYW5pbWF0aW9uSWQsIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMsIGNvbnRleHRBbmltYXRpb25NYW5hZ2VyXSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9HbG9iYWwuanMKdmFyIHBhcnNlSXNTc3JCeURlZmF1bHQgPSAoKSA9PiAhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCAmJiBCb29sZWFuKHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KSAmJiB3aW5kb3cuc2V0VGltZW91dCk7CnZhciBHbG9iYWwgPSB7CiAgZGV2VG9vbHNFbmFibGVkOiBmYWxzZSwKICBpc1NzcjogcGFyc2VJc1NzckJ5RGVmYXVsdCgpCn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9KYXZhc2NyaXB0QW5pbWF0ZS5qcwp2YXIgZGVmYXVsdEphdmFzY3JpcHRBbmltYXRlUHJvcHMgPSB7CiAgYmVnaW46IDAsCiAgZHVyYXRpb246IDFlMywKICBlYXNpbmc6ICJlYXNlIiwKICBpc0FjdGl2ZTogdHJ1ZSwKICBjYW5CZWdpbjogdHJ1ZSwKICBvbkFuaW1hdGlvbkVuZDogKCkgPT4gewogIH0sCiAgb25BbmltYXRpb25TdGFydDogKCkgPT4gewogIH0KfTsKdmFyIGZyb20gPSB7CiAgdDogMAp9Owp2YXIgdG8gPSB7CiAgdDogMQp9OwpmdW5jdGlvbiBKYXZhc2NyaXB0QW5pbWF0ZShvdXRzaWRlUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdEphdmFzY3JpcHRBbmltYXRlUHJvcHMpOwogIHZhciB7CiAgICBpc0FjdGl2ZTogaXNBY3RpdmVQcm9wLAogICAgY2FuQmVnaW4sCiAgICBkdXJhdGlvbiwKICAgIGVhc2luZywKICAgIGJlZ2luLAogICAgb25BbmltYXRpb25FbmQsCiAgICBvbkFuaW1hdGlvblN0YXJ0LAogICAgY2hpbGRyZW4KICB9ID0gcHJvcHM7CiAgdmFyIGlzQWN0aXZlID0gaXNBY3RpdmVQcm9wID09PSAiYXV0byIgPyAhR2xvYmFsLmlzU3NyIDogaXNBY3RpdmVQcm9wOwogIHZhciBhbmltYXRpb25NYW5hZ2VyID0gdXNlQW5pbWF0aW9uTWFuYWdlcihwcm9wcy5hbmltYXRpb25JZCwgcHJvcHMuYW5pbWF0aW9uTWFuYWdlcik7CiAgdmFyIFtzdHlsZSwgc2V0U3R5bGVdID0gKDAsIGltcG9ydF9yZWFjdDE2LnVzZVN0YXRlKShpc0FjdGl2ZSA/IGZyb20gOiB0byk7CiAgdmFyIHN0b3BKU0FuaW1hdGlvbiA9ICgwLCBpbXBvcnRfcmVhY3QxNi51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QxNi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNBY3RpdmUpIHsKICAgICAgc2V0U3R5bGUodG8pOwogICAgfQogIH0sIFtpc0FjdGl2ZV0pOwogICgwLCBpbXBvcnRfcmVhY3QxNi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNBY3RpdmUgfHwgIWNhbkJlZ2luKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIHN0YXJ0QW5pbWF0aW9uID0gY29uZmlnVXBkYXRlX2RlZmF1bHQoZnJvbSwgdG8sIGNvbmZpZ0Vhc2luZyhlYXNpbmcpLCBkdXJhdGlvbiwgc2V0U3R5bGUsIGFuaW1hdGlvbk1hbmFnZXIuZ2V0VGltZW91dENvbnRyb2xsZXIoKSk7CiAgICB2YXIgb25BbmltYXRpb25BY3RpdmUgPSAoKSA9PiB7CiAgICAgIHN0b3BKU0FuaW1hdGlvbi5jdXJyZW50ID0gc3RhcnRBbmltYXRpb24oKTsKICAgIH07CiAgICBhbmltYXRpb25NYW5hZ2VyLnN0YXJ0KFtvbkFuaW1hdGlvblN0YXJ0LCBiZWdpbiwgb25BbmltYXRpb25BY3RpdmUsIGR1cmF0aW9uLCBvbkFuaW1hdGlvbkVuZF0pOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgYW5pbWF0aW9uTWFuYWdlci5zdG9wKCk7CiAgICAgIGlmIChzdG9wSlNBbmltYXRpb24uY3VycmVudCkgewogICAgICAgIHN0b3BKU0FuaW1hdGlvbi5jdXJyZW50KCk7CiAgICAgIH0KICAgICAgb25BbmltYXRpb25FbmQoKTsKICAgIH07CiAgfSwgW2lzQWN0aXZlLCBjYW5CZWdpbiwgZHVyYXRpb24sIGVhc2luZywgYmVnaW4sIG9uQW5pbWF0aW9uU3RhcnQsIG9uQW5pbWF0aW9uRW5kLCBhbmltYXRpb25NYW5hZ2VyXSk7CiAgcmV0dXJuIGNoaWxkcmVuKHN0eWxlLnQpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlQW5pbWF0aW9uSWQuanMKdmFyIGltcG9ydF9yZWFjdDE3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VBbmltYXRpb25JZChpbnB1dCkgewogIHZhciBwcmVmaXggPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6ICJhbmltYXRpb24tIjsKICB2YXIgYW5pbWF0aW9uSWQgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKSh1bmlxdWVJZChwcmVmaXgpKTsKICB2YXIgcHJldlByb3BzID0gKDAsIGltcG9ydF9yZWFjdDE3LnVzZVJlZikoaW5wdXQpOwogIGlmIChwcmV2UHJvcHMuY3VycmVudCAhPT0gaW5wdXQpIHsKICAgIGFuaW1hdGlvbklkLmN1cnJlbnQgPSB1bmlxdWVJZChwcmVmaXgpOwogICAgcHJldlByb3BzLmN1cnJlbnQgPSBpbnB1dDsKICB9CiAgcmV0dXJuIGFuaW1hdGlvbklkLmN1cnJlbnQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvUmVjdGFuZ2xlLmpzCnZhciBfZXhjbHVkZWQ0ID0gWyJyYWRpdXMiXTsKdmFyIF9leGNsdWRlZDIyID0gWyJyYWRpdXMiXTsKZnVuY3Rpb24gb3duS2V5czExKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzNygpIHsKICByZXR1cm4gX2V4dGVuZHM3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM3LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGdldFJlY3RhbmdsZVBhdGggPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXMpID0+IHsKICB2YXIgbWF4UmFkaXVzID0gTWF0aC5taW4oTWF0aC5hYnMod2lkdGgpIC8gMiwgTWF0aC5hYnMoaGVpZ2h0KSAvIDIpOwogIHZhciB5U2lnbiA9IGhlaWdodCA+PSAwID8gMSA6IC0xOwogIHZhciB4U2lnbiA9IHdpZHRoID49IDAgPyAxIDogLTE7CiAgdmFyIGNsb2NrV2lzZSA9IGhlaWdodCA+PSAwICYmIHdpZHRoID49IDAgfHwgaGVpZ2h0IDwgMCAmJiB3aWR0aCA8IDAgPyAxIDogMDsKICB2YXIgcGF0aDI7CiAgaWYgKG1heFJhZGl1cyA+IDAgJiYgcmFkaXVzIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgIHZhciBuZXdSYWRpdXMgPSBbMCwgMCwgMCwgMF07CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gNDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIG5ld1JhZGl1c1tpXSA9IHJhZGl1c1tpXSA+IG1heFJhZGl1cyA/IG1heFJhZGl1cyA6IHJhZGl1c1tpXTsKICAgIH0KICAgIHBhdGgyID0gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIG5ld1JhZGl1c1swXSk7CiAgICBpZiAobmV3UmFkaXVzWzBdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMF0sICIsIikuY29uY2F0KG5ld1JhZGl1c1swXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1swXSwgIiwiKS5jb25jYXQoeTIpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogbmV3UmFkaXVzWzFdLCAiLCIpLmNvbmNhdCh5Mik7CiAgICBpZiAobmV3UmFkaXVzWzFdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMV0sICIsIikuY29uY2F0KG5ld1JhZGl1c1sxXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBuZXdSYWRpdXNbMV0pOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1syXSk7CiAgICBpZiAobmV3UmFkaXVzWzJdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMl0sICIsIikuY29uY2F0KG5ld1JhZGl1c1syXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIG5ld1JhZGl1c1syXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1szXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgaWYgKG5ld1JhZGl1c1szXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzNdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbM10sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1szXSk7CiAgICB9CiAgICBwYXRoMiArPSAiWiI7CiAgfSBlbHNlIGlmIChtYXhSYWRpdXMgPiAwICYmIHJhZGl1cyA9PT0gK3JhZGl1cyAmJiByYWRpdXMgPiAwKSB7CiAgICB2YXIgX25ld1JhZGl1cyA9IE1hdGgubWluKG1heFJhZGl1cywgcmFkaXVzKTsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0LCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogX25ld1JhZGl1cywgIiBaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyLCAiIGggIikuY29uY2F0KHdpZHRoLCAiIHYgIikuY29uY2F0KGhlaWdodCwgIiBoICIpLmNvbmNhdCgtd2lkdGgsICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICAvLyBUaGUgcmFkaXVzIG9mIGJvcmRlcgogIC8vIFRoZSByYWRpdXMgb2YgZm91ciBjb3JuZXJzIHdoZW4gcmFkaXVzIGlzIGEgbnVtYmVyCiAgLy8gVGhlIHJhZGl1cyBvZiBsZWZ0LXRvcCwgcmlnaHQtdG9wLCByaWdodC1ib3R0b20sIGxlZnQtYm90dG9tIHdoZW4gcmFkaXVzIGlzIGFuIGFycmF5CiAgcmFkaXVzOiAwLAogIGlzQW5pbWF0aW9uQWN0aXZlOiBmYWxzZSwKICBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZTogZmFsc2UsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIKfTsKdmFyIFJlY3RhbmdsZSA9IChyZWN0YW5nbGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocmVjdGFuZ2xlUHJvcHMsIGRlZmF1bHRSZWN0YW5nbGVQcm9wcyk7CiAgdmFyIHBhdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShudWxsKTsKICB2YXIgW3RvdGFsTGVuZ3RoLCBzZXRUb3RhbExlbmd0aF0gPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlU3RhdGUpKC0xKTsKICAoMCwgaW1wb3J0X3JlYWN0MTgudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50ICYmIHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCkgewogICAgICB0cnkgewogICAgICAgIHZhciBwYXRoVG90YWxMZW5ndGggPSBwYXRoUmVmLmN1cnJlbnQuZ2V0VG90YWxMZW5ndGgoKTsKICAgICAgICBpZiAocGF0aFRvdGFsTGVuZ3RoKSB7CiAgICAgICAgICBzZXRUb3RhbExlbmd0aChwYXRoVG90YWxMZW5ndGgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgICB9CiAgICB9CiAgfSwgW10pOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByYWRpdXMsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIHsKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlCiAgfSA9IHByb3BzOwogIHZhciBwcmV2V2lkdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh3aWR0aCk7CiAgdmFyIHByZXZIZWlnaHRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShoZWlnaHQpOwogIHZhciBwcmV2WFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHgyKTsKICB2YXIgcHJldllSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh5Mik7CiAgdmFyIGFuaW1hdGlvbklkSW5wdXQgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlTWVtbykoKCkgPT4gKHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJhZGl1cwogIH0pLCBbeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXNdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JZElucHV0LCAicmVjdGFuZ2xlLSIpOwogIGlmICh4MiAhPT0gK3gyIHx8IHkyICE9PSAreTIgfHwgd2lkdGggIT09ICt3aWR0aCB8fCBoZWlnaHQgIT09ICtoZWlnaHQgfHwgd2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1yZWN0YW5nbGUiLCBjbGFzc05hbWUpOwogIGlmICghaXNVcGRhdGVBbmltYXRpb25BY3RpdmUpIHsKICAgIHZhciBfc3ZnUHJvcGVydGllc0FuZEV2ZW4gPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8KICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIG90aGVyUGF0aFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIF9leGNsdWRlZDQpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDkuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNyh7fSwgb3RoZXJQYXRoUHJvcHMsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKQogICAgfSkpOwogIH0KICB2YXIgcHJldldpZHRoID0gcHJldldpZHRoUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZIZWlnaHQgPSBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZYID0gcHJldlhSZWYuY3VycmVudDsKICB2YXIgcHJldlkgPSBwcmV2WVJlZi5jdXJyZW50OwogIHZhciBmcm9tMiA9ICIwcHggIi5jb25jYXQodG90YWxMZW5ndGggPT09IC0xID8gMSA6IHRvdGFsTGVuZ3RoLCAicHgiKTsKICB2YXIgdG8yID0gIiIuY29uY2F0KHRvdGFsTGVuZ3RoLCAicHggMHB4Iik7CiAgdmFyIHRyYW5zaXRpb24gPSBnZXRUcmFuc2l0aW9uVmFsKFsic3Ryb2tlRGFzaGFycmF5Il0sIGFuaW1hdGlvbkR1cmF0aW9uLCB0eXBlb2YgYW5pbWF0aW9uRWFzaW5nID09PSAic3RyaW5nIiA/IGFuaW1hdGlvbkVhc2luZyA6IGRlZmF1bHRSZWN0YW5nbGVQcm9wcy5hbmltYXRpb25FYXNpbmcpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAga2V5OiBhbmltYXRpb25JZCwKICAgIGNhbkJlZ2luOiB0b3RhbExlbmd0aCA+IDAsCiAgICBkdXJhdGlvbjogYW5pbWF0aW9uRHVyYXRpb24sCiAgICBlYXNpbmc6IGFuaW1hdGlvbkVhc2luZywKICAgIGlzQWN0aXZlOiBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZSwKICAgIGJlZ2luOiBhbmltYXRpb25CZWdpbgogIH0sICh0KSA9PiB7CiAgICB2YXIgY3VycldpZHRoID0gaW50ZXJwb2xhdGUocHJldldpZHRoLCB3aWR0aCwgdCk7CiAgICB2YXIgY3VyckhlaWdodCA9IGludGVycG9sYXRlKHByZXZIZWlnaHQsIGhlaWdodCwgdCk7CiAgICB2YXIgY3VyclggPSBpbnRlcnBvbGF0ZShwcmV2WCwgeDIsIHQpOwogICAgdmFyIGN1cnJZID0gaW50ZXJwb2xhdGUocHJldlksIHkyLCB0KTsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQpIHsKICAgICAgcHJldldpZHRoUmVmLmN1cnJlbnQgPSBjdXJyV2lkdGg7CiAgICAgIHByZXZIZWlnaHRSZWYuY3VycmVudCA9IGN1cnJIZWlnaHQ7CiAgICAgIHByZXZYUmVmLmN1cnJlbnQgPSBjdXJyWDsKICAgICAgcHJldllSZWYuY3VycmVudCA9IGN1cnJZOwogICAgfQogICAgdmFyIGFuaW1hdGlvblN0eWxlOwogICAgaWYgKCFpc0FuaW1hdGlvbkFjdGl2ZSkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIGlmICh0ID4gMCkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICB0cmFuc2l0aW9uLAogICAgICAgIHN0cm9rZURhc2hhcnJheTogdG8yCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IGZyb20yCiAgICAgIH07CiAgICB9CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICAgIHJhZGl1czogXzIKICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBvdGhlclBhdGhQcm9wczIgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIsIF9leGNsdWRlZDIyKTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczcoe30sIG90aGVyUGF0aFByb3BzMiwgewogICAgICByYWRpdXM6IHR5cGVvZiByYWRpdXMgPT09ICJudW1iZXIiID8gcmFkaXVzIDogdm9pZCAwLAogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGQ6IGdldFJlY3RhbmdsZVBhdGgoY3VyclgsIGN1cnJZLCBjdXJyV2lkdGgsIGN1cnJIZWlnaHQsIHJhZGl1cyksCiAgICAgIHJlZjogcGF0aFJlZiwKICAgICAgc3R5bGU6IF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIGFuaW1hdGlvblN0eWxlKSwgcHJvcHMuc3R5bGUpCiAgICB9KSk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUG9sYXJVdGlscy5qcwp2YXIgaW1wb3J0X3JlYWN0MTkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIG93bktleXMxMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgUkFESUFOID0gTWF0aC5QSSAvIDE4MDsKdmFyIHJhZGlhblRvRGVncmVlID0gKGFuZ2xlSW5SYWRpYW4pID0+IGFuZ2xlSW5SYWRpYW4gKiAxODAgLyBNYXRoLlBJOwp2YXIgcG9sYXJUb0NhcnRlc2lhbiA9IChjeCwgY3ksIHJhZGl1cywgYW5nbGUpID0+ICh7CiAgeDogY3ggKyBNYXRoLmNvcygtUkFESUFOICogYW5nbGUpICogcmFkaXVzLAogIHk6IGN5ICsgTWF0aC5zaW4oLVJBRElBTiAqIGFuZ2xlKSAqIHJhZGl1cwp9KTsKdmFyIGdldE1heFJhZGl1cyA9IGZ1bmN0aW9uIGdldE1heFJhZGl1czIod2lkdGgsIGhlaWdodCkgewogIHZhciBvZmZzZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHsKICAgIHRvcDogMCwKICAgIHJpZ2h0OiAwLAogICAgYm90dG9tOiAwLAogICAgbGVmdDogMCwKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwLAogICAgYnJ1c2hCb3R0b206IDAKICB9OwogIHJldHVybiBNYXRoLm1pbihNYXRoLmFicyh3aWR0aCAtIChvZmZzZXQubGVmdCB8fCAwKSAtIChvZmZzZXQucmlnaHQgfHwgMCkpLCBNYXRoLmFicyhoZWlnaHQgLSAob2Zmc2V0LnRvcCB8fCAwKSAtIChvZmZzZXQuYm90dG9tIHx8IDApKSkgLyAyOwp9Owp2YXIgZGlzdGFuY2VCZXR3ZWVuUG9pbnRzID0gKHBvaW50NCwgYW5vdGhlclBvaW50KSA9PiB7CiAgdmFyIHsKICAgIHg6IHgxLAogICAgeTogeTEKICB9ID0gcG9pbnQ0OwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSA9IGFub3RoZXJQb2ludDsKICByZXR1cm4gTWF0aC5zcXJ0KCh4MSAtIHgyKSAqKiAyICsgKHkxIC0geTIpICoqIDIpOwp9Owp2YXIgZ2V0QW5nbGVPZlBvaW50ID0gKF9yZWYyLCBfcmVmMjIpID0+IHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBfcmVmMjsKICB2YXIgewogICAgY3gsCiAgICBjeQogIH0gPSBfcmVmMjI7CiAgdmFyIHJhZGl1cyA9IGRpc3RhbmNlQmV0d2VlblBvaW50cyh7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSwgewogICAgeDogY3gsCiAgICB5OiBjeQogIH0pOwogIGlmIChyYWRpdXMgPD0gMCkgewogICAgcmV0dXJuIHsKICAgICAgcmFkaXVzLAogICAgICBhbmdsZTogMAogICAgfTsKICB9CiAgdmFyIGNvcyA9ICh4MiAtIGN4KSAvIHJhZGl1czsKICB2YXIgYW5nbGVJblJhZGlhbiA9IE1hdGguYWNvcyhjb3MpOwogIGlmICh5MiA+IGN5KSB7CiAgICBhbmdsZUluUmFkaWFuID0gMiAqIE1hdGguUEkgLSBhbmdsZUluUmFkaWFuOwogIH0KICByZXR1cm4gewogICAgcmFkaXVzLAogICAgYW5nbGU6IHJhZGlhblRvRGVncmVlKGFuZ2xlSW5SYWRpYW4pLAogICAgYW5nbGVJblJhZGlhbgogIH07Cn07CnZhciBmb3JtYXRBbmdsZU9mU2VjdG9yID0gKF9yZWYzKSA9PiB7CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMzsKICB2YXIgc3RhcnRDbnQgPSBNYXRoLmZsb29yKHN0YXJ0QW5nbGUgLyAzNjApOwogIHZhciBlbmRDbnQgPSBNYXRoLmZsb29yKGVuZEFuZ2xlIC8gMzYwKTsKICB2YXIgbWluMiA9IE1hdGgubWluKHN0YXJ0Q250LCBlbmRDbnQpOwogIHJldHVybiB7CiAgICBzdGFydEFuZ2xlOiBzdGFydEFuZ2xlIC0gbWluMiAqIDM2MCwKICAgIGVuZEFuZ2xlOiBlbmRBbmdsZSAtIG1pbjIgKiAzNjAKICB9Owp9Owp2YXIgcmV2ZXJzZUZvcm1hdEFuZ2xlT2ZTZWN0b3IgPSAoYW5nbGUsIF9yZWY0KSA9PiB7CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmNDsKICB2YXIgc3RhcnRDbnQgPSBNYXRoLmZsb29yKHN0YXJ0QW5nbGUgLyAzNjApOwogIHZhciBlbmRDbnQgPSBNYXRoLmZsb29yKGVuZEFuZ2xlIC8gMzYwKTsKICB2YXIgbWluMiA9IE1hdGgubWluKHN0YXJ0Q250LCBlbmRDbnQpOwogIHJldHVybiBhbmdsZSArIG1pbjIgKiAzNjA7Cn07CnZhciBpblJhbmdlT2ZTZWN0b3IgPSAoX3JlZjUsIHZpZXdCb3gpID0+IHsKICB2YXIgewogICAgY2hhcnRYOiB4MiwKICAgIGNoYXJ0WTogeTIKICB9ID0gX3JlZjU7CiAgdmFyIHsKICAgIHJhZGl1cywKICAgIGFuZ2xlCiAgfSA9IGdldEFuZ2xlT2ZQb2ludCh7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSwgdmlld0JveCk7CiAgdmFyIHsKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMKICB9ID0gdmlld0JveDsKICBpZiAocmFkaXVzIDwgaW5uZXJSYWRpdXMgfHwgcmFkaXVzID4gb3V0ZXJSYWRpdXMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAocmFkaXVzID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBmb3JtYXRBbmdsZU9mU2VjdG9yKHZpZXdCb3gpOwogIHZhciBmb3JtYXRBbmdsZSA9IGFuZ2xlOwogIHZhciBpblJhbmdlOwogIGlmIChzdGFydEFuZ2xlIDw9IGVuZEFuZ2xlKSB7CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPiBlbmRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSAtPSAzNjA7CiAgICB9CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPCBzdGFydEFuZ2xlKSB7CiAgICAgIGZvcm1hdEFuZ2xlICs9IDM2MDsKICAgIH0KICAgIGluUmFuZ2UgPSBmb3JtYXRBbmdsZSA+PSBzdGFydEFuZ2xlICYmIGZvcm1hdEFuZ2xlIDw9IGVuZEFuZ2xlOwogIH0gZWxzZSB7CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPiBzdGFydEFuZ2xlKSB7CiAgICAgIGZvcm1hdEFuZ2xlIC09IDM2MDsKICAgIH0KICAgIHdoaWxlIChmb3JtYXRBbmdsZSA8IGVuZEFuZ2xlKSB7CiAgICAgIGZvcm1hdEFuZ2xlICs9IDM2MDsKICAgIH0KICAgIGluUmFuZ2UgPSBmb3JtYXRBbmdsZSA+PSBlbmRBbmdsZSAmJiBmb3JtYXRBbmdsZSA8PSBzdGFydEFuZ2xlOwogIH0KICBpZiAoaW5SYW5nZSkgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMihfb2JqZWN0U3ByZWFkMTIoe30sIHZpZXdCb3gpLCB7fSwgewogICAgICByYWRpdXMsCiAgICAgIGFuZ2xlOiByZXZlcnNlRm9ybWF0QW5nbGVPZlNlY3Rvcihmb3JtYXRBbmdsZSwgdmlld0JveCkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzLmpzCmZ1bmN0aW9uIGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKSB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gYWN0aXZlQ29vcmRpbmF0ZTsKICB2YXIgc3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBlbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGVuZEFuZ2xlKTsKICByZXR1cm4gewogICAgcG9pbnRzOiBbc3RhcnRQb2ludCwgZW5kUG9pbnRdLAogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvU2VjdG9yLmpzCnZhciBSZWFjdDEwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczgoKSB7CiAgcmV0dXJuIF9leHRlbmRzOCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBnZXREZWx0YUFuZ2xlID0gKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKSA9PiB7CiAgdmFyIHNpZ24yID0gbWF0aFNpZ24oZW5kQW5nbGUgLSBzdGFydEFuZ2xlKTsKICB2YXIgZGVsdGFBbmdsZSA9IE1hdGgubWluKE1hdGguYWJzKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSksIDM1OS45OTkpOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciBnZXRUYW5nZW50Q2lyY2xlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBhbmdsZSwKICAgIHNpZ246IHNpZ24yLAogICAgaXNFeHRlcm5hbCwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9ID0gX3JlZjI7CiAgdmFyIGNlbnRlclJhZGl1cyA9IGNvcm5lclJhZGl1cyAqIChpc0V4dGVybmFsID8gMSA6IC0xKSArIHJhZGl1czsKICB2YXIgdGhldGEgPSBNYXRoLmFzaW4oY29ybmVyUmFkaXVzIC8gY2VudGVyUmFkaXVzKSAvIFJBRElBTjsKICB2YXIgY2VudGVyQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gYW5nbGUgOiBhbmdsZSArIHNpZ24yICogdGhldGE7CiAgdmFyIGNlbnRlciA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBjZW50ZXJSYWRpdXMsIGNlbnRlckFuZ2xlKTsKICB2YXIgY2lyY2xlVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBjZW50ZXJBbmdsZSk7CiAgdmFyIGxpbmVUYW5nZW5jeUFuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IGFuZ2xlIC0gc2lnbjIgKiB0aGV0YSA6IGFuZ2xlOwogIHZhciBsaW5lVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgY2VudGVyUmFkaXVzICogTWF0aC5jb3ModGhldGEgKiBSQURJQU4pLCBsaW5lVGFuZ2VuY3lBbmdsZSk7CiAgcmV0dXJuIHsKICAgIGNlbnRlciwKICAgIGNpcmNsZVRhbmdlbmN5LAogICAgbGluZVRhbmdlbmN5LAogICAgdGhldGEKICB9Owp9Owp2YXIgZ2V0U2VjdG9yUGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMjsKICB2YXIgYW5nbGUgPSBnZXREZWx0YUFuZ2xlKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgdGVtcEVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIGFuZ2xlOwogIHZhciBvdXRlclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBvdXRlckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KG91dGVyU3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueSwgIlxuICAgIEEgIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLFxuICAgICIpLmNvbmNhdCgrKE1hdGguYWJzKGFuZ2xlKSA+IDE4MCksICIsIikuY29uY2F0KCsoc3RhcnRBbmdsZSA+IHRlbXBFbmRBbmdsZSksICIsXG4gICAgIikuY29uY2F0KG91dGVyRW5kUG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJFbmRQb2ludC55LCAiXG4gICIpOwogIGlmIChpbm5lclJhZGl1cyA+IDApIHsKICAgIHZhciBpbm5lclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogICAgdmFyIGlubmVyRW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHRlbXBFbmRBbmdsZSk7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChpbm5lckVuZFBvaW50LngsICIsIikuY29uY2F0KGlubmVyRW5kUG9pbnQueSwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLDAsXG4gICAgICAgICAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPD0gdGVtcEVuZEFuZ2xlKSwgIixcbiAgICAgICAgICAgICIpLmNvbmNhdChpbm5lclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LnksICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBnZXRTZWN0b3JXaXRoQ29ybmVyID0gKF9yZWYzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBzb2N0LAogICAgbGluZVRhbmdlbmN5OiBzb2x0LAogICAgdGhldGE6IHNvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9KTsKICB2YXIgewogICAgY2lyY2xlVGFuZ2VuY3k6IGVvY3QsCiAgICBsaW5lVGFuZ2VuY3k6IGVvbHQsCiAgICB0aGV0YTogZW90CiAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICBhbmdsZTogZW5kQW5nbGUsCiAgICBzaWduOiAtc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIG91dGVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzb3QgLSBlb3Q7CiAgaWYgKG91dGVyQXJjQW5nbGUgPCAwKSB7CiAgICBpZiAoZm9yY2VDb3JuZXJSYWRpdXMpIHsKICAgICAgcmV0dXJuICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgICAgIGEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLDEsIikuY29uY2F0KGNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdCgtY29ybmVyUmFkaXVzICogMiwgIiwwXG4gICAgICAiKTsKICAgIH0KICAgIHJldHVybiBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgdmFyIHBhdGgyID0gIk0gIi5jb25jYXQoc29sdC54LCAiLCIpLmNvbmNhdChzb2x0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzb2N0LngsICIsIikuY29uY2F0KHNvY3QueSwgIlxuICAgIEEiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLDAsIikuY29uY2F0KCsob3V0ZXJBcmNBbmdsZSA+IDE4MCksICIsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9jdC54LCAiLCIpLmNvbmNhdChlb2N0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlb2x0LngsICIsIikuY29uY2F0KGVvbHQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgewogICAgICBjaXJjbGVUYW5nZW5jeTogc2ljdCwKICAgICAgbGluZVRhbmdlbmN5OiBzaWx0LAogICAgICB0aGV0YTogc2l0CiAgICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzOiBpbm5lclJhZGl1cywKICAgICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICAgIHNpZ246IHNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IGVpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogZWlsdCwKICAgICAgdGhldGE6IGVpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBlbmRBbmdsZSwKICAgICAgc2lnbjogLXNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIGlubmVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzaXQgLSBlaXQ7CiAgICBpZiAoaW5uZXJBcmNBbmdsZSA8IDAgJiYgY29ybmVyUmFkaXVzID09PSAwKSB7CiAgICAgIHJldHVybiAiIi5jb25jYXQocGF0aDIsICJMIikuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIloiKTsKICAgIH0KICAgIHBhdGgyICs9ICJMIi5jb25jYXQoZWlsdC54LCAiLCIpLmNvbmNhdChlaWx0LnksICJcbiAgICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVpY3QueCwgIiwiKS5jb25jYXQoZWljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKGlubmVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yID4gMCksICIsIikuY29uY2F0KHNpY3QueCwgIiwiKS5jb25jYXQoc2ljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzaWx0LngsICIsIikuY29uY2F0KHNpbHQueSwgIloiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRTZWN0b3JQcm9wcyA9IHsKICBjeDogMCwKICBjeTogMCwKICBpbm5lclJhZGl1czogMCwKICBvdXRlclJhZGl1czogMCwKICBzdGFydEFuZ2xlOiAwLAogIGVuZEFuZ2xlOiAwLAogIGNvcm5lclJhZGl1czogMCwKICBmb3JjZUNvcm5lclJhZGl1czogZmFsc2UsCiAgY29ybmVySXNFeHRlcm5hbDogZmFsc2UKfTsKdmFyIFNlY3RvciA9IChzZWN0b3JQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMoc2VjdG9yUHJvcHMsIGRlZmF1bHRTZWN0b3JQcm9wcyk7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIGlmIChvdXRlclJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHN0YXJ0QW5nbGUgPT09IGVuZEFuZ2xlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1zZWN0b3IiLCBjbGFzc05hbWUpOwogIHZhciBkZWx0YVJhZGl1cyA9IG91dGVyUmFkaXVzIC0gaW5uZXJSYWRpdXM7CiAgdmFyIGNyID0gZ2V0UGVyY2VudFZhbHVlKGNvcm5lclJhZGl1cywgZGVsdGFSYWRpdXMsIDAsIHRydWUpOwogIHZhciBwYXRoMjsKICBpZiAoY3IgPiAwICYmIE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgPCAzNjApIHsKICAgIHBhdGgyID0gZ2V0U2VjdG9yV2l0aENvcm5lcih7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBjb3JuZXJSYWRpdXM6IE1hdGgubWluKGNyLCBkZWx0YVJhZGl1cyAvIDIpLAogICAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbCwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9IGdldFNlY3RvclBhdGgoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTAuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgIGQ6IHBhdGgyCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRDdXJzb3JQb2ludHMuanMKZnVuY3Rpb24gZ2V0Q3Vyc29yUG9pbnRzKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0KSB7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gW3sKICAgICAgeDogYWN0aXZlQ29vcmRpbmF0ZS54LAogICAgICB5OiBvZmZzZXQudG9wCiAgICB9LCB7CiAgICAgIHg6IGFjdGl2ZUNvb3JkaW5hdGUueCwKICAgICAgeTogb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQKICAgIH1dOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gW3sKICAgICAgeDogb2Zmc2V0LmxlZnQsCiAgICAgIHk6IGFjdGl2ZUNvb3JkaW5hdGUueQogICAgfSwgewogICAgICB4OiBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCwKICAgICAgeTogYWN0aXZlQ29vcmRpbmF0ZS55CiAgICB9XTsKICB9CiAgaWYgKGlzUG9sYXJDb29yZGluYXRlKGFjdGl2ZUNvb3JkaW5hdGUpKSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIHsKICAgICAgICBjeCwKICAgICAgICBjeSwKICAgICAgICBpbm5lclJhZGl1cywKICAgICAgICBvdXRlclJhZGl1cywKICAgICAgICBhbmdsZQogICAgICB9ID0gYWN0aXZlQ29vcmRpbmF0ZTsKICAgICAgdmFyIGlubmVyUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIGFuZ2xlKTsKICAgICAgdmFyIG91dGVyUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIGFuZ2xlKTsKICAgICAgcmV0dXJuIFt7CiAgICAgICAgeDogaW5uZXJQb2ludC54LAogICAgICAgIHk6IGlubmVyUG9pbnQueQogICAgICB9LCB7CiAgICAgICAgeDogb3V0ZXJQb2ludC54LAogICAgICAgIHk6IG91dGVyUG9pbnQueQogICAgICB9XTsKICAgIH0KICAgIHJldHVybiBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKdmFyIGltcG9ydF9yYW5nZTIgPSBfX3RvRVNNKHJlcXVpcmVfcmFuZ2UyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3ZpY3RvcnktdmVuZG9yL2VzL2QzLXNjYWxlLmpzCnZhciBkM19zY2FsZV9leHBvcnRzID0ge307Cl9fZXhwb3J0KGQzX3NjYWxlX2V4cG9ydHMsIHsKICBzY2FsZUJhbmQ6ICgpID0+IGJhbmQsCiAgc2NhbGVEaXZlcmdpbmc6ICgpID0+IGRpdmVyZ2luZywKICBzY2FsZURpdmVyZ2luZ0xvZzogKCkgPT4gZGl2ZXJnaW5nTG9nLAogIHNjYWxlRGl2ZXJnaW5nUG93OiAoKSA9PiBkaXZlcmdpbmdQb3csCiAgc2NhbGVEaXZlcmdpbmdTcXJ0OiAoKSA9PiBkaXZlcmdpbmdTcXJ0LAogIHNjYWxlRGl2ZXJnaW5nU3ltbG9nOiAoKSA9PiBkaXZlcmdpbmdTeW1sb2csCiAgc2NhbGVJZGVudGl0eTogKCkgPT4gaWRlbnRpdHkyLAogIHNjYWxlSW1wbGljaXQ6ICgpID0+IGltcGxpY2l0LAogIHNjYWxlTGluZWFyOiAoKSA9PiBsaW5lYXIyLAogIHNjYWxlTG9nOiAoKSA9PiBsb2csCiAgc2NhbGVPcmRpbmFsOiAoKSA9PiBvcmRpbmFsLAogIHNjYWxlUG9pbnQ6ICgpID0+IHBvaW50MywKICBzY2FsZVBvdzogKCkgPT4gcG93LAogIHNjYWxlUXVhbnRpbGU6ICgpID0+IHF1YW50aWxlMiwKICBzY2FsZVF1YW50aXplOiAoKSA9PiBxdWFudGl6ZSwKICBzY2FsZVJhZGlhbDogKCkgPT4gcmFkaWFsLAogIHNjYWxlU2VxdWVudGlhbDogKCkgPT4gc2VxdWVudGlhbCwKICBzY2FsZVNlcXVlbnRpYWxMb2c6ICgpID0+IHNlcXVlbnRpYWxMb2csCiAgc2NhbGVTZXF1ZW50aWFsUG93OiAoKSA9PiBzZXF1ZW50aWFsUG93LAogIHNjYWxlU2VxdWVudGlhbFF1YW50aWxlOiAoKSA9PiBzZXF1ZW50aWFsUXVhbnRpbGUsCiAgc2NhbGVTZXF1ZW50aWFsU3FydDogKCkgPT4gc2VxdWVudGlhbFNxcnQsCiAgc2NhbGVTZXF1ZW50aWFsU3ltbG9nOiAoKSA9PiBzZXF1ZW50aWFsU3ltbG9nLAogIHNjYWxlU3FydDogKCkgPT4gc3FydCwKICBzY2FsZVN5bWxvZzogKCkgPT4gc3ltbG9nLAogIHNjYWxlVGhyZXNob2xkOiAoKSA9PiB0aHJlc2hvbGQsCiAgc2NhbGVUaW1lOiAoKSA9PiB0aW1lLAogIHNjYWxlVXRjOiAoKSA9PiB1dGNUaW1lLAogIHRpY2tGb3JtYXQ6ICgpID0+IHRpY2tGb3JtYXQKfSk7CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2FzY2VuZGluZy5qcwpmdW5jdGlvbiBhc2NlbmRpbmcoYSwgYikgewogIHJldHVybiBhID09IG51bGwgfHwgYiA9PSBudWxsID8gTmFOIDogYSA8IGIgPyAtMSA6IGEgPiBiID8gMSA6IGEgPj0gYiA/IDAgOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvZGVzY2VuZGluZy5qcwpmdW5jdGlvbiBkZXNjZW5kaW5nKGEsIGIpIHsKICByZXR1cm4gYSA9PSBudWxsIHx8IGIgPT0gbnVsbCA/IE5hTiA6IGIgPCBhID8gLTEgOiBiID4gYSA/IDEgOiBiID49IGEgPyAwIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Jpc2VjdG9yLmpzCmZ1bmN0aW9uIGJpc2VjdG9yKGYpIHsKICBsZXQgY29tcGFyZTEsIGNvbXBhcmUyLCBkZWx0YTsKICBpZiAoZi5sZW5ndGggIT09IDIpIHsKICAgIGNvbXBhcmUxID0gYXNjZW5kaW5nOwogICAgY29tcGFyZTIgPSAoZCwgeDIpID0+IGFzY2VuZGluZyhmKGQpLCB4Mik7CiAgICBkZWx0YSA9IChkLCB4MikgPT4gZihkKSAtIHgyOwogIH0gZWxzZSB7CiAgICBjb21wYXJlMSA9IGYgPT09IGFzY2VuZGluZyB8fCBmID09PSBkZXNjZW5kaW5nID8gZiA6IHplcm87CiAgICBjb21wYXJlMiA9IGY7CiAgICBkZWx0YSA9IGY7CiAgfQogIGZ1bmN0aW9uIGxlZnQoYSwgeDIsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgyLCB4MikgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeDIpIDwgMCkgbG8gPSBtaWQgKyAxOwogICAgICAgIGVsc2UgaGkgPSBtaWQ7CiAgICAgIH0gd2hpbGUgKGxvIDwgaGkpOwogICAgfQogICAgcmV0dXJuIGxvOwogIH0KICBmdW5jdGlvbiByaWdodChhLCB4MiwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBpZiAobG8gPCBoaSkgewogICAgICBpZiAoY29tcGFyZTEoeDIsIHgyKSAhPT0gMCkgcmV0dXJuIGhpOwogICAgICBkbyB7CiAgICAgICAgY29uc3QgbWlkID0gbG8gKyBoaSA+Pj4gMTsKICAgICAgICBpZiAoY29tcGFyZTIoYVttaWRdLCB4MikgPD0gMCkgbG8gPSBtaWQgKyAxOwogICAgICAgIGVsc2UgaGkgPSBtaWQ7CiAgICAgIH0gd2hpbGUgKGxvIDwgaGkpOwogICAgfQogICAgcmV0dXJuIGxvOwogIH0KICBmdW5jdGlvbiBjZW50ZXIoYSwgeDIsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgY29uc3QgaSA9IGxlZnQoYSwgeDIsIGxvLCBoaSAtIDEpOwogICAgcmV0dXJuIGkgPiBsbyAmJiBkZWx0YShhW2kgLSAxXSwgeDIpID4gLWRlbHRhKGFbaV0sIHgyKSA/IGkgLSAxIDogaTsKICB9CiAgcmV0dXJuIHsgbGVmdCwgY2VudGVyLCByaWdodCB9Owp9CmZ1bmN0aW9uIHplcm8oKSB7CiAgcmV0dXJuIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcih4MikgewogIHJldHVybiB4MiA9PT0gbnVsbCA/IE5hTiA6ICt4MjsKfQpmdW5jdGlvbiogbnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpIHsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKHZhbHVlID0gK3ZhbHVlKSA+PSB2YWx1ZSkgewogICAgICAgIHlpZWxkIHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmICh2YWx1ZSA9ICt2YWx1ZSkgPj0gdmFsdWUpIHsKICAgICAgICB5aWVsZCB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3QuanMKdmFyIGFzY2VuZGluZ0Jpc2VjdCA9IGJpc2VjdG9yKGFzY2VuZGluZyk7CnZhciBiaXNlY3RSaWdodCA9IGFzY2VuZGluZ0Jpc2VjdC5yaWdodDsKdmFyIGJpc2VjdExlZnQgPSBhc2NlbmRpbmdCaXNlY3QubGVmdDsKdmFyIGJpc2VjdENlbnRlciA9IGJpc2VjdG9yKG51bWJlcikuY2VudGVyOwp2YXIgYmlzZWN0X2RlZmF1bHQgPSBiaXNlY3RSaWdodDsKCi8vIG5vZGVfbW9kdWxlcy9pbnRlcm5tYXAvc3JjL2luZGV4LmpzCnZhciBJbnRlcm5NYXAgPSBjbGFzcyBleHRlbmRzIE1hcCB7CiAgY29uc3RydWN0b3IoZW50cmllcywga2V5ID0ga2V5b2YpIHsKICAgIHN1cGVyKCk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7IF9pbnRlcm46IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkgfSwgX2tleTogeyB2YWx1ZToga2V5IH0gfSk7CiAgICBpZiAoZW50cmllcyAhPSBudWxsKSBmb3IgKGNvbnN0IFtrZXkyLCB2YWx1ZV0gb2YgZW50cmllcykgdGhpcy5zZXQoa2V5MiwgdmFsdWUpOwogIH0KICBnZXQoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuZ2V0KGludGVybl9nZXQodGhpcywga2V5KSk7CiAgfQogIGhhcyhrZXkpIHsKICAgIHJldHVybiBzdXBlci5oYXMoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgc2V0KGtleSwgdmFsdWUpIHsKICAgIHJldHVybiBzdXBlci5zZXQoaW50ZXJuX3NldCh0aGlzLCBrZXkpLCB2YWx1ZSk7CiAgfQogIGRlbGV0ZShrZXkpIHsKICAgIHJldHVybiBzdXBlci5kZWxldGUoaW50ZXJuX2RlbGV0ZSh0aGlzLCBrZXkpKTsKICB9Cn07CmZ1bmN0aW9uIGludGVybl9nZXQoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgcmV0dXJuIF9pbnRlcm4uaGFzKGtleSkgPyBfaW50ZXJuLmdldChrZXkpIDogdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX3NldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgcmV0dXJuIF9pbnRlcm4uZ2V0KGtleSk7CiAgX2ludGVybi5zZXQoa2V5LCB2YWx1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGludGVybl9kZWxldGUoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgaWYgKF9pbnRlcm4uaGFzKGtleSkpIHsKICAgIHZhbHVlID0gX2ludGVybi5nZXQoa2V5KTsKICAgIF9pbnRlcm4uZGVsZXRlKGtleSk7CiAgfQogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBrZXlvZih2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiID8gdmFsdWUudmFsdWVPZigpIDogdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvc29ydC5qcwpmdW5jdGlvbiBjb21wYXJlRGVmaW5lZChjb21wYXJlID0gYXNjZW5kaW5nKSB7CiAgaWYgKGNvbXBhcmUgPT09IGFzY2VuZGluZykgcmV0dXJuIGFzY2VuZGluZ0RlZmluZWQ7CiAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJjb21wYXJlIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgcmV0dXJuIChhLCBiKSA9PiB7CiAgICBjb25zdCB4MiA9IGNvbXBhcmUoYSwgYik7CiAgICBpZiAoeDIgfHwgeDIgPT09IDApIHJldHVybiB4MjsKICAgIHJldHVybiAoY29tcGFyZShiLCBiKSA9PT0gMCkgLSAoY29tcGFyZShhLCBhKSA9PT0gMCk7CiAgfTsKfQpmdW5jdGlvbiBhc2NlbmRpbmdEZWZpbmVkKGEsIGIpIHsKICByZXR1cm4gKGEgPT0gbnVsbCB8fCAhKGEgPj0gYSkpIC0gKGIgPT0gbnVsbCB8fCAhKGIgPj0gYikpIHx8IChhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogMCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvdGlja3MuanMKdmFyIGUxMCA9IE1hdGguc3FydCg1MCk7CnZhciBlNSA9IE1hdGguc3FydCgxMCk7CnZhciBlMiA9IE1hdGguc3FydCgyKTsKZnVuY3Rpb24gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgY29uc3Qgc3RlcCA9IChzdG9wIC0gc3RhcnQpIC8gTWF0aC5tYXgoMCwgY291bnQpLCBwb3dlciA9IE1hdGguZmxvb3IoTWF0aC5sb2cxMChzdGVwKSksIGVycm9yID0gc3RlcCAvIE1hdGgucG93KDEwLCBwb3dlciksIGZhY3RvciA9IGVycm9yID49IGUxMCA/IDEwIDogZXJyb3IgPj0gZTUgPyA1IDogZXJyb3IgPj0gZTIgPyAyIDogMTsKICBsZXQgaTEsIGkyLCBpbmM7CiAgaWYgKHBvd2VyIDwgMCkgewogICAgaW5jID0gTWF0aC5wb3coMTAsIC1wb3dlcikgLyBmYWN0b3I7CiAgICBpMSA9IE1hdGgucm91bmQoc3RhcnQgKiBpbmMpOwogICAgaTIgPSBNYXRoLnJvdW5kKHN0b3AgKiBpbmMpOwogICAgaWYgKGkxIC8gaW5jIDwgc3RhcnQpICsraTE7CiAgICBpZiAoaTIgLyBpbmMgPiBzdG9wKSAtLWkyOwogICAgaW5jID0gLWluYzsKICB9IGVsc2UgewogICAgaW5jID0gTWF0aC5wb3coMTAsIHBvd2VyKSAqIGZhY3RvcjsKICAgIGkxID0gTWF0aC5yb3VuZChzdGFydCAvIGluYyk7CiAgICBpMiA9IE1hdGgucm91bmQoc3RvcCAvIGluYyk7CiAgICBpZiAoaTEgKiBpbmMgPCBzdGFydCkgKytpMTsKICAgIGlmIChpMiAqIGluYyA+IHN0b3ApIC0taTI7CiAgfQogIGlmIChpMiA8IGkxICYmIDAuNSA8PSBjb3VudCAmJiBjb3VudCA8IDIpIHJldHVybiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQgKiAyKTsKICByZXR1cm4gW2kxLCBpMiwgaW5jXTsKfQpmdW5jdGlvbiB0aWNrcyhzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICBpZiAoIShjb3VudCA+IDApKSByZXR1cm4gW107CiAgaWYgKHN0YXJ0ID09PSBzdG9wKSByZXR1cm4gW3N0YXJ0XTsKICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydCwgW2kxLCBpMiwgaW5jXSA9IHJldmVyc2UyID8gdGlja1NwZWMoc3RvcCwgc3RhcnQsIGNvdW50KSA6IHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgaWYgKCEoaTIgPj0gaTEpKSByZXR1cm4gW107CiAgY29uc3QgbiA9IGkyIC0gaTEgKyAxLCB0aWNrczIgPSBuZXcgQXJyYXkobik7CiAgaWYgKHJldmVyc2UyKSB7CiAgICBpZiAoaW5jIDwgMCkgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHRpY2tzMltpXSA9IChpMiAtIGkpIC8gLWluYzsKICAgIGVsc2UgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHRpY2tzMltpXSA9IChpMiAtIGkpICogaW5jOwogIH0gZWxzZSB7CiAgICBpZiAoaW5jIDwgMCkgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHRpY2tzMltpXSA9IChpMSArIGkpIC8gLWluYzsKICAgIGVsc2UgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHRpY2tzMltpXSA9IChpMSArIGkpICogaW5jOwogIH0KICByZXR1cm4gdGlja3MyOwp9CmZ1bmN0aW9uIHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQgPSArY291bnQ7CiAgcmV0dXJuIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudClbMl07Cn0KZnVuY3Rpb24gdGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQgPSArY291bnQ7CiAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQsIGluYyA9IHJldmVyc2UyID8gdGlja0luY3JlbWVudChzdG9wLCBzdGFydCwgY291bnQpIDogdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpOwogIHJldHVybiAocmV2ZXJzZTIgPyAtMSA6IDEpICogKGluYyA8IDAgPyAxIC8gLWluYyA6IGluYyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbWF4LmpzCmZ1bmN0aW9uIG1heCh2YWx1ZXMsIHZhbHVlb2YpIHsKICBsZXQgbWF4MjsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKG1heDIgPCB2YWx1ZSB8fCBtYXgyID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWF4MiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBtYXgyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL21pbi5qcwpmdW5jdGlvbiBtaW4odmFsdWVzLCB2YWx1ZW9mKSB7CiAgbGV0IG1pbjI7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKG1pbjIgPiB2YWx1ZSB8fCBtaW4yID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWluMiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmIChtaW4yID4gdmFsdWUgfHwgbWluMiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1pbjIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWluMjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9xdWlja3NlbGVjdC5qcwpmdW5jdGlvbiBxdWlja3NlbGVjdChhcnJheSwgaywgbGVmdCA9IDAsIHJpZ2h0ID0gSW5maW5pdHksIGNvbXBhcmUpIHsKICBrID0gTWF0aC5mbG9vcihrKTsKICBsZWZ0ID0gTWF0aC5mbG9vcihNYXRoLm1heCgwLCBsZWZ0KSk7CiAgcmlnaHQgPSBNYXRoLmZsb29yKE1hdGgubWluKGFycmF5Lmxlbmd0aCAtIDEsIHJpZ2h0KSk7CiAgaWYgKCEobGVmdCA8PSBrICYmIGsgPD0gcmlnaHQpKSByZXR1cm4gYXJyYXk7CiAgY29tcGFyZSA9IGNvbXBhcmUgPT09IHZvaWQgMCA/IGFzY2VuZGluZ0RlZmluZWQgOiBjb21wYXJlRGVmaW5lZChjb21wYXJlKTsKICB3aGlsZSAocmlnaHQgPiBsZWZ0KSB7CiAgICBpZiAocmlnaHQgLSBsZWZ0ID4gNjAwKSB7CiAgICAgIGNvbnN0IG4gPSByaWdodCAtIGxlZnQgKyAxOwogICAgICBjb25zdCBtID0gayAtIGxlZnQgKyAxOwogICAgICBjb25zdCB6ID0gTWF0aC5sb2cobik7CiAgICAgIGNvbnN0IHMgPSAwLjUgKiBNYXRoLmV4cCgyICogeiAvIDMpOwogICAgICBjb25zdCBzZCA9IDAuNSAqIE1hdGguc3FydCh6ICogcyAqIChuIC0gcykgLyBuKSAqIChtIC0gbiAvIDIgPCAwID8gLTEgOiAxKTsKICAgICAgY29uc3QgbmV3TGVmdCA9IE1hdGgubWF4KGxlZnQsIE1hdGguZmxvb3IoayAtIG0gKiBzIC8gbiArIHNkKSk7CiAgICAgIGNvbnN0IG5ld1JpZ2h0ID0gTWF0aC5taW4ocmlnaHQsIE1hdGguZmxvb3IoayArIChuIC0gbSkgKiBzIC8gbiArIHNkKSk7CiAgICAgIHF1aWNrc2VsZWN0KGFycmF5LCBrLCBuZXdMZWZ0LCBuZXdSaWdodCwgY29tcGFyZSk7CiAgICB9CiAgICBjb25zdCB0ID0gYXJyYXlba107CiAgICBsZXQgaSA9IGxlZnQ7CiAgICBsZXQgaiA9IHJpZ2h0OwogICAgc3dhcChhcnJheSwgbGVmdCwgayk7CiAgICBpZiAoY29tcGFyZShhcnJheVtyaWdodF0sIHQpID4gMCkgc3dhcChhcnJheSwgbGVmdCwgcmlnaHQpOwogICAgd2hpbGUgKGkgPCBqKSB7CiAgICAgIHN3YXAoYXJyYXksIGksIGopLCArK2ksIC0tajsKICAgICAgd2hpbGUgKGNvbXBhcmUoYXJyYXlbaV0sIHQpIDwgMCkgKytpOwogICAgICB3aGlsZSAoY29tcGFyZShhcnJheVtqXSwgdCkgPiAwKSAtLWo7CiAgICB9CiAgICBpZiAoY29tcGFyZShhcnJheVtsZWZ0XSwgdCkgPT09IDApIHN3YXAoYXJyYXksIGxlZnQsIGopOwogICAgZWxzZSArK2osIHN3YXAoYXJyYXksIGosIHJpZ2h0KTsKICAgIGlmIChqIDw9IGspIGxlZnQgPSBqICsgMTsKICAgIGlmIChrIDw9IGopIHJpZ2h0ID0gaiAtIDE7CiAgfQogIHJldHVybiBhcnJheTsKfQpmdW5jdGlvbiBzd2FwKGFycmF5LCBpLCBqKSB7CiAgY29uc3QgdCA9IGFycmF5W2ldOwogIGFycmF5W2ldID0gYXJyYXlbal07CiAgYXJyYXlbal0gPSB0Owp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlKHZhbHVlcywgcCwgdmFsdWVvZikgewogIHZhbHVlcyA9IEZsb2F0NjRBcnJheS5mcm9tKG51bWJlcnModmFsdWVzLCB2YWx1ZW9mKSk7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gbWluKHZhbHVlcyk7CiAgaWYgKHAgPj0gMSkgcmV0dXJuIG1heCh2YWx1ZXMpOwogIHZhciBuLCBpID0gKG4gLSAxKSAqIHAsIGkwID0gTWF0aC5mbG9vcihpKSwgdmFsdWUwID0gbWF4KHF1aWNrc2VsZWN0KHZhbHVlcywgaTApLnN1YmFycmF5KDAsIGkwICsgMSkpLCB2YWx1ZTEgPSBtaW4odmFsdWVzLnN1YmFycmF5KGkwICsgMSkpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CmZ1bmN0aW9uIHF1YW50aWxlU29ydGVkKHZhbHVlcywgcCwgdmFsdWVvZiA9IG51bWJlcikgewogIGlmICghKG4gPSB2YWx1ZXMubGVuZ3RoKSB8fCBpc05hTihwID0gK3ApKSByZXR1cm47CiAgaWYgKHAgPD0gMCB8fCBuIDwgMikgcmV0dXJuICt2YWx1ZW9mKHZhbHVlc1swXSwgMCwgdmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzW24gLSAxXSwgbiAtIDEsIHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSArdmFsdWVvZih2YWx1ZXNbaTBdLCBpMCwgdmFsdWVzKSwgdmFsdWUxID0gK3ZhbHVlb2YodmFsdWVzW2kwICsgMV0sIGkwICsgMSwgdmFsdWVzKTsKICByZXR1cm4gdmFsdWUwICsgKHZhbHVlMSAtIHZhbHVlMCkgKiAoaSAtIGkwKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9yYW5nZS5qcwpmdW5jdGlvbiByYW5nZShzdGFydCwgc3RvcCwgc3RlcCkgewogIHN0YXJ0ID0gK3N0YXJ0LCBzdG9wID0gK3N0b3AsIHN0ZXAgPSAobiA9IGFyZ3VtZW50cy5sZW5ndGgpIDwgMiA/IChzdG9wID0gc3RhcnQsIHN0YXJ0ID0gMCwgMSkgOiBuIDwgMyA/IDEgOiArc3RlcDsKICB2YXIgaSA9IC0xLCBuID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCkpIHwgMCwgcmFuZ2U0ID0gbmV3IEFycmF5KG4pOwogIHdoaWxlICgrK2kgPCBuKSB7CiAgICByYW5nZTRbaV0gPSBzdGFydCArIGkgKiBzdGVwOwogIH0KICByZXR1cm4gcmFuZ2U0Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2luaXQuanMKZnVuY3Rpb24gaW5pdFJhbmdlKGRvbWFpbiwgcmFuZ2U0KSB7CiAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICB0aGlzLnJhbmdlKGRvbWFpbik7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhpcy5yYW5nZShyYW5nZTQpLmRvbWFpbihkb21haW4pOwogICAgICBicmVhazsKICB9CiAgcmV0dXJuIHRoaXM7Cn0KZnVuY3Rpb24gaW5pdEludGVycG9sYXRvcihkb21haW4sIGludGVycG9sYXRvcikgewogIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgY2FzZSAwOgogICAgICBicmVhazsKICAgIGNhc2UgMTogewogICAgICBpZiAodHlwZW9mIGRvbWFpbiA9PT0gImZ1bmN0aW9uIikgdGhpcy5pbnRlcnBvbGF0b3IoZG9tYWluKTsKICAgICAgZWxzZSB0aGlzLnJhbmdlKGRvbWFpbik7CiAgICAgIGJyZWFrOwogICAgfQogICAgZGVmYXVsdDogewogICAgICB0aGlzLmRvbWFpbihkb21haW4pOwogICAgICBpZiAodHlwZW9mIGludGVycG9sYXRvciA9PT0gImZ1bmN0aW9uIikgdGhpcy5pbnRlcnBvbGF0b3IoaW50ZXJwb2xhdG9yKTsKICAgICAgZWxzZSB0aGlzLnJhbmdlKGludGVycG9sYXRvcik7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gdGhpczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9vcmRpbmFsLmpzCnZhciBpbXBsaWNpdCA9IFN5bWJvbCgiaW1wbGljaXQiKTsKZnVuY3Rpb24gb3JkaW5hbCgpIHsKICB2YXIgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCksIGRvbWFpbiA9IFtdLCByYW5nZTQgPSBbXSwgdW5rbm93biA9IGltcGxpY2l0OwogIGZ1bmN0aW9uIHNjYWxlKGQpIHsKICAgIGxldCBpID0gaW5kZXguZ2V0KGQpOwogICAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgICBpZiAodW5rbm93biAhPT0gaW1wbGljaXQpIHJldHVybiB1bmtub3duOwogICAgICBpbmRleC5zZXQoZCwgaSA9IGRvbWFpbi5wdXNoKGQpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gcmFuZ2U0W2kgJSByYW5nZTQubGVuZ3RoXTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXSwgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIF8pIHsKICAgICAgaWYgKGluZGV4Lmhhcyh2YWx1ZSkpIGNvbnRpbnVlOwogICAgICBpbmRleC5zZXQodmFsdWUsIGRvbWFpbi5wdXNoKHZhbHVlKSAtIDEpOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBvcmRpbmFsKGRvbWFpbiwgcmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9iYW5kLmpzCmZ1bmN0aW9uIGJhbmQoKSB7CiAgdmFyIHNjYWxlID0gb3JkaW5hbCgpLnVua25vd24odm9pZCAwKSwgZG9tYWluID0gc2NhbGUuZG9tYWluLCBvcmRpbmFsUmFuZ2UgPSBzY2FsZS5yYW5nZSwgcjAgPSAwLCByMSA9IDEsIHN0ZXAsIGJhbmR3aWR0aCwgcm91bmQgPSBmYWxzZSwgcGFkZGluZ0lubmVyID0gMCwgcGFkZGluZ091dGVyID0gMCwgYWxpZ24gPSAwLjU7CiAgZGVsZXRlIHNjYWxlLnVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBuID0gZG9tYWluKCkubGVuZ3RoLCByZXZlcnNlMiA9IHIxIDwgcjAsIHN0YXJ0ID0gcmV2ZXJzZTIgPyByMSA6IHIwLCBzdG9wID0gcmV2ZXJzZTIgPyByMCA6IHIxOwogICAgc3RlcCA9IChzdG9wIC0gc3RhcnQpIC8gTWF0aC5tYXgoMSwgbiAtIHBhZGRpbmdJbm5lciArIHBhZGRpbmdPdXRlciAqIDIpOwogICAgaWYgKHJvdW5kKSBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgIHN0YXJ0ICs9IChzdG9wIC0gc3RhcnQgLSBzdGVwICogKG4gLSBwYWRkaW5nSW5uZXIpKSAqIGFsaWduOwogICAgYmFuZHdpZHRoID0gc3RlcCAqICgxIC0gcGFkZGluZ0lubmVyKTsKICAgIGlmIChyb3VuZCkgc3RhcnQgPSBNYXRoLnJvdW5kKHN0YXJ0KSwgYmFuZHdpZHRoID0gTWF0aC5yb3VuZChiYW5kd2lkdGgpOwogICAgdmFyIHZhbHVlcyA9IHJhbmdlKG4pLm1hcChmdW5jdGlvbihpKSB7CiAgICAgIHJldHVybiBzdGFydCArIHN0ZXAgKiBpOwogICAgfSk7CiAgICByZXR1cm4gb3JkaW5hbFJhbmdlKHJldmVyc2UyID8gdmFsdWVzLnJldmVyc2UoKSA6IHZhbHVlcyk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcmVzY2FsZSgpKSA6IFtyMCwgcjFdOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcm91bmQgPSB0cnVlLCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5iYW5kd2lkdGggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiYW5kd2lkdGg7CiAgfTsKICBzY2FsZS5zdGVwID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc3RlcDsKICB9OwogIHNjYWxlLnJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocm91bmQgPSAhIV8sIHJlc2NhbGUoKSkgOiByb3VuZDsKICB9OwogIHNjYWxlLnBhZGRpbmcgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBwYWRkaW5nT3V0ZXIgPSArXyksIHJlc2NhbGUoKSkgOiBwYWRkaW5nSW5uZXI7CiAgfTsKICBzY2FsZS5wYWRkaW5nSW5uZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBfKSwgcmVzY2FsZSgpKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHNjYWxlLnBhZGRpbmdPdXRlciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdPdXRlciA9ICtfLCByZXNjYWxlKCkpIDogcGFkZGluZ091dGVyOwogIH07CiAgc2NhbGUuYWxpZ24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChhbGlnbiA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIF8pKSwgcmVzY2FsZSgpKSA6IGFsaWduOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGJhbmQoZG9tYWluKCksIFtyMCwgcjFdKS5yb3VuZChyb3VuZCkucGFkZGluZ0lubmVyKHBhZGRpbmdJbm5lcikucGFkZGluZ091dGVyKHBhZGRpbmdPdXRlcikuYWxpZ24oYWxpZ24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShyZXNjYWxlKCksIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gcG9pbnRpc2goc2NhbGUpIHsKICB2YXIgY29weTMgPSBzY2FsZS5jb3B5OwogIHNjYWxlLnBhZGRpbmcgPSBzY2FsZS5wYWRkaW5nT3V0ZXI7CiAgZGVsZXRlIHNjYWxlLnBhZGRpbmdJbm5lcjsKICBkZWxldGUgc2NhbGUucGFkZGluZ091dGVyOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBwb2ludGlzaChjb3B5MygpKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBwb2ludDMoKSB7CiAgcmV0dXJuIHBvaW50aXNoKGJhbmQuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYWRkaW5nSW5uZXIoMSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtY29sb3Ivc3JjL2RlZmluZS5qcwpmdW5jdGlvbiBkZWZpbmVfZGVmYXVsdChjb25zdHJ1Y3RvciwgZmFjdG9yeSwgcHJvdG90eXBlKSB7CiAgY29uc3RydWN0b3IucHJvdG90eXBlID0gZmFjdG9yeS5wcm90b3R5cGUgPSBwcm90b3R5cGU7CiAgcHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29uc3RydWN0b3I7Cn0KZnVuY3Rpb24gZXh0ZW5kKHBhcmVudCwgZGVmaW5pdGlvbikgewogIHZhciBwcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHBhcmVudC5wcm90b3R5cGUpOwogIGZvciAodmFyIGtleSBpbiBkZWZpbml0aW9uKSBwcm90b3R5cGVba2V5XSA9IGRlZmluaXRpb25ba2V5XTsKICByZXR1cm4gcHJvdG90eXBlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtY29sb3Ivc3JjL2NvbG9yLmpzCmZ1bmN0aW9uIENvbG9yKCkgewp9CnZhciBkYXJrZXIgPSAwLjc7CnZhciBicmlnaHRlciA9IDEgLyBkYXJrZXI7CnZhciByZUkgPSAiXFxzKihbKy1dP1xcZCspXFxzKiI7CnZhciByZU4gPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pXFxzKiI7CnZhciByZVAgPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pJVxccyoiOwp2YXIgcmVIZXggPSAvXiMoWzAtOWEtZl17Myw4fSkkLzsKdmFyIHJlUmdiSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlSX0sJHtyZUl9LCR7cmVJfVxcKSRgKTsKdmFyIHJlUmdiUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlUH0sJHtyZVB9LCR7cmVQfVxcKSRgKTsKdmFyIHJlUmdiYUludGVnZXIgPSBuZXcgUmVnRXhwKGBecmdiYVxcKCR7cmVJfSwke3JlSX0sJHtyZUl9LCR7cmVOfVxcKSRgKTsKdmFyIHJlUmdiYVBlcmNlbnQgPSBuZXcgUmVnRXhwKGBecmdiYVxcKCR7cmVQfSwke3JlUH0sJHtyZVB9LCR7cmVOfVxcKSRgKTsKdmFyIHJlSHNsUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xcXCgke3JlTn0sJHtyZVB9LCR7cmVQfVxcKSRgKTsKdmFyIHJlSHNsYVBlcmNlbnQgPSBuZXcgUmVnRXhwKGBeaHNsYVxcKCR7cmVOfSwke3JlUH0sJHtyZVB9LCR7cmVOfVxcKSRgKTsKdmFyIG5hbWVkID0gewogIGFsaWNlYmx1ZTogMTU3OTIzODMsCiAgYW50aXF1ZXdoaXRlOiAxNjQ0NDM3NSwKICBhcXVhOiA2NTUzNSwKICBhcXVhbWFyaW5lOiA4Mzg4NTY0LAogIGF6dXJlOiAxNTc5NDE3NSwKICBiZWlnZTogMTYxMTkyNjAsCiAgYmlzcXVlOiAxNjc3MDI0NCwKICBibGFjazogMCwKICBibGFuY2hlZGFsbW9uZDogMTY3NzIwNDUsCiAgYmx1ZTogMjU1LAogIGJsdWV2aW9sZXQ6IDkwNTUyMDIsCiAgYnJvd246IDEwODI0MjM0LAogIGJ1cmx5d29vZDogMTQ1OTYyMzEsCiAgY2FkZXRibHVlOiA2MjY2NTI4LAogIGNoYXJ0cmV1c2U6IDgzODgzNTIsCiAgY2hvY29sYXRlOiAxMzc4OTQ3MCwKICBjb3JhbDogMTY3NDQyNzIsCiAgY29ybmZsb3dlcmJsdWU6IDY1OTE5ODEsCiAgY29ybnNpbGs6IDE2Nzc1Mzg4LAogIGNyaW1zb246IDE0NDIzMTAwLAogIGN5YW46IDY1NTM1LAogIGRhcmtibHVlOiAxMzksCiAgZGFya2N5YW46IDM1NzIzLAogIGRhcmtnb2xkZW5yb2Q6IDEyMDkyOTM5LAogIGRhcmtncmF5OiAxMTExOTAxNywKICBkYXJrZ3JlZW46IDI1NjAwLAogIGRhcmtncmV5OiAxMTExOTAxNywKICBkYXJra2hha2k6IDEyNDMzMjU5LAogIGRhcmttYWdlbnRhOiA5MTA5NjQzLAogIGRhcmtvbGl2ZWdyZWVuOiA1NTk3OTk5LAogIGRhcmtvcmFuZ2U6IDE2NzQ3NTIwLAogIGRhcmtvcmNoaWQ6IDEwMDQwMDEyLAogIGRhcmtyZWQ6IDkxMDk1MDQsCiAgZGFya3NhbG1vbjogMTUzMDg0MTAsCiAgZGFya3NlYWdyZWVuOiA5NDE5OTE5LAogIGRhcmtzbGF0ZWJsdWU6IDQ3MzQzNDcsCiAgZGFya3NsYXRlZ3JheTogMzEwMDQ5NSwKICBkYXJrc2xhdGVncmV5OiAzMTAwNDk1LAogIGRhcmt0dXJxdW9pc2U6IDUyOTQ1LAogIGRhcmt2aW9sZXQ6IDk2OTk1MzksCiAgZGVlcHBpbms6IDE2NzE2OTQ3LAogIGRlZXBza3libHVlOiA0OTE1MSwKICBkaW1ncmF5OiA2OTA4MjY1LAogIGRpbWdyZXk6IDY5MDgyNjUsCiAgZG9kZ2VyYmx1ZTogMjAwMzE5OSwKICBmaXJlYnJpY2s6IDExNjc0MTQ2LAogIGZsb3JhbHdoaXRlOiAxNjc3NTkyMCwKICBmb3Jlc3RncmVlbjogMjI2Mzg0MiwKICBmdWNoc2lhOiAxNjcxMTkzNSwKICBnYWluc2Jvcm86IDE0NDc0NDYwLAogIGdob3N0d2hpdGU6IDE2MzE2NjcxLAogIGdvbGQ6IDE2NzY2NzIwLAogIGdvbGRlbnJvZDogMTQzMjkxMjAsCiAgZ3JheTogODQyMTUwNCwKICBncmVlbjogMzI3NjgsCiAgZ3JlZW55ZWxsb3c6IDExNDAzMDU1LAogIGdyZXk6IDg0MjE1MDQsCiAgaG9uZXlkZXc6IDE1Nzk0MTYwLAogIGhvdHBpbms6IDE2NzM4NzQwLAogIGluZGlhbnJlZDogMTM0NTg1MjQsCiAgaW5kaWdvOiA0OTE1MzMwLAogIGl2b3J5OiAxNjc3NzIwMCwKICBraGFraTogMTU3ODc2NjAsCiAgbGF2ZW5kZXI6IDE1MTMyNDEwLAogIGxhdmVuZGVyYmx1c2g6IDE2NzczMzY1LAogIGxhd25ncmVlbjogODE5MDk3NiwKICBsZW1vbmNoaWZmb246IDE2Nzc1ODg1LAogIGxpZ2h0Ymx1ZTogMTEzOTMyNTQsCiAgbGlnaHRjb3JhbDogMTU3NjE1MzYsCiAgbGlnaHRjeWFuOiAxNDc0NTU5OSwKICBsaWdodGdvbGRlbnJvZHllbGxvdzogMTY0NDgyMTAsCiAgbGlnaHRncmF5OiAxMzg4MjMyMywKICBsaWdodGdyZWVuOiA5NDk4MjU2LAogIGxpZ2h0Z3JleTogMTM4ODIzMjMsCiAgbGlnaHRwaW5rOiAxNjc1ODQ2NSwKICBsaWdodHNhbG1vbjogMTY3NTI3NjIsCiAgbGlnaHRzZWFncmVlbjogMjE0Mjg5MCwKICBsaWdodHNreWJsdWU6IDg5MDAzNDYsCiAgbGlnaHRzbGF0ZWdyYXk6IDc4MzM3NTMsCiAgbGlnaHRzbGF0ZWdyZXk6IDc4MzM3NTMsCiAgbGlnaHRzdGVlbGJsdWU6IDExNTg0NzM0LAogIGxpZ2h0eWVsbG93OiAxNjc3NzE4NCwKICBsaW1lOiA2NTI4MCwKICBsaW1lZ3JlZW46IDMzMjkzMzAsCiAgbGluZW46IDE2NDQ1NjcwLAogIG1hZ2VudGE6IDE2NzExOTM1LAogIG1hcm9vbjogODM4ODYwOCwKICBtZWRpdW1hcXVhbWFyaW5lOiA2NzM3MzIyLAogIG1lZGl1bWJsdWU6IDIwNSwKICBtZWRpdW1vcmNoaWQ6IDEyMjExNjY3LAogIG1lZGl1bXB1cnBsZTogOTY2MjY4MywKICBtZWRpdW1zZWFncmVlbjogMzk3ODA5NywKICBtZWRpdW1zbGF0ZWJsdWU6IDgwODc3OTAsCiAgbWVkaXVtc3ByaW5nZ3JlZW46IDY0MTU0LAogIG1lZGl1bXR1cnF1b2lzZTogNDc3MjMwMCwKICBtZWRpdW12aW9sZXRyZWQ6IDEzMDQ3MTczLAogIG1pZG5pZ2h0Ymx1ZTogMTY0NDkxMiwKICBtaW50Y3JlYW06IDE2MTIxODUwLAogIG1pc3R5cm9zZTogMTY3NzAyNzMsCiAgbW9jY2FzaW46IDE2NzcwMjI5LAogIG5hdmFqb3doaXRlOiAxNjc2ODY4NSwKICBuYXZ5OiAxMjgsCiAgb2xkbGFjZTogMTY2NDM1NTgsCiAgb2xpdmU6IDg0MjEzNzYsCiAgb2xpdmVkcmFiOiA3MDQ4NzM5LAogIG9yYW5nZTogMTY3NTM5MjAsCiAgb3JhbmdlcmVkOiAxNjcyOTM0NCwKICBvcmNoaWQ6IDE0MzE1NzM0LAogIHBhbGVnb2xkZW5yb2Q6IDE1NjU3MTMwLAogIHBhbGVncmVlbjogMTAwMjU4ODAsCiAgcGFsZXR1cnF1b2lzZTogMTE1Mjk5NjYsCiAgcGFsZXZpb2xldHJlZDogMTQzODEyMDMsCiAgcGFwYXlhd2hpcDogMTY3NzMwNzcsCiAgcGVhY2hwdWZmOiAxNjc2NzY3MywKICBwZXJ1OiAxMzQ2ODk5MSwKICBwaW5rOiAxNjc2MTAzNSwKICBwbHVtOiAxNDUyNDYzNywKICBwb3dkZXJibHVlOiAxMTU5MTkxMCwKICBwdXJwbGU6IDgzODg3MzYsCiAgcmViZWNjYXB1cnBsZTogNjY5Nzg4MSwKICByZWQ6IDE2NzExNjgwLAogIHJvc3licm93bjogMTIzNTc1MTksCiAgcm95YWxibHVlOiA0Mjg2OTQ1LAogIHNhZGRsZWJyb3duOiA5MTI3MTg3LAogIHNhbG1vbjogMTY0MTY4ODIsCiAgc2FuZHlicm93bjogMTYwMzI4NjQsCiAgc2VhZ3JlZW46IDMwNTAzMjcsCiAgc2Vhc2hlbGw6IDE2Nzc0NjM4LAogIHNpZW5uYTogMTA1MDY3OTcsCiAgc2lsdmVyOiAxMjYzMjI1NiwKICBza3libHVlOiA4OTAwMzMxLAogIHNsYXRlYmx1ZTogNjk3MDA2MSwKICBzbGF0ZWdyYXk6IDczNzI5NDQsCiAgc2xhdGVncmV5OiA3MzcyOTQ0LAogIHNub3c6IDE2Nzc1OTMwLAogIHNwcmluZ2dyZWVuOiA2NTQwNywKICBzdGVlbGJsdWU6IDQ2MjA5ODAsCiAgdGFuOiAxMzgwODc4MCwKICB0ZWFsOiAzMjg5NiwKICB0aGlzdGxlOiAxNDIwNDg4OCwKICB0b21hdG86IDE2NzM3MDk1LAogIHR1cnF1b2lzZTogNDI1MTg1NiwKICB2aW9sZXQ6IDE1NjMxMDg2LAogIHdoZWF0OiAxNjExMzMzMSwKICB3aGl0ZTogMTY3NzcyMTUsCiAgd2hpdGVzbW9rZTogMTYxMTkyODUsCiAgeWVsbG93OiAxNjc3Njk2MCwKICB5ZWxsb3dncmVlbjogMTAxNDUwNzQKfTsKZGVmaW5lX2RlZmF1bHQoQ29sb3IsIGNvbG9yLCB7CiAgY29weShjaGFubmVscykgewogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IHRoaXMuY29uc3RydWN0b3IoKSwgdGhpcywgY2hhbm5lbHMpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5yZ2IoKS5kaXNwbGF5YWJsZSgpOwogIH0sCiAgaGV4OiBjb2xvcl9mb3JtYXRIZXgsCiAgLy8gRGVwcmVjYXRlZCEgVXNlIGNvbG9yLmZvcm1hdEhleC4KICBmb3JtYXRIZXg6IGNvbG9yX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiBjb2xvcl9mb3JtYXRIZXg4LAogIGZvcm1hdEhzbDogY29sb3JfZm9ybWF0SHNsLAogIGZvcm1hdFJnYjogY29sb3JfZm9ybWF0UmdiLAogIHRvU3RyaW5nOiBjb2xvcl9mb3JtYXRSZ2IKfSk7CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleCgpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXgoKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXg4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleDgoKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIc2woKSB7CiAgcmV0dXJuIGhzbENvbnZlcnQodGhpcykuZm9ybWF0SHNsKCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0UmdiKCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdFJnYigpOwp9CmZ1bmN0aW9uIGNvbG9yKGZvcm1hdDIpIHsKICB2YXIgbSwgbDsKICBmb3JtYXQyID0gKGZvcm1hdDIgKyAiIikudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgcmV0dXJuIChtID0gcmVIZXguZXhlYyhmb3JtYXQyKSkgPyAobCA9IG1bMV0ubGVuZ3RoLCBtID0gcGFyc2VJbnQobVsxXSwgMTYpLCBsID09PSA2ID8gcmdibihtKSA6IGwgPT09IDMgPyBuZXcgUmdiKG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsIChtICYgMTUpIDw8IDQgfCBtICYgMTUsIDEpIDogbCA9PT0gOCA/IHJnYmEobSA+PiAyNCAmIDI1NSwgbSA+PiAxNiAmIDI1NSwgbSA+PiA4ICYgMjU1LCAobSAmIDI1NSkgLyAyNTUpIDogbCA9PT0gNCA/IHJnYmEobSA+PiAxMiAmIDE1IHwgbSA+PiA4ICYgMjQwLCBtID4+IDggJiAxNSB8IG0gPj4gNCAmIDI0MCwgbSA+PiA0ICYgMTUgfCBtICYgMjQwLCAoKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSkgLyAyNTUpIDogbnVsbCkgOiAobSA9IHJlUmdiSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IG5ldyBSZ2IobVsxXSwgbVsyXSwgbVszXSwgMSkgOiAobSA9IHJlUmdiUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IG5ldyBSZ2IobVsxXSAqIDI1NSAvIDEwMCwgbVsyXSAqIDI1NSAvIDEwMCwgbVszXSAqIDI1NSAvIDEwMCwgMSkgOiAobSA9IHJlUmdiYUludGVnZXIuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0sIG1bMl0sIG1bM10sIG1bNF0pIDogKG0gPSByZVJnYmFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gcmdiYShtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCBtWzRdKSA6IChtID0gcmVIc2xQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCAxKSA6IChtID0gcmVIc2xhUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IGhzbGEobVsxXSwgbVsyXSAvIDEwMCwgbVszXSAvIDEwMCwgbVs0XSkgOiBuYW1lZC5oYXNPd25Qcm9wZXJ0eShmb3JtYXQyKSA/IHJnYm4obmFtZWRbZm9ybWF0Ml0pIDogZm9ybWF0MiA9PT0gInRyYW5zcGFyZW50IiA/IG5ldyBSZ2IoTmFOLCBOYU4sIE5hTiwgMCkgOiBudWxsOwp9CmZ1bmN0aW9uIHJnYm4obikgewogIHJldHVybiBuZXcgUmdiKG4gPj4gMTYgJiAyNTUsIG4gPj4gOCAmIDI1NSwgbiAmIDI1NSwgMSk7Cn0KZnVuY3Rpb24gcmdiYShyMiwgZywgYiwgYSkgewogIGlmIChhIDw9IDApIHIyID0gZyA9IGIgPSBOYU47CiAgcmV0dXJuIG5ldyBSZ2IocjIsIGcsIGIsIGEpOwp9CmZ1bmN0aW9uIHJnYkNvbnZlcnQobykgewogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgUmdiKCk7CiAgbyA9IG8ucmdiKCk7CiAgcmV0dXJuIG5ldyBSZ2Ioby5yLCBvLmcsIG8uYiwgby5vcGFjaXR5KTsKfQpmdW5jdGlvbiByZ2IocjIsIGcsIGIsIG9wYWNpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHJnYkNvbnZlcnQocjIpIDogbmV3IFJnYihyMiwgZywgYiwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwp9CmZ1bmN0aW9uIFJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHRoaXMuciA9ICtyMjsKICB0aGlzLmcgPSArZzsKICB0aGlzLmIgPSArYjsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChSZ2IsIHJnYiwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIGRhcmtlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgIHJldHVybiBuZXcgUmdiKHRoaXMuciAqIGssIHRoaXMuZyAqIGssIHRoaXMuYiAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICByZ2IoKSB7CiAgICByZXR1cm4gdGhpczsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBSZ2IoY2xhbXBpKHRoaXMuciksIGNsYW1waSh0aGlzLmcpLCBjbGFtcGkodGhpcy5iKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gLTAuNSA8PSB0aGlzLnIgJiYgdGhpcy5yIDwgMjU1LjUgJiYgKC0wLjUgPD0gdGhpcy5nICYmIHRoaXMuZyA8IDI1NS41KSAmJiAoLTAuNSA8PSB0aGlzLmIgJiYgdGhpcy5iIDwgMjU1LjUpICYmICgwIDw9IHRoaXMub3BhY2l0eSAmJiB0aGlzLm9wYWNpdHkgPD0gMSk7CiAgfSwKICBoZXg6IHJnYl9mb3JtYXRIZXgsCiAgLy8gRGVwcmVjYXRlZCEgVXNlIGNvbG9yLmZvcm1hdEhleC4KICBmb3JtYXRIZXg6IHJnYl9mb3JtYXRIZXgsCiAgZm9ybWF0SGV4ODogcmdiX2Zvcm1hdEhleDgsCiAgZm9ybWF0UmdiOiByZ2JfZm9ybWF0UmdiLAogIHRvU3RyaW5nOiByZ2JfZm9ybWF0UmdiCn0pKTsKZnVuY3Rpb24gcmdiX2Zvcm1hdEhleCgpIHsKICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX1gOwp9CmZ1bmN0aW9uIHJnYl9mb3JtYXRIZXg4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfSR7aGV4KChpc05hTih0aGlzLm9wYWNpdHkpID8gMSA6IHRoaXMub3BhY2l0eSkgKiAyNTUpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdFJnYigpIHsKICBjb25zdCBhID0gY2xhbXBhKHRoaXMub3BhY2l0eSk7CiAgcmV0dXJuIGAke2EgPT09IDEgPyAicmdiKCIgOiAicmdiYSgifSR7Y2xhbXBpKHRoaXMucil9LCAke2NsYW1waSh0aGlzLmcpfSwgJHtjbGFtcGkodGhpcy5iKX0ke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKfQpmdW5jdGlvbiBjbGFtcGEob3BhY2l0eSkgewogIHJldHVybiBpc05hTihvcGFjaXR5KSA/IDEgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBvcGFjaXR5KSk7Cn0KZnVuY3Rpb24gY2xhbXBpKHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDI1NSwgTWF0aC5yb3VuZCh2YWx1ZSkgfHwgMCkpOwp9CmZ1bmN0aW9uIGhleCh2YWx1ZSkgewogIHZhbHVlID0gY2xhbXBpKHZhbHVlKTsKICByZXR1cm4gKHZhbHVlIDwgMTYgPyAiMCIgOiAiIikgKyB2YWx1ZS50b1N0cmluZygxNik7Cn0KZnVuY3Rpb24gaHNsYShoLCBzLCBsLCBhKSB7CiAgaWYgKGEgPD0gMCkgaCA9IHMgPSBsID0gTmFOOwogIGVsc2UgaWYgKGwgPD0gMCB8fCBsID49IDEpIGggPSBzID0gTmFOOwogIGVsc2UgaWYgKHMgPD0gMCkgaCA9IE5hTjsKICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBhKTsKfQpmdW5jdGlvbiBoc2xDb252ZXJ0KG8pIHsKICBpZiAobyBpbnN0YW5jZW9mIEhzbCkgcmV0dXJuIG5ldyBIc2woby5oLCBvLnMsIG8ubCwgby5vcGFjaXR5KTsKICBpZiAoIShvIGluc3RhbmNlb2YgQ29sb3IpKSBvID0gY29sb3Iobyk7CiAgaWYgKCFvKSByZXR1cm4gbmV3IEhzbCgpOwogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbzsKICBvID0gby5yZ2IoKTsKICB2YXIgcjIgPSBvLnIgLyAyNTUsIGcgPSBvLmcgLyAyNTUsIGIgPSBvLmIgLyAyNTUsIG1pbjIgPSBNYXRoLm1pbihyMiwgZywgYiksIG1heDIgPSBNYXRoLm1heChyMiwgZywgYiksIGggPSBOYU4sIHMgPSBtYXgyIC0gbWluMiwgbCA9IChtYXgyICsgbWluMikgLyAyOwogIGlmIChzKSB7CiAgICBpZiAocjIgPT09IG1heDIpIGggPSAoZyAtIGIpIC8gcyArIChnIDwgYikgKiA2OwogICAgZWxzZSBpZiAoZyA9PT0gbWF4MikgaCA9IChiIC0gcjIpIC8gcyArIDI7CiAgICBlbHNlIGggPSAocjIgLSBnKSAvIHMgKyA0OwogICAgcyAvPSBsIDwgMC41ID8gbWF4MiArIG1pbjIgOiAyIC0gbWF4MiAtIG1pbjI7CiAgICBoICo9IDYwOwogIH0gZWxzZSB7CiAgICBzID0gbCA+IDAgJiYgbCA8IDEgPyAwIDogaDsKICB9CiAgcmV0dXJuIG5ldyBIc2woaCwgcywgbCwgby5vcGFjaXR5KTsKfQpmdW5jdGlvbiBoc2woaCwgcywgbCwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gaHNsQ29udmVydChoKSA6IG5ldyBIc2woaCwgcywgbCwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwp9CmZ1bmN0aW9uIEhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgdGhpcy5oID0gK2g7CiAgdGhpcy5zID0gK3M7CiAgdGhpcy5sID0gK2w7CiAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7Cn0KZGVmaW5lX2RlZmF1bHQoSHNsLCBoc2wsIGV4dGVuZChDb2xvciwgewogIGJyaWdodGVyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgIHJldHVybiBuZXcgSHNsKHRoaXMuaCwgdGhpcy5zLCB0aGlzLmwgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICByZ2IoKSB7CiAgICB2YXIgaCA9IHRoaXMuaCAlIDM2MCArICh0aGlzLmggPCAwKSAqIDM2MCwgcyA9IGlzTmFOKGgpIHx8IGlzTmFOKHRoaXMucykgPyAwIDogdGhpcy5zLCBsID0gdGhpcy5sLCBtMiA9IGwgKyAobCA8IDAuNSA/IGwgOiAxIC0gbCkgKiBzLCBtMSA9IDIgKiBsIC0gbTI7CiAgICByZXR1cm4gbmV3IFJnYigKICAgICAgaHNsMnJnYihoID49IDI0MCA/IGggLSAyNDAgOiBoICsgMTIwLCBtMSwgbTIpLAogICAgICBoc2wycmdiKGgsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCA8IDEyMCA/IGggKyAyNDAgOiBoIC0gMTIwLCBtMSwgbTIpLAogICAgICB0aGlzLm9wYWNpdHkKICAgICk7CiAgfSwKICBjbGFtcCgpIHsKICAgIHJldHVybiBuZXcgSHNsKGNsYW1waCh0aGlzLmgpLCBjbGFtcHQodGhpcy5zKSwgY2xhbXB0KHRoaXMubCksIGNsYW1wYSh0aGlzLm9wYWNpdHkpKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuICgwIDw9IHRoaXMucyAmJiB0aGlzLnMgPD0gMSB8fCBpc05hTih0aGlzLnMpKSAmJiAoMCA8PSB0aGlzLmwgJiYgdGhpcy5sIDw9IDEpICYmICgwIDw9IHRoaXMub3BhY2l0eSAmJiB0aGlzLm9wYWNpdHkgPD0gMSk7CiAgfSwKICBmb3JtYXRIc2woKSB7CiAgICBjb25zdCBhID0gY2xhbXBhKHRoaXMub3BhY2l0eSk7CiAgICByZXR1cm4gYCR7YSA9PT0gMSA/ICJoc2woIiA6ICJoc2xhKCJ9JHtjbGFtcGgodGhpcy5oKX0sICR7Y2xhbXB0KHRoaXMucykgKiAxMDB9JSwgJHtjbGFtcHQodGhpcy5sKSAqIDEwMH0lJHthID09PSAxID8gIikiIDogYCwgJHthfSlgfWA7CiAgfQp9KSk7CmZ1bmN0aW9uIGNsYW1waCh2YWx1ZSkgewogIHZhbHVlID0gKHZhbHVlIHx8IDApICUgMzYwOwogIHJldHVybiB2YWx1ZSA8IDAgPyB2YWx1ZSArIDM2MCA6IHZhbHVlOwp9CmZ1bmN0aW9uIGNsYW1wdCh2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB2YWx1ZSB8fCAwKSk7Cn0KZnVuY3Rpb24gaHNsMnJnYihoLCBtMSwgbTIpIHsKICByZXR1cm4gKGggPCA2MCA/IG0xICsgKG0yIC0gbTEpICogaCAvIDYwIDogaCA8IDE4MCA/IG0yIDogaCA8IDI0MCA/IG0xICsgKG0yIC0gbTEpICogKDI0MCAtIGgpIC8gNjAgOiBtMSkgKiAyNTU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYmFzaXMuanMKZnVuY3Rpb24gYmFzaXModDEyLCB2MCwgdjEsIHYyLCB2MykgewogIHZhciB0MiA9IHQxMiAqIHQxMiwgdDMgPSB0MiAqIHQxMjsKICByZXR1cm4gKCgxIC0gMyAqIHQxMiArIDMgKiB0MiAtIHQzKSAqIHYwICsgKDQgLSA2ICogdDIgKyAzICogdDMpICogdjEgKyAoMSArIDMgKiB0MTIgKyAzICogdDIgLSAzICogdDMpICogdjIgKyB0MyAqIHYzKSAvIDY7Cn0KZnVuY3Rpb24gYmFzaXNfZGVmYXVsdDIodmFsdWVzKSB7CiAgdmFyIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSB0IDw9IDAgPyB0ID0gMCA6IHQgPj0gMSA/ICh0ID0gMSwgbiAtIDEpIDogTWF0aC5mbG9vcih0ICogbiksIHYxID0gdmFsdWVzW2ldLCB2MiA9IHZhbHVlc1tpICsgMV0sIHYwID0gaSA+IDAgPyB2YWx1ZXNbaSAtIDFdIDogMiAqIHYxIC0gdjIsIHYzID0gaSA8IG4gLSAxID8gdmFsdWVzW2kgKyAyXSA6IDIgKiB2MiAtIHYxOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYmFzaXNDbG9zZWQuanMKZnVuY3Rpb24gYmFzaXNDbG9zZWRfZGVmYXVsdDIodmFsdWVzKSB7CiAgdmFyIG4gPSB2YWx1ZXMubGVuZ3RoOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaSA9IE1hdGguZmxvb3IoKCh0ICU9IDEpIDwgMCA/ICsrdCA6IHQpICogbiksIHYwID0gdmFsdWVzWyhpICsgbiAtIDEpICUgbl0sIHYxID0gdmFsdWVzW2kgJSBuXSwgdjIgPSB2YWx1ZXNbKGkgKyAxKSAlIG5dLCB2MyA9IHZhbHVlc1soaSArIDIpICUgbl07CiAgICByZXR1cm4gYmFzaXMoKHQgLSBpIC8gbikgKiBuLCB2MCwgdjEsIHYyLCB2Myk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb25zdGFudC5qcwp2YXIgY29uc3RhbnRfZGVmYXVsdDIgPSAoeDIpID0+ICgpID0+IHgyOwoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBsaW5lYXIoYSwgZCkgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYSArIHQgKiBkOwogIH07Cn0KZnVuY3Rpb24gZXhwb25lbnRpYWwoYSwgYiwgeTIpIHsKICByZXR1cm4gYSA9IE1hdGgucG93KGEsIHkyKSwgYiA9IE1hdGgucG93KGIsIHkyKSAtIGEsIHkyID0gMSAvIHkyLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gTWF0aC5wb3coYSArIHQgKiBiLCB5Mik7CiAgfTsKfQpmdW5jdGlvbiBnYW1tYSh5MikgewogIHJldHVybiAoeTIgPSAreTIpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBiIC0gYSA/IGV4cG9uZW50aWFsKGEsIGIsIHkyKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwogIH07Cn0KZnVuY3Rpb24gbm9nYW1tYShhLCBiKSB7CiAgdmFyIGQgPSBiIC0gYTsKICByZXR1cm4gZCA/IGxpbmVhcihhLCBkKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3JnYi5qcwp2YXIgcmdiX2RlZmF1bHQgPSBmdW5jdGlvbiByZ2JHYW1tYSh5MikgewogIHZhciBjb2xvcjIgPSBnYW1tYSh5Mik7CiAgZnVuY3Rpb24gcmdiMihzdGFydCwgZW5kKSB7CiAgICB2YXIgcjIgPSBjb2xvcjIoKHN0YXJ0ID0gcmdiKHN0YXJ0KSkuciwgKGVuZCA9IHJnYihlbmQpKS5yKSwgZyA9IGNvbG9yMihzdGFydC5nLCBlbmQuZyksIGIgPSBjb2xvcjIoc3RhcnQuYiwgZW5kLmIpLCBvcGFjaXR5ID0gbm9nYW1tYShzdGFydC5vcGFjaXR5LCBlbmQub3BhY2l0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBzdGFydC5yID0gcjIodCk7CiAgICAgIHN0YXJ0LmcgPSBnKHQpOwogICAgICBzdGFydC5iID0gYih0KTsKICAgICAgc3RhcnQub3BhY2l0eSA9IG9wYWNpdHkodCk7CiAgICAgIHJldHVybiBzdGFydCArICIiOwogICAgfTsKICB9CiAgcmdiMi5nYW1tYSA9IHJnYkdhbW1hOwogIHJldHVybiByZ2IyOwp9KDEpOwpmdW5jdGlvbiByZ2JTcGxpbmUoc3BsaW5lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGNvbG9ycykgewogICAgdmFyIG4gPSBjb2xvcnMubGVuZ3RoLCByMiA9IG5ldyBBcnJheShuKSwgZyA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgaSwgY29sb3IyOwogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICBjb2xvcjIgPSByZ2IoY29sb3JzW2ldKTsKICAgICAgcjJbaV0gPSBjb2xvcjIuciB8fCAwOwogICAgICBnW2ldID0gY29sb3IyLmcgfHwgMDsKICAgICAgYltpXSA9IGNvbG9yMi5iIHx8IDA7CiAgICB9CiAgICByMiA9IHNwbGluZShyMik7CiAgICBnID0gc3BsaW5lKGcpOwogICAgYiA9IHNwbGluZShiKTsKICAgIGNvbG9yMi5vcGFjaXR5ID0gMTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIGNvbG9yMi5yID0gcjIodCk7CiAgICAgIGNvbG9yMi5nID0gZyh0KTsKICAgICAgY29sb3IyLmIgPSBiKHQpOwogICAgICByZXR1cm4gY29sb3IyICsgIiI7CiAgICB9OwogIH07Cn0KdmFyIHJnYkJhc2lzID0gcmdiU3BsaW5lKGJhc2lzX2RlZmF1bHQyKTsKdmFyIHJnYkJhc2lzQ2xvc2VkID0gcmdiU3BsaW5lKGJhc2lzQ2xvc2VkX2RlZmF1bHQyKTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyQXJyYXkuanMKZnVuY3Rpb24gbnVtYmVyQXJyYXlfZGVmYXVsdChhLCBiKSB7CiAgaWYgKCFiKSBiID0gW107CiAgdmFyIG4gPSBhID8gTWF0aC5taW4oYi5sZW5ndGgsIGEubGVuZ3RoKSA6IDAsIGMgPSBiLnNsaWNlKCksIGk7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIGNbaV0gPSBhW2ldICogKDEgLSB0KSArIGJbaV0gKiB0OwogICAgcmV0dXJuIGM7CiAgfTsKfQpmdW5jdGlvbiBpc051bWJlckFycmF5KHgyKSB7CiAgcmV0dXJuIEFycmF5QnVmZmVyLmlzVmlldyh4MikgJiYgISh4MiBpbnN0YW5jZW9mIERhdGFWaWV3KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9hcnJheS5qcwpmdW5jdGlvbiBnZW5lcmljQXJyYXkoYSwgYikgewogIHZhciBuYiA9IGIgPyBiLmxlbmd0aCA6IDAsIG5hID0gYSA/IE1hdGgubWluKG5iLCBhLmxlbmd0aCkgOiAwLCB4MiA9IG5ldyBBcnJheShuYSksIGMgPSBuZXcgQXJyYXkobmIpLCBpOwogIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSB4MltpXSA9IHZhbHVlX2RlZmF1bHQoYVtpXSwgYltpXSk7CiAgZm9yICg7IGkgPCBuYjsgKytpKSBjW2ldID0gYltpXTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIGNbaV0gPSB4MltpXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvZGF0ZS5qcwpmdW5jdGlvbiBkYXRlX2RlZmF1bHQoYSwgYikgewogIHZhciBkID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CiAgcmV0dXJuIGEgPSArYSwgYiA9ICtiLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gZC5zZXRUaW1lKGEgKiAoMSAtIHQpICsgYiAqIHQpLCBkOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcl9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBhICogKDEgLSB0KSArIGIgKiB0OwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvb2JqZWN0LmpzCmZ1bmN0aW9uIG9iamVjdF9kZWZhdWx0KGEsIGIpIHsKICB2YXIgaSA9IHt9LCBjID0ge30sIGs7CiAgaWYgKGEgPT09IG51bGwgfHwgdHlwZW9mIGEgIT09ICJvYmplY3QiKSBhID0ge307CiAgaWYgKGIgPT09IG51bGwgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSBiID0ge307CiAgZm9yIChrIGluIGIpIHsKICAgIGlmIChrIGluIGEpIHsKICAgICAgaVtrXSA9IHZhbHVlX2RlZmF1bHQoYVtrXSwgYltrXSk7CiAgICB9IGVsc2UgewogICAgICBjW2tdID0gYltrXTsKICAgIH0KICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoayBpbiBpKSBjW2tdID0gaVtrXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvc3RyaW5nLmpzCnZhciByZUEgPSAvWy0rXT8oPzpcZCtcLj9cZCp8XC4/XGQrKSg/OltlRV1bLStdP1xkKyk/L2c7CnZhciByZUIgPSBuZXcgUmVnRXhwKHJlQS5zb3VyY2UsICJnIik7CmZ1bmN0aW9uIHplcm8yKGIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYjsKICB9Owp9CmZ1bmN0aW9uIG9uZShiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBiKHQpICsgIiI7CiAgfTsKfQpmdW5jdGlvbiBzdHJpbmdfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGJpID0gcmVBLmxhc3RJbmRleCA9IHJlQi5sYXN0SW5kZXggPSAwLCBhbSwgYm0sIGJzLCBpID0gLTEsIHMgPSBbXSwgcSA9IFtdOwogIGEgPSBhICsgIiIsIGIgPSBiICsgIiI7CiAgd2hpbGUgKChhbSA9IHJlQS5leGVjKGEpKSAmJiAoYm0gPSByZUIuZXhlYyhiKSkpIHsKICAgIGlmICgoYnMgPSBibS5pbmRleCkgPiBiaSkgewogICAgICBicyA9IGIuc2xpY2UoYmksIGJzKTsKICAgICAgaWYgKHNbaV0pIHNbaV0gKz0gYnM7CiAgICAgIGVsc2Ugc1srK2ldID0gYnM7CiAgICB9CiAgICBpZiAoKGFtID0gYW1bMF0pID09PSAoYm0gPSBibVswXSkpIHsKICAgICAgaWYgKHNbaV0pIHNbaV0gKz0gYm07CiAgICAgIGVsc2Ugc1srK2ldID0gYm07CiAgICB9IGVsc2UgewogICAgICBzWysraV0gPSBudWxsOwogICAgICBxLnB1c2goeyBpLCB4OiBudW1iZXJfZGVmYXVsdChhbSwgYm0pIH0pOwogICAgfQogICAgYmkgPSByZUIubGFzdEluZGV4OwogIH0KICBpZiAoYmkgPCBiLmxlbmd0aCkgewogICAgYnMgPSBiLnNsaWNlKGJpKTsKICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOwogICAgZWxzZSBzWysraV0gPSBiczsKICB9CiAgcmV0dXJuIHMubGVuZ3RoIDwgMiA/IHFbMF0gPyBvbmUocVswXS54KSA6IHplcm8yKGIpIDogKGIgPSBxLmxlbmd0aCwgZnVuY3Rpb24odCkgewogICAgZm9yICh2YXIgaTIgPSAwLCBvOyBpMiA8IGI7ICsraTIpIHNbKG8gPSBxW2kyXSkuaV0gPSBvLngodCk7CiAgICByZXR1cm4gcy5qb2luKCIiKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy92YWx1ZS5qcwpmdW5jdGlvbiB2YWx1ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgdCA9IHR5cGVvZiBiLCBjOwogIHJldHVybiBiID09IG51bGwgfHwgdCA9PT0gImJvb2xlYW4iID8gY29uc3RhbnRfZGVmYXVsdDIoYikgOiAodCA9PT0gIm51bWJlciIgPyBudW1iZXJfZGVmYXVsdCA6IHQgPT09ICJzdHJpbmciID8gKGMgPSBjb2xvcihiKSkgPyAoYiA9IGMsIHJnYl9kZWZhdWx0KSA6IHN0cmluZ19kZWZhdWx0IDogYiBpbnN0YW5jZW9mIGNvbG9yID8gcmdiX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgRGF0ZSA/IGRhdGVfZGVmYXVsdCA6IGlzTnVtYmVyQXJyYXkoYikgPyBudW1iZXJBcnJheV9kZWZhdWx0IDogQXJyYXkuaXNBcnJheShiKSA/IGdlbmVyaWNBcnJheSA6IHR5cGVvZiBiLnZhbHVlT2YgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGIudG9TdHJpbmcgIT09ICJmdW5jdGlvbiIgfHwgaXNOYU4oYikgPyBvYmplY3RfZGVmYXVsdCA6IG51bWJlcl9kZWZhdWx0KShhLCBiKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yb3VuZC5qcwpmdW5jdGlvbiByb3VuZF9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAoMSAtIHQpICsgYiAqIHQpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcGllY2V3aXNlLmpzCmZ1bmN0aW9uIHBpZWNld2lzZShpbnRlcnBvbGF0ZTIsIHZhbHVlcykgewogIGlmICh2YWx1ZXMgPT09IHZvaWQgMCkgdmFsdWVzID0gaW50ZXJwb2xhdGUyLCBpbnRlcnBvbGF0ZTIgPSB2YWx1ZV9kZWZhdWx0OwogIHZhciBpID0gMCwgbiA9IHZhbHVlcy5sZW5ndGggLSAxLCB2ID0gdmFsdWVzWzBdLCBJID0gbmV3IEFycmF5KG4gPCAwID8gMCA6IG4pOwogIHdoaWxlIChpIDwgbikgSVtpXSA9IGludGVycG9sYXRlMih2LCB2ID0gdmFsdWVzWysraV0pOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaTIgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihuIC0gMSwgTWF0aC5mbG9vcih0ICo9IG4pKSk7CiAgICByZXR1cm4gSVtpMl0odCAtIGkyKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50cyh4MikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB4MjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIyKHgyKSB7CiAgcmV0dXJuICt4MjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9jb250aW51b3VzLmpzCnZhciB1bml0ID0gWzAsIDFdOwpmdW5jdGlvbiBpZGVudGl0eSh4MikgewogIHJldHVybiB4MjsKfQpmdW5jdGlvbiBub3JtYWxpemUoYSwgYikgewogIHJldHVybiAoYiAtPSBhID0gK2EpID8gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiAoeDIgLSBhKSAvIGI7CiAgfSA6IGNvbnN0YW50cyhpc05hTihiKSA/IE5hTiA6IDAuNSk7Cn0KZnVuY3Rpb24gY2xhbXBlcihhLCBiKSB7CiAgdmFyIHQ7CiAgaWYgKGEgPiBiKSB0ID0gYSwgYSA9IGIsIGIgPSB0OwogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGgubWF4KGEsIE1hdGgubWluKGIsIHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBiaW1hcChkb21haW4sIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSB7CiAgdmFyIGQwID0gZG9tYWluWzBdLCBkMSA9IGRvbWFpblsxXSwgcjAgPSByYW5nZTRbMF0sIHIxID0gcmFuZ2U0WzFdOwogIGlmIChkMSA8IGQwKSBkMCA9IG5vcm1hbGl6ZShkMSwgZDApLCByMCA9IGludGVycG9sYXRlMihyMSwgcjApOwogIGVsc2UgZDAgPSBub3JtYWxpemUoZDAsIGQxKSwgcjAgPSBpbnRlcnBvbGF0ZTIocjAsIHIxKTsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiByMChkMCh4MikpOwogIH07Cn0KZnVuY3Rpb24gcG9seW1hcChkb21haW4sIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSB7CiAgdmFyIGogPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoKSAtIDEsIGQgPSBuZXcgQXJyYXkoaiksIHIyID0gbmV3IEFycmF5KGopLCBpID0gLTE7CiAgaWYgKGRvbWFpbltqXSA8IGRvbWFpblswXSkgewogICAgZG9tYWluID0gZG9tYWluLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgcmFuZ2U0ID0gcmFuZ2U0LnNsaWNlKCkucmV2ZXJzZSgpOwogIH0KICB3aGlsZSAoKytpIDwgaikgewogICAgZFtpXSA9IG5vcm1hbGl6ZShkb21haW5baV0sIGRvbWFpbltpICsgMV0pOwogICAgcjJbaV0gPSBpbnRlcnBvbGF0ZTIocmFuZ2U0W2ldLCByYW5nZTRbaSArIDFdKTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICB2YXIgaTIgPSBiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAxLCBqKSAtIDE7CiAgICByZXR1cm4gcjJbaTJdKGRbaTJdKHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBjb3B5KHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5yYW5nZShzb3VyY2UucmFuZ2UoKSkuaW50ZXJwb2xhdGUoc291cmNlLmludGVycG9sYXRlKCkpLmNsYW1wKHNvdXJjZS5jbGFtcCgpKS51bmtub3duKHNvdXJjZS51bmtub3duKCkpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybWVyKCkgewogIHZhciBkb21haW4gPSB1bml0LCByYW5nZTQgPSB1bml0LCBpbnRlcnBvbGF0ZTIgPSB2YWx1ZV9kZWZhdWx0LCB0cmFuc2Zvcm0sIHVudHJhbnNmb3JtLCB1bmtub3duLCBjbGFtcCA9IGlkZW50aXR5LCBwaWVjZXdpc2UyLCBvdXRwdXQsIGlucHV0OwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGgpOwogICAgaWYgKGNsYW1wICE9PSBpZGVudGl0eSkgY2xhbXAgPSBjbGFtcGVyKGRvbWFpblswXSwgZG9tYWluW24gLSAxXSk7CiAgICBwaWVjZXdpc2UyID0gbiA+IDIgPyBwb2x5bWFwIDogYmltYXA7CiAgICBvdXRwdXQgPSBpbnB1dCA9IG51bGw7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogKG91dHB1dCB8fCAob3V0cHV0ID0gcGllY2V3aXNlMihkb21haW4ubWFwKHRyYW5zZm9ybSksIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSkpKHRyYW5zZm9ybShjbGFtcCh4MikpKTsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBjbGFtcCh1bnRyYW5zZm9ybSgoaW5wdXQgfHwgKGlucHV0ID0gcGllY2V3aXNlMihyYW5nZTQsIGRvbWFpbi5tYXAodHJhbnNmb3JtKSwgbnVtYmVyX2RlZmF1bHQpKSkoeTIpKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8sIG51bWJlcjIpLCByZXNjYWxlKCkpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gcmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgaW50ZXJwb2xhdGUyID0gcm91bmRfZGVmYXVsdCwgcmVzY2FsZSgpOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9IF8gPyB0cnVlIDogaWRlbnRpdHksIHJlc2NhbGUoKSkgOiBjbGFtcCAhPT0gaWRlbnRpdHk7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRlMiA9IF8sIHJlc2NhbGUoKSkgOiBpbnRlcnBvbGF0ZTI7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCwgdSkgewogICAgdHJhbnNmb3JtID0gdCwgdW50cmFuc2Zvcm0gPSB1OwogICAgcmV0dXJuIHJlc2NhbGUoKTsKICB9Owp9CmZ1bmN0aW9uIGNvbnRpbnVvdXMoKSB7CiAgcmV0dXJuIHRyYW5zZm9ybWVyKCkoaWRlbnRpdHksIGlkZW50aXR5KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0RGVjaW1hbC5qcwpmdW5jdGlvbiBmb3JtYXREZWNpbWFsX2RlZmF1bHQoeDIpIHsKICByZXR1cm4gTWF0aC5hYnMoeDIgPSBNYXRoLnJvdW5kKHgyKSkgPj0gMWUyMSA/IHgyLnRvTG9jYWxlU3RyaW5nKCJlbiIpLnJlcGxhY2UoLywvZywgIiIpIDogeDIudG9TdHJpbmcoMTApOwp9CmZ1bmN0aW9uIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCkgewogIGlmICgoaSA9ICh4MiA9IHAgPyB4Mi50b0V4cG9uZW50aWFsKHAgLSAxKSA6IHgyLnRvRXhwb25lbnRpYWwoKSkuaW5kZXhPZigiZSIpKSA8IDApIHJldHVybiBudWxsOwogIHZhciBpLCBjb2VmZmljaWVudCA9IHgyLnNsaWNlKDAsIGkpOwogIHJldHVybiBbCiAgICBjb2VmZmljaWVudC5sZW5ndGggPiAxID8gY29lZmZpY2llbnRbMF0gKyBjb2VmZmljaWVudC5zbGljZSgyKSA6IGNvZWZmaWNpZW50LAogICAgK3gyLnNsaWNlKGkgKyAxKQogIF07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2V4cG9uZW50LmpzCmZ1bmN0aW9uIGV4cG9uZW50X2RlZmF1bHQoeDIpIHsKICByZXR1cm4geDIgPSBmb3JtYXREZWNpbWFsUGFydHMoTWF0aC5hYnMoeDIpKSwgeDIgPyB4MlsxXSA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0R3JvdXAuanMKZnVuY3Rpb24gZm9ybWF0R3JvdXBfZGVmYXVsdChncm91cGluZywgdGhvdXNhbmRzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCB3aWR0aCkgewogICAgdmFyIGkgPSB2YWx1ZS5sZW5ndGgsIHQgPSBbXSwgaiA9IDAsIGcgPSBncm91cGluZ1swXSwgbGVuZ3RoID0gMDsKICAgIHdoaWxlIChpID4gMCAmJiBnID4gMCkgewogICAgICBpZiAobGVuZ3RoICsgZyArIDEgPiB3aWR0aCkgZyA9IE1hdGgubWF4KDEsIHdpZHRoIC0gbGVuZ3RoKTsKICAgICAgdC5wdXNoKHZhbHVlLnN1YnN0cmluZyhpIC09IGcsIGkgKyBnKSk7CiAgICAgIGlmICgobGVuZ3RoICs9IGcgKyAxKSA+IHdpZHRoKSBicmVhazsKICAgICAgZyA9IGdyb3VwaW5nW2ogPSAoaiArIDEpICUgZ3JvdXBpbmcubGVuZ3RoXTsKICAgIH0KICAgIHJldHVybiB0LnJldmVyc2UoKS5qb2luKHRob3VzYW5kcyk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0TnVtZXJhbHMuanMKZnVuY3Rpb24gZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChudW1lcmFscykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1swLTldL2csIGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIG51bWVyYWxzWytpXTsKICAgIH0pOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFNwZWNpZmllci5qcwp2YXIgcmUgPSAvXig/OiguKT8oWzw+PV5dKSk/KFsrXC0oIF0pPyhbJCNdKT8oMCk/KFxkKyk/KCwpPyhcLlxkKyk/KH4pPyhbYS16JV0pPyQvaTsKZnVuY3Rpb24gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIGlmICghKG1hdGNoID0gcmUuZXhlYyhzcGVjaWZpZXIpKSkgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIGZvcm1hdDogIiArIHNwZWNpZmllcik7CiAgdmFyIG1hdGNoOwogIHJldHVybiBuZXcgRm9ybWF0U3BlY2lmaWVyKHsKICAgIGZpbGw6IG1hdGNoWzFdLAogICAgYWxpZ246IG1hdGNoWzJdLAogICAgc2lnbjogbWF0Y2hbM10sCiAgICBzeW1ib2w6IG1hdGNoWzRdLAogICAgemVybzogbWF0Y2hbNV0sCiAgICB3aWR0aDogbWF0Y2hbNl0sCiAgICBjb21tYTogbWF0Y2hbN10sCiAgICBwcmVjaXNpb246IG1hdGNoWzhdICYmIG1hdGNoWzhdLnNsaWNlKDEpLAogICAgdHJpbTogbWF0Y2hbOV0sCiAgICB0eXBlOiBtYXRjaFsxMF0KICB9KTsKfQpmb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlID0gRm9ybWF0U3BlY2lmaWVyLnByb3RvdHlwZTsKZnVuY3Rpb24gRm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIHRoaXMuZmlsbCA9IHNwZWNpZmllci5maWxsID09PSB2b2lkIDAgPyAiICIgOiBzcGVjaWZpZXIuZmlsbCArICIiOwogIHRoaXMuYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24gPT09IHZvaWQgMCA/ICI+IiA6IHNwZWNpZmllci5hbGlnbiArICIiOwogIHRoaXMuc2lnbiA9IHNwZWNpZmllci5zaWduID09PSB2b2lkIDAgPyAiLSIgOiBzcGVjaWZpZXIuc2lnbiArICIiOwogIHRoaXMuc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIuc3ltYm9sICsgIiI7CiAgdGhpcy56ZXJvID0gISFzcGVjaWZpZXIuemVybzsKICB0aGlzLndpZHRoID0gc3BlY2lmaWVyLndpZHRoID09PSB2b2lkIDAgPyB2b2lkIDAgOiArc3BlY2lmaWVyLndpZHRoOwogIHRoaXMuY29tbWEgPSAhIXNwZWNpZmllci5jb21tYTsKICB0aGlzLnByZWNpc2lvbiA9IHNwZWNpZmllci5wcmVjaXNpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIucHJlY2lzaW9uOwogIHRoaXMudHJpbSA9ICEhc3BlY2lmaWVyLnRyaW07CiAgdGhpcy50eXBlID0gc3BlY2lmaWVyLnR5cGUgPT09IHZvaWQgMCA/ICIiIDogc3BlY2lmaWVyLnR5cGUgKyAiIjsKfQpGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuZmlsbCArIHRoaXMuYWxpZ24gKyB0aGlzLnNpZ24gKyB0aGlzLnN5bWJvbCArICh0aGlzLnplcm8gPyAiMCIgOiAiIikgKyAodGhpcy53aWR0aCA9PT0gdm9pZCAwID8gIiIgOiBNYXRoLm1heCgxLCB0aGlzLndpZHRoIHwgMCkpICsgKHRoaXMuY29tbWEgPyAiLCIgOiAiIikgKyAodGhpcy5wcmVjaXNpb24gPT09IHZvaWQgMCA/ICIiIDogIi4iICsgTWF0aC5tYXgoMCwgdGhpcy5wcmVjaXNpb24gfCAwKSkgKyAodGhpcy50cmltID8gIn4iIDogIiIpICsgdGhpcy50eXBlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHJpbS5qcwpmdW5jdGlvbiBmb3JtYXRUcmltX2RlZmF1bHQocykgewogIG91dDogZm9yICh2YXIgbiA9IHMubGVuZ3RoLCBpID0gMSwgaTAgPSAtMSwgaTE7IGkgPCBuOyArK2kpIHsKICAgIHN3aXRjaCAoc1tpXSkgewogICAgICBjYXNlICIuIjoKICAgICAgICBpMCA9IGkxID0gaTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiMCI6CiAgICAgICAgaWYgKGkwID09PSAwKSBpMCA9IGk7CiAgICAgICAgaTEgPSBpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmICghK3NbaV0pIGJyZWFrIG91dDsKICAgICAgICBpZiAoaTAgPiAwKSBpMCA9IDA7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiBpMCA+IDAgPyBzLnNsaWNlKDAsIGkwKSArIHMuc2xpY2UoaTEgKyAxKSA6IHM7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFByZWZpeEF1dG8uanMKdmFyIHByZWZpeEV4cG9uZW50OwpmdW5jdGlvbiBmb3JtYXRQcmVmaXhBdXRvX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV0sIGkgPSBleHBvbmVudCAtIChwcmVmaXhFeHBvbmVudCA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50IC8gMykpKSAqIDMpICsgMSwgbiA9IGNvZWZmaWNpZW50Lmxlbmd0aDsKICByZXR1cm4gaSA9PT0gbiA/IGNvZWZmaWNpZW50IDogaSA+IG4gPyBjb2VmZmljaWVudCArIG5ldyBBcnJheShpIC0gbiArIDEpLmpvaW4oIjAiKSA6IGkgPiAwID8gY29lZmZpY2llbnQuc2xpY2UoMCwgaSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShpKSA6ICIwLiIgKyBuZXcgQXJyYXkoMSAtIGkpLmpvaW4oIjAiKSArIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgTWF0aC5tYXgoMCwgcCArIGkgLSAxKSlbMF07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFJvdW5kZWQuanMKZnVuY3Rpb24gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyLCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApOwogIGlmICghZCkgcmV0dXJuIHgyICsgIiI7CiAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwgZXhwb25lbnQgPSBkWzFdOwogIHJldHVybiBleHBvbmVudCA8IDAgPyAiMC4iICsgbmV3IEFycmF5KC1leHBvbmVudCkuam9pbigiMCIpICsgY29lZmZpY2llbnQgOiBjb2VmZmljaWVudC5sZW5ndGggPiBleHBvbmVudCArIDEgPyBjb2VmZmljaWVudC5zbGljZSgwLCBleHBvbmVudCArIDEpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoZXhwb25lbnQgKyAxKSA6IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGV4cG9uZW50IC0gY29lZmZpY2llbnQubGVuZ3RoICsgMikuam9pbigiMCIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRUeXBlcy5qcwp2YXIgZm9ybWF0VHlwZXNfZGVmYXVsdCA9IHsKICAiJSI6ICh4MiwgcCkgPT4gKHgyICogMTAwKS50b0ZpeGVkKHApLAogICJiIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZygyKSwKICAiYyI6ICh4MikgPT4geDIgKyAiIiwKICAiZCI6IGZvcm1hdERlY2ltYWxfZGVmYXVsdCwKICAiZSI6ICh4MiwgcCkgPT4geDIudG9FeHBvbmVudGlhbChwKSwKICAiZiI6ICh4MiwgcCkgPT4geDIudG9GaXhlZChwKSwKICAiZyI6ICh4MiwgcCkgPT4geDIudG9QcmVjaXNpb24ocCksCiAgIm8iOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDgpLAogICJwIjogKHgyLCBwKSA9PiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQoeDIgKiAxMDAsIHApLAogICJyIjogZm9ybWF0Um91bmRlZF9kZWZhdWx0LAogICJzIjogZm9ybWF0UHJlZml4QXV0b19kZWZhdWx0LAogICJYIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKSwKICAieCI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMTYpCn07CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9pZGVudGl0eS5qcwpmdW5jdGlvbiBpZGVudGl0eV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHgyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9sb2NhbGUuanMKdmFyIG1hcCA9IEFycmF5LnByb3RvdHlwZS5tYXA7CnZhciBwcmVmaXhlcyA9IFsieSIsICJ6IiwgImEiLCAiZiIsICJwIiwgIm4iLCAiXHhCNSIsICJtIiwgIiIsICJrIiwgIk0iLCAiRyIsICJUIiwgIlAiLCAiRSIsICJaIiwgIlkiXTsKZnVuY3Rpb24gbG9jYWxlX2RlZmF1bHQobG9jYWxlMykgewogIHZhciBncm91cCA9IGxvY2FsZTMuZ3JvdXBpbmcgPT09IHZvaWQgMCB8fCBsb2NhbGUzLnRob3VzYW5kcyA9PT0gdm9pZCAwID8gaWRlbnRpdHlfZGVmYXVsdCA6IGZvcm1hdEdyb3VwX2RlZmF1bHQobWFwLmNhbGwobG9jYWxlMy5ncm91cGluZywgTnVtYmVyKSwgbG9jYWxlMy50aG91c2FuZHMgKyAiIiksIGN1cnJlbmN5UHJlZml4ID0gbG9jYWxlMy5jdXJyZW5jeSA9PT0gdm9pZCAwID8gIiIgOiBsb2NhbGUzLmN1cnJlbmN5WzBdICsgIiIsIGN1cnJlbmN5U3VmZml4ID0gbG9jYWxlMy5jdXJyZW5jeSA9PT0gdm9pZCAwID8gIiIgOiBsb2NhbGUzLmN1cnJlbmN5WzFdICsgIiIsIGRlY2ltYWwgPSBsb2NhbGUzLmRlY2ltYWwgPT09IHZvaWQgMCA/ICIuIiA6IGxvY2FsZTMuZGVjaW1hbCArICIiLCBudW1lcmFscyA9IGxvY2FsZTMubnVtZXJhbHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQgOiBmb3JtYXROdW1lcmFsc19kZWZhdWx0KG1hcC5jYWxsKGxvY2FsZTMubnVtZXJhbHMsIFN0cmluZykpLCBwZXJjZW50ID0gbG9jYWxlMy5wZXJjZW50ID09PSB2b2lkIDAgPyAiJSIgOiBsb2NhbGUzLnBlcmNlbnQgKyAiIiwgbWludXMgPSBsb2NhbGUzLm1pbnVzID09PSB2b2lkIDAgPyAiXHUyMjEyIiA6IGxvY2FsZTMubWludXMgKyAiIiwgbmFuID0gbG9jYWxlMy5uYW4gPT09IHZvaWQgMCA/ICJOYU4iIDogbG9jYWxlMy5uYW4gKyAiIjsKICBmdW5jdGlvbiBuZXdGb3JtYXQoc3BlY2lmaWVyKSB7CiAgICBzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKTsKICAgIHZhciBmaWxsID0gc3BlY2lmaWVyLmZpbGwsIGFsaWduID0gc3BlY2lmaWVyLmFsaWduLCBzaWduMiA9IHNwZWNpZmllci5zaWduLCBzeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sLCB6ZXJvMyA9IHNwZWNpZmllci56ZXJvLCB3aWR0aCA9IHNwZWNpZmllci53aWR0aCwgY29tbWEgPSBzcGVjaWZpZXIuY29tbWEsIHByZWNpc2lvbiA9IHNwZWNpZmllci5wcmVjaXNpb24sIHRyaW0gPSBzcGVjaWZpZXIudHJpbSwgdHlwZSA9IHNwZWNpZmllci50eXBlOwogICAgaWYgKHR5cGUgPT09ICJuIikgY29tbWEgPSB0cnVlLCB0eXBlID0gImciOwogICAgZWxzZSBpZiAoIWZvcm1hdFR5cGVzX2RlZmF1bHRbdHlwZV0pIHByZWNpc2lvbiA9PT0gdm9pZCAwICYmIChwcmVjaXNpb24gPSAxMiksIHRyaW0gPSB0cnVlLCB0eXBlID0gImciOwogICAgaWYgKHplcm8zIHx8IGZpbGwgPT09ICIwIiAmJiBhbGlnbiA9PT0gIj0iKSB6ZXJvMyA9IHRydWUsIGZpbGwgPSAiMCIsIGFsaWduID0gIj0iOwogICAgdmFyIHByZWZpeCA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lQcmVmaXggOiBzeW1ib2wgPT09ICIjIiAmJiAvW2JveFhdLy50ZXN0KHR5cGUpID8gIjAiICsgdHlwZS50b0xvd2VyQ2FzZSgpIDogIiIsIHN1ZmZpeDIgPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5U3VmZml4IDogL1slcF0vLnRlc3QodHlwZSkgPyBwZXJjZW50IDogIiI7CiAgICB2YXIgZm9ybWF0VHlwZSA9IGZvcm1hdFR5cGVzX2RlZmF1bHRbdHlwZV0sIG1heWJlU3VmZml4ID0gL1tkZWZncHJzJV0vLnRlc3QodHlwZSk7CiAgICBwcmVjaXNpb24gPSBwcmVjaXNpb24gPT09IHZvaWQgMCA/IDYgOiAvW2dwcnNdLy50ZXN0KHR5cGUpID8gTWF0aC5tYXgoMSwgTWF0aC5taW4oMjEsIHByZWNpc2lvbikpIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMjAsIHByZWNpc2lvbikpOwogICAgZnVuY3Rpb24gZm9ybWF0Mih2YWx1ZSkgewogICAgICB2YXIgdmFsdWVQcmVmaXggPSBwcmVmaXgsIHZhbHVlU3VmZml4ID0gc3VmZml4MiwgaSwgbiwgYzsKICAgICAgaWYgKHR5cGUgPT09ICJjIikgewogICAgICAgIHZhbHVlU3VmZml4ID0gZm9ybWF0VHlwZSh2YWx1ZSkgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICB2YWx1ZSA9ICIiOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIHZhciB2YWx1ZU5lZ2F0aXZlID0gdmFsdWUgPCAwIHx8IDEgLyB2YWx1ZSA8IDA7CiAgICAgICAgdmFsdWUgPSBpc05hTih2YWx1ZSkgPyBuYW4gOiBmb3JtYXRUeXBlKE1hdGguYWJzKHZhbHVlKSwgcHJlY2lzaW9uKTsKICAgICAgICBpZiAodHJpbSkgdmFsdWUgPSBmb3JtYXRUcmltX2RlZmF1bHQodmFsdWUpOwogICAgICAgIGlmICh2YWx1ZU5lZ2F0aXZlICYmICt2YWx1ZSA9PT0gMCAmJiBzaWduMiAhPT0gIisiKSB2YWx1ZU5lZ2F0aXZlID0gZmFsc2U7CiAgICAgICAgdmFsdWVQcmVmaXggPSAodmFsdWVOZWdhdGl2ZSA/IHNpZ24yID09PSAiKCIgPyBzaWduMiA6IG1pbnVzIDogc2lnbjIgPT09ICItIiB8fCBzaWduMiA9PT0gIigiID8gIiIgOiBzaWduMikgKyB2YWx1ZVByZWZpeDsKICAgICAgICB2YWx1ZVN1ZmZpeCA9ICh0eXBlID09PSAicyIgPyBwcmVmaXhlc1s4ICsgcHJlZml4RXhwb25lbnQgLyAzXSA6ICIiKSArIHZhbHVlU3VmZml4ICsgKHZhbHVlTmVnYXRpdmUgJiYgc2lnbjIgPT09ICIoIiA/ICIpIiA6ICIiKTsKICAgICAgICBpZiAobWF5YmVTdWZmaXgpIHsKICAgICAgICAgIGkgPSAtMSwgbiA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgICAgIGlmIChjID0gdmFsdWUuY2hhckNvZGVBdChpKSwgNDggPiBjIHx8IGMgPiA1NykgewogICAgICAgICAgICAgIHZhbHVlU3VmZml4ID0gKGMgPT09IDQ2ID8gZGVjaW1hbCArIHZhbHVlLnNsaWNlKGkgKyAxKSA6IHZhbHVlLnNsaWNlKGkpKSArIHZhbHVlU3VmZml4OwogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbW1hICYmICF6ZXJvMykgdmFsdWUgPSBncm91cCh2YWx1ZSwgSW5maW5pdHkpOwogICAgICB2YXIgbGVuZ3RoID0gdmFsdWVQcmVmaXgubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgdmFsdWVTdWZmaXgubGVuZ3RoLCBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogIiI7CiAgICAgIGlmIChjb21tYSAmJiB6ZXJvMykgdmFsdWUgPSBncm91cChwYWRkaW5nICsgdmFsdWUsIHBhZGRpbmcubGVuZ3RoID8gd2lkdGggLSB2YWx1ZVN1ZmZpeC5sZW5ndGggOiBJbmZpbml0eSksIHBhZGRpbmcgPSAiIjsKICAgICAgc3dpdGNoIChhbGlnbikgewogICAgICAgIGNhc2UgIjwiOgogICAgICAgICAgdmFsdWUgPSB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiPSI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgcGFkZGluZyArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJeIjoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZy5zbGljZSgwLCBsZW5ndGggPSBwYWRkaW5nLmxlbmd0aCA+PiAxKSArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmcuc2xpY2UobGVuZ3RoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB2YWx1ZSA9IHBhZGRpbmcgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gbnVtZXJhbHModmFsdWUpOwogICAgfQogICAgZm9ybWF0Mi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3BlY2lmaWVyICsgIiI7CiAgICB9OwogICAgcmV0dXJuIGZvcm1hdDI7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFByZWZpeDIoc3BlY2lmaWVyLCB2YWx1ZSkgewogICAgdmFyIGYgPSBuZXdGb3JtYXQoKHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpLCBzcGVjaWZpZXIudHlwZSA9ICJmIiwgc3BlY2lmaWVyKSksIGUgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzLCBrID0gTWF0aC5wb3coMTAsIC1lKSwgcHJlZml4ID0gcHJlZml4ZXNbOCArIGUgLyAzXTsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZTIpIHsKICAgICAgcmV0dXJuIGYoayAqIHZhbHVlMikgKyBwcmVmaXg7CiAgICB9OwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBuZXdGb3JtYXQsCiAgICBmb3JtYXRQcmVmaXg6IGZvcm1hdFByZWZpeDIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9kZWZhdWx0TG9jYWxlLmpzCnZhciBsb2NhbGU7CnZhciBmb3JtYXQ7CnZhciBmb3JtYXRQcmVmaXg7CmRlZmF1bHRMb2NhbGUoewogIHRob3VzYW5kczogIiwiLAogIGdyb3VwaW5nOiBbM10sCiAgY3VycmVuY3k6IFsiJCIsICIiXQp9KTsKZnVuY3Rpb24gZGVmYXVsdExvY2FsZShkZWZpbml0aW9uKSB7CiAgbG9jYWxlID0gbG9jYWxlX2RlZmF1bHQoZGVmaW5pdGlvbik7CiAgZm9ybWF0ID0gbG9jYWxlLmZvcm1hdDsKICBmb3JtYXRQcmVmaXggPSBsb2NhbGUuZm9ybWF0UHJlZml4OwogIHJldHVybiBsb2NhbGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvbkZpeGVkLmpzCmZ1bmN0aW9uIHByZWNpc2lvbkZpeGVkX2RlZmF1bHQoc3RlcCkgewogIHJldHVybiBNYXRoLm1heCgwLCAtZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25QcmVmaXguanMKZnVuY3Rpb24gcHJlY2lzaW9uUHJlZml4X2RlZmF1bHQoc3RlcCwgdmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnRfZGVmYXVsdCh2YWx1ZSkgLyAzKSkpICogMyAtIGV4cG9uZW50X2RlZmF1bHQoTWF0aC5hYnMoc3RlcCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvcHJlY2lzaW9uUm91bmQuanMKZnVuY3Rpb24gcHJlY2lzaW9uUm91bmRfZGVmYXVsdChzdGVwLCBtYXgyKSB7CiAgc3RlcCA9IE1hdGguYWJzKHN0ZXApLCBtYXgyID0gTWF0aC5hYnMobWF4MikgLSBzdGVwOwogIHJldHVybiBNYXRoLm1heCgwLCBleHBvbmVudF9kZWZhdWx0KG1heDIpIC0gZXhwb25lbnRfZGVmYXVsdChzdGVwKSkgKyAxOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RpY2tGb3JtYXQuanMKZnVuY3Rpb24gdGlja0Zvcm1hdChzdGFydCwgc3RvcCwgY291bnQsIHNwZWNpZmllcikgewogIHZhciBzdGVwID0gdGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50KSwgcHJlY2lzaW9uOwogIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIgPT0gbnVsbCA/ICIsZiIgOiBzcGVjaWZpZXIpOwogIHN3aXRjaCAoc3BlY2lmaWVyLnR5cGUpIHsKICAgIGNhc2UgInMiOiB7CiAgICAgIHZhciB2YWx1ZSA9IE1hdGgubWF4KE1hdGguYWJzKHN0YXJ0KSwgTWF0aC5hYnMoc3RvcCkpOwogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uOwogICAgICByZXR1cm4gZm9ybWF0UHJlZml4KHNwZWNpZmllciwgdmFsdWUpOwogICAgfQogICAgY2FzZSAiIjoKICAgIGNhc2UgImUiOgogICAgY2FzZSAiZyI6CiAgICBjYXNlICJwIjoKICAgIGNhc2UgInIiOiB7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSkpKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbiAtIChzcGVjaWZpZXIudHlwZSA9PT0gImUiKTsKICAgICAgYnJlYWs7CiAgICB9CiAgICBjYXNlICJmIjoKICAgIGNhc2UgIiUiOiB7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvbkZpeGVkX2RlZmF1bHQoc3RlcCkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiJSIpICogMjsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiBmb3JtYXQoc3BlY2lmaWVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9saW5lYXIuanMKZnVuY3Rpb24gbGluZWFyaXNoKHNjYWxlKSB7CiAgdmFyIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tzKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQgPT0gbnVsbCA/IDEwIDogY291bnQpOwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja0Zvcm1hdChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50LCBzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICBpZiAoY291bnQgPT0gbnVsbCkgY291bnQgPSAxMDsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICB2YXIgaTAgPSAwOwogICAgdmFyIGkxID0gZC5sZW5ndGggLSAxOwogICAgdmFyIHN0YXJ0ID0gZFtpMF07CiAgICB2YXIgc3RvcCA9IGRbaTFdOwogICAgdmFyIHByZXN0ZXA7CiAgICB2YXIgc3RlcDsKICAgIHZhciBtYXhJdGVyID0gMTA7CiAgICBpZiAoc3RvcCA8IHN0YXJ0KSB7CiAgICAgIHN0ZXAgPSBzdGFydCwgc3RhcnQgPSBzdG9wLCBzdG9wID0gc3RlcDsKICAgICAgc3RlcCA9IGkwLCBpMCA9IGkxLCBpMSA9IHN0ZXA7CiAgICB9CiAgICB3aGlsZSAobWF4SXRlci0tID4gMCkgewogICAgICBzdGVwID0gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpOwogICAgICBpZiAoc3RlcCA9PT0gcHJlc3RlcCkgewogICAgICAgIGRbaTBdID0gc3RhcnQ7CiAgICAgICAgZFtpMV0gPSBzdG9wOwogICAgICAgIHJldHVybiBkb21haW4oZCk7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA+IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguZmxvb3Ioc3RhcnQgLyBzdGVwKSAqIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguY2VpbChzdG9wIC8gc3RlcCkgKiBzdGVwOwogICAgICB9IGVsc2UgaWYgKHN0ZXAgPCAwKSB7CiAgICAgICAgc3RhcnQgPSBNYXRoLmNlaWwoc3RhcnQgKiBzdGVwKSAvIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguZmxvb3Ioc3RvcCAqIHN0ZXApIC8gc3RlcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBwcmVzdGVwID0gc3RlcDsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsaW5lYXIyKCkgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgbGluZWFyMigpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9pZGVudGl0eS5qcwpmdW5jdGlvbiBpZGVudGl0eTIoZG9tYWluKSB7CiAgdmFyIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiB4MjsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gc2NhbGU7CiAgc2NhbGUuZG9tYWluID0gc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8sIG51bWJlcjIpLCBzY2FsZSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpZGVudGl0eTIoZG9tYWluKS51bmtub3duKHVua25vd24pOwogIH07CiAgZG9tYWluID0gYXJndW1lbnRzLmxlbmd0aCA/IEFycmF5LmZyb20oZG9tYWluLCBudW1iZXIyKSA6IFswLCAxXTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9uaWNlLmpzCmZ1bmN0aW9uIG5pY2UoZG9tYWluLCBpbnRlcnZhbCkgewogIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpOwogIHZhciBpMCA9IDAsIGkxID0gZG9tYWluLmxlbmd0aCAtIDEsIHgwID0gZG9tYWluW2kwXSwgeDEgPSBkb21haW5baTFdLCB0OwogIGlmICh4MSA8IHgwKSB7CiAgICB0ID0gaTAsIGkwID0gaTEsIGkxID0gdDsKICAgIHQgPSB4MCwgeDAgPSB4MSwgeDEgPSB0OwogIH0KICBkb21haW5baTBdID0gaW50ZXJ2YWwuZmxvb3IoeDApOwogIGRvbWFpbltpMV0gPSBpbnRlcnZhbC5jZWlsKHgxKTsKICByZXR1cm4gZG9tYWluOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2xvZy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1Mb2coeDIpIHsKICByZXR1cm4gTWF0aC5sb2coeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cCh4MikgewogIHJldHVybiBNYXRoLmV4cCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtTG9nbih4MikgewogIHJldHVybiAtTWF0aC5sb2coLXgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1FeHBuKHgyKSB7CiAgcmV0dXJuIC1NYXRoLmV4cCgteDIpOwp9CmZ1bmN0aW9uIHBvdzEwKHgyKSB7CiAgcmV0dXJuIGlzRmluaXRlKHgyKSA/ICsoIjFlIiArIHgyKSA6IHgyIDwgMCA/IDAgOiB4MjsKfQpmdW5jdGlvbiBwb3dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gMTAgPyBwb3cxMCA6IGJhc2UgPT09IE1hdGguRSA/IE1hdGguZXhwIDogKHgyKSA9PiBNYXRoLnBvdyhiYXNlLCB4Mik7Cn0KZnVuY3Rpb24gbG9ncChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IE1hdGguRSA/IE1hdGgubG9nIDogYmFzZSA9PT0gMTAgJiYgTWF0aC5sb2cxMCB8fCBiYXNlID09PSAyICYmIE1hdGgubG9nMiB8fCAoYmFzZSA9IE1hdGgubG9nKGJhc2UpLCAoeDIpID0+IE1hdGgubG9nKHgyKSAvIGJhc2UpOwp9CmZ1bmN0aW9uIHJlZmxlY3QoZikgewogIHJldHVybiAoeDIsIGspID0+IC1mKC14Miwgayk7Cn0KZnVuY3Rpb24gbG9nZ2lzaCh0cmFuc2Zvcm0pIHsKICBjb25zdCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1Mb2csIHRyYW5zZm9ybUV4cCk7CiAgY29uc3QgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIGxldCBiYXNlID0gMTA7CiAgbGV0IGxvZ3M7CiAgbGV0IHBvd3M7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIGxvZ3MgPSBsb2dwKGJhc2UpLCBwb3dzID0gcG93cChiYXNlKTsKICAgIGlmIChkb21haW4oKVswXSA8IDApIHsKICAgICAgbG9ncyA9IHJlZmxlY3QobG9ncyksIHBvd3MgPSByZWZsZWN0KHBvd3MpOwogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nbiwgdHJhbnNmb3JtRXhwbik7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5iYXNlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYmFzZSA9ICtfLCByZXNjYWxlKCkpIDogYmFzZTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUudGlja3MgPSAoY291bnQpID0+IHsKICAgIGNvbnN0IGQgPSBkb21haW4oKTsKICAgIGxldCB1ID0gZFswXTsKICAgIGxldCB2ID0gZFtkLmxlbmd0aCAtIDFdOwogICAgY29uc3QgcjIgPSB2IDwgdTsKICAgIGlmIChyMikgW3UsIHZdID0gW3YsIHVdOwogICAgbGV0IGkgPSBsb2dzKHUpOwogICAgbGV0IGogPSBsb2dzKHYpOwogICAgbGV0IGs7CiAgICBsZXQgdDsKICAgIGNvbnN0IG4gPSBjb3VudCA9PSBudWxsID8gMTAgOiArY291bnQ7CiAgICBsZXQgeiA9IFtdOwogICAgaWYgKCEoYmFzZSAlIDEpICYmIGogLSBpIDwgbikgewogICAgICBpID0gTWF0aC5mbG9vcihpKSwgaiA9IE1hdGguY2VpbChqKTsKICAgICAgaWYgKHUgPiAwKSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsgPSAxOyBrIDwgYmFzZTsgKytrKSB7CiAgICAgICAgICB0ID0gaSA8IDAgPyBrIC8gcG93cygtaSkgOiBrICogcG93cyhpKTsKICAgICAgICAgIGlmICh0IDwgdSkgY29udGludWU7CiAgICAgICAgICBpZiAodCA+IHYpIGJyZWFrOwogICAgICAgICAgei5wdXNoKHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoayA9IGJhc2UgLSAxOyBrID49IDE7IC0taykgewogICAgICAgICAgdCA9IGkgPiAwID8gayAvIHBvd3MoLWkpIDogayAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHoubGVuZ3RoICogMiA8IG4pIHogPSB0aWNrcyh1LCB2LCBuKTsKICAgIH0gZWxzZSB7CiAgICAgIHogPSB0aWNrcyhpLCBqLCBNYXRoLm1pbihqIC0gaSwgbikpLm1hcChwb3dzKTsKICAgIH0KICAgIHJldHVybiByMiA/IHoucmV2ZXJzZSgpIDogejsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSAoY291bnQsIHNwZWNpZmllcikgPT4gewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICBpZiAoc3BlY2lmaWVyID09IG51bGwpIHNwZWNpZmllciA9IGJhc2UgPT09IDEwID8gInMiIDogIiwiOwogICAgaWYgKHR5cGVvZiBzcGVjaWZpZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCEoYmFzZSAlIDEpICYmIChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSkucHJlY2lzaW9uID09IG51bGwpIHNwZWNpZmllci50cmltID0gdHJ1ZTsKICAgICAgc3BlY2lmaWVyID0gZm9ybWF0KHNwZWNpZmllcik7CiAgICB9CiAgICBpZiAoY291bnQgPT09IEluZmluaXR5KSByZXR1cm4gc3BlY2lmaWVyOwogICAgY29uc3QgayA9IE1hdGgubWF4KDEsIGJhc2UgKiBjb3VudCAvIHNjYWxlLnRpY2tzKCkubGVuZ3RoKTsKICAgIHJldHVybiAoZCkgPT4gewogICAgICBsZXQgaSA9IGQgLyBwb3dzKE1hdGgucm91bmQobG9ncyhkKSkpOwogICAgICBpZiAoaSAqIGJhc2UgPCBiYXNlIC0gMC41KSBpICo9IGJhc2U7CiAgICAgIHJldHVybiBpIDw9IGsgPyBzcGVjaWZpZXIoZCkgOiAiIjsKICAgIH07CiAgfTsKICBzY2FsZS5uaWNlID0gKCkgPT4gewogICAgcmV0dXJuIGRvbWFpbihuaWNlKGRvbWFpbigpLCB7CiAgICAgIGZsb29yOiAoeDIpID0+IHBvd3MoTWF0aC5mbG9vcihsb2dzKHgyKSkpLAogICAgICBjZWlsOiAoeDIpID0+IHBvd3MoTWF0aC5jZWlsKGxvZ3MoeDIpKSkKICAgIH0pKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsb2coKSB7CiAgY29uc3Qgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyKCkpLmRvbWFpbihbMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gKCkgPT4gY29weShzY2FsZSwgbG9nKCkpLmJhc2Uoc2NhbGUuYmFzZSgpKTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3N5bWxvZy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1TeW1sb2coYykgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLmxvZzFwKE1hdGguYWJzKHgyIC8gYykpOwogIH07Cn0KZnVuY3Rpb24gdHJhbnNmb3JtU3ltZXhwKGMpIHsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5leHBtMShNYXRoLmFicyh4MikpICogYzsKICB9Owp9CmZ1bmN0aW9uIHN5bWxvZ2lzaCh0cmFuc2Zvcm0pIHsKICB2YXIgYyA9IDEsIHNjYWxlID0gdHJhbnNmb3JtKHRyYW5zZm9ybVN5bWxvZyhjKSwgdHJhbnNmb3JtU3ltZXhwKGMpKTsKICBzY2FsZS5jb25zdGFudCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gdHJhbnNmb3JtKHRyYW5zZm9ybVN5bWxvZyhjID0gK18pLCB0cmFuc2Zvcm1TeW1leHAoYykpIDogYzsKICB9OwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CmZ1bmN0aW9uIHN5bWxvZygpIHsKICB2YXIgc2NhbGUgPSBzeW1sb2dpc2godHJhbnNmb3JtZXIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIHN5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcG93LmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVBvdyhleHBvbmVudCkgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnBvdygteDIsIGV4cG9uZW50KSA6IE1hdGgucG93KHgyLCBleHBvbmVudCk7CiAgfTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXJ0KHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnNxcnQoLXgyKSA6IE1hdGguc3FydCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtU3F1YXJlKHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC14MiAqIHgyIDogeDIgKiB4MjsKfQpmdW5jdGlvbiBwb3dpc2godHJhbnNmb3JtKSB7CiAgdmFyIHNjYWxlID0gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSksIGV4cG9uZW50ID0gMTsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgcmV0dXJuIGV4cG9uZW50ID09PSAxID8gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSkgOiBleHBvbmVudCA9PT0gMC41ID8gdHJhbnNmb3JtKHRyYW5zZm9ybVNxcnQsIHRyYW5zZm9ybVNxdWFyZSkgOiB0cmFuc2Zvcm0odHJhbnNmb3JtUG93KGV4cG9uZW50KSwgdHJhbnNmb3JtUG93KDEgLyBleHBvbmVudCkpOwogIH0KICBzY2FsZS5leHBvbmVudCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGV4cG9uZW50ID0gK18sIHJlc2NhbGUoKSkgOiBleHBvbmVudDsKICB9OwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CmZ1bmN0aW9uIHBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIHBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gc3FydCgpIHsKICByZXR1cm4gcG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9yYWRpYWwuanMKZnVuY3Rpb24gc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHVuc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLnNxcnQoTWF0aC5hYnMoeDIpKTsKfQpmdW5jdGlvbiByYWRpYWwoKSB7CiAgdmFyIHNxdWFyZWQgPSBjb250aW51b3VzKCksIHJhbmdlNCA9IFswLCAxXSwgcm91bmQgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgdmFyIHkyID0gdW5zcXVhcmUoc3F1YXJlZCh4MikpOwogICAgcmV0dXJuIGlzTmFOKHkyKSA/IHVua25vd24gOiByb3VuZCA/IE1hdGgucm91bmQoeTIpIDogeTI7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gc3F1YXJlZC5pbnZlcnQoc3F1YXJlKHkyKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzcXVhcmVkLmRvbWFpbihfKSwgc2NhbGUpIDogc3F1YXJlZC5kb21haW4oKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5yYW5nZSgocmFuZ2U0ID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSkubWFwKHNxdWFyZSkpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gc2NhbGUucmFuZ2UoXykucm91bmQodHJ1ZSk7CiAgfTsKICBzY2FsZS5yb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJvdW5kID0gISFfLCBzY2FsZSkgOiByb3VuZDsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5jbGFtcChfKSwgc2NhbGUpIDogc3F1YXJlZC5jbGFtcCgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHJhZGlhbChzcXVhcmVkLmRvbWFpbigpLCByYW5nZTQpLnJvdW5kKHJvdW5kKS5jbGFtcChzcXVhcmVkLmNsYW1wKCkpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcXVhbnRpbGUuanMKZnVuY3Rpb24gcXVhbnRpbGUyKCkgewogIHZhciBkb21haW4gPSBbXSwgcmFuZ2U0ID0gW10sIHRocmVzaG9sZHMgPSBbXSwgdW5rbm93bjsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIGkgPSAwLCBuID0gTWF0aC5tYXgoMSwgcmFuZ2U0Lmxlbmd0aCk7CiAgICB0aHJlc2hvbGRzID0gbmV3IEFycmF5KG4gLSAxKTsKICAgIHdoaWxlICgrK2kgPCBuKSB0aHJlc2hvbGRzW2kgLSAxXSA9IHF1YW50aWxlU29ydGVkKGRvbWFpbiwgaSAvIG4pOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IHJhbmdlNFtiaXNlY3RfZGVmYXVsdCh0aHJlc2hvbGRzLCB4MildOwogIH0KICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gaSA8IDAgPyBbTmFOLCBOYU5dIDogWwogICAgICBpID4gMCA/IHRocmVzaG9sZHNbaSAtIDFdIDogZG9tYWluWzBdLAogICAgICBpIDwgdGhyZXNob2xkcy5sZW5ndGggPyB0aHJlc2hvbGRzW2ldIDogZG9tYWluW2RvbWFpbi5sZW5ndGggLSAxXQogICAgXTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogICAgZG9tYWluID0gW107CiAgICBmb3IgKGxldCBkIG9mIF8pIGlmIChkICE9IG51bGwgJiYgIWlzTmFOKGQgPSArZCkpIGRvbWFpbi5wdXNoKGQpOwogICAgZG9tYWluLnNvcnQoYXNjZW5kaW5nKTsKICAgIHJldHVybiByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLnF1YW50aWxlcyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRocmVzaG9sZHMuc2xpY2UoKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBxdWFudGlsZTIoKS5kb21haW4oZG9tYWluKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aXplLmpzCmZ1bmN0aW9uIHF1YW50aXplKCkgewogIHZhciB4MCA9IDAsIHgxID0gMSwgbiA9IDEsIGRvbWFpbiA9IFswLjVdLCByYW5nZTQgPSBbMCwgMV0sIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiAhPSBudWxsICYmIHgyIDw9IHgyID8gcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDAsIG4pXSA6IHVua25vd247CiAgfQogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgaSA9IC0xOwogICAgZG9tYWluID0gbmV3IEFycmF5KG4pOwogICAgd2hpbGUgKCsraSA8IG4pIGRvbWFpbltpXSA9ICgoaSArIDEpICogeDEgLSAoaSAtIG4pICogeDApIC8gKG4gKyAxKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MV0gPSBfLCB4MCA9ICt4MCwgeDEgPSAreDEsIHJlc2NhbGUoKSkgOiBbeDAsIHgxXTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAobiA9IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pKS5sZW5ndGggLSAxLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gaSA8IDAgPyBbTmFOLCBOYU5dIDogaSA8IDEgPyBbeDAsIGRvbWFpblswXV0gOiBpID49IG4gPyBbZG9tYWluW24gLSAxXSwgeDFdIDogW2RvbWFpbltpIC0gMV0sIGRvbWFpbltpXV07CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHNjYWxlOwogIH07CiAgc2NhbGUudGhyZXNob2xkcyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHF1YW50aXplKCkuZG9tYWluKFt4MCwgeDFdKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KGxpbmVhcmlzaChzY2FsZSksIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGhyZXNob2xkLmpzCmZ1bmN0aW9uIHRocmVzaG9sZCgpIHsKICB2YXIgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93biwgbiA9IDE7CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiAhPSBudWxsICYmIHgyIDw9IHgyID8gcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDAsIG4pXSA6IHVua25vd247CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXyksIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoIC0gMSksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGQoKS5kb21haW4oZG9tYWluKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaW50ZXJ2YWwuanMKdmFyIHQwID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CnZhciB0MSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwpmdW5jdGlvbiB0aW1lSW50ZXJ2YWwoZmxvb3JpLCBvZmZzZXRpLCBjb3VudCwgZmllbGQpIHsKICBmdW5jdGlvbiBpbnRlcnZhbChkYXRlMikgewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSA6IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfQogIGludGVydmFsLmZsb29yID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMikpLCBkYXRlMjsKICB9OwogIGludGVydmFsLmNlaWwgPSAoZGF0ZTIpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBuZXcgRGF0ZShkYXRlMiAtIDEpKSwgb2Zmc2V0aShkYXRlMiwgMSksIGZsb29yaShkYXRlMiksIGRhdGUyOwogIH07CiAgaW50ZXJ2YWwucm91bmQgPSAoZGF0ZTIpID0+IHsKICAgIGNvbnN0IGQwID0gaW50ZXJ2YWwoZGF0ZTIpLCBkMSA9IGludGVydmFsLmNlaWwoZGF0ZTIpOwogICAgcmV0dXJuIGRhdGUyIC0gZDAgPCBkMSAtIGRhdGUyID8gZDAgOiBkMTsKICB9OwogIGludGVydmFsLm9mZnNldCA9IChkYXRlMiwgc3RlcCkgPT4gewogICAgcmV0dXJuIG9mZnNldGkoZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSwgc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCkpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJhbmdlID0gKHN0YXJ0LCBzdG9wLCBzdGVwKSA9PiB7CiAgICBjb25zdCByYW5nZTQgPSBbXTsKICAgIHN0YXJ0ID0gaW50ZXJ2YWwuY2VpbChzdGFydCk7CiAgICBzdGVwID0gc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCk7CiAgICBpZiAoIShzdGFydCA8IHN0b3ApIHx8ICEoc3RlcCA+IDApKSByZXR1cm4gcmFuZ2U0OwogICAgbGV0IHByZXZpb3VzOwogICAgZG8KICAgICAgcmFuZ2U0LnB1c2gocHJldmlvdXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3N0YXJ0KSksIG9mZnNldGkoc3RhcnQsIHN0ZXApLCBmbG9vcmkoc3RhcnQpOwogICAgd2hpbGUgKHByZXZpb3VzIDwgc3RhcnQgJiYgc3RhcnQgPCBzdG9wKTsKICAgIHJldHVybiByYW5nZTQ7CiAgfTsKICBpbnRlcnZhbC5maWx0ZXIgPSAodGVzdCkgPT4gewogICAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB3aGlsZSAoZmxvb3JpKGRhdGUyKSwgIXRlc3QoZGF0ZTIpKSBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gMSk7CiAgICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB7CiAgICAgICAgaWYgKHN0ZXAgPCAwKSB3aGlsZSAoKytzdGVwIDw9IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAtMSksICF0ZXN0KGRhdGUyKSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHdoaWxlICgtLXN0ZXAgPj0gMCkgewogICAgICAgICAgd2hpbGUgKG9mZnNldGkoZGF0ZTIsIDEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CiAgaWYgKGNvdW50KSB7CiAgICBpbnRlcnZhbC5jb3VudCA9IChzdGFydCwgZW5kKSA9PiB7CiAgICAgIHQwLnNldFRpbWUoK3N0YXJ0KSwgdDEuc2V0VGltZSgrZW5kKTsKICAgICAgZmxvb3JpKHQwKSwgZmxvb3JpKHQxKTsKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoY291bnQodDAsIHQxKSk7CiAgICB9OwogICAgaW50ZXJ2YWwuZXZlcnkgPSAoc3RlcCkgPT4gewogICAgICBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgICAgcmV0dXJuICFpc0Zpbml0ZShzdGVwKSB8fCAhKHN0ZXAgPiAwKSA/IG51bGwgOiAhKHN0ZXAgPiAxKSA/IGludGVydmFsIDogaW50ZXJ2YWwuZmlsdGVyKGZpZWxkID8gKGQpID0+IGZpZWxkKGQpICUgc3RlcCA9PT0gMCA6IChkKSA9PiBpbnRlcnZhbC5jb3VudCgwLCBkKSAlIHN0ZXAgPT09IDApOwogICAgfTsKICB9CiAgcmV0dXJuIGludGVydmFsOwp9CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWlsbGlzZWNvbmQuanMKdmFyIG1pbGxpc2Vjb25kID0gdGltZUludGVydmFsKCgpID0+IHsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kIC0gc3RhcnQ7Cn0pOwptaWxsaXNlY29uZC5ldmVyeSA9IChrKSA9PiB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgaWYgKCFpc0Zpbml0ZShrKSB8fCAhKGsgPiAwKSkgcmV0dXJuIG51bGw7CiAgaWYgKCEoayA+IDEpKSByZXR1cm4gbWlsbGlzZWNvbmQ7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFRpbWUoTWF0aC5mbG9vcihkYXRlMiAvIGspICogayk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBrKTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBrOwogIH0pOwp9Owp2YXIgbWlsbGlzZWNvbmRzID0gbWlsbGlzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZHVyYXRpb24uanMKdmFyIGR1cmF0aW9uU2Vjb25kID0gMWUzOwp2YXIgZHVyYXRpb25NaW51dGUgPSBkdXJhdGlvblNlY29uZCAqIDYwOwp2YXIgZHVyYXRpb25Ib3VyID0gZHVyYXRpb25NaW51dGUgKiA2MDsKdmFyIGR1cmF0aW9uRGF5ID0gZHVyYXRpb25Ib3VyICogMjQ7CnZhciBkdXJhdGlvbldlZWsgPSBkdXJhdGlvbkRheSAqIDc7CnZhciBkdXJhdGlvbk1vbnRoID0gZHVyYXRpb25EYXkgKiAzMDsKdmFyIGR1cmF0aW9uWWVhciA9IGR1cmF0aW9uRGF5ICogMzY1OwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3NlY29uZC5qcwp2YXIgc2Vjb25kID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uU2Vjb25kOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDU2Vjb25kcygpOwp9KTsKdmFyIHNlY29uZHMgPSBzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWludXRlLmpzCnZhciB0aW1lTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUyLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25NaW51dGUpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25NaW51dGU7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRNaW51dGVzKCk7Cn0pOwp2YXIgdGltZU1pbnV0ZXMgPSB0aW1lTWludXRlLnJhbmdlOwp2YXIgdXRjTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ1NlY29uZHMoMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDTWludXRlcygpOwp9KTsKdmFyIHV0Y01pbnV0ZXMgPSB1dGNNaW51dGUucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaG91ci5qcwp2YXIgdGltZUhvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpIC0gZGF0ZTIuZ2V0U2Vjb25kcygpICogZHVyYXRpb25TZWNvbmQgLSBkYXRlMi5nZXRNaW51dGVzKCkgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uSG91cik7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkhvdXI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRIb3VycygpOwp9KTsKdmFyIHRpbWVIb3VycyA9IHRpbWVIb3VyLnJhbmdlOwp2YXIgdXRjSG91ciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENNaW51dGVzKDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDSG91cnMoKTsKfSk7CnZhciB1dGNIb3VycyA9IHV0Y0hvdXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZGF5LmpzCnZhciB0aW1lRGF5ID0gdGltZUludGVydmFsKAogIChkYXRlMikgPT4gZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCksCiAgKGRhdGUyLCBzdGVwKSA9PiBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSArIHN0ZXApLAogIChzdGFydCwgZW5kKSA9PiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uRGF5LAogIChkYXRlMikgPT4gZGF0ZTIuZ2V0RGF0ZSgpIC0gMQopOwp2YXIgdGltZURheXMgPSB0aW1lRGF5LnJhbmdlOwp2YXIgdXRjRGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENEYXRlKCkgLSAxOwp9KTsKdmFyIHV0Y0RheXMgPSB1dGNEYXkucmFuZ2U7CnZhciB1bml4RGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBNYXRoLmZsb29yKGRhdGUyIC8gZHVyYXRpb25EYXkpOwp9KTsKdmFyIHVuaXhEYXlzID0gdW5peERheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy93ZWVrLmpzCmZ1bmN0aW9uIHRpbWVXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgLSAoZGF0ZTIuZ2V0RGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdGltZVN1bmRheSA9IHRpbWVXZWVrZGF5KDApOwp2YXIgdGltZU1vbmRheSA9IHRpbWVXZWVrZGF5KDEpOwp2YXIgdGltZVR1ZXNkYXkgPSB0aW1lV2Vla2RheSgyKTsKdmFyIHRpbWVXZWRuZXNkYXkgPSB0aW1lV2Vla2RheSgzKTsKdmFyIHRpbWVUaHVyc2RheSA9IHRpbWVXZWVrZGF5KDQpOwp2YXIgdGltZUZyaWRheSA9IHRpbWVXZWVrZGF5KDUpOwp2YXIgdGltZVNhdHVyZGF5ID0gdGltZVdlZWtkYXkoNik7CnZhciB0aW1lU3VuZGF5cyA9IHRpbWVTdW5kYXkucmFuZ2U7CnZhciB0aW1lTW9uZGF5cyA9IHRpbWVNb25kYXkucmFuZ2U7CnZhciB0aW1lVHVlc2RheXMgPSB0aW1lVHVlc2RheS5yYW5nZTsKdmFyIHRpbWVXZWRuZXNkYXlzID0gdGltZVdlZG5lc2RheS5yYW5nZTsKdmFyIHRpbWVUaHVyc2RheXMgPSB0aW1lVGh1cnNkYXkucmFuZ2U7CnZhciB0aW1lRnJpZGF5cyA9IHRpbWVGcmlkYXkucmFuZ2U7CnZhciB0aW1lU2F0dXJkYXlzID0gdGltZVNhdHVyZGF5LnJhbmdlOwpmdW5jdGlvbiB1dGNXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgLSAoZGF0ZTIuZ2V0VVRDRGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25XZWVrOwogIH0pOwp9CnZhciB1dGNTdW5kYXkgPSB1dGNXZWVrZGF5KDApOwp2YXIgdXRjTW9uZGF5ID0gdXRjV2Vla2RheSgxKTsKdmFyIHV0Y1R1ZXNkYXkgPSB1dGNXZWVrZGF5KDIpOwp2YXIgdXRjV2VkbmVzZGF5ID0gdXRjV2Vla2RheSgzKTsKdmFyIHV0Y1RodXJzZGF5ID0gdXRjV2Vla2RheSg0KTsKdmFyIHV0Y0ZyaWRheSA9IHV0Y1dlZWtkYXkoNSk7CnZhciB1dGNTYXR1cmRheSA9IHV0Y1dlZWtkYXkoNik7CnZhciB1dGNTdW5kYXlzID0gdXRjU3VuZGF5LnJhbmdlOwp2YXIgdXRjTW9uZGF5cyA9IHV0Y01vbmRheS5yYW5nZTsKdmFyIHV0Y1R1ZXNkYXlzID0gdXRjVHVlc2RheS5yYW5nZTsKdmFyIHV0Y1dlZG5lc2RheXMgPSB1dGNXZWRuZXNkYXkucmFuZ2U7CnZhciB1dGNUaHVyc2RheXMgPSB1dGNUaHVyc2RheS5yYW5nZTsKdmFyIHV0Y0ZyaWRheXMgPSB1dGNGcmlkYXkucmFuZ2U7CnZhciB1dGNTYXR1cmRheXMgPSB1dGNTYXR1cmRheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9tb250aC5qcwp2YXIgdGltZU1vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldERhdGUoMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldE1vbnRoKGRhdGUyLmdldE1vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldE1vbnRoKCkgLSBzdGFydC5nZXRNb250aCgpICsgKGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldE1vbnRoKCk7Cn0pOwp2YXIgdGltZU1vbnRocyA9IHRpbWVNb250aC5yYW5nZTsKdmFyIHV0Y01vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ01vbnRoKGRhdGUyLmdldFVUQ01vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ01vbnRoKCkgLSBzdGFydC5nZXRVVENNb250aCgpICsgKGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ01vbnRoKCk7Cn0pOwp2YXIgdXRjTW9udGhzID0gdXRjTW9udGgucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMveWVhci5qcwp2YXIgdGltZVllYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldEZ1bGxZZWFyKCkgLSBzdGFydC5nZXRGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0RnVsbFllYXIoKTsKfSk7CnRpbWVZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldEZ1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB0aW1lWWVhcnMgPSB0aW1lWWVhci5yYW5nZTsKdmFyIHV0Y1llYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKTsKfSk7CnV0Y1llYXIuZXZlcnkgPSAoaykgPT4gewogIHJldHVybiAhaXNGaW5pdGUoayA9IE1hdGguZmxvb3IoaykpIHx8ICEoayA+IDApID8gbnVsbCA6IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKE1hdGguZmxvb3IoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSAvIGspICogayk7CiAgICBkYXRlMi5zZXRVVENNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSArIHN0ZXAgKiBrKTsKICB9KTsKfTsKdmFyIHV0Y1llYXJzID0gdXRjWWVhci5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy90aWNrcy5qcwpmdW5jdGlvbiB0aWNrZXIoeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlKSB7CiAgY29uc3QgdGlja0ludGVydmFscyA9IFsKICAgIFtzZWNvbmQsIDEsIGR1cmF0aW9uU2Vjb25kXSwKICAgIFtzZWNvbmQsIDUsIDUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAxNSwgMTUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAzMCwgMzAgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbbWludXRlLCAxLCBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbbWludXRlLCA1LCA1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMTUsIDE1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMzAsIDMwICogZHVyYXRpb25NaW51dGVdLAogICAgW2hvdXIsIDEsIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMywgMyAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgNiwgNiAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMTIsIDEyICogZHVyYXRpb25Ib3VyXSwKICAgIFtkYXksIDEsIGR1cmF0aW9uRGF5XSwKICAgIFtkYXksIDIsIDIgKiBkdXJhdGlvbkRheV0sCiAgICBbd2VlaywgMSwgZHVyYXRpb25XZWVrXSwKICAgIFttb250aCwgMSwgZHVyYXRpb25Nb250aF0sCiAgICBbbW9udGgsIDMsIDMgKiBkdXJhdGlvbk1vbnRoXSwKICAgIFt5ZWFyLCAxLCBkdXJhdGlvblllYXJdCiAgXTsKICBmdW5jdGlvbiB0aWNrczIoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydDsKICAgIGlmIChyZXZlcnNlMikgW3N0YXJ0LCBzdG9wXSA9IFtzdG9wLCBzdGFydF07CiAgICBjb25zdCBpbnRlcnZhbCA9IGNvdW50ICYmIHR5cGVvZiBjb3VudC5yYW5nZSA9PT0gImZ1bmN0aW9uIiA/IGNvdW50IDogdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgICBjb25zdCB0aWNrczMgPSBpbnRlcnZhbCA/IGludGVydmFsLnJhbmdlKHN0YXJ0LCArc3RvcCArIDEpIDogW107CiAgICByZXR1cm4gcmV2ZXJzZTIgPyB0aWNrczMucmV2ZXJzZSgpIDogdGlja3MzOwogIH0KICBmdW5jdGlvbiB0aWNrSW50ZXJ2YWwoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCB0YXJnZXQgPSBNYXRoLmFicyhzdG9wIC0gc3RhcnQpIC8gY291bnQ7CiAgICBjb25zdCBpID0gYmlzZWN0b3IoKFssICwgc3RlcDJdKSA9PiBzdGVwMikucmlnaHQodGlja0ludGVydmFscywgdGFyZ2V0KTsKICAgIGlmIChpID09PSB0aWNrSW50ZXJ2YWxzLmxlbmd0aCkgcmV0dXJuIHllYXIuZXZlcnkodGlja1N0ZXAoc3RhcnQgLyBkdXJhdGlvblllYXIsIHN0b3AgLyBkdXJhdGlvblllYXIsIGNvdW50KSk7CiAgICBpZiAoaSA9PT0gMCkgcmV0dXJuIG1pbGxpc2Vjb25kLmV2ZXJ5KE1hdGgubWF4KHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCksIDEpKTsKICAgIGNvbnN0IFt0LCBzdGVwXSA9IHRpY2tJbnRlcnZhbHNbdGFyZ2V0IC8gdGlja0ludGVydmFsc1tpIC0gMV1bMl0gPCB0aWNrSW50ZXJ2YWxzW2ldWzJdIC8gdGFyZ2V0ID8gaSAtIDEgOiBpXTsKICAgIHJldHVybiB0LmV2ZXJ5KHN0ZXApOwogIH0KICByZXR1cm4gW3RpY2tzMiwgdGlja0ludGVydmFsXTsKfQp2YXIgW3V0Y1RpY2tzLCB1dGNUaWNrSW50ZXJ2YWxdID0gdGlja2VyKHV0Y1llYXIsIHV0Y01vbnRoLCB1dGNTdW5kYXksIHVuaXhEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSk7CnZhciBbdGltZVRpY2tzLCB0aW1lVGlja0ludGVydmFsXSA9IHRpY2tlcih0aW1lWWVhciwgdGltZU1vbnRoLCB0aW1lU3VuZGF5LCB0aW1lRGF5LCB0aW1lSG91ciwgdGltZU1pbnV0ZSk7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS1mb3JtYXQvc3JjL2xvY2FsZS5qcwpmdW5jdGlvbiBsb2NhbERhdGUoZCkgewogIGlmICgwIDw9IGQueSAmJiBkLnkgPCAxMDApIHsKICAgIHZhciBkYXRlMiA9IG5ldyBEYXRlKC0xLCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKICAgIGRhdGUyLnNldEZ1bGxZZWFyKGQueSk7CiAgICByZXR1cm4gZGF0ZTI7CiAgfQogIHJldHVybiBuZXcgRGF0ZShkLnksIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpOwp9CmZ1bmN0aW9uIHV0Y0RhdGUoZCkgewogIGlmICgwIDw9IGQueSAmJiBkLnkgPCAxMDApIHsKICAgIHZhciBkYXRlMiA9IG5ldyBEYXRlKERhdGUuVVRDKC0xLCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKSk7CiAgICBkYXRlMi5zZXRVVENGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUyOwogIH0KICByZXR1cm4gbmV3IERhdGUoRGF0ZS5VVEMoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKSk7Cn0KZnVuY3Rpb24gbmV3RGF0ZSh5MiwgbSwgZCkgewogIHJldHVybiB7IHk6IHkyLCBtLCBkLCBIOiAwLCBNOiAwLCBTOiAwLCBMOiAwIH07Cn0KZnVuY3Rpb24gZm9ybWF0TG9jYWxlKGxvY2FsZTMpIHsKICB2YXIgbG9jYWxlX2RhdGVUaW1lID0gbG9jYWxlMy5kYXRlVGltZSwgbG9jYWxlX2RhdGUgPSBsb2NhbGUzLmRhdGUsIGxvY2FsZV90aW1lID0gbG9jYWxlMy50aW1lLCBsb2NhbGVfcGVyaW9kcyA9IGxvY2FsZTMucGVyaW9kcywgbG9jYWxlX3dlZWtkYXlzID0gbG9jYWxlMy5kYXlzLCBsb2NhbGVfc2hvcnRXZWVrZGF5cyA9IGxvY2FsZTMuc2hvcnREYXlzLCBsb2NhbGVfbW9udGhzID0gbG9jYWxlMy5tb250aHMsIGxvY2FsZV9zaG9ydE1vbnRocyA9IGxvY2FsZTMuc2hvcnRNb250aHM7CiAgdmFyIHBlcmlvZFJlID0gZm9ybWF0UmUobG9jYWxlX3BlcmlvZHMpLCBwZXJpb2RMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3BlcmlvZHMpLCB3ZWVrZGF5UmUgPSBmb3JtYXRSZShsb2NhbGVfd2Vla2RheXMpLCB3ZWVrZGF5TG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV93ZWVrZGF5cyksIHNob3J0V2Vla2RheVJlID0gZm9ybWF0UmUobG9jYWxlX3Nob3J0V2Vla2RheXMpLCBzaG9ydFdlZWtkYXlMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3Nob3J0V2Vla2RheXMpLCBtb250aFJlID0gZm9ybWF0UmUobG9jYWxlX21vbnRocyksIG1vbnRoTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9tb250aHMpLCBzaG9ydE1vbnRoUmUgPSBmb3JtYXRSZShsb2NhbGVfc2hvcnRNb250aHMpLCBzaG9ydE1vbnRoTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9zaG9ydE1vbnRocyk7CiAgdmFyIGZvcm1hdHMgPSB7CiAgICAiYSI6IGZvcm1hdFNob3J0V2Vla2RheSwKICAgICJBIjogZm9ybWF0V2Vla2RheSwKICAgICJiIjogZm9ybWF0U2hvcnRNb250aCwKICAgICJCIjogZm9ybWF0TW9udGgsCiAgICAiYyI6IG51bGwsCiAgICAiZCI6IGZvcm1hdERheU9mTW9udGgsCiAgICAiZSI6IGZvcm1hdERheU9mTW9udGgsCiAgICAiZiI6IGZvcm1hdE1pY3Jvc2Vjb25kcywKICAgICJnIjogZm9ybWF0WWVhcklTTywKICAgICJHIjogZm9ybWF0RnVsbFllYXJJU08sCiAgICAiSCI6IGZvcm1hdEhvdXIyNCwKICAgICJJIjogZm9ybWF0SG91cjEyLAogICAgImoiOiBmb3JtYXREYXlPZlllYXIsCiAgICAiTCI6IGZvcm1hdE1pbGxpc2Vjb25kcywKICAgICJtIjogZm9ybWF0TW9udGhOdW1iZXIsCiAgICAiTSI6IGZvcm1hdE1pbnV0ZXMsCiAgICAicCI6IGZvcm1hdFBlcmlvZCwKICAgICJxIjogZm9ybWF0UXVhcnRlciwKICAgICJRIjogZm9ybWF0VW5peFRpbWVzdGFtcCwKICAgICJzIjogZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IGZvcm1hdFNlY29uZHMsCiAgICAidSI6IGZvcm1hdFdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IGZvcm1hdFdlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IGZvcm1hdFdlZWtOdW1iZXJJU08sCiAgICAidyI6IGZvcm1hdFdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IGZvcm1hdFdlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IG51bGwsCiAgICAiWCI6IG51bGwsCiAgICAieSI6IGZvcm1hdFllYXIsCiAgICAiWSI6IGZvcm1hdEZ1bGxZZWFyLAogICAgIloiOiBmb3JtYXRab25lLAogICAgIiUiOiBmb3JtYXRMaXRlcmFsUGVyY2VudAogIH07CiAgdmFyIHV0Y0Zvcm1hdHMgPSB7CiAgICAiYSI6IGZvcm1hdFVUQ1Nob3J0V2Vla2RheSwKICAgICJBIjogZm9ybWF0VVRDV2Vla2RheSwKICAgICJiIjogZm9ybWF0VVRDU2hvcnRNb250aCwKICAgICJCIjogZm9ybWF0VVRDTW9udGgsCiAgICAiYyI6IG51bGwsCiAgICAiZCI6IGZvcm1hdFVUQ0RheU9mTW9udGgsCiAgICAiZSI6IGZvcm1hdFVUQ0RheU9mTW9udGgsCiAgICAiZiI6IGZvcm1hdFVUQ01pY3Jvc2Vjb25kcywKICAgICJnIjogZm9ybWF0VVRDWWVhcklTTywKICAgICJHIjogZm9ybWF0VVRDRnVsbFllYXJJU08sCiAgICAiSCI6IGZvcm1hdFVUQ0hvdXIyNCwKICAgICJJIjogZm9ybWF0VVRDSG91cjEyLAogICAgImoiOiBmb3JtYXRVVENEYXlPZlllYXIsCiAgICAiTCI6IGZvcm1hdFVUQ01pbGxpc2Vjb25kcywKICAgICJtIjogZm9ybWF0VVRDTW9udGhOdW1iZXIsCiAgICAiTSI6IGZvcm1hdFVUQ01pbnV0ZXMsCiAgICAicCI6IGZvcm1hdFVUQ1BlcmlvZCwKICAgICJxIjogZm9ybWF0VVRDUXVhcnRlciwKICAgICJRIjogZm9ybWF0VW5peFRpbWVzdGFtcCwKICAgICJzIjogZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IGZvcm1hdFVUQ1NlY29uZHMsCiAgICAidSI6IGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJJU08sCiAgICAidyI6IGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IG51bGwsCiAgICAiWCI6IG51bGwsCiAgICAieSI6IGZvcm1hdFVUQ1llYXIsCiAgICAiWSI6IGZvcm1hdFVUQ0Z1bGxZZWFyLAogICAgIloiOiBmb3JtYXRVVENab25lLAogICAgIiUiOiBmb3JtYXRMaXRlcmFsUGVyY2VudAogIH07CiAgdmFyIHBhcnNlcyA9IHsKICAgICJhIjogcGFyc2VTaG9ydFdlZWtkYXksCiAgICAiQSI6IHBhcnNlV2Vla2RheSwKICAgICJiIjogcGFyc2VTaG9ydE1vbnRoLAogICAgIkIiOiBwYXJzZU1vbnRoLAogICAgImMiOiBwYXJzZUxvY2FsZURhdGVUaW1lLAogICAgImQiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZSI6IHBhcnNlRGF5T2ZNb250aCwKICAgICJmIjogcGFyc2VNaWNyb3NlY29uZHMsCiAgICAiZyI6IHBhcnNlWWVhciwKICAgICJHIjogcGFyc2VGdWxsWWVhciwKICAgICJIIjogcGFyc2VIb3VyMjQsCiAgICAiSSI6IHBhcnNlSG91cjI0LAogICAgImoiOiBwYXJzZURheU9mWWVhciwKICAgICJMIjogcGFyc2VNaWxsaXNlY29uZHMsCiAgICAibSI6IHBhcnNlTW9udGhOdW1iZXIsCiAgICAiTSI6IHBhcnNlTWludXRlcywKICAgICJwIjogcGFyc2VQZXJpb2QsCiAgICAicSI6IHBhcnNlUXVhcnRlciwKICAgICJRIjogcGFyc2VVbml4VGltZXN0YW1wLAogICAgInMiOiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBwYXJzZVNlY29uZHMsCiAgICAidSI6IHBhcnNlV2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogcGFyc2VXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBwYXJzZVdlZWtOdW1iZXJJU08sCiAgICAidyI6IHBhcnNlV2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogcGFyc2VXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBwYXJzZUxvY2FsZURhdGUsCiAgICAiWCI6IHBhcnNlTG9jYWxlVGltZSwKICAgICJ5IjogcGFyc2VZZWFyLAogICAgIlkiOiBwYXJzZUZ1bGxZZWFyLAogICAgIloiOiBwYXJzZVpvbmUsCiAgICAiJSI6IHBhcnNlTGl0ZXJhbFBlcmNlbnQKICB9OwogIGZvcm1hdHMueCA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5YID0gbmV3Rm9ybWF0KGxvY2FsZV90aW1lLCBmb3JtYXRzKTsKICBmb3JtYXRzLmMgPSBuZXdGb3JtYXQobG9jYWxlX2RhdGVUaW1lLCBmb3JtYXRzKTsKICB1dGNGb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgdXRjRm9ybWF0cyk7CiAgdXRjRm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgdXRjRm9ybWF0cyk7CiAgZnVuY3Rpb24gbmV3Rm9ybWF0KHNwZWNpZmllciwgZm9ybWF0czIpIHsKICAgIHJldHVybiBmdW5jdGlvbihkYXRlMikgewogICAgICB2YXIgc3RyaW5nID0gW10sIGkgPSAtMSwgaiA9IDAsIG4gPSBzcGVjaWZpZXIubGVuZ3RoLCBjLCBwYWQyLCBmb3JtYXQyOwogICAgICBpZiAoIShkYXRlMiBpbnN0YW5jZW9mIERhdGUpKSBkYXRlMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpOwogICAgICB3aGlsZSAoKytpIDwgbikgewogICAgICAgIGlmIChzcGVjaWZpZXIuY2hhckNvZGVBdChpKSA9PT0gMzcpIHsKICAgICAgICAgIHN0cmluZy5wdXNoKHNwZWNpZmllci5zbGljZShqLCBpKSk7CiAgICAgICAgICBpZiAoKHBhZDIgPSBwYWRzW2MgPSBzcGVjaWZpZXIuY2hhckF0KCsraSldKSAhPSBudWxsKSBjID0gc3BlY2lmaWVyLmNoYXJBdCgrK2kpOwogICAgICAgICAgZWxzZSBwYWQyID0gYyA9PT0gImUiID8gIiAiIDogIjAiOwogICAgICAgICAgaWYgKGZvcm1hdDIgPSBmb3JtYXRzMltjXSkgYyA9IGZvcm1hdDIoZGF0ZTIsIHBhZDIpOwogICAgICAgICAgc3RyaW5nLnB1c2goYyk7CiAgICAgICAgICBqID0gaSArIDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN0cmluZy5wdXNoKHNwZWNpZmllci5zbGljZShqLCBpKSk7CiAgICAgIHJldHVybiBzdHJpbmcuam9pbigiIik7CiAgICB9OwogIH0KICBmdW5jdGlvbiBuZXdQYXJzZShzcGVjaWZpZXIsIFopIHsKICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdmFyIGQgPSBuZXdEYXRlKDE5MDAsIHZvaWQgMCwgMSksIGkgPSBwYXJzZVNwZWNpZmllcihkLCBzcGVjaWZpZXIsIHN0cmluZyArPSAiIiwgMCksIHdlZWssIGRheTsKICAgICAgaWYgKGkgIT0gc3RyaW5nLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICgiUSIgaW4gZCkgcmV0dXJuIG5ldyBEYXRlKGQuUSk7CiAgICAgIGlmICgicyIgaW4gZCkgcmV0dXJuIG5ldyBEYXRlKGQucyAqIDFlMyArICgiTCIgaW4gZCA/IGQuTCA6IDApKTsKICAgICAgaWYgKFogJiYgISgiWiIgaW4gZCkpIGQuWiA9IDA7CiAgICAgIGlmICgicCIgaW4gZCkgZC5IID0gZC5IICUgMTIgKyBkLnAgKiAxMjsKICAgICAgaWYgKGQubSA9PT0gdm9pZCAwKSBkLm0gPSAicSIgaW4gZCA/IGQucSA6IDA7CiAgICAgIGlmICgiViIgaW4gZCkgewogICAgICAgIGlmIChkLlYgPCAxIHx8IGQuViA+IDUzKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoISgidyIgaW4gZCkpIGQudyA9IDE7CiAgICAgICAgaWYgKCJaIiBpbiBkKSB7CiAgICAgICAgICB3ZWVrID0gdXRjRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLCBkYXkgPSB3ZWVrLmdldFVUQ0RheSgpOwogICAgICAgICAgd2VlayA9IGRheSA+IDQgfHwgZGF5ID09PSAwID8gdXRjTW9uZGF5LmNlaWwod2VlaykgOiB1dGNNb25kYXkod2Vlayk7CiAgICAgICAgICB3ZWVrID0gdXRjRGF5Lm9mZnNldCh3ZWVrLCAoZC5WIC0gMSkgKiA3KTsKICAgICAgICAgIGQueSA9IHdlZWsuZ2V0VVRDRnVsbFllYXIoKTsKICAgICAgICAgIGQubSA9IHdlZWsuZ2V0VVRDTW9udGgoKTsKICAgICAgICAgIGQuZCA9IHdlZWsuZ2V0VVRDRGF0ZSgpICsgKGQudyArIDYpICUgNzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2VlayA9IGxvY2FsRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLCBkYXkgPSB3ZWVrLmdldERheSgpOwogICAgICAgICAgd2VlayA9IGRheSA+IDQgfHwgZGF5ID09PSAwID8gdGltZU1vbmRheS5jZWlsKHdlZWspIDogdGltZU1vbmRheSh3ZWVrKTsKICAgICAgICAgIHdlZWsgPSB0aW1lRGF5Lm9mZnNldCh3ZWVrLCAoZC5WIC0gMSkgKiA3KTsKICAgICAgICAgIGQueSA9IHdlZWsuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgIGQubSA9IHdlZWsuZ2V0TW9udGgoKTsKICAgICAgICAgIGQuZCA9IHdlZWsuZ2V0RGF0ZSgpICsgKGQudyArIDYpICUgNzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoIlciIGluIGQgfHwgIlUiIGluIGQpIHsKICAgICAgICBpZiAoISgidyIgaW4gZCkpIGQudyA9ICJ1IiBpbiBkID8gZC51ICUgNyA6ICJXIiBpbiBkID8gMSA6IDA7CiAgICAgICAgZGF5ID0gIloiIGluIGQgPyB1dGNEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSkuZ2V0VVRDRGF5KCkgOiBsb2NhbERhdGUobmV3RGF0ZShkLnksIDAsIDEpKS5nZXREYXkoKTsKICAgICAgICBkLm0gPSAwOwogICAgICAgIGQuZCA9ICJXIiBpbiBkID8gKGQudyArIDYpICUgNyArIGQuVyAqIDcgLSAoZGF5ICsgNSkgJSA3IDogZC53ICsgZC5VICogNyAtIChkYXkgKyA2KSAlIDc7CiAgICAgIH0KICAgICAgaWYgKCJaIiBpbiBkKSB7CiAgICAgICAgZC5IICs9IGQuWiAvIDEwMCB8IDA7CiAgICAgICAgZC5NICs9IGQuWiAlIDEwMDsKICAgICAgICByZXR1cm4gdXRjRGF0ZShkKTsKICAgICAgfQogICAgICByZXR1cm4gbG9jYWxEYXRlKGQpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTcGVjaWZpZXIoZCwgc3BlY2lmaWVyLCBzdHJpbmcsIGopIHsKICAgIHZhciBpID0gMCwgbiA9IHNwZWNpZmllci5sZW5ndGgsIG0gPSBzdHJpbmcubGVuZ3RoLCBjLCBwYXJzZTsKICAgIHdoaWxlIChpIDwgbikgewogICAgICBpZiAoaiA+PSBtKSByZXR1cm4gLTE7CiAgICAgIGMgPSBzcGVjaWZpZXIuY2hhckNvZGVBdChpKyspOwogICAgICBpZiAoYyA9PT0gMzcpIHsKICAgICAgICBjID0gc3BlY2lmaWVyLmNoYXJBdChpKyspOwogICAgICAgIHBhcnNlID0gcGFyc2VzW2MgaW4gcGFkcyA/IHNwZWNpZmllci5jaGFyQXQoaSsrKSA6IGNdOwogICAgICAgIGlmICghcGFyc2UgfHwgKGogPSBwYXJzZShkLCBzdHJpbmcsIGopKSA8IDApIHJldHVybiAtMTsKICAgICAgfSBlbHNlIGlmIChjICE9IHN0cmluZy5jaGFyQ29kZUF0KGorKykpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqOwogIH0KICBmdW5jdGlvbiBwYXJzZVBlcmlvZChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gcGVyaW9kUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5wID0gcGVyaW9kTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU2hvcnRXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydFdlZWtkYXlSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLncgPSBzaG9ydFdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSB3ZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gd2Vla2RheUxvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0TW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHNob3J0TW9udGhSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLm0gPSBzaG9ydE1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IG1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gbW9udGhMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVEYXRlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZVRpbWUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVUaW1lKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV90aW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydFdlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfd2Vla2RheXNbZC5nZXREYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFNob3J0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydE1vbnRoc1tkLmdldE1vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX21vbnRoc1tkLmdldE1vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRQZXJpb2QoZCkgewogICAgcmV0dXJuIGxvY2FsZV9wZXJpb2RzWysoZC5nZXRIb3VycygpID49IDEyKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFF1YXJ0ZXIoZCkgewogICAgcmV0dXJuIDEgKyB+fihkLmdldE1vbnRoKCkgLyAzKTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRXZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3dlZWtkYXlzW2QuZ2V0VVRDRGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENTaG9ydE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRNb250aHNbZC5nZXRVVENNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDTW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRVVENNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0VVRDSG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRVVENNb250aCgpIC8gMyk7CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgZiA9IG5ld0Zvcm1hdChzcGVjaWZpZXIgKz0gIiIsIGZvcm1hdHMpOwogICAgICBmLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIGY7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgcCA9IG5ld1BhcnNlKHNwZWNpZmllciArPSAiIiwgZmFsc2UpOwogICAgICBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIHA7CiAgICB9LAogICAgdXRjRm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCB1dGNGb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHV0Y1BhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIHRydWUpOwogICAgICBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIHA7CiAgICB9CiAgfTsKfQp2YXIgcGFkcyA9IHsgIi0iOiAiIiwgIl8iOiAiICIsICIwIjogIjAiIH07CnZhciBudW1iZXJSZSA9IC9eXHMqXGQrLzsKdmFyIHBlcmNlbnRSZSA9IC9eJS87CnZhciByZXF1b3RlUmUgPSAvW1xcXiQqKz98W1xdKCkue31dL2c7CmZ1bmN0aW9uIHBhZCh2YWx1ZSwgZmlsbCwgd2lkdGgpIHsKICB2YXIgc2lnbjIgPSB2YWx1ZSA8IDAgPyAiLSIgOiAiIiwgc3RyaW5nID0gKHNpZ24yID8gLXZhbHVlIDogdmFsdWUpICsgIiIsIGxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgcmV0dXJuIHNpZ24yICsgKGxlbmd0aCA8IHdpZHRoID8gbmV3IEFycmF5KHdpZHRoIC0gbGVuZ3RoICsgMSkuam9pbihmaWxsKSArIHN0cmluZyA6IHN0cmluZyk7Cn0KZnVuY3Rpb24gcmVxdW90ZShzKSB7CiAgcmV0dXJuIHMucmVwbGFjZShyZXF1b3RlUmUsICJcXCQmIik7Cn0KZnVuY3Rpb24gZm9ybWF0UmUobmFtZXMpIHsKICByZXR1cm4gbmV3IFJlZ0V4cCgiXig/OiIgKyBuYW1lcy5tYXAocmVxdW90ZSkuam9pbigifCIpICsgIikiLCAiaSIpOwp9CmZ1bmN0aW9uIGZvcm1hdExvb2t1cChuYW1lcykgewogIHJldHVybiBuZXcgTWFwKG5hbWVzLm1hcCgobmFtZSwgaSkgPT4gW25hbWUudG9Mb3dlckNhc2UoKSwgaV0pKTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtkYXlOdW1iZXJTdW5kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQudyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrZGF5TnVtYmVyTW9uZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLnUgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlclN1bmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5VID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJJU08oZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuViA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVyTW9uZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlcgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRnVsbFllYXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNCkpOwogIHJldHVybiBuID8gKGQueSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLnkgPSArblswXSArICgrblswXSA+IDY4ID8gMTkwMCA6IDJlMyksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVpvbmUoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSAvXihaKXwoWystXVxkXGQpKD86Oj8oXGRcZCkpPy8uZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDYpKTsKICByZXR1cm4gbiA/IChkLlogPSBuWzFdID8gMCA6IC0oblsyXSArIChuWzNdIHx8ICIwMCIpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlUXVhcnRlcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC5xID0gblswXSAqIDMgLSAzLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNb250aE51bWJlcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5tID0gblswXSAtIDEsIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZURheU9mTW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuZCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VEYXlPZlllYXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMykpOwogIHJldHVybiBuID8gKGQubSA9IDAsIGQuZCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VIb3VyMjQoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuSCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaW51dGVzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLk0gPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlU2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5TID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1pbGxpc2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAzKSk7CiAgcmV0dXJuIG4gPyAoZC5MID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1pY3Jvc2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA2KSk7CiAgcmV0dXJuIG4gPyAoZC5MID0gTWF0aC5mbG9vcihuWzBdIC8gMWUzKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTGl0ZXJhbFBlcmNlbnQoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBwZXJjZW50UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IGkgKyBuWzBdLmxlbmd0aCA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlVW5peFRpbWVzdGFtcChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICByZXR1cm4gbiA/IChkLlEgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlVW5peFRpbWVzdGFtcFNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgcmV0dXJuIG4gPyAoZC5zID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBmb3JtYXREYXlPZk1vbnRoKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0RGF0ZSgpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRIb3VyMjQoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRIb3VycygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRIb3VyMTIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRIb3VycygpICUgMTIgfHwgMTIsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdERheU9mWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZCgxICsgdGltZURheS5jb3VudCh0aW1lWWVhcihkKSwgZCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pbGxpc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1pbGxpc2Vjb25kcygpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRNaWNyb3NlY29uZHMoZCwgcCkgewogIHJldHVybiBmb3JtYXRNaWxsaXNlY29uZHMoZCwgcCkgKyAiMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRNb250aE51bWJlcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1vbnRoKCkgKyAxLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRNaW51dGVzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TWludXRlcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRTZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0U2Vjb25kcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrZGF5TnVtYmVyTW9uZGF5KGQpIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICByZXR1cm4gZGF5ID09PSAwID8gNyA6IGRheTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVyU3VuZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHRpbWVTdW5kYXkuY291bnQodGltZVllYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZElTTyhkKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgcmV0dXJuIGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHRpbWVUaHVyc2RheShkKSA6IHRpbWVUaHVyc2RheS5jZWlsKGQpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtOdW1iZXJJU08oZCwgcCkgewogIGQgPSBkSVNPKGQpOwogIHJldHVybiBwYWQodGltZVRodXJzZGF5LmNvdW50KHRpbWVZZWFyKGQpLCBkKSArICh0aW1lWWVhcihkKS5nZXREYXkoKSA9PT0gNCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtkYXlOdW1iZXJTdW5kYXkoZCkgewogIHJldHVybiBkLmdldERheSgpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtOdW1iZXJNb25kYXkoZCwgcCkgewogIHJldHVybiBwYWQodGltZU1vbmRheS5jb3VudCh0aW1lWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0WWVhcklTTyhkLCBwKSB7CiAgZCA9IGRJU08oZCk7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEZ1bGxZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0RnVsbFllYXJJU08oZCwgcCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIGQgPSBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB0aW1lVGh1cnNkYXkoZCkgOiB0aW1lVGh1cnNkYXkuY2VpbChkKTsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0Wm9uZShkKSB7CiAgdmFyIHogPSBkLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgcmV0dXJuICh6ID4gMCA/ICItIiA6ICh6ICo9IC0xLCAiKyIpKSArIHBhZCh6IC8gNjAgfCAwLCAiMCIsIDIpICsgcGFkKHogJSA2MCwgIjAiLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENEYXlPZk1vbnRoKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRGF0ZSgpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENIb3VyMjQoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENIb3VycygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENIb3VyMTIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENIb3VycygpICUgMTIgfHwgMTIsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0RheU9mWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZCgxICsgdXRjRGF5LmNvdW50KHV0Y1llYXIoZCksIGQpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaWxsaXNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNaWxsaXNlY29uZHMoKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWljcm9zZWNvbmRzKGQsIHApIHsKICByZXR1cm4gZm9ybWF0VVRDTWlsbGlzZWNvbmRzKGQsIHApICsgIjAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTW9udGhOdW1iZXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNb250aCgpICsgMSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWludXRlcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01pbnV0ZXMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDU2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ1NlY29uZHMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheU51bWJlck1vbmRheShkKSB7CiAgdmFyIGRvdyA9IGQuZ2V0VVRDRGF5KCk7CiAgcmV0dXJuIGRvdyA9PT0gMCA/IDcgOiBkb3c7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlclN1bmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh1dGNTdW5kYXkuY291bnQodXRjWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBVVENkSVNPKGQpIHsKICB2YXIgZGF5ID0gZC5nZXRVVENEYXkoKTsKICByZXR1cm4gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdXRjVGh1cnNkYXkoZCkgOiB1dGNUaHVyc2RheS5jZWlsKGQpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJJU08oZCwgcCkgewogIGQgPSBVVENkSVNPKGQpOwogIHJldHVybiBwYWQodXRjVGh1cnNkYXkuY291bnQodXRjWWVhcihkKSwgZCkgKyAodXRjWWVhcihkKS5nZXRVVENEYXkoKSA9PT0gNCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJTdW5kYXkoZCkgewogIHJldHVybiBkLmdldFVUQ0RheSgpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJNb25kYXkoZCwgcCkgewogIHJldHVybiBwYWQodXRjTW9uZGF5LmNvdW50KHV0Y1llYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1llYXJJU08oZCwgcCkgewogIGQgPSBVVENkSVNPKGQpOwogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENGdWxsWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0Z1bGxZZWFySVNPKGQsIHApIHsKICB2YXIgZGF5ID0gZC5nZXRVVENEYXkoKTsKICBkID0gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdXRjVGh1cnNkYXkoZCkgOiB1dGNUaHVyc2RheS5jZWlsKGQpOwogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRVVENab25lKCkgewogIHJldHVybiAiKzAwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdExpdGVyYWxQZXJjZW50KCkgewogIHJldHVybiAiJSI7Cn0KZnVuY3Rpb24gZm9ybWF0VW5peFRpbWVzdGFtcChkKSB7CiAgcmV0dXJuICtkOwp9CmZ1bmN0aW9uIGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzKGQpIHsKICByZXR1cm4gTWF0aC5mbG9vcigrZCAvIDFlMyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlMjsKdmFyIHRpbWVGb3JtYXQ7CnZhciB0aW1lUGFyc2U7CnZhciB1dGNGb3JtYXQ7CnZhciB1dGNQYXJzZTsKZGVmYXVsdExvY2FsZTIoewogIGRhdGVUaW1lOiAiJXgsICVYIiwKICBkYXRlOiAiJS1tLyUtZC8lWSIsCiAgdGltZTogIiUtSTolTTolUyAlcCIsCiAgcGVyaW9kczogWyJBTSIsICJQTSJdLAogIGRheXM6IFsiU3VuZGF5IiwgIk1vbmRheSIsICJUdWVzZGF5IiwgIldlZG5lc2RheSIsICJUaHVyc2RheSIsICJGcmlkYXkiLCAiU2F0dXJkYXkiXSwKICBzaG9ydERheXM6IFsiU3VuIiwgIk1vbiIsICJUdWUiLCAiV2VkIiwgIlRodSIsICJGcmkiLCAiU2F0Il0sCiAgbW9udGhzOiBbIkphbnVhcnkiLCAiRmVicnVhcnkiLCAiTWFyY2giLCAiQXByaWwiLCAiTWF5IiwgIkp1bmUiLCAiSnVseSIsICJBdWd1c3QiLCAiU2VwdGVtYmVyIiwgIk9jdG9iZXIiLCAiTm92ZW1iZXIiLCAiRGVjZW1iZXIiXSwKICBzaG9ydE1vbnRoczogWyJKYW4iLCAiRmViIiwgIk1hciIsICJBcHIiLCAiTWF5IiwgIkp1biIsICJKdWwiLCAiQXVnIiwgIlNlcCIsICJPY3QiLCAiTm92IiwgIkRlYyJdCn0pOwpmdW5jdGlvbiBkZWZhdWx0TG9jYWxlMihkZWZpbml0aW9uKSB7CiAgbG9jYWxlMiA9IGZvcm1hdExvY2FsZShkZWZpbml0aW9uKTsKICB0aW1lRm9ybWF0ID0gbG9jYWxlMi5mb3JtYXQ7CiAgdGltZVBhcnNlID0gbG9jYWxlMi5wYXJzZTsKICB1dGNGb3JtYXQgPSBsb2NhbGUyLnV0Y0Zvcm1hdDsKICB1dGNQYXJzZSA9IGxvY2FsZTIudXRjUGFyc2U7CiAgcmV0dXJuIGxvY2FsZTI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGltZS5qcwpmdW5jdGlvbiBkYXRlKHQpIHsKICByZXR1cm4gbmV3IERhdGUodCk7Cn0KZnVuY3Rpb24gbnVtYmVyMyh0KSB7CiAgcmV0dXJuIHQgaW5zdGFuY2VvZiBEYXRlID8gK3QgOiArLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCt0KTsKfQpmdW5jdGlvbiBjYWxlbmRhcih0aWNrczIsIHRpY2tJbnRlcnZhbCwgeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQyLCBmb3JtYXQyKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpLCBpbnZlcnQgPSBzY2FsZS5pbnZlcnQsIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICB2YXIgZm9ybWF0TWlsbGlzZWNvbmQgPSBmb3JtYXQyKCIuJUwiKSwgZm9ybWF0U2Vjb25kID0gZm9ybWF0MigiOiVTIiksIGZvcm1hdE1pbnV0ZSA9IGZvcm1hdDIoIiVJOiVNIiksIGZvcm1hdEhvdXIgPSBmb3JtYXQyKCIlSSAlcCIpLCBmb3JtYXREYXkgPSBmb3JtYXQyKCIlYSAlZCIpLCBmb3JtYXRXZWVrID0gZm9ybWF0MigiJWIgJWQiKSwgZm9ybWF0TW9udGggPSBmb3JtYXQyKCIlQiIpLCBmb3JtYXRZZWFyMiA9IGZvcm1hdDIoIiVZIik7CiAgZnVuY3Rpb24gdGlja0Zvcm1hdDIoZGF0ZTIpIHsKICAgIHJldHVybiAoc2Vjb25kMihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbGxpc2Vjb25kIDogbWludXRlKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0U2Vjb25kIDogaG91cihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbnV0ZSA6IGRheShkYXRlMikgPCBkYXRlMiA/IGZvcm1hdEhvdXIgOiBtb250aChkYXRlMikgPCBkYXRlMiA/IHdlZWsoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXREYXkgOiBmb3JtYXRXZWVrIDogeWVhcihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1vbnRoIDogZm9ybWF0WWVhcjIpKGRhdGUyKTsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBuZXcgRGF0ZShpbnZlcnQoeTIpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gZG9tYWluKEFycmF5LmZyb20oXywgbnVtYmVyMykpIDogZG9tYWluKCkubWFwKGRhdGUpOwogIH07CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihpbnRlcnZhbCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrczIoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQsIHNwZWNpZmllcikgewogICAgcmV0dXJuIHNwZWNpZmllciA9PSBudWxsID8gdGlja0Zvcm1hdDIgOiBmb3JtYXQyKHNwZWNpZmllcik7CiAgfTsKICBzY2FsZS5uaWNlID0gZnVuY3Rpb24oaW50ZXJ2YWwpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICBpZiAoIWludGVydmFsIHx8IHR5cGVvZiBpbnRlcnZhbC5yYW5nZSAhPT0gImZ1bmN0aW9uIikgaW50ZXJ2YWwgPSB0aWNrSW50ZXJ2YWwoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgICByZXR1cm4gaW50ZXJ2YWwgPyBkb21haW4obmljZShkLCBpbnRlcnZhbCkpIDogc2NhbGU7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHRpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih0aW1lVGlja3MsIHRpbWVUaWNrSW50ZXJ2YWwsIHRpbWVZZWFyLCB0aW1lTW9udGgsIHRpbWVTdW5kYXksIHRpbWVEYXksIHRpbWVIb3VyLCB0aW1lTWludXRlLCBzZWNvbmQsIHRpbWVGb3JtYXQpLmRvbWFpbihbbmV3IERhdGUoMmUzLCAwLCAxKSwgbmV3IERhdGUoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3V0Y1RpbWUuanMKZnVuY3Rpb24gdXRjVGltZSgpIHsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KGNhbGVuZGFyKHV0Y1RpY2tzLCB1dGNUaWNrSW50ZXJ2YWwsIHV0Y1llYXIsIHV0Y01vbnRoLCB1dGNTdW5kYXksIHV0Y0RheSwgdXRjSG91ciwgdXRjTWludXRlLCBzZWNvbmQsIHV0Y0Zvcm1hdCkuZG9tYWluKFtEYXRlLlVUQygyZTMsIDAsIDEpLCBEYXRlLlVUQygyZTMsIDAsIDIpXSksIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc2VxdWVudGlhbC5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1lcjIoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAxLCB0MDIsIHQxMiwgazEwLCB0cmFuc2Zvcm0sIGludGVycG9sYXRvciA9IGlkZW50aXR5LCBjbGFtcCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogaW50ZXJwb2xhdG9yKGsxMCA9PT0gMCA/IDAuNSA6ICh4MiA9ICh0cmFuc2Zvcm0oeDIpIC0gdDAyKSAqIGsxMCwgY2xhbXAgPyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4MikpIDogeDIpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MV0gPSBfLCB0MDIgPSB0cmFuc2Zvcm0oeDAgPSAreDApLCB0MTIgPSB0cmFuc2Zvcm0oeDEgPSAreDEpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAxIC8gKHQxMiAtIHQwMiksIHNjYWxlKSA6IFt4MCwgeDFdOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9ICEhXywgc2NhbGUpIDogY2xhbXA7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBmdW5jdGlvbiByYW5nZTQoaW50ZXJwb2xhdGUyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oXykgewogICAgICB2YXIgcjAsIHIxOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxXSA9IF8sIGludGVycG9sYXRvciA9IGludGVycG9sYXRlMihyMCwgcjEpLCBzY2FsZSkgOiBbaW50ZXJwb2xhdG9yKDApLCBpbnRlcnBvbGF0b3IoMSldOwogICAgfTsKICB9CiAgc2NhbGUucmFuZ2UgPSByYW5nZTQodmFsdWVfZGVmYXVsdCk7CiAgc2NhbGUucmFuZ2VSb3VuZCA9IHJhbmdlNChyb3VuZF9kZWZhdWx0KTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdHJhbnNmb3JtID0gdCwgdDAyID0gdCh4MCksIHQxMiA9IHQoeDEpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAxIC8gKHQxMiAtIHQwMik7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKfQpmdW5jdGlvbiBjb3B5Mihzb3VyY2UsIHRhcmdldCkgewogIHJldHVybiB0YXJnZXQuZG9tYWluKHNvdXJjZS5kb21haW4oKSkuaW50ZXJwb2xhdG9yKHNvdXJjZS5pbnRlcnBvbGF0b3IoKSkuY2xhbXAoc291cmNlLmNsYW1wKCkpLnVua25vd24oc291cmNlLnVua25vd24oKSk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbCgpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIyKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWwoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsTG9nKCkgewogIHZhciBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIyKCkpLmRvbWFpbihbMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWxMb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFN5bWxvZygpIHsKICB2YXIgc2NhbGUgPSBzeW1sb2dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFN5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxQb3coKSB7CiAgdmFyIHNjYWxlID0gcG93aXNoKHRyYW5zZm9ybWVyMigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWxQb3coKSkuZXhwb25lbnQoc2NhbGUuZXhwb25lbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3FydCgpIHsKICByZXR1cm4gc2VxdWVudGlhbFBvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc2VxdWVudGlhbFF1YW50aWxlLmpzCmZ1bmN0aW9uIHNlcXVlbnRpYWxRdWFudGlsZSgpIHsKICB2YXIgZG9tYWluID0gW10sIGludGVycG9sYXRvciA9IGlkZW50aXR5OwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICBpZiAoeDIgIT0gbnVsbCAmJiAhaXNOYU4oeDIgPSAreDIpKSByZXR1cm4gaW50ZXJwb2xhdG9yKChiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAxKSAtIDEpIC8gKGRvbWFpbi5sZW5ndGggLSAxKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogICAgZG9tYWluID0gW107CiAgICBmb3IgKGxldCBkIG9mIF8pIGlmIChkICE9IG51bGwgJiYgIWlzTmFOKGQgPSArZCkpIGRvbWFpbi5wdXNoKGQpOwogICAgZG9tYWluLnNvcnQoYXNjZW5kaW5nKTsKICAgIHJldHVybiBzY2FsZTsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLm1hcCgoZCwgaSkgPT4gaW50ZXJwb2xhdG9yKGkgLyAoZG9tYWluLmxlbmd0aCAtIDEpKSk7CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbihuKSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aDogbiArIDEgfSwgKF8sIGkpID0+IHF1YW50aWxlKGRvbWFpbiwgaSAvIG4pKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZXF1ZW50aWFsUXVhbnRpbGUoaW50ZXJwb2xhdG9yKS5kb21haW4oZG9tYWluKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2RpdmVyZ2luZy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1lcjMoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAwLjUsIHgyID0gMSwgcyA9IDEsIHQwMiwgdDEyLCB0MiwgazEwLCBrMjEsIGludGVycG9sYXRvciA9IGlkZW50aXR5LCB0cmFuc2Zvcm0sIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDMpIHsKICAgIHJldHVybiBpc05hTih4MyA9ICt4MykgPyB1bmtub3duIDogKHgzID0gMC41ICsgKCh4MyA9ICt0cmFuc2Zvcm0oeDMpKSAtIHQxMikgKiAocyAqIHgzIDwgcyAqIHQxMiA/IGsxMCA6IGsyMSksIGludGVycG9sYXRvcihjbGFtcCA/IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgzKSkgOiB4MykpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxLCB4Ml0gPSBfLCB0MDIgPSB0cmFuc2Zvcm0oeDAgPSAreDApLCB0MTIgPSB0cmFuc2Zvcm0oeDEgPSAreDEpLCB0MiA9IHRyYW5zZm9ybSh4MiA9ICt4MiksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDAuNSAvICh0MTIgLSB0MDIpLCBrMjEgPSB0MTIgPT09IHQyID8gMCA6IDAuNSAvICh0MiAtIHQxMiksIHMgPSB0MTIgPCB0MDIgPyAtMSA6IDEsIHNjYWxlKSA6IFt4MCwgeDEsIHgyXTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSAhIV8sIHNjYWxlKSA6IGNsYW1wOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdG9yID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdG9yID0gXywgc2NhbGUpIDogaW50ZXJwb2xhdG9yOwogIH07CiAgZnVuY3Rpb24gcmFuZ2U0KGludGVycG9sYXRlMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKF8pIHsKICAgICAgdmFyIHIwLCByMSwgcjI7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjEsIHIyXSA9IF8sIGludGVycG9sYXRvciA9IHBpZWNld2lzZShpbnRlcnBvbGF0ZTIsIFtyMCwgcjEsIHIyXSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigwLjUpLCBpbnRlcnBvbGF0b3IoMSldOwogICAgfTsKICB9CiAgc2NhbGUucmFuZ2UgPSByYW5nZTQodmFsdWVfZGVmYXVsdCk7CiAgc2NhbGUucmFuZ2VSb3VuZCA9IHJhbmdlNChyb3VuZF9kZWZhdWx0KTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdHJhbnNmb3JtID0gdCwgdDAyID0gdCh4MCksIHQxMiA9IHQoeDEpLCB0MiA9IHQoeDIpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAwLjUgLyAodDEyIC0gdDAyKSwgazIxID0gdDEyID09PSB0MiA/IDAgOiAwLjUgLyAodDIgLSB0MTIpLCBzID0gdDEyIDwgdDAyID8gLTEgOiAxOwogICAgcmV0dXJuIHNjYWxlOwogIH07Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nKCkgewogIHZhciBzY2FsZSA9IGxpbmVhcmlzaCh0cmFuc2Zvcm1lcjMoKShpZGVudGl0eSkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nTG9nKCkgewogIHZhciBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIzKCkpLmRvbWFpbihbMC4xLCAxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nTG9nKCkpLmJhc2Uoc2NhbGUuYmFzZSgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1N5bWxvZygpIHsKICB2YXIgc2NhbGUgPSBzeW1sb2dpc2godHJhbnNmb3JtZXIzKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nU3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nUG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcjMoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmdQb3coKSkuZXhwb25lbnQoc2NhbGUuZXhwb25lbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdTcXJ0KCkgewogIHJldHVybiBkaXZlcmdpbmdQb3cuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5leHBvbmVudCgwLjUpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9kYXRhU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcyA9IChzdGF0ZSkgPT4gc3RhdGUuY2hhcnREYXRhOwp2YXIgc2VsZWN0Q2hhcnREYXRhQW5kQWx3YXlzSWdub3JlSW5kZXhlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIChkYXRhU3RhdGUpID0+IHsKICB2YXIgZGF0YUVuZEluZGV4ID0gZGF0YVN0YXRlLmNoYXJ0RGF0YSAhPSBudWxsID8gZGF0YVN0YXRlLmNoYXJ0RGF0YS5sZW5ndGggLSAxIDogMDsKICByZXR1cm4gewogICAgY2hhcnREYXRhOiBkYXRhU3RhdGUuY2hhcnREYXRhLAogICAgY29tcHV0ZWREYXRhOiBkYXRhU3RhdGUuY29tcHV0ZWREYXRhLAogICAgZGF0YUVuZEluZGV4LAogICAgZGF0YVN0YXJ0SW5kZXg6IDAKICB9Owp9KTsKdmFyIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hID0gKHN0YXRlLCBfdW51c2VkMSwgX3VudXNlZDIsIGlzUGFub3JhbWEpID0+IHsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIHNlbGVjdENoYXJ0RGF0YUFuZEFsd2F5c0lnbm9yZUluZGV4ZXMoc3RhdGUpOwogIH0KICByZXR1cm4gc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMoc3RhdGUpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2lzRG9tYWluU3BlY2lmaWVkQnlVc2VyLmpzCmZ1bmN0aW9uIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbih2KSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbbWluMiwgbWF4Ml0gPSB2OwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobWluMikgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihtYXgyKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV4dGVuZERvbWFpbihwcm92aWRlZERvbWFpbiwgYm91bmRhcnlEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKGFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gcHJvdmlkZWREb21haW47CiAgfQogIHJldHVybiBbTWF0aC5taW4ocHJvdmlkZWREb21haW5bMF0sIGJvdW5kYXJ5RG9tYWluWzBdKSwgTWF0aC5tYXgocHJvdmlkZWREb21haW5bMV0sIGJvdW5kYXJ5RG9tYWluWzFdKV07Cn0KZnVuY3Rpb24gbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEodXNlckRvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWF4KSkgewogICAgICBmaW5hbE1heCA9IHByb3ZpZGVkTWF4OwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbih1c2VyRG9tYWluLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmICghYWxsb3dEYXRhT3ZlcmZsb3cgJiYgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIgJiYgZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICB0cnkgewogICAgICB2YXIgcmVzdWx0ID0gdXNlckRvbWFpbihkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4ocmVzdWx0KSkgewogICAgICAgIHJldHVybiBleHRlbmREb21haW4ocmVzdWx0LCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIH0KICB9CiAgaWYgKEFycmF5LmlzQXJyYXkodXNlckRvbWFpbikgJiYgdXNlckRvbWFpbi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbcHJvdmlkZWRNaW4sIHByb3ZpZGVkTWF4XSA9IHVzZXJEb21haW47CiAgICB2YXIgZmluYWxNaW4sIGZpbmFsTWF4OwogICAgaWYgKHByb3ZpZGVkTWluID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gTWF0aC5taW4oLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNaW4pKSB7CiAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW47CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW4oZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQyKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAic3RyaW5nIiAmJiBNSU5fVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNaW4pKSB7CiAgICAgIHZhciBtYXRjaCA9IE1JTl9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1pbik7CiAgICAgIGlmIChtYXRjaCA9PSBudWxsIHx8IGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gdm9pZCAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB2YWx1ZSA9ICttYXRjaFsxXTsKICAgICAgICBmaW5hbE1pbiA9IGRhdGFEb21haW5bMF0gLSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMF07CiAgICB9CiAgICBpZiAocHJvdmlkZWRNYXggPT09ICJhdXRvIikgewogICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSBNYXRoLm1heCguLi5kYXRhRG9tYWluKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc051bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heChkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMV0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZDMpIHsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJzdHJpbmciICYmIE1BWF9WQUxVRV9SRUcudGVzdChwcm92aWRlZE1heCkpIHsKICAgICAgdmFyIF9tYXRjaCA9IE1BWF9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1heCk7CiAgICAgIGlmIChfbWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1heCA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX3ZhbHVlID0gK19tYXRjaFsxXTsKICAgICAgICBmaW5hbE1heCA9IGRhdGFEb21haW5bMV0gKyBfdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWF4ID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdOwogICAgfQogICAgdmFyIGNhbmRpZGF0ZSA9IFtmaW5hbE1pbiwgZmluYWxNYXhdOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihjYW5kaWRhdGUpKSB7CiAgICAgIGlmIChkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgICB9CiAgICAgIHJldHVybiBleHRlbmREb21haW4oY2FuZGlkYXRlLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS9nZXROaWNlVGlja1ZhbHVlcy5qcwp2YXIgaW1wb3J0X2RlY2ltYWwyID0gX190b0VTTShyZXF1aXJlX2RlY2ltYWwoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvdXRpbC91dGlscy5qcwp2YXIgaWRlbnRpdHkzID0gKGkpID0+IGk7CnZhciBQTEFDRV9IT0xERVIgPSB7CiAgIkBAZnVuY3Rpb25hbC9wbGFjZWhvbGRlciI6IHRydWUKfTsKdmFyIGlzUGxhY2VIb2xkZXIgPSAodmFsKSA9PiB2YWwgPT09IFBMQUNFX0hPTERFUjsKdmFyIGN1cnJ5MCA9IChmbikgPT4gZnVuY3Rpb24gX2N1cnJpZWQoKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiBpc1BsYWNlSG9sZGVyKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHZvaWQgMCA6IGFyZ3VtZW50c1swXSkpIHsKICAgIHJldHVybiBfY3VycmllZDsKICB9CiAgcmV0dXJuIGZuKC4uLmFyZ3VtZW50cyk7Cn07CnZhciBjdXJyeU4gPSAobiwgZm4pID0+IHsKICBpZiAobiA9PT0gMSkgewogICAgcmV0dXJuIGZuOwogIH0KICByZXR1cm4gY3VycnkwKGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CiAgICB2YXIgYXJnc0xlbmd0aCA9IGFyZ3MuZmlsdGVyKChhcmcpID0+IGFyZyAhPT0gUExBQ0VfSE9MREVSKS5sZW5ndGg7CiAgICBpZiAoYXJnc0xlbmd0aCA+PSBuKSB7CiAgICAgIHJldHVybiBmbiguLi5hcmdzKTsKICAgIH0KICAgIHJldHVybiBjdXJyeU4obiAtIGFyZ3NMZW5ndGgsIGN1cnJ5MChmdW5jdGlvbigpIHsKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCByZXN0QXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIHJlc3RBcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KICAgICAgdmFyIG5ld0FyZ3MgPSBhcmdzLm1hcCgoYXJnKSA9PiBpc1BsYWNlSG9sZGVyKGFyZykgPyByZXN0QXJncy5zaGlmdCgpIDogYXJnKTsKICAgICAgcmV0dXJuIGZuKC4uLm5ld0FyZ3MsIC4uLnJlc3RBcmdzKTsKICAgIH0pKTsKICB9KTsKfTsKdmFyIGN1cnJ5ID0gKGZuKSA9PiBjdXJyeU4oZm4ubGVuZ3RoLCBmbik7CnZhciByYW5nZTIgPSAoYmVnaW4sIGVuZCkgPT4gewogIHZhciBhcnIgPSBbXTsKICBmb3IgKHZhciBpID0gYmVnaW47IGkgPCBlbmQ7ICsraSkgewogICAgYXJyW2kgLSBiZWdpbl0gPSBpOwogIH0KICByZXR1cm4gYXJyOwp9Owp2YXIgbWFwMiA9IGN1cnJ5KChmbiwgYXJyKSA9PiB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFyci5tYXAoZm4pOwogIH0KICByZXR1cm4gT2JqZWN0LmtleXMoYXJyKS5tYXAoKGtleSkgPT4gYXJyW2tleV0pLm1hcChmbik7Cn0pOwp2YXIgY29tcG9zZTIgPSBmdW5jdGlvbiBjb21wb3NlMygpIHsKICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjMpLCBfa2V5MyA9IDA7IF9rZXkzIDwgX2xlbjM7IF9rZXkzKyspIHsKICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICB9CiAgaWYgKCFhcmdzLmxlbmd0aCkgewogICAgcmV0dXJuIGlkZW50aXR5MzsKICB9CiAgdmFyIGZucyA9IGFyZ3MucmV2ZXJzZSgpOwogIHZhciBmaXJzdEZuID0gZm5zWzBdOwogIHZhciB0YWlsc0ZuID0gZm5zLnNsaWNlKDEpOwogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0YWlsc0ZuLnJlZHVjZSgocmVzLCBmbikgPT4gZm4ocmVzKSwgZmlyc3RGbiguLi5hcmd1bWVudHMpKTsKICB9Owp9Owp2YXIgcmV2ZXJzZSA9IChhcnIpID0+IHsKICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyLnJldmVyc2UoKTsKICB9CiAgcmV0dXJuIGFyci5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL3V0aWwvYXJpdGhtZXRpYy5qcwp2YXIgaW1wb3J0X2RlY2ltYWwgPSBfX3RvRVNNKHJlcXVpcmVfZGVjaW1hbCgpKTsKZnVuY3Rpb24gZ2V0RGlnaXRDb3VudCh2YWx1ZSkgewogIHZhciByZXN1bHQ7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXN1bHQgPSAxOwogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBNYXRoLmZsb29yKG5ldyBpbXBvcnRfZGVjaW1hbC5kZWZhdWx0KHZhbHVlKS5hYnMoKS5sb2coMTApLnRvTnVtYmVyKCkpICsgMTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiByYW5nZVN0ZXAoc3RhcnQsIGVuZCwgc3RlcCkgewogIHZhciBudW0gPSBuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdChzdGFydCk7CiAgdmFyIGkgPSAwOwogIHZhciByZXN1bHQgPSBbXTsKICB3aGlsZSAobnVtLmx0KGVuZCkgJiYgaSA8IDFlNSkgewogICAgcmVzdWx0LnB1c2gobnVtLnRvTnVtYmVyKCkpOwogICAgbnVtID0gbnVtLmFkZChzdGVwKTsKICAgIGkrKzsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL2dldE5pY2VUaWNrVmFsdWVzLmpzCnZhciBnZXRWYWxpZEludGVydmFsID0gKF9yZWYyKSA9PiB7CiAgdmFyIFttaW4yLCBtYXgyXSA9IF9yZWYyOwogIHZhciBbdmFsaWRNaW4sIHZhbGlkTWF4XSA9IFttaW4yLCBtYXgyXTsKICBpZiAobWluMiA+IG1heDIpIHsKICAgIFt2YWxpZE1pbiwgdmFsaWRNYXhdID0gW21heDIsIG1pbjJdOwogIH0KICByZXR1cm4gW3ZhbGlkTWluLCB2YWxpZE1heF07Cn07CnZhciBnZXRGb3JtYXRTdGVwID0gKHJvdWdoU3RlcCwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3RvcikgPT4gewogIGlmIChyb3VnaFN0ZXAubHRlKDApKSB7CiAgICByZXR1cm4gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApOwogIH0KICB2YXIgZGlnaXRDb3VudCA9IGdldERpZ2l0Q291bnQocm91Z2hTdGVwLnRvTnVtYmVyKCkpOwogIHZhciBkaWdpdENvdW50VmFsdWUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMTApLnBvdyhkaWdpdENvdW50KTsKICB2YXIgc3RlcFJhdGlvID0gcm91Z2hTdGVwLmRpdihkaWdpdENvdW50VmFsdWUpOwogIHZhciBzdGVwUmF0aW9TY2FsZSA9IGRpZ2l0Q291bnQgIT09IDEgPyAwLjA1IDogMC4xOwogIHZhciBhbWVuZFN0ZXBSYXRpbyA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmNlaWwoc3RlcFJhdGlvLmRpdihzdGVwUmF0aW9TY2FsZSkudG9OdW1iZXIoKSkpLmFkZChjb3JyZWN0aW9uRmFjdG9yKS5tdWwoc3RlcFJhdGlvU2NhbGUpOwogIHZhciBmb3JtYXRTdGVwID0gYW1lbmRTdGVwUmF0aW8ubXVsKGRpZ2l0Q291bnRWYWx1ZSk7CiAgcmV0dXJuIGFsbG93RGVjaW1hbHMgPyBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoZm9ybWF0U3RlcC50b051bWJlcigpKSA6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmNlaWwoZm9ybWF0U3RlcC50b051bWJlcigpKSk7Cn07CnZhciBnZXRUaWNrT2ZTaW5nbGVWYWx1ZSA9ICh2YWx1ZSwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKSA9PiB7CiAgdmFyIHN0ZXAgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMSk7CiAgdmFyIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCh2YWx1ZSk7CiAgaWYgKCFtaWRkbGUuaXNpbnQoKSAmJiBhbGxvd0RlY2ltYWxzKSB7CiAgICB2YXIgYWJzVmFsID0gTWF0aC5hYnModmFsdWUpOwogICAgaWYgKGFic1ZhbCA8IDEpIHsKICAgICAgc3RlcCA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgxMCkucG93KGdldERpZ2l0Q291bnQodmFsdWUpIC0gMSk7CiAgICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKG1pZGRsZS5kaXYoc3RlcCkudG9OdW1iZXIoKSkpLm11bChzdGVwKTsKICAgIH0gZWxzZSBpZiAoYWJzVmFsID4gMSkgewogICAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcih2YWx1ZSkpOwogICAgfQogIH0gZWxzZSBpZiAodmFsdWUgPT09IDApIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKCh0aWNrQ291bnQgLSAxKSAvIDIpKTsKICB9IGVsc2UgaWYgKCFhbGxvd0RlY2ltYWxzKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcih2YWx1ZSkpOwogIH0KICB2YXIgbWlkZGxlSW5kZXggPSBNYXRoLmZsb29yKCh0aWNrQ291bnQgLSAxKSAvIDIpOwogIHZhciBmbiA9IGNvbXBvc2UyKG1hcDIoKG4pID0+IG1pZGRsZS5hZGQobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG4gLSBtaWRkbGVJbmRleCkubXVsKHN0ZXApKS50b051bWJlcigpKSwgcmFuZ2UyKTsKICByZXR1cm4gZm4oMCwgdGlja0NvdW50KTsKfTsKdmFyIF9jYWxjdWxhdGVTdGVwID0gZnVuY3Rpb24gY2FsY3VsYXRlU3RlcChtaW4yLCBtYXgyLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpIHsKICB2YXIgY29ycmVjdGlvbkZhY3RvciA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIGFyZ3VtZW50c1s0XSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzRdIDogMDsKICBpZiAoIU51bWJlci5pc0Zpbml0ZSgobWF4MiAtIG1pbjIpIC8gKHRpY2tDb3VudCAtIDEpKSkgewogICAgcmV0dXJuIHsKICAgICAgc3RlcDogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApLAogICAgICB0aWNrTWluOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCksCiAgICAgIHRpY2tNYXg6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKQogICAgfTsKICB9CiAgdmFyIHN0ZXAgPSBnZXRGb3JtYXRTdGVwKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtYXgyKS5zdWIobWluMikuZGl2KHRpY2tDb3VudCAtIDEpLCBhbGxvd0RlY2ltYWxzLCBjb3JyZWN0aW9uRmFjdG9yKTsKICB2YXIgbWlkZGxlOwogIGlmIChtaW4yIDw9IDAgJiYgbWF4MiA+PSAwKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCk7CiAgfSBlbHNlIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtaW4yKS5hZGQobWF4MikuZGl2KDIpOwogICAgbWlkZGxlID0gbWlkZGxlLnN1YihuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWlkZGxlKS5tb2Qoc3RlcCkpOwogIH0KICB2YXIgYmVsb3dDb3VudCA9IE1hdGguY2VpbChtaWRkbGUuc3ViKG1pbjIpLmRpdihzdGVwKS50b051bWJlcigpKTsKICB2YXIgdXBDb3VudCA9IE1hdGguY2VpbChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWF4Mikuc3ViKG1pZGRsZSkuZGl2KHN0ZXApLnRvTnVtYmVyKCkpOwogIHZhciBzY2FsZUNvdW50ID0gYmVsb3dDb3VudCArIHVwQ291bnQgKyAxOwogIGlmIChzY2FsZUNvdW50ID4gdGlja0NvdW50KSB7CiAgICByZXR1cm4gX2NhbGN1bGF0ZVN0ZXAobWluMiwgbWF4MiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzLCBjb3JyZWN0aW9uRmFjdG9yICsgMSk7CiAgfQogIGlmIChzY2FsZUNvdW50IDwgdGlja0NvdW50KSB7CiAgICB1cENvdW50ID0gbWF4MiA+IDAgPyB1cENvdW50ICsgKHRpY2tDb3VudCAtIHNjYWxlQ291bnQpIDogdXBDb3VudDsKICAgIGJlbG93Q291bnQgPSBtYXgyID4gMCA/IGJlbG93Q291bnQgOiBiZWxvd0NvdW50ICsgKHRpY2tDb3VudCAtIHNjYWxlQ291bnQpOwogIH0KICByZXR1cm4gewogICAgc3RlcCwKICAgIHRpY2tNaW46IG1pZGRsZS5zdWIobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGJlbG93Q291bnQpLm11bChzdGVwKSksCiAgICB0aWNrTWF4OiBtaWRkbGUuYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCh1cENvdW50KS5tdWwoc3RlcCkpCiAgfTsKfTsKdmFyIGdldE5pY2VUaWNrVmFsdWVzID0gZnVuY3Rpb24gZ2V0TmljZVRpY2tWYWx1ZXMyKF9yZWYyKSB7CiAgdmFyIFttaW4yLCBtYXgyXSA9IF9yZWYyOwogIHZhciB0aWNrQ291bnQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IDY7CiAgdmFyIGFsbG93RGVjaW1hbHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgdmFyIGNvdW50ID0gTWF0aC5tYXgodGlja0NvdW50LCAyKTsKICB2YXIgW2Nvcm1pbiwgY29ybWF4XSA9IGdldFZhbGlkSW50ZXJ2YWwoW21pbjIsIG1heDJdKTsKICBpZiAoY29ybWluID09PSAtSW5maW5pdHkgfHwgY29ybWF4ID09PSBJbmZpbml0eSkgewogICAgdmFyIF92YWx1ZXMgPSBjb3JtYXggPT09IEluZmluaXR5ID8gW2Nvcm1pbiwgLi4ucmFuZ2UyKDAsIHRpY2tDb3VudCAtIDEpLm1hcCgoKSA9PiBJbmZpbml0eSldIDogWy4uLnJhbmdlMigwLCB0aWNrQ291bnQgLSAxKS5tYXAoKCkgPT4gLUluZmluaXR5KSwgY29ybWF4XTsKICAgIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UoX3ZhbHVlcykgOiBfdmFsdWVzOwogIH0KICBpZiAoY29ybWluID09PSBjb3JtYXgpIHsKICAgIHJldHVybiBnZXRUaWNrT2ZTaW5nbGVWYWx1ZShjb3JtaW4sIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscyk7CiAgfQogIHZhciB7CiAgICBzdGVwLAogICAgdGlja01pbiwKICAgIHRpY2tNYXgKICB9ID0gX2NhbGN1bGF0ZVN0ZXAoY29ybWluLCBjb3JtYXgsIGNvdW50LCBhbGxvd0RlY2ltYWxzLCAwKTsKICB2YXIgdmFsdWVzID0gcmFuZ2VTdGVwKHRpY2tNaW4sIHRpY2tNYXguYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwLjEpLm11bChzdGVwKSksIHN0ZXApOwogIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UodmFsdWVzKSA6IHZhbHVlczsKfTsKdmFyIGdldFRpY2tWYWx1ZXNGaXhlZERvbWFpbiA9IGZ1bmN0aW9uIGdldFRpY2tWYWx1ZXNGaXhlZERvbWFpbjIoX3JlZjMsIHRpY2tDb3VudCkgewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMzsKICB2YXIgYWxsb3dEZWNpbWFscyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogdHJ1ZTsKICB2YXIgW2Nvcm1pbiwgY29ybWF4XSA9IGdldFZhbGlkSW50ZXJ2YWwoW21pbjIsIG1heDJdKTsKICBpZiAoY29ybWluID09PSAtSW5maW5pdHkgfHwgY29ybWF4ID09PSBJbmZpbml0eSkgewogICAgcmV0dXJuIFttaW4yLCBtYXgyXTsKICB9CiAgaWYgKGNvcm1pbiA9PT0gY29ybWF4KSB7CiAgICByZXR1cm4gW2Nvcm1pbl07CiAgfQogIHZhciBjb3VudCA9IE1hdGgubWF4KHRpY2tDb3VudCwgMik7CiAgdmFyIHN0ZXAgPSBnZXRGb3JtYXRTdGVwKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtYXgpLnN1Yihjb3JtaW4pLmRpdihjb3VudCAtIDEpLCBhbGxvd0RlY2ltYWxzLCAwKTsKICB2YXIgdmFsdWVzID0gWy4uLnJhbmdlU3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWluKSwgbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1heCksIHN0ZXApLCBjb3JtYXhdOwogIGlmIChhbGxvd0RlY2ltYWxzID09PSBmYWxzZSkgewogICAgdmFsdWVzID0gdmFsdWVzLm1hcCgodmFsdWUpID0+IE1hdGgucm91bmQodmFsdWUpKTsKICB9CiAgcmV0dXJuIG1pbjIgPiBtYXgyID8gcmV2ZXJzZSh2YWx1ZXMpIDogdmFsdWVzOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcm9vdFByb3BzU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RCYXJDYXRlZ29yeUdhcCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmJhckNhdGVnb3J5R2FwOwp2YXIgc2VsZWN0U3RhY2tPZmZzZXRUeXBlID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3RhY2tPZmZzZXQ7CnZhciBzZWxlY3RSZXZlcnNlU3RhY2tPcmRlciA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnJldmVyc2VTdGFja09yZGVyOwp2YXIgc2VsZWN0Q2hhcnROYW1lID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmNoYXJ0TmFtZTsKdmFyIHNlbGVjdFN5bmNJZCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN5bmNJZDsKdmFyIHNlbGVjdFN5bmNNZXRob2QgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zeW5jTWV0aG9kOwp2YXIgc2VsZWN0RXZlbnRFbWl0dGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmV2ZW50RW1pdHRlcjsKdmFyIHNlbGVjdENoYXJ0QmFzZVZhbHVlID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYmFzZVZhbHVlOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvRGVmYXVsdFpJbmRleGVzLmpzCnZhciBEZWZhdWx0WkluZGV4ZXMgPSB7CiAgLyoqCiAgICogQ2FydGVzaWFuR3JpZCBhbmQgUG9sYXJHcmlkCiAgICovCiAgZ3JpZDogLTEwMCwKICAvKioKICAgKiBCYWNrZ3JvdW5kIG9mIEJhciBhbmQgUmFkaWFsQmFyLgogICAqIFRoaXMgaXMgbm90IHZpc2libGUgYnkgZGVmYXVsdCBidXQgY2FuIGJlIGVuYWJsZWQgYnkgc2V0dGluZyBiYWNrZ3JvdW5kPXt0cnVlfSBvbiBCYXIgb3IgUmFkaWFsQmFyLgogICAqLwogIGJhckJhY2tncm91bmQ6IC01MCwKICAvKgogICAqIG90aGVyIGNoYXJ0IGVsZW1lbnRzIG9yIGN1c3RvbSBlbGVtZW50cyB3aXRob3V0IHNwZWNpZmljIHpJbmRleAogICAqIHJlbmRlciBpbiBoZXJlLCBhdCB6SW5kZXggMAogICAqLwogIC8qKgogICAqIEFyZWEsIFBpZSwgUmFkYXIsIGFuZCBSZWZlcmVuY2VBcmVhCiAgICovCiAgYXJlYTogMTAwLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYS4gQ3Vyc29yUmVjdGFuZ2xlIGlzIGEgcmVjdGFuZ2xlIGJveC4KICAgKiBJdCByZW5kZXJzIGJlbG93IGJhciBzbyB0aGF0IGluIGEgc3RhY2tlZCBiYXIgY2hhcnQgdGhlIGN1cnNvciByZWN0YW5nbGUgZG9lcyBub3QgaGlkZSB0aGUgb3RoZXIgYmFycy4KICAgKi8KICBjdXJzb3JSZWN0YW5nbGU6IDIwMCwKICAvKioKICAgKiBCYXIgYW5kIFJhZGlhbEJhcgogICAqLwogIGJhcjogMzAwLAogIC8qKgogICAqIExpbmUgYW5kIFJlZmVyZW5jZUxpbmUsIGFuZCBFcnJvckJvcgogICAqLwogIGxpbmU6IDQwMCwKICAvKioKICAgKiBYQXhpcyBhbmQgWUF4aXMgYW5kIFBvbGFyQW5nbGVBeGlzIGFuZCBQb2xhclJhZGl1c0F4aXMgdGlja3MgYW5kIGxpbmVzIGFuZCBjaGlsZHJlbgogICAqLwogIGF4aXM6IDUwMCwKICAvKioKICAgKiBTY2F0dGVyIGFuZCBSZWZlcmVuY2VEb3QsCiAgICogYW5kIERvdHMgb2YgTGluZSBhbmQgQXJlYSBhbmQgUmFkYXIgaWYgdGhleSBoYXZlIGRvdD10cnVlCiAgICovCiAgc2NhdHRlcjogNjAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBCYXIgb3IgUmFkaWFsQmFyIHJlbmRlcnMgYSBoaWdobGlnaHQgcmVjdGFuZ2xlCiAgICovCiAgYWN0aXZlQmFyOiAxZTMsCiAgLyoqCiAgICogQ3Vyc29yIGlzIGVtYmVkZGVkIGluc2lkZSBUb29sdGlwIGFuZCBjb250cm9sbGVkIGJ5IGl0LgogICAqIFRoZSBUb29sdGlwIGl0c2VsZiBoYXMgYSBzZXBhcmF0ZSBwb3J0YWwgYW5kIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgekluZGV4IHN5c3RlbTsKICAgKiBDdXJzb3IgaXMgdGhlIGRlY29yYXRpb24gaW5zaWRlIHRoZSBjaGFydCBhcmVhLCB1c3VhbGx5IGEgY3Jvc3Mgb3IgYSBib3guCiAgICogQ3Vyc29yTGluZSBpcyBhIGxpbmUgY3Vyc29yIHJlbmRlcmVkIGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIGNoYXJ0cy4KICAgKiBJdCByZW5kZXJzIGFib3ZlIHRoZSBMaW5lIGFuZCBTY2F0dGVyIHNvIHRoYXQgaXQgaXMgYWx3YXlzIHZpc2libGUuCiAgICogSXQgcmVuZGVycyBiZWxvdyBhY3RpdmUgZG90IHNvIHRoYXQgdGhlIGRvdCBpcyBhbHdheXMgdmlzaWJsZSBhbmQgc2hvd3MgdGhlIGN1cnJlbnQgcG9pbnQuCiAgICogV2UncmUgYWxzbyBhc3N1bWluZyB0aGF0IHRoZSBhY3RpdmUgZG90IGlzIHNtYWxsIGVub3VnaCB0aGF0IGl0IGRvZXMgbm90IGZ1bGx5IGNvdmVyIHRoZSBjdXJzb3IgbGluZS4KICAgKgogICAqIFRoaXMgYWxzbyBhcHBsaWVzIHRvIHRoZSByYWRpYWwgY3Vyc29yIGluIFJhZGlhbEJhckNoYXJ0LgogICAqLwogIGN1cnNvckxpbmU6IDExMDAsCiAgLyoqCiAgICogSG92ZXJpbmcgb3ZlciBhIFBvaW50IGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIHJlbmRlcnMgYSBoaWdobGlnaHQgZG90CiAgICovCiAgYWN0aXZlRG90OiAxMjAwLAogIC8qKgogICAqIExhYmVsTGlzdCBhbmQgTGFiZWwsIGluY2x1ZGluZyBBeGlzIGxhYmVscwogICAqLwogIGxhYmVsOiAyZTMKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvcG9sYXIvZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuanMKdmFyIGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzID0gewogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIC8vIGlmIEkgc2V0IHRoaXMgdG8gZmFsc2UgdGhlbiBUb29sdGlwIHN5bmNocm9uaXNhdGlvbiBzdG9wcyB3b3JraW5nIGluIFJhZGFyLCB3dGYKICBhbmdsZUF4aXNJZDogMCwKICBheGlzTGluZTogdHJ1ZSwKICBheGlzTGluZVR5cGU6ICJwb2x5Z29uIiwKICBjeDogMCwKICBjeTogMCwKICBvcmllbnRhdGlvbjogIm91dGVyIiwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6ICJhdXRvIiwKICB0aWNrOiB0cnVlLAogIHRpY2tMaW5lOiB0cnVlLAogIHRpY2tTaXplOiA4LAogIHR5cGU6ICJjYXRlZ29yeSIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9wb2xhci9kZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuanMKdmFyIGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgYW5nbGU6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbGFiZWw6IGZhbHNlLAogIG9yaWVudGF0aW9uOiAicmlnaHQiLAogIHJhZGl1c0F4aXNJZDogMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6ICJhdXRvIiwKICBzdHJva2U6ICIjY2NjIiwKICB0aWNrOiB0cnVlLAogIHRpY2tDb3VudDogNSwKICB0eXBlOiAibnVtYmVyIiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlLmpzCnZhciBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UgPSAoYXhpc1NldHRpbmdzLCBheGlzUmFuZ2UpID0+IHsKICBpZiAoIWF4aXNTZXR0aW5ncyB8fCAhYXhpc1JhbmdlKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9PSBudWxsICYmIGF4aXNTZXR0aW5ncyAhPT0gdm9pZCAwICYmIGF4aXNTZXR0aW5ncy5yZXZlcnNlZCkgewogICAgcmV0dXJuIFtheGlzUmFuZ2VbMV0sIGF4aXNSYW5nZVswXV07CiAgfQogIHJldHVybiBheGlzUmFuZ2U7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9wb2xhckF4aXNTZWxlY3RvcnMuanMKdmFyIGltcGxpY2l0QW5nbGVBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZmFsc2UsCiAgLy8gZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgaGFzIGl0IHNldCB0byB0cnVlIGJ1dCB0aGUgYWN0dWFsIGF4aXMgcmVuZGVyaW5nIGlnbm9yZXMgdGhlIHByb3AgYmVjYXVzZSByZWFzb25zLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBpZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuYW5nbGVBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5yZXZlcnNlZCwKICBzY2FsZTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuc2NhbGUsCiAgdGljazogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnR5cGUsCiAgdW5pdDogdm9pZCAwCn07CnZhciBpbXBsaWNpdFJhZGl1c0F4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBpZDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnJhZGl1c0F4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuc2NhbGUsCiAgdGljazogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGlja0NvdW50LAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnR5cGUsCiAgdW5pdDogdm9pZCAwCn07CnZhciBpbXBsaWNpdFJhZGlhbEJhckFuZ2xlQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBpZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuYW5nbGVBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuc2NhbGUsCiAgdGljazogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJudW1iZXIiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpYWxCYXJSYWRpdXNBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5yYWRpdXNBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2tDb3VudCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJjYXRlZ29yeSIsCiAgdW5pdDogdm9pZCAwCn07CnZhciBzZWxlY3RBbmdsZUF4aXMgPSAoc3RhdGUsIGFuZ2xlQXhpc0lkKSA9PiB7CiAgaWYgKHN0YXRlLnBvbGFyQXhpcy5hbmdsZUF4aXNbYW5nbGVBeGlzSWRdICE9IG51bGwpIHsKICAgIHJldHVybiBzdGF0ZS5wb2xhckF4aXMuYW5nbGVBeGlzW2FuZ2xlQXhpc0lkXTsKICB9CiAgaWYgKHN0YXRlLmxheW91dC5sYXlvdXRUeXBlID09PSAicmFkaWFsIikgewogICAgcmV0dXJuIGltcGxpY2l0UmFkaWFsQmFyQW5nbGVBeGlzOwogIH0KICByZXR1cm4gaW1wbGljaXRBbmdsZUF4aXM7Cn07CnZhciBzZWxlY3RSYWRpdXNBeGlzID0gKHN0YXRlLCByYWRpdXNBeGlzSWQpID0+IHsKICBpZiAoc3RhdGUucG9sYXJBeGlzLnJhZGl1c0F4aXNbcmFkaXVzQXhpc0lkXSAhPSBudWxsKSB7CiAgICByZXR1cm4gc3RhdGUucG9sYXJBeGlzLnJhZGl1c0F4aXNbcmFkaXVzQXhpc0lkXTsKICB9CiAgaWYgKHN0YXRlLmxheW91dC5sYXlvdXRUeXBlID09PSAicmFkaWFsIikgewogICAgcmV0dXJuIGltcGxpY2l0UmFkaWFsQmFyUmFkaXVzQXhpczsKICB9CiAgcmV0dXJuIGltcGxpY2l0UmFkaXVzQXhpczsKfTsKdmFyIHNlbGVjdFBvbGFyT3B0aW9ucyA9IChzdGF0ZSkgPT4gc3RhdGUucG9sYXJPcHRpb25zOwp2YXIgc2VsZWN0TWF4UmFkaXVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgZ2V0TWF4UmFkaXVzKTsKdmFyIHNlbGVjdElubmVyUmFkaXVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0TWF4UmFkaXVzXSwgKHBvbGFyQ2hhcnRPcHRpb25zLCBtYXhSYWRpdXMpID0+IHsKICBpZiAocG9sYXJDaGFydE9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGdldFBlcmNlbnRWYWx1ZShwb2xhckNoYXJ0T3B0aW9ucy5pbm5lclJhZGl1cywgbWF4UmFkaXVzLCAwKTsKfSk7CnZhciBzZWxlY3RPdXRlclJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdE1heFJhZGl1c10sIChwb2xhckNoYXJ0T3B0aW9ucywgbWF4UmFkaXVzKSA9PiB7CiAgaWYgKHBvbGFyQ2hhcnRPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBnZXRQZXJjZW50VmFsdWUocG9sYXJDaGFydE9wdGlvbnMub3V0ZXJSYWRpdXMsIG1heFJhZGl1cywgbWF4UmFkaXVzICogMC44KTsKfSk7CnZhciBjb21iaW5lQW5nbGVBeGlzUmFuZ2UgPSAocG9sYXJPcHRpb25zKSA9PiB7CiAgaWYgKHBvbGFyT3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gWzAsIDBdOwogIH0KICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IHBvbGFyT3B0aW9uczsKICByZXR1cm4gW3N0YXJ0QW5nbGUsIGVuZEFuZ2xlXTsKfTsKdmFyIHNlbGVjdEFuZ2xlQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyT3B0aW9uc10sIGNvbWJpbmVBbmdsZUF4aXNSYW5nZSk7CnZhciBzZWxlY3RBbmdsZUF4aXNSYW5nZVdpdGhSZXZlcnNlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbmdsZUF4aXMsIHNlbGVjdEFuZ2xlQXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdFJhZGl1c0F4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RNYXhSYWRpdXMsIHNlbGVjdElubmVyUmFkaXVzLCBzZWxlY3RPdXRlclJhZGl1c10sIChtYXhSYWRpdXMsIGlubmVyUmFkaXVzLCBvdXRlclJhZGl1cykgPT4gewogIGlmIChtYXhSYWRpdXMgPT0gbnVsbCB8fCBpbm5lclJhZGl1cyA9PSBudWxsIHx8IG91dGVyUmFkaXVzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzXTsKfSk7CnZhciBzZWxlY3RSYWRpdXNBeGlzUmFuZ2VXaXRoUmV2ZXJzZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmFkaXVzQXhpcywgc2VsZWN0UmFkaXVzQXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdFBvbGFyVmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RJbm5lclJhZGl1cywgc2VsZWN0T3V0ZXJSYWRpdXMsIHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0XSwgKGxheW91dCwgcG9sYXJPcHRpb25zLCBpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXMsIHdpZHRoLCBoZWlnaHQpID0+IHsKICBpZiAobGF5b3V0ICE9PSAiY2VudHJpYyIgJiYgbGF5b3V0ICE9PSAicmFkaWFsIiB8fCBwb2xhck9wdGlvbnMgPT0gbnVsbCB8fCBpbm5lclJhZGl1cyA9PSBudWxsIHx8IG91dGVyUmFkaXVzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IHBvbGFyT3B0aW9uczsKICByZXR1cm4gewogICAgY3g6IGdldFBlcmNlbnRWYWx1ZShjeCwgd2lkdGgsIHdpZHRoIC8gMiksCiAgICBjeTogZ2V0UGVyY2VudFZhbHVlKGN5LCBoZWlnaHQsIGhlaWdodCAvIDIpLAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsb2NrV2lzZTogZmFsc2UKICAgIC8vIHRoaXMgcHJvcGVydHkgbG9vayB1c2VmdWwsIHdoeSBub3QgdXNlIGl0PwogIH07Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcGlja0F4aXNUeXBlLmpzCnZhciBwaWNrQXhpc1R5cGUgPSAoX3N0YXRlLCBheGlzVHlwZSkgPT4gYXhpc1R5cGU7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc0lkLmpzCnZhciBwaWNrQXhpc0lkID0gKF9zdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IGF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdGFja3MvZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyLmpzCmZ1bmN0aW9uIGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcihncmFwaGljYWxJdGVtKSB7CiAgcmV0dXJuIGdyYXBoaWNhbEl0ZW0gPT09IG51bGwgfHwgZ3JhcGhpY2FsSXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JhcGhpY2FsSXRlbS5pZDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YS5qcwpmdW5jdGlvbiBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEoc3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBfcmVmMiwgdG9vbHRpcEF4aXNTZXR0aW5ncykgewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXQogIH0gPSBfcmVmMjsKICB2YXIgewogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBkYXRhS2V5OiB0b29sdGlwRGF0YUtleQogIH0gPSB0b29sdGlwQXhpc1NldHRpbmdzOwogIHZhciBrbm93bkl0ZW1zQnlEYXRhS2V5ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBzdGFja2VkR3JhcGhpY2FsSXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgdmFyIF9pdGVtJGRhdGE7CiAgICB2YXIgcmVzb2x2ZWREYXRhID0gKF9pdGVtJGRhdGEgPSBpdGVtLmRhdGEpICE9PSBudWxsICYmIF9pdGVtJGRhdGEgIT09IHZvaWQgMCA/IF9pdGVtJGRhdGEgOiBjaGFydERhdGE7CiAgICBpZiAocmVzb2x2ZWREYXRhID09IG51bGwgfHwgcmVzb2x2ZWREYXRhLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3RhY2tJZGVudGlmaWVyID0gZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKGl0ZW0pOwogICAgcmVzb2x2ZWREYXRhLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgdG9vbHRpcFZhbHVlID0gdG9vbHRpcERhdGFLZXkgPT0gbnVsbCB8fCBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSA/IGluZGV4IDogU3RyaW5nKGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCB0b29sdGlwRGF0YUtleSwgbnVsbCkpOwogICAgICB2YXIgbnVtZXJpY1ZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGl0ZW0uZGF0YUtleSwgMCk7CiAgICAgIHZhciBjdXJyOwogICAgICBpZiAoa25vd25JdGVtc0J5RGF0YUtleS5oYXModG9vbHRpcFZhbHVlKSkgewogICAgICAgIGN1cnIgPSBrbm93bkl0ZW1zQnlEYXRhS2V5LmdldCh0b29sdGlwVmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1cnIgPSB7fTsKICAgICAgfQogICAgICBPYmplY3QuYXNzaWduKGN1cnIsIHsKICAgICAgICBbc3RhY2tJZGVudGlmaWVyXTogbnVtZXJpY1ZhbHVlCiAgICAgIH0pOwogICAgICBrbm93bkl0ZW1zQnlEYXRhS2V5LnNldCh0b29sdGlwVmFsdWUsIGN1cnIpOwogICAgfSk7CiAgfSk7CiAgcmV0dXJuIEFycmF5LmZyb20oa25vd25JdGVtc0J5RGF0YUtleS52YWx1ZXMoKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdHlwZXMvU3RhY2tlZEdyYXBoaWNhbEl0ZW0uanMKZnVuY3Rpb24gaXNTdGFja2VkKGdyYXBoaWNhbEl0ZW0pIHsKICByZXR1cm4gZ3JhcGhpY2FsSXRlbS5zdGFja0lkICE9IG51bGwgJiYgZ3JhcGhpY2FsSXRlbS5kYXRhS2V5ICE9IG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL251bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2suanMKdmFyIG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sgPSAoYSwgYikgPT4gewogIGlmIChhID09PSBiKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGFbMF0gPT09IGJbMF0gJiYgYVsxXSA9PT0gYlsxXTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2FycmF5RXF1YWxpdHlDaGVjay5qcwpmdW5jdGlvbiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2soYSwgYikgewogIGlmIChBcnJheS5pc0FycmF5KGEpICYmIEFycmF5LmlzQXJyYXkoYikgJiYgYS5sZW5ndGggPT09IDAgJiYgYi5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gYSA9PT0gYjsKfQpmdW5jdGlvbiBhcnJheUNvbnRlbnRzQXJlRXF1YWxDaGVjayhhLCBiKSB7CiAgaWYgKGEubGVuZ3RoID09PSBiLmxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc1R5cGUuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSA9IChzdGF0ZSkgPT4gewogIHZhciBsYXlvdXQgPSBzZWxlY3RDaGFydExheW91dChzdGF0ZSk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gInhBeGlzIjsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuICJ5QXhpcyI7CiAgfQogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuICJhbmdsZUF4aXMiOwogIH0KICByZXR1cm4gInJhZGl1c0F4aXMiOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcEF4aXNJZC5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNJZCA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5heGlzSWQ7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9heGlzU2VsZWN0b3JzLmpzCmZ1bmN0aW9uIG93bktleXMxMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZGVmYXVsdE51bWVyaWNEb21haW4gPSBbMCwgImF1dG8iXTsKdmFyIGltcGxpY2l0WEF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IHRydWUsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgYW5nbGU6IDAsCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGhlaWdodDogMzAsCiAgaGlkZTogdHJ1ZSwKICBpZDogMCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICBtaW5UaWNrR2FwOiA1LAogIG1pcnJvcjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIG9yaWVudGF0aW9uOiAiYm90dG9tIiwKICBwYWRkaW5nOiB7CiAgICBsZWZ0OiAwLAogICAgcmlnaHQ6IDAKICB9LAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHRpY2tGb3JtYXR0ZXI6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJjYXRlZ29yeSIsCiAgdW5pdDogdm9pZCAwCn07CnZhciBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIHN0YXRlLmNhcnRlc2lhbkF4aXMueEF4aXNbYXhpc0lkXTsKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc2VsZWN0WEF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGltcGxpY2l0WEF4aXM7CiAgfQogIHJldHVybiBheGlzOwp9Owp2YXIgaW1wbGljaXRZQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiBkZWZhdWx0TnVtZXJpY0RvbWFpbiwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJsZWZ0IiwKICBwYWRkaW5nOiB7CiAgICB0b3A6IDAsCiAgICBib3R0b206IDAKICB9LAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHRpY2tGb3JtYXR0ZXI6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJudW1iZXIiLAogIHVuaXQ6IHZvaWQgMCwKICB3aWR0aDogREVGQVVMVF9ZX0FYSVNfV0lEVEgKfTsKdmFyIHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy55QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RZQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRZQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFpBeGlzID0gewogIGRvbWFpbjogWzAsICJhdXRvIl0sCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZmFsc2UsCiAgZGF0YUtleTogdm9pZCAwLAogIGlkOiAwLAogIG5hbWU6ICIiLAogIHJhbmdlOiBbNjQsIDY0XSwKICBzY2FsZTogImF1dG8iLAogIHR5cGU6ICJudW1iZXIiLAogIHVuaXQ6ICIiCn07CnZhciBzZWxlY3RaQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHN0YXRlLmNhcnRlc2lhbkF4aXMuekF4aXNbYXhpc0lkXTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRaQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBzZWxlY3RCYXNlQXhpcyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInpBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WkF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgImFuZ2xlQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInJhZGl1c0F4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGF4aXMgdHlwZTogIi5jb25jYXQoYXhpc1R5cGUpKTsKICB9Cn07CnZhciBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpID0+IHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJ5QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgImFuZ2xlQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInJhZGl1c0F4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGF4aXMgdHlwZTogIi5jb25jYXQoYXhpc1R5cGUpKTsKICB9Cn07CnZhciBzZWxlY3RIYXNCYXIgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLnNvbWUoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImJhciIpIHx8IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAicmFkaWFsQmFyIik7CmZ1bmN0aW9uIGl0ZW1BeGlzUHJlZGljYXRlKGF4aXNUeXBlLCBheGlzSWQpIHsKICByZXR1cm4gKGl0ZW0pID0+IHsKICAgIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgICAgY2FzZSAieEF4aXMiOgogICAgICAgIHJldHVybiAieEF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAieUF4aXMiOgogICAgICAgIHJldHVybiAieUF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnlBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAiekF4aXMiOgogICAgICAgIHJldHVybiAiekF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnpBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAiYW5nbGVBeGlzIjoKICAgICAgICByZXR1cm4gImFuZ2xlQXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uYW5nbGVBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgICAgcmV0dXJuICJyYWRpdXNBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5yYWRpdXNBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKfQp2YXIgc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zID0gKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5jYXJ0ZXNpYW5JdGVtczsKdmFyIHNlbGVjdEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3RvcihbcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgY29tYmluZUdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSAoZ3JhcGhpY2FsSXRlbXMsIGF4aXNTZXR0aW5ncywgYXhpc1ByZWRpY2F0ZSkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGF4aXNQcmVkaWNhdGUpLmZpbHRlcigoaXRlbSkgPT4gewogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmluY2x1ZGVIaWRkZW4pID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuICFpdGVtLmhpZGU7Cn0pOwp2YXIgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUHJlZGljYXRlXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCAoY2FydGVzaWFuSXRlbXMpID0+IHsKICByZXR1cm4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIiB8fCBpdGVtLnR5cGUgPT09ICJiYXIiKS5maWx0ZXIoaXNTdGFja2VkKTsKfSk7CnZhciBmaWx0ZXJHcmFwaGljYWxOb3RTdGFja2VkSXRlbXMgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLmZpbHRlcigoaXRlbSkgPT4gISgic3RhY2tJZCIgaW4gaXRlbSkgfHwgaXRlbS5zdGFja0lkID09PSB2b2lkIDApOwp2YXIgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhID0gKGNhcnRlc2lhbkl0ZW1zKSA9PiBjYXJ0ZXNpYW5JdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uZGF0YSkuZmlsdGVyKEJvb2xlYW4pLmZsYXQoMSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtc0RhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIGNvbWJpbmVEaXNwbGF5ZWREYXRhID0gKGdyYXBoaWNhbEl0ZW1zRGF0YSwgX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhID0gW10sCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoZ3JhcGhpY2FsSXRlbXNEYXRhLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBncmFwaGljYWxJdGVtc0RhdGE7CiAgfQogIHJldHVybiBjaGFydERhdGEuc2xpY2UoZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCArIDEpOwp9Owp2YXIgc2VsZWN0RGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtc0RhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hXSwgY29tYmluZURpc3BsYXllZERhdGEpOwp2YXIgY29tYmluZUFwcGxpZWRWYWx1ZXMgPSAoZGF0YSwgYXhpc1NldHRpbmdzLCBpdGVtcykgPT4gewogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGl0ZW0sIGF4aXNTZXR0aW5ncy5kYXRhS2V5KQogICAgfSkpOwogIH0KICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhS2V5KS5mbGF0TWFwKChkYXRhS2V5KSA9PiBkYXRhLm1hcCgoZW50cnkpID0+ICh7CiAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkKICAgIH0pKSk7CiAgfQogIHJldHVybiBkYXRhLm1hcCgoZW50cnkpID0+ICh7CiAgICB2YWx1ZTogZW50cnkKICB9KSk7Cn07CnZhciBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUFwcGxpZWRWYWx1ZXMpOwpmdW5jdGlvbiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZXJyb3JCYXIpIHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6CiAgICAgIHJldHVybiBlcnJvckJhci5kaXJlY3Rpb24gPT09ICJ4IjsKICAgIGNhc2UgInlBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gInkiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBtYWtlTnVtYmVyKHZhbCkgewogIGlmIChpc051bU9yU3RyKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgRGF0ZSkgewogICAgdmFyIG4gPSBOdW1iZXIodmFsKTsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG4pKSB7CiAgICAgIHJldHVybiBuOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIG1ha2VEb21haW4odmFsKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgdmFyIGF0dGVtcHQgPSBbbWFrZU51bWJlcih2YWxbMF0pLCBtYWtlTnVtYmVyKHZhbFsxXSldOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihhdHRlbXB0KSkgewogICAgICByZXR1cm4gYXR0ZW1wdDsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBuID0gbWFrZU51bWJlcih2YWwpOwogIGlmIChuID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbbiwgbl07Cn0KZnVuY3Rpb24gb25seUFsbG93TnVtYmVycyhkYXRhKSB7CiAgcmV0dXJuIGRhdGEubWFwKG1ha2VOdW1iZXIpLmZpbHRlcihpc05vdE5pbCk7Cn0KZnVuY3Rpb24gZ2V0RXJyb3JEb21haW5CeURhdGFLZXkoZW50cnksIGFwcGxpZWRWYWx1ZSwgcmVsZXZhbnRFcnJvckJhcnMpIHsKICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzIHx8IHR5cGVvZiBhcHBsaWVkVmFsdWUgIT09ICJudW1iZXIiIHx8IGlzTmFuKGFwcGxpZWRWYWx1ZSkpIHsKICAgIHJldHVybiBbXTsKICB9CiAgaWYgKCFyZWxldmFudEVycm9yQmFycy5sZW5ndGgpIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMocmVsZXZhbnRFcnJvckJhcnMuZmxhdE1hcCgoZWIpID0+IHsKICAgIHZhciBlcnJvclZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGViLmRhdGFLZXkpOwogICAgdmFyIGxvd0JvdW5kLCBoaWdoQm91bmQ7CiAgICBpZiAoQXJyYXkuaXNBcnJheShlcnJvclZhbHVlKSkgewogICAgICBbbG93Qm91bmQsIGhpZ2hCb3VuZF0gPSBlcnJvclZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgbG93Qm91bmQgPSBoaWdoQm91bmQgPSBlcnJvclZhbHVlOwogICAgfQogICAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd0JvdW5kKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihoaWdoQm91bmQpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gW2FwcGxpZWRWYWx1ZSAtIGxvd0JvdW5kLCBhcHBsaWVkVmFsdWUgKyBoaWdoQm91bmRdOwogIH0pKTsKfQp2YXIgc2VsZWN0VG9vbHRpcEF4aXMgPSAoc3RhdGUpID0+IHsKICB2YXIgYXhpc1R5cGUgPSBzZWxlY3RUb29sdGlwQXhpc1R5cGUoc3RhdGUpOwogIHZhciBheGlzSWQgPSBzZWxlY3RUb29sdGlwQXhpc0lkKHN0YXRlKTsKICByZXR1cm4gc2VsZWN0QXhpc1NldHRpbmdzKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzKSA9PiBheGlzID09PSBudWxsIHx8IGF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXMuZGF0YUtleSk7CnZhciBzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja2VkQ2FydGVzaWFuSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIGNvbWJpbmVTdGFja0dyb3VwcyA9IChkaXNwbGF5ZWREYXRhLCBpdGVtcywgc3RhY2tPZmZzZXRUeXBlLCByZXZlcnNlU3RhY2tPcmRlcikgPT4gewogIHZhciBpbml0aWFsSXRlbXNHcm91cHMgPSB7fTsKICB2YXIgaXRlbXNHcm91cCA9IGl0ZW1zLnJlZHVjZSgoYWNjLCBpdGVtKSA9PiB7CiAgICBpZiAoaXRlbS5zdGFja0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIGFjYzsKICAgIH0KICAgIGlmIChhY2NbaXRlbS5zdGFja0lkXSA9PSBudWxsKSB7CiAgICAgIGFjY1tpdGVtLnN0YWNrSWRdID0gW107CiAgICB9CiAgICBhY2NbaXRlbS5zdGFja0lkXS5wdXNoKGl0ZW0pOwogICAgcmV0dXJuIGFjYzsKICB9LCBpbml0aWFsSXRlbXNHcm91cHMpOwogIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMoaXRlbXNHcm91cCkubWFwKChfcmVmMikgPT4gewogICAgdmFyIFtzdGFja0lkLCBncmFwaGljYWxJdGVtc10gPSBfcmVmMjsKICAgIHZhciBvcmRlcmVkR3JhcGhpY2FsSXRlbXMgPSByZXZlcnNlU3RhY2tPcmRlciA/IFsuLi5ncmFwaGljYWxJdGVtc10ucmV2ZXJzZSgpIDogZ3JhcGhpY2FsSXRlbXM7CiAgICB2YXIgZGF0YUtleXMgPSBvcmRlcmVkR3JhcGhpY2FsSXRlbXMubWFwKGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcik7CiAgICByZXR1cm4gW3N0YWNrSWQsIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRTdGFja2VkRGF0YSByZXF1aXJlcyB0aGF0IHRoZSBpbnB1dCBpcyBhcnJheSBvZiBvYmplY3RzLCBSZWNoYXJ0cyBkb2VzIG5vdCB0ZXN0IGZvciB0aGF0CiAgICAgIHN0YWNrZWREYXRhOiBnZXRTdGFja2VkRGF0YShkaXNwbGF5ZWREYXRhLCBkYXRhS2V5cywgc3RhY2tPZmZzZXRUeXBlKSwKICAgICAgZ3JhcGhpY2FsSXRlbXM6IG9yZGVyZWRHcmFwaGljYWxJdGVtcwogICAgfV07CiAgfSkpOwp9Owp2YXIgc2VsZWN0U3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkU3RhY2tlZERhdGEsIHNlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIGNvbWJpbmVEb21haW5PZlN0YWNrR3JvdXBzID0gKHN0YWNrR3JvdXBzLCBfcmVmMywgYXhpc1R5cGUsIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSkgPT4gewogIHZhciB7CiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMzsKICBpZiAoZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlICE9IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzVHlwZSA9PT0gInpBeGlzIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGRvbWFpbk9mU3RhY2tHcm91cHMgPSBnZXREb21haW5PZlN0YWNrR3JvdXBzKHN0YWNrR3JvdXBzLCBkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4KTsKICBpZiAoZG9tYWluT2ZTdGFja0dyb3VwcyAhPSBudWxsICYmIGRvbWFpbk9mU3RhY2tHcm91cHNbMF0gPT09IDAgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1sxXSA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGRvbWFpbk9mU3RhY2tHcm91cHM7Cn07CnZhciBzZWxlY3RBbGxvd3NEYXRhT3ZlcmZsb3cgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXNdLCAoYXhpc1NldHRpbmdzKSA9PiBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp2YXIgZ2V0RG9tYWluRGVmaW5pdGlvbiA9IChheGlzU2V0dGluZ3MpID0+IHsKICB2YXIgX2F4aXNTZXR0aW5ncyRkb21haW47CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsIHx8ICEoImRvbWFpbiIgaW4gYXhpc1NldHRpbmdzKSkgewogICAgcmV0dXJuIGRlZmF1bHROdW1lcmljRG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLmRvbWFpbiAhPSBudWxsKSB7CiAgICByZXR1cm4gYXhpc1NldHRpbmdzLmRvbWFpbjsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncy50aWNrcyAhPSBudWxsKSB7CiAgICBpZiAoYXhpc1NldHRpbmdzLnR5cGUgPT09ICJudW1iZXIiKSB7CiAgICAgIHZhciBhbGxWYWx1ZXMgPSBvbmx5QWxsb3dOdW1iZXJzKGF4aXNTZXR0aW5ncy50aWNrcyk7CiAgICAgIHJldHVybiBbTWF0aC5taW4oLi4uYWxsVmFsdWVzKSwgTWF0aC5tYXgoLi4uYWxsVmFsdWVzKV07CiAgICB9CiAgICBpZiAoYXhpc1NldHRpbmdzLnR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgICAgcmV0dXJuIGF4aXNTZXR0aW5ncy50aWNrcy5tYXAoU3RyaW5nKTsKICAgIH0KICB9CiAgcmV0dXJuIChfYXhpc1NldHRpbmdzJGRvbWFpbiA9IGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5kb21haW4pICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZG9tYWluICE9PSB2b2lkIDAgPyBfYXhpc1NldHRpbmdzJGRvbWFpbiA6IGRlZmF1bHROdW1lcmljRG9tYWluOwp9Owp2YXIgc2VsZWN0RG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERvbWFpbkRlZmluaXRpb24sIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvd10sIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKTsKdmFyIHNlbGVjdERvbWFpbk9mU3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0U3RhY2tHcm91cHMsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBwaWNrQXhpc1R5cGUsIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZV0sIGNvbWJpbmVEb21haW5PZlN0YWNrR3JvdXBzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUuZXJyb3JCYXJzOwp2YXIgY29tYmluZVJlbGV2YW50RXJyb3JCYXJTZXR0aW5ncyA9IChjYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBhbGxFcnJvckJhclNldHRpbmdzLCBheGlzVHlwZSkgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLmZsYXRNYXAoKGl0ZW0pID0+IHsKICAgIHJldHVybiBhbGxFcnJvckJhclNldHRpbmdzW2l0ZW0uaWRdOwogIH0pLmZpbHRlcihCb29sZWFuKS5maWx0ZXIoKGUpID0+IHsKICAgIHJldHVybiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZSk7CiAgfSk7Cn07CnZhciBtZXJnZURvbWFpbnMgPSBmdW5jdGlvbiBtZXJnZURvbWFpbnMyKCkgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBkb21haW5zID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgZG9tYWluc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgdmFyIGFsbERvbWFpbnMgPSBkb21haW5zLmZpbHRlcihCb29sZWFuKTsKICBpZiAoYWxsRG9tYWlucy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBhbGxWYWx1ZXMgPSBhbGxEb21haW5zLmZsYXQoKTsKICB2YXIgbWluMiA9IE1hdGgubWluKC4uLmFsbFZhbHVlcyk7CiAgdmFyIG1heDIgPSBNYXRoLm1heCguLi5hbGxWYWx1ZXMpOwogIHJldHVybiBbbWluMiwgbWF4Ml07Cn07CnZhciBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSAoZGF0YSwgYXhpc1NldHRpbmdzLCBpdGVtcywgZXJyb3JCYXJzLCBheGlzVHlwZSkgPT4gewogIHZhciBsb3dlckVuZCwgdXBwZXJFbmQ7CiAgaWYgKGl0ZW1zLmxlbmd0aCA+IDApIHsKICAgIGRhdGEuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgIHZhciBfZXJyb3JCYXJzJGl0ZW0kaWQsIF9heGlzU2V0dGluZ3MkZGF0YUtleTsKICAgICAgICB2YXIgcmVsZXZhbnRFcnJvckJhcnMgPSAoX2Vycm9yQmFycyRpdGVtJGlkID0gZXJyb3JCYXJzW2l0ZW0uaWRdKSA9PT0gbnVsbCB8fCBfZXJyb3JCYXJzJGl0ZW0kaWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lcnJvckJhcnMkaXRlbSRpZC5maWx0ZXIoKGVycm9yQmFyKSA9PiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZXJyb3JCYXIpKTsKICAgICAgICB2YXIgdmFsdWVCeURhdGFLZXkgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgKF9heGlzU2V0dGluZ3MkZGF0YUtleSA9IGF4aXNTZXR0aW5ncy5kYXRhS2V5KSAhPT0gbnVsbCAmJiBfYXhpc1NldHRpbmdzJGRhdGFLZXkgIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZGF0YUtleSA6IGl0ZW0uZGF0YUtleSk7CiAgICAgICAgdmFyIGVycm9yRG9tYWluID0gZ2V0RXJyb3JEb21haW5CeURhdGFLZXkoZW50cnksIHZhbHVlQnlEYXRhS2V5LCByZWxldmFudEVycm9yQmFycyk7CiAgICAgICAgaWYgKGVycm9yRG9tYWluLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICB2YXIgbG9jYWxMb3dlciA9IE1hdGgubWluKC4uLmVycm9yRG9tYWluKTsKICAgICAgICAgIHZhciBsb2NhbFVwcGVyID0gTWF0aC5tYXgoLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgaWYgKGxvd2VyRW5kID09IG51bGwgfHwgbG9jYWxMb3dlciA8IGxvd2VyRW5kKSB7CiAgICAgICAgICAgIGxvd2VyRW5kID0gbG9jYWxMb3dlcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cHBlckVuZCA9PSBudWxsIHx8IGxvY2FsVXBwZXIgPiB1cHBlckVuZCkgewogICAgICAgICAgICB1cHBlckVuZCA9IGxvY2FsVXBwZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkYXRhVmFsdWVEb21haW4gPSBtYWtlRG9tYWluKHZhbHVlQnlEYXRhS2V5KTsKICAgICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGxvd2VyRW5kID0gbG93ZXJFbmQgPT0gbnVsbCA/IGRhdGFWYWx1ZURvbWFpblswXSA6IE1hdGgubWluKGxvd2VyRW5kLCBkYXRhVmFsdWVEb21haW5bMF0pOwogICAgICAgICAgdXBwZXJFbmQgPSB1cHBlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzFdIDogTWF0aC5tYXgodXBwZXJFbmQsIGRhdGFWYWx1ZURvbWFpblsxXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KICBpZiAoKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5kYXRhS2V5KSAhPSBudWxsKSB7CiAgICBkYXRhLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4oZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpKTsKICAgICAgaWYgKGRhdGFWYWx1ZURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgdXBwZXJFbmQgPSB1cHBlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzFdIDogTWF0aC5tYXgodXBwZXJFbmQsIGRhdGFWYWx1ZURvbWFpblsxXSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihsb3dlckVuZCkgJiYgaXNXZWxsQmVoYXZlZE51bWJlcih1cHBlckVuZCkpIHsKICAgIHJldHVybiBbbG93ZXJFbmQsIHVwcGVyRW5kXTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCwgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncywgcGlja0F4aXNUeXBlXSwgY29tYmluZURvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKGl0ZW0pIHsKICB2YXIgewogICAgdmFsdWUKICB9ID0gaXRlbTsKICBpZiAoaXNOdW1PclN0cih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KdmFyIGNvbXB1dGVEb21haW5PZlR5cGVDYXRlZ29yeSA9IChhbGxEYXRhU3F1aXNoZWQsIGF4aXNTZXR0aW5ncywgaXNDYXRlZ29yaWNhbCkgPT4gewogIHZhciBjYXRlZ29yaWNhbERvbWFpbiA9IGFsbERhdGFTcXVpc2hlZC5tYXAob25seUFsbG93TnVtYmVyc0FuZFN0cmluZ3NBbmREYXRlcykuZmlsdGVyKCh2KSA9PiB2ICE9IG51bGwpOwogIGlmIChpc0NhdGVnb3JpY2FsICYmIChheGlzU2V0dGluZ3MuZGF0YUtleSA9PSBudWxsIHx8IGF4aXNTZXR0aW5ncy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSAmJiBoYXNEdXBsaWNhdGUoY2F0ZWdvcmljYWxEb21haW4pKSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfcmFuZ2UyLmRlZmF1bHQpKDAsIGFsbERhdGFTcXVpc2hlZC5sZW5ndGgpOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5KSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW47CiAgfQogIHJldHVybiBBcnJheS5mcm9tKG5ldyBTZXQoY2F0ZWdvcmljYWxEb21haW4pKTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHMgPSAoc3RhdGUpID0+IHN0YXRlLnJlZmVyZW5jZUVsZW1lbnRzLmRvdHM7CnZhciBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyA9IChlbGVtZW50cywgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBlbGVtZW50cy5maWx0ZXIoKGVsKSA9PiBlbC5pZk92ZXJmbG93ID09PSAiZXh0ZW5kRG9tYWluIikuZmlsdGVyKChlbCkgPT4gewogICAgaWYgKGF4aXNUeXBlID09PSAieEF4aXMiKSB7CiAgICAgIHJldHVybiBlbC54QXhpc0lkID09PSBheGlzSWQ7CiAgICB9CiAgICByZXR1cm4gZWwueUF4aXNJZCA9PT0gYXhpc0lkOwogIH0pOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90c0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuYXJlYXM7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXMgPSAoc3RhdGUpID0+IHN0YXRlLnJlZmVyZW5jZUVsZW1lbnRzLmxpbmVzOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNCeUF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIGNvbWJpbmVEb3RzRG9tYWluID0gKGRvdHMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IG9ubHlBbGxvd051bWJlcnMoZG90cy5tYXAoKGRvdCkgPT4gYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBkb3QueCA6IGRvdC55KSk7CiAgaWYgKGFsbENvb3Jkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbTWF0aC5taW4oLi4uYWxsQ29vcmRzKSwgTWF0aC5tYXgoLi4uYWxsQ29vcmRzKV07Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0UmVmZXJlbmNlRG90c0J5QXhpcywgcGlja0F4aXNUeXBlLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBjb21iaW5lQXJlYXNEb21haW4gPSAoYXJlYXMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IG9ubHlBbGxvd051bWJlcnMoYXJlYXMuZmxhdE1hcCgoYXJlYSkgPT4gW2F4aXNUeXBlID09PSAieEF4aXMiID8gYXJlYS54MSA6IGFyZWEueTEsIGF4aXNUeXBlID09PSAieEF4aXMiID8gYXJlYS54MiA6IGFyZWEueTJdKSk7CiAgaWYgKGFsbENvb3Jkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbTWF0aC5taW4oLi4uYWxsQ29vcmRzKSwgTWF0aC5tYXgoLi4uYWxsQ29vcmRzKV07Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5QXhpcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUFyZWFzRG9tYWluKTsKZnVuY3Rpb24gZXh0cmFjdFhDb29yZGluYXRlcyhsaW5lKSB7CiAgdmFyIF9saW5lJHNlZ21lbnQ7CiAgaWYgKGxpbmUueCAhPSBudWxsKSB7CiAgICByZXR1cm4gb25seUFsbG93TnVtYmVycyhbbGluZS54XSk7CiAgfQogIHZhciBzZWdtZW50Q29vcmRpbmF0ZXMgPSAoX2xpbmUkc2VnbWVudCA9IGxpbmUuc2VnbWVudCkgPT09IG51bGwgfHwgX2xpbmUkc2VnbWVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2xpbmUkc2VnbWVudC5tYXAoKHMpID0+IHMueCk7CiAgaWYgKHNlZ21lbnRDb29yZGluYXRlcyA9PSBudWxsIHx8IHNlZ21lbnRDb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoc2VnbWVudENvb3JkaW5hdGVzKTsKfQpmdW5jdGlvbiBleHRyYWN0WUNvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDI7CiAgaWYgKGxpbmUueSAhPSBudWxsKSB7CiAgICByZXR1cm4gb25seUFsbG93TnVtYmVycyhbbGluZS55XSk7CiAgfQogIHZhciBzZWdtZW50Q29vcmRpbmF0ZXMgPSAoX2xpbmUkc2VnbWVudDIgPSBsaW5lLnNlZ21lbnQpID09PSBudWxsIHx8IF9saW5lJHNlZ21lbnQyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Mi5tYXAoKHMpID0+IHMueSk7CiAgaWYgKHNlZ21lbnRDb29yZGluYXRlcyA9PSBudWxsIHx8IHNlZ21lbnRDb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoc2VnbWVudENvb3JkaW5hdGVzKTsKfQp2YXIgY29tYmluZUxpbmVzRG9tYWluID0gKGxpbmVzLCBheGlzVHlwZSkgPT4gewogIHZhciBhbGxDb29yZHMgPSBsaW5lcy5mbGF0TWFwKChsaW5lKSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGV4dHJhY3RYQ29vcmRpbmF0ZXMobGluZSkgOiBleHRyYWN0WUNvb3JkaW5hdGVzKGxpbmUpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lTGluZXNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0UmVmZXJlbmNlQXJlYXNEb21haW4sIChkb3RzRG9tYWluLCBsaW5lc0RvbWFpbiwgYXJlYXNEb21haW4pID0+IHsKICByZXR1cm4gbWVyZ2VEb21haW5zKGRvdHNEb21haW4sIGFyZWFzRG9tYWluLCBsaW5lc0RvbWFpbik7Cn0pOwp2YXIgY29tYmluZU51bWVyaWNhbERvbWFpbiA9IChheGlzU2V0dGluZ3MsIGRvbWFpbkRlZmluaXRpb24sIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgZG9tYWluT2ZTdGFja0dyb3VwcywgZGF0YUFuZEVycm9yQmFyc0RvbWFpbiwgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGxheW91dCwgYXhpc1R5cGUpID0+IHsKICBpZiAoZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlICE9IG51bGwpIHsKICAgIHJldHVybiBkb21haW5Gcm9tVXNlclByZWZlcmVuY2U7CiAgfQogIHZhciBzaG91bGRJbmNsdWRlRG9tYWluT2ZTdGFja0dyb3VwcyA9IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInhBeGlzIiB8fCBsYXlvdXQgPT09ICJob3Jpem9udGFsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIjsKICB2YXIgbWVyZ2VkRG9tYWlucyA9IHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID8gbWVyZ2VEb21haW5zKGRvbWFpbk9mU3RhY2tHcm91cHMsIHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKSA6IG1lcmdlRG9tYWlucyhyZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgZGF0YUFuZEVycm9yQmFyc0RvbWFpbik7CiAgcmV0dXJuIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbihkb21haW5EZWZpbml0aW9uLCBtZXJnZWREb21haW5zLCBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp9Owp2YXIgc2VsZWN0TnVtZXJpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3REb21haW5EZWZpbml0aW9uLCBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UsIHNlbGVjdERvbWFpbk9mU3RhY2tHcm91cHMsIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4sIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBleHBhbmREb21haW4gPSBbMCwgMV07CnZhciBjb21iaW5lQXhpc0RvbWFpbiA9IChheGlzU2V0dGluZ3MsIGxheW91dCwgZGlzcGxheWVkRGF0YSwgYWxsQXBwbGllZFZhbHVlcywgc3RhY2tPZmZzZXRUeXBlLCBheGlzVHlwZSwgbnVtZXJpY2FsRG9tYWluKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhID09IG51bGwgfHwgZGlzcGxheWVkRGF0YS5sZW5ndGggPT09IDApICYmIG51bWVyaWNhbERvbWFpbiA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgZGF0YUtleSwKICAgIHR5cGUKICB9ID0gYXhpc1NldHRpbmdzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgZGF0YUtleSA9PSBudWxsKSB7CiAgICB2YXIgX2Rpc3BsYXllZERhdGEkbGVuZ3RoOwogICAgcmV0dXJuICgwLCBpbXBvcnRfcmFuZ2UyLmRlZmF1bHQpKDAsIChfZGlzcGxheWVkRGF0YSRsZW5ndGggPSBkaXNwbGF5ZWREYXRhID09PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRpc3BsYXllZERhdGEubGVuZ3RoKSAhPT0gbnVsbCAmJiBfZGlzcGxheWVkRGF0YSRsZW5ndGggIT09IHZvaWQgMCA/IF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA6IDApOwogIH0KICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgcmV0dXJuIGNvbXB1dGVEb21haW5PZlR5cGVDYXRlZ29yeShhbGxBcHBsaWVkVmFsdWVzLCBheGlzU2V0dGluZ3MsIGlzQ2F0ZWdvcmljYWwpOwogIH0KICBpZiAoc3RhY2tPZmZzZXRUeXBlID09PSAiZXhwYW5kIikgewogICAgcmV0dXJuIGV4cGFuZERvbWFpbjsKICB9CiAgcmV0dXJuIG51bWVyaWNhbERvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3REaXNwbGF5ZWREYXRhLCBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHBpY2tBeGlzVHlwZSwgc2VsZWN0TnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgY29tYmluZVJlYWxTY2FsZVR5cGUgPSAoYXhpc0NvbmZpZywgbGF5b3V0LCBoYXNCYXIsIGNoYXJ0VHlwZSwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpc0NvbmZpZyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgc2NhbGUsCiAgICB0eXBlCiAgfSA9IGF4aXNDb25maWc7CiAgaWYgKHNjYWxlID09PSAiYXV0byIpIHsKICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIikgewogICAgICByZXR1cm4gImxpbmVhciI7CiAgICB9CiAgICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IiAmJiBjaGFydFR5cGUgJiYgKGNoYXJ0VHlwZS5pbmRleE9mKCJMaW5lQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJBcmVhQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJDb21wb3NlZENoYXJ0IikgPj0gMCAmJiAhaGFzQmFyKSkgewogICAgICByZXR1cm4gInBvaW50IjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICAgIHJldHVybiAiYmFuZCI7CiAgICB9CiAgICByZXR1cm4gImxpbmVhciI7CiAgfQogIGlmICh0eXBlb2Ygc2NhbGUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgbmFtZSA9ICJzY2FsZSIuY29uY2F0KHVwcGVyRmlyc3Qoc2NhbGUpKTsKICAgIHJldHVybiBuYW1lIGluIGQzX3NjYWxlX2V4cG9ydHMgPyBuYW1lIDogInBvaW50IjsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdFJlYWxTY2FsZVR5cGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RIYXNCYXIsIHNlbGVjdENoYXJ0TmFtZSwgcGlja0F4aXNUeXBlXSwgY29tYmluZVJlYWxTY2FsZVR5cGUpOwpmdW5jdGlvbiBnZXREM1NjYWxlRnJvbVR5cGUocmVhbFNjYWxlVHlwZSkgewogIGlmIChyZWFsU2NhbGVUeXBlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChyZWFsU2NhbGVUeXBlIGluIGQzX3NjYWxlX2V4cG9ydHMpIHsKICAgIHJldHVybiBkM19zY2FsZV9leHBvcnRzW3JlYWxTY2FsZVR5cGVdKCk7CiAgfQogIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChyZWFsU2NhbGVUeXBlKSk7CiAgaWYgKG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbbmFtZV0oKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBjb21iaW5lU2NhbGVGdW5jdGlvbihheGlzLCByZWFsU2NhbGVUeXBlLCBheGlzRG9tYWluLCBheGlzUmFuZ2UpIHsKICBpZiAoYXhpc0RvbWFpbiA9PSBudWxsIHx8IGF4aXNSYW5nZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGF4aXMuc2NhbGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBheGlzLnNjYWxlLmNvcHkoKS5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICB9CiAgdmFyIGQzU2NhbGVGdW5jdGlvbiA9IGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKTsKICBpZiAoZDNTY2FsZUZ1bmN0aW9uID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzY2FsZSA9IGQzU2NhbGVGdW5jdGlvbi5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICBjaGVja0RvbWFpbk9mU2NhbGUoc2NhbGUpOwogIHJldHVybiBzY2FsZTsKfQp2YXIgY29tYmluZU5pY2VUaWNrcyA9IChheGlzRG9tYWluLCBheGlzU2V0dGluZ3MsIHJlYWxTY2FsZVR5cGUpID0+IHsKICB2YXIgZG9tYWluRGVmaW5pdGlvbiA9IGdldERvbWFpbkRlZmluaXRpb24oYXhpc1NldHRpbmdzKTsKICBpZiAocmVhbFNjYWxlVHlwZSAhPT0gImF1dG8iICYmIHJlYWxTY2FsZVR5cGUgIT09ICJsaW5lYXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9IG51bGwgJiYgYXhpc1NldHRpbmdzLnRpY2tDb3VudCAmJiBBcnJheS5pc0FycmF5KGRvbWFpbkRlZmluaXRpb24pICYmIChkb21haW5EZWZpbml0aW9uWzBdID09PSAiYXV0byIgfHwgZG9tYWluRGVmaW5pdGlvblsxXSA9PT0gImF1dG8iKSAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXROaWNlVGlja1ZhbHVlcyhheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIGF4aXNTZXR0aW5ncy50eXBlID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4oYXhpc0RvbWFpbiwgYXhpc1NldHRpbmdzLnRpY2tDb3VudCwgYXhpc1NldHRpbmdzLmFsbG93RGVjaW1hbHMpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0TmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEF4aXNEb21haW4sIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzID0gKGF4aXNTZXR0aW5ncywgZG9tYWluLCBuaWNlVGlja3MsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKAogICAgLyoKICAgICAqIEFuZ2xlIGF4aXMgZm9yIHNvbWUgcmVhc29uIHVzZXMgbmljZSB0aWNrcyB3aGVuIHJlbmRlcmluZyBheGlzIHRpY2sgbGFiZWxzLAogICAgICogYnV0IGRvZXNuJ3QgdXNlIG5pY2UgdGlja3MgZm9yIGV4dGVuZGluZyBkb21haW4gbGlrZSBhbGwgdGhlIG90aGVyIGF4ZXMgZG8uCiAgICAgKiBOb3QgcmVhbGx5IHN1cmUgd2h5PyBJcyB0aGVyZSBhIGdvb2QgcmVhc29uLAogICAgICogb3IgaXMgaXQganVzdCBiZWNhdXNlIHNvbWVvbmUgYWRkZWQgc3VwcG9ydCBmb3IgbmljZSB0aWNrcyB0byB0aGUgb3RoZXIgYXhlcyBhbmQgZm9yZ290IHRoaXMgb25lPwogICAgICovCiAgICBheGlzVHlwZSAhPT0gImFuZ2xlQXhpcyIgJiYgKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy50eXBlKSA9PT0gIm51bWJlciIgJiYgaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGRvbWFpbikgJiYgQXJyYXkuaXNBcnJheShuaWNlVGlja3MpICYmIG5pY2VUaWNrcy5sZW5ndGggPiAwCiAgKSB7CiAgICB2YXIgbWluRnJvbURvbWFpbiA9IGRvbWFpblswXTsKICAgIHZhciBtaW5Gcm9tVGlja3MgPSBuaWNlVGlja3NbMF07CiAgICB2YXIgbWF4RnJvbURvbWFpbiA9IGRvbWFpblsxXTsKICAgIHZhciBtYXhGcm9tVGlja3MgPSBuaWNlVGlja3NbbmljZVRpY2tzLmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIFtNYXRoLm1pbihtaW5Gcm9tRG9tYWluLCBtaW5Gcm9tVGlja3MpLCBNYXRoLm1heChtYXhGcm9tRG9tYWluLCBtYXhGcm9tVGlja3MpXTsKICB9CiAgcmV0dXJuIGRvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNEb21haW4sIHNlbGVjdE5pY2VUaWNrcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzKTsKdmFyIHNlbGVjdFNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIChhbGxEYXRhU3F1aXNoZWQsIGF4aXNTZXR0aW5ncykgPT4gewogIGlmICghYXhpc1NldHRpbmdzIHx8IGF4aXNTZXR0aW5ncy50eXBlICE9PSAibnVtYmVyIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gSW5maW5pdHk7CiAgdmFyIHNvcnRlZFZhbHVlcyA9IEFycmF5LmZyb20ob25seUFsbG93TnVtYmVycyhhbGxEYXRhU3F1aXNoZWQubWFwKChkKSA9PiBkLnZhbHVlKSkpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICBpZiAoc29ydGVkVmFsdWVzLmxlbmd0aCA8IDIpIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgdmFyIGRpZmYgPSBzb3J0ZWRWYWx1ZXNbc29ydGVkVmFsdWVzLmxlbmd0aCAtIDFdIC0gc29ydGVkVmFsdWVzWzBdOwogIGlmIChkaWZmID09PSAwKSB7CiAgICByZXR1cm4gSW5maW5pdHk7CiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkVmFsdWVzLmxlbmd0aCAtIDE7IGkrKykgewogICAgdmFyIGRpc3RhbmNlID0gc29ydGVkVmFsdWVzW2kgKyAxXSAtIHNvcnRlZFZhbHVlc1tpXTsKICAgIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gTWF0aC5taW4oc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIGRpc3RhbmNlKTsKICB9CiAgcmV0dXJuIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzIC8gZGlmZjsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QmFyQ2F0ZWdvcnlHYXAsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChfMSwgXzIsIF8zLCBwYWRkaW5nKSA9PiBwYWRkaW5nLCAoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCwgbGF5b3V0LCBiYXJDYXRlZ29yeUdhcCwgb2Zmc2V0LCBwYWRkaW5nKSA9PiB7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQpKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHJhbmdlV2lkdGggPSBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgPyBvZmZzZXQuaGVpZ2h0IDogb2Zmc2V0LndpZHRoOwogIGlmIChwYWRkaW5nID09PSAiZ2FwIikgewogICAgcmV0dXJuIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICB9CiAgaWYgKHBhZGRpbmcgPT09ICJuby1nYXAiKSB7CiAgICB2YXIgZ2FwID0gZ2V0UGVyY2VudFZhbHVlKGJhckNhdGVnb3J5R2FwLCBzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50ICogcmFuZ2VXaWR0aCk7CiAgICB2YXIgaGFsZkJhbmQgPSBzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50ICogcmFuZ2VXaWR0aCAvIDI7CiAgICByZXR1cm4gaGFsZkJhbmQgLSBnYXAgLSAoaGFsZkJhbmQgLSBnYXApIC8gcmFuZ2VXaWR0aCAqIGdhcDsKICB9CiAgcmV0dXJuIDA7Cn0pOwp2YXIgc2VsZWN0Q2FsY3VsYXRlZFhBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHhBeGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHhBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ4QXhpcyIsIGF4aXNJZCwgeEF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciB5QXhpc1NldHRpbmdzID0gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoeUF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IHR5cGVvZiB5QXhpc1NldHRpbmdzLnBhZGRpbmcgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gMDsKICB9CiAgcmV0dXJuIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nKHN0YXRlLCAieUF4aXMiLCBheGlzSWQsIHlBeGlzU2V0dGluZ3MucGFkZGluZyk7Cn07CnZhciBzZWxlY3RYQXhpc1BhZGRpbmcgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RYQXhpc1NldHRpbmdzLCBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nLCAoeEF4aXNTZXR0aW5ncywgY2FsY3VsYXRlZCkgPT4gewogIHZhciBfcGFkZGluZyRsZWZ0LCBfcGFkZGluZyRyaWdodDsKICBpZiAoeEF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMAogICAgfTsKICB9CiAgdmFyIHsKICAgIHBhZGRpbmcKICB9ID0geEF4aXNTZXR0aW5nczsKICBpZiAodHlwZW9mIHBhZGRpbmcgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gewogICAgICBsZWZ0OiBjYWxjdWxhdGVkLAogICAgICByaWdodDogY2FsY3VsYXRlZAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGxlZnQ6ICgoX3BhZGRpbmckbGVmdCA9IHBhZGRpbmcubGVmdCkgIT09IG51bGwgJiYgX3BhZGRpbmckbGVmdCAhPT0gdm9pZCAwID8gX3BhZGRpbmckbGVmdCA6IDApICsgY2FsY3VsYXRlZCwKICAgIHJpZ2h0OiAoKF9wYWRkaW5nJHJpZ2h0ID0gcGFkZGluZy5yaWdodCkgIT09IG51bGwgJiYgX3BhZGRpbmckcmlnaHQgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHJpZ2h0IDogMCkgKyBjYWxjdWxhdGVkCiAgfTsKfSk7CnZhciBzZWxlY3RZQXhpc1BhZGRpbmcgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RZQXhpc1NldHRpbmdzLCBzZWxlY3RDYWxjdWxhdGVkWUF4aXNQYWRkaW5nLCAoeUF4aXNTZXR0aW5ncywgY2FsY3VsYXRlZCkgPT4gewogIHZhciBfcGFkZGluZyR0b3AsIF9wYWRkaW5nJGJvdHRvbTsKICBpZiAoeUF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICB0b3A6IDAsCiAgICAgIGJvdHRvbTogMAogICAgfTsKICB9CiAgdmFyIHsKICAgIHBhZGRpbmcKICB9ID0geUF4aXNTZXR0aW5nczsKICBpZiAodHlwZW9mIHBhZGRpbmcgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gewogICAgICB0b3A6IGNhbGN1bGF0ZWQsCiAgICAgIGJvdHRvbTogY2FsY3VsYXRlZAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHRvcDogKChfcGFkZGluZyR0b3AgPSBwYWRkaW5nLnRvcCkgIT09IG51bGwgJiYgX3BhZGRpbmckdG9wICE9PSB2b2lkIDAgPyBfcGFkZGluZyR0b3AgOiAwKSArIGNhbGN1bGF0ZWQsCiAgICBib3R0b206ICgoX3BhZGRpbmckYm90dG9tID0gcGFkZGluZy5ib3R0b20pICE9PSBudWxsICYmIF9wYWRkaW5nJGJvdHRvbSAhPT0gdm9pZCAwID8gX3BhZGRpbmckYm90dG9tIDogMCkgKyBjYWxjdWxhdGVkCiAgfTsKfSk7CnZhciBjb21iaW5lWEF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1BhZGRpbmcsIHNlbGVjdEJydXNoRGltZW5zaW9ucywgc2VsZWN0QnJ1c2hTZXR0aW5ncywgKF9zdGF0ZSwgX2F4aXNJZCwgaXNQYW5vcmFtYSkgPT4gaXNQYW5vcmFtYV0sIChvZmZzZXQsIHBhZGRpbmcsIGJydXNoRGltZW5zaW9ucywgX3JlZjQsIGlzUGFub3JhbWEpID0+IHsKICB2YXIgewogICAgcGFkZGluZzogYnJ1c2hQYWRkaW5nCiAgfSA9IF9yZWY0OwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gW2JydXNoUGFkZGluZy5sZWZ0LCBicnVzaERpbWVuc2lvbnMud2lkdGggLSBicnVzaFBhZGRpbmcucmlnaHRdOwogIH0KICByZXR1cm4gW29mZnNldC5sZWZ0ICsgcGFkZGluZy5sZWZ0LCBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAtIHBhZGRpbmcucmlnaHRdOwp9KTsKdmFyIGNvbWJpbmVZQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RZQXhpc1BhZGRpbmcsIHNlbGVjdEJydXNoRGltZW5zaW9ucywgc2VsZWN0QnJ1c2hTZXR0aW5ncywgKF9zdGF0ZSwgX2F4aXNJZCwgaXNQYW5vcmFtYSkgPT4gaXNQYW5vcmFtYV0sIChvZmZzZXQsIGxheW91dCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNSwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjU7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hEaW1lbnNpb25zLmhlaWdodCAtIGJydXNoUGFkZGluZy5ib3R0b20sIGJydXNoUGFkZGluZy50b3BdOwogIH0KICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiBbb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbSwgb2Zmc2V0LnRvcCArIHBhZGRpbmcudG9wXTsKICB9CiAgcmV0dXJuIFtvZmZzZXQudG9wICsgcGFkZGluZy50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0IC0gcGFkZGluZy5ib3R0b21dOwp9KTsKdmFyIHNlbGVjdEF4aXNSYW5nZSA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciBfc2VsZWN0WkF4aXNTZXR0aW5nczsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6CiAgICAgIHJldHVybiBjb21iaW5lWEF4aXNSYW5nZShzdGF0ZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKTsKICAgIGNhc2UgInlBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVZQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAiekF4aXMiOgogICAgICByZXR1cm4gKF9zZWxlY3RaQXhpc1NldHRpbmdzID0gc2VsZWN0WkF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKSkgPT09IG51bGwgfHwgX3NlbGVjdFpBeGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9zZWxlY3RaQXhpc1NldHRpbmdzLnJhbmdlOwogICAgY2FzZSAiYW5nbGVBeGlzIjoKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpc1JhbmdlKHN0YXRlKTsKICAgIGNhc2UgInJhZGl1c0F4aXMiOgogICAgICByZXR1cm4gc2VsZWN0UmFkaXVzQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQpOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHZvaWQgMDsKICB9Cn07CnZhciBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RFcnJvckJhcnNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzKTsKZnVuY3Rpb24gY29tcGFyZUlkcyhhLCBiKSB7CiAgaWYgKGEuaWQgPCBiLmlkKSB7CiAgICByZXR1cm4gLTE7CiAgfQogIGlmIChhLmlkID4gYi5pZCkgewogICAgcmV0dXJuIDE7CiAgfQogIHJldHVybiAwOwp9CnZhciBwaWNrQXhpc09yaWVudGF0aW9uID0gKF9zdGF0ZSwgb3JpZW50YXRpb24pID0+IG9yaWVudGF0aW9uOwp2YXIgcGlja01pcnJvciA9IChfc3RhdGUsIF9vcmllbnRhdGlvbiwgbWlycm9yKSA9PiBtaXJyb3I7CnZhciBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsWEF4ZXMsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChhbGxBeGVzLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiBhbGxBeGVzLmZpbHRlcigoYXhpcykgPT4gYXhpcy5vcmllbnRhdGlvbiA9PT0gb3JpZW50YXRpb24pLmZpbHRlcigoYXhpcykgPT4gYXhpcy5taXJyb3IgPT09IG1pcnJvcikuc29ydChjb21wYXJlSWRzKSk7CnZhciBzZWxlY3RBbGxZQXhlc1dpdGhPZmZzZXRUeXBlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsWUF4ZXMsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChhbGxBeGVzLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiBhbGxBeGVzLmZpbHRlcigoYXhpcykgPT4gYXhpcy5vcmllbnRhdGlvbiA9PT0gb3JpZW50YXRpb24pLmZpbHRlcigoYXhpcykgPT4gYXhpcy5taXJyb3IgPT09IG1pcnJvcikuc29ydChjb21wYXJlSWRzKSk7CnZhciBnZXRYQXhpc1NpemUgPSAob2Zmc2V0LCBheGlzU2V0dGluZ3MpID0+IHsKICByZXR1cm4gewogICAgd2lkdGg6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogYXhpc1NldHRpbmdzLmhlaWdodAogIH07Cn07CnZhciBnZXRZQXhpc1NpemUgPSAob2Zmc2V0LCBheGlzU2V0dGluZ3MpID0+IHsKICB2YXIgd2lkdGggPSB0eXBlb2YgYXhpc1NldHRpbmdzLndpZHRoID09PSAibnVtYmVyIiA/IGF4aXNTZXR0aW5ncy53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogIHJldHVybiB7CiAgICB3aWR0aCwKICAgIGhlaWdodDogb2Zmc2V0LmhlaWdodAogIH07Cn07CnZhciBzZWxlY3RYQXhpc1NpemUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1NldHRpbmdzLCBnZXRYQXhpc1NpemUpOwp2YXIgY29tYmluZVhBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50ID0gKG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAidG9wIjoKICAgICAgcmV0dXJuIG9mZnNldC50b3A7CiAgICBjYXNlICJib3R0b20iOgogICAgICByZXR1cm4gY2hhcnRIZWlnaHQgLSBvZmZzZXQuYm90dG9tOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50ID0gKG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgcmV0dXJuIG9mZnNldC5sZWZ0OwogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gY2hhcnRXaWR0aCAtIG9mZnNldC5yaWdodDsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAwOwogIH0KfTsKdmFyIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0QWxsWEF4ZXNXaXRoT2Zmc2V0VHlwZSwgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGNoYXJ0SGVpZ2h0LCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRYQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVhBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0SGVpZ2h0KTsKICAgIH0KICAgIHZhciBuZWVkU3BhY2UgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgJiYgbWlycm9yOwogICAgc3RlcHNbYXhpcy5pZF0gPSBwb3NpdGlvbiAtIE51bWJlcihuZWVkU3BhY2UpICogYXhpc1NpemUuaGVpZ2h0OwogICAgcG9zaXRpb24gKz0gKG5lZWRTcGFjZSA/IC0xIDogMSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdEFsbFlBeGVzT2Zmc2V0U3RlcHMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxZQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRXaWR0aCwgb2Zmc2V0LCBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiB7CiAgdmFyIHN0ZXBzID0ge307CiAgdmFyIHBvc2l0aW9uOwogIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUuZm9yRWFjaCgoYXhpcykgPT4gewogICAgdmFyIGF4aXNTaXplID0gZ2V0WUF4aXNTaXplKG9mZnNldCwgYXhpcyk7CiAgICBpZiAocG9zaXRpb24gPT0gbnVsbCkgewogICAgICBwb3NpdGlvbiA9IGNvbWJpbmVZQXhpc1Bvc2l0aW9uU3RhcnRpbmdQb2ludChvZmZzZXQsIG9yaWVudGF0aW9uLCBjaGFydFdpZHRoKTsKICAgIH0KICAgIHZhciBuZWVkU3BhY2UgPSBvcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgbWlycm9yOwogICAgc3RlcHNbYXhpcy5pZF0gPSBwb3NpdGlvbiAtIE51bWJlcihuZWVkU3BhY2UpICogYXhpc1NpemUud2lkdGg7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLndpZHRoOwogIH0pOwogIHJldHVybiBzdGVwczsKfSk7CnZhciBzZWxlY3RYQXhpc09mZnNldFN0ZXBzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpc1NldHRpbmdzID0gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBzZWxlY3RBbGxYQXhlc09mZnNldFN0ZXBzKHN0YXRlLCBheGlzU2V0dGluZ3Mub3JpZW50YXRpb24sIGF4aXNTZXR0aW5ncy5taXJyb3IpOwp9Owp2YXIgc2VsZWN0WEF4aXNQb3NpdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1NldHRpbmdzLCBzZWxlY3RYQXhpc09mZnNldFN0ZXBzLCAoXywgYXhpc0lkKSA9PiBheGlzSWRdLCAob2Zmc2V0LCBheGlzU2V0dGluZ3MsIGFsbFN0ZXBzLCBheGlzSWQpID0+IHsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzdGVwT2ZUaGlzQXhpcyA9IGFsbFN0ZXBzID09PSBudWxsIHx8IGFsbFN0ZXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxTdGVwc1theGlzSWRdOwogIGlmIChzdGVwT2ZUaGlzQXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICB4OiBvZmZzZXQubGVmdCwKICAgICAgeTogMAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IG9mZnNldC5sZWZ0LAogICAgeTogc3RlcE9mVGhpc0F4aXMKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFlBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RZQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdFlBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IG9mZnNldC50b3AKICAgIH07CiAgfQogIHJldHVybiB7CiAgICB4OiBzdGVwT2ZUaGlzQXhpcywKICAgIHk6IG9mZnNldC50b3AKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFlBeGlzU2V0dGluZ3MsIChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfSk7CnZhciBjb21iaW5lRHVwbGljYXRlRG9tYWluID0gKGNoYXJ0TGF5b3V0LCBhcHBsaWVkVmFsdWVzLCBheGlzLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIHR5cGUsCiAgICBkYXRhS2V5CiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhjaGFydExheW91dCwgYXhpc1R5cGUpOwogIHZhciBhbGxEYXRhID0gYXBwbGllZFZhbHVlcy5tYXAoKGF2KSA9PiBhdi52YWx1ZSk7CiAgaWYgKGRhdGFLZXkgJiYgaXNDYXRlZ29yaWNhbCAmJiB0eXBlID09PSAiY2F0ZWdvcnkiICYmIGFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShhbGxEYXRhKSkgewogICAgcmV0dXJuIGFsbERhdGE7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3REdXBsaWNhdGVEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdEJhc2VBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIGNvbWJpbmVDYXRlZ29yaWNhbERvbWFpbiA9IChsYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBheGlzLmRhdGFLZXkgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHR5cGUsCiAgICBzY2FsZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKHR5cGUgPT09ICJudW1iZXIiIHx8IHNjYWxlICE9PSAiYXV0byIpKSB7CiAgICByZXR1cm4gYXBwbGllZFZhbHVlcy5tYXAoKGQpID0+IGQudmFsdWUpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdEF4aXNTZXR0aW5ncywgcGlja0F4aXNUeXBlXSwgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluKTsKdmFyIHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvciA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2FydGVzaWFuQXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4sIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0TmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1JhbmdlLCBuaWNlVGlja3MsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICByZXR1cm4gewogICAgYW5nbGU6IGF4aXMuYW5nbGUsCiAgICBpbnRlcnZhbDogYXhpcy5pbnRlcnZhbCwKICAgIG1pblRpY2tHYXA6IGF4aXMubWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uOiBheGlzLm9yaWVudGF0aW9uLAogICAgdGljazogYXhpcy50aWNrLAogICAgdGlja0NvdW50OiBheGlzLnRpY2tDb3VudCwKICAgIHRpY2tGb3JtYXR0ZXI6IGF4aXMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tzOiBheGlzLnRpY2tzLAogICAgdHlwZTogYXhpcy50eXBlLAogICAgdW5pdDogYXhpcy51bml0LAogICAgYXhpc1R5cGUsCiAgICBjYXRlZ29yaWNhbERvbWFpbiwKICAgIGR1cGxpY2F0ZURvbWFpbiwKICAgIGlzQ2F0ZWdvcmljYWwsCiAgICBuaWNlVGlja3MsCiAgICByYW5nZTogYXhpc1JhbmdlLAogICAgcmVhbFNjYWxlVHlwZSwKICAgIHNjYWxlCiAgfTsKfSk7CnZhciBjb21iaW5lQXhpc1RpY2tzID0gKGxheW91dCwgYXhpcywgcmVhbFNjYWxlVHlwZSwgc2NhbGUsIG5pY2VUaWNrcywgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdHlwZSwKICAgIHRpY2tzOiB0aWNrczIsCiAgICB0aWNrQ291bnQKICB9ID0gYXhpczsKICB2YXIgb2Zmc2V0Rm9yQmFuZCA9IHJlYWxTY2FsZVR5cGUgPT09ICJzY2FsZUJhbmQiICYmIHR5cGVvZiBzY2FsZS5iYW5kd2lkdGggPT09ICJmdW5jdGlvbiIgPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIGF4aXNSYW5nZSAhPSBudWxsICYmIGF4aXNSYW5nZS5sZW5ndGggPj0gMiA/IG1hdGhTaWduKGF4aXNSYW5nZVswXSAtIGF4aXNSYW5nZVsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIHZhciB0aWNrc09yTmljZVRpY2tzID0gdGlja3MyIHx8IG5pY2VUaWNrczsKICBpZiAodGlja3NPck5pY2VUaWNrcykgewogICAgdmFyIHJlc3VsdCA9IHRpY2tzT3JOaWNlVGlja3MubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHNjYWxlQ29udGVudCA9IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbi5pbmRleE9mKGVudHJ5KSA6IGVudHJ5OwogICAgICByZXR1cm4gewogICAgICAgIGluZGV4LAogICAgICAgIC8vIElmIHRoZSBzY2FsZUNvbnRlbnQgaXMgbm90IGEgbnVtYmVyLCB0aGUgY29vcmRpbmF0ZSB3aWxsIGJlIE5hTi4KICAgICAgICAvLyBUaGF0IGNvdWxkIGJlIHRoZSBjYXNlIGZvciBleGFtcGxlIHdpdGggYSBQb2ludFNjYWxlIGFuZCBhIHN0cmluZyBhcyBkb21haW4uCiAgICAgICAgY29vcmRpbmF0ZTogc2NhbGUoc2NhbGVDb250ZW50KSArIG9mZnNldCwKICAgICAgICB2YWx1ZTogZW50cnksCiAgICAgICAgb2Zmc2V0CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuZmlsdGVyKChyb3cpID0+IGlzV2VsbEJlaGF2ZWROdW1iZXIocm93LmNvb3JkaW5hdGUpKTsKICB9CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKS5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnkpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VGlja3NPZkF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc1NjYWxlLCBzZWxlY3ROaWNlVGlja3MsIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgcGlja0F4aXNUeXBlXSwgY29tYmluZUF4aXNUaWNrcyk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzID0gKGxheW91dCwgYXhpcywgc2NhbGUsIGF4aXNSYW5nZSwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwgfHwgYXhpc1JhbmdlID09IG51bGwgfHwgYXhpc1JhbmdlWzBdID09PSBheGlzUmFuZ2VbMV0pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIHsKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXQgPSAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiAoYXhpc1JhbmdlID09PSBudWxsIHx8IGF4aXNSYW5nZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1JhbmdlLmxlbmd0aCkgPj0gMiA/IG1hdGhTaWduKGF4aXNSYW5nZVswXSAtIGF4aXNSYW5nZVsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgcGlja0F4aXNUeXBlXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1UaWNrcyk7CnZhciBzZWxlY3RBeGlzV2l0aFNjYWxlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNTY2FsZSwgKGF4aXMsIHNjYWxlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDEzKF9vYmplY3RTcHJlYWQxMyh7fSwgYXhpcyksIHt9LCB7CiAgICBzY2FsZQogIH0pOwp9KTsKdmFyIHNlbGVjdFpBeGlzU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNEb21haW4sIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0WkF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUsIF9heGlzVHlwZSwgYXhpc0lkKSA9PiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpLCBzZWxlY3RaQXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0Q2hhcnREaXJlY3Rpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFhBeGVzLCBzZWxlY3RBbGxZQXhlc10sIChsYXlvdXQsIGFsbFhBeGVzLCBhbGxZQXhlcykgPT4gewogIHN3aXRjaCAobGF5b3V0KSB7CiAgICBjYXNlICJob3Jpem9udGFsIjogewogICAgICByZXR1cm4gYWxsWEF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAicmlnaHQtdG8tbGVmdCIgOiAibGVmdC10by1yaWdodCI7CiAgICB9CiAgICBjYXNlICJ2ZXJ0aWNhbCI6IHsKICAgICAgcmV0dXJuIGFsbFlBeGVzLnNvbWUoKGF4aXMpID0+IGF4aXMucmV2ZXJzZWQpID8gImJvdHRvbS10by10b3AiIDogInRvcC10by1ib3R0b20iOwogICAgfQogICAgY2FzZSAiY2VudHJpYyI6CiAgICBjYXNlICJyYWRpYWwiOiB7CiAgICAgIHJldHVybiAibGVmdC10by1yaWdodCI7CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBFdmVudFR5cGUuanMKdmFyIHNlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwp2YXIgc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy52YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOwpmdW5jdGlvbiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKSB7CiAgaWYgKHNoYXJlZCA9PSBudWxsKSB7CiAgICByZXR1cm4gZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CiAgfQogIHZhciBldmVudFR5cGUgPSBzaGFyZWQgPyAiYXhpcyIgOiAiaXRlbSI7CiAgaWYgKHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwogIH0KICByZXR1cm4gdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcy5pbmNsdWRlcyhldmVudFR5cGUpID8gZXZlbnRUeXBlIDogZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7Cn0KZnVuY3Rpb24gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSB7CiAgdmFyIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUpOwogIHZhciB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID0gc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyhzdGF0ZSk7CiAgcmV0dXJuIGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMpOwp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKSB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lQWN0aXZlTGFiZWwuanMKdmFyIGNvbWJpbmVBY3RpdmVMYWJlbCA9ICh0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4KSA9PiB7CiAgdmFyIF90b29sdGlwVGlja3MkbjsKICB2YXIgbiA9IE51bWJlcihhY3RpdmVJbmRleCk7CiAgaWYgKGlzTmFuKG4pIHx8IGFjdGl2ZUluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBuID49IDAgPyB0b29sdGlwVGlja3MgPT09IG51bGwgfHwgdG9vbHRpcFRpY2tzID09PSB2b2lkIDAgfHwgKF90b29sdGlwVGlja3MkbiA9IHRvb2x0aXBUaWNrc1tuXSkgPT09IG51bGwgfHwgX3Rvb2x0aXBUaWNrcyRuID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdG9vbHRpcFRpY2tzJG4udmFsdWUgOiB2b2lkIDA7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwU2V0dGluZ3MuanMKdmFyIHNlbGVjdFRvb2x0aXBTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5nczsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG9vbHRpcFNsaWNlLmpzCnZhciBub0ludGVyYWN0aW9uID0gewogIGFjdGl2ZTogZmFsc2UsCiAgaW5kZXg6IG51bGwsCiAgZGF0YUtleTogdm9pZCAwLAogIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwLAogIGNvb3JkaW5hdGU6IHZvaWQgMAp9Owp2YXIgaW5pdGlhbFN0YXRlMyA9IHsKICBpdGVtSW50ZXJhY3Rpb246IHsKICAgIGNsaWNrOiBub0ludGVyYWN0aW9uLAogICAgaG92ZXI6IG5vSW50ZXJhY3Rpb24KICB9LAogIGF4aXNJbnRlcmFjdGlvbjogewogICAgY2xpY2s6IG5vSW50ZXJhY3Rpb24sCiAgICBob3Zlcjogbm9JbnRlcmFjdGlvbgogIH0sCiAga2V5Ym9hcmRJbnRlcmFjdGlvbjogbm9JbnRlcmFjdGlvbiwKICBzeW5jSW50ZXJhY3Rpb246IHsKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBpbmRleDogbnVsbCwKICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgIGxhYmVsOiB2b2lkIDAsCiAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICBzb3VyY2VWaWV3Qm94OiB2b2lkIDAsCiAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogIH0sCiAgdG9vbHRpcEl0ZW1QYXlsb2FkczogW10sCiAgc2V0dGluZ3M6IHsKICAgIHNoYXJlZDogdm9pZCAwLAogICAgdHJpZ2dlcjogImhvdmVyIiwKICAgIGF4aXNJZDogMCwKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBkZWZhdWx0SW5kZXg6IHZvaWQgMAogIH0KfTsKdmFyIHRvb2x0aXBTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAidG9vbHRpcCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUzLAogIHJlZHVjZXJzOiB7CiAgICBhZGRUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS50b29sdGlwSXRlbVBheWxvYWRzLmluZGV4T2YoY2FzdERyYWZ0KHByZXYpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnRvb2x0aXBJdGVtUGF5bG9hZHMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNldHRpbmdzID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmdyYXBoaWNhbEl0ZW1JZCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIG1vdXNlTGVhdmVDaGFydChzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgIH0sCiAgICBtb3VzZUxlYXZlSXRlbShzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICB9LAogICAgc2V0QWN0aXZlQ2xpY2tJdGVtSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZ3JhcGhpY2FsSXRlbUlkID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlR3JhcGhpY2FsSXRlbUlkOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0TW91c2VPdmVyQXhpc0luZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0U3luY0ludGVyYWN0aW9uKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRUb29sdGlwRW50cnlTZXR0aW5ncywKICByZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgcmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUsCiAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4LAogIG1vdXNlTGVhdmVJdGVtLAogIG1vdXNlTGVhdmVDaGFydCwKICBzZXRBY3RpdmVDbGlja0l0ZW1JbmRleCwKICBzZXRNb3VzZU92ZXJBeGlzSW5kZXgsCiAgc2V0TW91c2VDbGlja0F4aXNJbmRleCwKICBzZXRTeW5jSW50ZXJhY3Rpb24sCiAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbgp9ID0gdG9vbHRpcFNsaWNlLmFjdGlvbnM7CnZhciB0b29sdGlwUmVkdWNlciA9IHRvb2x0aXBTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5qcwpmdW5jdGlvbiBvd25LZXlzMTQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gY2hvb3NlQXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikgewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgIGlmICh0cmlnZ2VyID09PSAiY2xpY2siKSB7CiAgICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrOwogICAgfQogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXI7CiAgfQogIGlmICh0cmlnZ2VyID09PSAiY2xpY2siKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljazsKICB9CiAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXI7Cn0KZnVuY3Rpb24gaGFzQmVlbkFjdGl2ZVByZXZpb3VzbHkodG9vbHRpcEludGVyYWN0aW9uU3RhdGUpIHsKICByZXR1cm4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuaW5kZXggIT0gbnVsbDsKfQp2YXIgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlID0gKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIG5vSW50ZXJhY3Rpb247CiAgfQogIHZhciBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24gPSBjaG9vc2VBcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24odG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKTsKICBpZiAoYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uID09IG51bGwpIHsKICAgIHJldHVybiBub0ludGVyYWN0aW9uOwogIH0KICBpZiAoYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uLmFjdGl2ZSkgewogICAgcmV0dXJuIGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbjsKICB9CiAgaWYgKHRvb2x0aXBTdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSkgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgJiYgdG9vbHRpcFN0YXRlLnN5bmNJbnRlcmFjdGlvbi5pbmRleCAhPSBudWxsKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLnN5bmNJbnRlcmFjdGlvbjsKICB9CiAgdmFyIGFjdGl2ZUZyb21Qcm9wcyA9IHRvb2x0aXBTdGF0ZS5zZXR0aW5ncy5hY3RpdmUgPT09IHRydWU7CiAgaWYgKGhhc0JlZW5BY3RpdmVQcmV2aW91c2x5KGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbikpIHsKICAgIGlmIChhY3RpdmVGcm9tUHJvcHMpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNChfb2JqZWN0U3ByZWFkMTQoe30sIGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiksIHt9LCB7CiAgICAgICAgYWN0aXZlOiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAoZGVmYXVsdEluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgY29vcmRpbmF0ZTogdm9pZCAwLAogICAgICBkYXRhS2V5OiB2b2lkIDAsCiAgICAgIGluZGV4OiBkZWZhdWx0SW5kZXgsCiAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICB9OwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDE0KF9vYmplY3RTcHJlYWQxNCh7fSwgbm9JbnRlcmFjdGlvbiksIHt9LCB7CiAgICBjb29yZGluYXRlOiBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24uY29vcmRpbmF0ZQogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXguanMKZnVuY3Rpb24gdG9GaW5pdGVOdW1iZXIodmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZSh2YWx1ZSkgPyB2YWx1ZSA6IHZvaWQgMDsKICB9CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgdmFyIG51bWVyaWNWYWx1ZSA9IHZhbHVlLnZhbHVlT2YoKTsKICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobnVtZXJpY1ZhbHVlKSA/IG51bWVyaWNWYWx1ZSA6IHZvaWQgMDsKICB9CiAgdmFyIHBhcnNlZCA9IE51bWJlcih2YWx1ZSk7CiAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShwYXJzZWQpID8gcGFyc2VkIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGlzVmFsdWVXaXRoaW5OdW1iZXJEb21haW4odmFsdWUsIGRvbWFpbikgewogIHZhciBudW1lcmljVmFsdWUgPSB0b0Zpbml0ZU51bWJlcih2YWx1ZSk7CiAgdmFyIGxvd2VyQm91bmQgPSBkb21haW5bMF07CiAgdmFyIHVwcGVyQm91bmQgPSBkb21haW5bMV07CiAgaWYgKG51bWVyaWNWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBtaW4yID0gTWF0aC5taW4obG93ZXJCb3VuZCwgdXBwZXJCb3VuZCk7CiAgdmFyIG1heDIgPSBNYXRoLm1heChsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICByZXR1cm4gbnVtZXJpY1ZhbHVlID49IG1pbjIgJiYgbnVtZXJpY1ZhbHVlIDw9IG1heDI7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbkRvbWFpbihlbnRyeSwgYXhpc0RhdGFLZXksIGRvbWFpbikgewogIGlmIChkb21haW4gPT0gbnVsbCB8fCBheGlzRGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGF4aXNEYXRhS2V5KTsKICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmICghaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGRvbWFpbikpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKTsKfQp2YXIgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCA9ICh0b29sdGlwSW50ZXJhY3Rpb24sIGNoYXJ0RGF0YSwgYXhpc0RhdGFLZXksIGRvbWFpbikgPT4gewogIHZhciBkZXNpcmVkSW5kZXggPSB0b29sdGlwSW50ZXJhY3Rpb24gPT09IG51bGwgfHwgdG9vbHRpcEludGVyYWN0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwSW50ZXJhY3Rpb24uaW5kZXg7CiAgaWYgKGRlc2lyZWRJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGluZGV4QXNOdW1iZXIgPSBOdW1iZXIoZGVzaXJlZEluZGV4KTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoaW5kZXhBc051bWJlcikpIHsKICAgIHJldHVybiBkZXNpcmVkSW5kZXg7CiAgfQogIHZhciBsb3dlckxpbWl0ID0gMDsKICB2YXIgdXBwZXJMaW1pdCA9IEluZmluaXR5OwogIGlmIChjaGFydERhdGEubGVuZ3RoID4gMCkgewogICAgdXBwZXJMaW1pdCA9IGNoYXJ0RGF0YS5sZW5ndGggLSAxOwogIH0KICB2YXIgY2xhbXBlZEluZGV4ID0gTWF0aC5tYXgobG93ZXJMaW1pdCwgTWF0aC5taW4oaW5kZXhBc051bWJlciwgdXBwZXJMaW1pdCkpOwogIHZhciBlbnRyeSA9IGNoYXJ0RGF0YVtjbGFtcGVkSW5kZXhdOwogIGlmIChlbnRyeSA9PSBudWxsKSB7CiAgICByZXR1cm4gU3RyaW5nKGNsYW1wZWRJbmRleCk7CiAgfQogIGlmICghaXNWYWx1ZVdpdGhpbkRvbWFpbihlbnRyeSwgYXhpc0RhdGFLZXksIGRvbWFpbikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gU3RyaW5nKGNsYW1wZWRJbmRleCk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXguanMKdmFyIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gKHdpZHRoLCBoZWlnaHQsIGxheW91dCwgb2Zmc2V0LCB0b29sdGlwVGlja3MsIGRlZmF1bHRJbmRleCwgdG9vbHRpcENvbmZpZ3VyYXRpb25zLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKSA9PiB7CiAgaWYgKGRlZmF1bHRJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGZpcnN0Q29uZmlndXJhdGlvbiA9IHRvb2x0aXBDb25maWd1cmF0aW9uc1swXTsKICB2YXIgbWF5YmVQb3NpdGlvbiA9IGZpcnN0Q29uZmlndXJhdGlvbiA9PSBudWxsID8gdm9pZCAwIDogdG9vbHRpcFBheWxvYWRTZWFyY2hlcihmaXJzdENvbmZpZ3VyYXRpb24ucG9zaXRpb25zLCBkZWZhdWx0SW5kZXgpOwogIGlmIChtYXliZVBvc2l0aW9uICE9IG51bGwpIHsKICAgIHJldHVybiBtYXliZVBvc2l0aW9uOwogIH0KICB2YXIgdGljayA9IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBUaWNrc1tOdW1iZXIoZGVmYXVsdEluZGV4KV07CiAgaWYgKCF0aWNrKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBzd2l0Y2ggKGxheW91dCkgewogICAgY2FzZSAiaG9yaXpvbnRhbCI6IHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB0aWNrLmNvb3JkaW5hdGUsCiAgICAgICAgeTogKG9mZnNldC50b3AgKyBoZWlnaHQpIC8gMgogICAgICB9OwogICAgfQogICAgZGVmYXVsdDogewogICAgICByZXR1cm4gewogICAgICAgIHg6IChvZmZzZXQubGVmdCArIHdpZHRoKSAvIDIsCiAgICAgICAgeTogdGljay5jb29yZGluYXRlCiAgICAgIH07CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLmpzCnZhciBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyA9ICh0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2FkczsKICB9CiAgaWYgKHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICB2YXIgZmlsdGVyQnlEYXRhS2V5OwogIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICBmaWx0ZXJCeURhdGFLZXkgPSB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXk7CiAgfSBlbHNlIHsKICAgIGZpbHRlckJ5RGF0YUtleSA9IHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleTsKICB9CiAgaWYgKGZpbHRlckJ5RGF0YUtleSA9PSBudWxsICYmIGRlZmF1bHRJbmRleCAhPSBudWxsKSB7CiAgICByZXR1cm4gW3Rvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzWzBdXTsKICB9CiAgcmV0dXJuIHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLmZpbHRlcigodHBjKSA9PiB7CiAgICB2YXIgX3RwYyRzZXR0aW5nczsKICAgIHJldHVybiAoKF90cGMkc2V0dGluZ3MgPSB0cGMuc2V0dGluZ3MpID09PSBudWxsIHx8IF90cGMkc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90cGMkc2V0dGluZ3MuZGF0YUtleSkgPT09IGZpbHRlckJ5RGF0YUtleTsKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIuanMKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMudG9vbHRpcFBheWxvYWRTZWFyY2hlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTdGF0ZS5qcwp2YXIgc2VsZWN0VG9vbHRpcFN0YXRlID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVUb29sdGlwUGF5bG9hZC5qcwpmdW5jdGlvbiBvd25LZXlzMTUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gc2VsZWN0RmluYWxEYXRhKGRhdGFEZWZpbmVkT25JdGVtLCBkYXRhRGVmaW5lZE9uQ2hhcnQpIHsKICBpZiAoZGF0YURlZmluZWRPbkl0ZW0gIT0gbnVsbCkgewogICAgcmV0dXJuIGRhdGFEZWZpbmVkT25JdGVtOwogIH0KICByZXR1cm4gZGF0YURlZmluZWRPbkNoYXJ0Owp9CnZhciBjb21iaW5lVG9vbHRpcFBheWxvYWQgPSAodG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucywgYWN0aXZlSW5kZXgsIGNoYXJ0RGF0YVN0YXRlLCB0b29sdGlwQXhpc0RhdGFLZXksIGFjdGl2ZUxhYmVsLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLCB0b29sdGlwRXZlbnRUeXBlKSA9PiB7CiAgaWYgKGFjdGl2ZUluZGV4ID09IG51bGwgfHwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgY2hhcnREYXRhLAogICAgY29tcHV0ZWREYXRhLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBkYXRhRW5kSW5kZXgKICB9ID0gY2hhcnREYXRhU3RhdGU7CiAgdmFyIGluaXQgPSBbXTsKICByZXR1cm4gdG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucy5yZWR1Y2UoKGFnZywgX3JlZjIpID0+IHsKICAgIHZhciBfc2V0dGluZ3MkZGF0YUtleTsKICAgIHZhciB7CiAgICAgIGRhdGFEZWZpbmVkT25JdGVtLAogICAgICBzZXR0aW5ncwogICAgfSA9IF9yZWYyOwogICAgdmFyIGZpbmFsRGF0YSA9IHNlbGVjdEZpbmFsRGF0YShkYXRhRGVmaW5lZE9uSXRlbSwgY2hhcnREYXRhKTsKICAgIHZhciBzbGljZWQgPSBBcnJheS5pc0FycmF5KGZpbmFsRGF0YSkgPyBnZXRTbGljZWQoZmluYWxEYXRhLCBkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4KSA6IGZpbmFsRGF0YTsKICAgIHZhciBmaW5hbERhdGFLZXkgPSAoX3NldHRpbmdzJGRhdGFLZXkgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MuZGF0YUtleSkgIT09IG51bGwgJiYgX3NldHRpbmdzJGRhdGFLZXkgIT09IHZvaWQgMCA/IF9zZXR0aW5ncyRkYXRhS2V5IDogdG9vbHRpcEF4aXNEYXRhS2V5OwogICAgdmFyIGZpbmFsTmFtZUtleSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5uYW1lS2V5OwogICAgdmFyIHRvb2x0aXBQYXlsb2FkOwogICAgaWYgKHRvb2x0aXBBeGlzRGF0YUtleSAmJiBBcnJheS5pc0FycmF5KHNsaWNlZCkgJiYgLyoKICAgICAqIGZpbmRFbnRyeUluQXJyYXkgd29uJ3Qgd29yayBmb3IgU2NhdHRlciBiZWNhdXNlIFNjYXR0ZXIgcHJvdmlkZXMgYW4gYXJyYXkgb2YgYXJyYXlzCiAgICAgKiBhcyB0b29sdGlwIHBheWxvYWRzIGFuZCBmaW5kRW50cnlJbkFycmF5IGlzIG5vdCBwcmVwYXJlZCB0byBoYW5kbGUgdGhhdC4KICAgICAqIFNhZCBidXQgYWxzbyBTY2F0dGVyQ2hhcnQgb25seSBhbGxvd3MgJ2l0ZW0nIHRvb2x0aXBFdmVudFR5cGUKICAgICAqIGFuZCBhbHNvIHRoaXMgaXMgb25seSBhIHByb2JsZW0gaWYgdGhlcmUgYXJlIG11bHRpcGxlIFNjYXR0ZXJzIGFuZCBlYWNoIGhhcyBpdHMgb3duIGRhdGEgYXJyYXkKICAgICAqIHNvIGxldCdzIGZpeCB0aGF0IHNvbWUgb3RoZXIgdGltZS4KICAgICAqLwogICAgIUFycmF5LmlzQXJyYXkoc2xpY2VkWzBdKSAmJiAvKgogICAgICogSWYgdGhlIHRvb2x0aXBFdmVudFR5cGUgaXMgJ2F4aXMnLCB3ZSBzaG91bGQgc2VhcmNoIGZvciB0aGUgZGF0YUtleSBpbiB0aGUgc2xpY2VkIGRhdGEKICAgICAqIGJlY2F1c2UgdGhhbmtzIHRvIGFsbG93RHVwbGljYXRlZENhdGVnb3J5PWZhbHNlLCB0aGUgb3JkZXIgb2YgZWxlbWVudHMgaW4gdGhlIGFycmF5CiAgICAgKiBubyBsb25nZXIgbWF0Y2hlcyB0aGUgb3JkZXIgb2YgZWxlbWVudHMgaW4gdGhlIG9yaWdpbmFsIGRhdGEKICAgICAqIGFuZCBzbyB3ZSBuZWVkIHRvIHNlYXJjaCBieSB0aGUgYWN0aXZlIGRhdGFLZXkgKyBsYWJlbCByYXRoZXIgdGhhbiBieSBpbmRleC4KICAgICAqCiAgICAgKiBUaGUgc2FtZSBoYXBwZW5zIGlmIG11bHRpcGxlIGdyYXBoaWNhbCBpdGVtcyBhcmUgcHJlc2VudCBpbiB0aGUgY2hhcnQKICAgICAqIGFuZCBlYWNoIG9mIHRoZW0gaGFzIGl0cyBvd24gZGF0YSBhcnJheS4gVGhvc2UgYXJyYXlzIGdldCBjb25jYXRlbmF0ZWQKICAgICAqIGFuZCBhZ2FpbiB0aGUgdG9vbHRpcCBpbmRleCBubyBsb25nZXIgbWF0Y2hlcyB0aGUgb3JpZ2luYWwgZGF0YS4KICAgICAqCiAgICAgKiBPbiB0aGUgb3RoZXIgaGFuZCB0aGUgdG9vbHRpcEV2ZW50VHlwZSAnaXRlbScgc2hvdWxkIGFsd2F5cyBzZWFyY2ggYnkgaW5kZXgKICAgICAqIGJlY2F1c2Ugd2UgZ2V0IHRoZSBpbmRleCBmcm9tIGludGVyYWN0aW5nIG92ZXIgdGhlIGluZGl2aWR1YWwgZWxlbWVudHMKICAgICAqIHdoaWNoIGlzIGFsd2F5cyBhY2N1cmF0ZSwgaXJyZXNwZWN0aXZlIG9mIHRoZSBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSBzZXR0aW5nLgogICAgICovCiAgICB0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgICAgdG9vbHRpcFBheWxvYWQgPSBmaW5kRW50cnlJbkFycmF5KHNsaWNlZCwgdG9vbHRpcEF4aXNEYXRhS2V5LCBhY3RpdmVMYWJlbCk7CiAgICB9IGVsc2UgewogICAgICB0b29sdGlwUGF5bG9hZCA9IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIoc2xpY2VkLCBhY3RpdmVJbmRleCwgY29tcHV0ZWREYXRhLCBmaW5hbE5hbWVLZXkpOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkodG9vbHRpcFBheWxvYWQpKSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICB2YXIgbmV3U2V0dGluZ3MgPSBfb2JqZWN0U3ByZWFkMTUoX29iamVjdFNwcmVhZDE1KHt9LCBzZXR0aW5ncyksIHt9LCB7CiAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUsCiAgICAgICAgICB1bml0OiBpdGVtLnVuaXQsCiAgICAgICAgICAvLyBjb2xvciBhbmQgZmlsbCBhcmUgZXJhc2VkIHRvIGtlZXAgMTAwJSB0aGUgaWRlbnRpY2FsIGJlaGF2aW91ciB0byByZWNoYXJ0cyAyLnggLSBidXQgdGhlcmUncyBub3RoaW5nIHN0b3BwaW5nIHVzIGZyb20gcmV0dXJuaW5nIHRoZW0gaGVyZS4gSXQncyB0ZWNobmljYWxseSBhIGJyZWFraW5nIGNoYW5nZS4KICAgICAgICAgIGNvbG9yOiB2b2lkIDAsCiAgICAgICAgICAvLyBjb2xvciBhbmQgZmlsbCBhcmUgZXJhc2VkIHRvIGtlZXAgMTAwJSB0aGUgaWRlbnRpY2FsIGJlaGF2aW91ciB0byByZWNoYXJ0cyAyLnggLSBidXQgdGhlcmUncyBub3RoaW5nIHN0b3BwaW5nIHVzIGZyb20gcmV0dXJuaW5nIHRoZW0gaGVyZS4gSXQncyB0ZWNobmljYWxseSBhIGJyZWFraW5nIGNoYW5nZS4KICAgICAgICAgIGZpbGw6IHZvaWQgMAogICAgICAgIH0pOwogICAgICAgIGFnZy5wdXNoKGdldFRvb2x0aXBFbnRyeSh7CiAgICAgICAgICB0b29sdGlwRW50cnlTZXR0aW5nczogbmV3U2V0dGluZ3MsCiAgICAgICAgICBkYXRhS2V5OiBpdGVtLmRhdGFLZXksCiAgICAgICAgICBwYXlsb2FkOiBpdGVtLnBheWxvYWQsCiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGl0ZW0ucGF5bG9hZCwgaXRlbS5kYXRhS2V5KSwKICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZQogICAgICAgIH0pKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgX2dldFZhbHVlQnlEYXRhS2V5OwogICAgICBhZ2cucHVzaChnZXRUb29sdGlwRW50cnkoewogICAgICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzOiBzZXR0aW5ncywKICAgICAgICBkYXRhS2V5OiBmaW5hbERhdGFLZXksCiAgICAgICAgcGF5bG9hZDogdG9vbHRpcFBheWxvYWQsCiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRWYWx1ZUJ5RGF0YUtleSBkb2VzIG5vdCB2YWxpZGF0ZSB0aGUgb3V0cHV0IHR5cGUKICAgICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkodG9vbHRpcFBheWxvYWQsIGZpbmFsRGF0YUtleSksCiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRWYWx1ZUJ5RGF0YUtleSBkb2VzIG5vdCB2YWxpZGF0ZSB0aGUgb3V0cHV0IHR5cGUKICAgICAgICBuYW1lOiAoX2dldFZhbHVlQnlEYXRhS2V5ID0gZ2V0VmFsdWVCeURhdGFLZXkodG9vbHRpcFBheWxvYWQsIGZpbmFsTmFtZUtleSkpICE9PSBudWxsICYmIF9nZXRWYWx1ZUJ5RGF0YUtleSAhPT0gdm9pZCAwID8gX2dldFZhbHVlQnlEYXRhS2V5IDogc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLm5hbWUKICAgICAgfSkpOwogICAgfQogICAgcmV0dXJuIGFnZzsKICB9LCBpbml0KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3Rvb2x0aXBTZWxlY3RvcnMuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEhhc0Jhciwgc2VsZWN0Q2hhcnROYW1lLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lUmVhbFNjYWxlVHlwZSk7CnZhciBzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3RvcihbKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5jYXJ0ZXNpYW5JdGVtcywgKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5wb2xhckl0ZW1zXSwgKGNhcnRlc2lhbkl0ZW1zLCBwb2xhckl0ZW1zKSA9PiBbLi4uY2FydGVzaWFuSXRlbXMsIC4uLnBvbGFySXRlbXNdKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUHJlZGljYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGl0ZW1BeGlzUHJlZGljYXRlKTsKdmFyIHNlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsVW5maWx0ZXJlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcEdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBzZWxlY3RUb29sdGlwU3RhY2tlZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc10sIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YSk7CnZhciBzZWxlY3RBbGxUb29sdGlwQXBwbGllZFZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CnZhciBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNdLCBnZXREb21haW5EZWZpbml0aW9uKTsKdmFyIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3cgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNdLCAoYXhpc1NldHRpbmdzKSA9PiBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp2YXIgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNEb21haW5EZWZpbml0aW9uLCBzZWxlY3RUb29sdGlwRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCAoZ3JhcGhpY2FsSXRlbXMpID0+IGdyYXBoaWNhbEl0ZW1zLmZpbHRlcihpc1N0YWNrZWQpKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhY2tlZERhdGEsIHNlbGVjdEFsbFN0YWNrZWRHcmFwaGljYWxJdGVtcywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBzZWxlY3RSZXZlcnNlU3RhY2tPcmRlcl0sIGNvbWJpbmVTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhY2tHcm91cHMsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBEb21haW5Gcm9tVXNlclByZWZlcmVuY2VzXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMpOwp2YXIgc2VsZWN0VG9vbHRpcEl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBmaWx0ZXJHcmFwaGljYWxOb3RTdGFja2VkSXRlbXMpOwp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlUb29sdGlwQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRG90c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzQnlUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZURvdHNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlQXJlYXNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlQXJlYXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlTGluZXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lTGluZXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluLCBzZWxlY3RUb29sdGlwUmVmZXJlbmNlTGluZXNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbl0sIG1lcmdlRG9tYWlucyk7CnZhciBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEb21haW5Gcm9tVXNlclByZWZlcmVuY2VzLCBzZWxlY3RUb29sdGlwRG9tYWluT2ZTdGFja0dyb3Vwcywgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMyLCBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4sIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lTnVtZXJpY2FsRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcE51bWVyaWNhbERvbWFpbl0sIGNvbWJpbmVBeGlzRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNEb21haW4sIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGVdLCBjb21iaW5lTmljZVRpY2tzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2UgPSAoc3RhdGUpID0+IHsKICB2YXIgYXhpc1R5cGUgPSBzZWxlY3RUb29sdGlwQXhpc1R5cGUoc3RhdGUpOwogIHZhciBheGlzSWQgPSBzZWxlY3RUb29sdGlwQXhpc0lkKHN0YXRlKTsKICB2YXIgaXNQYW5vcmFtYSA9IGZhbHNlOwogIHJldHVybiBzZWxlY3RBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQsIGlzUGFub3JhbWEpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdFRvb2x0aXBEdXBsaWNhdGVEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUR1cGxpY2F0ZURvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwQ2F0ZWdvcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluKTsKdmFyIGNvbWJpbmVUaWNrc09mVG9vbHRpcEF4aXMgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgcmFuZ2U0LCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmICghYXhpcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHR5cGUKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIGlmICghc2NhbGUpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiAocmFuZ2U0ID09PSBudWxsIHx8IHJhbmdlNCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmFuZ2U0Lmxlbmd0aCkgPj0gMiA/IG1hdGhTaWduKHJhbmdlNFswXSAtIHJhbmdlNFsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGUsIHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2UsIHNlbGVjdFRvb2x0aXBEdXBsaWNhdGVEb21haW4sIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyk7CnZhciBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywgc2VsZWN0VG9vbHRpcFNldHRpbmdzXSwgKGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGUsIHNldHRpbmdzKSA9PiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzZXR0aW5ncy5zaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGUpKTsKdmFyIHNlbGVjdFRvb2x0aXBUcmlnZ2VyID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnRyaWdnZXI7CnZhciBzZWxlY3REZWZhdWx0SW5kZXggPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MuZGVmYXVsdEluZGV4Owp2YXIgc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluXSwgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVMYWJlbCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXhdLCBjb21iaW5lQWN0aXZlTGFiZWwpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFLZXkgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZGF0YUtleTsKfSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwR3JhcGhpY2FsSXRlbUlkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlXSwgKHRvb2x0aXBJbnRlcmFjdGlvbikgPT4gewogIGlmICghdG9vbHRpcEludGVyYWN0aW9uKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gdG9vbHRpcEludGVyYWN0aW9uLmdyYXBoaWNhbEl0ZW1JZDsKfSk7CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgc2VsZWN0VG9vbHRpcEV2ZW50VHlwZTIsIHNlbGVjdFRvb2x0aXBUcmlnZ2VyLCBzZWxlY3REZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyk7CnZhciBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdERlZmF1bHRJbmRleCwgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucywgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlcl0sIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgZGVmYXVsdEluZGV4Q29vcmRpbmF0ZSkgPT4gewogIGlmICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSAhPT0gbnVsbCAmJiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSAhPT0gdm9pZCAwICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGUpIHsKICAgIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlOwogIH0KICByZXR1cm4gZGVmYXVsdEluZGV4Q29vcmRpbmF0ZTsKfSk7CnZhciBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUpID0+IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmFjdGl2ZSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdEFjdGl2ZUxhYmVsLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMl0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YVBvaW50cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBY3RpdmVUb29sdGlwUGF5bG9hZF0sIChwYXlsb2FkKSA9PiB7CiAgaWYgKHBheWxvYWQgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGRhdGFQb2ludHMgPSBwYXlsb2FkLm1hcCgocCkgPT4gcC5wYXlsb2FkKS5maWx0ZXIoKHApID0+IHAgIT0gbnVsbCk7CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChkYXRhUG9pbnRzKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L3VzZVRvb2x0aXBBeGlzLmpzCmZ1bmN0aW9uIG93bktleXMxNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgdXNlVG9vbHRpcEF4aXMgPSAoKSA9PiB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpcyk7CnZhciB1c2VUb29sdGlwQXhpc0JhbmRTaXplID0gKCkgPT4gewogIHZhciB0b29sdGlwQXhpcyA9IHVzZVRvb2x0aXBBeGlzKCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciB0b29sdGlwQXhpc1NjYWxlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSk7CiAgaWYgKCF0b29sdGlwQXhpcyB8fCAhdG9vbHRpcEF4aXNTY2FsZSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHZvaWQgMCwgdG9vbHRpcFRpY2tzKTsKICB9CiAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKF9vYmplY3RTcHJlYWQxNihfb2JqZWN0U3ByZWFkMTYoe30sIHRvb2x0aXBBeGlzKSwge30sIHsKICAgIHNjYWxlOiB0b29sdGlwQXhpc1NjYWxlCiAgfSksIHRvb2x0aXBUaWNrcyk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RvcnMuanMKdmFyIGltcG9ydF9zb3J0Qnk0ID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0QWN0aXZlQ29vcmRpbmF0ZS5qcwpmdW5jdGlvbiBvd25LZXlzMTcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGdldEFjdGl2ZUNhcnRlc2lhbkNvb3JkaW5hdGUgPSAobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCBwb2ludGVyKSA9PiB7CiAgdmFyIGVudHJ5ID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IHRpY2sgJiYgdGljay5pbmRleCA9PT0gYWN0aXZlSW5kZXgpOwogIGlmIChlbnRyeSkgewogICAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogZW50cnkuY29vcmRpbmF0ZSwKICAgICAgICB5OiBwb2ludGVyLmNoYXJ0WQogICAgICB9OwogICAgfQogICAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgICByZXR1cm4gewogICAgICAgIHg6IHBvaW50ZXIuY2hhcnRYLAogICAgICAgIHk6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfTsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKfTsKdmFyIGdldEFjdGl2ZVBvbGFyQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHJhbmdlT2JqKSA9PiB7CiAgdmFyIGVudHJ5ID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IHRpY2sgJiYgdGljay5pbmRleCA9PT0gYWN0aXZlSW5kZXgpOwogIGlmIChlbnRyeSkgewogICAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICAgIHZhciBfYW5nbGUgPSBlbnRyeS5jb29yZGluYXRlOwogICAgICB2YXIgewogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9ID0gcmFuZ2VPYmo7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgX3JhZGl1cywgX2FuZ2xlKSksIHt9LCB7CiAgICAgICAgYW5nbGU6IF9hbmdsZSwKICAgICAgICByYWRpdXM6IF9yYWRpdXMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgcmFkaXVzID0gZW50cnkuY29vcmRpbmF0ZTsKICAgIHZhciB7CiAgICAgIGFuZ2xlCiAgICB9ID0gcmFuZ2VPYmo7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoe30sIHJhbmdlT2JqKSwgcG9sYXJUb0NhcnRlc2lhbihyYW5nZU9iai5jeCwgcmFuZ2VPYmouY3ksIHJhZGl1cywgYW5nbGUpKSwge30sIHsKICAgICAgYW5nbGUsCiAgICAgIHJhZGl1cwogICAgfSk7CiAgfQogIHJldHVybiB7CiAgICBhbmdsZTogMCwKICAgIGNsb2NrV2lzZTogZmFsc2UsCiAgICBjeDogMCwKICAgIGN5OiAwLAogICAgZW5kQW5nbGU6IDAsCiAgICBpbm5lclJhZGl1czogMCwKICAgIG91dGVyUmFkaXVzOiAwLAogICAgcmFkaXVzOiAwLAogICAgc3RhcnRBbmdsZTogMCwKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKfTsKZnVuY3Rpb24gaXNJbkNhcnRlc2lhblJhbmdlKHBvaW50ZXIsIG9mZnNldCkgewogIHZhciB7CiAgICBjaGFydFg6IHgyLAogICAgY2hhcnRZOiB5MgogIH0gPSBwb2ludGVyOwogIHJldHVybiB4MiA+PSBvZmZzZXQubGVmdCAmJiB4MiA8PSBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAmJiB5MiA+PSBvZmZzZXQudG9wICYmIHkyIDw9IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0Owp9CnZhciBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXggPSAoY29vcmRpbmF0ZSwgdGlja3MyLCB1bnNvcnRlZFRpY2tzLCBheGlzVHlwZSwgcmFuZ2U0KSA9PiB7CiAgdmFyIF90aWNrcyRsZW5ndGg7CiAgdmFyIGluZGV4ID0gLTE7CiAgdmFyIGxlbiA9IChfdGlja3MkbGVuZ3RoID0gdGlja3MyID09PSBudWxsIHx8IHRpY2tzMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGlja3MyLmxlbmd0aCkgIT09IG51bGwgJiYgX3RpY2tzJGxlbmd0aCAhPT0gdm9pZCAwID8gX3RpY2tzJGxlbmd0aCA6IDA7CiAgaWYgKGxlbiA8PSAxIHx8IGNvb3JkaW5hdGUgPT0gbnVsbCkgewogICAgcmV0dXJuIDA7CiAgfQogIGlmIChheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgcmFuZ2U0ICE9IG51bGwgJiYgTWF0aC5hYnMoTWF0aC5hYnMocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSAtIDM2MCkgPD0gMWUtNikgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgYmVmb3JlID0gaSA+IDAgPyB1bnNvcnRlZFRpY2tzW2kgLSAxXS5jb29yZGluYXRlIDogdW5zb3J0ZWRUaWNrc1tsZW4gLSAxXS5jb29yZGluYXRlOwogICAgICB2YXIgY3VyID0gdW5zb3J0ZWRUaWNrc1tpXS5jb29yZGluYXRlOwogICAgICB2YXIgYWZ0ZXIgPSBpID49IGxlbiAtIDEgPyB1bnNvcnRlZFRpY2tzWzBdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2kgKyAxXS5jb29yZGluYXRlOwogICAgICB2YXIgc2FtZURpcmVjdGlvbkNvb3JkID0gdm9pZCAwOwogICAgICBpZiAobWF0aFNpZ24oY3VyIC0gYmVmb3JlKSAhPT0gbWF0aFNpZ24oYWZ0ZXIgLSBjdXIpKSB7CiAgICAgICAgdmFyIGRpZmZJbnRlcnZhbCA9IFtdOwogICAgICAgIGlmIChtYXRoU2lnbihhZnRlciAtIGN1cikgPT09IG1hdGhTaWduKHJhbmdlNFsxXSAtIHJhbmdlNFswXSkpIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGFmdGVyOwogICAgICAgICAgdmFyIGN1ckluUmFuZ2UgPSBjdXIgKyByYW5nZTRbMV0gLSByYW5nZTRbMF07CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMF0gPSBNYXRoLm1pbihjdXJJblJhbmdlLCAoY3VySW5SYW5nZSArIGJlZm9yZSkgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYW1lRGlyZWN0aW9uQ29vcmQgPSBiZWZvcmU7CiAgICAgICAgICB2YXIgYWZ0ZXJJblJhbmdlID0gYWZ0ZXIgKyByYW5nZTRbMV0gLSByYW5nZTRbMF07CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMF0gPSBNYXRoLm1pbihjdXIsIChhZnRlckluUmFuZ2UgKyBjdXIpIC8gMik7CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMV0gPSBNYXRoLm1heChjdXIsIChhZnRlckluUmFuZ2UgKyBjdXIpIC8gMik7CiAgICAgICAgfQogICAgICAgIHZhciBzYW1lSW50ZXJ2YWwgPSBbTWF0aC5taW4oY3VyLCAoc2FtZURpcmVjdGlvbkNvb3JkICsgY3VyKSAvIDIpLCBNYXRoLm1heChjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMildOwogICAgICAgIGlmIChjb29yZGluYXRlID4gc2FtZUludGVydmFsWzBdICYmIGNvb3JkaW5hdGUgPD0gc2FtZUludGVydmFsWzFdIHx8IGNvb3JkaW5hdGUgPj0gZGlmZkludGVydmFsWzBdICYmIGNvb3JkaW5hdGUgPD0gZGlmZkludGVydmFsWzFdKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBtaW5WYWx1ZSA9IE1hdGgubWluKGJlZm9yZSwgYWZ0ZXIpOwogICAgICAgIHZhciBtYXhWYWx1ZSA9IE1hdGgubWF4KGJlZm9yZSwgYWZ0ZXIpOwogICAgICAgIGlmIChjb29yZGluYXRlID4gKG1pblZhbHVlICsgY3VyKSAvIDIgJiYgY29vcmRpbmF0ZSA8PSAobWF4VmFsdWUgKyBjdXIpIC8gMikgewogICAgICAgICAgKHsKICAgICAgICAgICAgaW5kZXgKICAgICAgICAgIH0gPSB1bnNvcnRlZFRpY2tzW2ldKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAodGlja3MyKSB7CiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgbGVuOyBfaSsrKSB7CiAgICAgIGlmIChfaSA9PT0gMCAmJiBjb29yZGluYXRlIDw9ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgKyAxXS5jb29yZGluYXRlKSAvIDIgfHwgX2kgPiAwICYmIF9pIDwgbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMiAmJiBjb29yZGluYXRlIDw9ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgKyAxXS5jb29yZGluYXRlKSAvIDIgfHwgX2kgPT09IGxlbiAtIDEgJiYgY29vcmRpbmF0ZSA+ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgLSAxXS5jb29yZGluYXRlKSAvIDIpIHsKICAgICAgICAoewogICAgICAgICAgaW5kZXgKICAgICAgICB9ID0gdGlja3MyW19pXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGluZGV4Owp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciB1c2VDaGFydE5hbWUgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TmFtZSk7Cn07CnZhciBwaWNrVG9vbHRpcEV2ZW50VHlwZSA9IChfc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUpID0+IHRvb2x0aXBFdmVudFR5cGU7CnZhciBwaWNrVHJpZ2dlciA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB0cmlnZ2VyOwp2YXIgcGlja0RlZmF1bHRJbmRleCA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCBfdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiBkZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgKHRpY2tzMikgPT4gKDAsIGltcG9ydF9zb3J0Qnk0LmRlZmF1bHQpKHRpY2tzMiwgKG8pID0+IG8uY29vcmRpbmF0ZSkpOwp2YXIgc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgcGlja1Rvb2x0aXBFdmVudFR5cGUsIHBpY2tUcmlnZ2VyLCBwaWNrRGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZUluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdFRvb2x0aXBEYXRhS2V5ID0gKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHRvb2x0aXBTdGF0ZSA9IHNlbGVjdFRvb2x0aXBTdGF0ZShzdGF0ZSk7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5Owp9Owp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBwaWNrVG9vbHRpcEV2ZW50VHlwZSwgcGlja1RyaWdnZXIsIHBpY2tEZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyk7CnZhciBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgcGlja0RlZmF1bHRJbmRleCwgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXJdLCBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgZGVmYXVsdEluZGV4Q29vcmRpbmF0ZSkgPT4gewogIHZhciBfdG9vbHRpcEludGVyYWN0aW9uU3Q7CiAgcmV0dXJuIChfdG9vbHRpcEludGVyYWN0aW9uU3QgPSB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlKSAhPT0gbnVsbCAmJiBfdG9vbHRpcEludGVyYWN0aW9uU3QgIT09IHZvaWQgMCA/IF90b29sdGlwSW50ZXJhY3Rpb25TdCA6IGRlZmF1bHRJbmRleENvb3JkaW5hdGU7Cn0pOwp2YXIgc2VsZWN0QWN0aXZlTGFiZWwyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZUluZGV4XSwgY29tYmluZUFjdGl2ZUxhYmVsKTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyLCBzZWxlY3RBY3RpdmVJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwyLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCBwaWNrVG9vbHRpcEV2ZW50VHlwZV0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZCk7CnZhciBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0QWN0aXZlSW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGFjdGl2ZUluZGV4KSA9PiB7CiAgcmV0dXJuIHsKICAgIGlzQWN0aXZlOiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5hY3RpdmUgJiYgYWN0aXZlSW5kZXggIT0gbnVsbCwKICAgIGFjdGl2ZUluZGV4CiAgfTsKfSk7CnZhciBjb21iaW5lQWN0aXZlQ2FydGVzaWFuUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFpc0luQ2FydGVzaWFuUmFuZ2UoY2hhcnRFdmVudCwgb2Zmc2V0KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHBvcyA9IGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MoY2hhcnRFdmVudCwgbGF5b3V0KTsKICB2YXIgYWN0aXZlSW5kZXggPSBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXgocG9zLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCB0b29sdGlwVGlja3MsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSk7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBnZXRBY3RpdmVDYXJ0ZXNpYW5Db29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgY2hhcnRFdmVudCk7CiAgcmV0dXJuIHsKICAgIGFjdGl2ZUluZGV4OiBTdHJpbmcoYWN0aXZlSW5kZXgpLAogICAgYWN0aXZlQ29vcmRpbmF0ZQogIH07Cn07CnZhciBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzIHx8ICFwb2xhclZpZXdCb3gpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciByYW5nZU9iaiA9IGluUmFuZ2VPZlNlY3RvcihjaGFydEV2ZW50LCBwb2xhclZpZXdCb3gpOwogIGlmICghcmFuZ2VPYmopIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBwb3MgPSBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MocmFuZ2VPYmosIGxheW91dCk7CiAgdmFyIGFjdGl2ZUluZGV4ID0gY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4KHBvcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgdG9vbHRpcFRpY2tzLCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UpOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopOwogIHJldHVybiB7CiAgICBhY3RpdmVJbmRleDogU3RyaW5nKGFjdGl2ZUluZGV4KSwKICAgIGFjdGl2ZUNvb3JkaW5hdGUKICB9Owp9Owp2YXIgY29tYmluZUFjdGl2ZVByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICFsYXlvdXQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29tYmluZUFjdGl2ZUNhcnRlc2lhblByb3BzKGNoYXJ0RXZlbnQsIGxheW91dCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCk7CiAgfQogIHJldHVybiBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyhjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvWkluZGV4TGF5ZXIuanMKdmFyIGltcG9ydF9yZWFjdDIwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0X2RvbSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdF9kb20oKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC96SW5kZXhTZWxlY3RvcnMuanMKdmFyIHNlbGVjdFpJbmRleFBvcnRhbElkID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoXywgekluZGV4KSA9PiB6SW5kZXgsIChfLCBfekluZGV4LCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hLCAoekluZGV4TWFwLCB6SW5kZXgsIGlzUGFub3JhbWEpID0+IHsKICBpZiAoekluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBlbnRyeSA9IHpJbmRleE1hcFt6SW5kZXhdOwogIGlmIChlbnRyeSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIGVudHJ5LnBhbm9yYW1hRWxlbWVudElkOwogIH0KICByZXR1cm4gZW50cnkuZWxlbWVudElkOwp9KTsKdmFyIHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuekluZGV4LnpJbmRleE1hcCwgKHpJbmRleE1hcCkgPT4gewogIHZhciBhbGxOdW1iZXJzID0gT2JqZWN0LmtleXMoekluZGV4TWFwKS5tYXAoKHpJbmRleFN0cikgPT4gcGFyc2VJbnQoekluZGV4U3RyLCAxMCkpLmNvbmNhdChPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykpOwogIHZhciB1bmlxdWVOdW1iZXJzID0gQXJyYXkuZnJvbShuZXcgU2V0KGFsbE51bWJlcnMpKTsKICByZXR1cm4gdW5pcXVlTnVtYmVycy5zb3J0KChhLCBiKSA9PiBhIC0gYik7Cn0sIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogYXJyYXlDb250ZW50c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS96SW5kZXhTbGljZS5qcwpmdW5jdGlvbiBvd25LZXlzMTgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlZWQgPSB7fTsKdmFyIGluaXRpYWxTdGF0ZTQgPSB7CiAgekluZGV4TWFwOiBPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykucmVkdWNlKChhY2MsIGN1cnJlbnQzKSA9PiBfb2JqZWN0U3ByZWFkMTgoX29iamVjdFNwcmVhZDE4KHt9LCBhY2MpLCB7fSwgewogICAgW2N1cnJlbnQzXTogewogICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgY29uc3VtZXJzOiAwCiAgICB9CiAgfSksIHNlZWQpCn07CnZhciBkZWZhdWx0WkluZGV4U2V0ID0gbmV3IFNldChPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykpOwpmdW5jdGlvbiBpc0RlZmF1bHRaSW5kZXgoekluZGV4KSB7CiAgcmV0dXJuIGRlZmF1bHRaSW5kZXhTZXQuaGFzKHpJbmRleCk7Cn0KdmFyIHpJbmRleFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJ6SW5kZXgiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNCwKICByZWR1Y2VyczogewogICAgcmVnaXN0ZXJaSW5kZXhQb3J0YWw6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uY29uc3VtZXJzICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdID0gewogICAgICAgICAgICBjb25zdW1lcnM6IDEsCiAgICAgICAgICAgIGVsZW1lbnRJZDogdm9pZCAwLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyAtPSAxOwogICAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyA8PSAwICYmICFpc0RlZmF1bHRaSW5kZXgoekluZGV4KSkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuekluZGV4TWFwW3pJbmRleF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4LAogICAgICAgICAgZWxlbWVudElkLAogICAgICAgICAgaXNQYW5vcmFtYQogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAwLAogICAgICAgICAgICBlbGVtZW50SWQ6IGlzUGFub3JhbWEgPyB2b2lkIDAgOiBlbGVtZW50SWQsCiAgICAgICAgICAgIHBhbm9yYW1hRWxlbWVudElkOiBpc1Bhbm9yYW1hID8gZWxlbWVudElkIDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkLmlzUGFub3JhbWEpIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0ucGFub3JhbWFFbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5lbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgdW5yZWdpc3RlclpJbmRleFBvcnRhbCwKICByZWdpc3RlclpJbmRleFBvcnRhbElkLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZAp9ID0gekluZGV4U2xpY2UuYWN0aW9uczsKdmFyIHpJbmRleFJlZHVjZXIgPSB6SW5kZXhTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvWkluZGV4TGF5ZXIuanMKZnVuY3Rpb24gWkluZGV4TGF5ZXIoX3JlZjIpIHsKICB2YXIgewogICAgekluZGV4LAogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIGlzSW5DaGFydENvbnRleHQgPSB1c2VJc0luQ2hhcnRDb250ZXh0KCk7CiAgdmFyIHNob3VsZFJlbmRlckluUG9ydGFsID0gaXNJbkNoYXJ0Q29udGV4dCAmJiB6SW5kZXggIT09IHZvaWQgMCAmJiB6SW5kZXggIT09IDA7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIXNob3VsZFJlbmRlckluUG9ydGFsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgZGlzcGF0Y2gocmVnaXN0ZXJaSW5kZXhQb3J0YWwoewogICAgICB6SW5kZXgKICAgIH0pKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHVucmVnaXN0ZXJaSW5kZXhQb3J0YWwoewogICAgICAgIHpJbmRleAogICAgICB9KSk7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgekluZGV4LCBzaG91bGRSZW5kZXJJblBvcnRhbF0pOwogIHZhciBwb3J0YWxJZCA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WkluZGV4UG9ydGFsSWQoc3RhdGUsIHpJbmRleCwgaXNQYW5vcmFtYSkpOwogIGlmICghc2hvdWxkUmVuZGVySW5Qb3J0YWwpIHsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgaWYgKCFwb3J0YWxJZCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB6SW5kZXhQb3J0YWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwb3J0YWxJZCk7CiAgaWYgKHpJbmRleFBvcnRhbCkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0X2RvbS5jcmVhdGVQb3J0YWwpKGNoaWxkcmVuLCB6SW5kZXhQb3J0YWwpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCmZ1bmN0aW9uIF9leHRlbmRzOSgpIHsKICByZXR1cm4gX2V4dGVuZHM5ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM5LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czE5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIFJlbmRlckN1cnNvcihfcmVmMikgewogIHZhciB7CiAgICBjdXJzb3IsCiAgICBjdXJzb3JDb21wLAogICAgY3Vyc29yUHJvcHMKICB9ID0gX3JlZjI7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuaXNWYWxpZEVsZW1lbnQpKGN1cnNvcikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmNsb25lRWxlbWVudCkoY3Vyc29yLCBjdXJzb3JQcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmNyZWF0ZUVsZW1lbnQpKGN1cnNvckNvbXAsIGN1cnNvclByb3BzKTsKfQpmdW5jdGlvbiBDdXJzb3JJbnRlcm5hbChwcm9wcykgewogIHZhciBfcHJvcHMkekluZGV4OwogIHZhciB7CiAgICBjb29yZGluYXRlLAogICAgcGF5bG9hZCwKICAgIGluZGV4LAogICAgb2Zmc2V0LAogICAgdG9vbHRpcEF4aXNCYW5kU2l6ZSwKICAgIGxheW91dCwKICAgIGN1cnNvciwKICAgIHRvb2x0aXBFdmVudFR5cGUsCiAgICBjaGFydE5hbWUKICB9ID0gcHJvcHM7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBjb29yZGluYXRlOwogIHZhciBhY3RpdmVQYXlsb2FkID0gcGF5bG9hZDsKICB2YXIgYWN0aXZlVG9vbHRpcEluZGV4ID0gaW5kZXg7CiAgaWYgKCFjdXJzb3IgfHwgIWFjdGl2ZUNvb3JkaW5hdGUgfHwgY2hhcnROYW1lICE9PSAiU2NhdHRlckNoYXJ0IiAmJiB0b29sdGlwRXZlbnRUeXBlICE9PSAiYXhpcyIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcmVzdFByb3BzLCBjdXJzb3JDb21wLCBwcmVmZXJyZWRaSW5kZXg7CiAgaWYgKGNoYXJ0TmFtZSA9PT0gIlNjYXR0ZXJDaGFydCIpIHsKICAgIHJlc3RQcm9wcyA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgICBjdXJzb3JDb21wID0gQ3Jvc3M7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9IGVsc2UgaWYgKGNoYXJ0TmFtZSA9PT0gIkJhckNoYXJ0IikgewogICAgcmVzdFByb3BzID0gZ2V0Q3Vyc29yUmVjdGFuZ2xlKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0LCB0b29sdGlwQXhpc0JhbmRTaXplKTsKICAgIGN1cnNvckNvbXAgPSBSZWN0YW5nbGU7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yUmVjdGFuZ2xlOwogIH0gZWxzZSBpZiAobGF5b3V0ID09PSAicmFkaWFsIiAmJiBpc1BvbGFyQ29vcmRpbmF0ZShhY3RpdmVDb29yZGluYXRlKSkgewogICAgdmFyIHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9ID0gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpOwogICAgcmVzdFByb3BzID0gewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlLAogICAgICBpbm5lclJhZGl1czogcmFkaXVzLAogICAgICBvdXRlclJhZGl1czogcmFkaXVzCiAgICB9OwogICAgY3Vyc29yQ29tcCA9IFNlY3RvcjsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0gZWxzZSB7CiAgICByZXN0UHJvcHMgPSB7CiAgICAgIHBvaW50czogZ2V0Q3Vyc29yUG9pbnRzKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0KQogICAgfTsKICAgIGN1cnNvckNvbXAgPSBDdXJ2ZTsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0KICB2YXIgZXh0cmFDbGFzc05hbWUgPSB0eXBlb2YgY3Vyc29yID09PSAib2JqZWN0IiAmJiAiY2xhc3NOYW1lIiBpbiBjdXJzb3IgPyBjdXJzb3IuY2xhc3NOYW1lIDogdm9pZCAwOwogIHZhciBjdXJzb3JQcm9wcyA9IF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOSh7CiAgICBzdHJva2U6ICIjY2NjIiwKICAgIHBvaW50ZXJFdmVudHM6ICJub25lIgogIH0sIG9mZnNldCksIHJlc3RQcm9wcyksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGN1cnNvcikpLCB7fSwgewogICAgcGF5bG9hZDogYWN0aXZlUGF5bG9hZCwKICAgIHBheWxvYWRJbmRleDogYWN0aXZlVG9vbHRpcEluZGV4LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy10b29sdGlwLWN1cnNvciIsIGV4dHJhQ2xhc3NOYW1lKQogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IChfcHJvcHMkekluZGV4ID0gcHJvcHMuekluZGV4KSAhPT0gbnVsbCAmJiBfcHJvcHMkekluZGV4ICE9PSB2b2lkIDAgPyBfcHJvcHMkekluZGV4IDogcHJlZmVycmVkWkluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTEuY3JlYXRlRWxlbWVudChSZW5kZXJDdXJzb3IsIHsKICAgIGN1cnNvciwKICAgIGN1cnNvckNvbXAsCiAgICBjdXJzb3JQcm9wcwogIH0pKTsKfQpmdW5jdGlvbiBDdXJzb3IocHJvcHMpIHsKICB2YXIgdG9vbHRpcEF4aXNCYW5kU2l6ZSA9IHVzZVRvb2x0aXBBeGlzQmFuZFNpemUoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgY2hhcnROYW1lID0gdXNlQ2hhcnROYW1lKCk7CiAgaWYgKHRvb2x0aXBBeGlzQmFuZFNpemUgPT0gbnVsbCB8fCBvZmZzZXQgPT0gbnVsbCB8fCBsYXlvdXQgPT0gbnVsbCB8fCBjaGFydE5hbWUgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KEN1cnNvckludGVybmFsLCBfZXh0ZW5kczkoe30sIHByb3BzLCB7CiAgICBvZmZzZXQsCiAgICBsYXlvdXQsCiAgICB0b29sdGlwQXhpc0JhbmRTaXplLAogICAgY2hhcnROYW1lCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvdG9vbHRpcFBvcnRhbENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDIyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgVG9vbHRpcFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIyLmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlVG9vbHRpcFBvcnRhbCA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QyMi51c2VDb250ZXh0KShUb29sdGlwUG9ydGFsQ29udGV4dCk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N5bmNocm9uaXNhdGlvbi91c2VDaGFydFN5bmNocm9uaXNhdGlvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MjMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5tanMKdmFyIGltcG9ydF9pbmRleCA9IF9fdG9FU00ocmVxdWlyZV9ldmVudGVtaXR0ZXIzKCksIDEpOwp2YXIgZXZlbnRlbWl0dGVyM19kZWZhdWx0ID0gaW1wb3J0X2luZGV4LmRlZmF1bHQ7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvRXZlbnRzLmpzCnZhciBldmVudENlbnRlciA9IG5ldyBldmVudGVtaXR0ZXIzX2RlZmF1bHQoKTsKdmFyIFRPT0xUSVBfU1lOQ19FVkVOVCA9ICJyZWNoYXJ0cy5zeW5jRXZlbnQudG9vbHRpcCI7CnZhciBCUlVTSF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC5icnVzaCI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL29wdGlvbnNTbGljZS5qcwpmdW5jdGlvbiBhcnJheVRvb2x0aXBTZWFyY2hlcihkYXRhLCBzdHJJbmRleCkgewogIGlmICghc3RySW5kZXgpIHJldHVybiB2b2lkIDA7CiAgdmFyIG51bUluZGV4ID0gTnVtYmVyLnBhcnNlSW50KHN0ckluZGV4LCAxMCk7CiAgaWYgKGlzTmFuKG51bUluZGV4KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YVtudW1JbmRleF07Cn0KdmFyIGluaXRpYWxTdGF0ZTUgPSB7CiAgY2hhcnROYW1lOiAiIiwKICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiB2b2lkIDAsCiAgZXZlbnRFbWl0dGVyOiB2b2lkIDAsCiAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU6ICJheGlzIgp9Owp2YXIgb3B0aW9uc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJvcHRpb25zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTUsCiAgcmVkdWNlcnM6IHsKICAgIGNyZWF0ZUV2ZW50RW1pdHRlcjogKHN0YXRlKSA9PiB7CiAgICAgIGlmIChzdGF0ZS5ldmVudEVtaXR0ZXIgPT0gbnVsbCkgewogICAgICAgIHN0YXRlLmV2ZW50RW1pdHRlciA9IFN5bWJvbCgicmVjaGFydHNFdmVudEVtaXR0ZXIiKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciBvcHRpb25zUmVkdWNlciA9IG9wdGlvbnNTbGljZS5yZWR1Y2VyOwp2YXIgewogIGNyZWF0ZUV2ZW50RW1pdHRlcgp9ID0gb3B0aW9uc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N5bmNocm9uaXNhdGlvbi9zeW5jU2VsZWN0b3JzLmpzCmZ1bmN0aW9uIHNlbGVjdFN5bmNocm9uaXNlZFRvb2x0aXBTdGF0ZShzdGF0ZSkgewogIHJldHVybiBzdGF0ZS50b29sdGlwLnN5bmNJbnRlcmFjdGlvbjsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9jaGFydERhdGFTbGljZS5qcwp2YXIgaW5pdGlhbENoYXJ0RGF0YVN0YXRlID0gewogIGNoYXJ0RGF0YTogdm9pZCAwLAogIGNvbXB1dGVkRGF0YTogdm9pZCAwLAogIGRhdGFTdGFydEluZGV4OiAwLAogIGRhdGFFbmRJbmRleDogMAp9Owp2YXIgY2hhcnREYXRhU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNoYXJ0RGF0YSIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsQ2hhcnREYXRhU3RhdGUsCiAgcmVkdWNlcnM6IHsKICAgIHNldENoYXJ0RGF0YShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmNoYXJ0RGF0YSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoYWN0aW9uLnBheWxvYWQgPT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gMDsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSAwOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoYWN0aW9uLnBheWxvYWQubGVuZ3RoID4gMCAmJiBzdGF0ZS5kYXRhRW5kSW5kZXggIT09IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDEpIHsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSBhY3Rpb24ucGF5bG9hZC5sZW5ndGggLSAxOwogICAgICB9CiAgICB9LAogICAgc2V0Q29tcHV0ZWREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY29tcHV0ZWREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciB7CiAgICAgICAgc3RhcnRJbmRleCwKICAgICAgICBlbmRJbmRleAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGFydEluZGV4ICE9IG51bGwpIHsKICAgICAgICBzdGF0ZS5kYXRhU3RhcnRJbmRleCA9IHN0YXJ0SW5kZXg7CiAgICAgIH0KICAgICAgaWYgKGVuZEluZGV4ICE9IG51bGwpIHsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSBlbmRJbmRleDsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0Q2hhcnREYXRhLAogIHNldERhdGFTdGFydEVuZEluZGV4ZXMsCiAgc2V0Q29tcHV0ZWREYXRhCn0gPSBjaGFydERhdGFTbGljZS5hY3Rpb25zOwp2YXIgY2hhcnREYXRhUmVkdWNlciA9IGNoYXJ0RGF0YVNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N5bmNocm9uaXNhdGlvbi91c2VDaGFydFN5bmNocm9uaXNhdGlvbi5qcwp2YXIgX2V4Y2x1ZGVkNSA9IFsieCIsICJ5Il07CmZ1bmN0aW9uIG93bktleXMyMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCkgewogIHZhciBteVN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIG15RXZlbnRFbWl0dGVyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBzeW5jTWV0aG9kID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY01ldGhvZCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBjbGFzc05hbWUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5jbGFzc05hbWUpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChteVN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGxpc3RlbmVyMiA9IChpbmNvbWluZ1N5bmNJZCwgYWN0aW9uLCBlbWl0dGVyKSA9PiB7CiAgICAgIGlmIChteUV2ZW50RW1pdHRlciA9PT0gZW1pdHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobXlTeW5jSWQgIT09IGluY29taW5nU3luY0lkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChzeW5jTWV0aG9kID09PSAiaW5kZXgiKSB7CiAgICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZDsKICAgICAgICBpZiAodmlld0JveCAmJiBhY3Rpb24gIT09IG51bGwgJiYgYWN0aW9uICE9PSB2b2lkIDAgJiYgKF9hY3Rpb24kcGF5bG9hZCA9IGFjdGlvbi5wYXlsb2FkKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQgIT09IHZvaWQgMCAmJiBfYWN0aW9uJHBheWxvYWQuY29vcmRpbmF0ZSAmJiBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94KSB7CiAgICAgICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJGNvb3JkID0gYWN0aW9uLnBheWxvYWQuY29vcmRpbmF0ZSwgewogICAgICAgICAgICB4OiBfeCwKICAgICAgICAgICAgeTogX3kKICAgICAgICAgIH0gPSBfYWN0aW9uJHBheWxvYWQkY29vcmQsIG90aGVyQ29vcmRpbmF0ZVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShfYWN0aW9uJHBheWxvYWQkY29vcmQsIF9leGNsdWRlZDUpOwogICAgICAgICAgdmFyIHsKICAgICAgICAgICAgeDogc291cmNlWCwKICAgICAgICAgICAgeTogc291cmNlWSwKICAgICAgICAgICAgd2lkdGg6IHNvdXJjZVdpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHNvdXJjZUhlaWdodAogICAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3g7CiAgICAgICAgICB2YXIgc2NhbGVkQ29vcmRpbmF0ZSA9IF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoe30sIG90aGVyQ29vcmRpbmF0ZVByb3BzKSwge30sIHsKICAgICAgICAgICAgeDogdmlld0JveC54ICsgKHNvdXJjZVdpZHRoID8gKF94IC0gc291cmNlWCkgLyBzb3VyY2VXaWR0aCA6IDApICogdmlld0JveC53aWR0aCwKICAgICAgICAgICAgeTogdmlld0JveC55ICsgKHNvdXJjZUhlaWdodCA/IChfeSAtIHNvdXJjZVkpIC8gc291cmNlSGVpZ2h0IDogMCkgKiB2aWV3Qm94LmhlaWdodAogICAgICAgICAgfSk7CiAgICAgICAgICBkaXNwYXRjaChfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24pLCB7fSwgewogICAgICAgICAgICBwYXlsb2FkOiBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24ucGF5bG9hZCksIHt9LCB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZTogc2NhbGVkQ29vcmRpbmF0ZQogICAgICAgICAgICB9KQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkaXNwYXRjaChhY3Rpb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBhY3RpdmVUaWNrOwogICAgICBpZiAodHlwZW9mIHN5bmNNZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB2YXIgc3luY01ldGhvZFBhcmFtID0gewogICAgICAgICAgYWN0aXZlVG9vbHRpcEluZGV4OiBhY3Rpb24ucGF5bG9hZC5pbmRleCA9PSBudWxsID8gdm9pZCAwIDogTnVtYmVyKGFjdGlvbi5wYXlsb2FkLmluZGV4KSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogYWN0aW9uLnBheWxvYWQuYWN0aXZlLAogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGlvbi5wYXlsb2FkLmluZGV4ID09IG51bGwgPyB2b2lkIDAgOiBOdW1iZXIoYWN0aW9uLnBheWxvYWQuaW5kZXgpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgICAgYWN0aXZlRGF0YUtleTogYWN0aW9uLnBheWxvYWQuZGF0YUtleSwKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGlvbi5wYXlsb2FkLmNvb3JkaW5hdGUKICAgICAgICB9OwogICAgICAgIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBzeW5jTWV0aG9kKHRvb2x0aXBUaWNrcywgc3luY01ldGhvZFBhcmFtKTsKICAgICAgICBhY3RpdmVUaWNrID0gdG9vbHRpcFRpY2tzW2FjdGl2ZVRvb2x0aXBJbmRleF07CiAgICAgIH0gZWxzZSBpZiAoc3luY01ldGhvZCA9PT0gInZhbHVlIikgewogICAgICAgIGFjdGl2ZVRpY2sgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gU3RyaW5nKHRpY2sudmFsdWUpID09PSBhY3Rpb24ucGF5bG9hZC5sYWJlbCk7CiAgICAgIH0KICAgICAgdmFyIHsKICAgICAgICBjb29yZGluYXRlCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKGFjdGl2ZVRpY2sgPT0gbnVsbCB8fCBhY3Rpb24ucGF5bG9hZC5hY3RpdmUgPT09IGZhbHNlIHx8IGNvb3JkaW5hdGUgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwpIHsKICAgICAgICBkaXNwYXRjaChzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgIGluZGV4OiBudWxsLAogICAgICAgICAgbGFiZWw6IHZvaWQgMCwKICAgICAgICAgIHNvdXJjZVZpZXdCb3g6IHZvaWQgMCwKICAgICAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICAgICAgfSkpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgewogICAgICAgIHg6IHgyLAogICAgICAgIHk6IHkyCiAgICAgIH0gPSBjb29yZGluYXRlOwogICAgICB2YXIgdmFsaWRhdGVDaGFydFggPSBNYXRoLm1pbih4Miwgdmlld0JveC54ICsgdmlld0JveC53aWR0aCk7CiAgICAgIHZhciB2YWxpZGF0ZUNoYXJ0WSA9IE1hdGgubWluKHkyLCB2aWV3Qm94LnkgKyB2aWV3Qm94LmhlaWdodCk7CiAgICAgIHZhciBhY3RpdmVDb29yZGluYXRlID0gewogICAgICAgIHg6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gYWN0aXZlVGljay5jb29yZGluYXRlIDogdmFsaWRhdGVDaGFydFgsCiAgICAgICAgeTogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB2YWxpZGF0ZUNoYXJ0WSA6IGFjdGl2ZVRpY2suY29vcmRpbmF0ZQogICAgICB9OwogICAgICB2YXIgc3luY0FjdGlvbiA9IHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiBhY3Rpb24ucGF5bG9hZC5hY3RpdmUsCiAgICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgICBkYXRhS2V5OiBhY3Rpb24ucGF5bG9hZC5kYXRhS2V5LAogICAgICAgIGluZGV4OiBTdHJpbmcoYWN0aXZlVGljay5pbmRleCksCiAgICAgICAgbGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgIHNvdXJjZVZpZXdCb3g6IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3gsCiAgICAgICAgZ3JhcGhpY2FsSXRlbUlkOiBhY3Rpb24ucGF5bG9hZC5ncmFwaGljYWxJdGVtSWQKICAgICAgfSk7CiAgICAgIGRpc3BhdGNoKHN5bmNBY3Rpb24pOwogICAgfTsKICAgIGV2ZW50Q2VudGVyLm9uKFRPT0xUSVBfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihUT09MVElQX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICB9OwogIH0sIFtjbGFzc05hbWUsIGRpc3BhdGNoLCBteUV2ZW50RW1pdHRlciwgbXlTeW5jSWQsIHN5bmNNZXRob2QsIHRvb2x0aXBUaWNrcywgbGF5b3V0LCB2aWV3Qm94XSk7Cn0KZnVuY3Rpb24gdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKSB7CiAgdmFyIG15U3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgbXlFdmVudEVtaXR0ZXIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKG15U3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIyID0gKGluY29taW5nU3luY0lkLCBhY3Rpb24sIGVtaXR0ZXIpID0+IHsKICAgICAgaWYgKG15RXZlbnRFbWl0dGVyID09PSBlbWl0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChteVN5bmNJZCA9PT0gaW5jb21pbmdTeW5jSWQpIHsKICAgICAgICBkaXNwYXRjaChzZXREYXRhU3RhcnRFbmRJbmRleGVzKGFjdGlvbikpOwogICAgICB9CiAgICB9OwogICAgZXZlbnRDZW50ZXIub24oQlJVU0hfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihCUlVTSF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIG15RXZlbnRFbWl0dGVyLCBteVN5bmNJZF0pOwp9CmZ1bmN0aW9uIHVzZVN5bmNocm9uaXNlZEV2ZW50c0Zyb21PdGhlckNoYXJ0cygpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKGNyZWF0ZUV2ZW50RW1pdHRlcigpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCk7CiAgdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKTsKfQpmdW5jdGlvbiB1c2VUb29sdGlwQ2hhcnRTeW5jaHJvbmlzYXRpb24odG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgYWN0aXZlQ29vcmRpbmF0ZSwgYWN0aXZlTGFiZWwsIGFjdGl2ZUluZGV4LCBpc1Rvb2x0aXBBY3RpdmUpIHsKICB2YXIgYWN0aXZlRGF0YUtleSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcERhdGFLZXkoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpKTsKICB2YXIgZXZlbnRFbWl0dGVyU3ltYm9sID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgc3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgc3luY01ldGhvZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNNZXRob2QpOwogIHZhciB0b29sdGlwU3RhdGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUpOwogIHZhciBpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbiA9IHRvb2x0aXBTdGF0ZSA9PT0gbnVsbCB8fCB0b29sdGlwU3RhdGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBTdGF0ZS5hY3RpdmU7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnRFbWl0dGVyU3ltYm9sID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN5bmNBY3Rpb24gPSBzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IGlzVG9vbHRpcEFjdGl2ZSwKICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgZGF0YUtleTogYWN0aXZlRGF0YUtleSwKICAgICAgaW5kZXg6IGFjdGl2ZUluZGV4LAogICAgICBsYWJlbDogdHlwZW9mIGFjdGl2ZUxhYmVsID09PSAibnVtYmVyIiA/IFN0cmluZyhhY3RpdmVMYWJlbCkgOiBhY3RpdmVMYWJlbCwKICAgICAgc291cmNlVmlld0JveDogdmlld0JveCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH0pOwogICAgZXZlbnRDZW50ZXIuZW1pdChUT09MVElQX1NZTkNfRVZFTlQsIHN5bmNJZCwgc3luY0FjdGlvbiwgZXZlbnRFbWl0dGVyU3ltYm9sKTsKICB9LCBbaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24sIGFjdGl2ZUNvb3JkaW5hdGUsIGFjdGl2ZURhdGFLZXksIGFjdGl2ZUluZGV4LCBhY3RpdmVMYWJlbCwgZXZlbnRFbWl0dGVyU3ltYm9sLCBzeW5jSWQsIHN5bmNNZXRob2QsIGlzVG9vbHRpcEFjdGl2ZSwgdmlld0JveF0pOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Ub29sdGlwLmpzCmZ1bmN0aW9uIG93bktleXMyMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIxKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIxKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIxKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIxKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIxKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIxKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIxKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBkZWZhdWx0VW5pcUJ5KGVudHJ5KSB7CiAgcmV0dXJuIGVudHJ5LmRhdGFLZXk7Cn0KZnVuY3Rpb24gcmVuZGVyQ29udGVudChjb250ZW50LCBwcm9wcykgewogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5pc1ZhbGlkRWxlbWVudChjb250ZW50KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNsb25lRWxlbWVudChjb250ZW50LCBwcm9wcyk7CiAgfQogIGlmICh0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoY29udGVudCwgcHJvcHMpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChEZWZhdWx0VG9vbHRpcENvbnRlbnQsIHByb3BzKTsKfQp2YXIgZW1wdHlQYXlsb2FkID0gW107CnZhciBkZWZhdWx0VG9vbHRpcFByb3BzID0gewogIGFsbG93RXNjYXBlVmlld0JveDogewogICAgeDogZmFsc2UsCiAgICB5OiBmYWxzZQogIH0sCiAgYW5pbWF0aW9uRHVyYXRpb246IDQwMCwKICBhbmltYXRpb25FYXNpbmc6ICJlYXNlIiwKICBheGlzSWQ6IDAsCiAgY29udGVudFN0eWxlOiB7fSwKICBjdXJzb3I6IHRydWUsCiAgZmlsdGVyTnVsbDogdHJ1ZSwKICBpc0FuaW1hdGlvbkFjdGl2ZTogImF1dG8iLAogIGl0ZW1Tb3J0ZXI6ICJuYW1lIiwKICBpdGVtU3R5bGU6IHt9LAogIGxhYmVsU3R5bGU6IHt9LAogIG9mZnNldDogMTAsCiAgcmV2ZXJzZURpcmVjdGlvbjogewogICAgeDogZmFsc2UsCiAgICB5OiBmYWxzZQogIH0sCiAgc2VwYXJhdG9yOiAiIDogIiwKICB0cmlnZ2VyOiAiaG92ZXIiLAogIHVzZVRyYW5zbGF0ZTNkOiBmYWxzZSwKICB3cmFwcGVyU3R5bGU6IHt9Cn07CmZ1bmN0aW9uIFRvb2x0aXAob3V0c2lkZVByb3BzKSB7CiAgdmFyIF91c2VBcHBTZWxlY3RvciwgX3JlZjI7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRUb29sdGlwUHJvcHMpOwogIHZhciB7CiAgICBhY3RpdmU6IGFjdGl2ZUZyb21Qcm9wcywKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgY29udGVudCwKICAgIGZpbHRlck51bGwsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIG9mZnNldCwKICAgIHBheWxvYWRVbmlxQnksCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHdyYXBwZXJTdHlsZSwKICAgIGN1cnNvciwKICAgIHNoYXJlZCwKICAgIHRyaWdnZXIsCiAgICBkZWZhdWx0SW5kZXgsCiAgICBwb3J0YWw6IHBvcnRhbEZyb21Qcm9wcywKICAgIGF4aXNJZAogIH0gPSBwcm9wczsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBkZWZhdWx0SW5kZXhBc1N0cmluZyA9IHR5cGVvZiBkZWZhdWx0SW5kZXggPT09ICJudW1iZXIiID8gU3RyaW5nKGRlZmF1bHRJbmRleCkgOiBkZWZhdWx0SW5kZXg7CiAgKDAsIGltcG9ydF9yZWFjdDI0LnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2goc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUoewogICAgICBzaGFyZWQsCiAgICAgIHRyaWdnZXIsCiAgICAgIGF4aXNJZCwKICAgICAgYWN0aXZlOiBhY3RpdmVGcm9tUHJvcHMsCiAgICAgIGRlZmF1bHRJbmRleDogZGVmYXVsdEluZGV4QXNTdHJpbmcKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIHNoYXJlZCwgdHJpZ2dlciwgYXhpc0lkLCBhY3RpdmVGcm9tUHJvcHMsIGRlZmF1bHRJbmRleEFzU3RyaW5nXSk7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgdmFyIGFjY2Vzc2liaWxpdHlMYXllciA9IHVzZUFjY2Vzc2liaWxpdHlMYXllcigpOwogIHZhciB0b29sdGlwRXZlbnRUeXBlID0gdXNlVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQpOwogIHZhciB7CiAgICBhY3RpdmVJbmRleCwKICAgIGlzQWN0aXZlCiAgfSA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdElzVG9vbHRpcEFjdGl2ZTIoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvciAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yIDoge307CiAgdmFyIHBheWxvYWRGcm9tUmVkdXggPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRvb2x0aXBQYXlsb2FkKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpOwogIHZhciBsYWJlbEZyb21SZWR1eCA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QWN0aXZlTGFiZWwyKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpOwogIHZhciBjb29yZGluYXRlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBY3RpdmVDb29yZGluYXRlKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpOwogIHZhciBwYXlsb2FkID0gcGF5bG9hZEZyb21SZWR1eDsKICB2YXIgdG9vbHRpcFBvcnRhbEZyb21Db250ZXh0ID0gdXNlVG9vbHRpcFBvcnRhbCgpOwogIHZhciBmaW5hbElzQWN0aXZlID0gKF9yZWYyID0gYWN0aXZlRnJvbVByb3BzICE9PSBudWxsICYmIGFjdGl2ZUZyb21Qcm9wcyAhPT0gdm9pZCAwID8gYWN0aXZlRnJvbVByb3BzIDogaXNBY3RpdmUpICE9PSBudWxsICYmIF9yZWYyICE9PSB2b2lkIDAgPyBfcmVmMiA6IGZhbHNlOwogIHZhciBbbGFzdEJvdW5kaW5nQm94LCB1cGRhdGVCb3VuZGluZ0JveF0gPSB1c2VFbGVtZW50T2Zmc2V0KFtwYXlsb2FkLCBmaW5hbElzQWN0aXZlXSk7CiAgdmFyIGZpbmFsTGFiZWwgPSB0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIgPyBsYWJlbEZyb21SZWR1eCA6IHZvaWQgMDsKICB1c2VUb29sdGlwQ2hhcnRTeW5jaHJvbmlzYXRpb24odG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgY29vcmRpbmF0ZSwgZmluYWxMYWJlbCwgYWN0aXZlSW5kZXgsIGZpbmFsSXNBY3RpdmUpOwogIHZhciB0b29sdGlwUG9ydGFsID0gcG9ydGFsRnJvbVByb3BzICE9PSBudWxsICYmIHBvcnRhbEZyb21Qcm9wcyAhPT0gdm9pZCAwID8gcG9ydGFsRnJvbVByb3BzIDogdG9vbHRpcFBvcnRhbEZyb21Db250ZXh0OwogIGlmICh0b29sdGlwUG9ydGFsID09IG51bGwgfHwgdmlld0JveCA9PSBudWxsIHx8IHRvb2x0aXBFdmVudFR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBmaW5hbFBheWxvYWQgPSBwYXlsb2FkICE9PSBudWxsICYmIHBheWxvYWQgIT09IHZvaWQgMCA/IHBheWxvYWQgOiBlbXB0eVBheWxvYWQ7CiAgaWYgKCFmaW5hbElzQWN0aXZlKSB7CiAgICBmaW5hbFBheWxvYWQgPSBlbXB0eVBheWxvYWQ7CiAgfQogIGlmIChmaWx0ZXJOdWxsICYmIGZpbmFsUGF5bG9hZC5sZW5ndGgpIHsKICAgIGZpbmFsUGF5bG9hZCA9IGdldFVuaXFQYXlsb2FkKGZpbmFsUGF5bG9hZC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeS52YWx1ZSAhPSBudWxsICYmIChlbnRyeS5oaWRlICE9PSB0cnVlIHx8IHByb3BzLmluY2x1ZGVIaWRkZW4pKSwgcGF5bG9hZFVuaXFCeSwgZGVmYXVsdFVuaXFCeSk7CiAgfQogIHZhciBoYXNQYXlsb2FkID0gZmluYWxQYXlsb2FkLmxlbmd0aCA+IDA7CiAgdmFyIHRvb2x0aXBFbGVtZW50ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChUb29sdGlwQm91bmRpbmdCb3gsIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBhY3RpdmU6IGZpbmFsSXNBY3RpdmUsCiAgICBjb29yZGluYXRlLAogICAgaGFzUGF5bG9hZCwKICAgIG9mZnNldCwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgdmlld0JveCwKICAgIHdyYXBwZXJTdHlsZSwKICAgIGxhc3RCb3VuZGluZ0JveCwKICAgIGlubmVyUmVmOiB1cGRhdGVCb3VuZGluZ0JveCwKICAgIGhhc1BvcnRhbEZyb21Qcm9wczogQm9vbGVhbihwb3J0YWxGcm9tUHJvcHMpCiAgfSwgcmVuZGVyQ29udGVudChjb250ZW50LCBfb2JqZWN0U3ByZWFkMjEoX29iamVjdFNwcmVhZDIxKHt9LCBwcm9wcyksIHt9LCB7CiAgICBwYXlsb2FkOiBmaW5hbFBheWxvYWQsCiAgICBsYWJlbDogZmluYWxMYWJlbCwKICAgIGFjdGl2ZTogZmluYWxJc0FjdGl2ZSwKICAgIGFjdGl2ZUluZGV4LAogICAgY29vcmRpbmF0ZSwKICAgIGFjY2Vzc2liaWxpdHlMYXllcgogIH0pKSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoUmVhY3QxMi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3RfZG9tMi5jcmVhdGVQb3J0YWwpKHRvb2x0aXBFbGVtZW50LCB0b29sdGlwUG9ydGFsKSwgZmluYWxJc0FjdGl2ZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KEN1cnNvciwgewogICAgY3Vyc29yLAogICAgdG9vbHRpcEV2ZW50VHlwZSwKICAgIGNvb3JkaW5hdGUsCiAgICBwYXlsb2FkOiBmaW5hbFBheWxvYWQsCiAgICBpbmRleDogYWN0aXZlSW5kZXgKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1RleHQuanMKdmFyIFJlYWN0MTMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9MUlVDYWNoZS5qcwpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgTFJVQ2FjaGUgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IobWF4U2l6ZSkgewogICAgX2RlZmluZVByb3BlcnR5MjIodGhpcywgImNhY2hlIiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSk7CiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplOwogIH0KICBnZXQoa2V5KSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLmNhY2hlLmdldChrZXkpOwogICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHNldChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5jYWNoZS5oYXMoa2V5KSkgewogICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpOwogICAgfSBlbHNlIGlmICh0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7CiAgICAgIHZhciBmaXJzdEtleSA9IHRoaXMuY2FjaGUua2V5cygpLm5leHQoKS52YWx1ZTsKICAgICAgaWYgKGZpcnN0S2V5ICE9IG51bGwpIHsKICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShmaXJzdEtleSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogIH0KICBjbGVhcigpIHsKICAgIHRoaXMuY2FjaGUuY2xlYXIoKTsKICB9CiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmNhY2hlLnNpemU7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0RPTVV0aWxzLmpzCmZ1bmN0aW9uIG93bktleXMyMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZGVmYXVsdENvbmZpZyA9IHsKICBjYWNoZVNpemU6IDJlMywKICBlbmFibGVDYWNoZTogdHJ1ZQp9Owp2YXIgY3VycmVudENvbmZpZyA9IF9vYmplY3RTcHJlYWQyMih7fSwgZGVmYXVsdENvbmZpZyk7CnZhciBzdHJpbmdDYWNoZSA9IG5ldyBMUlVDYWNoZShjdXJyZW50Q29uZmlnLmNhY2hlU2l6ZSk7CnZhciBTUEFOX1NUWUxFID0gewogIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogIHRvcDogIi0yMDAwMHB4IiwKICBsZWZ0OiAwLAogIHBhZGRpbmc6IDAsCiAgbWFyZ2luOiAwLAogIGJvcmRlcjogIm5vbmUiLAogIHdoaXRlU3BhY2U6ICJwcmUiCn07CnZhciBNRUFTVVJFTUVOVF9TUEFOX0lEID0gInJlY2hhcnRzX21lYXN1cmVtZW50X3NwYW4iOwpmdW5jdGlvbiBjcmVhdGVDYWNoZUtleSh0ZXh0LCBzdHlsZSkgewogIHZhciBmb250U2l6ZSA9IHN0eWxlLmZvbnRTaXplIHx8ICIiOwogIHZhciBmb250RmFtaWx5ID0gc3R5bGUuZm9udEZhbWlseSB8fCAiIjsKICB2YXIgZm9udFdlaWdodCA9IHN0eWxlLmZvbnRXZWlnaHQgfHwgIiI7CiAgdmFyIGZvbnRTdHlsZSA9IHN0eWxlLmZvbnRTdHlsZSB8fCAiIjsKICB2YXIgbGV0dGVyU3BhY2luZyA9IHN0eWxlLmxldHRlclNwYWNpbmcgfHwgIiI7CiAgdmFyIHRleHRUcmFuc2Zvcm0gPSBzdHlsZS50ZXh0VHJhbnNmb3JtIHx8ICIiOwogIHJldHVybiAiIi5jb25jYXQodGV4dCwgInwiKS5jb25jYXQoZm9udFNpemUsICJ8IikuY29uY2F0KGZvbnRGYW1pbHksICJ8IikuY29uY2F0KGZvbnRXZWlnaHQsICJ8IikuY29uY2F0KGZvbnRTdHlsZSwgInwiKS5jb25jYXQobGV0dGVyU3BhY2luZywgInwiKS5jb25jYXQodGV4dFRyYW5zZm9ybSk7Cn0KdmFyIG1lYXN1cmVUZXh0V2l0aERPTSA9ICh0ZXh0LCBzdHlsZSkgPT4gewogIHRyeSB7CiAgICB2YXIgbWVhc3VyZW1lbnRTcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoTUVBU1VSRU1FTlRfU1BBTl9JRCk7CiAgICBpZiAoIW1lYXN1cmVtZW50U3BhbikgewogICAgICBtZWFzdXJlbWVudFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgIG1lYXN1cmVtZW50U3Bhbi5zZXRBdHRyaWJ1dGUoImlkIiwgTUVBU1VSRU1FTlRfU1BBTl9JRCk7CiAgICAgIG1lYXN1cmVtZW50U3Bhbi5zZXRBdHRyaWJ1dGUoImFyaWEtaGlkZGVuIiwgInRydWUiKTsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChtZWFzdXJlbWVudFNwYW4pOwogICAgfQogICAgT2JqZWN0LmFzc2lnbihtZWFzdXJlbWVudFNwYW4uc3R5bGUsIFNQQU5fU1RZTEUsIHN0eWxlKTsKICAgIG1lYXN1cmVtZW50U3Bhbi50ZXh0Q29udGVudCA9ICIiLmNvbmNhdCh0ZXh0KTsKICAgIHZhciByZWN0ID0gbWVhc3VyZW1lbnRTcGFuLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgcmV0dXJuIHsKICAgICAgd2lkdGg6IHJlY3Qud2lkdGgsCiAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQKICAgIH07CiAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgcmV0dXJuIHsKICAgICAgd2lkdGg6IDAsCiAgICAgIGhlaWdodDogMAogICAgfTsKICB9Cn07CnZhciBnZXRTdHJpbmdTaXplID0gZnVuY3Rpb24gZ2V0U3RyaW5nU2l6ZTIodGV4dCkgewogIHZhciBzdHlsZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDoge307CiAgaWYgKHRleHQgPT09IHZvaWQgMCB8fCB0ZXh0ID09PSBudWxsIHx8IEdsb2JhbC5pc1NzcikgewogICAgcmV0dXJuIHsKICAgICAgd2lkdGg6IDAsCiAgICAgIGhlaWdodDogMAogICAgfTsKICB9CiAgaWYgKCFjdXJyZW50Q29uZmlnLmVuYWJsZUNhY2hlKSB7CiAgICByZXR1cm4gbWVhc3VyZVRleHRXaXRoRE9NKHRleHQsIHN0eWxlKTsKICB9CiAgdmFyIGNhY2hlS2V5ID0gY3JlYXRlQ2FjaGVLZXkodGV4dCwgc3R5bGUpOwogIHZhciBjYWNoZWRSZXN1bHQgPSBzdHJpbmdDYWNoZS5nZXQoY2FjaGVLZXkpOwogIGlmIChjYWNoZWRSZXN1bHQpIHsKICAgIHJldHVybiBjYWNoZWRSZXN1bHQ7CiAgfQogIHZhciByZXN1bHQgPSBtZWFzdXJlVGV4dFdpdGhET00odGV4dCwgc3R5bGUpOwogIHN0cmluZ0NhY2hlLnNldChjYWNoZUtleSwgcmVzdWx0KTsKICByZXR1cm4gcmVzdWx0Owp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1JlZHVjZUNTU0NhbGMuanMKdmFyIE1VTFRJUExZX09SX0RJVklERV9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikoWyovXSkoLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikvOwp2YXIgQUREX09SX1NVQlRSQUNUX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKShbKy1dKSgtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKS87CnZhciBDU1NfTEVOR1RIX1VOSVRfUkVHRVggPSAvXnB4fGNtfHZofHZ3fGVtfHJlbXwlfG1tfGlufHB0fHBjfGV4fGNofHZtaW58dm1heHxRJC87CnZhciBOVU1fU1BMSVRfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspPykoW2EtekEtWiVdKyk/LzsKdmFyIENPTlZFUlNJT05fUkFURVMgPSB7CiAgY206IDk2IC8gMi41NCwKICBtbTogOTYgLyAyNS40LAogIHB0OiA5NiAvIDcyLAogIHBjOiA5NiAvIDYsCiAgaW46IDk2LAogIFE6IDk2IC8gKDIuNTQgKiA0MCksCiAgcHg6IDEKfTsKdmFyIEZJWEVEX0NTU19MRU5HVEhfVU5JVFMgPSBPYmplY3Qua2V5cyhDT05WRVJTSU9OX1JBVEVTKTsKdmFyIFNUUl9OQU4gPSAiTmFOIjsKZnVuY3Rpb24gY29udmVydFRvUHgodmFsdWUsIHVuaXQyKSB7CiAgcmV0dXJuIHZhbHVlICogQ09OVkVSU0lPTl9SQVRFU1t1bml0Ml07Cn0KdmFyIERlY2ltYWxDU1MgPSBjbGFzcyBfRGVjaW1hbENTUyB7CiAgc3RhdGljIHBhcnNlKHN0cikgewogICAgdmFyIF9OVU1fU1BMSVRfUkVHRVgkZXhlYzsKICAgIHZhciBbLCBudW1TdHIsIHVuaXQyXSA9IChfTlVNX1NQTElUX1JFR0VYJGV4ZWMgPSBOVU1fU1BMSVRfUkVHRVguZXhlYyhzdHIpKSAhPT0gbnVsbCAmJiBfTlVNX1NQTElUX1JFR0VYJGV4ZWMgIT09IHZvaWQgMCA/IF9OVU1fU1BMSVRfUkVHRVgkZXhlYyA6IFtdOwogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhwYXJzZUZsb2F0KG51bVN0ciksIHVuaXQyICE9PSBudWxsICYmIHVuaXQyICE9PSB2b2lkIDAgPyB1bml0MiA6ICIiKTsKICB9CiAgY29uc3RydWN0b3IobnVtLCB1bml0MikgewogICAgdGhpcy5udW0gPSBudW07CiAgICB0aGlzLnVuaXQgPSB1bml0MjsKICAgIHRoaXMubnVtID0gbnVtOwogICAgdGhpcy51bml0ID0gdW5pdDI7CiAgICBpZiAoaXNOYW4obnVtKSkgewogICAgICB0aGlzLnVuaXQgPSAiIjsKICAgIH0KICAgIGlmICh1bml0MiAhPT0gIiIgJiYgIUNTU19MRU5HVEhfVU5JVF9SRUdFWC50ZXN0KHVuaXQyKSkgewogICAgICB0aGlzLm51bSA9IE5hTjsKICAgICAgdGhpcy51bml0ID0gIiI7CiAgICB9CiAgICBpZiAoRklYRURfQ1NTX0xFTkdUSF9VTklUUy5pbmNsdWRlcyh1bml0MikpIHsKICAgICAgdGhpcy5udW0gPSBjb252ZXJ0VG9QeChudW0sIHVuaXQyKTsKICAgICAgdGhpcy51bml0ID0gInB4IjsKICAgIH0KICB9CiAgYWRkKG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtICsgb3RoZXIubnVtLCB0aGlzLnVuaXQpOwogIH0KICBzdWJ0cmFjdChvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAtIG90aGVyLm51bSwgdGhpcy51bml0KTsKICB9CiAgbXVsdGlwbHkob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09ICIiICYmIG90aGVyLnVuaXQgIT09ICIiICYmIHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAqIG90aGVyLm51bSwgdGhpcy51bml0IHx8IG90aGVyLnVuaXQpOwogIH0KICBkaXZpZGUob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09ICIiICYmIG90aGVyLnVuaXQgIT09ICIiICYmIHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAvIG90aGVyLm51bSwgdGhpcy51bml0IHx8IG90aGVyLnVuaXQpOwogIH0KICB0b1N0cmluZygpIHsKICAgIHJldHVybiAiIi5jb25jYXQodGhpcy5udW0pLmNvbmNhdCh0aGlzLnVuaXQpOwogIH0KICBpc05hTigpIHsKICAgIHJldHVybiBpc05hbih0aGlzLm51bSk7CiAgfQp9OwpmdW5jdGlvbiBjYWxjdWxhdGVBcml0aG1ldGljKGV4cHIpIHsKICBpZiAoZXhwci5pbmNsdWRlcyhTVFJfTkFOKSkgewogICAgcmV0dXJuIFNUUl9OQU47CiAgfQogIHZhciBuZXdFeHByID0gZXhwcjsKICB3aGlsZSAobmV3RXhwci5pbmNsdWRlcygiKiIpIHx8IG5ld0V4cHIuaW5jbHVkZXMoIi8iKSkgewogICAgdmFyIF9NVUxUSVBMWV9PUl9ESVZJREVfUjsKICAgIHZhciBbLCBsZWZ0T3BlcmFuZCwgb3BlcmF0b3IsIHJpZ2h0T3BlcmFuZF0gPSAoX01VTFRJUExZX09SX0RJVklERV9SID0gTVVMVElQTFlfT1JfRElWSURFX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9PSBudWxsICYmIF9NVUxUSVBMWV9PUl9ESVZJREVfUiAhPT0gdm9pZCAwID8gX01VTFRJUExZX09SX0RJVklERV9SIDogW107CiAgICB2YXIgbFRzID0gRGVjaW1hbENTUy5wYXJzZShsZWZ0T3BlcmFuZCAhPT0gbnVsbCAmJiBsZWZ0T3BlcmFuZCAhPT0gdm9pZCAwID8gbGVmdE9wZXJhbmQgOiAiIik7CiAgICB2YXIgclRzID0gRGVjaW1hbENTUy5wYXJzZShyaWdodE9wZXJhbmQgIT09IG51bGwgJiYgcmlnaHRPcGVyYW5kICE9PSB2b2lkIDAgPyByaWdodE9wZXJhbmQgOiAiIik7CiAgICB2YXIgcmVzdWx0ID0gb3BlcmF0b3IgPT09ICIqIiA/IGxUcy5tdWx0aXBseShyVHMpIDogbFRzLmRpdmlkZShyVHMpOwogICAgaWYgKHJlc3VsdC5pc05hTigpKSB7CiAgICAgIHJldHVybiBTVFJfTkFOOwogICAgfQogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVgsIHJlc3VsdC50b1N0cmluZygpKTsKICB9CiAgd2hpbGUgKG5ld0V4cHIuaW5jbHVkZXMoIisiKSB8fCAvLi1cZCsoPzpcLlxkKyk/Ly50ZXN0KG5ld0V4cHIpKSB7CiAgICB2YXIgX0FERF9PUl9TVUJUUkFDVF9SRUdFOwogICAgdmFyIFssIF9sZWZ0T3BlcmFuZCwgX29wZXJhdG9yLCBfcmlnaHRPcGVyYW5kXSA9IChfQUREX09SX1NVQlRSQUNUX1JFR0UgPSBBRERfT1JfU1VCVFJBQ1RfUkVHRVguZXhlYyhuZXdFeHByKSkgIT09IG51bGwgJiYgX0FERF9PUl9TVUJUUkFDVF9SRUdFICE9PSB2b2lkIDAgPyBfQUREX09SX1NVQlRSQUNUX1JFR0UgOiBbXTsKICAgIHZhciBfbFRzID0gRGVjaW1hbENTUy5wYXJzZShfbGVmdE9wZXJhbmQgIT09IG51bGwgJiYgX2xlZnRPcGVyYW5kICE9PSB2b2lkIDAgPyBfbGVmdE9wZXJhbmQgOiAiIik7CiAgICB2YXIgX3JUcyA9IERlY2ltYWxDU1MucGFyc2UoX3JpZ2h0T3BlcmFuZCAhPT0gbnVsbCAmJiBfcmlnaHRPcGVyYW5kICE9PSB2b2lkIDAgPyBfcmlnaHRPcGVyYW5kIDogIiIpOwogICAgdmFyIF9yZXN1bHQgPSBfb3BlcmF0b3IgPT09ICIrIiA/IF9sVHMuYWRkKF9yVHMpIDogX2xUcy5zdWJ0cmFjdChfclRzKTsKICAgIGlmIChfcmVzdWx0LmlzTmFOKCkpIHsKICAgICAgcmV0dXJuIFNUUl9OQU47CiAgICB9CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKEFERF9PUl9TVUJUUkFDVF9SRUdFWCwgX3Jlc3VsdC50b1N0cmluZygpKTsKICB9CiAgcmV0dXJuIG5ld0V4cHI7Cn0KdmFyIFBBUkVOVEhFU0VTX1JFR0VYID0gL1woKFteKCldKilcKS87CmZ1bmN0aW9uIGNhbGN1bGF0ZVBhcmVudGhlc2VzKGV4cHIpIHsKICB2YXIgbmV3RXhwciA9IGV4cHI7CiAgdmFyIG1hdGNoOwogIHdoaWxlICgobWF0Y2ggPSBQQVJFTlRIRVNFU19SRUdFWC5leGVjKG5ld0V4cHIpKSAhPSBudWxsKSB7CiAgICB2YXIgWywgcGFyZW50aGV0aWNhbEV4cHJlc3Npb25dID0gbWF0Y2g7CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKFBBUkVOVEhFU0VTX1JFR0VYLCBjYWxjdWxhdGVBcml0aG1ldGljKHBhcmVudGhldGljYWxFeHByZXNzaW9uKSk7CiAgfQogIHJldHVybiBuZXdFeHByOwp9CmZ1bmN0aW9uIGV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKSB7CiAgdmFyIG5ld0V4cHIgPSBleHByZXNzaW9uLnJlcGxhY2UoL1xzKy9nLCAiIik7CiAgbmV3RXhwciA9IGNhbGN1bGF0ZVBhcmVudGhlc2VzKG5ld0V4cHIpOwogIG5ld0V4cHIgPSBjYWxjdWxhdGVBcml0aG1ldGljKG5ld0V4cHIpOwogIHJldHVybiBuZXdFeHByOwp9CmZ1bmN0aW9uIHNhZmVFdmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbikgewogIHRyeSB7CiAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pOwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiBTVFJfTkFOOwogIH0KfQpmdW5jdGlvbiByZWR1Y2VDU1NDYWxjKGV4cHJlc3Npb24pIHsKICB2YXIgcmVzdWx0ID0gc2FmZUV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uLnNsaWNlKDUsIC0xKSk7CiAgaWYgKHJlc3VsdCA9PT0gU1RSX05BTikgewogICAgcmV0dXJuICIiOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9UZXh0LmpzCnZhciBfZXhjbHVkZWQ2ID0gWyJ4IiwgInkiLCAibGluZUhlaWdodCIsICJjYXBIZWlnaHQiLCAiZmlsbCIsICJzY2FsZVRvRml0IiwgInRleHRBbmNob3IiLCAidmVydGljYWxBbmNob3IiXTsKdmFyIF9leGNsdWRlZDIzID0gWyJkeCIsICJkeSIsICJhbmdsZSIsICJjbGFzc05hbWUiLCAiYnJlYWtBbGwiXTsKZnVuY3Rpb24gX2V4dGVuZHMxMCgpIHsKICByZXR1cm4gX2V4dGVuZHMxMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQlJFQUtJTkdfU1BBQ0VTID0gL1sgXGZcblxyXHRcdlx1MjAyOFx1MjAyOV0rLzsKdmFyIGNhbGN1bGF0ZVdvcmRXaWR0aHMgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBicmVha0FsbCwKICAgIHN0eWxlCiAgfSA9IF9yZWYyOwogIHRyeSB7CiAgICB2YXIgd29yZHMgPSBbXTsKICAgIGlmICghaXNOdWxsaXNoKGNoaWxkcmVuKSkgewogICAgICBpZiAoYnJlYWtBbGwpIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdvcmRzID0gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpOwogICAgICB9CiAgICB9CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdvcmRzLm1hcCgod29yZCkgPT4gKHsKICAgICAgd29yZCwKICAgICAgd2lkdGg6IGdldFN0cmluZ1NpemUod29yZCwgc3R5bGUpLndpZHRoCiAgICB9KSk7CiAgICB2YXIgc3BhY2VXaWR0aCA9IGJyZWFrQWxsID8gMCA6IGdldFN0cmluZ1NpemUoIlx4QTAiLCBzdHlsZSkud2lkdGg7CiAgICByZXR1cm4gewogICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLAogICAgICBzcGFjZVdpZHRoCiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKZnVuY3Rpb24gaXNWYWxpZFRleHRBbmNob3IodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgPT09ICJzdGFydCIgfHwgdmFsdWUgPT09ICJtaWRkbGUiIHx8IHZhbHVlID09PSAiZW5kIiB8fCB2YWx1ZSA9PT0gImluaGVyaXQiOwp9CnZhciBjYWxjdWxhdGUgPSAod29yZHMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gd29yZHMucmVkdWNlKChyZXN1bHQsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHdvcmQsCiAgICB3aWR0aAogIH0gPSBfcmVmMjsKICB2YXIgY3VycmVudExpbmUgPSByZXN1bHRbcmVzdWx0Lmxlbmd0aCAtIDFdOwogIGlmIChjdXJyZW50TGluZSAmJiB3aWR0aCAhPSBudWxsICYmIChsaW5lV2lkdGggPT0gbnVsbCB8fCBzY2FsZVRvRml0IHx8IGN1cnJlbnRMaW5lLndpZHRoICsgd2lkdGggKyBzcGFjZVdpZHRoIDwgTnVtYmVyKGxpbmVXaWR0aCkpKSB7CiAgICBjdXJyZW50TGluZS53b3Jkcy5wdXNoKHdvcmQpOwogICAgY3VycmVudExpbmUud2lkdGggKz0gd2lkdGggKyBzcGFjZVdpZHRoOwogIH0gZWxzZSB7CiAgICB2YXIgbmV3TGluZSA9IHsKICAgICAgd29yZHM6IFt3b3JkXSwKICAgICAgd2lkdGgKICAgIH07CiAgICByZXN1bHQucHVzaChuZXdMaW5lKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfSwgW10pOwp2YXIgZmluZExvbmdlc3RMaW5lID0gKHdvcmRzKSA9PiB3b3Jkcy5yZWR1Y2UoKGEsIGIpID0+IGEud2lkdGggPiBiLndpZHRoID8gYSA6IGIpOwp2YXIgc3VmZml4ID0gIlx1MjAyNiI7CnZhciBjaGVja092ZXJmbG93ID0gKHRleHQsIGluZGV4LCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgdGVtcFRleHQgPSB0ZXh0LnNsaWNlKDAsIGluZGV4KTsKICB2YXIgd29yZHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgIGJyZWFrQWxsLAogICAgc3R5bGUsCiAgICBjaGlsZHJlbjogdGVtcFRleHQgKyBzdWZmaXgKICB9KTsKICBpZiAoIXdvcmRzKSB7CiAgICByZXR1cm4gW2ZhbHNlLCBbXV07CiAgfQogIHZhciByZXN1bHQgPSBjYWxjdWxhdGUod29yZHMud29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICB2YXIgZG9lc092ZXJmbG93ID0gcmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShyZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgcmV0dXJuIFtkb2VzT3ZlcmZsb3csIHJlc3VsdF07Cn07CnZhciBjYWxjdWxhdGVXb3Jkc0J5TGluZXMgPSAoX3JlZjMsIGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIHNwYWNlV2lkdGgsIGxpbmVXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gewogIHZhciB7CiAgICBtYXhMaW5lcywKICAgIGNoaWxkcmVuLAogICAgc3R5bGUsCiAgICBicmVha0FsbAogIH0gPSBfcmVmMzsKICB2YXIgc2hvdWxkTGltaXRMaW5lcyA9IGlzTnVtYmVyKG1heExpbmVzKTsKICB2YXIgdGV4dCA9IFN0cmluZyhjaGlsZHJlbik7CiAgdmFyIG9yaWdpbmFsUmVzdWx0ID0gY2FsY3VsYXRlKGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgaWYgKCFzaG91bGRMaW1pdExpbmVzIHx8IHNjYWxlVG9GaXQpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIG92ZXJmbG93cyA9IG9yaWdpbmFsUmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShvcmlnaW5hbFJlc3VsdCkud2lkdGggPiBOdW1iZXIobGluZVdpZHRoKTsKICBpZiAoIW92ZXJmbG93cykgewogICAgcmV0dXJuIG9yaWdpbmFsUmVzdWx0OwogIH0KICB2YXIgc3RhcnQgPSAwOwogIHZhciBlbmQgPSB0ZXh0Lmxlbmd0aCAtIDE7CiAgdmFyIGl0ZXJhdGlvbnMgPSAwOwogIHZhciB0cmltbWVkUmVzdWx0OwogIHdoaWxlIChzdGFydCA8PSBlbmQgJiYgaXRlcmF0aW9ucyA8PSB0ZXh0Lmxlbmd0aCAtIDEpIHsKICAgIHZhciBtaWRkbGUgPSBNYXRoLmZsb29yKChzdGFydCArIGVuZCkgLyAyKTsKICAgIHZhciBwcmV2ID0gbWlkZGxlIC0gMTsKICAgIHZhciBbZG9lc1ByZXZPdmVyZmxvdywgcmVzdWx0XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgcHJldiwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIHZhciBbZG9lc01pZGRsZU92ZXJmbG93XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgbWlkZGxlLCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmICFkb2VzTWlkZGxlT3ZlcmZsb3cpIHsKICAgICAgc3RhcnQgPSBtaWRkbGUgKyAxOwogICAgfQogICAgaWYgKGRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIGVuZCA9IG1pZGRsZSAtIDE7CiAgICB9CiAgICBpZiAoIWRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHRyaW1tZWRSZXN1bHQgPSByZXN1bHQ7CiAgICAgIGJyZWFrOwogICAgfQogICAgaXRlcmF0aW9ucysrOwogIH0KICByZXR1cm4gdHJpbW1lZFJlc3VsdCB8fCBvcmlnaW5hbFJlc3VsdDsKfTsKdmFyIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZSA9IChjaGlsZHJlbikgPT4gewogIHZhciB3b3JkcyA9ICFpc051bGxpc2goY2hpbGRyZW4pID8gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpIDogW107CiAgcmV0dXJuIFt7CiAgICB3b3JkcywKICAgIHdpZHRoOiB2b2lkIDAKICB9XTsKfTsKdmFyIGdldFdvcmRzQnlMaW5lcyA9IChfcmVmNCkgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIHNjYWxlVG9GaXQsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwsCiAgICBtYXhMaW5lcwogIH0gPSBfcmVmNDsKICBpZiAoKHdpZHRoIHx8IHNjYWxlVG9GaXQpICYmICFHbG9iYWwuaXNTc3IpIHsKICAgIHZhciB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoOwogICAgdmFyIHdvcmRXaWR0aHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBzdHlsZQogICAgfSk7CiAgICBpZiAod29yZFdpZHRocykgewogICAgICB2YXIgewogICAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGg6IHdjdywKICAgICAgICBzcGFjZVdpZHRoOiBzdwogICAgICB9ID0gd29yZFdpZHRoczsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdjdzsKICAgICAgc3BhY2VXaWR0aCA9IHN3OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7CiAgICB9CiAgICByZXR1cm4gY2FsY3VsYXRlV29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBtYXhMaW5lcywKICAgICAgc3R5bGUKICAgIH0sIHdvcmRzV2l0aENvbXB1dGVkV2lkdGgsIHNwYWNlV2lkdGgsIHdpZHRoLCBCb29sZWFuKHNjYWxlVG9GaXQpKTsKICB9CiAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7Cn07CnZhciBERUZBVUxUX0ZJTEwgPSAiIzgwODA4MCI7CnZhciB0ZXh0RGVmYXVsdFByb3BzID0gewogIGFuZ2xlOiAwLAogIGJyZWFrQWxsOiBmYWxzZSwKICAvLyBNYWdpYyBudW1iZXIgZnJvbSBkMwogIGNhcEhlaWdodDogIjAuNzFlbSIsCiAgZmlsbDogREVGQVVMVF9GSUxMLAogIGxpbmVIZWlnaHQ6ICIxZW0iLAogIHNjYWxlVG9GaXQ6IGZhbHNlLAogIHRleHRBbmNob3I6ICJzdGFydCIsCiAgLy8gTWFpbnRhaW4gY29tcGF0IHdpdGggZXhpc3RpbmcgY2hhcnRzIC8gZGVmYXVsdCBTVkcgYmVoYXZpb3IKICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIsCiAgeDogMCwKICB5OiAwCn07CnZhciBUZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNS5mb3J3YXJkUmVmKSgob3V0c2lkZVByb3BzLCByZWYpID0+IHsKICB2YXIgX3Jlc29sdmVEZWZhdWx0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgdGV4dERlZmF1bHRQcm9wcyksIHsKICAgIHg6IHByb3BzWCwKICAgIHk6IHByb3BzWSwKICAgIGxpbmVIZWlnaHQsCiAgICBjYXBIZWlnaHQsCiAgICBmaWxsLAogICAgc2NhbGVUb0ZpdCwKICAgIHRleHRBbmNob3IsCiAgICB2ZXJ0aWNhbEFuY2hvcgogIH0gPSBfcmVzb2x2ZURlZmF1bHRQcm9wcywgcHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KF9yZXNvbHZlRGVmYXVsdFByb3BzLCBfZXhjbHVkZWQ2KTsKICB2YXIgd29yZHNCeUxpbmVzID0gKDAsIGltcG9ydF9yZWFjdDI1LnVzZU1lbW8pKCgpID0+IHsKICAgIHJldHVybiBnZXRXb3Jkc0J5TGluZXMoewogICAgICBicmVha0FsbDogcHJvcHMuYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuOiBwcm9wcy5jaGlsZHJlbiwKICAgICAgbWF4TGluZXM6IHByb3BzLm1heExpbmVzLAogICAgICBzY2FsZVRvRml0LAogICAgICBzdHlsZTogcHJvcHMuc3R5bGUsCiAgICAgIHdpZHRoOiBwcm9wcy53aWR0aAogICAgfSk7CiAgfSwgW3Byb3BzLmJyZWFrQWxsLCBwcm9wcy5jaGlsZHJlbiwgcHJvcHMubWF4TGluZXMsIHNjYWxlVG9GaXQsIHByb3BzLnN0eWxlLCBwcm9wcy53aWR0aF0pOwogIHZhciB7CiAgICBkeCwKICAgIGR5LAogICAgYW5nbGUsCiAgICBjbGFzc05hbWUsCiAgICBicmVha0FsbAogIH0gPSBwcm9wcywgdGV4dFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihwcm9wcywgX2V4Y2x1ZGVkMjMpOwogIGlmICghaXNOdW1PclN0cihwcm9wc1gpIHx8ICFpc051bU9yU3RyKHByb3BzWSkgfHwgd29yZHNCeUxpbmVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB4MiA9IE51bWJlcihwcm9wc1gpICsgKGlzTnVtYmVyKGR4KSA/IGR4IDogMCk7CiAgdmFyIHkyID0gTnVtYmVyKHByb3BzWSkgKyAoaXNOdW1iZXIoZHkpID8gZHkgOiAwKTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoeDIpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKHkyKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBzdGFydER5OwogIHN3aXRjaCAodmVydGljYWxBbmNob3IpIHsKICAgIGNhc2UgInN0YXJ0IjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoY2FwSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJtaWRkbGUiOgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCgod29yZHNCeUxpbmVzLmxlbmd0aCAtIDEpIC8gMiwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIiArICgiKS5jb25jYXQoY2FwSGVpZ2h0LCAiIC8gMikpIikpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxLCAiICogLSIpLmNvbmNhdChsaW5lSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgfQogIHZhciB0cmFuc2Zvcm1zID0gW107CiAgaWYgKHNjYWxlVG9GaXQpIHsKICAgIHZhciBsaW5lV2lkdGggPSB3b3Jkc0J5TGluZXNbMF0ud2lkdGg7CiAgICB2YXIgewogICAgICB3aWR0aAogICAgfSA9IHByb3BzOwogICAgdHJhbnNmb3Jtcy5wdXNoKCJzY2FsZSgiLmNvbmNhdChpc051bWJlcih3aWR0aCkgJiYgaXNOdW1iZXIobGluZVdpZHRoKSA/IHdpZHRoIC8gbGluZVdpZHRoIDogMSwgIikiKSk7CiAgfQogIGlmIChhbmdsZSkgewogICAgdHJhbnNmb3Jtcy5wdXNoKCJyb3RhdGUoIi5jb25jYXQoYW5nbGUsICIsICIpLmNvbmNhdCh4MiwgIiwgIikuY29uY2F0KHkyLCAiKSIpKTsKICB9CiAgaWYgKHRyYW5zZm9ybXMubGVuZ3RoKSB7CiAgICB0ZXh0UHJvcHMudHJhbnNmb3JtID0gdHJhbnNmb3Jtcy5qb2luKCIgIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyh0ZXh0UHJvcHMpLCB7CiAgICByZWYsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy10ZXh0IiwgY2xhc3NOYW1lKSwKICAgIHRleHRBbmNob3IsCiAgICBmaWxsOiBmaWxsLmluY2x1ZGVzKCJ1cmwiKSA/IERFRkFVTFRfRklMTCA6IGZpbGwKICB9KSwgd29yZHNCeUxpbmVzLm1hcCgobGluZSwgaW5kZXgpID0+IHsKICAgIHZhciB3b3JkcyA9IGxpbmUud29yZHMuam9pbihicmVha0FsbCA/ICIiIDogIiAiKTsKICAgIHJldHVybiAoCiAgICAgIC8vIGR1cGxpY2F0ZSB3b3JkcyB3aWxsIGNhdXNlIGR1cGxpY2F0ZSBrZXlzIHdoaWNoIGlzIHdoeSB3ZSBhZGQgdGhlIGFycmF5IGluZGV4IGhlcmUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudCgidHNwYW4iLCB7CiAgICAgICAgeDogeDIsCiAgICAgICAgZHk6IGluZGV4ID09PSAwID8gc3RhcnREeSA6IGxpbmVIZWlnaHQsCiAgICAgICAga2V5OiAiIi5jb25jYXQod29yZHMsICItIikuY29uY2F0KGluZGV4KQogICAgICB9LCB3b3JkcykKICAgICk7CiAgfSkpOwp9KTsKVGV4dC5kaXNwbGF5TmFtZSA9ICJUZXh0IjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0xhYmVsLmpzCnZhciBSZWFjdDE0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQ3ID0gWyJsYWJlbFJlZiJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM3KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U3KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U3KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBvd25LZXlzMjMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxMSgpIHsKICByZXR1cm4gX2V4dGVuZHMxMSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTEuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgQ2FydGVzaWFuTGFiZWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIENhcnRlc2lhbkxhYmVsQ29udGV4dFByb3ZpZGVyID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIHZpZXdCb3ggPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlTWVtbykoKCkgPT4gKHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIFt4MiwgeTIsIHVwcGVyV2lkdGgsIGxvd2VyV2lkdGgsIHdpZHRoLCBoZWlnaHRdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiB2aWV3Qm94CiAgfSwgY2hpbGRyZW4pOwp9Owp2YXIgdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYWJlbENoaWxkQ29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VDb250ZXh0KShDYXJ0ZXNpYW5MYWJlbENvbnRleHQpOwogIHZhciBjaGFydENvbnRleHQgPSB1c2VWaWV3Qm94KCk7CiAgcmV0dXJuIGxhYmVsQ2hpbGRDb250ZXh0IHx8IGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZChjaGFydENvbnRleHQpOwp9Owp2YXIgUG9sYXJMYWJlbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlUG9sYXJMYWJlbENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxhYmVsQ2hpbGRDb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZUNvbnRleHQpKFBvbGFyTGFiZWxDb250ZXh0KTsKICB2YXIgY2hhcnRDb250ZXh0ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0UG9sYXJWaWV3Qm94KTsKICByZXR1cm4gbGFiZWxDaGlsZENvbnRleHQgfHwgY2hhcnRDb250ZXh0Owp9Owp2YXIgZ2V0TGFiZWwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgdmFsdWUsCiAgICBmb3JtYXR0ZXIKICB9ID0gcHJvcHM7CiAgdmFyIGxhYmVsID0gaXNOdWxsaXNoKHByb3BzLmNoaWxkcmVuKSA/IHZhbHVlIDogcHJvcHMuY2hpbGRyZW47CiAgaWYgKHR5cGVvZiBmb3JtYXR0ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBmb3JtYXR0ZXIobGFiZWwpOwogIH0KICByZXR1cm4gbGFiZWw7Cn07CnZhciBpc0xhYmVsQ29udGVudEFGdW5jdGlvbiA9IChjb250ZW50KSA9PiB7CiAgcmV0dXJuIGNvbnRlbnQgIT0gbnVsbCAmJiB0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIjsKfTsKdmFyIGdldERlbHRhQW5nbGUyID0gKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKSA9PiB7CiAgdmFyIHNpZ24yID0gbWF0aFNpZ24oZW5kQW5nbGUgLSBzdGFydEFuZ2xlKTsKICB2YXIgZGVsdGFBbmdsZSA9IE1hdGgubWluKE1hdGguYWJzKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSksIDM2MCk7CiAgcmV0dXJuIHNpZ24yICogZGVsdGFBbmdsZTsKfTsKdmFyIHJlbmRlclJhZGlhbExhYmVsID0gKGxhYmVsUHJvcHMsIHBvc2l0aW9uLCBsYWJlbCwgYXR0cnMsIHZpZXdCb3gpID0+IHsKICB2YXIgewogICAgb2Zmc2V0LAogICAgY2xhc3NOYW1lCiAgfSA9IGxhYmVsUHJvcHM7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xvY2tXaXNlCiAgfSA9IHZpZXdCb3g7CiAgdmFyIHJhZGl1cyA9IChpbm5lclJhZGl1cyArIG91dGVyUmFkaXVzKSAvIDI7CiAgdmFyIGRlbHRhQW5nbGUgPSBnZXREZWx0YUFuZ2xlMihzdGFydEFuZ2xlLCBlbmRBbmdsZSk7CiAgdmFyIHNpZ24yID0gZGVsdGFBbmdsZSA+PSAwID8gMSA6IC0xOwogIHZhciBsYWJlbEFuZ2xlLCBkaXJlY3Rpb247CiAgc3dpdGNoIChwb3NpdGlvbikgewogICAgY2FzZSAiaW5zaWRlU3RhcnQiOgogICAgICBsYWJlbEFuZ2xlID0gc3RhcnRBbmdsZSArIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSBjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiaW5zaWRlRW5kIjoKICAgICAgbGFiZWxBbmdsZSA9IGVuZEFuZ2xlIC0gc2lnbjIgKiBvZmZzZXQ7CiAgICAgIGRpcmVjdGlvbiA9ICFjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiZW5kIjoKICAgICAgbGFiZWxBbmdsZSA9IGVuZEFuZ2xlICsgc2lnbjIgKiBvZmZzZXQ7CiAgICAgIGRpcmVjdGlvbiA9IGNsb2NrV2lzZTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIHBvc2l0aW9uICIuY29uY2F0KHBvc2l0aW9uKSk7CiAgfQogIGRpcmVjdGlvbiA9IGRlbHRhQW5nbGUgPD0gMCA/IGRpcmVjdGlvbiA6ICFkaXJlY3Rpb247CiAgdmFyIHN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBsYWJlbEFuZ2xlKTsKICB2YXIgZW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBsYWJlbEFuZ2xlICsgKGRpcmVjdGlvbiA/IDEgOiAtMSkgKiAzNTkpOwogIHZhciBwYXRoMiA9ICJNIi5jb25jYXQoc3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChzdGFydFBvaW50LnksICJcbiAgICBBIikuY29uY2F0KHJhZGl1cywgIiwiKS5jb25jYXQocmFkaXVzLCAiLDAsMSwiKS5jb25jYXQoZGlyZWN0aW9uID8gMCA6IDEsICIsXG4gICAgIikuY29uY2F0KGVuZFBvaW50LngsICIsIikuY29uY2F0KGVuZFBvaW50LnkpOwogIHZhciBpZCA9IGlzTnVsbGlzaChsYWJlbFByb3BzLmlkKSA/IHVuaXF1ZUlkKCJyZWNoYXJ0cy1yYWRpYWwtbGluZS0iKSA6IGxhYmVsUHJvcHMuaWQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInRleHQiLCBfZXh0ZW5kczExKHt9LCBhdHRycywgewogICAgZG9taW5hbnRCYXNlbGluZTogImNlbnRyYWwiLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1yYWRpYWwtYmFyLWxhYmVsIiwgY2xhc3NOYW1lKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgicGF0aCIsIHsKICAgIGlkLAogICAgZDogcGF0aDIKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInRleHRQYXRoIiwgewogICAgeGxpbmtIcmVmOiAiIyIuY29uY2F0KGlkKQogIH0sIGxhYmVsKSk7Cn07CnZhciBnZXRBdHRyc09mUG9sYXJMYWJlbCA9ICh2aWV3Qm94LCBvZmZzZXQsIHBvc2l0aW9uKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IHZpZXdCb3g7CiAgdmFyIG1pZEFuZ2xlID0gKHN0YXJ0QW5nbGUgKyBlbmRBbmdsZSkgLyAyOwogIGlmIChwb3NpdGlvbiA9PT0gIm91dHNpZGUiKSB7CiAgICB2YXIgewogICAgICB4OiBfeCwKICAgICAgeTogX3kKICAgIH0gPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMgKyBvZmZzZXQsIG1pZEFuZ2xlKTsKICAgIHJldHVybiB7CiAgICAgIHg6IF94LAogICAgICB5OiBfeSwKICAgICAgdGV4dEFuY2hvcjogX3ggPj0gY3ggPyAic3RhcnQiIDogImVuZCIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogIH0KICBpZiAocG9zaXRpb24gPT09ICJjZW50ZXJUb3AiKSB7CiAgICByZXR1cm4gewogICAgICB4OiBjeCwKICAgICAgeTogY3ksCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogInN0YXJ0IgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyQm90dG9tIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJlbmQiCiAgICB9OwogIH0KICB2YXIgcjIgPSAoaW5uZXJSYWRpdXMgKyBvdXRlclJhZGl1cykgLyAyOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByMiwgbWlkQW5nbGUpOwogIHJldHVybiB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICB9Owp9Owp2YXIgaXNQb2xhciA9ICh2aWV3Qm94KSA9PiAiY3giIGluIHZpZXdCb3ggJiYgaXNOdW1iZXIodmlld0JveC5jeCk7CnZhciBnZXRBdHRyc09mQ2FydGVzaWFuTGFiZWwgPSAocHJvcHMsIHZpZXdCb3gpID0+IHsKICB2YXIgewogICAgcGFyZW50Vmlld0JveDogcGFyZW50Vmlld0JveEZyb21Qcm9wcywKICAgIG9mZnNldCwKICAgIHBvc2l0aW9uCiAgfSA9IHByb3BzOwogIHZhciBwYXJlbnRWaWV3Qm94OwogIGlmIChwYXJlbnRWaWV3Qm94RnJvbVByb3BzICE9IG51bGwgJiYgIWlzUG9sYXIocGFyZW50Vmlld0JveEZyb21Qcm9wcykpIHsKICAgIHBhcmVudFZpZXdCb3ggPSBwYXJlbnRWaWV3Qm94RnJvbVByb3BzOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHVwcGVyV2lkdGgsCiAgICBsb3dlcldpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHZpZXdCb3g7CiAgdmFyIHVwcGVyWCA9IHgyOwogIHZhciBsb3dlclggPSB4MiArICh1cHBlcldpZHRoIC0gbG93ZXJXaWR0aCkgLyAyOwogIHZhciBtaWRkbGVYID0gKHVwcGVyWCArIGxvd2VyWCkgLyAyOwogIHZhciBtaWRIZWlnaHRXaWR0aCA9ICh1cHBlcldpZHRoICsgbG93ZXJXaWR0aCkgLyAyOwogIHZhciBjZW50ZXJYID0gdXBwZXJYICsgdXBwZXJXaWR0aCAvIDI7CiAgdmFyIHZlcnRpY2FsU2lnbiA9IGhlaWdodCA+PSAwID8gMSA6IC0xOwogIHZhciB2ZXJ0aWNhbE9mZnNldCA9IHZlcnRpY2FsU2lnbiAqIG9mZnNldDsKICB2YXIgdmVydGljYWxFbmQgPSB2ZXJ0aWNhbFNpZ24gPiAwID8gImVuZCIgOiAic3RhcnQiOwogIHZhciB2ZXJ0aWNhbFN0YXJ0ID0gdmVydGljYWxTaWduID4gMCA/ICJzdGFydCIgOiAiZW5kIjsKICB2YXIgaG9yaXpvbnRhbFNpZ24gPSB1cHBlcldpZHRoID49IDAgPyAxIDogLTE7CiAgdmFyIGhvcml6b250YWxPZmZzZXQgPSBob3Jpem9udGFsU2lnbiAqIG9mZnNldDsKICB2YXIgaG9yaXpvbnRhbEVuZCA9IGhvcml6b250YWxTaWduID4gMCA/ICJlbmQiIDogInN0YXJ0IjsKICB2YXIgaG9yaXpvbnRhbFN0YXJ0ID0gaG9yaXpvbnRhbFNpZ24gPiAwID8gInN0YXJ0IiA6ICJlbmQiOwogIGlmIChwb3NpdGlvbiA9PT0gInRvcCIpIHsKICAgIHZhciBhdHRycyA9IHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyIC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKF9vYmplY3RTcHJlYWQyMyh7fSwgYXR0cnMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICBoZWlnaHQ6IE1hdGgubWF4KHkyIC0gcGFyZW50Vmlld0JveC55LCAwKSwKICAgICAgd2lkdGg6IHVwcGVyV2lkdGgKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImJvdHRvbSIpIHsKICAgIHZhciBfYXR0cnMgPSB7CiAgICAgIHg6IGxvd2VyWCArIGxvd2VyV2lkdGggLyAyLAogICAgICB5OiB5MiArIGhlaWdodCArIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsU3RhcnQKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKF9vYmplY3RTcHJlYWQyMyh7fSwgX2F0dHJzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgaGVpZ2h0OiBNYXRoLm1heChwYXJlbnRWaWV3Qm94LnkgKyBwYXJlbnRWaWV3Qm94LmhlaWdodCAtICh5MiArIGhlaWdodCksIDApLAogICAgICB3aWR0aDogbG93ZXJXaWR0aAogICAgfSA6IHt9KTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAibGVmdCIpIHsKICAgIHZhciBfYXR0cnMyID0gewogICAgICB4OiBtaWRkbGVYIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKF9vYmplY3RTcHJlYWQyMyh7fSwgX2F0dHJzMiksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIHdpZHRoOiBNYXRoLm1heChfYXR0cnMyLnggLSBwYXJlbnRWaWV3Qm94LngsIDApLAogICAgICBoZWlnaHQKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gInJpZ2h0IikgewogICAgdmFyIF9hdHRyczMgPSB7CiAgICAgIHg6IG1pZGRsZVggKyBtaWRIZWlnaHRXaWR0aCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKF9vYmplY3RTcHJlYWQyMyh7fSwgX2F0dHJzMyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIHdpZHRoOiBNYXRoLm1heChwYXJlbnRWaWV3Qm94LnggKyBwYXJlbnRWaWV3Qm94LndpZHRoIC0gX2F0dHJzMy54LCAwKSwKICAgICAgaGVpZ2h0CiAgICB9IDoge30pOwogIH0KICB2YXIgc2l6ZUF0dHJzID0gcGFyZW50Vmlld0JveCA/IHsKICAgIHdpZHRoOiBtaWRIZWlnaHRXaWR0aCwKICAgIGhlaWdodAogIH0gOiB7fTsKICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVMZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IG1pZGRsZVggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVSaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBtaWRkbGVYICsgbWlkSGVpZ2h0V2lkdGggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wIikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyLAogICAgICB5OiB5MiArIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsU3RhcnQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZUJvdHRvbSIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB1cHBlclggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVUb3BSaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsU3RhcnQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZUJvdHRvbUxlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZUJvdHRvbVJpZ2h0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGxvd2VyV2lkdGggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmICghIXBvc2l0aW9uICYmIHR5cGVvZiBwb3NpdGlvbiA9PT0gIm9iamVjdCIgJiYgKGlzTnVtYmVyKHBvc2l0aW9uLngpIHx8IGlzUGVyY2VudChwb3NpdGlvbi54KSkgJiYgKGlzTnVtYmVyKHBvc2l0aW9uLnkpIHx8IGlzUGVyY2VudChwb3NpdGlvbi55KSkpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB4MiArIGdldFBlcmNlbnRWYWx1ZShwb3NpdGlvbi54LCBtaWRIZWlnaHRXaWR0aCksCiAgICAgIHk6IHkyICsgZ2V0UGVyY2VudFZhbHVlKHBvc2l0aW9uLnksIGhlaWdodCksCiAgICAgIHRleHRBbmNob3I6ICJlbmQiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgeDogY2VudGVyWCwKICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgfSwgc2l6ZUF0dHJzKTsKfTsKdmFyIGRlZmF1bHRMYWJlbFByb3BzID0gewogIGFuZ2xlOiAwLAogIG9mZnNldDogNSwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5sYWJlbCwKICBwb3NpdGlvbjogIm1pZGRsZSIsCiAgdGV4dEJyZWFrQWxsOiBmYWxzZQp9OwpmdW5jdGlvbiBMYWJlbChvdXRlclByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRlclByb3BzLCBkZWZhdWx0TGFiZWxQcm9wcyk7CiAgdmFyIHsKICAgIHZpZXdCb3g6IHZpZXdCb3hGcm9tUHJvcHMsCiAgICBwb3NpdGlvbiwKICAgIHZhbHVlLAogICAgY2hpbGRyZW4sCiAgICBjb250ZW50LAogICAgY2xhc3NOYW1lID0gIiIsCiAgICB0ZXh0QnJlYWtBbGwsCiAgICBsYWJlbFJlZgogIH0gPSBwcm9wczsKICB2YXIgcG9sYXJWaWV3Qm94ID0gdXNlUG9sYXJMYWJlbENvbnRleHQoKTsKICB2YXIgY2FydGVzaWFuVmlld0JveCA9IHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCgpOwogIHZhciByZXNvbHZlZFZpZXdCb3ggPSBwb3NpdGlvbiA9PT0gImNlbnRlciIgPyBjYXJ0ZXNpYW5WaWV3Qm94IDogcG9sYXJWaWV3Qm94ICE9PSBudWxsICYmIHBvbGFyVmlld0JveCAhPT0gdm9pZCAwID8gcG9sYXJWaWV3Qm94IDogY2FydGVzaWFuVmlld0JveDsKICB2YXIgdmlld0JveCwgbGFiZWwsIHBvc2l0aW9uQXR0cnM7CiAgaWYgKHZpZXdCb3hGcm9tUHJvcHMgPT0gbnVsbCkgewogICAgdmlld0JveCA9IHJlc29sdmVkVmlld0JveDsKICB9IGVsc2UgaWYgKGlzUG9sYXIodmlld0JveEZyb21Qcm9wcykpIHsKICAgIHZpZXdCb3ggPSB2aWV3Qm94RnJvbVByb3BzOwogIH0gZWxzZSB7CiAgICB2aWV3Qm94ID0gY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKHZpZXdCb3hGcm9tUHJvcHMpOwogIH0KICBpZiAoIXZpZXdCb3ggfHwgaXNOdWxsaXNoKHZhbHVlKSAmJiBpc051bGxpc2goY2hpbGRyZW4pICYmICEvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmlzVmFsaWRFbGVtZW50KShjb250ZW50KSAmJiB0eXBlb2YgY29udGVudCAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcm9wc1dpdGhWaWV3Qm94ID0gX29iamVjdFNwcmVhZDIzKF9vYmplY3RTcHJlYWQyMyh7fSwgcHJvcHMpLCB7fSwgewogICAgdmlld0JveAogIH0pOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmlzVmFsaWRFbGVtZW50KShjb250ZW50KSkgewogICAgdmFyIHsKICAgICAgbGFiZWxSZWY6IF8KICAgIH0gPSBwcm9wc1dpdGhWaWV3Qm94LCBwcm9wc1dpdGhvdXRMYWJlbFJlZiA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczcocHJvcHNXaXRoVmlld0JveCwgX2V4Y2x1ZGVkNyk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jbG9uZUVsZW1lbnQpKGNvbnRlbnQsIHByb3BzV2l0aG91dExhYmVsUmVmKTsKICB9CiAgaWYgKHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICBsYWJlbCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlRWxlbWVudCkoY29udGVudCwgcHJvcHNXaXRoVmlld0JveCk7CiAgICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkobGFiZWwpKSB7CiAgICAgIHJldHVybiBsYWJlbDsKICAgIH0KICB9IGVsc2UgewogICAgbGFiZWwgPSBnZXRMYWJlbChwcm9wcyk7CiAgfQogIHZhciBhdHRycyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpOwogIGlmIChpc1BvbGFyKHZpZXdCb3gpKSB7CiAgICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVTdGFydCIgfHwgcG9zaXRpb24gPT09ICJpbnNpZGVFbmQiIHx8IHBvc2l0aW9uID09PSAiZW5kIikgewogICAgICByZXR1cm4gcmVuZGVyUmFkaWFsTGFiZWwocHJvcHMsIHBvc2l0aW9uLCBsYWJlbCwgYXR0cnMsIHZpZXdCb3gpOwogICAgfQogICAgcG9zaXRpb25BdHRycyA9IGdldEF0dHJzT2ZQb2xhckxhYmVsKHZpZXdCb3gsIHByb3BzLm9mZnNldCwgcHJvcHMucG9zaXRpb24pOwogIH0gZWxzZSB7CiAgICBwb3NpdGlvbkF0dHJzID0gZ2V0QXR0cnNPZkNhcnRlc2lhbkxhYmVsKHByb3BzLCB2aWV3Qm94KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHMuekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChUZXh0LCBfZXh0ZW5kczExKHsKICAgIHJlZjogbGFiZWxSZWYsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWxhYmVsIiwgY2xhc3NOYW1lKQogIH0sIGF0dHJzLCBwb3NpdGlvbkF0dHJzLCB7CiAgICAvKgogICAgICogdGV4dEFuY2hvciBpcyBkZWNpZGVkIGJ5IGRlZmF1bHQgYmFzZWQgb24gdGhlIGBwb3NpdGlvbmAKICAgICAqIGJ1dCB3ZSBhbGxvdyBvdmVycmlkaW5nIHZpYSBwcm9wcyBmb3IgcHJlY2lzZSBjb250cm9sLgogICAgICovCiAgICB0ZXh0QW5jaG9yOiBpc1ZhbGlkVGV4dEFuY2hvcihhdHRycy50ZXh0QW5jaG9yKSA/IGF0dHJzLnRleHRBbmNob3IgOiBwb3NpdGlvbkF0dHJzLnRleHRBbmNob3IsCiAgICBicmVha0FsbDogdGV4dEJyZWFrQWxsCiAgfSksIGxhYmVsKSk7Cn0KTGFiZWwuZGlzcGxheU5hbWUgPSAiTGFiZWwiOwp2YXIgcGFyc2VMYWJlbCA9IChsYWJlbCwgdmlld0JveCwgbGFiZWxSZWYpID0+IHsKICBpZiAoIWxhYmVsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGNvbW1vblByb3BzID0gewogICAgdmlld0JveCwKICAgIGxhYmVsUmVmCiAgfTsKICBpZiAobGFiZWwgPT09IHRydWUpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoaXNOdW1PclN0cihsYWJlbCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICB2YWx1ZTogbGFiZWwKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmlzVmFsaWRFbGVtZW50KShsYWJlbCkpIHsKICAgIGlmIChsYWJlbC50eXBlID09PSBMYWJlbCkgewogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jbG9uZUVsZW1lbnQpKGxhYmVsLCBfb2JqZWN0U3ByZWFkMjMoewogICAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgICB9LCBjb21tb25Qcm9wcykpOwogICAgfQogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgY29udGVudDogbGFiZWwKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmIChsYWJlbCAmJiB0eXBlb2YgbGFiZWwgPT09ICJvYmplY3QiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7fSwgbGFiZWwsIHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICByZXR1cm4gbnVsbDsKfTsKZnVuY3Rpb24gQ2FydGVzaWFuTGFiZWxGcm9tTGFiZWxQcm9wKF9yZWYzKSB7CiAgdmFyIHsKICAgIGxhYmVsLAogICAgbGFiZWxSZWYKICB9ID0gX3JlZjM7CiAgdmFyIHZpZXdCb3ggPSB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQoKTsKICByZXR1cm4gcGFyc2VMYWJlbChsYWJlbCwgdmlld0JveCwgbGFiZWxSZWYpIHx8IG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0xhYmVsTGlzdC5qcwp2YXIgUmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2xhc3QgPSBfX3RvRVNNKHJlcXVpcmVfbGFzdDMoKSk7CnZhciBfZXhjbHVkZWQ4ID0gWyJ2YWx1ZUFjY2Vzc29yIl07CnZhciBfZXhjbHVkZWQyNCA9IFsiZGF0YUtleSIsICJjbG9ja1dpc2UiLCAiaWQiLCAidGV4dEJyZWFrQWxsIiwgInpJbmRleCJdOwpmdW5jdGlvbiBfZXh0ZW5kczEyKCkgewogIHJldHVybiBfZXh0ZW5kczEyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczgoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTgoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTgocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBkZWZhdWx0QWNjZXNzb3IgPSAoZW50cnkpID0+IEFycmF5LmlzQXJyYXkoZW50cnkudmFsdWUpID8gKDAsIGltcG9ydF9sYXN0LmRlZmF1bHQpKGVudHJ5LnZhbHVlKSA6IGVudHJ5LnZhbHVlOwp2YXIgQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjcuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHRQcm92aWRlciA9IENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQuUHJvdmlkZXI7CnZhciBQb2xhckxhYmVsTGlzdENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI3LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBQb2xhckxhYmVsTGlzdENvbnRleHRQcm92aWRlciA9IFBvbGFyTGFiZWxMaXN0Q29udGV4dC5Qcm92aWRlcjsKZnVuY3Rpb24gdXNlQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCgpIHsKICByZXR1cm4gKDAsIGltcG9ydF9yZWFjdDI3LnVzZUNvbnRleHQpKENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQpOwp9CmZ1bmN0aW9uIHVzZVBvbGFyTGFiZWxMaXN0Q29udGV4dCgpIHsKICByZXR1cm4gKDAsIGltcG9ydF9yZWFjdDI3LnVzZUNvbnRleHQpKFBvbGFyTGFiZWxMaXN0Q29udGV4dCk7Cn0KZnVuY3Rpb24gTGFiZWxMaXN0KF9yZWYyKSB7CiAgdmFyIHsKICAgIHZhbHVlQWNjZXNzb3IgPSBkZWZhdWx0QWNjZXNzb3IKICB9ID0gX3JlZjIsIHJlc3RQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczgoX3JlZjIsIF9leGNsdWRlZDgpOwogIHZhciB7CiAgICBkYXRhS2V5LAogICAgY2xvY2tXaXNlLAogICAgaWQsCiAgICB0ZXh0QnJlYWtBbGwsCiAgICB6SW5kZXgKICB9ID0gcmVzdFByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM4KHJlc3RQcm9wcywgX2V4Y2x1ZGVkMjQpOwogIHZhciBjYXJ0ZXNpYW5EYXRhID0gdXNlQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCgpOwogIHZhciBwb2xhckRhdGEgPSB1c2VQb2xhckxhYmVsTGlzdENvbnRleHQoKTsKICB2YXIgZGF0YSA9IGNhcnRlc2lhbkRhdGEgfHwgcG9sYXJEYXRhOwogIGlmICghZGF0YSB8fCAhZGF0YS5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiB6SW5kZXggIT09IG51bGwgJiYgekluZGV4ICE9PSB2b2lkIDAgPyB6SW5kZXggOiBEZWZhdWx0WkluZGV4ZXMubGFiZWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1sYWJlbC1saXN0IgogIH0sIGRhdGEubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgIHZhciBfcmVzdFByb3BzJGZpbGw7CiAgICB2YXIgdmFsdWUgPSBpc051bGxpc2goZGF0YUtleSkgPyB2YWx1ZUFjY2Vzc29yKGVudHJ5LCBpbmRleCkgOiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSAmJiBlbnRyeS5wYXlsb2FkLCBkYXRhS2V5KTsKICAgIHZhciBpZFByb3BzID0gaXNOdWxsaXNoKGlkKSA/IHt9IDogewogICAgICBpZDogIiIuY29uY2F0KGlkLCAiLSIpLmNvbmNhdChpbmRleCkKICAgIH07CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsLSIuY29uY2F0KGluZGV4KQogICAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhlbnRyeSksIG90aGVycywgaWRQcm9wcywgewogICAgICAvKgogICAgICAgKiBQcmVmZXIgdG8gdXNlIHRoZSBleHBsaWNpdCBmaWxsIGZyb20gTGFiZWxMaXN0IHByb3BzLgogICAgICAgKiBPbmx5IGluIGFuIGFic2VuY2Ugb2YgdGhhdCwgZmFsbCBiYWNrIHRvIHRoZSBmaWxsIG9mIHRoZSBlbnRyeS4KICAgICAgICogVGhlIGVudHJ5IGZpbGwgY2FuIGJlIHF1aXRlIGRpZmZpY3VsdCB0byBzZWUgZXNwZWNpYWxseSBpbiBCYXIsIFBpZSwgUmFkaWFsQmFyIGluIGluc2lkZSBwb3NpdGlvbnMuCiAgICAgICAqIE9uIHRoZSBvdGhlciBoYW5kIGl0J3MgcXVpdGUgY29udmVuaWVudCBpbiBTY2F0dGVyLCBMaW5lLCBvciB3aGVuIHRoZSBwb3NpdGlvbiBpcyBvdXRzaWRlIHRoZSBCYXIsIFBpZSBmaWxsZWQgc2hhcGVzLgogICAgICAgKi8KICAgICAgZmlsbDogKF9yZXN0UHJvcHMkZmlsbCA9IHJlc3RQcm9wcy5maWxsKSAhPT0gbnVsbCAmJiBfcmVzdFByb3BzJGZpbGwgIT09IHZvaWQgMCA/IF9yZXN0UHJvcHMkZmlsbCA6IGVudHJ5LmZpbGwsCiAgICAgIHBhcmVudFZpZXdCb3g6IGVudHJ5LnBhcmVudFZpZXdCb3gsCiAgICAgIHZhbHVlLAogICAgICB0ZXh0QnJlYWtBbGwsCiAgICAgIHZpZXdCb3g6IGVudHJ5LnZpZXdCb3gsCiAgICAgIGluZGV4LAogICAgICB6SW5kZXg6IDAKICAgIH0pKTsKICB9KSkpOwp9CkxhYmVsTGlzdC5kaXNwbGF5TmFtZSA9ICJMYWJlbExpc3QiOwpmdW5jdGlvbiBMYWJlbExpc3RGcm9tTGFiZWxQcm9wKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxhYmVsCiAgfSA9IF9yZWYyOwogIGlmICghbGFiZWwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAobGFiZWwgPT09IHRydWUpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiCiAgICB9KTsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmlzVmFsaWRFbGVtZW50KGxhYmVsKSB8fCBpc0xhYmVsQ29udGVudEFGdW5jdGlvbihsYWJlbCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSk7CiAgfQogIGlmICh0eXBlb2YgbGFiZWwgPT09ICJvYmplY3QiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIF9leHRlbmRzMTIoewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiCiAgICB9LCBsYWJlbCwgewogICAgICB0eXBlOiBTdHJpbmcobGFiZWwudHlwZSkKICAgIH0pKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvRG90LmpzCnZhciBSZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczEzKCkgewogIHJldHVybiBfZXh0ZW5kczEzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBEb3QgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHI6IHIyLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtZG90IiwgY2xhc3NOYW1lKTsKICBpZiAoaXNOdW1iZXIoY3gpICYmIGlzTnVtYmVyKGN5KSAmJiBpc051bWJlcihyMikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNi5jcmVhdGVFbGVtZW50KCJjaXJjbGUiLCBfZXh0ZW5kczEzKHt9LCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpLCBhZGFwdEV2ZW50SGFuZGxlcnMocHJvcHMpLCB7CiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByOiByMgogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcG9sYXJBeGlzU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTYgPSB7CiAgcmFkaXVzQXhpczoge30sCiAgYW5nbGVBeGlzOiB7fQp9Owp2YXIgcG9sYXJBeGlzU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInBvbGFyQXhpcyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU2LAogIHJlZHVjZXJzOiB7CiAgICBhZGRSYWRpdXNBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUucmFkaXVzQXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZVJhZGl1c0F4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBkZWxldGUgc3RhdGUucmFkaXVzQXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICB9LAogICAgYWRkQW5nbGVBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuYW5nbGVBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlQW5nbGVBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgZGVsZXRlIHN0YXRlLmFuZ2xlQXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRSYWRpdXNBeGlzLAogIHJlbW92ZVJhZGl1c0F4aXMsCiAgYWRkQW5nbGVBeGlzLAogIHJlbW92ZUFuZ2xlQXhpcwp9ID0gcG9sYXJBeGlzU2xpY2UuYWN0aW9uczsKdmFyIHBvbGFyQXhpc1JlZHVjZXIgPSBwb2xhckF4aXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1JlYWN0VXRpbHMuanMKdmFyIGltcG9ydF9yZWFjdDI4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaXNDbGlwRG90ID0gKGRvdCkgPT4gewogIGlmIChkb3QgJiYgdHlwZW9mIGRvdCA9PT0gIm9iamVjdCIgJiYgImNsaXBEb3QiIGluIGRvdCkgewogICAgcmV0dXJuIEJvb2xlYW4oZG90LmNsaXBEb3QpOwogIH0KICByZXR1cm4gdHJ1ZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MuanMKdmFyIGltcG9ydF9yZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRUb29sdGlwRW50cnlTZXR0aW5ncyhfcmVmMikgewogIHZhciB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0gPSBfcmVmMjsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MjkudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MjkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3ModG9vbHRpcEVudHJ5U2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHRvb2x0aXBFbnRyeVNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5ncyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogdG9vbHRpcEVudHJ5U2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSB0b29sdGlwRW50cnlTZXR0aW5nczsKICB9LCBbdG9vbHRpcEVudHJ5U2V0dGluZ3MsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgKDAsIGltcG9ydF9yZWFjdDI5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0TGVnZW5kUGF5bG9hZC5qcwp2YXIgaW1wb3J0X3JlYWN0MzAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFNldExlZ2VuZFBheWxvYWQoX3JlZjIpIHsKICB2YXIgewogICAgbGVnZW5kUGF5bG9hZAogIH0gPSBfcmVmMjsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBwcmV2UGF5bG9hZFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzMC51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZExlZ2VuZFBheWxvYWQobGVnZW5kUGF5bG9hZCkpOwogICAgfSBlbHNlIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50ICE9PSBsZWdlbmRQYXlsb2FkKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VMZWdlbmRQYXlsb2FkKHsKICAgICAgICBwcmV2OiBwcmV2UGF5bG9hZFJlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IGxlZ2VuZFBheWxvYWQKICAgICAgfSkpOwogICAgfQogICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IGxlZ2VuZFBheWxvYWQ7CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCBsZWdlbmRQYXlsb2FkXSk7CiAgKDAsIGltcG9ydF9yZWFjdDMwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVMZWdlbmRQYXlsb2FkKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2UGF5bG9hZFJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9LCBbZGlzcGF0Y2hdKTsKICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1JlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLmpzCnZhciBSZWFjdDE4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlSWQuanMKdmFyIFJlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfcmVmOwp2YXIgdXNlSWRGYWxsYmFjayA9ICgpID0+IHsKICB2YXIgW2lkXSA9IFJlYWN0MTcudXNlU3RhdGUoKCkgPT4gdW5pcXVlSWQoInVpZC0iKSk7CiAgcmV0dXJuIGlkOwp9Owp2YXIgdXNlSWQgPSAoX3JlZiA9IFJlYWN0MTdbInVzZUlkIi50b1N0cmluZygpXSkgIT09IG51bGwgJiYgX3JlZiAhPT0gdm9pZCAwID8gX3JlZiA6IHVzZUlkRmFsbGJhY2s7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlVW5pcXVlSWQuanMKZnVuY3Rpb24gdXNlVW5pcXVlSWQocHJlZml4LCBjdXN0b21JZCkgewogIHZhciBnZW5lcmF0ZWRJZCA9IHVzZUlkKCk7CiAgaWYgKGN1c3RvbUlkKSB7CiAgICByZXR1cm4gY3VzdG9tSWQ7CiAgfQogIHJldHVybiBwcmVmaXggPyAiIi5jb25jYXQocHJlZml4LCAiLSIpLmNvbmNhdChnZW5lcmF0ZWRJZCkgOiBnZW5lcmF0ZWRJZDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1JlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLmpzCnZhciBHcmFwaGljYWxJdGVtSWRDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMS5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgaWQsCiAgICB0eXBlLAogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIHJlc29sdmVkSWQgPSB1c2VVbmlxdWVJZCgicmVjaGFydHMtIi5jb25jYXQodHlwZSksIGlkKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTguY3JlYXRlRWxlbWVudChHcmFwaGljYWxJdGVtSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogcmVzb2x2ZWRJZAogIH0sIGNoaWxkcmVuKHJlc29sdmVkSWQpKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgaW1wb3J0X3JlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2dyYXBoaWNhbEl0ZW1zU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTcgPSB7CiAgY2FydGVzaWFuSXRlbXM6IFtdLAogIHBvbGFySXRlbXM6IFtdCn07CnZhciBncmFwaGljYWxJdGVtc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJncmFwaGljYWxJdGVtcyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU3LAogIHJlZHVjZXJzOiB7CiAgICBhZGRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLmNhcnRlc2lhbkl0ZW1zLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmNhcnRlc2lhbkl0ZW1zLmluZGV4T2YoY2FzdERyYWZ0KHByZXYpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXNbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmNhcnRlc2lhbkl0ZW1zLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLmNhcnRlc2lhbkl0ZW1zLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIGFkZFBvbGFyR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5wb2xhckl0ZW1zLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlUG9sYXJHcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBvbGFySXRlbXMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUucG9sYXJJdGVtcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sCiAgcmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sCiAgcmVtb3ZlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICBhZGRQb2xhckdyYXBoaWNhbEl0ZW0sCiAgcmVtb3ZlUG9sYXJHcmFwaGljYWxJdGVtCn0gPSBncmFwaGljYWxJdGVtc1NsaWNlLmFjdGlvbnM7CnZhciBncmFwaGljYWxJdGVtc1JlZHVjZXIgPSBncmFwaGljYWxJdGVtc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldEdyYXBoaWNhbEl0ZW0uanMKdmFyIFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1JbXBsID0gKHByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlByb3BzUmVmID0gKDAsIGltcG9ydF9yZWFjdDMyLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDMyLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZQcm9wc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJvcHMpKTsKICAgIH0gZWxzZSBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgIT09IHByb3BzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtKHsKICAgICAgICBwcmV2OiBwcmV2UHJvcHNSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBwcm9wcwogICAgICB9KSk7CiAgICB9CiAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IHByb3BzOwogIH0sIFtkaXNwYXRjaCwgcHJvcHNdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtKHByZXZQcm9wc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlByb3BzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9Owp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzIubWVtbykoU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvRG90cy5qcwp2YXIgUmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDMzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkOSA9IFsicG9pbnRzIl07CmZ1bmN0aW9uIG93bktleXMyNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE0KCkgewogIHJldHVybiBfZXh0ZW5kczE0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIERvdEl0ZW0oX3JlZjIpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgZG90UHJvcHMsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjI7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzMuaXNWYWxpZEVsZW1lbnQpKG9wdGlvbikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmNsb25lRWxlbWVudCkob3B0aW9uLCBkb3RQcm9wcyk7CiAgfQogIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gb3B0aW9uKGRvdFByb3BzKTsKICB9CiAgdmFyIGZpbmFsQ2xhc3NOYW1lID0gY2xzeChjbGFzc05hbWUsIHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIiA/IG9wdGlvbi5jbGFzc05hbWUgOiAiIik7CiAgdmFyIF9yZWYyMiA9IGRvdFByb3BzICE9PSBudWxsICYmIGRvdFByb3BzICE9PSB2b2lkIDAgPyBkb3RQcm9wcyA6IHt9LCB7CiAgICBwb2ludHMKICB9ID0gX3JlZjIyLCBwcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoX3JlZjIyLCBfZXhjbHVkZWQ5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChEb3QsIF9leHRlbmRzMTQoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGZpbmFsQ2xhc3NOYW1lCiAgfSkpOwp9CmZ1bmN0aW9uIHNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpIHsKICBpZiAocG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGRvdCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBwb2ludHMubGVuZ3RoID09PSAxOwp9CmZ1bmN0aW9uIERvdHMoX3JlZjMpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgZG90LAogICAgY2xhc3NOYW1lLAogICAgZG90Q2xhc3NOYW1lLAogICAgZGF0YUtleSwKICAgIGJhc2VQcm9wcywKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5zY2F0dGVyCiAgfSA9IF9yZWYzOwogIGlmICghc2hvdWxkUmVuZGVyRG90cyhwb2ludHMsIGRvdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgY2xpcERvdCA9IGlzQ2xpcERvdChkb3QpOwogIHZhciBjdXN0b21Eb3RQcm9wcyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihkb3QpOwogIHZhciBkb3RzID0gcG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBfZW50cnkkeCwgX2VudHJ5JHk7CiAgICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjQoX29iamVjdFNwcmVhZDI0KF9vYmplY3RTcHJlYWQyNCh7CiAgICAgIHI6IDMKICAgIH0sIGJhc2VQcm9wcyksIGN1c3RvbURvdFByb3BzKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIGN4OiAoX2VudHJ5JHggPSBlbnRyeS54KSAhPT0gbnVsbCAmJiBfZW50cnkkeCAhPT0gdm9pZCAwID8gX2VudHJ5JHggOiB2b2lkIDAsCiAgICAgIGN5OiAoX2VudHJ5JHkgPSBlbnRyeS55KSAhPT0gbnVsbCAmJiBfZW50cnkkeSAhPT0gdm9pZCAwID8gX2VudHJ5JHkgOiB2b2lkIDAsCiAgICAgIGRhdGFLZXksCiAgICAgIHZhbHVlOiBlbnRyeS52YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZCwKICAgICAgcG9pbnRzCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KERvdEl0ZW0sIHsKICAgICAga2V5OiAiZG90LSIuY29uY2F0KGkpLAogICAgICBvcHRpb246IGRvdCwKICAgICAgZG90UHJvcHMsCiAgICAgIGNsYXNzTmFtZTogZG90Q2xhc3NOYW1lCiAgICB9KTsKICB9KTsKICB2YXIgbGF5ZXJQcm9wcyA9IHt9OwogIGlmIChuZWVkQ2xpcCAmJiBjbGlwUGF0aElkICE9IG51bGwpIHsKICAgIGxheWVyUHJvcHMuY2xpcFBhdGggPSAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTQoewogICAgY2xhc3NOYW1lCiAgfSwgbGF5ZXJQcm9wcyksIGRvdHMpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQWN0aXZlUG9pbnRzLmpzCnZhciBSZWFjdDIwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NhcnRlc2lhbkF4aXNTbGljZS5qcwpmdW5jdGlvbiBvd25LZXlzMjUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGluaXRpYWxTdGF0ZTggPSB7CiAgeEF4aXM6IHt9LAogIHlBeGlzOiB7fSwKICB6QXhpczoge30KfTsKdmFyIGNhcnRlc2lhbkF4aXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2FydGVzaWFuQXhpcyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU4LAogIHJlZHVjZXJzOiB7CiAgICBhZGRYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS54QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnhBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS54QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnhBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUueEF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIGFkZFlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnlBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUueUF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnlBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUueUF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS55QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUuekF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuekF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS56QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnpBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1cGRhdGVZQXhpc1dpZHRoKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBpZCwKICAgICAgICB3aWR0aAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIHZhciBheGlzID0gc3RhdGUueUF4aXNbaWRdOwogICAgICBpZiAoYXhpcykgewogICAgICAgIHZhciBoaXN0b3J5ID0gYXhpcy53aWR0aEhpc3RvcnkgfHwgW107CiAgICAgICAgaWYgKGhpc3RvcnkubGVuZ3RoID09PSAzICYmIGhpc3RvcnlbMF0gPT09IGhpc3RvcnlbMl0gJiYgd2lkdGggPT09IGhpc3RvcnlbMV0gJiYgd2lkdGggIT09IGF4aXMud2lkdGggJiYgTWF0aC5hYnMod2lkdGggLSBoaXN0b3J5WzBdKSA8PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBuZXdIaXN0b3J5ID0gWy4uLmhpc3RvcnksIHdpZHRoXS5zbGljZSgtMyk7CiAgICAgICAgc3RhdGUueUF4aXNbaWRdID0gX29iamVjdFNwcmVhZDI1KF9vYmplY3RTcHJlYWQyNSh7fSwgc3RhdGUueUF4aXNbaWRdKSwge30sIHsKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgd2lkdGhIaXN0b3J5OiBuZXdIaXN0b3J5CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFhBeGlzLAogIHJlcGxhY2VYQXhpcywKICByZW1vdmVYQXhpcywKICBhZGRZQXhpcywKICByZXBsYWNlWUF4aXMsCiAgcmVtb3ZlWUF4aXMsCiAgYWRkWkF4aXMsCiAgcmVwbGFjZVpBeGlzLAogIHJlbW92ZVpBeGlzLAogIHVwZGF0ZVlBeGlzV2lkdGgKfSA9IGNhcnRlc2lhbkF4aXNTbGljZS5hY3Rpb25zOwp2YXIgY2FydGVzaWFuQXhpc1JlZHVjZXIgPSBjYXJ0ZXNpYW5BeGlzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0LmpzCnZhciBzZWxlY3RDaGFydE9mZnNldCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgKG9mZnNldEludGVybmFsKSA9PiB7CiAgcmV0dXJuIHsKICAgIHRvcDogb2Zmc2V0SW50ZXJuYWwudG9wLAogICAgYm90dG9tOiBvZmZzZXRJbnRlcm5hbC5ib3R0b20sCiAgICBsZWZ0OiBvZmZzZXRJbnRlcm5hbC5sZWZ0LAogICAgcmlnaHQ6IG9mZnNldEludGVybmFsLnJpZ2h0CiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RQbG90QXJlYS5qcwp2YXIgc2VsZWN0UGxvdEFyZWEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXQsIHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0XSwgKG9mZnNldCwgY2hhcnRXaWR0aCwgY2hhcnRIZWlnaHQpID0+IHsKICBpZiAoIW9mZnNldCB8fCBjaGFydFdpZHRoID09IG51bGwgfHwgY2hhcnRIZWlnaHQgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHsKICAgIHg6IG9mZnNldC5sZWZ0LAogICAgeTogb2Zmc2V0LnRvcCwKICAgIHdpZHRoOiBNYXRoLm1heCgwLCBjaGFydFdpZHRoIC0gb2Zmc2V0LmxlZnQgLSBvZmZzZXQucmlnaHQpLAogICAgaGVpZ2h0OiBNYXRoLm1heCgwLCBjaGFydEhlaWdodCAtIG9mZnNldC50b3AgLSBvZmZzZXQuYm90dG9tKQogIH07Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9ob29rcy5qcwp2YXIgdXNlUGxvdEFyZWEgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBsb3RBcmVhKTsKfTsKdmFyIHVzZUFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwRGF0YVBvaW50cyk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9BY3RpdmVQb2ludHMuanMKZnVuY3Rpb24gb3duS2V5czI2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBBY3RpdmVQb2ludCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBwb2ludDogcG9pbnQ0LAogICAgY2hpbGRJbmRleCwKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGRhdGFLZXksCiAgICBjbGlwUGF0aAogIH0gPSBfcmVmMjsKICBpZiAoYWN0aXZlRG90ID09PSBmYWxzZSB8fCBwb2ludDQueCA9PSBudWxsIHx8IHBvaW50NC55ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZG90UHJvcHNUeXBlZCA9IHsKICAgIGluZGV4OiBjaGlsZEluZGV4LAogICAgZGF0YUtleSwKICAgIGN4OiBwb2ludDQueCwKICAgIGN5OiBwb2ludDQueSwKICAgIHI6IDQsCiAgICBmaWxsOiBtYWluQ29sb3IgIT09IG51bGwgJiYgbWFpbkNvbG9yICE9PSB2b2lkIDAgPyBtYWluQ29sb3IgOiAibm9uZSIsCiAgICBzdHJva2VXaWR0aDogMiwKICAgIHN0cm9rZTogIiNmZmYiLAogICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICB2YWx1ZTogcG9pbnQ0LnZhbHVlCiAgfTsKICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjYoX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNih7fSwgZG90UHJvcHNUeXBlZCksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGFjdGl2ZURvdCkpLCBhZGFwdEV2ZW50SGFuZGxlcnMoYWN0aXZlRG90KSk7CiAgdmFyIGRvdDsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5pc1ZhbGlkRWxlbWVudCkoYWN0aXZlRG90KSkgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5jbG9uZUVsZW1lbnQpKGFjdGl2ZURvdCwgZG90UHJvcHMpOwogIH0gZWxzZSBpZiAodHlwZW9mIGFjdGl2ZURvdCA9PT0gImZ1bmN0aW9uIikgewogICAgZG90ID0gYWN0aXZlRG90KGRvdFByb3BzKTsKICB9IGVsc2UgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChEb3QsIGRvdFByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFjdGl2ZS1kb3QiLAogICAgY2xpcFBhdGgKICB9LCBkb3QpOwp9OwpmdW5jdGlvbiBBY3RpdmVQb2ludHMoX3JlZjIpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgbWFpbkNvbG9yLAogICAgYWN0aXZlRG90LAogICAgaXRlbURhdGFLZXksCiAgICBjbGlwUGF0aCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5hY3RpdmVEb3QKICB9ID0gX3JlZjI7CiAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCk7CiAgdmFyIGFjdGl2ZURhdGFQb2ludHMgPSB1c2VBY3RpdmVUb29sdGlwRGF0YVBvaW50cygpOwogIGlmIChwb2ludHMgPT0gbnVsbCB8fCBhY3RpdmVEYXRhUG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgYWN0aXZlUG9pbnQgPSBwb2ludHMuZmluZCgocCkgPT4gYWN0aXZlRGF0YVBvaW50cy5pbmNsdWRlcyhwLnBheWxvYWQpKTsKICBpZiAoaXNOdWxsaXNoKGFjdGl2ZVBvaW50KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50LCB7CiAgICBwb2ludDogYWN0aXZlUG9pbnQsCiAgICBjaGlsZEluZGV4OiBOdW1iZXIoYWN0aXZlVG9vbHRpcEluZGV4KSwKICAgIG1haW5Db2xvciwKICAgIGRhdGFLZXk6IGl0ZW1EYXRhS2V5LAogICAgYWN0aXZlRG90LAogICAgY2xpcFBhdGgKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZXJyb3JCYXJTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlOSA9IHt9Owp2YXIgZXJyb3JCYXJTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiZXJyb3JCYXJzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTksCiAgcmVkdWNlcnM6IHsKICAgIGFkZEVycm9yQmFyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgewogICAgICAgIGl0ZW1JZCwKICAgICAgICBlcnJvckJhcgogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmICghc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBbXTsKICAgICAgfQogICAgICBzdGF0ZVtpdGVtSWRdLnB1c2goZXJyb3JCYXIpOwogICAgfSwKICAgIHJlcGxhY2VFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgcHJldiwKICAgICAgICBuZXh0CiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gc3RhdGVbaXRlbUlkXS5tYXAoKGUpID0+IGUuZGF0YUtleSA9PT0gcHJldi5kYXRhS2V5ICYmIGUuZGlyZWN0aW9uID09PSBwcmV2LmRpcmVjdGlvbiA/IG5leHQgOiBlKTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZUVycm9yQmFyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgewogICAgICAgIGl0ZW1JZCwKICAgICAgICBlcnJvckJhcgogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IHN0YXRlW2l0ZW1JZF0uZmlsdGVyKChlKSA9PiBlLmRhdGFLZXkgIT09IGVycm9yQmFyLmRhdGFLZXkgfHwgZS5kaXJlY3Rpb24gIT09IGVycm9yQmFyLmRpcmVjdGlvbik7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZEVycm9yQmFyLAogIHJlcGxhY2VFcnJvckJhciwKICByZW1vdmVFcnJvckJhcgp9ID0gZXJyb3JCYXJTbGljZS5hY3Rpb25zOwp2YXIgZXJyb3JCYXJSZWR1Y2VyID0gZXJyb3JCYXJTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vR3JhcGhpY2FsSXRlbUNsaXBQYXRoLmpzCnZhciBSZWFjdDIxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCkgewogIHZhciBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYsIF95QXhpcyRhbGxvd0RhdGFPdmVyZjsKICB2YXIgeEF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgbmVlZENsaXBYID0gKF94QXhpcyRhbGxvd0RhdGFPdmVyZiA9IHhBeGlzID09PSBudWxsIHx8IHhBeGlzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB4QXhpcy5hbGxvd0RhdGFPdmVyZmxvdykgIT09IG51bGwgJiYgX3hBeGlzJGFsbG93RGF0YU92ZXJmICE9PSB2b2lkIDAgPyBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgOiBpbXBsaWNpdFhBeGlzLmFsbG93RGF0YU92ZXJmbG93OwogIHZhciBuZWVkQ2xpcFkgPSAoX3lBeGlzJGFsbG93RGF0YU92ZXJmID0geUF4aXMgPT09IG51bGwgfHwgeUF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHlBeGlzLmFsbG93RGF0YU92ZXJmbG93KSAhPT0gbnVsbCAmJiBfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgIT09IHZvaWQgMCA/IF95QXhpcyRhbGxvd0RhdGFPdmVyZiA6IGltcGxpY2l0WUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3c7CiAgdmFyIG5lZWRDbGlwID0gbmVlZENsaXBYIHx8IG5lZWRDbGlwWTsKICByZXR1cm4gewogICAgbmVlZENsaXAsCiAgICBuZWVkQ2xpcFgsCiAgICBuZWVkQ2xpcFkKICB9Owp9CmZ1bmN0aW9uIEdyYXBoaWNhbEl0ZW1DbGlwUGF0aChfcmVmMikgewogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZCwKICAgIGNsaXBQYXRoSWQKICB9ID0gX3JlZjI7CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICB2YXIgewogICAgbmVlZENsaXBYLAogICAgbmVlZENsaXBZLAogICAgbmVlZENsaXAKICB9ID0gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpOwogIGlmICghbmVlZENsaXAgfHwgIXBsb3RBcmVhKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwbG90QXJlYTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjEuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICBpZDogImNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjEuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IG5lZWRDbGlwWCA/IHgyIDogeDIgLSB3aWR0aCAvIDIsCiAgICB5OiBuZWVkQ2xpcFkgPyB5MiA6IHkyIC0gaGVpZ2h0IC8gMiwKICAgIHdpZHRoOiBuZWVkQ2xpcFggPyB3aWR0aCA6IHdpZHRoICogMiwKICAgIGhlaWdodDogbmVlZENsaXBZID8gaGVpZ2h0IDogaGVpZ2h0ICogMgogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LXJlZHV4L2Rpc3QvcmVhY3QtcmVkdXgubWpzCnZhciBSZWFjdDIyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwp2YXIgaW1wb3J0X3dpdGhfc2VsZWN0b3IyID0gX190b0VTTShyZXF1aXJlX3dpdGhfc2VsZWN0b3IyKCksIDEpOwp2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwp2YXIgUkVBQ1RfTUVNT19UWVBFID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKdmFyIEZvcndhcmRSZWYgPSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOwp2YXIgTWVtbyA9IFJFQUNUX01FTU9fVFlQRTsKZnVuY3Rpb24gZGVmYXVsdE5vb3BCYXRjaChjYWxsYmFjaykgewogIGNhbGxiYWNrKCk7Cn0KZnVuY3Rpb24gY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uKCkgewogIGxldCBmaXJzdCA9IG51bGw7CiAgbGV0IGxhc3QyID0gbnVsbDsKICByZXR1cm4gewogICAgY2xlYXIoKSB7CiAgICAgIGZpcnN0ID0gbnVsbDsKICAgICAgbGFzdDIgPSBudWxsOwogICAgfSwKICAgIG5vdGlmeSgpIHsKICAgICAgZGVmYXVsdE5vb3BCYXRjaCgoKSA9PiB7CiAgICAgICAgbGV0IGxpc3RlbmVyMiA9IGZpcnN0OwogICAgICAgIHdoaWxlIChsaXN0ZW5lcjIpIHsKICAgICAgICAgIGxpc3RlbmVyMi5jYWxsYmFjaygpOwogICAgICAgICAgbGlzdGVuZXIyID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBnZXQoKSB7CiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IFtdOwogICAgICBsZXQgbGlzdGVuZXIyID0gZmlyc3Q7CiAgICAgIHdoaWxlIChsaXN0ZW5lcjIpIHsKICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcjIpOwogICAgICAgIGxpc3RlbmVyMiA9IGxpc3RlbmVyMi5uZXh0OwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICB9LAogICAgc3Vic2NyaWJlKGNhbGxiYWNrKSB7CiAgICAgIGxldCBpc1N1YnNjcmliZWQgPSB0cnVlOwogICAgICBjb25zdCBsaXN0ZW5lcjIgPSBsYXN0MiA9IHsKICAgICAgICBjYWxsYmFjaywKICAgICAgICBuZXh0OiBudWxsLAogICAgICAgIHByZXY6IGxhc3QyCiAgICAgIH07CiAgICAgIGlmIChsaXN0ZW5lcjIucHJldikgewogICAgICAgIGxpc3RlbmVyMi5wcmV2Lm5leHQgPSBsaXN0ZW5lcjI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjI7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkgewogICAgICAgIGlmICghaXNTdWJzY3JpYmVkIHx8IGZpcnN0ID09PSBudWxsKSByZXR1cm47CiAgICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgICAgaWYgKGxpc3RlbmVyMi5uZXh0KSB7CiAgICAgICAgICBsaXN0ZW5lcjIubmV4dC5wcmV2ID0gbGlzdGVuZXIyLnByZXY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxhc3QyID0gbGlzdGVuZXIyLnByZXY7CiAgICAgICAgfQogICAgICAgIGlmIChsaXN0ZW5lcjIucHJldikgewogICAgICAgICAgbGlzdGVuZXIyLnByZXYubmV4dCA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaXJzdCA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9Owp9CnZhciBudWxsTGlzdGVuZXJzID0gewogIG5vdGlmeSgpIHsKICB9LAogIGdldDogKCkgPT4gW10KfTsKZnVuY3Rpb24gY3JlYXRlU3Vic2NyaXB0aW9uKHN0b3JlLCBwYXJlbnRTdWIpIHsKICBsZXQgdW5zdWJzY3JpYmU7CiAgbGV0IGxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7CiAgbGV0IHN1YnNjcmlwdGlvbnNBbW91bnQgPSAwOwogIGxldCBzZWxmU3Vic2NyaWJlZCA9IGZhbHNlOwogIGZ1bmN0aW9uIGFkZE5lc3RlZFN1YihsaXN0ZW5lcjIpIHsKICAgIHRyeVN1YnNjcmliZSgpOwogICAgY29uc3QgY2xlYW51cExpc3RlbmVyID0gbGlzdGVuZXJzLnN1YnNjcmliZShsaXN0ZW5lcjIpOwogICAgbGV0IHJlbW92ZWQgPSBmYWxzZTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmICghcmVtb3ZlZCkgewogICAgICAgIHJlbW92ZWQgPSB0cnVlOwogICAgICAgIGNsZWFudXBMaXN0ZW5lcigpOwogICAgICAgIHRyeVVuc3Vic2NyaWJlKCk7CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIG5vdGlmeU5lc3RlZFN1YnMoKSB7CiAgICBsaXN0ZW5lcnMubm90aWZ5KCk7CiAgfQogIGZ1bmN0aW9uIGhhbmRsZUNoYW5nZVdyYXBwZXIoKSB7CiAgICBpZiAoc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UpIHsKICAgICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UoKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaXNTdWJzY3JpYmVkKCkgewogICAgcmV0dXJuIHNlbGZTdWJzY3JpYmVkOwogIH0KICBmdW5jdGlvbiB0cnlTdWJzY3JpYmUoKSB7CiAgICBzdWJzY3JpcHRpb25zQW1vdW50Kys7CiAgICBpZiAoIXVuc3Vic2NyaWJlKSB7CiAgICAgIHVuc3Vic2NyaWJlID0gcGFyZW50U3ViID8gcGFyZW50U3ViLmFkZE5lc3RlZFN1YihoYW5kbGVDaGFuZ2VXcmFwcGVyKSA6IHN0b3JlLnN1YnNjcmliZShoYW5kbGVDaGFuZ2VXcmFwcGVyKTsKICAgICAgbGlzdGVuZXJzID0gY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVVuc3Vic2NyaWJlKCkgewogICAgc3Vic2NyaXB0aW9uc0Ftb3VudC0tOwogICAgaWYgKHVuc3Vic2NyaWJlICYmIHN1YnNjcmlwdGlvbnNBbW91bnQgPT09IDApIHsKICAgICAgdW5zdWJzY3JpYmUoKTsKICAgICAgdW5zdWJzY3JpYmUgPSB2b2lkIDA7CiAgICAgIGxpc3RlbmVycy5jbGVhcigpOwogICAgICBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlTdWJzY3JpYmVTZWxmKCkgewogICAgaWYgKCFzZWxmU3Vic2NyaWJlZCkgewogICAgICBzZWxmU3Vic2NyaWJlZCA9IHRydWU7CiAgICAgIHRyeVN1YnNjcmliZSgpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZVNlbGYoKSB7CiAgICBpZiAoc2VsZlN1YnNjcmliZWQpIHsKICAgICAgc2VsZlN1YnNjcmliZWQgPSBmYWxzZTsKICAgICAgdHJ5VW5zdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgY29uc3Qgc3Vic2NyaXB0aW9uID0gewogICAgYWRkTmVzdGVkU3ViLAogICAgbm90aWZ5TmVzdGVkU3VicywKICAgIGhhbmRsZUNoYW5nZVdyYXBwZXIsCiAgICBpc1N1YnNjcmliZWQsCiAgICB0cnlTdWJzY3JpYmU6IHRyeVN1YnNjcmliZVNlbGYsCiAgICB0cnlVbnN1YnNjcmliZTogdHJ5VW5zdWJzY3JpYmVTZWxmLAogICAgZ2V0TGlzdGVuZXJzOiAoKSA9PiBsaXN0ZW5lcnMKICB9OwogIHJldHVybiBzdWJzY3JpcHRpb247Cn0KdmFyIGNhblVzZURPTSA9ICgpID0+ICEhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAhPT0gInVuZGVmaW5lZCIpOwp2YXIgaXNET00gPSAvKiBAX19QVVJFX18gKi8gY2FuVXNlRE9NKCk7CnZhciBpc1J1bm5pbmdJblJlYWN0TmF0aXZlID0gKCkgPT4gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnByb2R1Y3QgPT09ICJSZWFjdE5hdGl2ZSI7CnZhciBpc1JlYWN0TmF0aXZlID0gLyogQF9fUFVSRV9fICovIGlzUnVubmluZ0luUmVhY3ROYXRpdmUoKTsKdmFyIGdldFVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QgPSAoKSA9PiBpc0RPTSB8fCBpc1JlYWN0TmF0aXZlID8gUmVhY3QyMi51c2VMYXlvdXRFZmZlY3QgOiBSZWFjdDIyLnVzZUVmZmVjdDsKdmFyIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QgPSAvKiBAX19QVVJFX18gKi8gZ2V0VXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCgpOwpmdW5jdGlvbiBpczMoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IHkyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KZnVuY3Rpb24gc2hhbGxvd0VxdWFsKG9iakEsIG9iakIpIHsKICBpZiAoaXMzKG9iakEsIG9iakIpKSByZXR1cm4gdHJ1ZTsKICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3Qga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICBjb25zdCBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogIGZvciAobGV0IGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGtleXNBW2ldKSB8fCAhaXMzKG9iakFba2V5c0FbaV1dLCBvYmpCW2tleXNBW2ldXSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQp2YXIgRk9SV0FSRF9SRUZfU1RBVElDUyA9IHsKICAkJHR5cGVvZjogdHJ1ZSwKICByZW5kZXI6IHRydWUsCiAgZGVmYXVsdFByb3BzOiB0cnVlLAogIGRpc3BsYXlOYW1lOiB0cnVlLAogIHByb3BUeXBlczogdHJ1ZQp9Owp2YXIgTUVNT19TVEFUSUNTID0gewogICQkdHlwZW9mOiB0cnVlLAogIGNvbXBhcmU6IHRydWUsCiAgZGVmYXVsdFByb3BzOiB0cnVlLAogIGRpc3BsYXlOYW1lOiB0cnVlLAogIHByb3BUeXBlczogdHJ1ZSwKICB0eXBlOiB0cnVlCn07CnZhciBUWVBFX1NUQVRJQ1MgPSB7CiAgW0ZvcndhcmRSZWZdOiBGT1JXQVJEX1JFRl9TVEFUSUNTLAogIFtNZW1vXTogTUVNT19TVEFUSUNTCn07CnZhciBvYmplY3RQcm90b3R5cGUgPSBPYmplY3QucHJvdG90eXBlOwp2YXIgQ29udGV4dEtleSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKGByZWFjdC1yZWR1eC1jb250ZXh0YCk7CnZhciBnVCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbFRoaXMgOiAoCiAgLyogZmFsbCBiYWNrIHRvIGEgcGVyLW1vZHVsZSBzY29wZSAocHJlLTguMSBiZWhhdmlvdXIpIGlmIGBnbG9iYWxUaGlzYCBpcyBub3QgYXZhaWxhYmxlICovCiAge30KKTsKZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHsKICBpZiAoIVJlYWN0MjIuY3JlYXRlQ29udGV4dCkgcmV0dXJuIHt9OwogIGNvbnN0IGNvbnRleHRNYXAgPSBnVFtDb250ZXh0S2V5XSA/Pz0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgcmVhbENvbnRleHQgPSBjb250ZXh0TWFwLmdldChSZWFjdDIyLmNyZWF0ZUNvbnRleHQpOwogIGlmICghcmVhbENvbnRleHQpIHsKICAgIHJlYWxDb250ZXh0ID0gUmVhY3QyMi5jcmVhdGVDb250ZXh0KAogICAgICBudWxsCiAgICApOwogICAgaWYgKHRydWUpIHsKICAgICAgcmVhbENvbnRleHQuZGlzcGxheU5hbWUgPSAiUmVhY3RSZWR1eCI7CiAgICB9CiAgICBjb250ZXh0TWFwLnNldChSZWFjdDIyLmNyZWF0ZUNvbnRleHQsIHJlYWxDb250ZXh0KTsKICB9CiAgcmV0dXJuIHJlYWxDb250ZXh0Owp9CnZhciBSZWFjdFJlZHV4Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBnZXRDb250ZXh0KCk7CmZ1bmN0aW9uIFByb3ZpZGVyKHByb3ZpZGVyUHJvcHMpIHsKICBjb25zdCB7IGNoaWxkcmVuLCBjb250ZXh0LCBzZXJ2ZXJTdGF0ZSwgc3RvcmUgfSA9IHByb3ZpZGVyUHJvcHM7CiAgY29uc3QgY29udGV4dFZhbHVlID0gUmVhY3QyMi51c2VNZW1vKCgpID0+IHsKICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSk7CiAgICBjb25zdCBiYXNlQ29udGV4dFZhbHVlID0gewogICAgICBzdG9yZSwKICAgICAgc3Vic2NyaXB0aW9uLAogICAgICBnZXRTZXJ2ZXJTdGF0ZTogc2VydmVyU3RhdGUgPyAoKSA9PiBzZXJ2ZXJTdGF0ZSA6IHZvaWQgMAogICAgfTsKICAgIGlmIChmYWxzZSkgewogICAgICByZXR1cm4gYmFzZUNvbnRleHRWYWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHsgaWRlbnRpdHlGdW5jdGlvbkNoZWNrID0gIm9uY2UiLCBzdGFiaWxpdHlDaGVjayA9ICJvbmNlIiB9ID0gcHJvdmlkZXJQcm9wczsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuYXNzaWduKGJhc2VDb250ZXh0VmFsdWUsIHsKICAgICAgICBzdGFiaWxpdHlDaGVjaywKICAgICAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sKICAgICAgfSk7CiAgICB9CiAgfSwgW3N0b3JlLCBzZXJ2ZXJTdGF0ZV0pOwogIGNvbnN0IHByZXZpb3VzU3RhdGUgPSBSZWFjdDIyLnVzZU1lbW8oKCkgPT4gc3RvcmUuZ2V0U3RhdGUoKSwgW3N0b3JlXSk7CiAgdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCgoKSA9PiB7CiAgICBjb25zdCB7IHN1YnNjcmlwdGlvbiB9ID0gY29udGV4dFZhbHVlOwogICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UgPSBzdWJzY3JpcHRpb24ubm90aWZ5TmVzdGVkU3ViczsKICAgIHN1YnNjcmlwdGlvbi50cnlTdWJzY3JpYmUoKTsKICAgIGlmIChwcmV2aW91c1N0YXRlICE9PSBzdG9yZS5nZXRTdGF0ZSgpKSB7CiAgICAgIHN1YnNjcmlwdGlvbi5ub3RpZnlOZXN0ZWRTdWJzKCk7CiAgICB9CiAgICByZXR1cm4gKCkgPT4gewogICAgICBzdWJzY3JpcHRpb24udHJ5VW5zdWJzY3JpYmUoKTsKICAgICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UgPSB2b2lkIDA7CiAgICB9OwogIH0sIFtjb250ZXh0VmFsdWUsIHByZXZpb3VzU3RhdGVdKTsKICBjb25zdCBDb250ZXh0ID0gY29udGV4dCB8fCBSZWFjdFJlZHV4Q29udGV4dDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChDb250ZXh0LlByb3ZpZGVyLCB7IHZhbHVlOiBjb250ZXh0VmFsdWUgfSwgY2hpbGRyZW4pOwp9CnZhciBQcm92aWRlcl9kZWZhdWx0ID0gUHJvdmlkZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvcHJvcHNBcmVFcXVhbC5qcwp2YXIgcHJvcHNUb1NoYWxsb3dDb21wYXJlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJheGlzTGluZSIsICJ0aWNrTGluZSIsICJhY3RpdmVCYXIiLCAiYWN0aXZlRG90IiwgImFjdGl2ZUxhYmVsIiwgImFjdGl2ZVNoYXBlIiwgImFsbG93RXNjYXBlVmlld0JveCIsICJiYWNrZ3JvdW5kIiwgImN1cnNvciIsICJkb3QiLCAibGFiZWwiLCAibGluZSIsICJtYXJnaW4iLCAicGFkZGluZyIsICJwb3NpdGlvbiIsICJzaGFwZSIsICJzdHlsZSIsICJ0aWNrIiwgIndyYXBwZXJTdHlsZSJdKTsKZnVuY3Rpb24gc2FtZVZhbHVlWmVybyh4MiwgeTIpIHsKICBpZiAoeDIgPT0gbnVsbCAmJiB5MiA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKHR5cGVvZiB4MiA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHkyID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIHgyID09PSB5MiB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KICByZXR1cm4geDIgPT09IHkyOwp9CmZ1bmN0aW9uIHByb3BzQXJlRXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpIHsKICB2YXIgYWxsS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsuLi5PYmplY3Qua2V5cyhwcmV2UHJvcHMpLCAuLi5PYmplY3Qua2V5cyhuZXh0UHJvcHMpXSk7CiAgZm9yICh2YXIga2V5IG9mIGFsbEtleXMpIHsKICAgIGlmIChwcm9wc1RvU2hhbGxvd0NvbXBhcmUuaGFzKGtleSkpIHsKICAgICAgaWYgKHByZXZQcm9wc1trZXldID09IG51bGwgJiYgbmV4dFByb3BzW2tleV0gPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghc2hhbGxvd0VxdWFsKHByZXZQcm9wc1trZXldLCBuZXh0UHJvcHNba2V5XSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIXNhbWVWYWx1ZVplcm8ocHJldlByb3BzW2tleV0sIG5leHRQcm9wc1trZXldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnREYXRhQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBDaGFydERhdGFDb250ZXh0UHJvdmlkZXIgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDM1LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgfTsKICAgIH0KICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YShjaGFydERhdGEpKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YSh2b2lkIDApKTsKICAgIH07CiAgfSwgW2NoYXJ0RGF0YSwgZGlzcGF0Y2gsIGlzUGFub3JhbWFdKTsKICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvYnJ1c2hTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTAgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBwYWRkaW5nOiB7CiAgICB0b3A6IDAsCiAgICByaWdodDogMCwKICAgIGJvdHRvbTogMCwKICAgIGxlZnQ6IDAKICB9Cn07CnZhciBicnVzaFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJicnVzaCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUxMCwKICByZWR1Y2VyczogewogICAgc2V0QnJ1c2hTZXR0aW5ncyhfc3RhdGUsIGFjdGlvbikgewogICAgICBpZiAoYWN0aW9uLnBheWxvYWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBpbml0aWFsU3RhdGUxMDsKICAgICAgfQogICAgICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRCcnVzaFNldHRpbmdzCn0gPSBicnVzaFNsaWNlLmFjdGlvbnM7CnZhciBicnVzaFJlZHVjZXIgPSBicnVzaFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2FydGVzaWFuVXRpbHMuanMKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFNjYWxlSGVscGVyID0gY2xhc3MgX1NjYWxlSGVscGVyIHsKICBzdGF0aWMgY3JlYXRlKG9iaikgewogICAgcmV0dXJuIG5ldyBfU2NhbGVIZWxwZXIob2JqKTsKICB9CiAgY29uc3RydWN0b3Ioc2NhbGUpIHsKICAgIHRoaXMuc2NhbGUgPSBzY2FsZTsKICB9CiAgZ2V0IGRvbWFpbigpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmRvbWFpbjsKICB9CiAgZ2V0IHJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUucmFuZ2U7CiAgfQogIGdldCByYW5nZU1pbigpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMF07CiAgfQogIGdldCByYW5nZU1heCgpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMV07CiAgfQogIGdldCBiYW5kd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5iYW5kd2lkdGg7CiAgfQogIGFwcGx5KHZhbHVlKSB7CiAgICB2YXIgewogICAgICBiYW5kQXdhcmUsCiAgICAgIHBvc2l0aW9uCiAgICB9ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgc3dpdGNoIChwb3NpdGlvbikgewogICAgICAgIGNhc2UgInN0YXJ0IjogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJtaWRkbGUiOiB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSkgKyBvZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGNhc2UgImVuZCI6IHsKICAgICAgICAgIHZhciBfb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChiYW5kQXdhcmUpIHsKICAgICAgdmFyIF9vZmZzZXQyID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQyOwogICAgfQogICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogIH0KICBpc0luUmFuZ2UodmFsdWUpIHsKICAgIHZhciByYW5nZTQgPSB0aGlzLnJhbmdlKCk7CiAgICB2YXIgZmlyc3QgPSByYW5nZTRbMF07CiAgICB2YXIgbGFzdDIgPSByYW5nZTRbcmFuZ2U0Lmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIGZpcnN0IDw9IGxhc3QyID8gdmFsdWUgPj0gZmlyc3QgJiYgdmFsdWUgPD0gbGFzdDIgOiB2YWx1ZSA+PSBsYXN0MiAmJiB2YWx1ZSA8PSBmaXJzdDsKICB9Cn07Cl9kZWZpbmVQcm9wZXJ0eTI4KFNjYWxlSGVscGVyLCAiRVBTIiwgMWUtNCk7CmZ1bmN0aW9uIG5vcm1hbGl6ZUFuZ2xlKGFuZ2xlKSB7CiAgcmV0dXJuIChhbmdsZSAlIDE4MCArIDE4MCkgJSAxODA7Cn0KdmFyIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoID0gZnVuY3Rpb24gZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGgyKF9yZWY1KSB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IF9yZWY1OwogIHZhciBhbmdsZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogMDsKICB2YXIgbm9ybWFsaXplZEFuZ2xlID0gbm9ybWFsaXplQW5nbGUoYW5nbGUpOwogIHZhciBhbmdsZVJhZGlhbnMgPSBub3JtYWxpemVkQW5nbGUgKiBNYXRoLlBJIC8gMTgwOwogIHZhciBhbmdsZVRocmVzaG9sZCA9IE1hdGguYXRhbihoZWlnaHQgLyB3aWR0aCk7CiAgdmFyIGFuZ2xlZFdpZHRoID0gYW5nbGVSYWRpYW5zID4gYW5nbGVUaHJlc2hvbGQgJiYgYW5nbGVSYWRpYW5zIDwgTWF0aC5QSSAtIGFuZ2xlVGhyZXNob2xkID8gaGVpZ2h0IC8gTWF0aC5zaW4oYW5nbGVSYWRpYW5zKSA6IHdpZHRoIC8gTWF0aC5jb3MoYW5nbGVSYWRpYW5zKTsKICByZXR1cm4gTWF0aC5hYnMoYW5nbGVkV2lkdGgpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWZlcmVuY2VFbGVtZW50c1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMSA9IHsKICBkb3RzOiBbXSwKICBhcmVhczogW10sCiAgbGluZXM6IFtdCn07CnZhciByZWZlcmVuY2VFbGVtZW50c1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyZWZlcmVuY2VFbGVtZW50cyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUxMSwKICByZWR1Y2VyczogewogICAgYWRkRG90OiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5kb3RzLnB1c2goYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZURvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuZG90cy5maW5kSW5kZXgoKGRvdCkgPT4gZG90ID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5kb3RzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5hcmVhcy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5hcmVhcy5maW5kSW5kZXgoKGFyZWEpID0+IGFyZWEgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmFyZWFzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5saW5lcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgfSwKICAgIHJlbW92ZUxpbmU6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmxpbmVzLmZpbmRJbmRleCgobGluZSkgPT4gbGluZSA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUubGluZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkRG90LAogIHJlbW92ZURvdCwKICBhZGRBcmVhLAogIHJlbW92ZUFyZWEsCiAgYWRkTGluZSwKICByZW1vdmVMaW5lCn0gPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLmFjdGlvbnM7CnZhciByZWZlcmVuY2VFbGVtZW50c1JlZHVjZXIgPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9DbGlwUGF0aFByb3ZpZGVyLmpzCnZhciBSZWFjdDIzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBDbGlwUGF0aElkQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzYuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIENsaXBQYXRoUHJvdmlkZXIgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIFtjbGlwUGF0aElkXSA9ICgwLCBpbXBvcnRfcmVhY3QzNi51c2VTdGF0ZSkoIiIuY29uY2F0KHVuaXF1ZUlkKCJyZWNoYXJ0cyIpLCAiLWNsaXAiKSk7CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICBpZiAocGxvdEFyZWEgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcGxvdEFyZWE7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoQ2xpcFBhdGhJZENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiBjbGlwUGF0aElkCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgaWQ6IGNsaXBQYXRoSWQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIGhlaWdodCwKICAgIHdpZHRoCiAgfSkpKSwgY2hpbGRyZW4pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQ2FydGVzaWFuQXhpcy5qcwp2YXIgUmVhY3QyNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2dldDMgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRFdmVyeU50aFdpdGhDb25kaXRpb24uanMKZnVuY3Rpb24gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKGFycmF5LCBuKSB7CiAgaWYgKG4gPCAxKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIHZhciByZXN1bHQgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBuKSB7CiAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9UaWNrVXRpbHMuanMKZnVuY3Rpb24gZ2V0QW5nbGVkVGlja1dpZHRoKGNvbnRlbnRTaXplLCB1bml0U2l6ZSwgYW5nbGUpIHsKICB2YXIgc2l6ZSA9IHsKICAgIHdpZHRoOiBjb250ZW50U2l6ZS53aWR0aCArIHVuaXRTaXplLndpZHRoLAogICAgaGVpZ2h0OiBjb250ZW50U2l6ZS5oZWlnaHQgKyB1bml0U2l6ZS5oZWlnaHQKICB9OwogIHJldHVybiBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aChzaXplLCBhbmdsZSk7Cn0KZnVuY3Rpb24gZ2V0VGlja0JvdW5kYXJpZXModmlld0JveCwgc2lnbjIsIHNpemVLZXkpIHsKICB2YXIgaXNXaWR0aCA9IHNpemVLZXkgPT09ICJ3aWR0aCI7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIGlmIChzaWduMiA9PT0gMSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGlzV2lkdGggPyB4MiA6IHkyLAogICAgICBlbmQ6IGlzV2lkdGggPyB4MiArIHdpZHRoIDogeTIgKyBoZWlnaHQKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBzdGFydDogaXNXaWR0aCA/IHgyICsgd2lkdGggOiB5MiArIGhlaWdodCwKICAgIGVuZDogaXNXaWR0aCA/IHgyIDogeTIKICB9Owp9CmZ1bmN0aW9uIGlzVmlzaWJsZShzaWduMiwgdGlja1Bvc2l0aW9uLCBnZXRTaXplLCBzdGFydCwgZW5kKSB7CiAgaWYgKHNpZ24yICogdGlja1Bvc2l0aW9uIDwgc2lnbjIgKiBzdGFydCB8fCBzaWduMiAqIHRpY2tQb3NpdGlvbiA+IHNpZ24yICogZW5kKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBzaXplID0gZ2V0U2l6ZSgpOwogIHJldHVybiBzaWduMiAqICh0aWNrUG9zaXRpb24gLSBzaWduMiAqIHNpemUgLyAyIC0gc3RhcnQpID49IDAgJiYgc2lnbjIgKiAodGlja1Bvc2l0aW9uICsgc2lnbjIgKiBzaXplIC8gMiAtIGVuZCkgPD0gMDsKfQpmdW5jdGlvbiBnZXROdW1iZXJJbnRlcnZhbFRpY2tzKHRpY2tzMiwgaW50ZXJ2YWwpIHsKICByZXR1cm4gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKHRpY2tzMiwgaW50ZXJ2YWwgKyAxKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vZ2V0RXF1aWRpc3RhbnRUaWNrcy5qcwpmdW5jdGlvbiBnZXRFcXVpZGlzdGFudFRpY2tzKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIHsKICAgIHN0YXJ0OiBpbml0aWFsU3RhcnQsCiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgaW5kZXggPSAwOwogIHZhciBzdGVwc2l6ZSA9IDE7CiAgdmFyIHN0YXJ0ID0gaW5pdGlhbFN0YXJ0OwogIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wMigpIHsKICAgIHZhciBlbnRyeSA9IHRpY2tzMiA9PT0gbnVsbCB8fCB0aWNrczIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRpY2tzMltpbmRleF07CiAgICBpZiAoZW50cnkgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gewogICAgICAgIHY6IGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIHN0ZXBzaXplKQogICAgICB9OwogICAgfQogICAgdmFyIGkgPSBpbmRleDsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIHZhciB0aWNrQ29vcmQgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIGlzU2hvdyA9IGluZGV4ID09PSAwIHx8IGlzVmlzaWJsZShzaWduMiwgdGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgIGlmICghaXNTaG93KSB7CiAgICAgIGluZGV4ID0gMDsKICAgICAgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgICAgIHN0ZXBzaXplICs9IDE7CiAgICB9CiAgICBpZiAoaXNTaG93KSB7CiAgICAgIHN0YXJ0ID0gdGlja0Nvb3JkICsgc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICBpbmRleCArPSBzdGVwc2l6ZTsKICAgIH0KICB9LCBfcmV0OwogIHdoaWxlIChzdGVwc2l6ZSA8PSByZXN1bHQubGVuZ3RoKSB7CiAgICBfcmV0ID0gX2xvb3AoKTsKICAgIGlmIChfcmV0KSByZXR1cm4gX3JldC52OwogIH0KICByZXR1cm4gW107Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL2dldFRpY2tzLmpzCmZ1bmN0aW9uIG93bktleXMyNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydAogIH0gPSBib3VuZGFyaWVzOwogIHZhciB7CiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcDIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSBsZW4gLSAxKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlICsgc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gZW5kKTsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZ2FwID4gMCA/IGVudHJ5LmNvb3JkaW5hdGUgLSBnYXAgKiBzaWduMiA6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGVudHJ5LnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1Nob3cgPSBpc1Zpc2libGUoc2lnbjIsIGVudHJ5LnRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1Nob3cpIHsKICAgICAgICBlbmQgPSBlbnRyeS50aWNrQ29vcmQgLSBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIF9sb29wKGkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFRpY2tzU3RhcnQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXAsIHByZXNlcnZlRW5kKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgdmFyIHsKICAgIHN0YXJ0LAogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgaWYgKHByZXNlcnZlRW5kKSB7CiAgICB2YXIgdGFpbCA9IHRpY2tzMltsZW4gLSAxXTsKICAgIHZhciB0YWlsU2l6ZSA9IGdldFRpY2tTaXplKHRhaWwsIGxlbiAtIDEpOwogICAgdmFyIHRhaWxHYXAgPSBzaWduMiAqICh0YWlsLmNvb3JkaW5hdGUgKyBzaWduMiAqIHRhaWxTaXplIC8gMiAtIGVuZCk7CiAgICByZXN1bHRbbGVuIC0gMV0gPSB0YWlsID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgdGFpbCksIHt9LCB7CiAgICAgIHRpY2tDb29yZDogdGFpbEdhcCA+IDAgPyB0YWlsLmNvb3JkaW5hdGUgLSB0YWlsR2FwICogc2lnbjIgOiB0YWlsLmNvb3JkaW5hdGUKICAgIH0pOwogICAgaWYgKHRhaWwudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzVGFpbFNob3cgPSBpc1Zpc2libGUoc2lnbjIsIHRhaWwudGlja0Nvb3JkLCAoKSA9PiB0YWlsU2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1RhaWxTaG93KSB7CiAgICAgICAgZW5kID0gdGFpbC50aWNrQ29vcmQgLSBzaWduMiAqICh0YWlsU2l6ZSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbbGVuIC0gMV0gPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCB0YWlsKSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQogIHZhciBjb3VudCA9IHByZXNlcnZlRW5kID8gbGVuIC0gMSA6IGxlbjsKICB2YXIgX2xvb3AyID0gZnVuY3Rpb24gX2xvb3AyMihpMikgewogICAgdmFyIGVudHJ5ID0gcmVzdWx0W2kyXTsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkyKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICBpZiAoaTIgPT09IDApIHsKICAgICAgdmFyIGdhcCA9IHNpZ24yICogKGVudHJ5LmNvb3JkaW5hdGUgLSBzaWduMiAqIGdldFNpemUoKSAvIDIgLSBzdGFydCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA8IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgc3RhcnQgPSBlbnRyeS50aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgIF9sb29wMihpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrcyhwcm9wcywgZm9udFNpemUsIGxldHRlclNwYWNpbmcpIHsKICB2YXIgewogICAgdGljaywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB2aWV3Qm94LAogICAgbWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uLAogICAgaW50ZXJ2YWwsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBhbmdsZQogIH0gPSBwcm9wczsKICBpZiAoIXRpY2tzMiB8fCAhdGlja3MyLmxlbmd0aCB8fCAhdGljaykgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoaXNOdW1iZXIoaW50ZXJ2YWwpIHx8IEdsb2JhbC5pc1NzcikgewogICAgdmFyIF9nZXROdW1iZXJJbnRlcnZhbFRpYzsKICAgIHJldHVybiAoX2dldE51bWJlckludGVydmFsVGljID0gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGlzTnVtYmVyKGludGVydmFsKSA/IGludGVydmFsIDogMCkpICE9PSBudWxsICYmIF9nZXROdW1iZXJJbnRlcnZhbFRpYyAhPT0gdm9pZCAwID8gX2dldE51bWJlckludGVydmFsVGljIDogW107CiAgfQogIHZhciBjYW5kaWRhdGVzID0gW107CiAgdmFyIHNpemVLZXkgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iID8gIndpZHRoIiA6ICJoZWlnaHQiOwogIHZhciB1bml0U2l6ZSA9IHVuaXQyICYmIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRTdHJpbmdTaXplKHVuaXQyLCB7CiAgICBmb250U2l6ZSwKICAgIGxldHRlclNwYWNpbmcKICB9KSA6IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfTsKICB2YXIgZ2V0VGlja1NpemUgPSAoY29udGVudCwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZSA9IHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihjb250ZW50LnZhbHVlLCBpbmRleCkgOiBjb250ZW50LnZhbHVlOwogICAgcmV0dXJuIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRBbmdsZWRUaWNrV2lkdGgoZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSksIHVuaXRTaXplLCBhbmdsZSkgOiBnZXRTdHJpbmdTaXplKHZhbHVlLCB7CiAgICAgIGZvbnRTaXplLAogICAgICBsZXR0ZXJTcGFjaW5nCiAgICB9KVtzaXplS2V5XTsKICB9OwogIHZhciBzaWduMiA9IHRpY2tzMi5sZW5ndGggPj0gMiA/IG1hdGhTaWduKHRpY2tzMlsxXS5jb29yZGluYXRlIC0gdGlja3MyWzBdLmNvb3JkaW5hdGUpIDogMTsKICB2YXIgYm91bmRhcmllcyA9IGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KTsKICBpZiAoaW50ZXJ2YWwgPT09ICJlcXVpZGlzdGFudFByZXNlcnZlU3RhcnQiKSB7CiAgICByZXR1cm4gZ2V0RXF1aWRpc3RhbnRUaWNrcyhzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIGlmIChpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnQiIHx8IGludGVydmFsID09PSAicHJlc2VydmVTdGFydEVuZCIpIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKTsKICB9IGVsc2UgewogICAgY2FuZGlkYXRlcyA9IGdldFRpY2tzRW5kKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKTsKICB9CiAgcmV0dXJuIGNhbmRpZGF0ZXMuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkuaXNTaG93KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1lBeGlzVXRpbHMuanMKdmFyIGdldENhbGN1bGF0ZWRZQXhpc1dpZHRoID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHRpY2tzOiB0aWNrczIsCiAgICBsYWJlbCwKICAgIGxhYmVsR2FwV2l0aFRpY2sgPSA1LAogICAgLy8gRGVmYXVsdCBnYXAgYmV0d2VlbiBsYWJlbCBhbmQgdGljawogICAgdGlja1NpemUgPSAwLAogICAgdGlja01hcmdpbiA9IDAKICB9ID0gX3JlZjI7CiAgdmFyIG1heFRpY2tXaWR0aCA9IDA7CiAgaWYgKHRpY2tzMikgewogICAgQXJyYXkuZnJvbSh0aWNrczIpLmZvckVhY2goKHRpY2tOb2RlKSA9PiB7CiAgICAgIGlmICh0aWNrTm9kZSkgewogICAgICAgIHZhciBiYm94ID0gdGlja05vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgaWYgKGJib3gud2lkdGggPiBtYXhUaWNrV2lkdGgpIHsKICAgICAgICAgIG1heFRpY2tXaWR0aCA9IGJib3gud2lkdGg7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBsYWJlbFdpZHRoID0gbGFiZWwgPyBsYWJlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCA6IDA7CiAgICB2YXIgdGlja1dpZHRoID0gdGlja1NpemUgKyB0aWNrTWFyZ2luOwogICAgdmFyIHVwZGF0ZWRZQXhpc1dpZHRoID0gbWF4VGlja1dpZHRoICsgdGlja1dpZHRoICsgbGFiZWxXaWR0aCArIChsYWJlbCA/IGxhYmVsR2FwV2l0aFRpY2sgOiAwKTsKICAgIHJldHVybiBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKTsKICB9CiAgcmV0dXJuIDA7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBfZXhjbHVkZWQxMCA9IFsiYXhpc0xpbmUiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSIsICJoaWRlIiwgInRpY2tzIiwgImF4aXNUeXBlIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTAocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9leHRlbmRzMTUoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTUgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE1LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czI4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgdmlld0JveDogewogICAgeDogMCwKICAgIHk6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgLy8gVGhlIG9yaWVudGF0aW9uIG9mIGF4aXMKICBvcmllbnRhdGlvbjogImJvdHRvbSIsCiAgLy8gVGhlIHRpY2tzCiAgdGlja3M6IFtdLAogIHN0cm9rZTogIiM2NjYiLAogIHRpY2tMaW5lOiB0cnVlLAogIGF4aXNMaW5lOiB0cnVlLAogIHRpY2s6IHRydWUsCiAgbWlycm9yOiBmYWxzZSwKICBtaW5UaWNrR2FwOiA1LAogIC8vIFRoZSB3aWR0aCBvciBoZWlnaHQgb2YgdGljawogIHRpY2tTaXplOiA2LAogIHRpY2tNYXJnaW46IDIsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwpmdW5jdGlvbiBBeGlzTGluZShheGlzTGluZVByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzCiAgfSA9IGF4aXNMaW5lUHJvcHM7CiAgaWYgKCFheGlzTGluZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBvdGhlclN2Z1Byb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKGF4aXNMaW5lKSksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9KTsKICBpZiAob3JpZW50YXRpb24gPT09ICJ0b3AiIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIikgewogICAgdmFyIG5lZWRIZWlnaHQgPSArKG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiwKICAgICAgeTE6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodCwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiB5MiArIG5lZWRIZWlnaHQgKiBoZWlnaHQKICAgIH0pOwogIH0gZWxzZSB7CiAgICB2YXIgbmVlZFdpZHRoID0gKyhvcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgbWlycm9yKTsKICAgIHByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcHJvcHMpLCB7fSwgewogICAgICB4MTogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTE6IHkyLAogICAgICB4MjogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTI6IHkyICsgaGVpZ2h0CiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE1KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKGF4aXNMaW5lLCAiY2xhc3NOYW1lIikpCiAgfSkpOwp9CmZ1bmN0aW9uIGdldFRpY2tMaW5lQ29vcmQoZGF0YSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikgewogIHZhciB4MSwgeDIyLCB5MSwgeTIyLCB0eCwgdHk7CiAgdmFyIHNpZ24yID0gbWlycm9yID8gLTEgOiAxOwogIHZhciBmaW5hbFRpY2tTaXplID0gZGF0YS50aWNrU2l6ZSB8fCB0aWNrU2l6ZTsKICB2YXIgdGlja0Nvb3JkID0gaXNOdW1iZXIoZGF0YS50aWNrQ29vcmQpID8gZGF0YS50aWNrQ29vcmQgOiBkYXRhLmNvb3JkaW5hdGU7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAidG9wIjoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgKyFtaXJyb3IgKiBoZWlnaHQ7CiAgICAgIHkxID0geTIyIC0gc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eSA9IHkxIC0gc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eCA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgKyFtaXJyb3IgKiB3aWR0aDsKICAgICAgeDEgPSB4MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR4ID0geDEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR5ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgK21pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgK21pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgKyBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgKyBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICB9CiAgcmV0dXJuIHsKICAgIGxpbmU6IHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MjogeDIyLAogICAgICB5MjogeTIyCiAgICB9LAogICAgdGljazogewogICAgICB4OiB0eCwKICAgICAgeTogdHkKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAibWlkZGxlIjsKICB9Cn0KZnVuY3Rpb24gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogICAgY2FzZSAidG9wIjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBtaXJyb3IgPyAiZW5kIiA6ICJzdGFydCI7CiAgfQp9CmZ1bmN0aW9uIFRpY2tJdGVtKHByb3BzKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIHRpY2tQcm9wcywKICAgIHZhbHVlCiAgfSA9IHByb3BzOwogIHZhciB0aWNrSXRlbTsKICB2YXIgY29tYmluZWRDbGFzc05hbWUgPSBjbHN4KHRpY2tQcm9wcy5jbGFzc05hbWUsICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLXZhbHVlIik7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmlzVmFsaWRFbGVtZW50KG9wdGlvbikpIHsKICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY2xvbmVFbGVtZW50KG9wdGlvbiwgX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgdGlja0l0ZW0gPSBvcHRpb24oX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSB7CiAgICB2YXIgY2xhc3NOYW1lID0gInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiOwogICAgaWYgKHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIikgewogICAgICBjbGFzc05hbWUgPSBjbHN4KGNsYXNzTmFtZSwgb3B0aW9uID09PSBudWxsIHx8IG9wdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9uLmNsYXNzTmFtZSk7CiAgICB9CiAgICB0aWNrSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxNSh7fSwgdGlja1Byb3BzLCB7CiAgICAgIGNsYXNzTmFtZQogICAgfSksIHZhbHVlKTsKICB9CiAgcmV0dXJuIHRpY2tJdGVtOwp9CnZhciBUaWNrcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgdGlja3M6IHRpY2tzMiA9IFtdLAogICAgdGljaywKICAgIHRpY2tMaW5lLAogICAgc3Ryb2tlLAogICAgdGlja0Zvcm1hdHRlciwKICAgIHVuaXQ6IHVuaXQyLAogICAgcGFkZGluZywKICAgIHRpY2tUZXh0UHJvcHMsCiAgICBvcmllbnRhdGlvbiwKICAgIG1pcnJvciwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHRpY2tTaXplLAogICAgdGlja01hcmdpbiwKICAgIGZvbnRTaXplLAogICAgbGV0dGVyU3BhY2luZywKICAgIGdldFRpY2tzQ29uZmlnLAogICAgZXZlbnRzLAogICAgYXhpc1R5cGUKICB9ID0gcHJvcHM7CiAgdmFyIGZpbmFsVGlja3MgPSBnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBnZXRUaWNrc0NvbmZpZyksIHt9LCB7CiAgICB0aWNrczogdGlja3MyCiAgfSksIGZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nKTsKICB2YXIgdGV4dEFuY2hvciA9IGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciB2ZXJ0aWNhbEFuY2hvciA9IGdldFRpY2tWZXJ0aWNhbEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKTsKICB2YXIgYXhpc1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKGdldFRpY2tzQ29uZmlnKTsKICB2YXIgY3VzdG9tVGlja1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24odGljayk7CiAgdmFyIHRpY2tMaW5lUHJvcHNPYmplY3QgPSB7fTsKICBpZiAodHlwZW9mIHRpY2tMaW5lID09PSAib2JqZWN0IikgewogICAgdGlja0xpbmVQcm9wc09iamVjdCA9IHRpY2tMaW5lOwogIH0KICB2YXIgdGlja0xpbmVQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGF4aXNQcm9wcyksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9LCB0aWNrTGluZVByb3BzT2JqZWN0KTsKICB2YXIgdGlja0xpbmVDb29yZHMgPSBmaW5hbFRpY2tzLm1hcCgoZW50cnkpID0+IF9vYmplY3RTcHJlYWQyOCh7CiAgICBlbnRyeQogIH0sIGdldFRpY2tMaW5lQ29vcmQoZW50cnksIHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgb3JpZW50YXRpb24sIHRpY2tTaXplLCBtaXJyb3IsIHRpY2tNYXJnaW4pKSk7CiAgdmFyIHRpY2tMaW5lcyA9IHRpY2tMaW5lQ29vcmRzLm1hcCgoX3JlZjIpID0+IHsKICAgIHZhciB7CiAgICAgIGVudHJ5LAogICAgICBsaW5lOiBsaW5lQ29vcmQKICAgIH0gPSBfcmVmMjsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2siLAogICAgICBrZXk6ICJ0aWNrLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCB0aWNrTGluZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNSh7fSwgdGlja0xpbmVQcm9wcywgbGluZUNvb3JkLCB7CiAgICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKHRpY2tMaW5lLCAiY2xhc3NOYW1lIikpCiAgICB9KSkpOwogIH0pOwogIHZhciB0aWNrTGFiZWxzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMiwgaSkgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIHRpY2s6IHRpY2tDb29yZAogICAgfSA9IF9yZWYyOwogICAgdmFyIHRpY2tQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGV4dEFuY2hvciBmcm9tIGF4aXNQcm9wcyBpcyB0eXBlZCBhcyBgc3RyaW5nYCBidXQgVGV4dCB3YW50cyB0eXBlIGBUZXh0QW5jaG9yYAogICAgICB0ZXh0QW5jaG9yLAogICAgICB2ZXJ0aWNhbEFuY2hvcgogICAgfSwgYXhpc1Byb3BzKSwge30sIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tVGlja1Byb3BzIGlzIGNvbnRyaWJ1dGluZyB1bmtub3duIHByb3BzCiAgICAgIGZpbGw6IHN0cm9rZQogICAgfSwgY3VzdG9tVGlja1Byb3BzKSwgdGlja0Nvb3JkKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIHBheWxvYWQ6IGVudHJ5LAogICAgICB2aXNpYmxlVGlja3NDb3VudDogZmluYWxUaWNrcy5sZW5ndGgsCiAgICAgIHRpY2tGb3JtYXR0ZXIsCiAgICAgIHBhZGRpbmcKICAgIH0sIHRpY2tUZXh0UHJvcHMpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTUoewogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVsIiwKICAgICAga2V5OiAidGljay1sYWJlbC0iLmNvbmNhdChlbnRyeS52YWx1ZSwgIi0iKS5jb25jYXQoZW50cnkuY29vcmRpbmF0ZSwgIi0iKS5jb25jYXQoZW50cnkudGlja0Nvb3JkKQogICAgfSwgYWRhcHRFdmVudHNPZkNoaWxkKGV2ZW50cywgZW50cnksIGkpKSwgdGljayAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFRpY2tJdGVtLCB7CiAgICAgIG9wdGlvbjogdGljaywKICAgICAgdGlja1Byb3BzLAogICAgICB2YWx1ZTogIiIuY29uY2F0KHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihlbnRyeS52YWx1ZSwgaSkgOiBlbnRyeS52YWx1ZSkuY29uY2F0KHVuaXQyIHx8ICIiKQogICAgfSkpOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGlja3MgcmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICItdGlja3MiKQogIH0sIHRpY2tMYWJlbHMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVscyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxhYmVscyIpLAogICAgcmVmCiAgfSwgdGlja0xhYmVscykpLCB0aWNrTGluZXMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxpbmVzIikKICB9LCB0aWNrTGluZXMpKTsKfSk7CnZhciBDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNy5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBheGlzTGluZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgY2xhc3NOYW1lLAogICAgaGlkZSwKICAgIHRpY2tzOiB0aWNrczIsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wcywgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKHByb3BzLCBfZXhjbHVkZWQxMCk7CiAgdmFyIFtmb250U2l6ZSwgc2V0Rm9udFNpemVdID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVN0YXRlKSgiIik7CiAgdmFyIFtsZXR0ZXJTcGFjaW5nLCBzZXRMZXR0ZXJTcGFjaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VTdGF0ZSkoIiIpOwogIHZhciB0aWNrUmVmcyA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzNy51c2VJbXBlcmF0aXZlSGFuZGxlKShyZWYsICgpID0+ICh7CiAgICBnZXRDYWxjdWxhdGVkV2lkdGg6ICgpID0+IHsKICAgICAgdmFyIF9wcm9wcyRsYWJlbFJlZjsKICAgICAgcmV0dXJuIGdldENhbGN1bGF0ZWRZQXhpc1dpZHRoKHsKICAgICAgICB0aWNrczogdGlja1JlZnMuY3VycmVudCwKICAgICAgICBsYWJlbDogKF9wcm9wcyRsYWJlbFJlZiA9IHByb3BzLmxhYmVsUmVmKSA9PT0gbnVsbCB8fCBfcHJvcHMkbGFiZWxSZWYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRsYWJlbFJlZi5jdXJyZW50LAogICAgICAgIGxhYmVsR2FwV2l0aFRpY2s6IDUsCiAgICAgICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4KICAgICAgfSk7CiAgICB9CiAgfSkpOwogIHZhciBsYXllclJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VDYWxsYmFjaykoKGVsKSA9PiB7CiAgICBpZiAoZWwpIHsKICAgICAgdmFyIHRpY2tOb2RlcyA9IGVsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICAgICAgdGlja1JlZnMuY3VycmVudCA9IHRpY2tOb2RlczsKICAgICAgdmFyIHRpY2sgPSB0aWNrTm9kZXNbMF07CiAgICAgIGlmICh0aWNrKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aWNrKTsKICAgICAgICB2YXIgY2FsY3VsYXRlZEZvbnRTaXplID0gY29tcHV0ZWRTdHlsZS5mb250U2l6ZTsKICAgICAgICB2YXIgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgPSBjb21wdXRlZFN0eWxlLmxldHRlclNwYWNpbmc7CiAgICAgICAgaWYgKGNhbGN1bGF0ZWRGb250U2l6ZSAhPT0gZm9udFNpemUgfHwgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgIT09IGxldHRlclNwYWNpbmcpIHsKICAgICAgICAgIHNldEZvbnRTaXplKGNhbGN1bGF0ZWRGb250U2l6ZSk7CiAgICAgICAgICBzZXRMZXR0ZXJTcGFjaW5nKGNhbGN1bGF0ZWRMZXR0ZXJTcGFjaW5nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCBbZm9udFNpemUsIGxldHRlclNwYWNpbmddKTsKICBpZiAoaGlkZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICh3aWR0aCAhPSBudWxsICYmIHdpZHRoIDw9IDAgfHwgaGVpZ2h0ICE9IG51bGwgJiYgaGVpZ2h0IDw9IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wcy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzIiwgY2xhc3NOYW1lKQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoQXhpc0xpbmUsIHsKICAgIHg6IHByb3BzLngsCiAgICB5OiBwcm9wcy55LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIGF4aXNMaW5lLAogICAgb3RoZXJTdmdQcm9wczogc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFRpY2tzLCB7CiAgICByZWY6IGxheWVyUmVmLAogICAgYXhpc1R5cGUsCiAgICBldmVudHM6IHJlc3QsCiAgICBmb250U2l6ZSwKICAgIGdldFRpY2tzQ29uZmlnOiBwcm9wcywKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbGV0dGVyU3BhY2luZywKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrTGluZTogcHJvcHMudGlja0xpbmUsCiAgICB0aWNrTWFyZ2luOiBwcm9wcy50aWNrTWFyZ2luLAogICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgdGlja1RleHRQcm9wczogcHJvcHMudGlja1RleHRQcm9wcywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGxvd2VyV2lkdGg6IHByb3BzLndpZHRoLAogICAgdXBwZXJXaWR0aDogcHJvcHMud2lkdGgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsLAogICAgbGFiZWxSZWY6IHByb3BzLmxhYmVsUmVmCiAgfSksIHByb3BzLmNoaWxkcmVuKSkpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5mb3J3YXJkUmVmKChvdXRzaWRlUHJvcHMsIHJlZikgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50LCBfZXh0ZW5kczE1KHt9LCBwcm9wcywgewogICAgcmVmCiAgfSkpOwp9KTsKQ2FydGVzaWFuQXhpcy5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5BeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkdyaWQuanMKdmFyIFJlYWN0MjUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxMSA9IFsieDEiLCAieTEiLCAieDIiLCAieTIiLCAia2V5Il07CnZhciBfZXhjbHVkZWQyNSA9IFsib2Zmc2V0Il07CnZhciBfZXhjbHVkZWQzMiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CnZhciBfZXhjbHVkZWQ0MiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIG93bktleXMyOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMxKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMxKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMxKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMxKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMxKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE2KCkgewogIHJldHVybiBfZXh0ZW5kczE2ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTEocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBCYWNrZ3JvdW5kID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGZpbGwKICB9ID0gcHJvcHM7CiAgaWYgKCFmaWxsIHx8IGZpbGwgPT09ICJub25lIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJ5CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHJ5LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogIH0pOwp9OwpmdW5jdGlvbiBMaW5lSXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBsaW5lSXRlbVByb3BzCiAgfSA9IF9yZWYyOwogIHZhciBsaW5lSXRlbTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjUuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jbG9uZUVsZW1lbnQob3B0aW9uLCBsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIGxpbmVJdGVtID0gb3B0aW9uKGxpbmVJdGVtUHJvcHMpOwogIH0gZWxzZSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNOb0V2ZW50OwogICAgdmFyIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGtleQogICAgfSA9IGxpbmVJdGVtUHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGxpbmVJdGVtUHJvcHMsIF9leGNsdWRlZDExKTsKICAgIHZhciBfcmVmMjIgPSAoX3N2Z1Byb3BlcnRpZXNOb0V2ZW50ID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycykpICE9PSBudWxsICYmIF9zdmdQcm9wZXJ0aWVzTm9FdmVudCAhPT0gdm9pZCAwID8gX3N2Z1Byb3BlcnRpZXNOb0V2ZW50IDoge30sIHsKICAgICAgb2Zmc2V0OiBfXwogICAgfSA9IF9yZWYyMiwgcmVzdE9mRmlsdGVyZWRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKF9yZWYyMiwgX2V4Y2x1ZGVkMjUpOwogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNih7fSwgcmVzdE9mRmlsdGVyZWRQcm9wcywgewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyLAogICAgICB5MiwKICAgICAgZmlsbDogIm5vbmUiLAogICAgICBrZXkKICAgIH0pKTsKICB9CiAgcmV0dXJuIGxpbmVJdGVtOwp9CmZ1bmN0aW9uIEhvcml6b250YWxHcmlkTGluZXMocHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB3aWR0aCwKICAgIGhvcml6b250YWwgPSB0cnVlLAogICAgaG9yaXpvbnRhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxQb2ludHMgfHwgIWhvcml6b250YWxQb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IHByb3BzLCBvdGhlckxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkMzIpOwogIHZhciBpdGVtcyA9IGhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogeDIsCiAgICAgIHkxOiBlbnRyeSwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiBlbnRyeSwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBob3Jpem9udGFsLAogICAgICBsaW5lSXRlbVByb3BzCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgdmVydGljYWwgPSB0cnVlLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCF2ZXJ0aWNhbCB8fCAhdmVydGljYWxQb2ludHMgfHwgIXZlcnRpY2FsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEocHJvcHMsIF9leGNsdWRlZDQyKTsKICB2YXIgaXRlbXMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIG90aGVyTGluZUl0ZW1Qcm9wcyksIHt9LCB7CiAgICAgIHgxOiBlbnRyeSwKICAgICAgeTE6IHkyLAogICAgICB4MjogZW50cnksCiAgICAgIHkyOiB5MiArIGhlaWdodCwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAgb3B0aW9uOiB2ZXJ0aWNhbCwKICAgICAgbGluZUl0ZW1Qcm9wcywKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKQogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC12ZXJ0aWNhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFN0cmlwZXMocHJvcHMpIHsKICB2YXIgewogICAgaG9yaXpvbnRhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICBob3Jpem9udGFsID0gdHJ1ZQogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxGaWxsIHx8ICFob3Jpem9udGFsRmlsbC5sZW5ndGggfHwgaG9yaXpvbnRhbFBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzID0gaG9yaXpvbnRhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHkyIC0geTIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHkyICE9PSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVIZWlnaHQgPSBsYXN0U3RyaXBlID8geTIgKyBoZWlnaHQgLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIGhvcml6b250YWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeTogZW50cnksCiAgICAgIHg6IHgyLAogICAgICBoZWlnaHQ6IGxpbmVIZWlnaHQsCiAgICAgIHdpZHRoLAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogaG9yaXpvbnRhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsRmlsbCB8fCAhdmVydGljYWxGaWxsLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHgyIC0geDIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHgyICE9PSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbMF0pIHsKICAgIHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy51bnNoaWZ0KDApOwogIH0KICB2YXIgaXRlbXMgPSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXTsKICAgIHZhciBsaW5lV2lkdGggPSBsYXN0U3RyaXBlID8geDIgKyB3aWR0aCAtIGVudHJ5IDogcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVXaWR0aCA8PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGNvbG9ySW5kZXggPSBpICUgdmVydGljYWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeDogZW50cnksCiAgICAgIHk6IHkyLAogICAgICB3aWR0aDogbGluZVdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICBmaWxsOiB2ZXJ0aWNhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLXZlcnRpY2FsIgogIH0sIGl0ZW1zKTsKfQp2YXIgZGVmYXVsdFZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSAoX3JlZjMsIHN5bmNXaXRoVGlja3MpID0+IHsKICB2YXIgewogICAgeEF4aXMsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9mZnNldAogIH0gPSBfcmVmMzsKICByZXR1cm4gZ2V0Q29vcmRpbmF0ZXNPZkdyaWQoZ2V0VGlja3MoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpLCB4QXhpcyksIHt9LCB7CiAgICB0aWNrczogZ2V0VGlja3NPZkF4aXMoeEF4aXMsIHRydWUpLAogICAgdmlld0JveDogewogICAgICB4OiAwLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9CiAgfSkpLCBvZmZzZXQubGVmdCwgb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmNCwgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB5QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWY0OwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHlBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh5QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0LCBzeW5jV2l0aFRpY2tzKTsKfTsKdmFyIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMgPSB7CiAgaG9yaXpvbnRhbDogdHJ1ZSwKICB2ZXJ0aWNhbDogdHJ1ZSwKICAvLyBUaGUgb3JkaW5hdGVzIG9mIGhvcml6b250YWwgZ3JpZCBsaW5lcwogIGhvcml6b250YWxQb2ludHM6IFtdLAogIC8vIFRoZSBhYnNjaXNzYXMgb2YgdmVydGljYWwgZ3JpZCBsaW5lcwogIHZlcnRpY2FsUG9pbnRzOiBbXSwKICBzdHJva2U6ICIjY2NjIiwKICBmaWxsOiAibm9uZSIsCiAgLy8gVGhlIGZpbGwgb2YgY29sb3JzIG9mIGdyaWQgbGluZXMKICB2ZXJ0aWNhbEZpbGw6IFtdLAogIGhvcml6b250YWxGaWxsOiBbXSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgc3luY1dpdGhUaWNrczogZmFsc2UsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuZ3JpZAp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5HcmlkKHByb3BzKSB7CiAgdmFyIGNoYXJ0V2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGNoYXJ0SGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cyA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMpKSwge30sIHsKICAgIHg6IGlzTnVtYmVyKHByb3BzLngpID8gcHJvcHMueCA6IG9mZnNldC5sZWZ0LAogICAgeTogaXNOdW1iZXIocHJvcHMueSkgPyBwcm9wcy55IDogb2Zmc2V0LnRvcCwKICAgIHdpZHRoOiBpc051bWJlcihwcm9wcy53aWR0aCkgPyBwcm9wcy53aWR0aCA6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogaXNOdW1iZXIocHJvcHMuaGVpZ2h0KSA/IHByb3BzLmhlaWdodCA6IG9mZnNldC5oZWlnaHQKICB9KTsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzeW5jV2l0aFRpY2tzLAogICAgaG9yaXpvbnRhbFZhbHVlcywKICAgIHZlcnRpY2FsVmFsdWVzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3Ioc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMudmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5ob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgfHwgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgewogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgaWYgKCghaG9yaXpvbnRhbFBvaW50cyB8fCAhaG9yaXpvbnRhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBpc0hvcml6b250YWxWYWx1ZXMgPSBob3Jpem9udGFsVmFsdWVzICYmIGhvcml6b250YWxWYWx1ZXMubGVuZ3RoOwogICAgdmFyIGdlbmVyYXRvclJlc3VsdCA9IGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHlBeGlzOiB5QXhpcyA/IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIHlBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNIb3Jpem9udGFsVmFsdWVzID8gaG9yaXpvbnRhbFZhbHVlcyA6IHlBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzSG9yaXpvbnRhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpLCAiaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBnZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoZ2VuZXJhdG9yUmVzdWx0KSkgewogICAgICBob3Jpem9udGFsUG9pbnRzID0gZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICBpZiAoKCF2ZXJ0aWNhbFBvaW50cyB8fCAhdmVydGljYWxQb2ludHMubGVuZ3RoKSAmJiB0eXBlb2YgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzVmVydGljYWxWYWx1ZXMgPSB2ZXJ0aWNhbFZhbHVlcyAmJiB2ZXJ0aWNhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgX2dlbmVyYXRvclJlc3VsdCA9IHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IoewogICAgICB4QXhpczogeEF4aXMgPyBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCB4QXhpcyksIHt9LCB7CiAgICAgICAgdGlja3M6IGlzVmVydGljYWxWYWx1ZXMgPyB2ZXJ0aWNhbFZhbHVlcyA6IHhBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzVmVydGljYWxWYWx1ZXMgPyB0cnVlIDogc3luY1dpdGhUaWNrcyk7CiAgICB3YXJuKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCksICJ2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBfZ2VuZXJhdG9yUmVzdWx0LCAiXSIpKTsKICAgIGlmIChBcnJheS5pc0FycmF5KF9nZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIHZlcnRpY2FsUG9pbnRzID0gX2dlbmVyYXRvclJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQiCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChCYWNrZ3JvdW5kLCB7CiAgICBmaWxsOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGwsCiAgICBmaWxsT3BhY2l0eTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5maWxsT3BhY2l0eSwKICAgIHg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueCwKICAgIHk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueSwKICAgIHdpZHRoOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhlaWdodCwKICAgIHJ5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnJ5CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFN0cmlwZXMsIF9leHRlbmRzMTYoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIGhvcml6b250YWxQb2ludHMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxTdHJpcGVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICB2ZXJ0aWNhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsR3JpZExpbmVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgeEF4aXMsCiAgICB5QXhpcwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChWZXJ0aWNhbEdyaWRMaW5lcywgX2V4dGVuZHMxNih7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgb2Zmc2V0LAogICAgdmVydGljYWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpKSk7Cn0KQ2FydGVzaWFuR3JpZC5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5HcmlkIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QuanMKZnVuY3Rpb24gZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90KGRvdCkgewogIHZhciBwcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGRvdCk7CiAgdmFyIGRlZmF1bHRSID0gMzsKICB2YXIgZGVmYXVsdFN0cm9rZVdpZHRoID0gMjsKICBpZiAocHJvcHMgIT0gbnVsbCkgewogICAgdmFyIHsKICAgICAgcjogcjIsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9ID0gcHJvcHM7CiAgICB2YXIgcmVhbFIgPSBOdW1iZXIocjIpOwogICAgdmFyIHJlYWxTdHJva2VXaWR0aCA9IE51bWJlcihzdHJva2VXaWR0aCk7CiAgICBpZiAoTnVtYmVyLmlzTmFOKHJlYWxSKSB8fCByZWFsUiA8IDApIHsKICAgICAgcmVhbFIgPSBkZWZhdWx0UjsKICAgIH0KICAgIGlmIChOdW1iZXIuaXNOYU4ocmVhbFN0cm9rZVdpZHRoKSB8fCByZWFsU3Ryb2tlV2lkdGggPCAwKSB7CiAgICAgIHJlYWxTdHJva2VXaWR0aCA9IGRlZmF1bHRTdHJva2VXaWR0aDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHI6IHJlYWxSLAogICAgICBzdHJva2VXaWR0aDogcmVhbFN0cm9rZVdpZHRoCiAgICB9OwogIH0KICByZXR1cm4gewogICAgcjogZGVmYXVsdFIsCiAgICBzdHJva2VXaWR0aDogZGVmYXVsdFN0cm9rZVdpZHRoCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgUmVhY3QyNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJlYVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WEF4aXNXaXRoU2NhbGUgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RBeGlzV2l0aFNjYWxlKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFhBeGlzVGlja3MgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WUF4aXNUaWNrcyA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdEJhbmRTaXplID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3NdLCAobGF5b3V0LCB4QXhpcywgeUF4aXMsIHhBeGlzVGlja3MsIHlBeGlzVGlja3MpID0+IHsKICBpZiAoaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHhBeGlzLCB4QXhpc1RpY2tzLCBmYWxzZSk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh5QXhpcywgeUF4aXNUaWNrcywgZmFsc2UpOwp9KTsKdmFyIHBpY2tBcmVhSWQgPSAoX3N0YXRlLCBfeEF4aXNJZCwgX3lBeGlzSWQsIF9pc1Bhbm9yYW1hLCBpZCkgPT4gaWQ7CnZhciBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zLCBwaWNrQXJlYUlkXSwgKGdyYXBoaWNhbEl0ZW1zLCBpZCkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIikuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaWQpKTsKdmFyIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSA9IChzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpID0+IHsKICB2YXIgX3N0YWNrR3JvdXBzJHN0YWNrSWQ7CiAgdmFyIGFyZWFTZXR0aW5ncyA9IHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICB2YXIgaXNYQXhpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKTsKICB2YXIgc3RhY2tHcm91cHM7CiAgaWYgKGlzWEF4aXNDYXRlZ29yaWNhbCkgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfSBlbHNlIHsKICAgIHN0YWNrR3JvdXBzID0gc2VsZWN0U3RhY2tHcm91cHMoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwogIH0KICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHN0YWNrSWQKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBzdGFja1Nlcmllc0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoYXJlYVNldHRpbmdzKTsKICBpZiAoc3RhY2tJZCA9PSBudWxsIHx8IHN0YWNrU2VyaWVzSWRlbnRpZmllciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZ3JvdXBzID0gKF9zdGFja0dyb3VwcyRzdGFja0lkID0gc3RhY2tHcm91cHNbc3RhY2tJZF0pID09PSBudWxsIHx8IF9zdGFja0dyb3VwcyRzdGFja0lkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfc3RhY2tHcm91cHMkc3RhY2tJZC5zdGFja2VkRGF0YTsKICByZXR1cm4gZ3JvdXBzID09PSBudWxsIHx8IGdyb3VwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JvdXBzLmZpbmQoKHYpID0+IHYua2V5ID09PSBzdGFja1Nlcmllc0lkZW50aWZpZXIpOwp9Owp2YXIgc2VsZWN0QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WEF4aXNXaXRoU2NhbGUsIHNlbGVjdFlBeGlzV2l0aFNjYWxlLCBzZWxlY3RYQXhpc1RpY2tzLCBzZWxlY3RZQXhpc1RpY2tzLCBzZWxlY3RHcmFwaGljYWxJdGVtU3RhY2tlZERhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hLCBzZWxlY3RCYW5kU2l6ZSwgc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzLCBzZWxlY3RDaGFydEJhc2VWYWx1ZV0sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcywgc3RhY2tlZERhdGEsIF9yZWYyLCBiYW5kU2l6ZSwgYXJlYVNldHRpbmdzLCBjaGFydEJhc2VWYWx1ZSkgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoYXJlYVNldHRpbmdzID09IG51bGwgfHwgbGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHhBeGlzID09IG51bGwgfHwgeUF4aXMgPT0gbnVsbCB8fCB4QXhpc1RpY2tzID09IG51bGwgfHwgeUF4aXNUaWNrcyA9PSBudWxsIHx8IHhBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IHlBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IGJhbmRTaXplID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhCiAgfSA9IGFyZWFTZXR0aW5nczsKICB2YXIgZGlzcGxheWVkRGF0YTsKICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDApIHsKICAgIGRpc3BsYXllZERhdGEgPSBkYXRhOwogIH0gZWxzZSB7CiAgICBkaXNwbGF5ZWREYXRhID0gY2hhcnREYXRhID09PSBudWxsIHx8IGNoYXJ0RGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2hhcnREYXRhLnNsaWNlKGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXggKyAxKTsKICB9CiAgaWYgKGRpc3BsYXllZERhdGEgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbXB1dGVBcmVhKHsKICAgIGxheW91dCwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGRhdGFTdGFydEluZGV4LAogICAgYXJlYVNldHRpbmdzLAogICAgc3RhY2tlZERhdGEsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICBiYW5kU2l6ZQogIH0pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0FyZWEuanMKdmFyIF9leGNsdWRlZDEyID0gWyJpZCJdOwp2YXIgX2V4Y2x1ZGVkMjYgPSBbImFjdGl2ZURvdCIsICJhbmltYXRpb25CZWdpbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25FYXNpbmciLCAiY29ubmVjdE51bGxzIiwgImRvdCIsICJmaWxsIiwgImZpbGxPcGFjaXR5IiwgImhpZGUiLCAiaXNBbmltYXRpb25BY3RpdmUiLCAibGVnZW5kVHlwZSIsICJzdHJva2UiLCAieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIF9leHRlbmRzMTcoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTcgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE3LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czMwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpIHsKICByZXR1cm4gc3Ryb2tlICYmIHN0cm9rZSAhPT0gIm5vbmUiID8gc3Ryb2tlIDogZmlsbDsKfQp2YXIgY29tcHV0ZUxlZ2VuZFBheWxvYWRGcm9tQXJlYURhdGEgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgZGF0YUtleSwKICAgIG5hbWUsCiAgICBzdHJva2UsCiAgICBmaWxsLAogICAgbGVnZW5kVHlwZSwKICAgIGhpZGUKICB9ID0gcHJvcHM7CiAgcmV0dXJuIFt7CiAgICBpbmFjdGl2ZTogaGlkZSwKICAgIGRhdGFLZXksCiAgICB0eXBlOiBsZWdlbmRUeXBlLAogICAgY29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpLAogICAgdmFsdWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgIHBheWxvYWQ6IHByb3BzCiAgfV07Cn07CnZhciBTZXRBcmVhVG9vbHRpcEVudHJ5U2V0dGluZ3MgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5tZW1vKChfcmVmMikgPT4gewogIHZhciB7CiAgICBkYXRhS2V5LAogICAgZGF0YSwKICAgIHN0cm9rZSwKICAgIHN0cm9rZVdpZHRoLAogICAgZmlsbCwKICAgIG5hbWUsCiAgICBoaWRlLAogICAgdW5pdDogdW5pdDIsCiAgICB0b29sdGlwVHlwZQogIH0gPSBfcmVmMjsKICB2YXIgdG9vbHRpcEVudHJ5U2V0dGluZ3MgPSB7CiAgICBkYXRhRGVmaW5lZE9uSXRlbTogZGF0YSwKICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgc2V0dGluZ3M6IHsKICAgICAgc3Ryb2tlLAogICAgICBzdHJva2VXaWR0aCwKICAgICAgZmlsbCwKICAgICAgZGF0YUtleSwKICAgICAgbmFtZUtleTogdm9pZCAwLAogICAgICBuYW1lOiBnZXRUb29sdGlwTmFtZVByb3AobmFtZSwgZGF0YUtleSksCiAgICAgIGhpZGUsCiAgICAgIHR5cGU6IHRvb2x0aXBUeXBlLAogICAgICBjb2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCksCiAgICAgIHVuaXQ6IHVuaXQyCiAgICB9CiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTZXRUb29sdGlwRW50cnlTZXR0aW5ncywgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MKICB9KTsKfSk7CmZ1bmN0aW9uIEFyZWFEb3RzV3JhcHBlcihfcmVmMikgewogIHZhciB7CiAgICBjbGlwUGF0aElkLAogICAgcG9pbnRzLAogICAgcHJvcHMKICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgZG90LAogICAgZGF0YUtleQogIH0gPSBwcm9wczsKICB2YXIgYXJlYVByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChEb3RzLCB7CiAgICBwb2ludHMsCiAgICBkb3QsCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWRvdHMiLAogICAgZG90Q2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1kb3QiLAogICAgZGF0YUtleSwKICAgIGJhc2VQcm9wczogYXJlYVByb3BzLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkCiAgfSk7Cn0KZnVuY3Rpb24gQXJlYUxhYmVsTGlzdFByb3ZpZGVyKF9yZWYzKSB7CiAgdmFyIHsKICAgIHNob3dMYWJlbHMsCiAgICBjaGlsZHJlbiwKICAgIHBvaW50cwogIH0gPSBfcmVmMzsKICB2YXIgbGFiZWxMaXN0RW50cmllcyA9IHBvaW50cy5tYXAoKHBvaW50NCkgPT4gewogICAgdmFyIF9wb2ludCR4LCBfcG9pbnQkeTsKICAgIHZhciB2aWV3Qm94ID0gewogICAgICB4OiAoX3BvaW50JHggPSBwb2ludDQueCkgIT09IG51bGwgJiYgX3BvaW50JHggIT09IHZvaWQgMCA/IF9wb2ludCR4IDogMCwKICAgICAgeTogKF9wb2ludCR5ID0gcG9pbnQ0LnkpICE9PSBudWxsICYmIF9wb2ludCR5ICE9PSB2b2lkIDAgPyBfcG9pbnQkeSA6IDAsCiAgICAgIHdpZHRoOiAwLAogICAgICBsb3dlcldpZHRoOiAwLAogICAgICB1cHBlcldpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgdmlld0JveCksIHt9LCB7CiAgICAgIHZhbHVlOiBwb2ludDQudmFsdWUsCiAgICAgIHBheWxvYWQ6IHBvaW50NC5wYXlsb2FkLAogICAgICBwYXJlbnRWaWV3Qm94OiB2b2lkIDAsCiAgICAgIHZpZXdCb3gsCiAgICAgIGZpbGw6IHZvaWQgMAogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyLCB7CiAgICB2YWx1ZTogc2hvd0xhYmVscyA/IGxhYmVsTGlzdEVudHJpZXMgOiB2b2lkIDAKICB9LCBjaGlsZHJlbik7Cn0KZnVuY3Rpb24gU3RhdGljQXJlYShfcmVmNCkgewogIHZhciB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzCiAgfSA9IF9yZWY0OwogIHZhciB7CiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgc3Ryb2tlLAogICAgY29ubmVjdE51bGxzLAogICAgaXNSYW5nZQogIH0gPSBwcm9wczsKICB2YXIgewogICAgaWQKICB9ID0gcHJvcHMsIHByb3BzV2l0aG91dElkID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIocHJvcHMsIF9leGNsdWRlZDEyKTsKICB2YXIgYWxsT3RoZXJQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wc1dpdGhvdXRJZCk7CiAgdmFyIHByb3BzV2l0aEV2ZW50cyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHNXaXRob3V0SWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFJlYWN0MjYuRnJhZ21lbnQsIG51bGwsIChwb2ludHMgPT09IG51bGwgfHwgcG9pbnRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwb2ludHMubGVuZ3RoKSA+IDEgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xpcFBhdGg6IG5lZWRDbGlwID8gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTcoe30sIHByb3BzV2l0aEV2ZW50cywgewogICAgaWQsCiAgICBwb2ludHMsCiAgICBjb25uZWN0TnVsbHMsCiAgICB0eXBlLAogICAgYmFzZUxpbmUsCiAgICBsYXlvdXQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtYXJlYSIKICB9KSksIHN0cm9rZSAhPT0gIm5vbmUiICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTcoe30sIGFsbE90aGVyUHJvcHMsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtY3VydmUiLAogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGZpbGw6ICJub25lIiwKICAgIHBvaW50cwogIH0pKSwgc3Ryb2tlICE9PSAibm9uZSIgJiYgaXNSYW5nZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE3KHt9LCBhbGxPdGhlclByb3BzLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWN1cnZlIiwKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBmaWxsOiAibm9uZSIsCiAgICBwb2ludHM6IGJhc2VMaW5lCiAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhRG90c1dyYXBwZXIsIHsKICAgIHBvaW50cywKICAgIHByb3BzOiBwcm9wc1dpdGhvdXRJZCwKICAgIGNsaXBQYXRoSWQKICB9KSk7Cn0KZnVuY3Rpb24gVmVydGljYWxSZWN0KF9yZWY1KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBiYXNlTGluZSwKICAgIHBvaW50cywKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY1OwogIHZhciBzdGFydFkgPSBwb2ludHNbMF0ueTsKICB2YXIgZW5kWSA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0ueTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc3RhcnRZKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihlbmRZKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBoZWlnaHQgPSBhbHBoYTIgKiBNYXRoLmFicyhzdGFydFkgLSBlbmRZKTsKICB2YXIgbWF4WCA9IE1hdGgubWF4KC4uLnBvaW50cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS54IHx8IDApKTsKICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBtYXhYID0gTWF0aC5tYXgoYmFzZUxpbmUsIG1heFgpOwogIH0gZWxzZSBpZiAoYmFzZUxpbmUgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgYmFzZUxpbmUubGVuZ3RoKSB7CiAgICBtYXhYID0gTWF0aC5tYXgoLi4uYmFzZUxpbmUubWFwKChlbnRyeSkgPT4gZW50cnkueCB8fCAwKSwgbWF4WCk7CiAgfQogIGlmIChpc051bWJlcihtYXhYKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IDAsCiAgICAgIHk6IHN0YXJ0WSA8IGVuZFkgPyBzdGFydFkgOiBzdGFydFkgLSBoZWlnaHQsCiAgICAgIHdpZHRoOiBtYXhYICsgKHN0cm9rZVdpZHRoID8gcGFyc2VJbnQoIiIuY29uY2F0KHN0cm9rZVdpZHRoKSwgMTApIDogMSksCiAgICAgIGhlaWdodDogTWF0aC5mbG9vcihoZWlnaHQpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFJlY3QoX3JlZjYpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGJhc2VMaW5lLAogICAgcG9pbnRzLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjY7CiAgdmFyIHN0YXJ0WCA9IHBvaW50c1swXS54OwogIHZhciBlbmRYID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS54OwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzdGFydFgpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGVuZFgpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHdpZHRoID0gYWxwaGEyICogTWF0aC5hYnMoc3RhcnRYIC0gZW5kWCk7CiAgdmFyIG1heFkgPSBNYXRoLm1heCguLi5wb2ludHMubWFwKChlbnRyeSkgPT4gZW50cnkueSB8fCAwKSk7CiAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbWF4WSA9IE1hdGgubWF4KGJhc2VMaW5lLCBtYXhZKTsKICB9IGVsc2UgaWYgKGJhc2VMaW5lICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIGJhc2VMaW5lLmxlbmd0aCkgewogICAgbWF4WSA9IE1hdGgubWF4KC4uLmJhc2VMaW5lLm1hcCgoZW50cnkpID0+IGVudHJ5LnkgfHwgMCksIG1heFkpOwogIH0KICBpZiAoaXNOdW1iZXIobWF4WSkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiBzdGFydFggPCBlbmRYID8gc3RhcnRYIDogc3RhcnRYIC0gd2lkdGgsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQ6IE1hdGguZmxvb3IobWF4WSArIChzdHJva2VXaWR0aCA/IHBhcnNlSW50KCIiLmNvbmNhdChzdHJva2VXaWR0aCksIDEwKSA6IDEpKQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIENsaXBSZWN0KF9yZWY3KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBsYXlvdXQsCiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY3OwogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFZlcnRpY2FsUmVjdCwgewogICAgICBhbHBoYTogYWxwaGEyLAogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBzdHJva2VXaWR0aAogICAgfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEhvcml6b250YWxSZWN0LCB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBzdHJva2VXaWR0aAogIH0pOwp9CmZ1bmN0aW9uIEFyZWFXaXRoQW5pbWF0aW9uKF9yZWY4KSB7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzLAogICAgcHJldmlvdXNQb2ludHNSZWYsCiAgICBwcmV2aW91c0Jhc2VsaW5lUmVmCiAgfSA9IF9yZWY4OwogIHZhciB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBvbkFuaW1hdGlvbkVuZAogIH0gPSBwcm9wczsKICB2YXIgYW5pbWF0aW9uSW5wdXQgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlTWVtbykoKCkgPT4gKHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lCiAgfSksIFtwb2ludHMsIGJhc2VMaW5lXSk7CiAgdmFyIGFuaW1hdGlvbklkID0gdXNlQW5pbWF0aW9uSWQoYW5pbWF0aW9uSW5wdXQsICJyZWNoYXJ0cy1hcmVhLSIpOwogIHZhciBsYXlvdXQgPSB1c2VDYXJ0ZXNpYW5DaGFydExheW91dCgpOwogIHZhciBbaXNBbmltYXRpbmcsIHNldElzQW5pbWF0aW5nXSA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VTdGF0ZSkoZmFsc2UpOwogIHZhciBzaG93TGFiZWxzID0gIWlzQW5pbWF0aW5nOwogIHZhciBoYW5kbGVBbmltYXRpb25FbmQgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGlmICh0eXBlb2Ygb25BbmltYXRpb25FbmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgb25BbmltYXRpb25FbmQoKTsKICAgIH0KICAgIHNldElzQW5pbWF0aW5nKGZhbHNlKTsKICB9LCBbb25BbmltYXRpb25FbmRdKTsKICB2YXIgaGFuZGxlQW5pbWF0aW9uU3RhcnQgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGlmICh0eXBlb2Ygb25BbmltYXRpb25TdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvbkFuaW1hdGlvblN0YXJ0KCk7CiAgICB9CiAgICBzZXRJc0FuaW1hdGluZyh0cnVlKTsKICB9LCBbb25BbmltYXRpb25TdGFydF0pOwogIGlmIChsYXlvdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcmV2UG9pbnRzID0gcHJldmlvdXNQb2ludHNSZWYuY3VycmVudDsKICB2YXIgcHJldkJhc2VMaW5lID0gcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFMYWJlbExpc3RQcm92aWRlciwgewogICAgc2hvd0xhYmVscywKICAgIHBvaW50cwogIH0sIHByb3BzLmNoaWxkcmVuLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGJlZ2luOiBhbmltYXRpb25CZWdpbiwKICAgIGR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbiwKICAgIGlzQWN0aXZlOiBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGVhc2luZzogYW5pbWF0aW9uRWFzaW5nLAogICAgb25BbmltYXRpb25FbmQ6IGhhbmRsZUFuaW1hdGlvbkVuZCwKICAgIG9uQW5pbWF0aW9uU3RhcnQ6IGhhbmRsZUFuaW1hdGlvblN0YXJ0LAogICAga2V5OiBhbmltYXRpb25JZAogIH0sICh0KSA9PiB7CiAgICBpZiAocHJldlBvaW50cykgewogICAgICB2YXIgcHJldlBvaW50c0RpZmZGYWN0b3IgPSBwcmV2UG9pbnRzLmxlbmd0aCAvIHBvaW50cy5sZW5ndGg7CiAgICAgIHZhciBzdGVwUG9pbnRzID0gKAogICAgICAgIC8qCiAgICAgICAgICogSGVyZSBpdCBpcyBpbXBvcnRhbnQgdGhhdCBhdCB0aGUgdmVyeSBlbmQgb2YgdGhlIGFuaW1hdGlvbiwgb24gdGhlIGxhc3QgZnJhbWUsCiAgICAgICAgICogd2UgcmVuZGVyIHRoZSBvcmlnaW5hbCBwb2ludHMgd2l0aG91dCBhbnkgaW50ZXJwb2xhdGlvbi4KICAgICAgICAgKiBUaGlzIGlzIG5lZWRlZCBiZWNhdXNlIHRoZSBjb2RlIGFib3ZlIGlzIGNoZWNraW5nIGZvciByZWZlcmVuY2UgZXF1YWxpdHkgdG8gZGVjaWRlIGlmIHRoZSBhbmltYXRpb24gc2hvdWxkIHJ1bgogICAgICAgICAqIGFuZCBpZiB3ZSBjcmVhdGUgYSBuZXcgYXJyYXkgaW5zdGFuY2UgKGV2ZW4gaWYgdGhlIG51bWJlcnMgd2VyZSB0aGUgc2FtZSkKICAgICAgICAgKiB0aGVuIHdlIHdvdWxkIGJyZWFrIGFuaW1hdGlvbnMuCiAgICAgICAgICovCiAgICAgICAgdCA9PT0gMSA/IHBvaW50cyA6IHBvaW50cy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICAgICAgdmFyIHByZXZQb2ludEluZGV4ID0gTWF0aC5mbG9vcihpbmRleCAqIHByZXZQb2ludHNEaWZmRmFjdG9yKTsKICAgICAgICAgIGlmIChwcmV2UG9pbnRzW3ByZXZQb2ludEluZGV4XSkgewogICAgICAgICAgICB2YXIgcHJldiA9IHByZXZQb2ludHNbcHJldlBvaW50SW5kZXhdOwogICAgICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgICAgIHg6IGludGVycG9sYXRlKHByZXYueCwgZW50cnkueCwgdCksCiAgICAgICAgICAgICAgeTogaW50ZXJwb2xhdGUocHJldi55LCBlbnRyeS55LCB0KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnRyeTsKICAgICAgICB9KQogICAgICApOwogICAgICB2YXIgc3RlcEJhc2VMaW5lOwogICAgICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gaW50ZXJwb2xhdGUocHJldkJhc2VMaW5lLCBiYXNlTGluZSwgdCk7CiAgICAgIH0gZWxzZSBpZiAoaXNOdWxsaXNoKGJhc2VMaW5lKSB8fCBpc05hbihiYXNlTGluZSkpIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBpbnRlcnBvbGF0ZShwcmV2QmFzZUxpbmUsIDAsIHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGJhc2VMaW5lLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgICAgICB2YXIgcHJldlBvaW50SW5kZXggPSBNYXRoLmZsb29yKGluZGV4ICogcHJldlBvaW50c0RpZmZGYWN0b3IpOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocHJldkJhc2VMaW5lKSAmJiBwcmV2QmFzZUxpbmVbcHJldlBvaW50SW5kZXhdKSB7CiAgICAgICAgICAgIHZhciBwcmV2ID0gcHJldkJhc2VMaW5lW3ByZXZQb2ludEluZGV4XTsKICAgICAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgICAgICB4OiBpbnRlcnBvbGF0ZShwcmV2LngsIGVudHJ5LngsIHQpLAogICAgICAgICAgICAgIHk6IGludGVycG9sYXRlKHByZXYueSwgZW50cnkueSwgdCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW50cnk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHQgPiAwKSB7CiAgICAgICAgcHJldmlvdXNQb2ludHNSZWYuY3VycmVudCA9IHN0ZXBQb2ludHM7CiAgICAgICAgcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50ID0gc3RlcEJhc2VMaW5lOwogICAgICB9CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFN0YXRpY0FyZWEsIHsKICAgICAgICBwb2ludHM6IHN0ZXBQb2ludHMsCiAgICAgICAgYmFzZUxpbmU6IHN0ZXBCYXNlTGluZSwKICAgICAgICBuZWVkQ2xpcCwKICAgICAgICBjbGlwUGF0aElkLAogICAgICAgIHByb3BzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHQgPiAwKSB7CiAgICAgIHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQgPSBwb2ludHM7CiAgICAgIHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudCA9IGJhc2VMaW5lOwogICAgfQogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIG51bGwsIGlzQW5pbWF0aW9uQWN0aXZlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgICAgaWQ6ICJhbmltYXRpb25DbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDbGlwUmVjdCwgewogICAgICBhbHBoYTogdCwKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgbGF5b3V0LAogICAgICBzdHJva2VXaWR0aDogcHJvcHMuc3Ryb2tlV2lkdGgKICAgIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xpcFBhdGg6ICJ1cmwoI2FuaW1hdGlvbkNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQsICIpIikKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU3RhdGljQXJlYSwgewogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBuZWVkQ2xpcCwKICAgICAgY2xpcFBhdGhJZCwKICAgICAgcHJvcHMKICAgIH0pKSk7CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0RnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsCiAgfSkpOwp9CmZ1bmN0aW9uIFJlbmRlckFyZWEoX3JlZjkpIHsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMKICB9ID0gX3JlZjk7CiAgdmFyIHByZXZpb3VzUG9pbnRzUmVmID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVJlZikobnVsbCk7CiAgdmFyIHByZXZpb3VzQmFzZWxpbmVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlUmVmKSgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFXaXRoQW5pbWF0aW9uLCB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcywKICAgIHByZXZpb3VzUG9pbnRzUmVmLAogICAgcHJldmlvdXNCYXNlbGluZVJlZgogIH0pOwp9CnZhciBBcmVhV2l0aFN0YXRlID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3QzOC5QdXJlQ29tcG9uZW50IHsKICByZW5kZXIoKSB7CiAgICB2YXIgewogICAgICBoaWRlLAogICAgICBkb3QsCiAgICAgIHBvaW50cywKICAgICAgY2xhc3NOYW1lLAogICAgICB0b3AsCiAgICAgIGxlZnQsCiAgICAgIG5lZWRDbGlwLAogICAgICB4QXhpc0lkLAogICAgICB5QXhpc0lkLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBpZCwKICAgICAgYmFzZUxpbmUsCiAgICAgIHpJbmRleAogICAgfSA9IHRoaXMucHJvcHM7CiAgICBpZiAoaGlkZSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtYXJlYSIsIGNsYXNzTmFtZSk7CiAgICB2YXIgY2xpcFBhdGhJZCA9IGlkOwogICAgdmFyIHsKICAgICAgcjogcjIsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9ID0gZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90KGRvdCk7CiAgICB2YXIgY2xpcERvdCA9IGlzQ2xpcERvdChkb3QpOwogICAgdmFyIGRvdFNpemUgPSByMiAqIDIgKyBzdHJva2VXaWR0aDsKICAgIHZhciBhY3RpdmVQb2ludHNDbGlwUGF0aCA9IG5lZWRDbGlwID8gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcERvdCA/ICIiIDogImRvdHMtIikuY29uY2F0KGNsaXBQYXRoSWQsICIpIikgOiB2b2lkIDA7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgICB6SW5kZXgKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgICB9LCBuZWVkQ2xpcCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChHcmFwaGljYWxJdGVtQ2xpcFBhdGgsIHsKICAgICAgY2xpcFBhdGhJZCwKICAgICAgeEF4aXNJZCwKICAgICAgeUF4aXNJZAogICAgfSksICFjbGlwRG90ICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgICBpZDogImNsaXBQYXRoLWRvdHMtIi5jb25jYXQoY2xpcFBhdGhJZCkKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IGxlZnQgLSBkb3RTaXplIC8gMiwKICAgICAgeTogdG9wIC0gZG90U2l6ZSAvIDIsCiAgICAgIHdpZHRoOiB3aWR0aCArIGRvdFNpemUsCiAgICAgIGhlaWdodDogaGVpZ2h0ICsgZG90U2l6ZQogICAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChSZW5kZXJBcmVhLCB7CiAgICAgIG5lZWRDbGlwLAogICAgICBjbGlwUGF0aElkLAogICAgICBwcm9wczogdGhpcy5wcm9wcwogICAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50cywgewogICAgICBwb2ludHMsCiAgICAgIG1haW5Db2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHRoaXMucHJvcHMuc3Ryb2tlLCB0aGlzLnByb3BzLmZpbGwpLAogICAgICBpdGVtRGF0YUtleTogdGhpcy5wcm9wcy5kYXRhS2V5LAogICAgICBhY3RpdmVEb3Q6IHRoaXMucHJvcHMuYWN0aXZlRG90LAogICAgICBjbGlwUGF0aDogYWN0aXZlUG9pbnRzQ2xpcFBhdGgKICAgIH0pLCB0aGlzLnByb3BzLmlzUmFuZ2UgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludHMsIHsKICAgICAgcG9pbnRzOiBiYXNlTGluZSwKICAgICAgbWFpbkNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3IodGhpcy5wcm9wcy5zdHJva2UsIHRoaXMucHJvcHMuZmlsbCksCiAgICAgIGl0ZW1EYXRhS2V5OiB0aGlzLnByb3BzLmRhdGFLZXksCiAgICAgIGFjdGl2ZURvdDogdGhpcy5wcm9wcy5hY3RpdmVEb3QsCiAgICAgIGNsaXBQYXRoOiBhY3RpdmVQb2ludHNDbGlwUGF0aAogICAgfSkpOwogIH0KfTsKdmFyIGRlZmF1bHRBcmVhUHJvcHMgPSB7CiAgYWN0aXZlRG90OiB0cnVlLAogIGFuaW1hdGlvbkJlZ2luOiAwLAogIGFuaW1hdGlvbkR1cmF0aW9uOiAxNTAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiLAogIGNvbm5lY3ROdWxsczogZmFsc2UsCiAgZG90OiBmYWxzZSwKICBmaWxsOiAiIzMxODJiZCIsCiAgZmlsbE9wYWNpdHk6IDAuNiwKICBoaWRlOiBmYWxzZSwKICBpc0FuaW1hdGlvbkFjdGl2ZTogImF1dG8iLAogIGxlZ2VuZFR5cGU6ICJsaW5lIiwKICBzdHJva2U6ICIjMzE4MmJkIiwKICBzdHJva2VXaWR0aDogMSwKICB0eXBlOiAibGluZWFyIiwKICBsYWJlbDogZmFsc2UsCiAgeEF4aXNJZDogMCwKICB5QXhpc0lkOiAwLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmFyZWEKfTsKZnVuY3Rpb24gQXJlYUltcGwocHJvcHMpIHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHZhciBfcmVzb2x2ZURlZmF1bHRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRBcmVhUHJvcHMpLCB7CiAgICBhY3RpdmVEb3QsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgY29ubmVjdE51bGxzLAogICAgZG90LAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgaGlkZSwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgbGVnZW5kVHlwZSwKICAgIHN0cm9rZSwKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IF9yZXNvbHZlRGVmYXVsdFByb3BzLCBldmVyeXRoaW5nRWxzZSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKF9yZXNvbHZlRGVmYXVsdFByb3BzLCBfZXhjbHVkZWQyNik7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIGNoYXJ0TmFtZSA9IHVzZUNoYXJ0TmFtZSgpOwogIHZhciB7CiAgICBuZWVkQ2xpcAogIH0gPSB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGlzUmFuZ2UsCiAgICBiYXNlTGluZQogIH0gPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBcmVhKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBwcm9wcy5pZCkpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHt9OwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKGxheW91dCAhPT0gImhvcml6b250YWwiICYmIGxheW91dCAhPT0gInZlcnRpY2FsIiB8fCBwbG90QXJlYSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKGNoYXJ0TmFtZSAhPT0gIkFyZWFDaGFydCIgJiYgY2hhcnROYW1lICE9PSAiQ29tcG9zZWRDaGFydCIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgaGVpZ2h0LAogICAgd2lkdGgsCiAgICB4OiBsZWZ0LAogICAgeTogdG9wCiAgfSA9IHBsb3RBcmVhOwogIGlmICghcG9pbnRzIHx8ICFwb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYVdpdGhTdGF0ZSwgX2V4dGVuZHMxNyh7fSwgZXZlcnl0aGluZ0Vsc2UsIHsKICAgIGFjdGl2ZURvdCwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBiYXNlTGluZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGRvdCwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGhlaWdodCwKICAgIGhpZGUsCiAgICBsYXlvdXQsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZTogaXNBbmltYXRpb25BY3RpdmUgPT09ICJhdXRvIiA/ICFHbG9iYWwuaXNTc3IgOiBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGlzUmFuZ2UsCiAgICBsZWdlbmRUeXBlLAogICAgbmVlZENsaXAsCiAgICBwb2ludHMsCiAgICBzdHJva2UsCiAgICB3aWR0aCwKICAgIGxlZnQsCiAgICB0b3AsCiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0pKTsKfQp2YXIgZ2V0QmFzZVZhbHVlID0gKGxheW91dCwgY2hhcnRCYXNlVmFsdWUsIGl0ZW1CYXNlVmFsdWUsIHhBeGlzLCB5QXhpcykgPT4gewogIHZhciBiYXNlVmFsdWUgPSBpdGVtQmFzZVZhbHVlICE9PSBudWxsICYmIGl0ZW1CYXNlVmFsdWUgIT09IHZvaWQgMCA/IGl0ZW1CYXNlVmFsdWUgOiBjaGFydEJhc2VWYWx1ZTsKICBpZiAoaXNOdW1iZXIoYmFzZVZhbHVlKSkgewogICAgcmV0dXJuIGJhc2VWYWx1ZTsKICB9CiAgdmFyIG51bWVyaWNBeGlzID0gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB5QXhpcyA6IHhBeGlzOwogIHZhciBkb21haW4gPSBudW1lcmljQXhpcy5zY2FsZS5kb21haW4oKTsKICBpZiAobnVtZXJpY0F4aXMudHlwZSA9PT0gIm51bWJlciIpIHsKICAgIHZhciBkb21haW5NYXggPSBNYXRoLm1heChkb21haW5bMF0sIGRvbWFpblsxXSk7CiAgICB2YXIgZG9tYWluTWluID0gTWF0aC5taW4oZG9tYWluWzBdLCBkb21haW5bMV0pOwogICAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNaW4iKSB7CiAgICAgIHJldHVybiBkb21haW5NaW47CiAgICB9CiAgICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1heCIpIHsKICAgICAgcmV0dXJuIGRvbWFpbk1heDsKICAgIH0KICAgIHJldHVybiBkb21haW5NYXggPCAwID8gZG9tYWluTWF4IDogTWF0aC5tYXgoTWF0aC5taW4oZG9tYWluWzBdLCBkb21haW5bMV0pLCAwKTsKICB9CiAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNaW4iKSB7CiAgICByZXR1cm4gZG9tYWluWzBdOwogIH0KICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1heCIpIHsKICAgIHJldHVybiBkb21haW5bMV07CiAgfQogIHJldHVybiBkb21haW5bMF07Cn07CmZ1bmN0aW9uIGNvbXB1dGVBcmVhKF9yZWYwKSB7CiAgdmFyIHsKICAgIGFyZWFTZXR0aW5nczogewogICAgICBjb25uZWN0TnVsbHMsCiAgICAgIGJhc2VWYWx1ZTogaXRlbUJhc2VWYWx1ZSwKICAgICAgZGF0YUtleQogICAgfSwKICAgIHN0YWNrZWREYXRhLAogICAgbGF5b3V0LAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICB4QXhpcywKICAgIHlBeGlzLAogICAgZGlzcGxheWVkRGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgeEF4aXNUaWNrcywKICAgIHlBeGlzVGlja3MsCiAgICBiYW5kU2l6ZQogIH0gPSBfcmVmMDsKICB2YXIgaGFzU3RhY2sgPSBzdGFja2VkRGF0YSAmJiBzdGFja2VkRGF0YS5sZW5ndGg7CiAgdmFyIGJhc2VWYWx1ZSA9IGdldEJhc2VWYWx1ZShsYXlvdXQsIGNoYXJ0QmFzZVZhbHVlLCBpdGVtQmFzZVZhbHVlLCB4QXhpcywgeUF4aXMpOwogIHZhciBpc0hvcml6b250YWxMYXlvdXQgPSBsYXlvdXQgPT09ICJob3Jpem9udGFsIjsKICB2YXIgaXNSYW5nZSA9IGZhbHNlOwogIHZhciBwb2ludHMgPSBkaXNwbGF5ZWREYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICB2YXIgdmFsdWU7CiAgICBpZiAoaGFzU3RhY2spIHsKICAgICAgdmFsdWUgPSBzdGFja2VkRGF0YVtkYXRhU3RhcnRJbmRleCArIGluZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGRhdGFLZXkpOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSBbYmFzZVZhbHVlLCB2YWx1ZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXNSYW5nZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHZhciBpc0JyZWFrUG9pbnQgPSB2YWx1ZVsxXSA9PSBudWxsIHx8IGhhc1N0YWNrICYmICFjb25uZWN0TnVsbHMgJiYgZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGRhdGFLZXkpID09IG51bGw7CiAgICBpZiAoaXNIb3Jpem9udGFsTGF5b3V0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoewogICAgICAgICAgYXhpczogeEF4aXMsCiAgICAgICAgICB0aWNrczogeEF4aXNUaWNrcywKICAgICAgICAgIGJhbmRTaXplLAogICAgICAgICAgZW50cnksCiAgICAgICAgICBpbmRleAogICAgICAgIH0pLAogICAgICAgIHk6IGlzQnJlYWtQb2ludCA/IG51bGwgOiB5QXhpcy5zY2FsZSh2YWx1ZVsxXSksCiAgICAgICAgdmFsdWUsCiAgICAgICAgcGF5bG9hZDogZW50cnkKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHg6IGlzQnJlYWtQb2ludCA/IG51bGwgOiB4QXhpcy5zY2FsZSh2YWx1ZVsxXSksCiAgICAgIHk6IGdldENhdGVDb29yZGluYXRlT2ZMaW5lKHsKICAgICAgICBheGlzOiB5QXhpcywKICAgICAgICB0aWNrczogeUF4aXNUaWNrcywKICAgICAgICBiYW5kU2l6ZSwKICAgICAgICBlbnRyeSwKICAgICAgICBpbmRleAogICAgICB9KSwKICAgICAgdmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5CiAgICB9OwogIH0pOwogIHZhciBiYXNlTGluZTsKICBpZiAoaGFzU3RhY2sgfHwgaXNSYW5nZSkgewogICAgYmFzZUxpbmUgPSBwb2ludHMubWFwKChlbnRyeSkgPT4gewogICAgICB2YXIgeDIgPSBBcnJheS5pc0FycmF5KGVudHJ5LnZhbHVlKSA/IGVudHJ5LnZhbHVlWzBdIDogbnVsbDsKICAgICAgaWYgKGlzSG9yaXpvbnRhbExheW91dCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB4OiBlbnRyeS54LAogICAgICAgICAgeTogeDIgIT0gbnVsbCAmJiBlbnRyeS55ICE9IG51bGwgPyB5QXhpcy5zY2FsZSh4MikgOiBudWxsLAogICAgICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZAogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB4MiAhPSBudWxsID8geEF4aXMuc2NhbGUoeDIpIDogbnVsbCwKICAgICAgICB5OiBlbnRyeS55LAogICAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQKICAgICAgfTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBiYXNlTGluZSA9IGlzSG9yaXpvbnRhbExheW91dCA/IHlBeGlzLnNjYWxlKGJhc2VWYWx1ZSkgOiB4QXhpcy5zY2FsZShiYXNlVmFsdWUpOwogIH0KICByZXR1cm4gewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBpc1JhbmdlCiAgfTsKfQpmdW5jdGlvbiBBcmVhRm4ob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRBcmVhUHJvcHMpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFJlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLCB7CiAgICBpZDogcHJvcHMuaWQsCiAgICB0eXBlOiAiYXJlYSIKICB9LCAoaWQpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVhY3QyNi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTZXRMZWdlbmRQYXlsb2FkLCB7CiAgICBsZWdlbmRQYXlsb2FkOiBjb21wdXRlTGVnZW5kUGF5bG9hZEZyb21BcmVhRGF0YShwcm9wcykKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTZXRBcmVhVG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBkYXRhOiBwcm9wcy5kYXRhLAogICAgc3Ryb2tlOiBwcm9wcy5zdHJva2UsCiAgICBzdHJva2VXaWR0aDogcHJvcHMuc3Ryb2tlV2lkdGgsCiAgICBmaWxsOiBwcm9wcy5maWxsLAogICAgbmFtZTogcHJvcHMubmFtZSwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgdG9vbHRpcFR5cGU6IHByb3BzLnRvb2x0aXBUeXBlCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbSwgewogICAgdHlwZTogImFyZWEiLAogICAgaWQsCiAgICBkYXRhOiBwcm9wcy5kYXRhLAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIHhBeGlzSWQ6IHByb3BzLnhBeGlzSWQsCiAgICB5QXhpc0lkOiBwcm9wcy55QXhpc0lkLAogICAgekF4aXNJZDogMCwKICAgIHN0YWNrSWQ6IGdldE5vcm1hbGl6ZWRTdGFja0lkKHByb3BzLnN0YWNrSWQpLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIGJhclNpemU6IHZvaWQgMCwKICAgIGJhc2VWYWx1ZTogcHJvcHMuYmFzZVZhbHVlLAogICAgaXNQYW5vcmFtYSwKICAgIGNvbm5lY3ROdWxsczogcHJvcHMuY29ubmVjdE51bGxzCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYUltcGwsIF9leHRlbmRzMTcoe30sIHByb3BzLCB7CiAgICBpZAogIH0pKSkpOwp9CnZhciBBcmVhID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjYubWVtbyhBcmVhRm4sIHByb3BzQXJlRXF1YWwpOwpBcmVhLmRpc3BsYXlOYW1lID0gIkFyZWEiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vWEF4aXMuanMKdmFyIFJlYWN0MjcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9heGlzUHJvcHNBcmVFcXVhbC5qcwp2YXIgX2V4Y2x1ZGVkMTMgPSBbImRvbWFpbiIsICJyYW5nZSJdOwp2YXIgX2V4Y2x1ZGVkMjcgPSBbImRvbWFpbiIsICJyYW5nZSJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBzaG9ydEFycmF5c0FyZUVxdWFsKGFycjEsIGFycjIpIHsKICBpZiAoYXJyMSA9PT0gYXJyMikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGFycjEpICYmIGFycjEubGVuZ3RoID09PSAyICYmIEFycmF5LmlzQXJyYXkoYXJyMikgJiYgYXJyMi5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiBhcnIxWzBdID09PSBhcnIyWzBdICYmIGFycjFbMV0gPT09IGFycjJbMV07CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBheGlzUHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHZhciB7CiAgICBkb21haW46IHByZXZEb21haW4sCiAgICByYW5nZTogcHJldlJhbmdlCiAgfSA9IHByZXZQcm9wcywgcHJldlJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhwcmV2UHJvcHMsIF9leGNsdWRlZDEzKTsKICB2YXIgewogICAgZG9tYWluOiBuZXh0RG9tYWluLAogICAgcmFuZ2U6IG5leHRSYW5nZQogIH0gPSBuZXh0UHJvcHMsIG5leHRSZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMobmV4dFByb3BzLCBfZXhjbHVkZWQyNyk7CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZEb21haW4sIG5leHREb21haW4pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghc2hvcnRBcnJheXNBcmVFcXVhbChwcmV2UmFuZ2UsIG5leHRSYW5nZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHByb3BzQXJlRXF1YWwocHJldlJlc3QsIG5leHRSZXN0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vWEF4aXMuanMKdmFyIF9leGNsdWRlZDE0ID0gWyJkYW5nZXJvdXNseVNldElubmVySFRNTCIsICJ0aWNrcyJdOwp2YXIgX2V4Y2x1ZGVkMjggPSBbImlkIl07CmZ1bmN0aW9uIF9leHRlbmRzMTgoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTggPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE4LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE0KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gU2V0WEF4aXNTZXR0aW5ncyhzZXR0aW5ncykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIHByZXZTZXR0aW5nc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOS51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRYQXhpcyhzZXR0aW5ncykpOwogICAgfSBlbHNlIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCAhPT0gc2V0dGluZ3MpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZVhBeGlzKHsKICAgICAgICBwcmV2OiBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBzZXR0aW5ncwogICAgICB9KSk7CiAgICB9CiAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IHNldHRpbmdzOwogIH0sIFtzZXR0aW5ncywgZGlzcGF0Y2hdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVYQXhpcyhwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9LCBbZGlzcGF0Y2hdKTsKICByZXR1cm4gbnVsbDsKfQp2YXIgWEF4aXNJbXBsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIHZpZXdCb3ggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBeGlzVmlld0JveCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIGF4aXNUeXBlID0gInhBeGlzIjsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgYXhpc1R5cGUsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgYXhpc1NpemUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2l6ZShzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciBwb3NpdGlvbiA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNQb3NpdGlvbihzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIHhBeGlzSWQpKTsKICBpZiAoYXhpc1NpemUgPT0gbnVsbCB8fCBwb3NpdGlvbiA9PSBudWxsIHx8IHN5bmNocm9uaXplZFNldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwsCiAgICB0aWNrczogdGlja3MyCiAgfSA9IHByb3BzLCBhbGxPdGhlclByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQocHJvcHMsIF9leGNsdWRlZDE0KTsKICB2YXIgewogICAgaWQKICB9ID0gc3luY2hyb25pemVkU2V0dGluZ3MsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KHN5bmNocm9uaXplZFNldHRpbmdzLCBfZXhjbHVkZWQyOCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQXhpcywgX2V4dGVuZHMxOCh7fSwgYWxsT3RoZXJQcm9wcywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzLCB7CiAgICBzY2FsZSwKICAgIHg6IHBvc2l0aW9uLngsCiAgICB5OiBwb3NpdGlvbi55LAogICAgd2lkdGg6IGF4aXNTaXplLndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2l6ZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiICIpLmNvbmNhdChheGlzVHlwZSksIGNsYXNzTmFtZSksCiAgICB2aWV3Qm94LAogICAgdGlja3M6IGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNUeXBlCiAgfSkpOwp9Owp2YXIgeEF4aXNEZWZhdWx0UHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGltcGxpY2l0WEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogaW1wbGljaXRYQXhpcy5hbGxvd0RlY2ltYWxzLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBpbXBsaWNpdFhBeGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGFuZ2xlOiBpbXBsaWNpdFhBeGlzLmFuZ2xlLAogIGF4aXNMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLmF4aXNMaW5lLAogIGhlaWdodDogaW1wbGljaXRYQXhpcy5oZWlnaHQsCiAgaGlkZTogZmFsc2UsCiAgaW5jbHVkZUhpZGRlbjogaW1wbGljaXRYQXhpcy5pbmNsdWRlSGlkZGVuLAogIGludGVydmFsOiBpbXBsaWNpdFhBeGlzLmludGVydmFsLAogIG1pblRpY2tHYXA6IGltcGxpY2l0WEF4aXMubWluVGlja0dhcCwKICBtaXJyb3I6IGltcGxpY2l0WEF4aXMubWlycm9yLAogIG9yaWVudGF0aW9uOiBpbXBsaWNpdFhBeGlzLm9yaWVudGF0aW9uLAogIHBhZGRpbmc6IGltcGxpY2l0WEF4aXMucGFkZGluZywKICByZXZlcnNlZDogaW1wbGljaXRYQXhpcy5yZXZlcnNlZCwKICBzY2FsZTogaW1wbGljaXRYQXhpcy5zY2FsZSwKICB0aWNrOiBpbXBsaWNpdFhBeGlzLnRpY2ssCiAgdGlja0NvdW50OiBpbXBsaWNpdFhBeGlzLnRpY2tDb3VudCwKICB0aWNrTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrTGluZSwKICB0aWNrU2l6ZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrU2l6ZSwKICB0eXBlOiBpbXBsaWNpdFhBeGlzLnR5cGUsCiAgeEF4aXNJZDogMAp9Owp2YXIgWEF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHhBeGlzRGVmYXVsdFByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChSZWFjdDI3LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFNldFhBeGlzU2V0dGluZ3MsIHsKICAgIGFsbG93RGF0YU92ZXJmbG93OiBwcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICAgIGFsbG93RGVjaW1hbHM6IHByb3BzLmFsbG93RGVjaW1hbHMsCiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogcHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBhbmdsZTogcHJvcHMuYW5nbGUsCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgZG9tYWluOiBwcm9wcy5kb21haW4sCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICBpZDogcHJvcHMueEF4aXNJZCwKICAgIGluY2x1ZGVIaWRkZW46IHByb3BzLmluY2x1ZGVIaWRkZW4sCiAgICBpbnRlcnZhbDogcHJvcHMuaW50ZXJ2YWwsCiAgICBtaW5UaWNrR2FwOiBwcm9wcy5taW5UaWNrR2FwLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIHJldmVyc2VkOiBwcm9wcy5yZXZlcnNlZCwKICAgIHNjYWxlOiBwcm9wcy5zY2FsZSwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrQ291bnQ6IHByb3BzLnRpY2tDb3VudCwKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrczogcHJvcHMudGlja3MsCiAgICB0eXBlOiBwcm9wcy50eXBlLAogICAgdW5pdDogcHJvcHMudW5pdAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFhBeGlzSW1wbCwgcHJvcHMpKTsKfTsKdmFyIFhBeGlzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjcubWVtbyhYQXhpc1NldHRpbmdzRGlzcGF0Y2hlciwgYXhpc1Byb3BzQXJlRXF1YWwpOwpYQXhpcy5kaXNwbGF5TmFtZSA9ICJYQXhpcyI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9ZQXhpcy5qcwp2YXIgUmVhY3QyOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMTUgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOSA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxOSgpIHsKICByZXR1cm4gX2V4dGVuZHMxOSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRZQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDQwLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFlBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWUF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVlBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBZQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeUF4aXNJZCwKICAgIGNsYXNzTmFtZSwKICAgIHdpZHRoLAogICAgbGFiZWwKICB9ID0gcHJvcHM7CiAgdmFyIGNhcnRlc2lhbkF4aXNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICB2YXIgbGFiZWxSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBheGlzVHlwZSA9ICJ5QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NpemUoc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzUG9zaXRpb24oc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB5QXhpc0lkKSk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHdpZHRoICE9PSAiYXV0byIgfHwgIWF4aXNTaXplIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSB8fCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQwLmlzVmFsaWRFbGVtZW50KShsYWJlbCkgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgYXhpc0NvbXBvbmVudCA9IGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudDsKICAgIGlmICghYXhpc0NvbXBvbmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBheGlzQ29tcG9uZW50LmdldENhbGN1bGF0ZWRXaWR0aCgpOwogICAgaWYgKE1hdGgucm91bmQoYXhpc1NpemUud2lkdGgpICE9PSBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKSkgewogICAgICBkaXNwYXRjaCh1cGRhdGVZQXhpc1dpZHRoKHsKICAgICAgICBpZDogeUF4aXNJZCwKICAgICAgICB3aWR0aDogdXBkYXRlZFlBeGlzV2lkdGgKICAgICAgfSkpOwogICAgfQogIH0sIFsKICAgIC8vIFRoZSBkZXBlbmRlbmN5IG9uIGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudCBpcyBub3QgbmVlZGVkIGJlY2F1c2UgdXNlTGF5b3V0RWZmZWN0IHdpbGwgcnVuIGFmdGVyIGV2ZXJ5IHJlbmRlci4KICAgIC8vIFRoZSByZWYgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgdGhlbi4KICAgIC8vIFRvIHJlLXJ1biB0aGlzIGVmZmVjdCB3aGVuIHRpY2tzIGNoYW5nZSwgd2UgY2FuIGRlcGVuZCBvbiB0aGUgdGlja3MgYXJyYXkgZnJvbSB0aGUgc3RvcmUuCiAgICBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzU2l6ZSwKICAgIGRpc3BhdGNoLAogICAgbGFiZWwsCiAgICB5QXhpc0lkLAogICAgd2lkdGgsCiAgICBzeW5jaHJvbml6ZWRTZXR0aW5ncwogIF0pOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShwcm9wcywgX2V4Y2x1ZGVkMTUpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTUoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczE5KHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHJlZjogY2FydGVzaWFuQXhpc1JlZiwKICAgIGxhYmVsUmVmLAogICAgc2NhbGUsCiAgICB4OiBwb3NpdGlvbi54LAogICAgeTogcG9zaXRpb24ueSwKICAgIHRpY2tUZXh0UHJvcHM6IHdpZHRoID09PSAiYXV0byIgPyB7CiAgICAgIHdpZHRoOiB2b2lkIDAKICAgIH0gOiB7CiAgICAgIHdpZHRoCiAgICB9LAogICAgd2lkdGg6IGF4aXNTaXplLndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2l6ZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiICIpLmNvbmNhdChheGlzVHlwZSksIGNsYXNzTmFtZSksCiAgICB2aWV3Qm94LAogICAgdGlja3M6IGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNUeXBlCiAgfSkpOwp9Owp2YXIgeUF4aXNEZWZhdWx0UHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGltcGxpY2l0WUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogaW1wbGljaXRZQXhpcy5hbGxvd0RlY2ltYWxzLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBpbXBsaWNpdFlBeGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGFuZ2xlOiBpbXBsaWNpdFlBeGlzLmFuZ2xlLAogIGF4aXNMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLmF4aXNMaW5lLAogIGhpZGU6IGZhbHNlLAogIGluY2x1ZGVIaWRkZW46IGltcGxpY2l0WUF4aXMuaW5jbHVkZUhpZGRlbiwKICBpbnRlcnZhbDogaW1wbGljaXRZQXhpcy5pbnRlcnZhbCwKICBtaW5UaWNrR2FwOiBpbXBsaWNpdFlBeGlzLm1pblRpY2tHYXAsCiAgbWlycm9yOiBpbXBsaWNpdFlBeGlzLm1pcnJvciwKICBvcmllbnRhdGlvbjogaW1wbGljaXRZQXhpcy5vcmllbnRhdGlvbiwKICBwYWRkaW5nOiBpbXBsaWNpdFlBeGlzLnBhZGRpbmcsCiAgcmV2ZXJzZWQ6IGltcGxpY2l0WUF4aXMucmV2ZXJzZWQsCiAgc2NhbGU6IGltcGxpY2l0WUF4aXMuc2NhbGUsCiAgdGljazogaW1wbGljaXRZQXhpcy50aWNrLAogIHRpY2tDb3VudDogaW1wbGljaXRZQXhpcy50aWNrQ291bnQsCiAgdGlja0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja0xpbmUsCiAgdGlja1NpemU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja1NpemUsCiAgdHlwZTogaW1wbGljaXRZQXhpcy50eXBlLAogIHdpZHRoOiBpbXBsaWNpdFlBeGlzLndpZHRoLAogIHlBeGlzSWQ6IDAKfTsKdmFyIFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyID0gKG91dHNpZGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB5QXhpc0RlZmF1bHRQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoUmVhY3QyOC5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChTZXRZQXhpc1NldHRpbmdzLCB7CiAgICBpbnRlcnZhbDogcHJvcHMuaW50ZXJ2YWwsCiAgICBpZDogcHJvcHMueUF4aXNJZCwKICAgIHNjYWxlOiBwcm9wcy5zY2FsZSwKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGFsbG93RGF0YU92ZXJmbG93OiBwcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogcHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBhbGxvd0RlY2ltYWxzOiBwcm9wcy5hbGxvd0RlY2ltYWxzLAogICAgdGlja0NvdW50OiBwcm9wcy50aWNrQ291bnQsCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIHJldmVyc2VkOiBwcm9wcy5yZXZlcnNlZCwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgYW5nbGU6IHByb3BzLmFuZ2xlLAogICAgbWluVGlja0dhcDogcHJvcHMubWluVGlja0dhcCwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoWUF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWUF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5tZW1vKFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7CllBeGlzLmRpc3BsYXlOYW1lID0gIllBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2FydGVzaWFuQ2hhcnQuanMKdmFyIFJlYWN0MzQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNTdG9yZVByb3ZpZGVyLmpzCnZhciBSZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIuanMKdmFyIHBpY2tDaGFydFBvaW50ZXIgPSAoX3N0YXRlLCBjaGFydFBvaW50ZXIpID0+IGNoYXJ0UG9pbnRlcjsKdmFyIHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlciA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQ2hhcnRQb2ludGVyLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0UG9sYXJWaWV3Qm94LCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZSwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0T3JkZXJlZFRvb2x0aXBUaWNrcywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGNvbWJpbmVBY3RpdmVQcm9wcyk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0Q2hhcnRQb2ludGVyLmpzCnZhciBnZXRDaGFydFBvaW50ZXIgPSAoZXZlbnQpID0+IHsKICB2YXIgcmVjdCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNjYWxlWCA9IHJlY3Qud2lkdGggLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldFdpZHRoOwogIHZhciBzY2FsZVkgPSByZWN0LmhlaWdodCAvIGV2ZW50LmN1cnJlbnRUYXJnZXQub2Zmc2V0SGVpZ2h0OwogIHJldHVybiB7CiAgICAvKgogICAgICogSGVyZSBpdCdzIGltcG9ydGFudCB0byB1c2U6CiAgICAgKiAtIGV2ZW50LmNsaWVudFggYW5kIGV2ZW50LmNsaWVudFkgdG8gZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQsIGluY2x1ZGluZyBzY3JvbGwuCiAgICAgKiAtIHBhZ2VYIGFuZCBwYWdlWSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgd2hvbGUgZG9jdW1lbnQsIGFuZCBpZ25vcmUgc2Nyb2xsLgogICAgICogLSByZWN0LmxlZnQgYW5kIHJlY3QudG9wIGFyZSB1c2VkIHRvIGdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNoYXJ0IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydC4KICAgICAqIC0gb2Zmc2V0WCBhbmQgb2Zmc2V0WSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0IHBhcmVudAogICAgICogIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIHRoZSBzYW1lIGFzIHRoZSBjbGllbnRYIGFuZCBjbGllbnRZLCBkZXBlbmRpbmcgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCBpbiB0aGUgRE9NCiAgICAgKiAgYW5kIHN1cnJvdW5kaW5nIGVsZW1lbnQgc3R5bGVzLiBDU1MgcG9zaXRpb246IHJlbGF0aXZlLCBhYnNvbHV0ZSwgZml4ZWQsIHdpbGwgY2hhbmdlIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICogLSBzY2FsZVggYW5kIHNjYWxlWSBhcmUgbmVjZXNzYXJ5IGZvciB3aGVuIHRoZSBjaGFydCBlbGVtZW50IGlzIHNjYWxlZCB1c2luZyBDU1MgYHRyYW5zZm9ybTogc2NhbGUoTilgLgogICAgICovCiAgICBjaGFydFg6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQpIC8gc2NhbGVYKSwKICAgIGNoYXJ0WTogTWF0aC5yb3VuZCgoZXZlbnQuY2xpZW50WSAtIHJlY3QudG9wKSAvIHNjYWxlWSkKICB9Owp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9tb3VzZUV2ZW50c01pZGRsZXdhcmUuanMKdmFyIG1vdXNlQ2xpY2tBY3Rpb24gPSBjcmVhdGVBY3Rpb24oIm1vdXNlQ2xpY2siKTsKdmFyIG1vdXNlQ2xpY2tNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7Cm1vdXNlQ2xpY2tNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBtb3VzZUNsaWNrQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBtb3VzZVBvaW50ZXIgPSBhY3Rpb24ucGF5bG9hZDsKICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBnZXRDaGFydFBvaW50ZXIobW91c2VQb2ludGVyKSk7CiAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZUNsaWNrQXhpc0luZGV4KHsKICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGl2ZVByb3BzLmFjdGl2ZUNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CnZhciBtb3VzZU1vdmVBY3Rpb24gPSBjcmVhdGVBY3Rpb24oIm1vdXNlTW92ZSIpOwp2YXIgbW91c2VNb3ZlTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWQgPSBudWxsOwptb3VzZU1vdmVNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBtb3VzZU1vdmVBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIG1vdXNlUG9pbnRlciA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKHJhZklkICE9PSBudWxsKSB7CiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJhZklkKTsKICAgIH0KICAgIHZhciBjaGFydFBvaW50ZXIgPSBnZXRDaGFydFBvaW50ZXIobW91c2VQb2ludGVyKTsKICAgIHJhZklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgICAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnNoYXJlZCk7CiAgICAgIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgICAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIoc3RhdGUsIGNoYXJ0UG9pbnRlcik7CiAgICAgICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlT3ZlckF4aXNJbmRleCh7CiAgICAgICAgICAgIGFjdGl2ZUluZGV4OiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCwKICAgICAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgICAgICB9KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKG1vdXNlTGVhdmVDaGFydCgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmFmSWQgPSBudWxsOwogICAgfSk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlci5qcwpmdW5jdGlvbiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyKGtleSwgdmFsdWUpIHsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgcmV0dXJuICJIVE1MRWxlbWVudCA8Ii5jb25jYXQodmFsdWUudGFnTmFtZSwgJyBjbGFzcz0iJykuY29uY2F0KHZhbHVlLmNsYXNzTmFtZSwgJyI+Jyk7CiAgfQogIGlmICh2YWx1ZSA9PT0gd2luZG93KSB7CiAgICByZXR1cm4gImdsb2JhbC53aW5kb3ciOwogIH0KICBpZiAoa2V5ID09PSAiY2hpbGRyZW4iICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgIHJldHVybiAiPDxDSElMRFJFTj4+IjsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Jvb3RQcm9wc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMiA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBiYXJTaXplOiB2b2lkIDAsCiAgY2xhc3NOYW1lOiB2b2lkIDAsCiAgbWF4QmFyU2l6ZTogdm9pZCAwLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY0lkOiB2b2lkIDAsCiAgc3luY01ldGhvZDogImluZGV4IiwKICBiYXNlVmFsdWU6IHZvaWQgMCwKICByZXZlcnNlU3RhY2tPcmRlcjogZmFsc2UKfTsKdmFyIHJvb3RQcm9wc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyb290UHJvcHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTIsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZU9wdGlvbnM6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkYmFyR2E7CiAgICAgIHN0YXRlLmFjY2Vzc2liaWxpdHlMYXllciA9IGFjdGlvbi5wYXlsb2FkLmFjY2Vzc2liaWxpdHlMYXllcjsKICAgICAgc3RhdGUuYmFyQ2F0ZWdvcnlHYXAgPSBhY3Rpb24ucGF5bG9hZC5iYXJDYXRlZ29yeUdhcDsKICAgICAgc3RhdGUuYmFyR2FwID0gKF9hY3Rpb24kcGF5bG9hZCRiYXJHYSA9IGFjdGlvbi5wYXlsb2FkLmJhckdhcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJhckdhICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYmFyR2EgOiBpbml0aWFsU3RhdGUxMi5iYXJHYXA7CiAgICAgIHN0YXRlLmJhclNpemUgPSBhY3Rpb24ucGF5bG9hZC5iYXJTaXplOwogICAgICBzdGF0ZS5tYXhCYXJTaXplID0gYWN0aW9uLnBheWxvYWQubWF4QmFyU2l6ZTsKICAgICAgc3RhdGUuc3RhY2tPZmZzZXQgPSBhY3Rpb24ucGF5bG9hZC5zdGFja09mZnNldDsKICAgICAgc3RhdGUuc3luY0lkID0gYWN0aW9uLnBheWxvYWQuc3luY0lkOwogICAgICBzdGF0ZS5zeW5jTWV0aG9kID0gYWN0aW9uLnBheWxvYWQuc3luY01ldGhvZDsKICAgICAgc3RhdGUuY2xhc3NOYW1lID0gYWN0aW9uLnBheWxvYWQuY2xhc3NOYW1lOwogICAgICBzdGF0ZS5iYXNlVmFsdWUgPSBhY3Rpb24ucGF5bG9hZC5iYXNlVmFsdWU7CiAgICAgIHN0YXRlLnJldmVyc2VTdGFja09yZGVyID0gYWN0aW9uLnBheWxvYWQucmV2ZXJzZVN0YWNrT3JkZXI7CiAgICB9CiAgfQp9KTsKdmFyIHJvb3RQcm9wc1JlZHVjZXIgPSByb290UHJvcHNTbGljZS5yZWR1Y2VyOwp2YXIgewogIHVwZGF0ZU9wdGlvbnMKfSA9IHJvb3RQcm9wc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3BvbGFyT3B0aW9uc1NsaWNlLmpzCnZhciBwb2xhck9wdGlvbnNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicG9sYXJPcHRpb25zIiwKICBpbml0aWFsU3RhdGU6IG51bGwsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZVBvbGFyT3B0aW9uczogKF9zdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKICAgIH0KICB9Cn0pOwp2YXIgewogIHVwZGF0ZVBvbGFyT3B0aW9ucwp9ID0gcG9sYXJPcHRpb25zU2xpY2UuYWN0aW9uczsKdmFyIHBvbGFyT3B0aW9uc1JlZHVjZXIgPSBwb2xhck9wdGlvbnNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9rZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGtleURvd25BY3Rpb24gPSBjcmVhdGVBY3Rpb24oImtleURvd24iKTsKdmFyIGZvY3VzQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJmb2N1cyIpOwp2YXIga2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CmtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjoga2V5RG93bkFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgdmFyIGtleSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGtleSAhPT0gIkFycm93UmlnaHQiICYmIGtleSAhPT0gIkFycm93TGVmdCIgJiYga2V5ICE9PSAiRW50ZXIiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByZXNvbHZlZEluZGV4ID0gY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleChrZXlib2FyZEludGVyYWN0aW9uLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluKHN0YXRlKSk7CiAgICB2YXIgY3VycmVudEluZGV4ID0gcmVzb2x2ZWRJbmRleCA9PSBudWxsID8gLTEgOiBOdW1iZXIocmVzb2x2ZWRJbmRleCk7CiAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShjdXJyZW50SW5kZXgpIHx8IGN1cnJlbnRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHRvb2x0aXBUaWNrcyA9IHNlbGVjdFRvb2x0aXBBeGlzVGlja3Moc3RhdGUpOwogICAgaWYgKGtleSA9PT0gIkVudGVyIikgewogICAgICB2YXIgX2Nvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhrZXlib2FyZEludGVyYWN0aW9uLmluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZTogIWtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlLAogICAgICAgIGFjdGl2ZUluZGV4OiBrZXlib2FyZEludGVyYWN0aW9uLmluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IGtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBfY29vcmRpbmF0ZQogICAgICB9KSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkaXJlY3Rpb24gPSBzZWxlY3RDaGFydERpcmVjdGlvbihzdGF0ZSk7CiAgICB2YXIgZGlyZWN0aW9uTXVsdGlwbGllciA9IGRpcmVjdGlvbiA9PT0gImxlZnQtdG8tcmlnaHQiID8gMSA6IC0xOwogICAgdmFyIG1vdmVtZW50ID0ga2V5ID09PSAiQXJyb3dSaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbmV4dEluZGV4ID0gY3VycmVudEluZGV4ICsgbW92ZW1lbnQgKiBkaXJlY3Rpb25NdWx0aXBsaWVyOwogICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsIHx8IG5leHRJbmRleCA+PSB0b29sdGlwVGlja3MubGVuZ3RoIHx8IG5leHRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGFjdGl2ZUluZGV4OiBuZXh0SW5kZXgudG9TdHJpbmcoKSwKICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICB9KSk7CiAgfQp9KTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBmb2N1c0FjdGlvbiwKICBlZmZlY3Q6IChfYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSA9IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIgIT09IGZhbHNlOwogICAgaWYgKCFhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgewogICAgICBrZXlib2FyZEludGVyYWN0aW9uCiAgICB9ID0gc3RhdGUudG9vbHRpcDsKICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoa2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCA9PSBudWxsKSB7CiAgICAgIHZhciBuZXh0SW5kZXggPSAiMCI7CiAgICAgIHZhciBjb29yZGluYXRlID0gc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleChzdGF0ZSwgImF4aXMiLCAiaG92ZXIiLCBTdHJpbmcobmV4dEluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmU6IHRydWUsCiAgICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9leHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGV4dGVybmFsRXZlbnRBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImV4dGVybmFsRXZlbnQiKTsKdmFyIGV4dGVybmFsRXZlbnRzTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGV4dGVybmFsRXZlbnRBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHsKICAgICAgaGFuZGxlciwKICAgICAgcmVhY3RFdmVudAogICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGhhbmRsZXIgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZWFjdEV2ZW50LnBlcnNpc3QoKTsKICAgIHZhciBldmVudFR5cGUgPSByZWFjdEV2ZW50LnR5cGU7CiAgICB2YXIgZXhpc3RpbmdSYWZJZCA9IHJhZklkTWFwLmdldChldmVudFR5cGUpOwogICAgaWYgKGV4aXN0aW5nUmFmSWQgIT09IHZvaWQgMCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShleGlzdGluZ1JhZklkKTsKICAgIH0KICAgIHZhciByYWZJZDIgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB0cnkgewogICAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhS2V5KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgoc3RhdGUpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IHNlbGVjdEFjdGl2ZUxhYmVsKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogc2VsZWN0SXNUb29sdGlwQWN0aXZlKHN0YXRlKQogICAgICAgIH07CiAgICAgICAgaGFuZGxlcihuZXh0U3RhdGUsIHJlYWN0RXZlbnQpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHJhZklkTWFwLmRlbGV0ZShldmVudFR5cGUpOwogICAgICB9CiAgICB9KTsKICAgIHJhZklkTWFwLnNldChldmVudFR5cGUsIHJhZklkMik7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3RvdWNoU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RBbGxUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlXSwgKHRvb2x0aXBTdGF0ZSkgPT4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMpOwp2YXIgc2VsZWN0VG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCAoX3N0YXRlLCB0b29sdGlwSW5kZXgsIF9kYXRhS2V5KSA9PiB0b29sdGlwSW5kZXgsIChfc3RhdGUsIF90b29sdGlwSW5kZXgsIGRhdGFLZXkpID0+IGRhdGFLZXldLCAoYWxsVG9vbHRpcENvbmZpZ3VyYXRpb25zLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLCB0b29sdGlwSW5kZXgsIGRhdGFLZXkpID0+IHsKICB2YXIgbW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb24gPSBhbGxUb29sdGlwQ29uZmlndXJhdGlvbnMuZmluZCgodG9vbHRpcENvbmZpZ3VyYXRpb24pID0+IHsKICAgIHJldHVybiB0b29sdGlwQ29uZmlndXJhdGlvbi5zZXR0aW5ncy5kYXRhS2V5ID09PSBkYXRhS2V5OwogIH0pOwogIGlmIChtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgcG9zaXRpb25zCiAgfSA9IG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uOwogIGlmIChwb3NpdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG1heWJlUG9zaXRpb24gPSB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKHBvc2l0aW9ucywgdG9vbHRpcEluZGV4KTsKICByZXR1cm4gbWF5YmVQb3NpdGlvbjsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3RvdWNoRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgdG91Y2hFdmVudEFjdGlvbiA9IGNyZWF0ZUFjdGlvbigidG91Y2hNb3ZlIik7CnZhciB0b3VjaEV2ZW50TWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp0b3VjaEV2ZW50TWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogdG91Y2hFdmVudEFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgdG91Y2hFdmVudCA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKHRvdWNoRXZlbnQudG91Y2hlcyA9PSBudWxsIHx8IHRvdWNoRXZlbnQudG91Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIoc3RhdGUsIGdldENoYXJ0UG9pbnRlcih7CiAgICAgICAgY2xpZW50WDogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFgsCiAgICAgICAgY2xpZW50WTogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFksCiAgICAgICAgY3VycmVudFRhcmdldDogdG91Y2hFdmVudC5jdXJyZW50VGFyZ2V0CiAgICAgIH0pKTsKICAgICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgIH0pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiaXRlbSIpIHsKICAgICAgdmFyIF90YXJnZXQkZ2V0QXR0cmlidXRlOwogICAgICB2YXIgdG91Y2ggPSB0b3VjaEV2ZW50LnRvdWNoZXNbMF07CiAgICAgIGlmIChkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50ID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRhcmdldCA9IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7CiAgICAgIGlmICghdGFyZ2V0IHx8ICF0YXJnZXQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBpdGVtSW5kZXggPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9JTkRFWF9BVFRSSUJVVEVfTkFNRSk7CiAgICAgIHZhciBkYXRhS2V5ID0gKF90YXJnZXQkZ2V0QXR0cmlidXRlID0gdGFyZ2V0LmdldEF0dHJpYnV0ZShEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSkpICE9PSBudWxsICYmIF90YXJnZXQkZ2V0QXR0cmlidXRlICE9PSB2b2lkIDAgPyBfdGFyZ2V0JGdldEF0dHJpYnV0ZSA6IHZvaWQgMDsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZShsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBpdGVtSW5kZXgsIGRhdGFLZXkpOwogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoewogICAgICAgIGFjdGl2ZURhdGFLZXk6IGRhdGFLZXksCiAgICAgICAgYWN0aXZlSW5kZXg6IGl0ZW1JbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zdG9yZS5qcwp2YXIgcm9vdFJlZHVjZXIgPSBjb21iaW5lUmVkdWNlcnMoewogIGJydXNoOiBicnVzaFJlZHVjZXIsCiAgY2FydGVzaWFuQXhpczogY2FydGVzaWFuQXhpc1JlZHVjZXIsCiAgY2hhcnREYXRhOiBjaGFydERhdGFSZWR1Y2VyLAogIGVycm9yQmFyczogZXJyb3JCYXJSZWR1Y2VyLAogIGdyYXBoaWNhbEl0ZW1zOiBncmFwaGljYWxJdGVtc1JlZHVjZXIsCiAgbGF5b3V0OiBjaGFydExheW91dFJlZHVjZXIsCiAgbGVnZW5kOiBsZWdlbmRSZWR1Y2VyLAogIG9wdGlvbnM6IG9wdGlvbnNSZWR1Y2VyLAogIHBvbGFyQXhpczogcG9sYXJBeGlzUmVkdWNlciwKICBwb2xhck9wdGlvbnM6IHBvbGFyT3B0aW9uc1JlZHVjZXIsCiAgcmVmZXJlbmNlRWxlbWVudHM6IHJlZmVyZW5jZUVsZW1lbnRzUmVkdWNlciwKICByb290UHJvcHM6IHJvb3RQcm9wc1JlZHVjZXIsCiAgdG9vbHRpcDogdG9vbHRpcFJlZHVjZXIsCiAgekluZGV4OiB6SW5kZXhSZWR1Y2VyCn0pOwp2YXIgY3JlYXRlUmVjaGFydHNTdG9yZSA9IGZ1bmN0aW9uIGNyZWF0ZVJlY2hhcnRzU3RvcmUyKHByZWxvYWRlZFN0YXRlKSB7CiAgdmFyIGNoYXJ0TmFtZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogIkNoYXJ0IjsKICByZXR1cm4gY29uZmlndXJlU3RvcmUoewogICAgcmVkdWNlcjogcm9vdFJlZHVjZXIsCiAgICAvLyByZWR1eC10b29sa2l0IHYxIHR5cGVzIGFyZSB1bmhhcHB5IHdpdGggdGhlIHByZWxvYWRlZFN0YXRlIHR5cGUuIFJlbW92ZSB0aGUgYGFzIGFueWAgd2hlbiBidW1waW5nIHRvIHYyCiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBtaWRkbGV3YXJlIGFycmF5LiBSZW1vdmUgdGhpcyBjb21tZW50IHdoZW4gYnVtcGluZyB0byB2MgogICAgbWlkZGxld2FyZTogKGdldERlZmF1bHRNaWRkbGV3YXJlKSA9PiB7CiAgICAgIHZhciBfcHJvY2VzcyRlbnYkTk9ERV9FTlY7CiAgICAgIHJldHVybiBnZXREZWZhdWx0TWlkZGxld2FyZSh7CiAgICAgICAgc2VyaWFsaXphYmxlQ2hlY2s6IGZhbHNlLAogICAgICAgIGltbXV0YWJsZUNoZWNrOiAhWyJjb21tb25qcyIsICJlczYiLCAicHJvZHVjdGlvbiJdLmluY2x1ZGVzKChfcHJvY2VzcyRlbnYkTk9ERV9FTlYgPSAiZXM2IikgIT09IG51bGwgJiYgX3Byb2Nlc3MkZW52JE5PREVfRU5WICE9PSB2b2lkIDAgPyBfcHJvY2VzcyRlbnYkTk9ERV9FTlYgOiAiIikKICAgICAgfSkuY29uY2F0KFttb3VzZUNsaWNrTWlkZGxld2FyZS5taWRkbGV3YXJlLCBtb3VzZU1vdmVNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIGtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5taWRkbGV3YXJlLCBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgdG91Y2hFdmVudE1pZGRsZXdhcmUubWlkZGxld2FyZV0pOwogICAgfSwKICAgIC8qCiAgICAgKiBJIGNhbid0IGZpbmQgb3V0IGhvdyB0byBzYXRpc2Z5IHR5cGVzY3JpcHQgaGVyZS4KICAgICAqIFdlIHJldHVybiBgRW5oYW5jZXJBcnJheTxbU3RvcmVFbmhhbmNlcjx7fSwge30+LCBTdG9yZUVuaGFuY2VyXT5gIGZyb20gdGhpcyBmdW5jdGlvbiwKICAgICAqIGJ1dCB0aGUgdHlwZXMgc2F5IHdlIHNob3VsZCByZXR1cm4gYEVuaGFuY2VyQXJyYXk8U3RvcmVFbmhhbmNlcjx7fSwge30+YC4KICAgICAqIExvb2tzIGxpa2UgaXQncyBiYWRseSBpbmZlcnJlZCBnZW5lcmljcywgYnV0IGl0IHdvbid0IGFsbG93IG1lIHRvIHByb3ZpZGUgdGhlIGNvcnJlY3QgdHlwZSBtYW51YWxseSBlaXRoZXIuCiAgICAgKiBTbyBsZXQncyBqdXN0IGlnbm9yZSB0aGUgZXJyb3IgZm9yIG5vdy4KICAgICAqLwogICAgLy8gQHRzLWV4cGVjdC1lcnJvciBtaXNtYXRjaGVkIGdlbmVyaWNzCiAgICBlbmhhbmNlcnM6IChnZXREZWZhdWx0RW5oYW5jZXJzKSA9PiB7CiAgICAgIHZhciBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzOwogICAgICBpZiAodHlwZW9mIGdldERlZmF1bHRFbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuaGFuY2Vycy5jb25jYXQoYXV0b0JhdGNoRW5oYW5jZXIoewogICAgICAgIHR5cGU6ICJyYWYiCiAgICAgIH0pKTsKICAgIH0sCiAgICBkZXZUb29sczogR2xvYmFsLmRldlRvb2xzRW5hYmxlZCAmJiB7CiAgICAgIHNlcmlhbGl6ZTogewogICAgICAgIHJlcGxhY2VyOiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyCiAgICAgIH0sCiAgICAgIG5hbWU6ICJyZWNoYXJ0cy0iLmNvbmNhdChjaGFydE5hbWUpCiAgICB9CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzU3RvcmVQcm92aWRlci5qcwpmdW5jdGlvbiBSZWNoYXJ0c1N0b3JlUHJvdmlkZXIoX3JlZjIpIHsKICB2YXIgewogICAgcHJlbG9hZGVkU3RhdGUsCiAgICBjaGlsZHJlbiwKICAgIHJlZHV4U3RvcmVOYW1lCiAgfSA9IF9yZWYyOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBzdG9yZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VSZWYpKG51bGwpOwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmIChzdG9yZVJlZi5jdXJyZW50ID09IG51bGwpIHsKICAgIHN0b3JlUmVmLmN1cnJlbnQgPSBjcmVhdGVSZWNoYXJ0c1N0b3JlKHByZWxvYWRlZFN0YXRlLCByZWR1eFN0b3JlTmFtZSk7CiAgfQogIHZhciBub25OdWxsQ29udGV4dCA9IFJlY2hhcnRzUmVkdXhDb250ZXh0OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KFByb3ZpZGVyX2RlZmF1bHQsIHsKICAgIGNvbnRleHQ6IG5vbk51bGxDb250ZXh0LAogICAgc3RvcmU6IHN0b3JlUmVmLmN1cnJlbnQKICB9LCBjaGlsZHJlbik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVwb3J0TWFpbkNoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRNYWluQ2hhcnRQcm9wc0ltcGwoX3JlZjIpIHsKICB2YXIgewogICAgbGF5b3V0LAogICAgbWFyZ2luCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hKSB7CiAgICAgIGRpc3BhdGNoKHNldExheW91dChsYXlvdXQpKTsKICAgICAgZGlzcGF0Y2goc2V0TWFyZ2luKG1hcmdpbikpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGF5b3V0LCBtYXJnaW5dKTsKICByZXR1cm4gbnVsbDsKfQp2YXIgUmVwb3J0TWFpbkNoYXJ0UHJvcHMgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQyLm1lbW8pKFJlcG9ydE1haW5DaGFydFByb3BzSW1wbCwgcHJvcHNBcmVFcXVhbCk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlcG9ydENoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRDaGFydFByb3BzKHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaCh1cGRhdGVPcHRpb25zKHByb3BzKSk7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhdGVnb3JpY2FsQ2hhcnQuanMKdmFyIFJlYWN0MzMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBSZWFjdDMxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhQb3J0YWwuanMKdmFyIFJlYWN0MzAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gWkluZGV4U3ZnUG9ydGFsKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIHByZWZpeCA9IGlzUGFub3JhbWEgPyAicmVjaGFydHMtemluZGV4LXBhbm9yYW1hLSIgOiAicmVjaGFydHMtemluZGV4LSI7CiAgdmFyIHBvcnRhbElkID0gdXNlVW5pcXVlSWQoIiIuY29uY2F0KHByZWZpeCkuY29uY2F0KHpJbmRleCkpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQ0LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2gocmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgIHpJbmRleCwKICAgICAgZWxlbWVudElkOiBwb3J0YWxJZCwKICAgICAgaXNQYW5vcmFtYQogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbElkKHsKICAgICAgICB6SW5kZXgsCiAgICAgICAgaXNQYW5vcmFtYQogICAgICB9KSk7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgekluZGV4LCBwb3J0YWxJZCwgaXNQYW5vcmFtYV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgdGFiSW5kZXg6IC0xLAogICAgaWQ6IHBvcnRhbElkCiAgfSk7Cn0KZnVuY3Rpb24gQWxsWkluZGV4UG9ydGFscyhfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIGFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyk7CiAgaWYgKCFhbGxSZWdpc3RlcmVkWkluZGV4ZXMgfHwgYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICB2YXIgYWxsTmVnYXRpdmVaSW5kZXhlcyA9IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5maWx0ZXIoKHpJbmRleCkgPT4gekluZGV4IDwgMCk7CiAgdmFyIGFsbFBvc2l0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA+IDApOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFJlYWN0MzAuRnJhZ21lbnQsIG51bGwsIGFsbE5lZ2F0aXZlWkluZGV4ZXMubWFwKCh6SW5kZXgpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoWkluZGV4U3ZnUG9ydGFsLCB7CiAgICBrZXk6IHpJbmRleCwKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9KSksIGNoaWxkcmVuLCBhbGxQb3NpdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvUm9vdFN1cmZhY2UuanMKdmFyIF9leGNsdWRlZDE2ID0gWyJjaGlsZHJlbiJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTYoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE2KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfZXh0ZW5kczIwKCkgewogIHJldHVybiBfZXh0ZW5kczIwID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBGVUxMX1dJRFRIX0FORF9IRUlHSFQgPSB7CiAgd2lkdGg6ICIxMDAlIiwKICBoZWlnaHQ6ICIxMDAlIiwKICAvKgogICAqIGRpc3BsYXk6IGJsb2NrIGlzIG5lY2Vzc2FyeSBoZXJlIGJlY2F1c2UgdGhlIGRlZmF1bHQgZm9yIGFuIFNWRyBpcyBkaXNwbGF5OiBpbmxpbmUsCiAgICogd2hpY2ggaW4gc29tZSBicm93c2VycyAoQ2hyb21lKSBhZGRzIGEgbGl0dGxlIGJpdCBvZiBleHRyYSBzcGFjZSBhYm92ZSBhbmQgYmVsb3cgdGhlIFNWRwogICAqIHRvIG1ha2Ugc3BhY2UgZm9yIHRoZSBkZXNjZW5kZXIgb2YgbGV0dGVycyBsaWtlICJnIiBhbmQgInkiLiBUaGlzIHRocm93cyBvZmYgdGhlIGhlaWdodCBjYWxjdWxhdGlvbgogICAqIGFuZCBjYXVzZXMgdGhlIGNvbnRhaW5lciB0byBncm93IGluZGVmaW5pdGVseSBvbiBlYWNoIHJlbmRlciB3aXRoIHJlc3BvbnNpdmU9dHJ1ZS4KICAgKiBEaXNwbGF5OiBibG9jayByZW1vdmVzIHRoYXQgZXh0cmEgc3BhY2UuCiAgICoKICAgKiBJbnRlcmVzdGluZ2x5LCBGaXJlZm94IGRvZXMgbm90IGhhdmUgdGhpcyBwcm9ibGVtLCBidXQgaXQgZG9lc24ndCBodXJ0IHRvIGFkZCB0aGUgc3R5bGUgYW55d2F5LgogICAqLwogIGRpc3BsYXk6ICJibG9jayIKfTsKdmFyIE1haW5DaGFydFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ1LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHdpZHRoID0gdXNlQ2hhcnRXaWR0aCgpOwogIHZhciBoZWlnaHQgPSB1c2VDaGFydEhlaWdodCgpOwogIHZhciBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPSB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIoKTsKICBpZiAoIWlzUG9zaXRpdmVOdW1iZXIod2lkdGgpIHx8ICFpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBvdGhlckF0dHJpYnV0ZXMsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHM7CiAgdmFyIHRhYkluZGV4LCByb2xlOwogIGlmIChvdGhlckF0dHJpYnV0ZXMgIT0gbnVsbCkgewogICAgaWYgKHR5cGVvZiBvdGhlckF0dHJpYnV0ZXMudGFiSW5kZXggPT09ICJudW1iZXIiKSB7CiAgICAgIHRhYkluZGV4ID0gb3RoZXJBdHRyaWJ1dGVzLnRhYkluZGV4OwogICAgfSBlbHNlIHsKICAgICAgdGFiSW5kZXggPSBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPyAwIDogdm9pZCAwOwogICAgfQogICAgaWYgKHR5cGVvZiBvdGhlckF0dHJpYnV0ZXMucm9sZSA9PT0gInN0cmluZyIpIHsKICAgICAgcm9sZSA9IG90aGVyQXR0cmlidXRlcy5yb2xlOwogICAgfSBlbHNlIHsKICAgICAgcm9sZSA9IGhhc0FjY2Vzc2liaWxpdHlMYXllciA/ICJhcHBsaWNhdGlvbiIgOiB2b2lkIDA7CiAgICB9CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFN1cmZhY2UsIF9leHRlbmRzMjAoe30sIG90aGVyQXR0cmlidXRlcywgewogICAgdGl0bGUsCiAgICBkZXNjLAogICAgcm9sZSwKICAgIHRhYkluZGV4LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHlsZTogRlVMTF9XSURUSF9BTkRfSEVJR0hULAogICAgcmVmCiAgfSksIGNoaWxkcmVuKTsKfSk7CnZhciBCcnVzaFBhbm9yYW1hU3VyZmFjZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgYnJ1c2hEaW1lbnNpb25zID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hEaW1lbnNpb25zKTsKICBpZiAoIWJydXNoRGltZW5zaW9ucykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHk6IHkyLAogICAgeDogeDIKICB9ID0gYnJ1c2hEaW1lbnNpb25zOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFN1cmZhY2UsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIFJvb3RTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0NS5mb3J3YXJkUmVmKSgoX3JlZjIsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMiwgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KF9yZWYyLCBfZXhjbHVkZWQxNik7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KEJydXNoUGFub3JhbWFTdXJmYWNlLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KEFsbFpJbmRleFBvcnRhbHMsIHsKICAgICAgaXNQYW5vcmFtYTogdHJ1ZQogICAgfSwgY2hpbGRyZW4pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoTWFpbkNoYXJ0U3VyZmFjZSwgX2V4dGVuZHMyMCh7CiAgICByZWYKICB9LCByZXN0KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChBbGxaSW5kZXhQb3J0YWxzLCB7CiAgICBpc1Bhbm9yYW1hOiBmYWxzZQogIH0sIGNoaWxkcmVuKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9SZWNoYXJ0c1dyYXBwZXIuanMKdmFyIFJlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VSZXBvcnRTY2FsZS5qcwp2YXIgaW1wb3J0X3JlYWN0NDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZVJlcG9ydFNjYWxlKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFtyZWYsIHNldFJlZl0gPSAoMCwgaW1wb3J0X3JlYWN0NDYudXNlU3RhdGUpKG51bGwpOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENvbnRhaW5lclNjYWxlKTsKICAoMCwgaW1wb3J0X3JlYWN0NDYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocmVmID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlY3QgPSByZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgbmV3U2NhbGUgPSByZWN0LndpZHRoIC8gcmVmLm9mZnNldFdpZHRoOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobmV3U2NhbGUpICYmIG5ld1NjYWxlICE9PSBzY2FsZSkgewogICAgICBkaXNwYXRjaChzZXRTY2FsZShuZXdTY2FsZSkpOwogICAgfQogIH0sIFtyZWYsIGRpc3BhdGNoLCBzY2FsZV0pOwogIHJldHVybiBzZXRSZWY7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvUmVjaGFydHNXcmFwcGVyLmpzCmZ1bmN0aW9uIG93bktleXMzMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMxKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMxKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczIxKCkgewogIHJldHVybiBfZXh0ZW5kczIxID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBFdmVudFN5bmNocm9uaXplciA9ICgpID0+IHsKICB1c2VTeW5jaHJvbmlzZWRFdmVudHNGcm9tT3RoZXJDaGFydHMoKTsKICByZXR1cm4gbnVsbDsKfTsKZnVuY3Rpb24gZ2V0TnVtYmVyT3JaZXJvKHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgIHZhciBwYXJzZWQgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIGlmICghTnVtYmVyLmlzTmFOKHBhcnNlZCkpIHsKICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KICB9CiAgcmV0dXJuIDA7Cn0KdmFyIFJlc3BvbnNpdmVEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIF9wcm9wcyRzdHlsZSwgX3Byb3BzJHN0eWxlMjsKICB2YXIgb2JzZXJ2ZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlUmVmKShudWxsKTsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBnZXROdW1iZXJPclplcm8oKF9wcm9wcyRzdHlsZSA9IHByb3BzLnN0eWxlKSA9PT0gbnVsbCB8fCBfcHJvcHMkc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRzdHlsZS53aWR0aCksCiAgICBjb250YWluZXJIZWlnaHQ6IGdldE51bWJlck9yWmVybygoX3Byb3BzJHN0eWxlMiA9IHByb3BzLnN0eWxlKSA9PT0gbnVsbCB8fCBfcHJvcHMkc3R5bGUyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkc3R5bGUyLmhlaWdodCkKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBpZiAobm9kZSAhPSBudWxsICYmIHR5cGVvZiBSZXNpemVPYnNlcnZlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQKICAgICAgfSA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCk7CiAgICAgIHZhciBjYWxsYmFjayA9IChlbnRyaWVzKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0CiAgICAgICAgfSA9IGVudHJpZXNbMF0uY29udGVudFJlY3Q7CiAgICAgICAgc2V0Q29udGFpbmVyU2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgfTsKICAgICAgdmFyIG9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKGNhbGxiYWNrKTsKICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShub2RlKTsKICAgICAgb2JzZXJ2ZXJSZWYuY3VycmVudCA9IG9ic2VydmVyOwogICAgfQogIH0sIFtyZWYsIHNldENvbnRhaW5lclNpemVdKTsKICAoMCwgaW1wb3J0X3JlYWN0NDcudXNlRWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgb2JzZXJ2ZXIgPSBvYnNlcnZlclJlZi5jdXJyZW50OwogICAgICBpZiAob2JzZXJ2ZXIgIT0gbnVsbCkgewogICAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgfQogICAgfTsKICB9LCBbc2V0Q29udGFpbmVyU2l6ZV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlYWN0MzIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aDogc2l6ZXMuY29udGFpbmVyV2lkdGgsCiAgICBoZWlnaHQ6IHNpemVzLmNvbnRhaW5lckhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIxKHsKICAgIHJlZjogaW5uZXJSZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBSZWFkU2l6ZU9uY2VEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGdldE51bWJlck9yWmVybyh3aWR0aCksCiAgICBjb250YWluZXJIZWlnaHQ6IGdldE51bWJlck9yWmVybyhoZWlnaHQpCiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgaWYgKG5vZGUgIT0gbnVsbCkgewogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aCwKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodAogICAgICB9ID0gbm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0KTsKICAgIH0KICB9LCBbcmVmLCBzZXRDb250YWluZXJTaXplXSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoOiBzaXplcy5jb250YWluZXJXaWR0aCwKICAgIGhlaWdodDogc2l6ZXMuY29udGFpbmVySGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjEoewogICAgcmVmOiBpbm5lclJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIFN0YXRpY0RpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjEoewogICAgcmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgTm9uUmVzcG9uc2l2ZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgaWYgKGlzUGVyY2VudCh3aWR0aCkgfHwgaXNQZXJjZW50KGhlaWdodCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlYWRTaXplT25jZURpdiwgX2V4dGVuZHMyMSh7fSwgcHJvcHMsIHsKICAgICAgcmVmCiAgICB9KSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFN0YXRpY0RpdiwgX2V4dGVuZHMyMSh7fSwgcHJvcHMsIHsKICAgIHJlZgogIH0pKTsKfSk7CmZ1bmN0aW9uIGdldFdyYXBwZXJEaXZDb21wb25lbnQocmVzcG9uc2l2ZSkgewogIHJldHVybiByZXNwb25zaXZlID09PSB0cnVlID8gUmVzcG9uc2l2ZURpdiA6IE5vblJlc3BvbnNpdmVEaXY7Cn0KdmFyIFJlY2hhcnRzV3JhcHBlciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUsCiAgICBoZWlnaHQ6IGhlaWdodEZyb21Qcm9wcywKICAgIG9uQ2xpY2ssCiAgICBvbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljaywKICAgIG9uTW91c2VEb3duLAogICAgb25Nb3VzZUVudGVyLAogICAgb25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlVXAsCiAgICBvblRvdWNoRW5kLAogICAgb25Ub3VjaE1vdmUsCiAgICBvblRvdWNoU3RhcnQsCiAgICBzdHlsZSwKICAgIHdpZHRoOiB3aWR0aEZyb21Qcm9wcywKICAgIHJlc3BvbnNpdmUsCiAgICBkaXNwYXRjaFRvdWNoRXZlbnRzID0gdHJ1ZQogIH0gPSBwcm9wczsKICB2YXIgY29udGFpbmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVJlZikobnVsbCk7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgW3Rvb2x0aXBQb3J0YWwsIHNldFRvb2x0aXBQb3J0YWxdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKShudWxsKTsKICB2YXIgW2xlZ2VuZFBvcnRhbCwgc2V0TGVnZW5kUG9ydGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIHNldFNjYWxlUmVmID0gdXNlUmVwb3J0U2NhbGUoKTsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9IHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KCk7CiAgdmFyIHdpZHRoID0gKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IG51bGwgfHwgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCkgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA6IHdpZHRoRnJvbVByb3BzOwogIHZhciBoZWlnaHQgPSAocmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gbnVsbCB8fCByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCkgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgOiBoZWlnaHRGcm9tUHJvcHM7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgc2V0U2NhbGVSZWYobm9kZSk7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBzZXRUb29sdGlwUG9ydGFsKG5vZGUpOwogICAgc2V0TGVnZW5kUG9ydGFsKG5vZGUpOwogICAgaWYgKG5vZGUgIT0gbnVsbCkgewogICAgICBjb250YWluZXJSZWYuY3VycmVudCA9IG5vZGU7CiAgICB9CiAgfSwgW3NldFNjYWxlUmVmLCByZWYsIHNldFRvb2x0aXBQb3J0YWwsIHNldExlZ2VuZFBvcnRhbF0pOwogIHZhciBteU9uQ2xpY2sgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZUNsaWNrQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkNsaWNrLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkNsaWNrXSk7CiAgdmFyIG15T25Nb3VzZUVudGVyID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VNb3ZlQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlRW50ZXIsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VFbnRlcl0pOwogIHZhciBteU9uTW91c2VMZWF2ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTGVhdmVDaGFydCgpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlTGVhdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VMZWF2ZV0pOwogIHZhciBteU9uTW91c2VNb3ZlID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VNb3ZlQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlTW92ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZU1vdmVdKTsKICB2YXIgb25Gb2N1cyA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKCkgPT4gewogICAgZGlzcGF0Y2goZm9jdXNBY3Rpb24oKSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdmFyIG9uS2V5RG93biA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGtleURvd25BY3Rpb24oZS5rZXkpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB2YXIgbXlPbkNvbnRleHRNZW51ID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uQ29udGV4dE1lbnUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uQ29udGV4dE1lbnVdKTsKICB2YXIgbXlPbkRvdWJsZUNsaWNrID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uRG91YmxlQ2xpY2ssCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uRG91YmxlQ2xpY2tdKTsKICB2YXIgbXlPbk1vdXNlRG93biA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlRG93biwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZURvd25dKTsKICB2YXIgbXlPbk1vdXNlVXAgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZVVwLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlVXBdKTsKICB2YXIgbXlPblRvdWNoU3RhcnQgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaFN0YXJ0LAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvblRvdWNoU3RhcnRdKTsKICB2YXIgbXlPblRvdWNoTW92ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGlmIChkaXNwYXRjaFRvdWNoRXZlbnRzKSB7CiAgICAgIGRpc3BhdGNoKHRvdWNoRXZlbnRBY3Rpb24oZSkpOwogICAgfQogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hNb3ZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBkaXNwYXRjaFRvdWNoRXZlbnRzLCBvblRvdWNoTW92ZV0pOwogIHZhciBteU9uVG91Y2hFbmQgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaEVuZCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Ub3VjaEVuZF0pOwogIHZhciBXcmFwcGVyRGl2ID0gZ2V0V3JhcHBlckRpdkNvbXBvbmVudChyZXNwb25zaXZlKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChUb29sdGlwUG9ydGFsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHRvb2x0aXBQb3J0YWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KExlZ2VuZFBvcnRhbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiBsZWdlbmRQb3J0YWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFdyYXBwZXJEaXYsIHsKICAgIHdpZHRoOiB3aWR0aCAhPT0gbnVsbCAmJiB3aWR0aCAhPT0gdm9pZCAwID8gd2lkdGggOiBzdHlsZSA9PT0gbnVsbCB8fCBzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3R5bGUud2lkdGgsCiAgICBoZWlnaHQ6IGhlaWdodCAhPT0gbnVsbCAmJiBoZWlnaHQgIT09IHZvaWQgMCA/IGhlaWdodCA6IHN0eWxlID09PSBudWxsIHx8IHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdHlsZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXdyYXBwZXIiLCBjbGFzc05hbWUpLAogICAgc3R5bGU6IF9vYmplY3RTcHJlYWQzMSh7CiAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICBjdXJzb3I6ICJkZWZhdWx0IiwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSwgc3R5bGUpLAogICAgb25DbGljazogbXlPbkNsaWNrLAogICAgb25Db250ZXh0TWVudTogbXlPbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljazogbXlPbkRvdWJsZUNsaWNrLAogICAgb25Gb2N1cywKICAgIG9uS2V5RG93biwKICAgIG9uTW91c2VEb3duOiBteU9uTW91c2VEb3duLAogICAgb25Nb3VzZUVudGVyOiBteU9uTW91c2VFbnRlciwKICAgIG9uTW91c2VMZWF2ZTogbXlPbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlTW92ZTogbXlPbk1vdXNlTW92ZSwKICAgIG9uTW91c2VVcDogbXlPbk1vdXNlVXAsCiAgICBvblRvdWNoRW5kOiBteU9uVG91Y2hFbmQsCiAgICBvblRvdWNoTW92ZTogbXlPblRvdWNoTW92ZSwKICAgIG9uVG91Y2hTdGFydDogbXlPblRvdWNoU3RhcnQsCiAgICByZWY6IGlubmVyUmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChFdmVudFN5bmNocm9uaXplciwgbnVsbCksIGNoaWxkcmVuKSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2F0ZWdvcmljYWxDaGFydC5qcwp2YXIgX2V4Y2x1ZGVkMTcgPSBbIndpZHRoIiwgImhlaWdodCIsICJyZXNwb25zaXZlIiwgImNoaWxkcmVuIiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJjb21wYWN0IiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTcoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIENhdGVnb3JpY2FsQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZSwKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgc3R5bGUsCiAgICBjb21wYWN0LAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhwcm9wcywgX2V4Y2x1ZGVkMTcpOwogIHZhciBhdHRycyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvdGhlcnMpOwogIGlmIChjb21wYWN0KSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWFjdDMzLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSb290U3VyZmFjZSwgewogICAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgICB0aXRsZSwKICAgICAgZGVzYwogICAgfSwgY2hpbGRyZW4pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNXcmFwcGVyLCB7CiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZTogcmVzcG9uc2l2ZSAhPT0gbnVsbCAmJiByZXNwb25zaXZlICE9PSB2b2lkIDAgPyByZXNwb25zaXZlIDogZmFsc2UsCiAgICBvbkNsaWNrOiBwcm9wcy5vbkNsaWNrLAogICAgb25Nb3VzZUxlYXZlOiBwcm9wcy5vbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlRW50ZXI6IHByb3BzLm9uTW91c2VFbnRlciwKICAgIG9uTW91c2VNb3ZlOiBwcm9wcy5vbk1vdXNlTW92ZSwKICAgIG9uTW91c2VEb3duOiBwcm9wcy5vbk1vdXNlRG93biwKICAgIG9uTW91c2VVcDogcHJvcHMub25Nb3VzZVVwLAogICAgb25Db250ZXh0TWVudTogcHJvcHMub25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IHByb3BzLm9uRG91YmxlQ2xpY2ssCiAgICBvblRvdWNoU3RhcnQ6IHByb3BzLm9uVG91Y2hTdGFydCwKICAgIG9uVG91Y2hNb3ZlOiBwcm9wcy5vblRvdWNoTW92ZSwKICAgIG9uVG91Y2hFbmQ6IHByb3BzLm9uVG91Y2hFbmQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgdGl0bGUsCiAgICBkZXNjLAogICAgcmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChDbGlwUGF0aFByb3ZpZGVyLCBudWxsLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCmZ1bmN0aW9uIF9leHRlbmRzMjIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIGRlZmF1bHRNYXJnaW4gPSB7CiAgdG9wOiA1LAogIHJpZ2h0OiA1LAogIGJvdHRvbTogNSwKICBsZWZ0OiA1Cn07CnZhciBkZWZhdWx0Q2FydGVzaWFuQ2hhcnRQcm9wcyA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICBtYXJnaW46IGRlZmF1bHRNYXJnaW4sCiAgcmVzcG9uc2l2ZTogZmFsc2UsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY01ldGhvZDogImluZGV4Igp9Owp2YXIgQ2FydGVzaWFuQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ5LmZvcndhcmRSZWYpKGZ1bmN0aW9uIENhcnRlc2lhbkNoYXJ0Mihwcm9wcywgcmVmKSB7CiAgdmFyIF9jYXRlZ29yaWNhbENoYXJ0UHJvcDsKICB2YXIgcm9vdENoYXJ0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLmNhdGVnb3JpY2FsQ2hhcnRQcm9wcywgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMpOwogIHZhciB7CiAgICBjaGFydE5hbWUsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzCiAgfSA9IHByb3BzOwogIHZhciBvcHRpb25zID0gewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGV2ZW50RW1pdHRlcjogdm9pZCAwCiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1N0b3JlUHJvdmlkZXIsIHsKICAgIHByZWxvYWRlZFN0YXRlOiB7CiAgICAgIG9wdGlvbnMKICAgIH0sCiAgICByZWR1eFN0b3JlTmFtZTogKF9jYXRlZ29yaWNhbENoYXJ0UHJvcCA9IGNhdGVnb3JpY2FsQ2hhcnRQcm9wcy5pZCkgIT09IG51bGwgJiYgX2NhdGVnb3JpY2FsQ2hhcnRQcm9wICE9PSB2b2lkIDAgPyBfY2F0ZWdvcmljYWxDaGFydFByb3AgOiBjaGFydE5hbWUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KENoYXJ0RGF0YUNvbnRleHRQcm92aWRlciwgewogICAgY2hhcnREYXRhOiBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuZGF0YQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlcG9ydE1haW5DaGFydFByb3BzLCB7CiAgICBsYXlvdXQ6IHJvb3RDaGFydFByb3BzLmxheW91dCwKICAgIG1hcmdpbjogcm9vdENoYXJ0UHJvcHMubWFyZ2luCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRQcm9wcywgewogICAgYmFzZVZhbHVlOiByb290Q2hhcnRQcm9wcy5iYXNlVmFsdWUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHJvb3RDaGFydFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciwKICAgIGJhckNhdGVnb3J5R2FwOiByb290Q2hhcnRQcm9wcy5iYXJDYXRlZ29yeUdhcCwKICAgIG1heEJhclNpemU6IHJvb3RDaGFydFByb3BzLm1heEJhclNpemUsCiAgICBzdGFja09mZnNldDogcm9vdENoYXJ0UHJvcHMuc3RhY2tPZmZzZXQsCiAgICBiYXJHYXA6IHJvb3RDaGFydFByb3BzLmJhckdhcCwKICAgIGJhclNpemU6IHJvb3RDaGFydFByb3BzLmJhclNpemUsCiAgICBzeW5jSWQ6IHJvb3RDaGFydFByb3BzLnN5bmNJZCwKICAgIHN5bmNNZXRob2Q6IHJvb3RDaGFydFByb3BzLnN5bmNNZXRob2QsCiAgICBjbGFzc05hbWU6IHJvb3RDaGFydFByb3BzLmNsYXNzTmFtZSwKICAgIHJldmVyc2VTdGFja09yZGVyOiByb290Q2hhcnRQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KENhdGVnb3JpY2FsQ2hhcnQsIF9leHRlbmRzMjIoe30sIHJvb3RDaGFydFByb3BzLCB7CiAgICByZWYKICB9KSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQXJlYUNoYXJ0LmpzCnZhciBSZWFjdDM1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBhbGxvd2VkVG9vbHRpcFR5cGVzID0gWyJheGlzIl07CnZhciBBcmVhQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM1LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQ2hhcnQsIHsKICAgIGNoYXJ0TmFtZTogIkFyZWFDaGFydCIsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTogImF4aXMiLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlczogYWxsb3dlZFRvb2x0aXBUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXI6IGFycmF5VG9vbHRpcFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzOiBwcm9wcywKICAgIHJlZgogIH0pOwp9KTsKCi8vIHNyYy9NeUJ1ZGdldC50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZSA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIFNUT1JBR0VfS0VZID0gIk1ZX0JVREdFVF9EQVRBIjsKdmFyIEJVREdFVFNfTElTVF9LRVkgPSAiTVlfQlVER0VUX0xJU1QiOwp2YXIgZ2VuZXJhdGVJZCA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTsKdmFyIENPTE9SUyA9IHsKICBwcmltYXJ5OiAiIzFCNDMzMiIsCiAgcHJpbWFyeURhcms6ICIjMEYyQjFGIiwKICBwcmltYXJ5TGlnaHQ6ICIjMkQ2QTRGIiwKICBhY2NlbnQ6ICIjNDA5MTZDIiwKICBhY2NlbnRMaWdodDogIiNFOEY1RTkiLAogIGJnOiAiI0Y1RjVGMCIsCiAgY2FyZDogIiNGRkZGRkYiLAogIGJvcmRlcjogIiNFNUU3RUIiLAogIGJvcmRlckxpZ2h0OiAiI0YwRjBGMCIsCiAgdGV4dE1haW46ICIjMUExQTFBIiwKICB0ZXh0U2Vjb25kYXJ5OiAiIzZCNzI4MCIsCiAgdGV4dE11dGVkOiAiIzlDQTNBRiIsCiAgaW5jb21lOiAiIzA1OTY2OSIsCiAgaW5jb21lQmc6ICIjRUNGREY1IiwKICBleHBlbnNlOiAiI0RDMjYyNiIsCiAgZXhwZW5zZUJnOiAiI0ZFRjJGMiIsCiAgYXNzZXQ6ICIjMjU2M0VCIiwKICBhc3NldEJnOiAiI0VGRjZGRiIsCiAgbm9uTGlxdWlkOiAiIzdDM0FFRCIsCiAgbm9uTGlxdWlkQmc6ICIjRjVGM0ZGIiwKICByZXRpcmVtZW50OiAiIzA4OTFCMiIsCiAgcmV0aXJlbWVudEJnOiAiI0VDRkVGRiIsCiAgbGlhYmlsaXR5OiAiI0VBNTgwQyIsCiAgbGlhYmlsaXR5Qmc6ICIjRkZGN0VEIiwKICBwb3NpdGl2ZTogIiMwNTk2NjkiLAogIG5lZ2F0aXZlOiAiI0RDMjYyNiIsCiAgd2FybmluZzogIiNEOTc3MDYiCn07CnZhciBmbXQgPSAobikgPT4gewogIGlmIChNYXRoLmFicyhuKSA+PSAxZTYpIHJldHVybiBgJCR7KG4gLyAxZTYpLnRvRml4ZWQoMil9TWA7CiAgcmV0dXJuIG4udG9Mb2NhbGVTdHJpbmcoImVuLVVTIiwgeyBzdHlsZTogImN1cnJlbmN5IiwgY3VycmVuY3k6ICJVU0QiLCBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IDAsIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMCB9KTsKfTsKdmFyIGZtdEV4YWN0ID0gKG4pID0+IG4udG9Mb2NhbGVTdHJpbmcoImVuLVVTIiwgeyBzdHlsZTogImN1cnJlbmN5IiwgY3VycmVuY3k6ICJVU0QiLCBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IDAsIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMCB9KTsKdmFyIGZtdFByaWNlID0gKG4pID0+IG4udG9Mb2NhbGVTdHJpbmcoImVuLVVTIiwgeyBzdHlsZTogImN1cnJlbmN5IiwgY3VycmVuY3k6ICJVU0QiLCBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IDIsIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMiB9KTsKdmFyIGVtcHR5QnVkZ2V0ID0gKCkgPT4gKHsKICBpZDogZ2VuZXJhdGVJZCgpLAogIG5hbWU6ICJNeSBCdWRnZXQgUGxhbiIsCiAgaW5jb21lOiBbXSwKICBleHBlbnNlczogW10sCiAgYXNzZXRzOiBbXSwKICBub25MaXF1aWRBc3NldHM6IFtdLAogIHJldGlyZW1lbnQ6IFtdLAogIGxpYWJpbGl0aWVzOiBbXSwKICBub25MaXF1aWREaXNjb3VudDogMjUsCiAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLAogIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQp9KTsKdmFyIGVtcHR5SXRlbSA9IChmcmVxID0gIm1vbnRobHkiKSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZTogIiIsCiAgYW1vdW50OiAwLAogIGZyZXF1ZW5jeTogZnJlcSwKICB0b3RhbFZhbHVlOiAwLAogIG1vbnRobHlWYWx1ZTogMAp9KTsKdmFyIGNvbXB1dGVWYWx1ZXMgPSAoYW1vdW50LCBmcmVxdWVuY3kpID0+IHsKICBzd2l0Y2ggKGZyZXF1ZW5jeSkgewogICAgY2FzZSAibW9udGhseSI6CiAgICAgIHJldHVybiB7IHRvdGFsVmFsdWU6IGFtb3VudCAqIDEyLCBtb250aGx5VmFsdWU6IGFtb3VudCB9OwogICAgY2FzZSAieWVhcmx5IjoKICAgICAgcmV0dXJuIHsgdG90YWxWYWx1ZTogYW1vdW50LCBtb250aGx5VmFsdWU6IE1hdGgucm91bmQoYW1vdW50IC8gMTIgKiAxMDApIC8gMTAwIH07CiAgICBjYXNlICJvbmVfdGltZSI6CiAgICAgIHJldHVybiB7IHRvdGFsVmFsdWU6IGFtb3VudCwgbW9udGhseVZhbHVlOiAwIH07CiAgfQp9Owp2YXIgQVBJX0JBU0UgPSAoKCkgPT4gewogIHRyeSB7CiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmxvY2F0aW9uLnByb3RvY29sID09PSAiZmlsZToiKSB7CiAgICAgIHJldHVybiAiaHR0cHM6Ly9teS1idWRnZXQtcGxhbm5lci5vbnJlbmRlci5jb20iOwogICAgfQogICAgcmV0dXJuICIiOwogIH0gY2F0Y2ggewogICAgcmV0dXJuICIiOwogIH0KfSkoKTsKdmFyIHRyYWNrRXZlbnQgPSAoZXZlbnQsIGRhdGEpID0+IHsKICBmZXRjaChgJHtBUElfQkFTRX0vYXBpL3RyYWNrYCwgewogICAgbWV0aG9kOiAiUE9TVCIsCiAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXZlbnQsIGRhdGE6IGRhdGEgfHwge30gfSkKICB9KS5jYXRjaCgoKSA9PiB7CiAgfSk7Cn07CnZhciBDT0lOR0VDS09fQkFTRSA9ICJodHRwczovL2FwaS5jb2luZ2Vja28uY29tL2FwaS92MyI7CnZhciBzZWFyY2hDb2lucyA9IGFzeW5jIChxdWVyeSkgPT4gewogIGlmICghcXVlcnkgfHwgcXVlcnkubGVuZ3RoIDwgMikgcmV0dXJuIFtdOwogIHRyeSB7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHtDT0lOR0VDS09fQkFTRX0vc2VhcmNoP3F1ZXJ5PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5KX1gKTsKICAgIGlmICghcmVzLm9rKSByZXR1cm4gW107CiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIHJldHVybiAoZGF0YS5jb2lucyB8fCBbXSkuc2xpY2UoMCwgOCkubWFwKChjKSA9PiAoewogICAgICBpZDogYy5pZCwKICAgICAgbmFtZTogYy5uYW1lLAogICAgICBzeW1ib2w6IGMuc3ltYm9sLAogICAgICB0aHVtYjogYy50aHVtYgogICAgfSkpOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIFtdOwogIH0KfTsKdmFyIGZldGNoQ3J5cHRvUHJpY2VzID0gYXN5bmMgKGlkcykgPT4gewogIGlmIChpZHMubGVuZ3RoID09PSAwKSByZXR1cm4ge307CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke0NPSU5HRUNLT19CQVNFfS9zaW1wbGUvcHJpY2U/aWRzPSR7aWRzLmpvaW4oIiwiKX0mdnNfY3VycmVuY2llcz11c2RgKTsKICAgIGlmICghcmVzLm9rKSByZXR1cm4ge307CiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGNvbnN0IHByaWNlcyA9IHt9OwogICAgZm9yIChjb25zdCBpZCBvZiBpZHMpIHsKICAgICAgaWYgKGRhdGFbaWRdPy51c2QpIHByaWNlc1tpZF0gPSBkYXRhW2lkXS51c2Q7CiAgICB9CiAgICByZXR1cm4gcHJpY2VzOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIHt9OwogIH0KfTsKdmFyIEZJTk5IVUJfS0VZID0gImQ2NTJldGhyMDFxcWJsbjVrampnZDY1MmV0aHIwMXFxYmxuNWtqazAiOwp2YXIgZmV0Y2hTdG9ja1ByaWNlcyA9IGFzeW5jIChzeW1ib2xzKSA9PiB7CiAgaWYgKHN5bWJvbHMubGVuZ3RoID09PSAwKSByZXR1cm4ge307CiAgY29uc3QgcmVzdWx0cyA9IHt9OwogIGF3YWl0IFByb21pc2UuYWxsKHN5bWJvbHMubWFwKGFzeW5jIChzeW1ib2wpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGBodHRwczovL2Zpbm5odWIuaW8vYXBpL3YxL3F1b3RlP3N5bWJvbD0ke3N5bWJvbH0mdG9rZW49JHtGSU5OSFVCX0tFWX1gKTsKICAgICAgaWYgKCFyZXMub2spIHJldHVybjsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICAgIGlmIChkYXRhLmMgJiYgZGF0YS5jID4gMCkgcmVzdWx0c1tzeW1ib2xdID0gZGF0YS5jOwogICAgfSBjYXRjaCB7CiAgICB9CiAgfSkpOwogIHJldHVybiByZXN1bHRzOwp9Owp2YXIgbWkgPSAobmFtZSwgYW1vdW50LCBmcmVxID0gIm1vbnRobHkiKSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZSwKICBhbW91bnQsCiAgZnJlcXVlbmN5OiBmcmVxLAogIHRvdGFsVmFsdWU6IGZyZXEgPT09ICJtb250aGx5IiA/IGFtb3VudCAqIDEyIDogZnJlcSA9PT0gInllYXJseSIgPyBhbW91bnQgOiBhbW91bnQsCiAgbW9udGhseVZhbHVlOiBmcmVxID09PSAibW9udGhseSIgPyBhbW91bnQgOiBmcmVxID09PSAieWVhcmx5IiA/IE1hdGgucm91bmQoYW1vdW50IC8gMTIpIDogMAp9KTsKdmFyIG1pYSA9IChuYW1lLCBhbW91bnQpID0+ICh7CiAgaWQ6IGdlbmVyYXRlSWQoKSwKICBuYW1lLAogIGFtb3VudCwKICBmcmVxdWVuY3k6ICJvbmVfdGltZSIsCiAgdG90YWxWYWx1ZTogYW1vdW50LAogIG1vbnRobHlWYWx1ZTogMAp9KTsKdmFyIEJVREdFVF9QUkVTRVRTID0gWwogIHsKICAgIC8vIEdlbiBaOiB+MjItMjgsIG1lZGlhbiBzYWxhcnkgfiQ0MGssIH4kMiw4MDAvbW8gYWZ0ZXIgdGF4CiAgICBrZXk6ICJnZW5feiIsCiAgICBsYWJlbDogIkdlbiBaIiwKICAgIGVtb2ppOiAiXHV7MUY0RjF9IiwKICAgIGRlc2M6ICJTdGFydGluZyBvdXQsIHNpZGUgaHVzdGxlcyAmIHN1YnNjcmlwdGlvbnMiLAogICAgYnVkZ2V0OiB7CiAgICAgIG5hbWU6ICJHZW4gWiBCdWRnZXQiLAogICAgICBpbmNvbWU6IFttaSgiUGFydC10aW1lIC8gRnVsbC10aW1lIEpvYiIsIDI0MDApLCBtaSgiRnJlZWxhbmNlIC8gU2lkZSBIdXN0bGUiLCA1MDApLCBtaSgiVGlwcyAvIEdpZyBXb3JrIiwgMjAwKV0sCiAgICAgIGV4cGVuc2VzOiBbbWkoIlJlbnQgKHNoYXJlZCkiLCA5NTApLCBtaSgiR3JvY2VyaWVzIiwgMzUwKSwgbWkoIlBob25lIFBsYW4iLCA4MCksIG1pKCJTdHJlYW1pbmcgKE5ldGZsaXgsIFNwb3RpZnkpIiwgMzApLCBtaSgiRGluaW5nIE91dCIsIDIwMCksIG1pKCJVYmVyIC8gVHJhbnNpdCIsIDEyMCksIG1pKCJHeW0gTWVtYmVyc2hpcCIsIDQwKSwgbWkoIlN1YnNjcmlwdGlvbnMgKGFwcHMpIiwgMjUpLCBtaSgiQ2xvdGhpbmciLCA3NSksIG1pKCJFbnRlcnRhaW5tZW50IiwgMTAwKV0sCiAgICAgIGFzc2V0czogW21pYSgiU2F2aW5ncyBBY2NvdW50IiwgMjUwMCksIG1pYSgiVmVubW8gLyBDYXNoIEFwcCBCYWxhbmNlIiwgMzAwKSwgbWlhKCJDcnlwdG8iLCA1MDApXSwKICAgICAgbm9uTGlxdWlkQXNzZXRzOiBbbWlhKCJMYXB0b3AiLCAxMjAwKSwgbWlhKCJQaG9uZSIsIDgwMCldLAogICAgICByZXRpcmVtZW50OiBbbWlhKCJSb3RoIElSQSIsIDNlMyldLAogICAgICBsaWFiaWxpdGllczogW21pYSgiU3R1ZGVudCBMb2FucyIsIDI4ZTMpLCBtaWEoIkNyZWRpdCBDYXJkIEJhbGFuY2UiLCAyNTAwKSwgbWkoIkJ1eSBOb3cgUGF5IExhdGVyIiwgNTApXSwKICAgICAgbm9uTGlxdWlkRGlzY291bnQ6IDUwCiAgICB9CiAgfSwKICB7CiAgICAvLyBNaWxsZW5uaWFsOiB+MjktNDMsIG1lZGlhbiBzYWxhcnkgfiQ2NWssIH4kNCwyMDAvbW8gYWZ0ZXIgdGF4CiAgICBrZXk6ICJtaWxsZW5uaWFsIiwKICAgIGxhYmVsOiAiTWlsbGVubmlhbCIsCiAgICBlbW9qaTogIlx1ezFGNEJDfSIsCiAgICBkZXNjOiAiQ2FyZWVyIGdyb3d0aCwgYnVpbGRpbmcgd2VhbHRoIiwKICAgIGJ1ZGdldDogewogICAgICBuYW1lOiAiTWlsbGVubmlhbCBCdWRnZXQiLAogICAgICBpbmNvbWU6IFttaSgiU2FsYXJ5IiwgNDIwMCksIG1pKCJCb251cyIsIDVlMywgInllYXJseSIpLCBtaSgiU2lkZSBQcm9qZWN0IC8gRnJlZWxhbmNlIiwgNDAwKV0sCiAgICAgIGV4cGVuc2VzOiBbbWkoIlJlbnQgLyBNb3J0Z2FnZSIsIDE1MDApLCBtaSgiR3JvY2VyaWVzIiwgNDUwKSwgbWkoIkNhciBQYXltZW50IiwgNTAwKSwgbWkoIkNhciBJbnN1cmFuY2UiLCAxNTApLCBtaSgiVXRpbGl0aWVzIiwgMjAwKSwgbWkoIlBob25lIFBsYW4iLCA4NSksIG1pKCJJbnRlcm5ldCIsIDcwKSwgbWkoIlN0cmVhbWluZyBTZXJ2aWNlcyIsIDQ1KSwgbWkoIkRpbmluZyBPdXQiLCAyNTApLCBtaSgiR3ltIiwgNTApLCBtaSgiUGV0IEV4cGVuc2VzIiwgMTAwKSwgbWkoIlRyYXZlbCBGdW5kIiwgMjAwKV0sCiAgICAgIGFzc2V0czogW21pYSgiQ2hlY2tpbmcgQWNjb3VudCIsIDRlMyksIG1pYSgiU2F2aW5ncyBBY2NvdW50IiwgMTJlMyksIG1pYSgiQnJva2VyYWdlIEFjY291bnQiLCAxNWUzKSwgbWlhKCJDcnlwdG8gUG9ydGZvbGlvIiwgM2UzKV0sCiAgICAgIG5vbkxpcXVpZEFzc2V0czogW21pYSgiQ2FyIiwgMThlMyksIG1pYSgiRnVybml0dXJlICYgRWxlY3Ryb25pY3MiLCA1ZTMpXSwKICAgICAgcmV0aXJlbWVudDogW21pYSgiNDAxayIsIDM1ZTMpLCBtaWEoIlJvdGggSVJBIiwgMTJlMyldLAogICAgICBsaWFiaWxpdGllczogW21pYSgiU3R1ZGVudCBMb2FucyIsIDIyZTMpLCBtaWEoIkNyZWRpdCBDYXJkIEJhbGFuY2UiLCA0NTAwKSwgbWlhKCJDYXIgTG9hbiIsIDE1ZTMpXSwKICAgICAgbm9uTGlxdWlkRGlzY291bnQ6IDMwCiAgICB9CiAgfSwKICB7CiAgICAvLyBGYW1pbHk6IGR1YWwgaW5jb21lLCAzNS01NCwgY29tYmluZWQgfiQ5NGsgcHJlLXRheCDihpIgfiQ2LDUwMC9tbyBhZnRlciB0YXgKICAgIGtleTogImZhbWlseSIsCiAgICBsYWJlbDogIkZhbWlseSIsCiAgICBlbW9qaTogIlx1ezFGNDY4fVx1MjAwRFx1ezFGNDY5fVx1MjAwRFx1ezFGNDY3fVx1MjAwRFx1ezFGNDY2fSIsCiAgICBkZXNjOiAiRHVhbCBpbmNvbWUsIGtpZHMsIGhvbWUgb3duZXJzaGlwIiwKICAgIGJ1ZGdldDogewogICAgICBuYW1lOiAiRmFtaWx5IEJ1ZGdldCIsCiAgICAgIGluY29tZTogW21pKCJTYWxhcnkgKFByaW1hcnkpIiwgNGUzKSwgbWkoIlNhbGFyeSAoU3BvdXNlKSIsIDMyMDApLCBtaSgiQ2hpbGQgVGF4IENyZWRpdCIsIDI1MCldLAogICAgICBleHBlbnNlczogW21pKCJNb3J0Z2FnZSIsIDIxMDApLCBtaSgiUHJvcGVydHkgVGF4IiwgNDgwMCwgInllYXJseSIpLCBtaSgiSG9tZW93bmVyJ3MgSW5zdXJhbmNlIiwgMTgwMCwgInllYXJseSIpLCBtaSgiR3JvY2VyaWVzIiwgNzAwKSwgbWkoIlV0aWxpdGllcyIsIDM4MCksIG1pKCJDaGlsZGNhcmUgLyBEYXljYXJlIiwgMTIwMCksIG1pKCJLaWRzIEFjdGl2aXRpZXMiLCAxNTApLCBtaSgiQ2FyIFBheW1lbnQiLCA1NTApLCBtaSgiQ2FyIEluc3VyYW5jZSIsIDIwMCksIG1pKCJHYXMiLCAxODApLCBtaSgiUGhvbmUgUGxhbnMiLCAxNDApLCBtaSgiSW50ZXJuZXQiLCA3NSksIG1pKCJTdHJlYW1pbmciLCA1MCksIG1pKCJEaW5pbmcgT3V0IiwgMjUwKSwgbWkoIkNsb3RoaW5nIiwgMTcwKSwgbWkoIk1lZGljYWwgLyBDb3BheXMiLCAxMDApLCBtaSgiU2Nob29sIFN1cHBsaWVzIiwgNTApXSwKICAgICAgYXNzZXRzOiBbbWlhKCJDaGVja2luZyBBY2NvdW50IiwgNmUzKSwgbWlhKCJKb2ludCBTYXZpbmdzIiwgMjVlMyksIG1pYSgiNTI5IENvbGxlZ2UgRnVuZCIsIDE4ZTMpLCBtaWEoIkJyb2tlcmFnZSBBY2NvdW50IiwgM2U0KV0sCiAgICAgIG5vbkxpcXVpZEFzc2V0czogW21pYSgiSG9tZSBFcXVpdHkiLCAxMmU0KSwgbWlhKCJDYXIgKFByaW1hcnkpIiwgMjJlMyksIG1pYSgiQ2FyIChTcG91c2UpIiwgMTVlMyldLAogICAgICByZXRpcmVtZW50OiBbbWlhKCI0MDFrIChQcmltYXJ5KSIsIDY1ZTMpLCBtaWEoIjQwMWsgKFNwb3VzZSkiLCA0ZTQpLCBtaWEoIlJvdGggSVJBIiwgMTVlMyldLAogICAgICBsaWFiaWxpdGllczogW21pYSgiTW9ydGdhZ2UgQmFsYW5jZSIsIDI4ZTQpLCBtaWEoIkNhciBMb2FuIiwgMThlMyksIG1pYSgiQ3JlZGl0IENhcmQiLCA2ZTMpLCBtaWEoIk1lZGljYWwgQmlsbHMiLCAyZTMpXSwKICAgICAgbm9uTGlxdWlkRGlzY291bnQ6IDIwCiAgICB9CiAgfSwKICB7CiAgICAvLyBSZXRpcmVlOiA2NSssIGF2ZyBTUyB+JDEsOTA3L21vLCBzcGVuZGluZyB+JDQsNjAwL21vCiAgICBrZXk6ICJyZXRpcmVlIiwKICAgIGxhYmVsOiAiUmV0aXJlZSIsCiAgICBlbW9qaTogIlx1ezFGM0Q2fVx1RkUwRiIsCiAgICBkZXNjOiAiRml4ZWQgaW5jb21lLCBsb3cgZGVidCwgZW5qb3lpbmcgbGlmZSIsCiAgICBidWRnZXQ6IHsKICAgICAgbmFtZTogIlJldGlyZWUgQnVkZ2V0IiwKICAgICAgaW5jb21lOiBbbWkoIlNvY2lhbCBTZWN1cml0eSIsIDE5MDApLCBtaSgiUGVuc2lvbiIsIDE1MDApLCBtaSgiUmV0aXJlbWVudCBXaXRoZHJhd2FscyIsIDEyMDApLCBtaSgiUmVudGFsIEluY29tZSIsIDgwMCldLAogICAgICBleHBlbnNlczogW21pKCJNb3J0Z2FnZSAvIFJlbnQiLCAxMjAwKSwgbWkoIlV0aWxpdGllcyIsIDMwMCksIG1pKCJHcm9jZXJpZXMiLCA1MDApLCBtaSgiTWVkaWNhcmUgLyBIZWFsdGggSW5zdXJhbmNlIiwgMzQwKSwgbWkoIlByZXNjcmlwdGlvbnMiLCAxNTApLCBtaSgiQ2FyIEluc3VyYW5jZSIsIDEyMCksIG1pKCJHYXMiLCAxMDApLCBtaSgiUGhvbmUiLCA2MCksIG1pKCJJbnRlcm5ldCAvIENhYmxlIiwgOTApLCBtaSgiRGluaW5nIE91dCIsIDIwMCksIG1pKCJUcmF2ZWwgLyBWYWNhdGlvbnMiLCAzMDApLCBtaSgiSG9iYmllcyIsIDEwMCksIG1pKCJHaWZ0cyAvIERvbmF0aW9ucyIsIDE1MCldLAogICAgICBhc3NldHM6IFttaWEoIkNoZWNraW5nIEFjY291bnQiLCA4ZTMpLCBtaWEoIlNhdmluZ3MgQWNjb3VudCIsIDQ1ZTMpLCBtaWEoIkNEcyAvIEJvbmRzIiwgNWU0KSwgbWlhKCJCcm9rZXJhZ2UgQWNjb3VudCIsIDhlNCldLAogICAgICBub25MaXF1aWRBc3NldHM6IFttaWEoIkhvbWUiLCAzZTUpLCBtaWEoIkNhciIsIDE1ZTMpLCBtaWEoIkpld2VscnkgLyBDb2xsZWN0aWJsZXMiLCAxZTQpXSwKICAgICAgcmV0aXJlbWVudDogW21pYSgiNDAxayAvIElSQSIsIDI1ZTQpLCBtaWEoIlBlbnNpb24gRnVuZCIsIDE1ZTQpLCBtaWEoIkFubnVpdHkiLCA3NWUzKV0sCiAgICAgIGxpYWJpbGl0aWVzOiBbbWlhKCJNb3J0Z2FnZSBCYWxhbmNlIiwgODVlMyksIG1pYSgiTWVkaWNhbCBCaWxscyIsIDNlMyldLAogICAgICBub25MaXF1aWREaXNjb3VudDogMjAKICAgIH0KICB9Cl07CnZhciBtaWdyYXRlSXRlbSA9IChpdGVtKSA9PiB7CiAgaWYgKGl0ZW0uYW1vdW50ICE9PSB2b2lkIDAgJiYgaXRlbS5mcmVxdWVuY3kgIT09IHZvaWQgMCkgcmV0dXJuIGl0ZW07CiAgaWYgKGl0ZW0ubW9udGhseVZhbHVlICYmIGl0ZW0ubW9udGhseVZhbHVlID4gMCkgewogICAgcmV0dXJuIHsgLi4uaXRlbSwgYW1vdW50OiBpdGVtLm1vbnRobHlWYWx1ZSwgZnJlcXVlbmN5OiAibW9udGhseSIgfTsKICB9CiAgcmV0dXJuIHsgLi4uaXRlbSwgYW1vdW50OiBpdGVtLnRvdGFsVmFsdWUgfHwgMCwgZnJlcXVlbmN5OiAib25lX3RpbWUiIH07Cn07CnZhciBtaWdyYXRlQnVkZ2V0ID0gKGIpID0+ICh7CiAgLi4uYiwKICBpbmNvbWU6IChiLmluY29tZSB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBleHBlbnNlczogKGIuZXhwZW5zZXMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgYXNzZXRzOiAoYi5hc3NldHMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgbm9uTGlxdWlkQXNzZXRzOiAoYi5ub25MaXF1aWRBc3NldHMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgcmV0aXJlbWVudDogKGIucmV0aXJlbWVudCB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBsaWFiaWxpdGllczogKGIubGlhYmlsaXRpZXMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSkKfSk7CnZhciBsb2FkQnVkZ2V0cyA9ICgpID0+IHsKICB0cnkgewogICAgY29uc3QgZGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEJVREdFVFNfTElTVF9LRVkpOwogICAgaWYgKGRhdGEpIHJldHVybiBKU09OLnBhcnNlKGRhdGEpLm1hcChtaWdyYXRlQnVkZ2V0KTsKICB9IGNhdGNoIHsKICB9CiAgcmV0dXJuIFtdOwp9Owp2YXIgc2F2ZUJ1ZGdldHMgPSAoYnVkZ2V0cykgPT4gewogIHRyeSB7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShCVURHRVRTX0xJU1RfS0VZLCBKU09OLnN0cmluZ2lmeShidWRnZXRzKSk7CiAgfSBjYXRjaCB7CiAgfQp9Owp2YXIgbG9hZEN1cnJlbnRCdWRnZXQgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IGRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVE9SQUdFX0tFWSk7CiAgICBpZiAoZGF0YSkgcmV0dXJuIG1pZ3JhdGVCdWRnZXQoSlNPTi5wYXJzZShkYXRhKSk7CiAgfSBjYXRjaCB7CiAgfQogIHJldHVybiBudWxsOwp9Owp2YXIgc2F2ZUN1cnJlbnRCdWRnZXQgPSAoYnVkZ2V0KSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeShidWRnZXQpKTsKICB9IGNhdGNoIHsKICB9Cn07CnZhciBQUkVTRVRTID0gewogIGluY29tZTogWwogICAgeyBuYW1lOiAiV29yayBTYWxhcnkiLCBlbW9qaTogIlx1ezFGNEJDfSIgfSwKICAgIHsgbmFtZTogIkZyZWVsYW5jZSBJbmNvbWUiLCBlbW9qaTogIlx1ezFGNEJCfSIgfSwKICAgIHsgbmFtZTogIlJlbnRhbCBJbmNvbWUiLCBlbW9qaTogIlx1ezFGM0UwfSIgfSwKICAgIHsgbmFtZTogIkludmVzdG1lbnQgRGl2aWRlbmRzIiwgZW1vamk6ICJcdXsxRjRDOH0iIH0sCiAgICB7IG5hbWU6ICJHb3Zlcm5tZW50IEJlbmVmaXRzIiwgZW1vamk6ICJcdXsxRjNEQn1cdUZFMEYiIH0sCiAgICB7IG5hbWU6ICJTaWRlIEJ1c2luZXNzIiwgZW1vamk6ICJcdXsxRjNFQX0iIH0sCiAgICB7IG5hbWU6ICJQZW5zaW9uIiwgZW1vamk6ICJcdXsxRjlEM30iIH0KICBdLAogIGV4cGVuc2VzOiBbCiAgICB7IG5hbWU6ICJSZW50IiwgZW1vamk6ICJcdXsxRjNFMH0iIH0sCiAgICB7IG5hbWU6ICJNb3J0Z2FnZSBQYXltZW50IiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJVdGlsaXRpZXMiLCBlbW9qaTogIlx1ezFGNEExfSIgfSwKICAgIHsgbmFtZTogIkdyb2NlcmllcyIsIGVtb2ppOiAiXHV7MUY2RDJ9IiB9LAogICAgeyBuYW1lOiAiQ2FyIFBheW1lbnQiLCBlbW9qaTogIlx1ezFGNjk3fSIgfSwKICAgIHsgbmFtZTogIkluc3VyYW5jZSIsIGVtb2ppOiAiXHV7MUY2RTF9XHVGRTBGIiB9LAogICAgeyBuYW1lOiAiU3Vic2NyaXB0aW9ucyIsIGVtb2ppOiAiXHV7MUY0RkF9IiB9LAogICAgeyBuYW1lOiAiUGhvbmUgQmlsbCIsIGVtb2ppOiAiXHV7MUY0RjF9IiB9LAogICAgeyBuYW1lOiAiSW50ZXJuZXQiLCBlbW9qaTogIlx1ezFGMzEwfSIgfSwKICAgIHsgbmFtZTogIkdhcy9UcmFuc3BvcnRhdGlvbiIsIGVtb2ppOiAiXHUyNkZEIiB9CiAgXSwKICBhc3NldHM6IFsKICAgIHsgbmFtZTogIkNoZWNraW5nIEFjY291bnQiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIlNhdmluZ3MgQWNjb3VudCIsIGVtb2ppOiAiXHV7MUY0QjB9IiB9LAogICAgeyBuYW1lOiAiU3RvY2tzL0Jyb2tlcmFnZSIsIGVtb2ppOiAiXHV7MUY0Q0F9IiwgcGVyc2lzdGVudDogdHJ1ZSwgYXNzZXRUeXBlOiAic3RvY2siIH0sCiAgICB7IG5hbWU6ICJDcnlwdG8iLCBlbW9qaTogIlx1MjBCRiIgfSwKICAgIHsgbmFtZTogIjQwMWsvUmV0aXJlbWVudCIsIGVtb2ppOiAiXHV7MUY5RDN9IiB9LAogICAgeyBuYW1lOiAiRW1lcmdlbmN5IEZ1bmQiLCBlbW9qaTogIlx1ezFGMTk4fSIgfSwKICAgIHsgbmFtZTogIkNEL0JvbmRzIiwgZW1vamk6ICJcdXsxRjREQ30iIH0KICBdLAogIG5vbkxpcXVpZEFzc2V0czogWwogICAgeyBuYW1lOiAiSG9tZSBWYWx1ZSIsIGVtb2ppOiAiXHV7MUYzRTF9IiB9LAogICAgeyBuYW1lOiAiQ2FyIFZhbHVlIiwgZW1vamk6ICJcdXsxRjY5N30iIH0sCiAgICB7IG5hbWU6ICJKZXdlbHJ5L1dhdGNoZXMiLCBlbW9qaTogIlx1ezFGNDhFfSIgfSwKICAgIHsgbmFtZTogIkFydC9Db2xsZWN0aWJsZXMiLCBlbW9qaTogIlx1ezFGM0E4fSIgfSwKICAgIHsgbmFtZTogIkJ1c2luZXNzIEVxdWl0eSIsIGVtb2ppOiAiXHV7MUYzRTJ9IiB9LAogICAgeyBuYW1lOiAiRnVybml0dXJlL0VsZWN0cm9uaWNzIiwgZW1vamk6ICJcdXsxRkE5MX0iIH0KICBdLAogIHJldGlyZW1lbnQ6IFsKICAgIHsgbmFtZTogIjQwMWsiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIlJvdGggSVJBIiwgZW1vamk6ICJcdXsxRjRDQX0iIH0sCiAgICB7IG5hbWU6ICJUcmFkaXRpb25hbCBJUkEiLCBlbW9qaTogIlx1ezFGNEM4fSIgfSwKICAgIHsgbmFtZTogIlBlbnNpb24gRnVuZCIsIGVtb2ppOiAiXHV7MUY5RDN9IiB9LAogICAgeyBuYW1lOiAiU0VQIElSQSIsIGVtb2ppOiAiXHV7MUY0QkN9IiB9LAogICAgeyBuYW1lOiAiNDAzYiIsIGVtb2ppOiAiXHV7MUYzRUJ9IiB9CiAgXSwKICBsaWFiaWxpdGllczogWwogICAgeyBuYW1lOiAiTW9ydGdhZ2UiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIkNhciBMb2FuIiwgZW1vamk6ICJcdXsxRjY5N30iIH0sCiAgICB7IG5hbWU6ICJTdHVkZW50IExvYW5zIiwgZW1vamk6ICJcdXsxRjM5M30iIH0sCiAgICB7IG5hbWU6ICJDcmVkaXQgQ2FyZCBEZWJ0IiwgZW1vamk6ICJcdXsxRjRCM30iIH0sCiAgICB7IG5hbWU6ICJQZXJzb25hbCBMb2FuIiwgZW1vamk6ICJcdXsxRjkxRH0iIH0sCiAgICB7IG5hbWU6ICJNZWRpY2FsIERlYnQiLCBlbW9qaTogIlx1ezFGM0U1fSIgfSwKICAgIHsgbmFtZTogIlBlcnNvbmFsIEV4cGVuc2VzIiwgZW1vamk6ICJcdXsxRjZDRH1cdUZFMEYiIH0KICBdCn07CnZhciBTZWN0aW9uSGVhZGVyID0gKHsgdGl0bGUsIGljb24sIGNvbG9yOiBjb2xvcjIsIGJnQ29sb3IsIHRvdGFsLCBtb250aGx5VG90YWwsIGNvdW50LCBpc09wZW4sIG9uVG9nZ2xlIH0pID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IG9uVG9nZ2xlLCBzdHlsZTogewogIHdpZHRoOiAiMTAwJSIsCiAgZGlzcGxheTogImZsZXgiLAogIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsCiAgcGFkZGluZzogIjE0cHggMTZweCIsCiAgYm9yZGVyOiAibm9uZSIsCiAgYm9yZGVyUmFkaXVzOiAxMiwKICBjdXJzb3I6ICJwb2ludGVyIiwKICBiYWNrZ3JvdW5kQ29sb3I6IGJnQ29sb3IsCiAgdHJhbnNpdGlvbjogImFsbCAwLjJzIgp9LCBjaGlsZHJlbjogWwogIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTAgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDM2LCBoZWlnaHQ6IDM2LCBib3JkZXJSYWRpdXM6IDEwLCBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yMiwgY29sb3I6ICJ3aGl0ZSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LCBjaGlsZHJlbjogaWNvbiB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogImxlZnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IHRpdGxlIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgIGNvdW50LAogICAgICAgICIgaXRlbSIsCiAgICAgICAgY291bnQgIT09IDEgPyAicyIgOiAiIgogICAgICBdIH0pCiAgICBdIH0pCiAgXSB9KSwKICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJyaWdodCIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogZm10KHRvdGFsKSB9KSwKICAgICAgbW9udGhseVRvdGFsICE9PSB2b2lkIDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICBmbXQobW9udGhseVRvdGFsKSwKICAgICAgICAiL21vIgogICAgICBdIH0pCiAgICBdIH0pLAogICAgaXNPcGVuID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGV2cm9uVXAsIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hldnJvbkRvd24sIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9KQogIF0gfSkKXSB9KTsKdmFyIENvaW5TZWFyY2hEcm9wZG93biA9ICh7IG9uU2VsZWN0LCBpbnB1dFN0eWxlIH0pID0+IHsKICBjb25zdCBbcXVlcnksIHNldFF1ZXJ5XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtyZXN1bHRzLCBzZXRSZXN1bHRzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoW10pOwogIGNvbnN0IFtsb2FkaW5nLCBzZXRMb2FkaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtzaG93RHJvcGRvd24sIHNldFNob3dEcm9wZG93bl0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCB0aW1lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VSZWYpKG51bGwpOwogIGNvbnN0IGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VFZmZlY3QpKCgpID0+IHsKICAgIGNvbnN0IGhhbmRsZUNsaWNrT3V0c2lkZSA9IChlKSA9PiB7CiAgICAgIGlmIChjb250YWluZXJSZWYuY3VycmVudCAmJiAhY29udGFpbmVyUmVmLmN1cnJlbnQuY29udGFpbnMoZS50YXJnZXQpKSBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgfTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIGhhbmRsZUNsaWNrT3V0c2lkZSk7CiAgICByZXR1cm4gKCkgPT4gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgaGFuZGxlQ2xpY2tPdXRzaWRlKTsKICB9LCBbXSk7CiAgY29uc3QgaGFuZGxlU2VhcmNoID0gKHZhbCkgPT4gewogICAgc2V0UXVlcnkodmFsKTsKICAgIGlmICh0aW1lclJlZi5jdXJyZW50KSBjbGVhclRpbWVvdXQodGltZXJSZWYuY3VycmVudCk7CiAgICBpZiAodmFsLmxlbmd0aCA8IDIpIHsKICAgICAgc2V0UmVzdWx0cyhbXSk7CiAgICAgIHNldFNob3dEcm9wZG93bihmYWxzZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldExvYWRpbmcodHJ1ZSk7CiAgICB0aW1lclJlZi5jdXJyZW50ID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGNvaW5zID0gYXdhaXQgc2VhcmNoQ29pbnModmFsKTsKICAgICAgc2V0UmVzdWx0cyhjb2lucyk7CiAgICAgIHNldFNob3dEcm9wZG93bihjb2lucy5sZW5ndGggPiAwKTsKICAgICAgc2V0TG9hZGluZyhmYWxzZSk7CiAgICB9LCAzMDApOwogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHJlZjogY29udGFpbmVyUmVmLCBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTZWFyY2gsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBsZWZ0OiA4LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAiaW5wdXQiLAogICAgICAgIHsKICAgICAgICAgIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHBhZGRpbmdMZWZ0OiAyOCB9LAogICAgICAgICAgdmFsdWU6IHF1ZXJ5LAogICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBoYW5kbGVTZWFyY2goZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgb25Gb2N1czogKCkgPT4gewogICAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAwKSBzZXRTaG93RHJvcGRvd24odHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgcGxhY2Vob2xkZXI6ICJTZWFyY2ggY3J5cHRvIChlLmcuIGJpdGNvaW4pIgogICAgICAgIH0KICAgICAgKSwKICAgICAgbG9hZGluZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKExvYWRlckNpcmNsZSwgeyBzaXplOiAxNCwgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHJpZ2h0OiA4LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGFuaW1hdGlvbjogInNwaW4gMXMgbGluZWFyIGluZmluaXRlIiB9IH0pCiAgICBdIH0pLAogICAgc2hvd0Ryb3Bkb3duICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogIjEwMCUiLAogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgekluZGV4OiA1MCwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwKICAgICAgbWF4SGVpZ2h0OiAyMDAsCiAgICAgIG92ZXJmbG93WTogImF1dG8iLAogICAgICBtYXJnaW5Ub3A6IDIKICAgIH0sIGNoaWxkcmVuOiByZXN1bHRzLm1hcCgoY29pbikgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICJidXR0b24iLAogICAgICB7CiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgb25TZWxlY3QoY29pbik7CiAgICAgICAgICBzZXRRdWVyeSgiIik7CiAgICAgICAgICBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgICAgICAgc2V0UmVzdWx0cyhbXSk7CiAgICAgICAgfSwKICAgICAgICBzdHlsZTogewogICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICB0ZXh0QWxpZ246ICJsZWZ0IiwKICAgICAgICAgIGZvbnRTaXplOiAxMywKICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sCiAgICAgICAgICBib3JkZXJCb3R0b206IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YAogICAgICAgIH0sCiAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5hc3NldEJnOwogICAgICAgIH0sCiAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW1nIiwgeyBzcmM6IGNvaW4udGh1bWIsIGFsdDogIiIsIHN0eWxlOiB7IHdpZHRoOiAyMCwgaGVpZ2h0OiAyMCwgYm9yZGVyUmFkaXVzOiAxMCB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiBjb2luLm5hbWUgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgZm9udFNpemU6IDExLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogY29pbi5zeW1ib2wgfSkKICAgICAgICBdCiAgICAgIH0sCiAgICAgIGNvaW4uaWQKICAgICkpIH0pCiAgXSB9KTsKfTsKdmFyIFN0b2NrVGlja2VySW5wdXQgPSAoeyBkcmFmdCwgc2V0RHJhZnQsIGlucHV0U3R5bGUsIGNvbG9yOiBjb2xvcjIgfSkgPT4gewogIGNvbnN0IFtmZXRjaGluZywgc2V0RmV0Y2hpbmddID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3RpY2tlcklucHV0LCBzZXRUaWNrZXJJbnB1dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGRyYWZ0LnRpY2tlciB8fCAiIik7CiAgY29uc3QgW3ByaWNlSW5wdXQsIHNldFByaWNlSW5wdXRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShkcmFmdC5saXZlUHJpY2UgPyBTdHJpbmcoZHJhZnQubGl2ZVByaWNlKSA6ICIiKTsKICBjb25zdCBkZWJvdW5jZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VSZWYpKG51bGwpOwogIGNvbnN0IHJlY2FsY0Ftb3VudCA9IChwcmljZSwgcXR5KSA9PiBNYXRoLnJvdW5kKHByaWNlICogcXR5ICogMTAwKSAvIDEwMDsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoZGVib3VuY2VSZWYuY3VycmVudCkgY2xlYXJUaW1lb3V0KGRlYm91bmNlUmVmLmN1cnJlbnQpOwogICAgY29uc3Qgc3ltYm9sID0gdGlja2VySW5wdXQudHJpbSgpOwogICAgaWYgKHN5bWJvbC5sZW5ndGggPCAxKSB7CiAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCB0aWNrZXI6IHZvaWQgMCwgbGl2ZVByaWNlOiB2b2lkIDAsIG5hbWU6ICIiIH0pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHRpY2tlcjogc3ltYm9sLCBuYW1lOiBzeW1ib2wgfSkpOwogICAgaWYgKHN5bWJvbC5sZW5ndGggPCAyKSByZXR1cm47CiAgICBkZWJvdW5jZVJlZi5jdXJyZW50ID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgIHNldEZldGNoaW5nKHRydWUpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHByaWNlcyA9IGF3YWl0IGZldGNoU3RvY2tQcmljZXMoW3N5bWJvbF0pOwogICAgICAgIGlmIChwcmljZXNbc3ltYm9sXSkgewogICAgICAgICAgY29uc3QgcHJpY2UgPSBwcmljZXNbc3ltYm9sXTsKICAgICAgICAgIHNldFByaWNlSW5wdXQoU3RyaW5nKHByaWNlKSk7CiAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBkLnF1YW50aXR5ID8gcmVjYWxjQW1vdW50KHByaWNlLCBkLnF1YW50aXR5KSA6IHByaWNlOwogICAgICAgICAgICByZXR1cm4geyAuLi5kLCBsaXZlUHJpY2U6IHByaWNlLCBhbW91bnQ6IG5ld0Ftb3VudCB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIHsKICAgICAgfQogICAgICBzZXRGZXRjaGluZyhmYWxzZSk7CiAgICB9LCA2MDApOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKGRlYm91bmNlUmVmLmN1cnJlbnQpIGNsZWFyVGltZW91dChkZWJvdW5jZVJlZi5jdXJyZW50KTsKICAgIH07CiAgfSwgW3RpY2tlcklucHV0XSk7CiAgY29uc3QgaGFzVGlja2VyID0gdGlja2VySW5wdXQudHJpbSgpLmxlbmd0aCA+PSAxOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlRpY2tlciBTeW1ib2wiIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgImlucHV0IiwKICAgICAgewogICAgICAgIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiIH0sCiAgICAgICAgdmFsdWU6IHRpY2tlcklucHV0LAogICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0VGlja2VySW5wdXQoZS50YXJnZXQudmFsdWUudG9VcHBlckNhc2UoKS5yZXBsYWNlKC9bXkEtWi5dL2csICIiKSksCiAgICAgICAgcGxhY2Vob2xkZXI6ICJlLmcuIEFBUEwsIFRTTEEsIFZPTyIsCiAgICAgICAgYXV0b0ZvY3VzOiB0cnVlCiAgICAgIH0KICAgICksCiAgICBmZXRjaGluZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiAiIzI1NjNFQiIsIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAiTG9va2luZyB1cCAiLAogICAgICB0aWNrZXJJbnB1dCwKICAgICAgIi4uLiIKICAgIF0gfSksCiAgICBoYXNUaWNrZXIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogOCwgbWFyZ2luVG9wOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUHJpY2UgLyBTaGFyZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBpbnB1dFN0eWxlLAogICAgICAgICAgICB0eXBlOiAibnVtYmVyIiwKICAgICAgICAgICAgc3RlcDogImFueSIsCiAgICAgICAgICAgIHZhbHVlOiBwcmljZUlucHV0LAogICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHsKICAgICAgICAgICAgICBzZXRQcmljZUlucHV0KGUudGFyZ2V0LnZhbHVlKTsKICAgICAgICAgICAgICBjb25zdCBwcmljZSA9IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDA7CiAgICAgICAgICAgICAgY29uc3QgcXR5ID0gZHJhZnQucXVhbnRpdHkgfHwgMDsKICAgICAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgbGl2ZVByaWNlOiBwcmljZSB8fCB2b2lkIDAsIGFtb3VudDogcXR5ID4gMCAmJiBwcmljZSA+IDAgPyByZWNhbGNBbW91bnQocHJpY2UsIHF0eSkgOiBwcmljZSB9KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiJDAuMDAiCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlNoYXJlcyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBpbnB1dFN0eWxlLAogICAgICAgICAgICB0eXBlOiAibnVtYmVyIiwKICAgICAgICAgICAgc3RlcDogImFueSIsCiAgICAgICAgICAgIHZhbHVlOiBkcmFmdC5xdWFudGl0eSB8fCAiIiwKICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgcXR5ID0gcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMDsKICAgICAgICAgICAgICBjb25zdCBwcmljZSA9IHBhcnNlRmxvYXQocHJpY2VJbnB1dCkgfHwgMDsKICAgICAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBxdHkgPiAwICYmIHByaWNlID4gMCA/IHJlY2FsY0Ftb3VudChwcmljZSwgcXR5KSA6IGRyYWZ0LmFtb3VudDsKICAgICAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgcXVhbnRpdHk6IHF0eSB8fCB2b2lkIDAsIGFtb3VudDogbmV3QW1vdW50IH0pKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJRdHkiCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pCiAgICBdIH0pLAogICAgaGFzVGlja2VyICYmIGRyYWZ0LmxpdmVQcmljZSAmJiBkcmFmdC5xdWFudGl0eSAmJiBkcmFmdC5xdWFudGl0eSA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNiwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBwYWRkaW5nOiAiNnB4IDEwcHgiLCBiYWNrZ3JvdW5kQ29sb3I6ICIjMjU2M0VCMTAiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogIjFweCBzb2xpZCAjMjU2M0VCMzAiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICJcdXsxRjRDOH0gIiwKICAgICAgICBkcmFmdC50aWNrZXIsCiAgICAgICAgIiBceEQ3ICIsCiAgICAgICAgZHJhZnQucXVhbnRpdHkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogZm10KGRyYWZ0LmFtb3VudCkgfSkgfSkKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgSXRlbVJvdyA9ICh7IGl0ZW0sIG9uVXBkYXRlLCBvbkRlbGV0ZSwgaW5wdXRNb2RlLCBjb2xvcjogY29sb3IyIH0pID0+IHsKICBjb25zdCBpc05ldyA9ICFpdGVtLmFtb3VudDsKICBjb25zdCBbZWRpdGluZywgc2V0RWRpdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGlzTmV3KTsKICBjb25zdCBbZHJhZnQsIHNldERyYWZ0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoaXRlbSk7CiAgKDAsIGltcG9ydF9yZWFjdDUxLnVzZUVmZmVjdCkoKCkgPT4gewogICAgc2V0RHJhZnQoaXRlbSk7CiAgfSwgW2l0ZW1dKTsKICBjb25zdCBzYXZlID0gKCkgPT4gewogICAgY29uc3QgZnJlcSA9IGRyYWZ0LmZyZXF1ZW5jeSB8fCAoaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiA/ICJtb250aGx5IiA6ICJvbmVfdGltZSIpOwogICAgbGV0IGFtb3VudCA9IGRyYWZ0LmFtb3VudDsKICAgIGlmICgoZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIpICYmIGRyYWZ0LnRpY2tlciAmJiBkcmFmdC5saXZlUHJpY2UgJiYgZHJhZnQucXVhbnRpdHkpIHsKICAgICAgYW1vdW50ID0gTWF0aC5yb3VuZChkcmFmdC5saXZlUHJpY2UgKiBkcmFmdC5xdWFudGl0eSAqIDEwMCkgLyAxMDA7CiAgICB9CiAgICBjb25zdCBjb21wdXRlZCA9IGNvbXB1dGVWYWx1ZXMoYW1vdW50LCBmcmVxKTsKICAgIG9uVXBkYXRlKHsgLi4uZHJhZnQsIGFtb3VudCwgZnJlcXVlbmN5OiBmcmVxLCAuLi5jb21wdXRlZCB9KTsKICAgIHNldEVkaXRpbmcoZmFsc2UpOwogIH07CiAgY29uc3QgaW5wdXRTdHlsZSA9IHsKICAgIHBhZGRpbmc6ICI4cHggMTBweCIsCiAgICBib3JkZXJSYWRpdXM6IDgsCiAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICBmb250U2l6ZTogMTMsCiAgICB3aWR0aDogIjEwMCUiLAogICAgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsCiAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIsCiAgICBvdXRsaW5lOiAibm9uZSIKICB9OwogIGNvbnN0IHNlbGVjdFN0eWxlID0gewogICAgLi4uaW5wdXRTdHlsZSwKICAgIGFwcGVhcmFuY2U6ICJub25lIiwKICAgIGJhY2tncm91bmRJbWFnZTogYHVybCgiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMicgaGVpZ2h0PScxMicgdmlld0JveD0nMCAwIDI0IDI0JyBmaWxsPSdub25lJyBzdHJva2U9JyUyMzlDQTNBRicgc3Ryb2tlLXdpZHRoPScyJyUzRSUzQ3BhdGggZD0nTTYgOWw2IDYgNi02Jy8lM0UlM0Mvc3ZnJTNFIilgLAogICAgYmFja2dyb3VuZFJlcGVhdDogIm5vLXJlcGVhdCIsCiAgICBiYWNrZ3JvdW5kUG9zaXRpb246ICJyaWdodCA4cHggY2VudGVyIiwKICAgIHBhZGRpbmdSaWdodDogMjQKICB9OwogIGNvbnN0IGZyZXFMYWJlbCA9IChmKSA9PiBmID09PSAibW9udGhseSIgPyAiL21vIiA6IGYgPT09ICJ5ZWFybHkiID8gIi95ciIgOiAiIjsKICBjb25zdCBoYW5kbGVDb2luU2VsZWN0ID0gYXN5bmMgKGNvaW4pID0+IHsKICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBuYW1lOiBjb2luLm5hbWUsIGFzc2V0VHlwZTogImNyeXB0byIsIHRpY2tlcjogY29pbi5pZCB9KSk7CiAgICB0cnkgewogICAgICBjb25zdCBwcmljZXMgPSBhd2FpdCBmZXRjaENyeXB0b1ByaWNlcyhbY29pbi5pZF0pOwogICAgICBpZiAocHJpY2VzW2NvaW4uaWRdKSB7CiAgICAgICAgc2V0RHJhZnQoKGQpID0+IHsKICAgICAgICAgIGNvbnN0IHByaWNlID0gcHJpY2VzW2NvaW4uaWRdOwogICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gZC5xdWFudGl0eSA/IE1hdGgucm91bmQocHJpY2UgKiBkLnF1YW50aXR5ICogMTAwKSAvIDEwMCA6IGQuYW1vdW50OwogICAgICAgICAgcmV0dXJuIHsgLi4uZCwgbGl2ZVByaWNlOiBwcmljZSwgYW1vdW50OiBuZXdBbW91bnQgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICB9CiAgfTsKICBpZiAoZWRpdGluZykgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxMHB4IDEycHgiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBib3JkZXJSYWRpdXM6IDEwLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogWwogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDYsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIGFzc2V0VHlwZTogImNyeXB0byIgfSkpLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6ICI0cHggMTBweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke2RyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgPyAiI0Y3OTMxQSIgOiBDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iID8gIiNGNzkzMUExNSIgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iID8gIiNGNzkzMUEiIDogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogIlx1MjBCRiBDcnlwdG8iCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBhc3NldFR5cGU6ICJzdG9jayIsIHRpY2tlcjogdm9pZCAwLCBsaXZlUHJpY2U6IHZvaWQgMCB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7ZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siID8gIiMyNTYzRUIiIDogQ09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siID8gIiMyNTYzRUIxNSIgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIgPyAiIzI1NjNFQiIgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAiXHV7MUY0Qzh9IFN0b2NrIgogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgYXNzZXRUeXBlOiB2b2lkIDAsIHRpY2tlcjogdm9pZCAwLCBsaXZlUHJpY2U6IHZvaWQgMCB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7IWRyYWZ0LmFzc2V0VHlwZSB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJtYW51YWwiID8gY29sb3IyIDogQ09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIWRyYWZ0LmFzc2V0VHlwZSB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJtYW51YWwiID8gYCR7Y29sb3IyfTE1YCA6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgY29sb3I6ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIiA/IGNvbG9yMiA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxMSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46ICJNYW51YWwiCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiAmJiAhZHJhZnQudGlja2VyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlNlYXJjaCBDcnlwdG9jdXJyZW5jeSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDb2luU2VhcmNoRHJvcGRvd24sIHsgb25TZWxlY3Q6IGhhbmRsZUNvaW5TZWxlY3QsIGlucHV0U3R5bGUgfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmIGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgZHJhZnQudGlja2VyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiwgcGFkZGluZzogIjZweCAxMHB4IiwgYmFja2dyb3VuZENvbG9yOiAiI0Y3OTMxQTEwIiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICIxcHggc29saWQgI0Y3OTMxQTMwIiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiAiI0Y3OTMxQSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlx1MjBCRiAiLAogICAgICAgICAgICBkcmFmdC5uYW1lCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIigiLAogICAgICAgICAgICBkcmFmdC50aWNrZXIsCiAgICAgICAgICAgICIpIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHRpY2tlcjogdm9pZCAwLCBuYW1lOiAiIiwgbGl2ZVByaWNlOiB2b2lkIDAgfSkpLCBzdHlsZTogeyBtYXJnaW5MZWZ0OiAiYXV0byIsIHBhZGRpbmc6IDIsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFgsIHsgc2l6ZTogMTQgfSkgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUXVhbnRpdHkiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IHN0eWxlOiBpbnB1dFN0eWxlLCB0eXBlOiAibnVtYmVyIiwgc3RlcDogImFueSIsIHZhbHVlOiBkcmFmdC5xdWFudGl0eSB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHF0eSA9IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDA7CiAgICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IGRyYWZ0LmxpdmVQcmljZSA/IE1hdGgucm91bmQoZHJhZnQubGl2ZVByaWNlICogcXR5ICogMTAwKSAvIDEwMCA6IGRyYWZ0LmFtb3VudDsKICAgICAgICAgICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHF1YW50aXR5OiBxdHkgfHwgdm9pZCAwLCBhbW91bnQ6IG5ld0Ftb3VudCB9KSk7CiAgICAgICAgICB9LCBwbGFjZWhvbGRlcjogIkhvdyBtYW55PyIsIGF1dG9Gb2N1czogdHJ1ZSB9KQogICAgICAgIF0gfSksCiAgICAgICAgZHJhZnQubGl2ZVByaWNlID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlByaWNlOiAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiBmbXRQcmljZShkcmFmdC5saXZlUHJpY2UpIH0pLAogICAgICAgICAgICAiL3VuaXQiCiAgICAgICAgICBdIH0pLAogICAgICAgICAgZHJhZnQucXVhbnRpdHkgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlRvdGFsOiAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBjb2xvcjIgfSwgY2hpbGRyZW46IGZtdChkcmFmdC5saXZlUHJpY2UgKiBkcmFmdC5xdWFudGl0eSkgfSkKICAgICAgICAgIF0gfSkgOiBudWxsCiAgICAgICAgXSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiAiRmV0Y2hpbmcgcHJpY2UuLi4iIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTdG9ja1RpY2tlcklucHV0LCB7IGRyYWZ0LCBzZXREcmFmdCwgaW5wdXRTdHlsZSwgY29sb3I6IGNvbG9yMiB9KSwKICAgICAgKGlucHV0TW9kZSAhPT0gImFzc2V0IiB8fCAhZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIk5hbWUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZSwgdmFsdWU6IGRyYWZ0Lm5hbWUsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgbmFtZTogZS50YXJnZXQudmFsdWUgfSksIHBsYWNlaG9sZGVyOiAiRGVzY3JpcHRpb24iIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogOCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIkFtb3VudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgYXV0b0ZvY3VzOiAhIWRyYWZ0Lm5hbWUsIHN0eWxlOiBpbnB1dFN0eWxlLCB0eXBlOiAibnVtYmVyIiwgdmFsdWU6IGRyYWZ0LmFtb3VudCB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBhbW91bnQ6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDAgfSksIHBsYWNlaG9sZGVyOiAiJDAiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiRnJlcXVlbmN5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzZWxlY3QiLCB7IHN0eWxlOiBzZWxlY3RTdHlsZSwgdmFsdWU6IGRyYWZ0LmZyZXF1ZW5jeSB8fCAibW9udGhseSIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgZnJlcXVlbmN5OiBlLnRhcmdldC52YWx1ZSB9KSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIm1vbnRobHkiLCBjaGlsZHJlbjogIk1vbnRobHkiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAieWVhcmx5IiwgY2hpbGRyZW46ICJZZWFybHkiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAib25lX3RpbWUiLCBjaGlsZHJlbjogIk9uZS10aW1lIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmICghZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDgsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJWYWx1ZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgYXV0b0ZvY3VzOiAhIWRyYWZ0Lm5hbWUsIHN0eWxlOiBpbnB1dFN0eWxlLCB0eXBlOiAibnVtYmVyIiwgdmFsdWU6IGRyYWZ0LmFtb3VudCB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBhbW91bnQ6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDAgfSksIHBsYWNlaG9sZGVyOiAiJDAiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUXVhbnRpdHkgKG9wdGlvbmFsKSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgc3R5bGU6IGlucHV0U3R5bGUsIHR5cGU6ICJudW1iZXIiLCBzdGVwOiAiYW55IiwgdmFsdWU6IGRyYWZ0LnF1YW50aXR5IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIHF1YW50aXR5OiBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCB2b2lkIDAgfSksIHBsYWNlaG9sZGVyOiAiUXR5IiB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAidmFsdWVfb25seSIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiVmFsdWUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICEhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDYsIGp1c3RpZnlDb250ZW50OiAiZmxleC1lbmQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICBpZiAoIWl0ZW0ubmFtZSAmJiAhaXRlbS5hbW91bnQpIHsKICAgICAgICAgICAgb25EZWxldGUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldERyYWZ0KGl0ZW0pOwogICAgICAgICAgICBzZXRFZGl0aW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiAiNnB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJDYW5jZWwiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogc2F2ZSwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBjb2xvcjIsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJTYXZlIiB9KQogICAgICBdIH0pCiAgICBdIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgIHBhZGRpbmc6ICIxMHB4IDZweCAxMHB4IDRweCIsCiAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgbWFyZ2luQm90dG9tOiA0LAogICAgdHJhbnNpdGlvbjogImFsbCAwLjE1cyIKICB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjbGFzc05hbWU6ICJkcmFnLWhhbmRsZSIsIHN0eWxlOiB7IHBhZGRpbmc6ICI0cHggNHB4IiwgY3Vyc29yOiAiZ3JhYiIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiZmxleCIsIGZsZXhTaHJpbms6IDAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoR3JpcFZlcnRpY2FsLCB7IHNpemU6IDE2IH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgbWluV2lkdGg6IDAsIHBhZGRpbmdMZWZ0OiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNTAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBvdmVyZmxvdzogImhpZGRlbiIsIHRleHRPdmVyZmxvdzogImVsbGlwc2lzIiwgd2hpdGVTcGFjZTogIm5vd3JhcCIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgIGl0ZW0uYXNzZXRUeXBlID09PSAiY3J5cHRvIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiAiI0Y3OTMxQSIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogIlx1MjBCRiIgfSksCiAgICAgICAgaXRlbS5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogIiMyNTYzRUIiLCBmb250V2VpZ2h0OiA3MDAgfSwgY2hpbGRyZW46ICJcdXsxRjRDOH0iIH0pLAogICAgICAgIGl0ZW0ubmFtZSB8fCAiVW5uYW1lZCIKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46IFsKICAgICAgICBpdGVtLnF1YW50aXR5ICE9PSB2b2lkIDAgJiYgaXRlbS5xdWFudGl0eSA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAiUXR5OiAiLAogICAgICAgICAgaXRlbS5xdWFudGl0eQogICAgICAgIF0gfSksCiAgICAgICAgKGl0ZW0uYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCBpdGVtLmFzc2V0VHlwZSA9PT0gInN0b2NrIikgJiYgaXRlbS5saXZlUHJpY2UgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAiQCAiLAogICAgICAgICAgZm10UHJpY2UoaXRlbS5saXZlUHJpY2UpCiAgICAgICAgXSB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciICYmIGl0ZW0uZnJlcXVlbmN5ICE9PSAib25lX3RpbWUiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgZm10KGl0ZW0uYW1vdW50KSwKICAgICAgICAgIGZyZXFMYWJlbChpdGVtLmZyZXF1ZW5jeSkKICAgICAgICBdIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgaXRlbS5mcmVxdWVuY3kgPT09ICJ5ZWFybHkiICYmIGl0ZW0ubW9udGhseVZhbHVlID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICIoIiwKICAgICAgICAgIGZtdChpdGVtLm1vbnRobHlWYWx1ZSksCiAgICAgICAgICAiL21vKSIKICAgICAgICBdIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgaXRlbS5mcmVxdWVuY3kgPT09ICJtb250aGx5IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICIoIiwKICAgICAgICAgIGZtdChpdGVtLnRvdGFsVmFsdWUpLAogICAgICAgICAgIi95cikiCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBjb2xvcjIsIHdoaXRlU3BhY2U6ICJub3dyYXAiIH0sIGNoaWxkcmVuOiBmbXRFeGFjdChpdGVtLnRvdGFsVmFsdWUpIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldEVkaXRpbmcodHJ1ZSksIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFBlbiwgeyBzaXplOiAxNCB9KSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBvbkRlbGV0ZSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJhc2gyLCB7IHNpemU6IDE0IH0pIH0pCiAgICBdIH0pCiAgXSB9KTsKfTsKdmFyIEJ1ZGdldFNlY3Rpb24gPSAoeyB0aXRsZSwgaWNvbiwgY29sb3I6IGNvbG9yMiwgYmdDb2xvciwgaXRlbXMsIG9uVXBkYXRlLCBvbkFkZCwgb25BZGRQcmVzZXQsIG9uRGVsZXRlLCBvblJlb3JkZXIsIGlucHV0TW9kZSwgcHJlc2V0cywgZm9vdGVyIH0pID0+IHsKICBjb25zdCBbaXNPcGVuLCBzZXRJc09wZW5dID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2RyYWdJZHgsIHNldERyYWdJZHhdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbb3ZlcklkeCwgc2V0T3ZlcklkeF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IHRvdGFsID0gaXRlbXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICBjb25zdCBzaG93TW9udGhseSA9IGlucHV0TW9kZSA9PT0gInJlY3VycmluZyI7CiAgY29uc3QgbW9udGhseVRvdGFsID0gc2hvd01vbnRobHkgPyBpdGVtcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCkgOiB2b2lkIDA7CiAgY29uc3QgZXhpc3RpbmdOYW1lcyA9IG5ldyBTZXQoaXRlbXMubWFwKChpKSA9PiBpLm5hbWUudG9Mb3dlckNhc2UoKSkpOwogIGNvbnN0IGF2YWlsYWJsZVByZXNldHMgPSAocHJlc2V0cyB8fCBbXSkuZmlsdGVyKChwKSA9PiBwLnBlcnNpc3RlbnQgfHwgIWV4aXN0aW5nTmFtZXMuaGFzKHAubmFtZS50b0xvd2VyQ2FzZSgpKSk7CiAgY29uc3QgaGFuZGxlRHJhZ1N0YXJ0ID0gKGUsIGlkeCkgPT4gewogICAgc2V0RHJhZ0lkeChpZHgpOwogICAgZS5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICJtb3ZlIjsKICB9OwogIGNvbnN0IGhhbmRsZURyYWdPdmVyID0gKGUsIGlkeCkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgZS5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9ICJtb3ZlIjsKICAgIHNldE92ZXJJZHgoaWR4KTsKICB9OwogIGNvbnN0IGhhbmRsZURyb3AgPSAoZSwgaWR4KSA9PiB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBpZiAoZHJhZ0lkeCAhPT0gbnVsbCAmJiBkcmFnSWR4ICE9PSBpZHgpIG9uUmVvcmRlcihkcmFnSWR4LCBpZHgpOwogICAgc2V0RHJhZ0lkeChudWxsKTsKICAgIHNldE92ZXJJZHgobnVsbCk7CiAgfTsKICBjb25zdCBoYW5kbGVEcmFnRW5kID0gKCkgPT4gewogICAgc2V0RHJhZ0lkeChudWxsKTsKICAgIHNldE92ZXJJZHgobnVsbCk7CiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgU2VjdGlvbkhlYWRlciwKICAgICAgewogICAgICAgIHRpdGxlLAogICAgICAgIGljb24sCiAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICBiZ0NvbG9yLAogICAgICAgIHRvdGFsLAogICAgICAgIG1vbnRobHlUb3RhbCwKICAgICAgICBjb3VudDogaXRlbXMubGVuZ3RoLAogICAgICAgIGlzT3BlbiwKICAgICAgICBvblRvZ2dsZTogKCkgPT4gc2V0SXNPcGVuKCFpc09wZW4pCiAgICAgIH0KICAgICksCiAgICBpc09wZW4gJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjEwcHggMTJweCAxMnB4IiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Y29sb3IyfTIwYCwgYm9yZGVyUmFkaXVzOiAiMCAwIDEycHggMTJweCIsIG1hcmdpblRvcDogLTIgfSwgY2hpbGRyZW46IFsKICAgICAgaXRlbXMubWFwKChpdGVtLCBpZHgpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgImRpdiIsCiAgICAgICAgewogICAgICAgICAgZHJhZ2dhYmxlOiB0cnVlLAogICAgICAgICAgb25EcmFnU3RhcnQ6IChlKSA9PiBoYW5kbGVEcmFnU3RhcnQoZSwgaWR4KSwKICAgICAgICAgIG9uRHJhZ092ZXI6IChlKSA9PiBoYW5kbGVEcmFnT3ZlcihlLCBpZHgpLAogICAgICAgICAgb25Ecm9wOiAoZSkgPT4gaGFuZGxlRHJvcChlLCBpZHgpLAogICAgICAgICAgb25EcmFnRW5kOiBoYW5kbGVEcmFnRW5kLAogICAgICAgICAgc3R5bGU6IHsgb3BhY2l0eTogZHJhZ0lkeCA9PT0gaWR4ID8gMC40IDogMSwgYm9yZGVyVG9wOiBvdmVySWR4ID09PSBpZHggJiYgZHJhZ0lkeCAhPT0gbnVsbCAmJiBkcmFnSWR4ICE9PSBpZHggPyBgMnB4IHNvbGlkICR7Y29sb3IyfWAgOiAiMnB4IHNvbGlkIHRyYW5zcGFyZW50IiwgdHJhbnNpdGlvbjogIm9wYWNpdHkgMC4xNXMiIH0sCiAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgSXRlbVJvdywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGl0ZW0sCiAgICAgICAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICAgICAgICBvblVwZGF0ZTogKHUpID0+IG9uVXBkYXRlKGl0ZW0uaWQsIHUpLAogICAgICAgICAgICAgIG9uRGVsZXRlOiAoKSA9PiBvbkRlbGV0ZShpdGVtLmlkKSwKICAgICAgICAgICAgICBpbnB1dE1vZGUKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIH0sCiAgICAgICAgaXRlbS5pZAogICAgICApKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMiwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgYXZhaWxhYmxlUHJlc2V0cy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDYsIHBhZGRpbmdMZWZ0OiAyIH0sIGNoaWxkcmVuOiAiUXVpY2sgYWRkOiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4V3JhcDogIndyYXAiLCBnYXA6IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGF2YWlsYWJsZVByZXNldHMubWFwKChwKSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBvbkFkZFByZXNldChwLm5hbWUsIHAuYXNzZXRUeXBlKSwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjAsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtjb2xvcjJ9MzBgLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBgJHtiZ0NvbG9yfWAsCiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4xNXMiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBgJHtjb2xvcjJ9MTVgOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYmdDb2xvcjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogcC5lbW9qaSB9KSwKICAgICAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgICAgIHAubmFtZQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcC5uYW1lCiAgICAgICAgICApKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9uQ2xpY2s6IG9uQWRkLAogICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNnB4IDEycHgiLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAyMCwKICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBkYXNoZWQgJHtjb2xvcjJ9NTBgLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDUwMCwKICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICBnYXA6IDQsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMTVzIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYCR7Y29sb3IyfTEwYDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICAgIGUudGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbHVzLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgIiBDdXN0b20iCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBmb290ZXIKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgU3VtbWFyeVNlY3Rpb24gPSAoeyBidWRnZXQgfSkgPT4gewogIGNvbnN0IHRvdGFsTW9udGhseUluY29tZSA9IGJ1ZGdldC5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTW9udGhseUV4cGVuc2VzID0gYnVkZ2V0LmV4cGVuc2VzLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKTsKICBjb25zdCB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyA9IGJ1ZGdldC5saWFiaWxpdGllcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgY29uc3QgbW9udGhseU5ldCA9IHRvdGFsTW9udGhseUluY29tZSAtIHRvdGFsTW9udGhseUV4cGVuc2VzIC0gdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHM7CiAgY29uc3QgYW5udWFsTmV0ID0gbW9udGhseU5ldCAqIDEyOwogIGNvbnN0IHRvdGFsTGlxdWlkQXNzZXRzID0gYnVkZ2V0LmFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTm9uTGlxdWlkQXNzZXRzID0gYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsUmV0aXJlbWVudCA9IGJ1ZGdldC5yZXRpcmVtZW50LnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3Qgbm9uTGlxdWlkQXREaXNjb3VudCA9IHRvdGFsTm9uTGlxdWlkQXNzZXRzICogKDEgLSBidWRnZXQubm9uTGlxdWlkRGlzY291bnQgLyAxMDApOwogIGNvbnN0IG9uZVRpbWVMaWFiaWxpdGllcyA9IGJ1ZGdldC5saWFiaWxpdGllcy5maWx0ZXIoKGkpID0+IGkuZnJlcXVlbmN5ID09PSAib25lX3RpbWUiKS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTGlhYmlsaXRpZXMgPSBidWRnZXQubGlhYmlsaXRpZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICBjb25zdCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID0gdG90YWxMaXF1aWRBc3NldHMgLSBvbmVUaW1lTGlhYmlsaXRpZXM7CiAgY29uc3QgbmV0V29ydGggPSBsaXF1aWRBZnRlckxpYWJpbGl0aWVzICsgbm9uTGlxdWlkQXREaXNjb3VudCArIHRvdGFsUmV0aXJlbWVudDsKICBjb25zdCBtb250aGx5QnVybiA9IHRvdGFsTW9udGhseUV4cGVuc2VzICsgdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHMgLSB0b3RhbE1vbnRobHlJbmNvbWU7CiAgY29uc3QgbGlxdWlkRm9yUnVud2F5ID0gTWF0aC5tYXgoMCwgbGlxdWlkQWZ0ZXJMaWFiaWxpdGllcyk7CiAgY29uc3QgcnVud2F5TW9udGhzID0gbW9udGhseUJ1cm4gPiAwICYmIGxpcXVpZEZvclJ1bndheSA+IDAgPyBsaXF1aWRGb3JSdW53YXkgLyBtb250aGx5QnVybiA6IG51bGw7CiAgY29uc3QgcnVud2F5WWVhcnMgPSBydW53YXlNb250aHMgPyBydW53YXlNb250aHMgLyAxMiA6IG51bGw7CiAgY29uc3QgZXh0ZW5kZWRGb3JSdW53YXkgPSBsaXF1aWRGb3JSdW53YXkgKyBub25MaXF1aWRBdERpc2NvdW50OwogIGNvbnN0IGV4dFJ1bndheU1vbnRocyA9IG1vbnRobHlCdXJuID4gMCAmJiBleHRlbmRlZEZvclJ1bndheSA+IDAgPyBleHRlbmRlZEZvclJ1bndheSAvIG1vbnRobHlCdXJuIDogbnVsbDsKICBjb25zdCBleHRSdW53YXlZZWFycyA9IGV4dFJ1bndheU1vbnRocyA/IGV4dFJ1bndheU1vbnRocyAvIDEyIDogbnVsbDsKICBjb25zdCBzYXZpbmdzUmF0ZSA9IHRvdGFsTW9udGhseUluY29tZSA+IDAgPyBtb250aGx5TmV0IC8gdG90YWxNb250aGx5SW5jb21lICogMTAwIDogMDsKICBjb25zdCBpc1Bvc2l0aXZlID0gbW9udGhseU5ldCA+PSAwOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogaXNQb3NpdGl2ZSA/IENPTE9SUy5pbmNvbWVCZyA6IENPTE9SUy5leHBlbnNlQmcsCiAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgIHBhZGRpbmc6ICIyMHB4IDE2cHgiLAogICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtpc1Bvc2l0aXZlID8gQ09MT1JTLmluY29tZSA6IENPTE9SUy5leHBlbnNlfTIwYAogICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxNiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIk1vbnRobHkgQ2FzaCBGbG93IiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJiYXNlbGluZSIsIGdhcDogNiwgbWFyZ2luQm90dG9tOiAyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBpc1Bvc2l0aXZlID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIG1vbnRobHlOZXQgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgICBmbXQobW9udGhseU5ldCkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIi9tbyIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBhbm51YWxOZXQgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgZm10KGFubnVhbE5ldCksCiAgICAgICAgICAiIC95ZWFyIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEyLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJJbmNvbWUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5pbmNvbWUgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICBmbXQodG90YWxNb250aGx5SW5jb21lKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiRXhwZW5zZXMiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5leHBlbnNlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgZm10KHRvdGFsTW9udGhseUV4cGVuc2VzKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIkxpYWJpbGl0aWVzIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgZm10KHRvdGFsTW9udGhseUxpYWJpbGl0eVBheW1lbnRzKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBydW53YXlNb250aHMgIT09IG51bGwgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJMZWZ0OiBgMXB4IHNvbGlkICR7aXNQb3NpdGl2ZSA/IENPTE9SUy5pbmNvbWUgOiBDT0xPUlMuZXhwZW5zZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENsb2NrLCB7IHNpemU6IDE0LCBjb2xvcjogQ09MT1JTLmV4cGVuc2UgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5leHBlbnNlLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogIlJ1bndheSIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMSB9LCBjaGlsZHJlbjogIkxpcXVpZCBvbmx5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMuZXhwZW5zZSB9LCBjaGlsZHJlbjogcnVud2F5WWVhcnMgPj0gMSA/IGAke3J1bndheVllYXJzLnRvRml4ZWQoMSl9IHlyc2AgOiBgJHtNYXRoLnJvdW5kKHJ1bndheU1vbnRocyl9IG1vYCB9KQogICAgICAgIF0gfSksCiAgICAgICAgZXh0UnVud2F5TW9udGhzICE9PSBudWxsICYmIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDEgfSwgY2hpbGRyZW46ICIrIE5vbi1saXF1aWQgc29sZCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyMCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZXh0UnVud2F5WWVhcnMgPj0gMSA/IGAke2V4dFJ1bndheVllYXJzLnRvRml4ZWQoMSl9IHlyc2AgOiBgJHtNYXRoLnJvdW5kKGV4dFJ1bndheU1vbnRocyl9IG1vYCB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSA6IGlzUG9zaXRpdmUgJiYgbW9udGhseU5ldCA+IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJMZWZ0OiBgMXB4IHNvbGlkICR7Q09MT1JTLmluY29tZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFycm93VXBSaWdodCwgeyBzaXplOiAxNCwgY29sb3I6IENPTE9SUy5pbmNvbWUgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5pbmNvbWUsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiIH0sIGNoaWxkcmVuOiAiR3Jvd3RoIiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiBmbXQoYW5udWFsTmV0KSB9KSwKICAgICAgICAgICIveXIiCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAiMnlyOiArIiwKICAgICAgICAgIGZtdChhbm51YWxOZXQgKiAyKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJyIiwge30pLAogICAgICAgICAgIjV5cjogKyIsCiAgICAgICAgICBmbXQoYW5udWFsTmV0ICogNSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkgOiBudWxsCiAgICBdIH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgIG1hcmdpbkJvdHRvbTogMTIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogIkFzc2V0IEJyZWFrZG93biIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGdhcDogNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiTGlxdWlkIGFzc2V0cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5hc3NldCB9LCBjaGlsZHJlbjogZm10RXhhY3QodG90YWxMaXF1aWRBc3NldHMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBvbmVUaW1lTGlhYmlsaXRpZXMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIsIHBhZGRpbmdMZWZ0OiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIlx1MjIxMiBPbmUtdGltZSBkZWJ0cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJcdTIyMTIiLAogICAgICAgICAgICBmbXRFeGFjdChvbmVUaW1lTGlhYmlsaXRpZXMpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBwYWRkaW5nTGVmdDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI9IExpcXVpZCBhdmFpbGFibGUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID49IDAgPyBDT0xPUlMucG9zaXRpdmUgOiBDT0xPUlMubmVnYXRpdmUgfSwgY2hpbGRyZW46IGZtdEV4YWN0KGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCwgbWFyZ2luVG9wOiA0LCBwYWRkaW5nVG9wOiA2LCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIk5vbi1saXF1aWQgKGF0ICIsCiAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgIiUgZGlzY291bnQpIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZm10RXhhY3Qobm9uTGlxdWlkQXREaXNjb3VudCkgfSkKICAgICAgICBdIH0pLAogICAgICAgIHRvdGFsUmV0aXJlbWVudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI0MDFrIC8gUmV0aXJlbWVudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5yZXRpcmVtZW50IH0sIGNoaWxkcmVuOiBmbXRFeGFjdCh0b3RhbFJldGlyZW1lbnQpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIG1hcmdpblRvcDogNCwgcGFkZGluZ1RvcDogOCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJOZXQgV29ydGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBuZXRXb3J0aCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXRFeGFjdChuZXRXb3J0aCkgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAoKCkgPT4gewogICAgICBjb25zdCBwcm9qZWN0aW9uWWVhcnMgPSAyMDsKICAgICAgY29uc3Qgc3RhcnRMaXF1aWQgPSBNYXRoLm1heCgwLCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzKTsKICAgICAgY29uc3Qgc3RhcnRFeHQgPSBNYXRoLm1heCgwLCBuZXRXb3J0aCk7CiAgICAgIGNvbnN0IGRhdGEgPSBbXTsKICAgICAgY29uc3QgYW5udWFsQnVybiA9IG1vbnRobHlCdXJuICogMTI7CiAgICAgIGxldCBiYWxMaXF1aWQgPSBzdGFydExpcXVpZDsKICAgICAgbGV0IGJhbEV4dGVuZGVkID0gc3RhcnRFeHQ7CiAgICAgIGxldCBsaXF1aWRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGxldCBleHRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGZvciAobGV0IHlyID0gMDsgeXIgPD0gcHJvamVjdGlvblllYXJzOyB5cisrKSB7CiAgICAgICAgZGF0YS5wdXNoKHsKICAgICAgICAgIHllYXI6IHlyLAogICAgICAgICAgbGlxdWlkOiBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbExpcXVpZCkpLAogICAgICAgICAgZXh0ZW5kZWQ6IG5vbkxpcXVpZEF0RGlzY291bnQgPiAwIHx8IHRvdGFsUmV0aXJlbWVudCA+IDAgPyBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbEV4dGVuZGVkKSkgOiAwCiAgICAgICAgfSk7CiAgICAgICAgaWYgKG1vbnRobHlCdXJuID4gMCkgewogICAgICAgICAgYmFsTGlxdWlkIC09IGFubnVhbEJ1cm47CiAgICAgICAgICBiYWxFeHRlbmRlZCAtPSBhbm51YWxCdXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYWxMaXF1aWQgKz0gYW5udWFsTmV0OwogICAgICAgICAgYmFsRXh0ZW5kZWQgKz0gYW5udWFsTmV0OwogICAgICAgIH0KICAgICAgICBpZiAoYmFsTGlxdWlkIDw9IDApIGxpcXVpZEhpdFplcm8gPSB0cnVlOwogICAgICAgIGlmIChiYWxFeHRlbmRlZCA8PSAwKSBleHRIaXRaZXJvID0gdHJ1ZTsKICAgICAgICBpZiAobGlxdWlkSGl0WmVybyAmJiBleHRIaXRaZXJvKSBicmVhazsKICAgICAgfQogICAgICBjb25zdCBsaXF1aWRaZXJvWWVhciA9IG1vbnRobHlCdXJuID4gMCA/IGRhdGEuZmluZCgoZCwgaSkgPT4gaSA+IDAgJiYgZC5saXF1aWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgZXh0WmVyb1llYXIgPSBtb250aGx5QnVybiA+IDAgPyBkYXRhLmZpbmQoKGQsIGkpID0+IGkgPiAwICYmIGQuZXh0ZW5kZWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgbWF4VmFsID0gTWF0aC5tYXgoLi4uZGF0YS5tYXAoKGQpID0+IE1hdGgubWF4KGQubGlxdWlkLCBkLmV4dGVuZGVkKSkpOwogICAgICBjb25zdCBtaW5WYWwgPSBNYXRoLm1pbiguLi5kYXRhLm1hcCgoZCkgPT4gTWF0aC5taW4oZC5saXF1aWQsIGQuZXh0ZW5kZWQpKSk7CiAgICAgIGNvbnN0IGZvcm1hdFlBeGlzID0gKHZhbCkgPT4gewogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlNikgcmV0dXJuIGAkJHsodmFsIC8gMWU2KS50b0ZpeGVkKDEpfU1gOwogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlMykgcmV0dXJuIGAkJHsodmFsIC8gMWUzKS50b0ZpeGVkKDApfUtgOwogICAgICAgIHJldHVybiBgJCR7dmFsfWA7CiAgICAgIH07CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICBwYWRkaW5nOiAiMTZweCIsCiAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgIG1hcmdpbkJvdHRvbTogMTIKICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiwgbGV0dGVyU3BhY2luZzogMC41LCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBtb250aGx5QnVybiA+IDAgPyAiUnVud2F5IFByb2plY3Rpb24iIDogIldlYWx0aCBQcm9qZWN0aW9uIiwKICAgICAgICAgICIgXHUyMDE0ICIsCiAgICAgICAgICBwcm9qZWN0aW9uWWVhcnMsCiAgICAgICAgICAiIFllYXJzIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDI0MCwgd2lkdGg6ICIxMDAlIiwgZm9udFNpemU6IDExIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKEFyZWFDaGFydCwgeyBkYXRhLCBtYXJnaW46IHsgdG9wOiAxMCwgcmlnaHQ6IDEwLCBsZWZ0OiAtMTAsIGJvdHRvbTogMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRlZnMiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJsaW5lYXJHcmFkaWVudCIsIHsgaWQ6ICJncmFkTGlxdWlkIiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI1JSIsIHN0b3BDb2xvcjogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTLmV4cGVuc2UgOiBDT0xPUlMuaW5jb21lLCBzdG9wT3BhY2l0eTogMC4xNSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI5NSUiLCBzdG9wQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgc3RvcE9wYWNpdHk6IDAgfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImxpbmVhckdyYWRpZW50IiwgeyBpZDogImdyYWRFeHRlbmRlZCIsIHgxOiAiMCIsIHkxOiAiMCIsIHgyOiAiMCIsIHkyOiAiMSIsIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IENPTE9SUy5ub25MaXF1aWQsIHN0b3BPcGFjaXR5OiAwLjEgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiOTUlIiwgc3RvcENvbG9yOiBDT0xPUlMubm9uTGlxdWlkLCBzdG9wT3BhY2l0eTogMCB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDYXJ0ZXNpYW5HcmlkLCB7IHN0cm9rZURhc2hhcnJheTogIjMgMyIsIHZlcnRpY2FsOiBmYWxzZSwgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyTGlnaHQgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBYQXhpcywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRhdGFLZXk6ICJ5ZWFyIiwKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IHsgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyIH0sCiAgICAgICAgICAgICAgdGlja0Zvcm1hdHRlcjogKHYpID0+IGBZciAke3Z9YAogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgWUF4aXMsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrRm9ybWF0dGVyOiBmb3JtYXRZQXhpcywKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBUb29sdGlwLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGVudDogKHsgYWN0aXZlLCBwYXlsb2FkLCBsYWJlbCB9KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlICYmIHBheWxvYWQgJiYgcGF5bG9hZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgbGlxID0gcGF5bG9hZC5maW5kKChwKSA9PiBwLmRhdGFLZXkgPT09ICJsaXF1aWQiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV4dCA9IHBheWxvYWQuZmluZCgocCkgPT4gcC5kYXRhS2V5ID09PSAiZXh0ZW5kZWQiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDgsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIG1hcmdpbkJvdHRvbTogNiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgIlllYXIgIiwKICAgICAgICAgICAgICAgICAgICAgIGxhYmVsCiAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogMyB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiTGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGxpcSA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQobGlxKSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiKyBOb24tbGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGV4dCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQoZXh0KSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgXSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAiZXh0ZW5kZWQiLCBzdHJva2U6IENPTE9SUy5ub25MaXF1aWQsIGZpbGw6ICJ1cmwoI2dyYWRFeHRlbmRlZCkiLCBzdHJva2VXaWR0aDogMiwgc3Ryb2tlRGFzaGFycmF5OiAiNSA1IiwgbmFtZTogIkV4dGVuZGVkIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAibGlxdWlkIiwgc3Ryb2tlOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMuZXhwZW5zZSA6IENPTE9SUy5pbmNvbWUsIGZpbGw6ICJ1cmwoI2dyYWRMaXF1aWQpIiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJMaXF1aWQiIH0pCiAgICAgICAgXSB9KSB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luVG9wOiA4LCBmb250U2l6ZTogMTEgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxNiwgaGVpZ2h0OiAzLCBiYWNrZ3JvdW5kQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgYm9yZGVyUmFkaXVzOiAyIH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkxpcXVpZCBhc3NldHMiIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDE2LCBoZWlnaHQ6IDMsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLm5vbkxpcXVpZCwgYm9yZGVyUmFkaXVzOiAyLCBib3JkZXJUb3A6ICIxcHggZGFzaGVkIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICIrIE5vbi1saXF1aWQgc29sZCIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIG1vbnRobHlCdXJuID4gMCAmJiAobGlxdWlkWmVyb1llYXIgfHwgZXh0WmVyb1llYXIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgcGFkZGluZzogIjhweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5leHBlbnNlfTA4YCwgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGxpcXVpZFplcm9ZZWFyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJMaXF1aWQgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMuZXhwZW5zZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICJ5ZWFyICIsCiAgICAgICAgICAgICAgbGlxdWlkWmVyb1llYXIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIGV4dFplcm9ZZWFyICYmIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJBbGwgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMubm9uTGlxdWlkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgInllYXIgIiwKICAgICAgICAgICAgICBleHRaZXJvWWVhcgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfSkoKQogIF0gfSk7Cn07CnZhciBoeWRyYXRlRnJvbUluaXRpYWxEYXRhID0gKGRhdGEpID0+IHsKICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJvYmplY3QiKSByZXR1cm4gbnVsbDsKICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGF0YSkuZmlsdGVyKChrKSA9PiBrICE9PSAicmVhZHkiICYmIGsgIT09ICJ0aW1lc3RhbXAiICYmIGsgIT09ICJpbnB1dF9zb3VyY2UiICYmIGsgIT09ICJzdW1tYXJ5IiAmJiBrICE9PSAic3VnZ2VzdGVkX2ZvbGxvd3VwcyIpOwogIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEFwcGx5aW5nIGluaXRpYWxEYXRhOiIsIGRhdGEpOwogIGNvbnN0IGZpbmRPckFkZCA9IChhcnIsIG5hbWUsIGFtb3VudCwgZnJlcSA9ICJvbmVfdGltZSIpID0+IHsKICAgIGNvbnN0IGV4aXN0aW5nID0gYXJyLmZpbmQoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGV4aXN0aW5nLmFtb3VudCA9IGFtb3VudDsKICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgY29tcHV0ZVZhbHVlcyhhbW91bnQsIGV4aXN0aW5nLmZyZXF1ZW5jeSkpOwogICAgICByZXR1cm4gYXJyOwogICAgfQogICAgY29uc3QgaXRlbSA9IGZyZXEgPT09ICJvbmVfdGltZSIgPyBtaWEobmFtZSwgYW1vdW50KSA6IG1pKG5hbWUsIGFtb3VudCwgZnJlcSk7CiAgICByZXR1cm4gWy4uLmFyciwgaXRlbV07CiAgfTsKICBjb25zdCB1cHNlcnQgPSAoYXJyLCBuYW1lLCBhbW91bnQsIGZyZXEgPSAib25lX3RpbWUiKSA9PiB7CiAgICBjb25zdCBsYyA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIGNvbnN0IGlkeCA9IGFyci5maW5kSW5kZXgoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGxjKSB8fCBsYy5pbmNsdWRlcyhpLm5hbWUudG9Mb3dlckNhc2UoKSkpOwogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGNvbnN0IGl0ZW0yID0gYXJyW2lkeF07CiAgICAgIGFycltpZHhdID0geyAuLi5pdGVtMiwgYW1vdW50LCAuLi5jb21wdXRlVmFsdWVzKGFtb3VudCwgaXRlbTIuZnJlcXVlbmN5KSB9OwogICAgICByZXR1cm4gYXJyOwogICAgfQogICAgY29uc3QgaXRlbSA9IGZyZXEgPT09ICJvbmVfdGltZSIgPyBtaWEobmFtZSwgYW1vdW50KSA6IG1pKG5hbWUsIGFtb3VudCwgZnJlcSk7CiAgICByZXR1cm4gWy4uLmFyciwgaXRlbV07CiAgfTsKICBsZXQgYmFzZTsKICBpZiAoZGF0YS5wcmVzZXQpIHsKICAgIGNvbnN0IHByZXNldCA9IEJVREdFVF9QUkVTRVRTLmZpbmQoKHApID0+IHAua2V5ID09PSBkYXRhLnByZXNldCk7CiAgICBpZiAocHJlc2V0KSB7CiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgIGJhc2UgPSB7IC4uLmVtcHR5QnVkZ2V0KCksIC4uLnByZXNldC5idWRnZXQsIGlkOiBnZW5lcmF0ZUlkKCksIGNyZWF0ZWRBdDogbm93LCB1cGRhdGVkQXQ6IG5vdyB9OwogICAgfSBlbHNlIHsKICAgICAgYmFzZSA9IGVtcHR5QnVkZ2V0KCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGJhc2UgPSBlbXB0eUJ1ZGdldCgpOwogIH0KICBpZiAoZGF0YS5idWRnZXRfbmFtZSkgYmFzZS5uYW1lID0gZGF0YS5idWRnZXRfbmFtZTsKICBpZiAoZGF0YS5pc191bmVtcGxveWVkKSB7CiAgICBpZiAoYmFzZS5pbmNvbWUubGVuZ3RoID4gMCkgewogICAgICBiYXNlLmluY29tZSA9IGJhc2UuaW5jb21lLm1hcCgoaSkgPT4gKHsgLi4uaSwgYW1vdW50OiAwLCAuLi5jb21wdXRlVmFsdWVzKDAsIGkuZnJlcXVlbmN5KSB9KSk7CiAgICB9CiAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IC9lbWVyZ2VuY3kvaS50ZXN0KGEubmFtZSkpKSB7CiAgICAgIGJhc2UuYXNzZXRzID0gZmluZE9yQWRkKGJhc2UuYXNzZXRzLCAiRW1lcmdlbmN5IEZ1bmQiLCAwKTsKICAgIH0KICB9CiAgaWYgKGRhdGEuaXNfaG9tZW93bmVyKSB7CiAgICBiYXNlLmV4cGVuc2VzID0gYmFzZS5leHBlbnNlcy5tYXAoKGkpID0+IHsKICAgICAgaWYgKC9cYnJlbnRcYi9pLnRlc3QoaS5uYW1lKSAmJiAhL21vcnRnYWdlL2kudGVzdChpLm5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgbmFtZTogIk1vcnRnYWdlIFBheW1lbnQiIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGk7CiAgICB9KTsKICB9CiAgaWYgKGRhdGEubnVtX2NoaWxkcmVuICYmIGRhdGEubnVtX2NoaWxkcmVuID4gMCkgewogICAgaWYgKCFiYXNlLmV4cGVuc2VzLnNvbWUoKGUpID0+IC9jaGlsZHxkYXljYXJlfGtpZHMvaS50ZXN0KGUubmFtZSkpKSB7CiAgICAgIGJhc2UuZXhwZW5zZXMgPSBmaW5kT3JBZGQoYmFzZS5leHBlbnNlcywgIkNoaWxkY2FyZSAvIERheWNhcmUiLCBkYXRhLm51bV9jaGlsZHJlbiAqIDgwMCwgIm1vbnRobHkiKTsKICAgIH0KICB9CiAgY29uc3QgZWZmZWN0aXZlTW9udGhseUluY29tZSA9IGRhdGEubW9udGhseV9pbmNvbWUgfHwgKGRhdGEuYW5udWFsX2luY29tZSA/IE1hdGgucm91bmQoZGF0YS5hbm51YWxfaW5jb21lIC8gMTIpIDogdm9pZCAwKTsKICBpZiAoZGF0YS5zYWxhcnkpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiU2FsYXJ5IiwgZGF0YS5zYWxhcnksICJtb250aGx5Iik7CiAgaWYgKGRhdGEuc2lkZV9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiRnJlZWxhbmNlIC8gU2lkZSBIdXN0bGUiLCBkYXRhLnNpZGVfaW5jb21lLCAibW9udGhseSIpOwogIGlmIChkYXRhLnJlbnRhbF9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiUmVudGFsIEluY29tZSIsIGRhdGEucmVudGFsX2luY29tZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5zb2NpYWxfc2VjdXJpdHkpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiU29jaWFsIFNlY3VyaXR5IiwgZGF0YS5zb2NpYWxfc2VjdXJpdHksICJtb250aGx5Iik7CiAgaWYgKGRhdGEucGVuc2lvbl9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiUGVuc2lvbiIsIGRhdGEucGVuc2lvbl9pbmNvbWUsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuaW52ZXN0bWVudF9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiSW52ZXN0bWVudCBJbmNvbWUiLCBkYXRhLmludmVzdG1lbnRfaW5jb21lLCAibW9udGhseSIpOwogIGlmIChlZmZlY3RpdmVNb250aGx5SW5jb21lICYmICFkYXRhLnNhbGFyeSAmJiAhZGF0YS5zaWRlX2luY29tZSAmJiAhZGF0YS5yZW50YWxfaW5jb21lICYmICFkYXRhLnNvY2lhbF9zZWN1cml0eSAmJiAhZGF0YS5wZW5zaW9uX2luY29tZSkgewogICAgY29uc3QgY3VycmVudFRvdGFsID0gYmFzZS5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgaWYgKGN1cnJlbnRUb3RhbCA+IDApIHsKICAgICAgY29uc3QgcmF0aW8gPSBlZmZlY3RpdmVNb250aGx5SW5jb21lIC8gY3VycmVudFRvdGFsOwogICAgICBiYXNlLmluY29tZSA9IGJhc2UuaW5jb21lLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGJhc2UuaW5jb21lLmxlbmd0aCA9PT0gMCkgewogICAgICBiYXNlLmluY29tZSA9IFttaSgiSW5jb21lIiwgZWZmZWN0aXZlTW9udGhseUluY29tZSldOwogICAgfQogIH0KICBpZiAoZGF0YS5yZW50KSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJSZW50IiwgZGF0YS5yZW50LCAibW9udGhseSIpOwogIGlmIChkYXRhLm1vcnRnYWdlX3BheW1lbnQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIk1vcnRnYWdlIFBheW1lbnQiLCBkYXRhLm1vcnRnYWdlX3BheW1lbnQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEudXRpbGl0aWVzKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJVdGlsaXRpZXMiLCBkYXRhLnV0aWxpdGllcywgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5ncm9jZXJpZXMpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkdyb2NlcmllcyIsIGRhdGEuZ3JvY2VyaWVzLCAibW9udGhseSIpOwogIGlmIChkYXRhLmNhcl9wYXltZW50KSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJDYXIgUGF5bWVudCIsIGRhdGEuY2FyX3BheW1lbnQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuY2FyX2luc3VyYW5jZSkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiQ2FyIEluc3VyYW5jZSIsIGRhdGEuY2FyX2luc3VyYW5jZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5oZWFsdGhfaW5zdXJhbmNlKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJIZWFsdGggSW5zdXJhbmNlIiwgZGF0YS5oZWFsdGhfaW5zdXJhbmNlLCAibW9udGhseSIpOwogIGlmIChkYXRhLnBob25lX2JpbGwpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIlBob25lIEJpbGwiLCBkYXRhLnBob25lX2JpbGwsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuaW50ZXJuZXQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkludGVybmV0IiwgZGF0YS5pbnRlcm5ldCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5jaGlsZGNhcmUpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkNoaWxkY2FyZSAvIERheWNhcmUiLCBkYXRhLmNoaWxkY2FyZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5zdWJzY3JpcHRpb25zKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJTdWJzY3JpcHRpb25zIiwgZGF0YS5zdWJzY3JpcHRpb25zLCAibW9udGhseSIpOwogIGlmIChkYXRhLmRpbmluZ19vdXQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkRpbmluZyBPdXQiLCBkYXRhLmRpbmluZ19vdXQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEudHJhbnNwb3J0YXRpb24pIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkdhcyAvIFRyYW5zcG9ydGF0aW9uIiwgZGF0YS50cmFuc3BvcnRhdGlvbiwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5tb250aGx5X2V4cGVuc2VzICYmICFkYXRhLnJlbnQgJiYgIWRhdGEubW9ydGdhZ2VfcGF5bWVudCAmJiAhZGF0YS5ncm9jZXJpZXMpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2UuZXhwZW5zZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgaWYgKGN1cnJlbnRUb3RhbCA+IDApIHsKICAgICAgY29uc3QgcmF0aW8gPSBkYXRhLm1vbnRobHlfZXhwZW5zZXMgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UuZXhwZW5zZXMgPSBiYXNlLmV4cGVuc2VzLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9CiAgfQogIGlmIChkYXRhLmNoZWNraW5nX2JhbGFuY2UpIGJhc2UuYXNzZXRzID0gdXBzZXJ0KGJhc2UuYXNzZXRzLCAiQ2hlY2tpbmcgQWNjb3VudCIsIGRhdGEuY2hlY2tpbmdfYmFsYW5jZSk7CiAgaWYgKGRhdGEuc2F2aW5nc19iYWxhbmNlKSBiYXNlLmFzc2V0cyA9IHVwc2VydChiYXNlLmFzc2V0cywgIlNhdmluZ3MgQWNjb3VudCIsIGRhdGEuc2F2aW5nc19iYWxhbmNlKTsKICBpZiAoZGF0YS5lbWVyZ2VuY3lfZnVuZCkgYmFzZS5hc3NldHMgPSB1cHNlcnQoYmFzZS5hc3NldHMsICJFbWVyZ2VuY3kgRnVuZCIsIGRhdGEuZW1lcmdlbmN5X2Z1bmQpOwogIGlmIChkYXRhLmludmVzdG1lbnRfYmFsYW5jZSkgYmFzZS5hc3NldHMgPSB1cHNlcnQoYmFzZS5hc3NldHMsICJCcm9rZXJhZ2UgQWNjb3VudCIsIGRhdGEuaW52ZXN0bWVudF9iYWxhbmNlKTsKICBpZiAoZGF0YS5jcnlwdG9fdGlja2VycykgewogICAgY29uc3QgdGlja2VycyA9IGRhdGEuY3J5cHRvX3RpY2tlcnMuc3BsaXQoIiwiKS5tYXAoKHQpID0+IHQudHJpbSgpLnRvTG93ZXJDYXNlKCkpLmZpbHRlcihCb29sZWFuKTsKICAgIGZvciAoY29uc3QgdGlja2VyMiBvZiB0aWNrZXJzKSB7CiAgICAgIGNvbnN0IG5hbWUgPSB0aWNrZXIyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGlja2VyMi5zbGljZSgxKTsKICAgICAgaWYgKCFiYXNlLmFzc2V0cy5zb21lKChhKSA9PiBhLnRpY2tlciA9PT0gdGlja2VyMikpIHsKICAgICAgICBiYXNlLmFzc2V0cy5wdXNoKHsgLi4ubWlhKG5hbWUsIDApLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6IHRpY2tlcjIsIHF1YW50aXR5OiB2b2lkIDAgfSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGRhdGEuaGFzX2NyeXB0byB8fCBkYXRhLmNyeXB0b19iYWxhbmNlKSB7CiAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IGEuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCAvY3J5cHRvL2kudGVzdChhLm5hbWUpKSkgewogICAgICBiYXNlLmFzc2V0cy5wdXNoKHsgLi4ubWlhKCJDcnlwdG8gUG9ydGZvbGlvIiwgZGF0YS5jcnlwdG9fYmFsYW5jZSB8fCAwKSwgYXNzZXRUeXBlOiAiY3J5cHRvIiwgdGlja2VyOiAiYml0Y29pbiIgfSk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY3J5cHRvX2JhbGFuY2UpIHsKICAgICAgYmFzZS5hc3NldHMgPSBiYXNlLmFzc2V0cy5tYXAoKGEpID0+IGEuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCAvY3J5cHRvL2kudGVzdChhLm5hbWUpID8geyAuLi5hLCBhbW91bnQ6IGRhdGEuY3J5cHRvX2JhbGFuY2UsIHRvdGFsVmFsdWU6IGRhdGEuY3J5cHRvX2JhbGFuY2UgfSA6IGEpOwogICAgfQogIH0KICBpZiAoZGF0YS5zdG9ja190aWNrZXJzKSB7CiAgICBjb25zdCB0aWNrZXJzID0gZGF0YS5zdG9ja190aWNrZXJzLnNwbGl0KCIsIikubWFwKCh0KSA9PiB0LnRyaW0oKS50b1VwcGVyQ2FzZSgpKS5maWx0ZXIoQm9vbGVhbik7CiAgICBmb3IgKGNvbnN0IHRpY2tlcjIgb2YgdGlja2VycykgewogICAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IGEudGlja2VyID09PSB0aWNrZXIyICYmIGEuYXNzZXRUeXBlID09PSAic3RvY2siKSkgewogICAgICAgIGJhc2UuYXNzZXRzLnB1c2goeyAuLi5taWEodGlja2VyMiwgMCksIGFzc2V0VHlwZTogInN0b2NrIiwgdGlja2VyOiB0aWNrZXIyLCBxdWFudGl0eTogdm9pZCAwIH0pOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChkYXRhLmhhc19zdG9ja3MpIHsKICAgIGlmICghYmFzZS5hc3NldHMuc29tZSgoYSkgPT4gYS5hc3NldFR5cGUgPT09ICJzdG9jayIgfHwgL3N0b2NrfGJyb2tlcmFnZS9pLnRlc3QoYS5uYW1lKSkpIHsKICAgICAgYmFzZS5hc3NldHMucHVzaCh7IC4uLm1pYSgiU3RvY2tzL0Jyb2tlcmFnZSIsIDApLCBhc3NldFR5cGU6ICJzdG9jayIgfSk7CiAgICB9CiAgfQogIGlmIChkYXRhLmxpcXVpZF9hc3NldHMgJiYgIWRhdGEuY2hlY2tpbmdfYmFsYW5jZSAmJiAhZGF0YS5zYXZpbmdzX2JhbGFuY2UgJiYgIWRhdGEuZW1lcmdlbmN5X2Z1bmQpIHsKICAgIGNvbnN0IGxpcXVpZEl0ZW1zID0gYmFzZS5hc3NldHMuZmlsdGVyKChhKSA9PiAhYS5hc3NldFR5cGUgfHwgYS5hc3NldFR5cGUgPT09ICJtYW51YWwiKTsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGxpcXVpZEl0ZW1zLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubGlxdWlkX2Fzc2V0cyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5hc3NldHMgPSBiYXNlLmFzc2V0cy5tYXAoKGkpID0+IHsKICAgICAgICBpZiAoaS5hc3NldFR5cGUgJiYgaS5hc3NldFR5cGUgIT09ICJtYW51YWwiKSByZXR1cm4gaTsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEuaG9tZV92YWx1ZSkgYmFzZS5ub25MaXF1aWRBc3NldHMgPSB1cHNlcnQoYmFzZS5ub25MaXF1aWRBc3NldHMsICJIb21lIFZhbHVlIiwgZGF0YS5ob21lX3ZhbHVlKTsKICBpZiAoZGF0YS5jYXJfdmFsdWUpIGJhc2Uubm9uTGlxdWlkQXNzZXRzID0gdXBzZXJ0KGJhc2Uubm9uTGlxdWlkQXNzZXRzLCAiQ2FyIFZhbHVlIiwgZGF0YS5jYXJfdmFsdWUpOwogIGlmIChkYXRhLmpld2VscnlfY29sbGVjdGlibGVzKSBiYXNlLm5vbkxpcXVpZEFzc2V0cyA9IHVwc2VydChiYXNlLm5vbkxpcXVpZEFzc2V0cywgIkpld2VscnkgLyBDb2xsZWN0aWJsZXMiLCBkYXRhLmpld2VscnlfY29sbGVjdGlibGVzKTsKICBpZiAoZGF0YS5idXNpbmVzc19lcXVpdHkpIGJhc2Uubm9uTGlxdWlkQXNzZXRzID0gdXBzZXJ0KGJhc2Uubm9uTGlxdWlkQXNzZXRzLCAiQnVzaW5lc3MgRXF1aXR5IiwgZGF0YS5idXNpbmVzc19lcXVpdHkpOwogIGlmIChkYXRhLm5vbmxpcXVpZF9hc3NldHMgJiYgIWRhdGEuaG9tZV92YWx1ZSAmJiAhZGF0YS5jYXJfdmFsdWUpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2Uubm9uTGlxdWlkQXNzZXRzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubm9ubGlxdWlkX2Fzc2V0cyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5ub25MaXF1aWRBc3NldHMgPSBiYXNlLm5vbkxpcXVpZEFzc2V0cy5tYXAoKGkpID0+IHsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEubm9ubGlxdWlkX2Rpc2NvdW50ICE9PSB2b2lkIDApIGJhc2Uubm9uTGlxdWlkRGlzY291bnQgPSBkYXRhLm5vbmxpcXVpZF9kaXNjb3VudDsKICBpZiAoZGF0YS5iYWxhbmNlXzQwMWspIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICI0MDFrIiwgZGF0YS5iYWxhbmNlXzQwMWspOwogIGlmIChkYXRhLnJvdGhfaXJhKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiUm90aCBJUkEiLCBkYXRhLnJvdGhfaXJhKTsKICBpZiAoZGF0YS50cmFkaXRpb25hbF9pcmEpIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICJUcmFkaXRpb25hbCBJUkEiLCBkYXRhLnRyYWRpdGlvbmFsX2lyYSk7CiAgaWYgKGRhdGEucGVuc2lvbl9mdW5kKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiUGVuc2lvbiBGdW5kIiwgZGF0YS5wZW5zaW9uX2Z1bmQpOwogIGlmIChkYXRhLmJhbGFuY2VfNDAzYikgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIjQwM2IiLCBkYXRhLmJhbGFuY2VfNDAzYik7CiAgaWYgKGRhdGEuc2VwX2lyYSkgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIlNFUCBJUkEiLCBkYXRhLnNlcF9pcmEpOwogIGlmIChkYXRhLnJldGlyZW1lbnRfc2F2aW5ncyAmJiAhZGF0YS5iYWxhbmNlXzQwMWsgJiYgIWRhdGEucm90aF9pcmEgJiYgIWRhdGEudHJhZGl0aW9uYWxfaXJhKSB7CiAgICBjb25zdCBjdXJyZW50VG90YWwgPSBiYXNlLnJldGlyZW1lbnQucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICAgIGlmIChjdXJyZW50VG90YWwgPiAwKSB7CiAgICAgIGNvbnN0IHJhdGlvID0gZGF0YS5yZXRpcmVtZW50X3NhdmluZ3MgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UucmV0aXJlbWVudCA9IGJhc2UucmV0aXJlbWVudC5tYXAoKGkpID0+IHsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoYmFzZS5yZXRpcmVtZW50Lmxlbmd0aCA9PT0gMCkgewogICAgICBiYXNlLnJldGlyZW1lbnQgPSBbbWlhKCJSZXRpcmVtZW50IFNhdmluZ3MiLCBkYXRhLnJldGlyZW1lbnRfc2F2aW5ncyldOwogICAgfQogIH0KICBpZiAoZGF0YS5tb3J0Z2FnZV9iYWxhbmNlKSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJNb3J0Z2FnZSIsIGRhdGEubW9ydGdhZ2VfYmFsYW5jZSk7CiAgaWYgKGRhdGEuc3R1ZGVudF9sb2FucykgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiU3R1ZGVudCBMb2FucyIsIGRhdGEuc3R1ZGVudF9sb2Fucyk7CiAgaWYgKGRhdGEuY2FyX2xvYW4pIGJhc2UubGlhYmlsaXRpZXMgPSB1cHNlcnQoYmFzZS5saWFiaWxpdGllcywgIkNhciBMb2FuIiwgZGF0YS5jYXJfbG9hbik7CiAgaWYgKGRhdGEuY3JlZGl0X2NhcmRfZGVidCkgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiQ3JlZGl0IENhcmQgRGVidCIsIGRhdGEuY3JlZGl0X2NhcmRfZGVidCk7CiAgaWYgKGRhdGEucGVyc29uYWxfbG9hbikgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiUGVyc29uYWwgTG9hbiIsIGRhdGEucGVyc29uYWxfbG9hbik7CiAgaWYgKGRhdGEubWVkaWNhbF9kZWJ0KSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJNZWRpY2FsIEJpbGxzIiwgZGF0YS5tZWRpY2FsX2RlYnQpOwogIGlmIChkYXRhLmxpYWJpbGl0aWVzICYmICFkYXRhLm1vcnRnYWdlX2JhbGFuY2UgJiYgIWRhdGEuc3R1ZGVudF9sb2FucyAmJiAhZGF0YS5jYXJfbG9hbiAmJiAhZGF0YS5jcmVkaXRfY2FyZF9kZWJ0KSB7CiAgICBjb25zdCBjdXJyZW50VG90YWwgPSBiYXNlLmxpYWJpbGl0aWVzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubGlhYmlsaXRpZXMgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UubGlhYmlsaXRpZXMgPSBiYXNlLmxpYWJpbGl0aWVzLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGJhc2UubGlhYmlsaXRpZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIGJhc2UubGlhYmlsaXRpZXMgPSBbbWlhKCJUb3RhbCBEZWJ0IiwgZGF0YS5saWFiaWxpdGllcyldOwogICAgfQogIH0KICByZXR1cm4gYmFzZTsKfTsKZnVuY3Rpb24gTXlCdWRnZXQoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBbc2F2ZWRCdWRnZXRzLCBzZXRTYXZlZEJ1ZGdldHNdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgoKSA9PiBsb2FkQnVkZ2V0cygpKTsKICBjb25zdCBbY3VycmVudFZpZXcsIHNldEN1cnJlbnRWaWV3XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoImJ1ZGdldCIpOwogIGNvbnN0IFtidWRnZXQsIHNldEJ1ZGdldF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCgpID0+IHsKICAgIGNvbnN0IGh5ZHJhdGVkID0gaHlkcmF0ZUZyb21Jbml0aWFsRGF0YShpbml0aWFsRGF0YTIpOwogICAgaWYgKGh5ZHJhdGVkKSByZXR1cm4gaHlkcmF0ZWQ7CiAgICByZXR1cm4gbG9hZEN1cnJlbnRCdWRnZXQoKSB8fCBlbXB0eUJ1ZGdldCgpOwogIH0pOwogIGNvbnN0IFtlZGl0aW5nTmFtZSwgc2V0RWRpdGluZ05hbWVdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW25hbWVJbnB1dCwgc2V0TmFtZUlucHV0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoYnVkZ2V0Lm5hbWUpOwogIGNvbnN0IFtyZWZyZXNoaW5nLCBzZXRSZWZyZXNoaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtzaG93U3Vic2NyaWJlTW9kYWwsIHNldFNob3dTdWJzY3JpYmVNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc3Vic2NyaWJlRW1haWwsIHNldFN1YnNjcmliZUVtYWlsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzdWJzY3JpYmVTdGF0dXMsIHNldFN1YnNjcmliZVN0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW3N1YnNjcmliZU1lc3NhZ2UsIHNldFN1YnNjcmliZU1lc3NhZ2VdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3Nob3dGZWVkYmFja01vZGFsLCBzZXRTaG93RmVlZGJhY2tNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZmVlZGJhY2tUZXh0LCBzZXRGZWVkYmFja1RleHRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW2ZlZWRiYWNrU3RhdHVzLCBzZXRGZWVkYmFja1N0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW2NvbmZpcm1EaWFsb2csIHNldENvbmZpcm1EaWFsb2ddID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbZW5qb3lWb3RlLCBzZXRFbmpveVZvdGVdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbc2hvd05hbWVCdWRnZXRNb2RhbCwgc2V0U2hvd05hbWVCdWRnZXRNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbbmFtZUJ1ZGdldFZhbHVlLCBzZXROYW1lQnVkZ2V0VmFsdWVdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3NhdmVUb2FzdCwgc2V0U2F2ZVRvYXN0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VSZWYpKG51bGwpOwogIGNvbnN0IFtwaWxsUmlnaHQsIHNldFBpbGxSaWdodF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKDE2KTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChidWRnZXQpOwogIH0sIFtidWRnZXRdKTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImVuam95Vm90ZV9idWRnZXQiKTsKICAgICAgaWYgKHYgPT09ICJ1cCIgfHwgdiA9PT0gImRvd24iKSBzZXRFbmpveVZvdGUodik7CiAgICB9IGNhdGNoIHsKICAgIH0KICB9LCBbXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUxLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgdXBkYXRlID0gKCkgPT4gewogICAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQpIHsKICAgICAgICBjb25zdCByZWN0ID0gY29udGFpbmVyUmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgc2V0UGlsbFJpZ2h0KE1hdGgubWF4KDE2LCB3aW5kb3cuaW5uZXJXaWR0aCAtIHJlY3QucmlnaHQgKyAxNikpOwogICAgICB9CiAgICB9OwogICAgdXBkYXRlKCk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdXBkYXRlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzY3JvbGwiLCB1cGRhdGUpOwogICAgY29uc3Qgcm8gPSB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFJlc2l6ZU9ic2VydmVyKHVwZGF0ZSkgOiBudWxsOwogICAgaWYgKHJvICYmIGNvbnRhaW5lclJlZi5jdXJyZW50KSByby5vYnNlcnZlKGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCB1cGRhdGUpOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgdXBkYXRlKTsKICAgICAgcm8/LmRpc2Nvbm5lY3QoKTsKICAgIH07CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZUVuam95Vm90ZSA9ICh2b3RlKSA9PiB7CiAgICBpZiAoZW5qb3lWb3RlKSByZXR1cm47CiAgICBzZXRFbmpveVZvdGUodm90ZSk7CiAgICB0cnkgewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiZW5qb3lWb3RlX2J1ZGdldCIsIHZvdGUpOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICB0cmFja0V2ZW50KCJlbmpveV92b3RlIiwgeyB2b3RlLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgfTsKICBjb25zdCByZWZyZXNoUHJpY2VzID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZUNhbGxiYWNrKShhc3luYyAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJyZWZyZXNoX3ByaWNlcyIsIHsgYnVkZ2V0TmFtZTogYnVkZ2V0Lm5hbWUgfHwgbnVsbCB9KTsKICAgIGNvbnN0IGFsbEl0ZW1zID0gWy4uLmJ1ZGdldC5hc3NldHMsIC4uLmJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIC4uLmJ1ZGdldC5yZXRpcmVtZW50XTsKICAgIGNvbnN0IGNyeXB0b0l0ZW1zID0gYWxsSXRlbXMuZmlsdGVyKChpKSA9PiBpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgaS50aWNrZXIpOwogICAgY29uc3Qgc3RvY2tJdGVtcyA9IGFsbEl0ZW1zLmZpbHRlcigoaSkgPT4gaS5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgaS50aWNrZXIpOwogICAgaWYgKGNyeXB0b0l0ZW1zLmxlbmd0aCA9PT0gMCAmJiBzdG9ja0l0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgc2V0UmVmcmVzaGluZyh0cnVlKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IFtjcnlwdG9QcmljZXMsIHN0b2NrUHJpY2VzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICBjcnlwdG9JdGVtcy5sZW5ndGggPiAwID8gZmV0Y2hDcnlwdG9QcmljZXMoWy4uLm5ldyBTZXQoY3J5cHRvSXRlbXMubWFwKChpKSA9PiBpLnRpY2tlcikpXSkgOiB7fSwKICAgICAgICBzdG9ja0l0ZW1zLmxlbmd0aCA+IDAgPyBmZXRjaFN0b2NrUHJpY2VzKFsuLi5uZXcgU2V0KHN0b2NrSXRlbXMubWFwKChpKSA9PiBpLnRpY2tlcikpXSkgOiB7fQogICAgICBdKTsKICAgICAgY29uc3QgYWxsUHJpY2VzID0geyAuLi5jcnlwdG9QcmljZXMsIC4uLnN0b2NrUHJpY2VzIH07CiAgICAgIHNldEJ1ZGdldCgoYikgPT4gewogICAgICAgIGNvbnN0IHVwZGF0ZVNlY3Rpb24gPSAoaXRlbXMpID0+IGl0ZW1zLm1hcCgoaXRlbSkgPT4gewogICAgICAgICAgaWYgKCFpdGVtLmFzc2V0VHlwZSB8fCBpdGVtLmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIgfHwgIWl0ZW0udGlja2VyIHx8ICFhbGxQcmljZXNbaXRlbS50aWNrZXJdKSByZXR1cm4gaXRlbTsKICAgICAgICAgIGNvbnN0IG5ld1ByaWNlID0gYWxsUHJpY2VzW2l0ZW0udGlja2VyXTsKICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IGl0ZW0ucXVhbnRpdHkgPyBNYXRoLnJvdW5kKG5ld1ByaWNlICogaXRlbS5xdWFudGl0eSAqIDEwMCkgLyAxMDAgOiBpdGVtLmFtb3VudDsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkID0gY29tcHV0ZVZhbHVlcyhuZXdBbW91bnQsIGl0ZW0uZnJlcXVlbmN5KTsKICAgICAgICAgIHJldHVybiB7IC4uLml0ZW0sIGxpdmVQcmljZTogbmV3UHJpY2UsIGFtb3VudDogbmV3QW1vdW50LCAuLi5jb21wdXRlZCB9OwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5iLAogICAgICAgICAgYXNzZXRzOiB1cGRhdGVTZWN0aW9uKGIuYXNzZXRzKSwKICAgICAgICAgIG5vbkxpcXVpZEFzc2V0czogdXBkYXRlU2VjdGlvbihiLm5vbkxpcXVpZEFzc2V0cyksCiAgICAgICAgICByZXRpcmVtZW50OiB1cGRhdGVTZWN0aW9uKGIucmV0aXJlbWVudCksCiAgICAgICAgICBsYXN0UHJpY2VSZWZyZXNoOiBEYXRlLm5vdygpLAogICAgICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZWZyZXNoIHByaWNlcyIsIGUpOwogICAgfSBmaW5hbGx5IHsKICAgICAgc2V0UmVmcmVzaGluZyhmYWxzZSk7CiAgICB9CiAgfSwgW2J1ZGdldC5hc3NldHMsIGJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIGJ1ZGdldC5yZXRpcmVtZW50XSk7CiAgY29uc3QgdXBkYXRlSXRlbSA9IChzZWN0aW9uLCBpZCwgdXBkYXRlcykgPT4gewogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IGJbc2VjdGlvbl0ubWFwKChpdGVtKSA9PiBpdGVtLmlkID09PSBpZCA/IHsgLi4uaXRlbSwgLi4udXBkYXRlcyB9IDogaXRlbSksCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgYWRkSXRlbSA9IChzZWN0aW9uLCBmcmVxID0gIm1vbnRobHkiKSA9PiB7CiAgICB0cmFja0V2ZW50KCJhZGRfaXRlbSIsIHsgc2VjdGlvbiwgZnJlcXVlbmN5OiBmcmVxLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IFsuLi5iW3NlY3Rpb25dLCBlbXB0eUl0ZW0oZnJlcSldLAogICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgIH0pKTsKICB9OwogIGNvbnN0IGFkZFByZXNldEl0ZW0gPSAoc2VjdGlvbiwgbmFtZSwgZnJlcSA9ICJtb250aGx5IiwgYXNzZXRUeXBlKSA9PiB7CiAgICB0cmFja0V2ZW50KCJhZGRfcHJlc2V0X2l0ZW0iLCB7IHNlY3Rpb24sIHByZXNldE5hbWU6IG5hbWUsIGZyZXF1ZW5jeTogZnJlcSwgYXNzZXRUeXBlIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IFsuLi5iW3NlY3Rpb25dLCB7IC4uLmVtcHR5SXRlbShmcmVxKSwgbmFtZSwgLi4uYXNzZXRUeXBlID8geyBhc3NldFR5cGUgfSA6IHt9IH1dLAogICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgIH0pKTsKICB9OwogIGNvbnN0IHJlb3JkZXJJdGVtcyA9IChzZWN0aW9uLCBmcm9tSW5kZXgsIHRvSW5kZXgpID0+IHsKICAgIHNldEJ1ZGdldCgoYikgPT4gewogICAgICBjb25zdCBhcnIgPSBbLi4uYltzZWN0aW9uXV07CiAgICAgIGNvbnN0IFttb3ZlZF0gPSBhcnIuc3BsaWNlKGZyb21JbmRleCwgMSk7CiAgICAgIGFyci5zcGxpY2UodG9JbmRleCwgMCwgbW92ZWQpOwogICAgICByZXR1cm4geyAuLi5iLCBbc2VjdGlvbl06IGFyciwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH07CiAgICB9KTsKICB9OwogIGNvbnN0IGRlbGV0ZUl0ZW0gPSAoc2VjdGlvbiwgaWQpID0+IHsKICAgIHRyYWNrRXZlbnQoImRlbGV0ZV9pdGVtIiwgeyBzZWN0aW9uLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IGJbc2VjdGlvbl0uZmlsdGVyKChpdGVtKSA9PiBpdGVtLmlkICE9PSBpZCksCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgZG9TYXZlQnVkZ2V0ID0gKGJ1ZGdldFRvU2F2ZSkgPT4gewogICAgY29uc3QgdXBkYXRlZEJ1ZGdldCA9IHsgLi4uYnVkZ2V0VG9TYXZlLCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfTsKICAgIGNvbnN0IGV4aXN0aW5nID0gbG9hZEJ1ZGdldHMoKTsKICAgIGNvbnN0IGlkeCA9IGV4aXN0aW5nLmZpbmRJbmRleCgoYikgPT4gYi5pZCA9PT0gdXBkYXRlZEJ1ZGdldC5pZCk7CiAgICBjb25zdCBpc05ldyA9IGlkeCA8IDA7CiAgICBpZiAoaWR4ID49IDApIHsKICAgICAgZXhpc3RpbmdbaWR4XSA9IHVwZGF0ZWRCdWRnZXQ7CiAgICB9IGVsc2UgewogICAgICBleGlzdGluZy5wdXNoKHVwZGF0ZWRCdWRnZXQpOwogICAgfQogICAgc2F2ZUJ1ZGdldHMoZXhpc3RpbmcpOwogICAgc2V0U2F2ZWRCdWRnZXRzKGV4aXN0aW5nKTsKICAgIHNldEJ1ZGdldCh1cGRhdGVkQnVkZ2V0KTsKICAgIHRyYWNrRXZlbnQoInNhdmVfYnVkZ2V0IiwgeyBidWRnZXROYW1lOiB1cGRhdGVkQnVkZ2V0Lm5hbWUsIGlzTmV3IH0pOwogICAgc2V0U2F2ZVRvYXN0KHRydWUpOwogICAgc2V0VGltZW91dCgoKSA9PiBzZXRTYXZlVG9hc3QoZmFsc2UpLCAxNTAwKTsKICB9OwogIGNvbnN0IGhhbmRsZVNhdmVCdWRnZXQgPSAoKSA9PiB7CiAgICBjb25zdCBpc0ZpcnN0U2F2ZSA9ICFzYXZlZEJ1ZGdldHMuc29tZSgoYikgPT4gYi5pZCA9PT0gYnVkZ2V0LmlkKTsKICAgIGlmIChpc0ZpcnN0U2F2ZSkgewogICAgICBjb25zdCBzdWdnZXN0ZWQgPSBidWRnZXQubmFtZSAhPT0gIk15IEJ1ZGdldCBQbGFuIiA/IGJ1ZGdldC5uYW1lIDogIiI7CiAgICAgIHNldE5hbWVCdWRnZXRWYWx1ZShzdWdnZXN0ZWQpOwogICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgZG9TYXZlQnVkZ2V0KGJ1ZGdldCk7CiAgICB9CiAgfTsKICBjb25zdCBzYXZlQnVkZ2V0VG9MaXN0ID0gKCkgPT4gewogICAgY29uc3QgZXhpc3RpbmcgPSBsb2FkQnVkZ2V0cygpOwogICAgY29uc3QgaWR4ID0gZXhpc3RpbmcuZmluZEluZGV4KChiKSA9PiBiLmlkID09PSBidWRnZXQuaWQpOwogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGV4aXN0aW5nW2lkeF0gPSB7IC4uLmJ1ZGdldCwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH07CiAgICB9IGVsc2UgewogICAgICBleGlzdGluZy5wdXNoKHsgLi4uYnVkZ2V0LCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfSk7CiAgICB9CiAgICBzYXZlQnVkZ2V0cyhleGlzdGluZyk7CiAgICBzZXRTYXZlZEJ1ZGdldHMoZXhpc3RpbmcpOwogIH07CiAgY29uc3QgaGFuZGxlTmV3QnVkZ2V0ID0gKCkgPT4gewogICAgdHJhY2tFdmVudCgibmV3X2J1ZGdldCIpOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgY29uc3QgbmV3QiA9IGVtcHR5QnVkZ2V0KCk7CiAgICBzZXRCdWRnZXQobmV3Qik7CiAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZU9wZW5CdWRnZXQgPSAoYikgPT4gewogICAgdHJhY2tFdmVudCgib3Blbl9idWRnZXQiLCB7IGJ1ZGdldE5hbWU6IGIubmFtZSB8fCBudWxsIH0pOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgc2V0QnVkZ2V0KGIpOwogICAgc2V0TmFtZUlucHV0KGIubmFtZSk7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChiKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZURlbGV0ZUJ1ZGdldCA9IChpZCkgPT4gewogICAgdHJhY2tFdmVudCgiZGVsZXRlX2J1ZGdldCIsIHsgYnVkZ2V0SWQ6IGlkIH0pOwogICAgY29uc3QgdXBkYXRlZCA9IHNhdmVkQnVkZ2V0cy5maWx0ZXIoKGIpID0+IGIuaWQgIT09IGlkKTsKICAgIHNhdmVCdWRnZXRzKHVwZGF0ZWQpOwogICAgc2V0U2F2ZWRCdWRnZXRzKHVwZGF0ZWQpOwogIH07CiAgY29uc3QgaGFuZGxlUmVzZXQgPSAoKSA9PiB7CiAgICBzZXRDb25maXJtRGlhbG9nKHsKICAgICAgbWVzc2FnZTogIkNsZWFyIGFsbCBidWRnZXQgZGF0YSBvbiB0aGUgY3VycmVudCBzY3JlZW4/IiwKICAgICAgb25Db25maXJtOiAoKSA9PiB7CiAgICAgICAgdHJhY2tFdmVudCgicmVzZXQiLCB7IGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lLCBpdGVtQ291bnQ6IGJ1ZGdldC5pbmNvbWUubGVuZ3RoICsgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCArIGJ1ZGdldC5hc3NldHMubGVuZ3RoIH0pOwogICAgICAgIGNvbnN0IG5ld0IgPSBlbXB0eUJ1ZGdldCgpOwogICAgICAgIHNldEJ1ZGdldChuZXdCKTsKICAgICAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgICAgfQogICAgfSk7CiAgfTsKICBjb25zdCBoYW5kbGVTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIXN1YnNjcmliZUVtYWlsIHx8ICFzdWJzY3JpYmVFbWFpbC5pbmNsdWRlcygiQCIpKSB7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsLiIpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldFN1YnNjcmliZVN0YXR1cygibG9hZGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRX0vYXBpL3N1YnNjcmliZWAsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVtYWlsOiBzdWJzY3JpYmVFbWFpbCwgdG9waWNJZDogImJ1ZGdldC1wbGFubmVyLW5ld3MiLCB0b3BpY05hbWU6ICJCdWRnZXQgUGxhbm5lciBVcGRhdGVzIiB9KQogICAgICB9KTsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgICAgaWYgKHJlc3BvbnNlLm9rICYmIGRhdGEuc3VjY2VzcykgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygic3VjY2VzcyIpOwogICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoZGF0YS5tZXNzYWdlKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRTdWJzY3JpYmVFbWFpbCgiIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImlkbGUiKTsKICAgICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIiIpOwogICAgICAgIH0sIDNlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoZGF0YS5lcnJvciB8fCAiRmFpbGVkIHRvIHN1YnNjcmliZS4iKTsKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiTmV0d29yayBlcnJvci4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZUZlZWRiYWNrU3VibWl0ID0gYXN5bmMgKCkgPT4gewogICAgaWYgKCFmZWVkYmFja1RleHQudHJpbSgpKSByZXR1cm47CiAgICBzZXRGZWVkYmFja1N0YXR1cygic3VibWl0dGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRX0vYXBpL3RyYWNrYCwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXZlbnQ6ICJ1c2VyX2ZlZWRiYWNrIiwgZGF0YTogeyBmZWVkYmFjazogZmVlZGJhY2tUZXh0LCB0b29sOiAiYnVkZ2V0LXBsYW5uZXIiLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0gfSkKICAgICAgfSk7CiAgICAgIGlmIChyZXNwb25zZS5vaykgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRGZWVkYmFja1RleHQoIiIpOwogICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICB9LCAyZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICB9CiAgfTsKICBjb25zdCBoYW5kbGVCYWNrVG9Ib21lID0gKCkgPT4gewogICAgdHJhY2tFdmVudCgiYmFja190b19ob21lIik7CiAgICBzYXZlQnVkZ2V0VG9MaXN0KCk7CiAgICBzZXRDdXJyZW50VmlldygiaG9tZSIpOwogIH07CiAgY29uc3QgaGFuZGxlUHJpbnQgPSAoKSA9PiB7CiAgICB3aW5kb3cucHJpbnQoKTsKICB9OwogIGlmIChjdXJyZW50VmlldyA9PT0gImhvbWUiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgcmVmOiBjb250YWluZXJSZWYsIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmJnLCBmb250RmFtaWx5OiAiJ0ludGVyJywgLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBSb2JvdG8sIHNhbnMtc2VyaWYiLCBtYXhXaWR0aDogNjAwLCBtYXJnaW46ICIwIGF1dG8iLCBvdmVyZmxvdzogImhpZGRlbiIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJvcmRlclJhZGl1czogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgcGFkZGluZzogIjI0cHggMjBweCIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImgxIiwgeyBzdHlsZTogeyBtYXJnaW46IDAsIGZvbnRTaXplOiAyMiwgZm9udFdlaWdodDogNzAwLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKERvbGxhclNpZ24sIHsgc2l6ZTogMjggfSksCiAgICAgICAgICAiIFRoZSBQZXJzb25hbCBCdWRnZXQgUGxhbm5lciIKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjZweCAwIDAiLCBmb250U2l6ZTogMTIsIG9wYWNpdHk6IDAuODUsIGxldHRlclNwYWNpbmc6IDAuMiB9LCBjaGlsZHJlbjogIkJ1aWx0IG9uIHRoZSA1MC8zMC8yMCBydWxlIHVzZWQgYnkgZmluYW5jaWFsIGFkdmlzb3JzIiB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICBwYWRkaW5nOiAxNiwKICAgICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgICBib3JkZXI6IGAycHggZGFzaGVkICR7Q09MT1JTLnByaW1hcnl9YCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmFjY2VudExpZ2h0LAogICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywKICAgICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICBnYXA6IDgsCiAgICAgICAgICBtYXJnaW5Cb3R0b206IDIwCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAyMCB9KSwKICAgICAgICAgICIgQ3JlYXRlIE5ldyBCdWRnZXQiCiAgICAgICAgXSB9KSwKICAgICAgICBzYXZlZEJ1ZGdldHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAiY2VudGVyIiwgcGFkZGluZzogNDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQaWdneUJhbmssIHsgc2l6ZTogNDgsIHN0eWxlOiB7IG9wYWNpdHk6IDAuMywgbWFyZ2luQm90dG9tOiAxNiB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwIH0sIGNoaWxkcmVuOiAiTm8gc2F2ZWQgYnVkZ2V0cyB5ZXQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiNHB4IDAgMCIsIGZvbnRTaXplOiAxMyB9LCBjaGlsZHJlbjogIkNyZWF0ZSB5b3VyIGZpcnN0IGJ1ZGdldCB0byBnZXQgc3RhcnRlZCIgfSkKICAgICAgICBdIH0pIDogc2F2ZWRCdWRnZXRzLm1hcCgoYikgPT4gewogICAgICAgICAgY29uc3QgdG90YWxJbmNvbWUgPSBiLmluY29tZS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICAgICAgICBjb25zdCB0b3RhbEV4cGVuc2VzID0gYi5leHBlbnNlcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICAgICAgICBjb25zdCBuZXQgPSB0b3RhbEluY29tZSAtIHRvdGFsRXhwZW5zZXM7CiAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMTZweCIsCiAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgbWFyZ2luQm90dG9tOiA4LAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIgogICAgICAgICAgfSwgb25DbGljazogKCkgPT4gaGFuZGxlT3BlbkJ1ZGdldChiKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBiLm5hbWUgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgYi5pbmNvbWUubGVuZ3RoICsgYi5leHBlbnNlcy5sZW5ndGggKyBiLmFzc2V0cy5sZW5ndGggKyBiLm5vbkxpcXVpZEFzc2V0cy5sZW5ndGggKyAoYi5yZXRpcmVtZW50IHx8IFtdKS5sZW5ndGggKyBiLmxpYWJpbGl0aWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgICIgaXRlbXMgXHhCNyBVcGRhdGVkICIsCiAgICAgICAgICAgICAgICBuZXcgRGF0ZShiLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAicmlnaHQiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IG5ldCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgbmV0ID49IDAgPyAiKyIgOiAiIiwKICAgICAgICAgICAgICBmbXQobmV0KSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICBoYW5kbGVEZWxldGVCdWRnZXQoYi5pZCk7CiAgICAgICAgICAgIH0sIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogNiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAibm9uZSIsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsCiAgICAgICAgICAgICAgbWFyZ2luTGVmdDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUcmFzaDIsIHsgc2l6ZTogMTYgfSkgfSkKICAgICAgICAgIF0gfSwgYi5pZCk7CiAgICAgICAgfSkKICAgICAgXSB9KQogICAgXSB9KTsKICB9CiAgY29uc3QgaGFzQnVkZ2V0Q29udGVudCA9IGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDAgfHwgYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5yZXRpcmVtZW50Lmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmxpYWJpbGl0aWVzLmxlbmd0aCA+IDA7CiAgY29uc3QgaGFzTGl2ZUFzc2V0cyA9IFsuLi5idWRnZXQuYXNzZXRzLCAuLi5idWRnZXQubm9uTGlxdWlkQXNzZXRzLCAuLi5idWRnZXQucmV0aXJlbWVudF0uc29tZSgoaSkgPT4gKGkuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCBpLmFzc2V0VHlwZSA9PT0gInN0b2NrIikgJiYgaS50aWNrZXIpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyByZWY6IGNvbnRhaW5lclJlZiwgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJvcmRlclJhZGl1czogMTYsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3R5bGUiLCB7IGNoaWxkcmVuOiBgQGtleWZyYW1lcyBzcGluIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKSByb3RhdGUoMGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gfSBAa2V5ZnJhbWVzIHNwaW5CdG4geyBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9IH0gQGtleWZyYW1lcyBmYWRlSW5PdXQgeyAwJSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKSB0cmFuc2xhdGVZKC04cHgpOyB9IDE1JSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKSB0cmFuc2xhdGVZKDApOyB9IDgwJSB7IG9wYWNpdHk6IDE7IH0gMTAwJSB7IG9wYWNpdHk6IDA7IH0gfWAgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBwYWRkaW5nOiAiMjBweCAxNnB4IiwgY29sb3I6ICJ3aGl0ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKERvbGxhclNpZ24sIHsgc2l6ZTogMjQgfSksCiAgICAgICAgICBlZGl0aW5nTmFtZSA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgdmFsdWU6IG5hbWVJbnB1dCwgb25DaGFuZ2U6IChlKSA9PiBzZXROYW1lSW5wdXQoZS50YXJnZXQudmFsdWUpLCBzdHlsZTogewogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgIGZvbnRTaXplOiAyMCwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgICAgcGFkZGluZzogIjJweCA4cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBvdXRsaW5lOiAibm9uZSIsCiAgICAgICAgICAgICAgd2lkdGg6IDE4MCwKICAgICAgICAgICAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIKICAgICAgICAgICAgfSwgYXV0b0ZvY3VzOiB0cnVlLCBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAiRW50ZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRCdWRnZXQoKGIpID0+ICh7IC4uLmIsIG5hbWU6IG5hbWVJbnB1dCB9KSk7CiAgICAgICAgICAgICAgICBzZXRFZGl0aW5nTmFtZShmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICBzZXRCdWRnZXQoKGIpID0+ICh7IC4uLmIsIG5hbWU6IG5hbWVJbnB1dCB9KSk7CiAgICAgICAgICAgICAgc2V0RWRpdGluZ05hbWUoZmFsc2UpOwogICAgICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiA0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6ICJ3aGl0ZSIsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGVjaywgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgXSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgxIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRFZGl0aW5nTmFtZSh0cnVlKSwgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMjAsIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46IGJ1ZGdldC5uYW1lIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGhhc0xpdmVBc3NldHMgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogcmVmcmVzaFByaWNlcywgZGlzYWJsZWQ6IHJlZnJlc2hpbmcsIHN0eWxlOiB7CiAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogcmVmcmVzaGluZyA/ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIDogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjdXJzb3I6IHJlZnJlc2hpbmcgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgIG9wYWNpdHk6IHJlZnJlc2hpbmcgPyAwLjcgOiAxCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlZnJlc2hDdywgeyBzaXplOiAxNCwgc3R5bGU6IHJlZnJlc2hpbmcgPyB7IGFuaW1hdGlvbjogInNwaW5CdG4gMXMgbGluZWFyIGluZmluaXRlIiB9IDogdm9pZCAwIH0pLAogICAgICAgICAgICByZWZyZXNoaW5nID8gIlVwZGF0aW5nLi4uIiA6ICJSZWZyZXNoIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogaGFuZGxlQmFja1RvSG9tZSwgc3R5bGU6IHsgcGFkZGluZzogNiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjIpIiwgY29sb3I6ICJ3aGl0ZSIsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoSG91c2UsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAgICAgICBoYXNCdWRnZXRDb250ZW50ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogaGFuZGxlU2F2ZUJ1ZGdldCwgc3R5bGU6IHsgcGFkZGluZzogNiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjIpIiwgY29sb3I6ICJ3aGl0ZSIsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU2F2ZSwgeyBzaXplOiAxNiB9KSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAxNCB9KSwKICAgICAgICAgICAgIiBOZXciCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTEsIG9wYWNpdHk6IDAuOCwgbGV0dGVyU3BhY2luZzogMC4yIH0sIGNoaWxkcmVuOiAiQnVpbHQgb24gdGhlIDUwLzMwLzIwIHJ1bGUgdXNlZCBieSBmaW5hbmNpYWwgYWR2aXNvcnMiIH0pLAogICAgICAgIGJ1ZGdldC5sYXN0UHJpY2VSZWZyZXNoICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIG9wYWNpdHk6IDAuNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgIlByaWNlczogIiwKICAgICAgICAgIG5ldyBEYXRlKGJ1ZGdldC5sYXN0UHJpY2VSZWZyZXNoKS50b0xvY2FsZVRpbWVTdHJpbmcoKQogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxNnB4IDE2cHggNDBweCIgfSwgY2hpbGRyZW46IFsKICAgICAgYnVkZ2V0LmluY29tZS5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQuYXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmxpYWJpbGl0aWVzLmxlbmd0aCA9PT0gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDgsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJTdGFydCB3aXRoIGEgdGVtcGxhdGUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDYgfSwgY2hpbGRyZW46IEJVREdFVF9QUkVTRVRTLm1hcCgocCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgY29uc3QgcHJlc2V0ID0gcC5idWRnZXQ7CiAgICAgICAgICAgICAgY29uc3QgcmVnZW5lcmF0ZWQgPSB7CiAgICAgICAgICAgICAgICAuLi5wcmVzZXQsCiAgICAgICAgICAgICAgICBpZDogYnVkZ2V0LmlkLAogICAgICAgICAgICAgICAgaW5jb21lOiBwcmVzZXQuaW5jb21lLm1hcCgoaSkgPT4gKHsgLi4uaSwgaWQ6IGdlbmVyYXRlSWQoKSB9KSksCiAgICAgICAgICAgICAgICBleHBlbnNlczogcHJlc2V0LmV4cGVuc2VzLm1hcCgoaSkgPT4gKHsgLi4uaSwgaWQ6IGdlbmVyYXRlSWQoKSB9KSksCiAgICAgICAgICAgICAgICBhc3NldHM6IHByZXNldC5hc3NldHMubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIG5vbkxpcXVpZEFzc2V0czogcHJlc2V0Lm5vbkxpcXVpZEFzc2V0cy5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgcmV0aXJlbWVudDogcHJlc2V0LnJldGlyZW1lbnQubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGxpYWJpbGl0aWVzOiBwcmVzZXQubGlhYmlsaXRpZXMubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogbm93LAogICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBub3cKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNldEJ1ZGdldChyZWdlbmVyYXRlZCk7CiAgICAgICAgICAgICAgc2V0TmFtZUlucHV0KHByZXNldC5uYW1lKTsKICAgICAgICAgICAgICB0cmFja0V2ZW50KCJsb2FkX3ByZXNldCIsIHsgcHJlc2V0OiBwLmtleSB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBmbGV4OiAxLAogICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggNHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgIGJvcmRlcjogYDEuNXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgdGV4dEFsaWduOiAiY2VudGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogImNvbHVtbiIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiAyLAogICAgICAgICAgICAgIHRyYW5zaXRpb246ICJib3JkZXItY29sb3IgMC4xNXMsIGJveC1zaGFkb3cgMC4xNXMiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm9yZGVyQ29sb3IgPSBDT0xPUlMuYWNjZW50OwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSBgMCAycHggOHB4ICR7Q09MT1JTLmFjY2VudH0yMGA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm9yZGVyQ29sb3IgPSBDT0xPUlMuYm9yZGVyOwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSAibm9uZSI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE2IH0sIGNoaWxkcmVuOiBwLmVtb2ppIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBwLmxhYmVsIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjIgfSwgY2hpbGRyZW46IHAuZGVzYyB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgcC5rZXkKICAgICAgICApKSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgIEJ1ZGdldFNlY3Rpb24sCiAgICAgICAgewogICAgICAgICAgdGl0bGU6ICJJbmNvbWUiLAogICAgICAgICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUcmVuZGluZ1VwLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUy5pbmNvbWUsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMuaW5jb21lQmcsCiAgICAgICAgICBpdGVtczogYnVkZ2V0LmluY29tZSwKICAgICAgICAgIGlucHV0TW9kZTogInJlY3VycmluZyIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLmluY29tZSwKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImluY29tZSIsIGlkLCB1KSwKICAgICAgICAgIG9uQWRkOiAoKSA9PiBhZGRJdGVtKCJpbmNvbWUiLCAibW9udGhseSIpLAogICAgICAgICAgb25BZGRQcmVzZXQ6IChuYW1lLCBhdCkgPT4gYWRkUHJlc2V0SXRlbSgiaW5jb21lIiwgbmFtZSwgIm1vbnRobHkiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJpbmNvbWUiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImluY29tZSIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgIEJ1ZGdldFNlY3Rpb24sCiAgICAgICAgewogICAgICAgICAgdGl0bGU6ICJFeHBlbnNlcyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRyZW5kaW5nRG93biwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMuZXhwZW5zZSwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUy5leHBlbnNlQmcsCiAgICAgICAgICBpdGVtczogYnVkZ2V0LmV4cGVuc2VzLAogICAgICAgICAgaW5wdXRNb2RlOiAicmVjdXJyaW5nIiwKICAgICAgICAgIHByZXNldHM6IFBSRVNFVFMuZXhwZW5zZXMsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJleHBlbnNlcyIsIGlkLCB1KSwKICAgICAgICAgIG9uQWRkOiAoKSA9PiBhZGRJdGVtKCJleHBlbnNlcyIsICJtb250aGx5IiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJleHBlbnNlcyIsIG5hbWUsICJtb250aGx5IiwgYXQpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgiZXhwZW5zZXMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImV4cGVuc2VzIiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkFzc2V0cyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFdhbGxldCwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMuYXNzZXQsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMuYXNzZXRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuYXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAiYXNzZXQiLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5hc3NldHMsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJhc3NldHMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiYXNzZXRzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJhc3NldHMiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJhc3NldHMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImFzc2V0cyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgIEJ1ZGdldFNlY3Rpb24sCiAgICAgICAgewogICAgICAgICAgdGl0bGU6ICJOb24tTGlxdWlkIEFzc2V0cyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEJ1aWxkaW5nMiwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMubm9uTGlxdWlkLAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTLm5vbkxpcXVpZEJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5ub25MaXF1aWRBc3NldHMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJ2YWx1ZV9vbmx5IiwKICAgICAgICAgIHByZXNldHM6IFBSRVNFVFMubm9uTGlxdWlkQXNzZXRzLAogICAgICAgICAgb25VcGRhdGU6IChpZCwgdSkgPT4gdXBkYXRlSXRlbSgibm9uTGlxdWlkQXNzZXRzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsICJvbmVfdGltZSIpLAogICAgICAgICAgb25BZGRQcmVzZXQ6IChuYW1lLCBhdCkgPT4gYWRkUHJlc2V0SXRlbSgibm9uTGlxdWlkQXNzZXRzIiwgbmFtZSwgIm9uZV90aW1lIiwgYXQpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgibm9uTGlxdWlkQXNzZXRzIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJub25MaXF1aWRBc3NldHMiLCBmcm9tMiwgdG8yKSwKICAgICAgICAgIGZvb3RlcjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAxMCwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLCBtYXJnaW5Ub3A6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkRpc2NvdW50IFJhdGUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5ub25MaXF1aWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgICAgICIlIgogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJyYW5nZSIsCiAgICAgICAgICAgICAgICBtaW46IDAsCiAgICAgICAgICAgICAgICBtYXg6IDc1LAogICAgICAgICAgICAgICAgdmFsdWU6IGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0QnVkZ2V0KChiKSA9PiAoeyAuLi5iLCBub25MaXF1aWREaXNjb3VudDogcGFyc2VJbnQoZS50YXJnZXQudmFsdWUpIH0pKSwKICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIGFjY2VudENvbG9yOiBDT0xPUlMubm9uTGlxdWlkIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiMCUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiMjUlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIjUwJSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICI3NSUiIH0pCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSkKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIjQwMWsgLyBSZXRpcmVtZW50IiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTGFuZG1hcmssIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnJldGlyZW1lbnQsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMucmV0aXJlbWVudEJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5yZXRpcmVtZW50LAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLnJldGlyZW1lbnQsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJyZXRpcmVtZW50IiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oInJldGlyZW1lbnQiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oInJldGlyZW1lbnQiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJyZXRpcmVtZW50IiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJyZXRpcmVtZW50IiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkxpYWJpbGl0aWVzIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJpYW5nbGVBbGVydCwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5LAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTLmxpYWJpbGl0eUJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5saWFiaWxpdGllcywKICAgICAgICAgIGlucHV0TW9kZTogInJlY3VycmluZyIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLmxpYWJpbGl0aWVzLAogICAgICAgICAgb25VcGRhdGU6IChpZCwgdSkgPT4gdXBkYXRlSXRlbSgibGlhYmlsaXRpZXMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgibGlhYmlsaXRpZXMiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oImxpYWJpbGl0aWVzIiwgbmFtZSwgIm9uZV90aW1lIiwgYXQpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgibGlhYmlsaXRpZXMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImxpYWJpbGl0aWVzIiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIChidWRnZXQuaW5jb21lLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmFzc2V0cy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5saWFiaWxpdGllcy5sZW5ndGggPiAwKSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFN1bW1hcnlTZWN0aW9uLCB7IGJ1ZGdldCB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjE2cHggMCIsIGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gIH0sIGNsYXNzTmFtZTogIm5vLXByaW50IiwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMCB9LCBjaGlsZHJlbjogIlJlbGF0ZWQgQXBwcyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTAsIGZsZXhXcmFwOiAid3JhcCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIHsgZW1vamk6ICJcdTI3MDJcdUZFMEYiLCBhY2NlbnQ6ICIjRUY0NDQ0IiwgYWNjZW50Qmc6ICIjRkVGMkYyIiwgbGFiZWw6ICJKdXN0IENhbmNlbCBJdCIsIGRlc2M6ICJDYW5jZWwgeW91ciBzdWJzY3JpcHRpb25zIGZvciBmcmVlIiB9LAogICAgICAgICAgeyBlbW9qaTogIlx1ezFGM0Q2fVx1RkUwRiIsIGFjY2VudDogIiNGNTlFMEIiLCBhY2NlbnRCZzogIiNGRkZCRUIiLCBsYWJlbDogIlJldGlyZW1lbnQgQ2FsY3VsYXRvciIsIGRlc2M6ICJQbGFuIHlvdXIgcmV0aXJlbWVudCB3aXRoIGNvbmZpZGVuY2UiIH0sCiAgICAgICAgICB7IGVtb2ppOiAiXHV7MUY0Q0F9IiwgYWNjZW50OiAiIzYzNjZGMSIsIGFjY2VudEJnOiAiI0VFRjJGRiIsIGxhYmVsOiAiUG9ydGZvbGlvIE9wdGltaXplciIsIGRlc2M6ICJPcHRpbWl6ZSB5b3VyIGludmVzdG1lbnQgcG9ydGZvbGlvIiB9CiAgICAgICAgXS5tYXAoKGFwcCwgaSkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gdHJhY2tFdmVudCgicmVsYXRlZF9hcHBfY2xpY2siLCB7IGFwcDogYXBwLmxhYmVsIH0pLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIGZsZXg6ICIxIDEgMCIsCiAgICAgICAgICAgICAgbWluV2lkdGg6IDE0MCwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogImNvbHVtbiIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNnB4IDEycHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTQsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7YXBwLmFjY2VudH0yMGAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBhcHAuYWNjZW50QmcsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgdGV4dEFsaWduOiAiY2VudGVyIiwKICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAidHJhbnNmb3JtIDAuMTVzLCBib3gtc2hhZG93IDAuMTVzIgogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGVZKC0ycHgpIjsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm94U2hhZG93ID0gYDAgNHB4IDEycHggJHthcHAuYWNjZW50fTIwYDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSAiIjsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm94U2hhZG93ID0gIiI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogNDQsIGhlaWdodDogNDQsIGJvcmRlclJhZGl1czogMTIsIGJhY2tncm91bmQ6IGBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAke2FwcC5hY2NlbnR9MjAsICR7YXBwLmFjY2VudH0wOClgLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGZvbnRTaXplOiAyMiB9LCBjaGlsZHJlbjogYXBwLmVtb2ppIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBhcHAubGFiZWwgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46IGFwcC5kZXNjIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgaQogICAgICAgICkpIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgbWFyZ2luVG9wOiAxNiwKICAgICAgICBwYWRkaW5nOiAiMTZweCAwIiwKICAgICAgICBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICBnYXA6IDgsCiAgICAgICAgZmxleFdyYXA6ICJ3cmFwIgogICAgICB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoInN1YnNjcmliZV9jbGljayIpOwogICAgICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbCh0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1haWwsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBTdWJzY3JpYmUiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IGhhbmRsZVJlc2V0LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUm90YXRlQ2N3LCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgUmVzZXQiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRyYWNrRXZlbnQoImRvbmF0ZV9jbGljayIpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoSGVhcnQsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBEb25hdGUiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICB0cmFja0V2ZW50KCJmZWVkYmFja19jbGljayIpOwogICAgICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWVzc2FnZVNxdWFyZSwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIEZlZWRiYWNrIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgdHJhY2tFdmVudCgicHJpbnRfY2xpY2siKTsKICAgICAgICAgICAgICB3aW5kb3cucHJpbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFByaW50ZXIsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBQcmludCIKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIGNvbmZpcm1EaWFsb2cgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRDb25maXJtRGlhbG9nKG51bGwpLAogICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJkaXYiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBib3JkZXJSYWRpdXM6IDE2LCBwYWRkaW5nOiAyNCwgbWF4V2lkdGg6IDM0MCwgd2lkdGg6ICI5MCUiLCBib3hTaGFkb3c6ICIwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4xNSkiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46IGNvbmZpcm1EaWFsb2cubWVzc2FnZSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0Q29uZmlybURpYWxvZyhudWxsKSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgZm9udFNpemU6IDEzLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQ2FuY2VsIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgICAgICBjb25maXJtRGlhbG9nLm9uQ29uZmlybSgpOwogICAgICAgICAgICAgICAgICBzZXRDb25maXJtRGlhbG9nKG51bGwpOwogICAgICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuZXhwZW5zZSwgY29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiB9LCBjaGlsZHJlbjogIkNvbmZpcm0iIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICB9CiAgICApLAogICAgc2hvd1N1YnNjcmliZU1vZGFsICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICJkaXYiLAogICAgICB7CiAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGluc2V0OiAwLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIHpJbmRleDogMWUzIH0sCiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldFN1YnNjcmliZUVtYWlsKCIiKTsKICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAxNiwgcGFkZGluZzogMjQsIG1heFdpZHRoOiAzODAsIHdpZHRoOiAiOTAlIiwgYm94U2hhZG93OiAiMCA4cHggMzBweCByZ2JhKDAsMCwwLDAuMTUpIiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTcsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIlN1YnNjcmliZSB0byBVcGRhdGVzIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgICAgICBzZXRTaG93U3Vic2NyaWJlTW9kYWwoZmFsc2UpOwogICAgICAgICAgICAgICAgICBzZXRTdWJzY3JpYmVFbWFpbCgiIik7CiAgICAgICAgICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCIiKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYLCB7IHNpemU6IDE4IH0pIH0pCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luOiAiMCAwIDEycHgiIH0sIGNoaWxkcmVuOiAiR2V0IG5vdGlmaWVkIGFib3V0IG5ldyBmZWF0dXJlcyBhbmQgdXBkYXRlcy4iIH0pLAogICAgICAgICAgICAgIHN1YnNjcmliZVN0YXR1cyA9PT0gInN1Y2Nlc3MiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5pbmNvbWV9MTBgLCBjb2xvcjogQ09MT1JTLmluY29tZSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfHwgIlN1YnNjcmliZWQhIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdWJzY3JpYmVFbWFpbCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldFN1YnNjcmliZUVtYWlsKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIpIGhhbmRsZVN1YnNjcmliZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJ5b3VyQGVtYWlsLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgZm9udFNpemU6IDE0LCBmb250RmFtaWx5OiAiaW5oZXJpdCIsIG91dGxpbmU6ICJub25lIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIG1hcmdpbkJvdHRvbTogOCB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBzdWJzY3JpYmVNZXNzYWdlICYmIHN1YnNjcmliZVN0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy5leHBlbnNlLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZVN1YnNjcmliZSwgZGlzYWJsZWQ6IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciLCBzdHlsZTogewogICAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTBweCAxNnB4IiwKICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgICBjdXJzb3I6IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gImRlZmF1bHQiIDogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICBvcGFjaXR5OiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiA/IDAuNyA6IDEKICAgICAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiA/ICJTdWJzY3JpYmluZy4uLiIgOiAiU3Vic2NyaWJlIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNob3dGZWVkYmFja01vZGFsICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICJkaXYiLAogICAgICB7CiAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGluc2V0OiAwLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIHpJbmRleDogMWUzIH0sCiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJpZGxlIik7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAxNiwgcGFkZGluZzogMjQsIG1heFdpZHRoOiAzODAsIHdpZHRoOiAiOTAlIiwgYm94U2hhZG93OiAiMCA4cHggMzBweCByZ2JhKDAsMCwwLDAuMTUpIiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTcsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIlNlbmQgRmVlZGJhY2siIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYLCB7IHNpemU6IDE4IH0pIH0pCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICBlbmpveVZvdGUgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTJweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBlbmpveVZvdGUgPT09ICJ1cCIgPyBgJHtDT0xPUlMuaW5jb21lfTEwYCA6IGAke0NPTE9SUy5leHBlbnNlfTEwYCwKICAgICAgICAgICAgICAgIGNvbG9yOiBlbmpveVZvdGUgPT09ICJ1cCIgPyBDT0xPUlMuaW5jb21lIDogQ09MT1JTLmV4cGVuc2UsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogNgogICAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICBlbmpveVZvdGUgPT09ICJ1cCIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRodW1ic1VwLCB7IHNpemU6IDE0IH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gIkdsYWQgeW91J3JlIGVuam95aW5nIGl0ISIgOiAiU29ycnkgdG8gaGVhciB0aGF0LiIKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDgsIGJhY2tncm91bmRDb2xvcjogYCR7Q09MT1JTLmluY29tZX0xMGAsIGNvbG9yOiBDT0xPUlMuaW5jb21lLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogIlRoYW5rIHlvdSBmb3IgeW91ciBmZWVkYmFjayEiIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAidGV4dGFyZWEiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZlZWRiYWNrVGV4dCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEZlZWRiYWNrVGV4dChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGVuam95Vm90ZSA9PT0gInVwIiA/ICJXaGF0IGRvIHlvdSBsaWtlIG1vc3Q/IEFueSBmZWF0dXJlcyB5b3UnZCBsb3ZlIHRvIHNlZT8iIDogZW5qb3lWb3RlID09PSAiZG93biIgPyAiV2hhdCB3ZW50IHdyb25nPyBIb3cgY2FuIHdlIGltcHJvdmU/IiA6ICJXaGF0IGNhbiB3ZSBpbXByb3ZlPyBCdWcgcmVwb3J0cywgZmVhdHVyZSByZXF1ZXN0cywgYW55dGhpbmcuLi4iLAogICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByb3dzOiA0LAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgZm9udFNpemU6IDE0LCBmb250RmFtaWx5OiAiaW5oZXJpdCIsIG91dGxpbmU6ICJub25lIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIG1hcmdpbkJvdHRvbTogOCwgcmVzaXplOiAidmVydGljYWwiIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAiZXJyb3IiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLmV4cGVuc2UsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkZhaWxlZCB0byBzZW5kLiBQbGVhc2UgdHJ5IGFnYWluLiIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZUZlZWRiYWNrU3VibWl0LCBkaXNhYmxlZDogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiB8fCAhZmVlZGJhY2tUZXh0LnRyaW0oKSwgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTQsCiAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICAgICAgY3Vyc29yOiBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciIHx8ICFmZWVkYmFja1RleHQudHJpbSgpID8gImRlZmF1bHQiIDogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICBvcGFjaXR5OiBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciIHx8ICFmZWVkYmFja1RleHQudHJpbSgpID8gMC43IDogMQogICAgICAgICAgICAgICAgfSwgY2hpbGRyZW46IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgPyAiU2VuZGluZy4uLiIgOiAiU3VibWl0IEZlZWRiYWNrIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNob3dOYW1lQnVkZ2V0TW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAxNiwgcGFkZGluZzogMjQsIG1heFdpZHRoOiAzODAsIHdpZHRoOiAiOTAlIiwgYm94U2hhZG93OiAiMCA4cHggMzBweCByZ2JhKDAsMCwwLDAuMTUpIiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTcsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIk5hbWUgWW91ciBCdWRnZXQiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFgsIHsgc2l6ZTogMTggfSkgfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YWx1ZTogbmFtZUJ1ZGdldFZhbHVlLAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldE5hbWVCdWRnZXRWYWx1ZShlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgIG9uS2V5RG93bjogKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIgJiYgbmFtZUJ1ZGdldFZhbHVlLnRyaW0oKSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZWQyID0geyAuLi5idWRnZXQsIG5hbWU6IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfTsKICAgICAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICAgICAgc2V0TmFtZUlucHV0KG5hbWVCdWRnZXRWYWx1ZS50cmltKCkpOwogICAgICAgICAgICAgICAgICAgICAgZG9TYXZlQnVkZ2V0KG5hbWVkMik7CiAgICAgICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiZS5nLiBNb250aGx5IEJ1ZGdldCwgSG91c2Vob2xkLCBTaWRlIEh1c3RsZSIsCiAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBmb250U2l6ZTogMTQsIGZvbnRGYW1pbHk6ICJpbmhlcml0Iiwgb3V0bGluZTogIm5vbmUiLCBib3hTaXppbmc6ICJib3JkZXItYm94IiwgbWFyZ2luQm90dG9tOiAxMiB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0U2hvd05hbWVCdWRnZXRNb2RhbChmYWxzZSksIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMywgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkNhbmNlbCIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfHwgIk15IEJ1ZGdldCI7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVkMiA9IHsgLi4uYnVkZ2V0LCBuYW1lIH07CiAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXROYW1lSW5wdXQobmFtZSk7CiAgICAgICAgICAgICAgICAgIGRvU2F2ZUJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJTYXZlIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNhdmVUb2FzdCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgdG9wOiAyMCwKICAgICAgbGVmdDogIjUwJSIsCiAgICAgIHRyYW5zZm9ybTogInRyYW5zbGF0ZVgoLTUwJSkiLAogICAgICB6SW5kZXg6IDExMDAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICBwYWRkaW5nOiAiMTBweCAyMHB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgZm9udFNpemU6IDEzLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDE2cHggcmdiYSgwLDAsMCwwLjE1KSIsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogOCwKICAgICAgYW5pbWF0aW9uOiAiZmFkZUluT3V0IDEuNXMgZWFzZSIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hlY2ssIHsgc2l6ZTogMTYgfSksCiAgICAgICIgQnVkZ2V0IHNhdmVkISIKICAgIF0gfSksCiAgICAhZW5qb3lWb3RlICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGJvdHRvbTogMjAsIHJpZ2h0OiBwaWxsUmlnaHQsIHpJbmRleDogOTAwLCBwb2ludGVyRXZlbnRzOiAibm9uZSIgfSwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9pbnRlckV2ZW50czogImF1dG8iLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6IDI0LAogICAgICBwYWRkaW5nOiAiMTBweCAxNnB4IiwKICAgICAgYm94U2hhZG93OiAiMCA0cHggMjBweCByZ2JhKDAsMCwwLDAuMTIpIiwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBnYXA6IDEwCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkVuam95aW5nIHRoaXMgYXBwPyIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gaGFuZGxlRW5qb3lWb3RlKCJ1cCIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMuaW5jb21lCiAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRodW1ic1VwLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IGhhbmRsZUVuam95Vm90ZSgiZG93biIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMuZXhwZW5zZQogICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE2IH0pIH0pCiAgICBdIH0pIH0pCiAgXSB9KTsKfQoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUyID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgRXJyb3JCb3VuZGFyeSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0NTIuZGVmYXVsdC5Db21wb25lbnQgewogIGNvbnN0cnVjdG9yKHByb3BzKSB7CiAgICBzdXBlcihwcm9wcyk7CiAgICB0aGlzLnN0YXRlID0geyBoYXNFcnJvcjogZmFsc2UgfTsKICB9CiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvcikgewogICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIGVycm9yIH07CiAgfQogIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHsKICAgIGNvbnNvbGUuZXJyb3IoIldpZGdldCBFcnJvciBCb3VuZGFyeSBjYXVnaHQgZXJyb3I6IiwgZXJyb3IsIGVycm9ySW5mbyk7CiAgICB0cnkgewogICAgICBmZXRjaCgiL2FwaS90cmFjayIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogImNyYXNoIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yPy5tZXNzYWdlIHx8ICJVbmtub3duIGVycm9yIiwKICAgICAgICAgICAgc3RhY2s6IGVycm9yPy5zdGFjaywKICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mbz8uY29tcG9uZW50U3RhY2sKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlcG9ydCBjcmFzaCIsIGUpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuc3RhdGUuaGFzRXJyb3IpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udEZhbWlseTogInNhbnMtc2VyaWYiLCBjb2xvcjogIiNEQzI2MjYiLCB3b3JkQnJlYWs6ICJicmVhay13b3JkIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgY2hpbGRyZW46ICJTb21ldGhpbmcgd2VudCB3cm9uZy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBjaGlsZHJlbjogIlBsZWFzZSB0cnkgcmVmcmVzaGluZyB0aGUgcGFnZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGV0YWlscyIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMCwgdGV4dEFsaWduOiAibGVmdCIsIGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiAiIzY2NiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdW1tYXJ5IiwgeyBjaGlsZHJlbjogIkRlYnVnIEVycm9yIERldGFpbHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIGJhY2tncm91bmQ6ICIjZjVmNWY1IiwgcGFkZGluZzogMTAsIGJvcmRlclJhZGl1czogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy50b1N0cmluZygpLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnN0YWNrCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW47CiAgfQp9Owp2YXIgZ2V0SHlkcmF0aW9uRGF0YSA9ICgpID0+IHsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gU3RhcnRpbmcgaHlkcmF0aW9uIGNoZWNrLi4uIik7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gV2luZG93IGlzIHVuZGVmaW5lZCIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCBvYSA9IHdpbmRvdy5vcGVuYWk7CiAgaWYgKCFvYSkgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgbm90IGZvdW5kLCByZW5kZXJpbmcgd2l0aCBkZWZhdWx0cyIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBmb3VuZDoiLCBPYmplY3Qua2V5cyhvYSkpOwogIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICBvYS50b29sT3V0cHV0LAogICAgb2Euc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EudG9vbElucHV0CiAgXTsKICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gRm91bmQgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTm8gZGF0YSBmb3VuZCBpbiBhbnkgY2FuZGlkYXRlIHNvdXJjZSIpOwogIHJldHVybiB7fTsKfTsKY29uc29sZS5sb2coIltNYWluXSBNeSBCdWRnZXQgbWFpbi50c3ggbG9hZGluZy4uLiIpOwpmdW5jdGlvbiBBcHAoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoTXlCdWRnZXQsIHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KTsKfQp2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm15LWJ1ZGdldC1yb290Iik7CmlmICghY29udGFpbmVyKSB7CiAgdGhyb3cgbmV3IEVycm9yKCJteS1idWRnZXQtcm9vdCBlbGVtZW50IG5vdCBmb3VuZCIpOwp9CnZhciByb290ID0gKDAsIGltcG9ydF9jbGllbnQuY3JlYXRlUm9vdCkoY29udGFpbmVyKTsKdmFyIHJlbmRlckFwcCA9IChkYXRhKSA9PiB7CiAgcm9vdC5yZW5kZXIoCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShpbXBvcnRfcmVhY3Q1Mi5kZWZhdWx0LlN0cmljdE1vZGUsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEVycm9yQm91bmRhcnksIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFwcCwgeyBpbml0aWFsRGF0YTogZGF0YSB9LCBEYXRlLm5vdygpKSB9KSB9KQogICk7Cn07CnZhciBpbml0aWFsRGF0YSA9IGdldEh5ZHJhdGlvbkRhdGEoKTsKcmVuZGVyQXBwKGluaXRpYWxEYXRhKTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW5haTpzZXRfZ2xvYmFscyIsIChldikgPT4gewogIGNvbnN0IGdsb2JhbHMgPSBldj8uZGV0YWlsPy5nbG9iYWxzOwogIGlmIChnbG9iYWxzKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTGF0ZSBldmVudCByZWNlaXZlZDoiLCBnbG9iYWxzKTsKICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICAgIGdsb2JhbHMudG9vbE91dHB1dCwKICAgICAgZ2xvYmFscy5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnRvb2xJbnB1dAogICAgXTsKICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggbGF0ZSBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgICAgcmVuZGVyQXBwKGNhbmRpZGF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQp9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoCiAgIm1lc3NhZ2UiLAogIChldmVudCkgPT4gewogICAgaWYgKGV2ZW50LnNvdXJjZSAhPT0gd2luZG93LnBhcmVudCkgcmV0dXJuOwogICAgY29uc3QgbWVzc2FnZSA9IGV2ZW50LmRhdGE7CiAgICBpZiAoIW1lc3NhZ2UgfHwgbWVzc2FnZS5qc29ucnBjICE9PSAiMi4wIikgcmV0dXJuOwogICAgaWYgKG1lc3NhZ2UubWV0aG9kICE9PSAidWkvbm90aWZpY2F0aW9ucy90b29sLXJlc3VsdCIpIHJldHVybjsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBNQ1AgQXBwcyBicmlkZ2UgdG9vbC1yZXN1bHQgcmVjZWl2ZWQ6IiwgbWVzc2FnZS5wYXJhbXMpOwogICAgY29uc3QgdG9vbFJlc3VsdCA9IG1lc3NhZ2UucGFyYW1zOwogICAgY29uc3QgZGF0YSA9IHRvb2xSZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50ID8/IHRvb2xSZXN1bHQ/LnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQgPz8ge307CiAgICBpZiAoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggTUNQIEFwcHMgYnJpZGdlIGRhdGE6IiwgZGF0YSk7CiAgICAgIHJlbmRlckFwcChkYXRhKTsKICAgIH0KICB9LAogIHsgcGFzc2l2ZTogdHJ1ZSB9Cik7Ci8qISBCdW5kbGVkIGxpY2Vuc2UgaW5mb3JtYXRpb246CgpyZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpzY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHNjaGVkdWxlci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpyZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiAgKCoqCiAgICogQ2hlY2tzIGlmIGFuIGV2ZW50IGlzIHN1cHBvcnRlZCBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gZW52aXJvbm1lbnQuCiAgICoKICAgKiBOT1RFOiBUaGlzIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5IGZvciBub24tZ2VuZXJpYyBldmVudHMgc3VjaCBhcyBgY2hhbmdlYCwKICAgKiBgcmVzZXRgLCBgbG9hZGAsIGBlcnJvcmAsIGFuZCBgc2VsZWN0YC4KICAgKgogICAqIEJvcnJvd3MgZnJvbSBNb2Rlcm5penIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lU3VmZml4IEV2ZW50IG5hbWUsIGUuZy4gImNsaWNrIi4KICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQuCiAgICogQGludGVybmFsCiAgICogQGxpY2Vuc2UgTW9kZXJuaXpyIDMuMC4wcHJlIChDdXN0b20gQnVpbGQpIHwgTUlUCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHVzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzOgogICgqISBkZWNpbWFsLmpzLWxpZ2h0IHYyLjUuMSBodHRwczovL2dpdGh1Yi5jb20vTWlrZU1jbC9kZWNpbWFsLmpzLWxpZ2h0L0xJQ0VOQ0UgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXVwLXJpZ2h0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZWNrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ncmlwLXZlcnRpY2FsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xhbmRtYXJrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21haWwuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BpZ2d5LWJhbmsuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcHJpbnRlci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2F2ZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NlYXJjaC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy1kb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyZW5kaW5nLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyaWFuZ2xlLWFsZXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvd2FsbGV0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMveC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[My Budget] Failed to load:', err);
          const root = document.getElementById('my-budget-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load budget</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
